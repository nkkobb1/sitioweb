<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historias del Judaísmo - Exploración Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Clásicas/Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Historias del Judaísmo --- */
        :root {
            --color-primary: #005f9e; /* Azul Tekhelet/Israel */
            --color-secondary: #ffd700; /* Dorado (uso moderado) */
            --color-tertiary: #ffffff; /* Blanco */
            --color-background: #fdfbf5; /* Blanco Hueso/Papiro claro */
            --color-text: #333333; /* Gris Oscuro/Casi Negro para texto */
            --color-text-muted: #555555; /* Gris medio */
            --color-modal-bg: #ffffff; /* Blanco Modal */
            --color-border: #cccccc; /* Borde Gris Claro */
            --color-error-bg: #fceded; /* Fondo error rosa pálido */
            --color-error-text: #a02c2c; /* Texto error rojo oscuro */
            --color-error-border: #f7baba; /* Borde error */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-primary); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-tertiary); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-tertiary); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 95, 158, 0.2); outline: none; background-color: #ffffff; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-tertiary); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f0f8ff; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-tertiary); padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-transform: uppercase; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #004a7c; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #b0c4de; color: #666666; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: var(--color-tertiary); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(50, 50, 50, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px; /* Espacio para contenido + chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-tertiary); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-background); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: #8b4513; /* Marrón para énfasis */ font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 700; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: #004a7c; } /* Azul más oscuro */
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(204, 204, 204, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f8f8f8; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: #e0f2fe; color: #1e3a8a; margin-left: auto; text-align: right; font-weight: 400;} /* Azul claro usuario */
        .ai-message { background-color: #f3f4f6; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; } /* Gris claro AI */
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: var(--color-tertiary); color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-tertiary); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #004a7c; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* --- Loading Modal with Minigame --- */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.98); /* Fondo blanco casi opaco */
            display: none; /* Initially hidden, shown via JS */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 55;
            padding: 2rem;
            border-radius: var(--border-radius);
            text-align: center;
            font-family: 'Lato', sans-serif;
            color: var(--color-text);
        }
        #modal-loading p { margin-bottom: 1.5rem; font-size: 1.2rem; font-weight: 700; color: var(--color-primary); }
        #minigame-container {
            width: 80%;
            max-width: 400px;
            height: auto;
            min-height: 200px; /* Ensure space for the game */
            border: 2px solid var(--color-primary);
            background-color: #eef4fa; /* Light blue background */
            padding: 1rem;
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }
        #minigame-wall {
            width: 100%;
            height: 120px; /* Adjust height as needed */
            background-color: #fdfbf5; /* Wall background */
            border: 1px solid #ccc;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden; /* Hide stones outside */
            display: flex;
            flex-wrap: wrap;
            align-content: flex-end; /* Stones start from bottom */
        }
        .minigame-stone {
            width: 25px; /* Adjust size */
            height: 20px; /* Adjust size */
            background-color: #b8a993; /* Stone color */
            border: 1px solid #8b7d6b;
            margin: 1px;
            opacity: 0;
            transition: opacity 0.3s ease-in;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2);
        }
        .minigame-stone.placed { opacity: 1; }
        /* Specific stone styles for variety/levels */
        .minigame-stone.decorative { background-color: var(--color-secondary); border-color: #b8860b; }

        #minigame-status { font-size: 1rem; margin-bottom: 1rem; font-weight: 700; }
        #minigame-level { color: var(--color-primary); }
        #minigame-progress { color: var(--color-text-muted); font-size: 0.9em;}

        #minigame-button {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            background-color: var(--color-primary);
            color: var(--color-tertiary);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-weight: 700;
        }
        #minigame-button:hover { background-color: #004a7c; }
        #minigame-button:disabled { background-color: #b0c4de; cursor: default; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-text); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(50, 50, 50, 0.9); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-tertiary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-tertiary); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-torah mr-3 text-blue-600"></i> <!-- Icono Torah -->
                     Historias del Judaísmo
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">Exploración Interactiva</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Un Viaje por la Historia y Cultura Judía</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre relatos, figuras, conceptos y tradiciones milenarias. Selecciona un tema o busca para comenzar tu exploración.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar tema, figura, texto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-600 mr-2"></i> <!-- Icono Libro -->
                 Índice Temático
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando índice de temas...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No se encontraron temas para tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Cargar Más Temas (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <p>Consultando los archivos...</p>
                 <div id="minigame-container">
                     <div id="minigame-status">
                         Nivel <span id="minigame-level">1</span>: Construyendo...
                         <div id="minigame-progress">Piedras: 0 / 10</div>
                     </div>
                     <div id="minigame-wall">
                         <!-- Stones will be added here by JS -->
                     </div>
                     <button id="minigame-button">Colocar Piedra</button>
                 </div>
                 <p style="font-size: 0.8em; margin-top: 1rem; color: var(--color-text-muted);">¡Juega mientras esperas!</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al erudito...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Consulta sobre este tema...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos y de referencia sobre historia y cultura judía.</p>
              <p class="mt-1">Para estudios profundos, consulta fuentes académicas y rabínicas.</p>
              <p class="mt-2">© 2025 Exploración Interactiva</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Tanakh - Torah
            "El Libro del Génesis (Bereshit): Resumen", "Historia de la Creación (Génesis 1-2)", "Adán y Eva en el Jardín del Edén", "Caín y Abel", "Noé y el Diluvio Universal", "La Torre de Babel", "La Vida de Abraham: Llamado y Pacto", "Abraham e Isaac: El Sacrificio (Akedá)", "La Historia de Jacob: Israel", "Los Doce Hijos de Jacob: Las Tribus", "La Historia de José en Egipto", "El Libro del Éxodo (Shemot): Resumen", "La Esclavitud en Egipto", "Moisés: Nacimiento y Llamado", "Las Diez Plagas de Egipto", "El Cruce del Mar Rojo", "La Entrega de la Torá en el Sinaí", "Los Diez Mandamientos", "El Becerro de Oro", "La Construcción del Tabernáculo (Mishkán)", "El Libro de Levítico (Vayikrá): Resumen", "Leyes de Santidad y Pureza Ritual", "Leyes de Sacrificios (Korbanot)", "Kashrut: Leyes Alimentarias Judías", "El Libro de Números (Bamidbar): Resumen", "El Censo de las Tribus", "Las Rebeliones en el Desierto", "La Historia de Balaam", "El Libro de Deuteronomio (Devarim): Resumen", "Repaso de las Leyes y Exhortaciones de Moisés", "El Shemá Israel", "La Muerte de Moisés",
            // Tanakh - Nevi'im (Profetas)
            "El Libro de Josué: La Conquista de Canaán", "La Caída de Jericó", "El Libro de los Jueces: Ciclos de Apostasía y Liberación", "Débora: Jueza y Profetisa", "Gedeón y los Madianitas", "Sansón: Fuerza y Debilidad", "El Libro de Samuel: Transición a la Monarquía", "Ana y el Nacimiento de Samuel", "Samuel: Juez y Profeta", "El Rey Saúl: Ascenso y Caída", "David y Goliat", "El Rey David: Reinado y Legado", "Jerusalén: Capital del Reino Unido", "El Pacto Davídico", "El Pecado de David y Betsabé", "El Rey Salomón: Sabiduría y Construcción del Templo", "El Primer Templo de Jerusalén", "La División del Reino: Israel y Judá", "El Libro de los Reyes: Historia de los Reinos Divididos", "El Profeta Elías: Milagros y Confrontaciones", "Elías en el Monte Carmelo", "El Profeta Eliseo: Sucesor de Elías", "El Profeta Isaías: Visiones y Profecías Mesiánicas", "El Profeta Jeremías: Lamentos y Advertencias", "El Profeta Ezequiel: Visiones del Exilio", "La Visión de los Huesos Secos", "Los Doce Profetas Menores (Oseas, Joel, Amós, etc.)", "El Profeta Jonás y la Ballena", "El Profeta Miqueas: Justicia Social",
            // Tanakh - Ketuvim (Escritos)
            "El Libro de los Salmos (Tehilim): Oraciones y Alabanzas", "Salmo 23: El Señor es mi Pastor", "Salmo 137: Junto a los ríos de Babilonia", "El Libro de Proverbios (Mishlei): Sabiduría Práctica", "El Libro de Job (Iyov): El Sufrimiento del Justo", "El Cantar de los Cantares (Shir Hashirim): Amor y Alegoría", "El Libro de Rut: Lealtad y Redención", "El Libro de Lamentaciones (Eijá): Duelo por Jerusalén", "El Libro de Eclesiastés (Kohelet): Vanidad y Sentido de la Vida", "El Libro de Ester: Salvación en Persia (Purim)", "El Libro de Daniel: Fe en el Exilio y Visiones Apocalípticas", "Daniel en el Foso de los Leones", "Los Libros de Esdras y Nehemías: Retorno del Exilio y Reconstrucción", "La Reconstrucción del Segundo Templo", "La Lectura Pública de la Torá por Esdras", "Los Libros de Crónicas: Genealogías e Historia Sacerdotal",
            // Figuras Históricas Clave
            "Abraham Avinu (Nuestro Padre Abraham)", "Sara, Rebeca, Raquel y Lea: Las Matriarcas", "Moisés Rabenu (Nuestro Maestro Moisés)", "Aarón, el Sumo Sacerdote", "Josué ben Nun", "Rey David", "Rey Salomón", "Reina Ester", "Rut la Moabita", "Judas Macabeo y la Revuelta Macabea", "Hillel el Anciano: Sabiduría y Paciencia", "Shamai: La Otra Gran Escuela", "Rabí Akiva: Erudito y Mártir", "Rabí Shimon bar Yojai (Rashbi) y el Zohar", "Yehudah Hanasí: Compilador de la Mishná", "Rashi (Rabí Shlomo Yitzhaki): Comentarista Fundamental", "Maimónides (Rambam): Filósofo y Codificador", "Nahmánides (Ramban): Comentarista y Cabalista", "Iosef Caro y el Shulján Aruj", "El Baal Shem Tov (Israel ben Eliezer): Fundador del Jasidismo", "El Gaón de Vilna (Eliyahu ben Shlomo Zalman)", "Moshé Mendelssohn y la Haskalá (Ilustración Judía)", "Theodor Herzl y el Sionismo Político Moderno", "Jaim Weizmann: Científico y Primer Presidente de Israel", "David Ben-Gurión: Primer Ministro Fundador de Israel", "Golda Meir: Primera Ministra de Israel", "Elie Wiesel: Sobreviviente del Holocausto y Premio Nobel", "Isaac Bashevis Singer: Escritor Yiddish y Premio Nobel", "Albert Einstein y su Identidad Judía",
            // Períodos Históricos
            "La Era Patriarcal", "El Éxodo de Egipto y la Travesía por el Desierto", "El Período de los Jueces", "La Monarquía Unida (Saúl, David, Salomón)", "El Reino Dividido: Israel y Judá", "El Exilio Babilónico (Galut Bavel)", "El Retorno a Sion y el Período del Segundo Templo", "La Dominación Persa", "La Helenización y la Revuelta Macabea", "La Dinastía Asmonea", "La Dominación Romana", "La Gran Revuelta Judía y la Destrucción del Segundo Templo (Año 70 EC)", "La Revuelta de Bar Kojba", "El Período de la Mishná y el Talmud (Era Rabínica)", "Las Academias Talmúdicas en Babilonia (Sura y Pumbedita)", "El Judaísmo bajo el Islam (Edad de Oro en España)", "Las Cruzadas y su Impacto en las Comunidades Judías", "La Expulsión de los Judíos de España (1492)", "El Desarrollo del Jasidismo en Europa del Este", "La Haskalá (Ilustración Judía) y sus Efectos", "La Emancipación Judía en Europa Occidental", "Los Pogromos en Rusia y Europa del Este", "La Emigración Judía a América y otros lugares", "El Surgimiento del Sionismo Moderno", "El Mandato Británico de Palestina", "El Holocausto (Shoá): Persecución y Genocidio", "La Creación del Estado de Israel (1948)", "Las Guerras Árabe-Israelíes", "La Historia de los Judíos en América Latina", "La Historia de los Judíos en Etiopía (Beta Israel)",
            // Conceptos y Prácticas Fundamentales
            "Monoteísmo Judío: La Creencia en un Solo Dios", "La Torá: Ley Escrita y Oral", "Mitzvot: Los Mandamientos (613)", "Halajá: La Ley Judía", "Shabat: El Día de Descanso Semanal", "Kashrut: Las Leyes Dietéticas", "Tefilá: La Oración Judía (Sidur, Minyán)", "Tzedaká: Justicia Social y Caridad", "Tikún Olam: Reparar el Mundo", "El Pacto (Brit) entre Dios e Israel", "Brit Milá: La Circuncisión", "Bar Mitzvá y Bat Mitzvá: Mayoría de Edad Religiosa", "El Matrimonio Judío (Kidushín)", "Leyes de Pureza Familiar (Taharat Hamishpajá)", "Duelo y Luto en el Judaísmo (Avelut)", "El Calendario Hebreo (Luaj)", "Sinagoga (Beit Knesset): Casa de Reunión", "Rabino: Maestro y Líder Espiritual", "Yeshivá: Centro de Estudio de la Torá", "El Talmud: Mishná y Guemará", "Midrash: Interpretación Exegética", "Kabbalah: Misticismo Judío", "El Zohar: Libro del Esplendor", "Jasidismo: Movimiento Espiritual", "Ética Judía (Musar)", "El Concepto de Mashíaj (Mesías)", "El Mundo Venidero (Olam Habá)",
            // Fiestas y Conmemoraciones (Yamim Tovim)
            "Rosh Hashaná: El Año Nuevo Judío", "El Sonido del Shofar", "Yom Kipur: El Día del Perdón", "El Ayuno de Yom Kipur", "Sucot: La Fiesta de las Cabañas (Tabernáculos)", "Las Cuatro Especies (Arba Minim)", "Simjat Torá: Alegría por la Torá", "Janucá: La Fiesta de las Luminarias", "La Historia de los Macabeos", "El Encendido de la Menorá de Janucá", "Purim: La Fiesta de las Suertes", "La Lectura de la Meguilá de Ester", "Pésaj (Pascua): La Liberación de Egipto", "El Seder de Pésaj", "La Matzá: El Pan Ázimo", "Shavuot: La Fiesta de las Semanas (Entrega de la Torá)", "Las Siete Especies de la Tierra de Israel", "Tishá BeAv: Día de Duelo por la Destrucción de los Templos", "Yom HaShoá: Día del Recuerdo del Holocausto", "Yom HaZikarón: Día del Recuerdo de los Caídos de Israel", "Yom HaAtzmaut: Día de la Independencia de Israel", "Tu Bishvat: Año Nuevo de los Árboles", "Lag BaÓmer: Celebración y Costumbres",
            // Diáspora y Comunidades Judías
            "Judaísmo Ashkenazí: Orígenes y Cultura (Yiddish)", "Judaísmo Sefardí: Orígenes y Cultura (Ladino)", "Judaísmo Mizrají: Judíos de Tierras Árabes e Irán", "Historia de los Judíos en España (Sefarad)", "Historia de los Judíos en Alemania y Europa Central", "Historia de los Judíos en Polonia y Rusia (Shtetl)", "Historia de los Judíos en Italia", "Historia de los Judíos en Marruecos", "Historia de los Judíos en Yemen", "Historia de los Judíos en Irak (Babilonia)", "Historia de los Judíos en los Estados Unidos", "Historia de los Judíos en Argentina", "Beta Israel: Los Judíos de Etiopía", "Judíos de la India (Bene Israel, Cochin, Baghdadi)", "Judíos Kaifeng de China",
            // Judaísmo Moderno y Contemporáneo
            "Las Corrientes del Judaísmo Moderno", "Judaísmo Ortodoxo (Moderno, Jaredí/Ultraortodoxo)", "Judaísmo Conservador (Masortí)", "Judaísmo Reformista (Progresista, Liberal)", "Judaísmo Reconstruccionista", "Judaísmo Humanista Secular", "El Movimiento Feminista en el Judaísmo", "El Diálogo Interreligioso", "Antisemitismo: Historia y Manifestaciones Modernas", "Negacionismo del Holocausto", "El Conflicto Israelí-Palestino: Perspectivas Históricas", "Aliyá: La Inmigración Judía a Israel", "La Sociedad Israelí Contemporánea: Diversidad y Desafíos", "El Judaísmo en la Era Digital", "Arte y Música Judía Contemporánea", "Literatura Judía Moderna y Contemporánea", "El Futuro del Pueblo Judío: Demografía y Tendencias",
            // Textos y Lenguas
            "La Biblia Hebrea (Tanakh)", "La Septuaginta: Traducción Griega", "Los Rollos del Mar Muerto", "La Mishná: Compilación de Ley Oral", "La Guemará: Discusión de la Mishná", "El Talmud de Jerusalén (Yerushalmi)", "El Talmud de Babilonia (Bavli)", "El Midrash Halajá y Agadá", "El Shulján Aruj: Código de Ley Judía", "Mishné Torá de Maimónides", "El Zohar y la Literatura Cabalística", "Literatura Responsa (She'elot u-Teshuvot)", "Literatura Musar (Ética)", "El Sidur: Libro de Oraciones", "La Majzor: Libro de Oraciones Festivas", "La Hagadá de Pésaj", "El Idioma Hebreo: Historia y Renacimiento", "El Idioma Arameo y su Importancia Textual", "El Idioma Yiddish: Origen y Cultura", "El Idioma Ladino (Judeoespañol): Origen y Cultura",
            // Símbolos y Objetos Rituales
            "La Estrella de David (Maguén David)", "La Menorá: Candelabro de Siete Brazos", "El Shofar: Cuerno de Carnero", "El Talit: Manto de Oración", "Los Tzitzit: Flecos Rituales", "Los Tefilín: Filacterias", "La Mezuzá: Pergamino en la Jamba", "El Arca de la Alianza (Arón HaBrit)", "El Arca Sagrada (Arón HaKodesh) en la Sinagoga", "El Rollo de la Torá (Séfer Torá)", "El Yad: Puntero para la Lectura de la Torá", "La Kipá (Yarmulke): Cobertura para la Cabeza", "La Jupá: Dosel Nupcial", "Las Velas de Shabat y Festividades", "La Copa de Kidush", "El Plato del Seder (Keará)", "El Dreidel (Sevivón) de Janucá",
            // Arqueología y Lugares
            "Arqueología Bíblica: Descubrimientos y Controversias", "La Ciudad de David en Jerusalén", "El Muro Occidental (Kotel / Muro de los Lamentos)", "El Monte del Templo (Har HaBait)", "Masada: Fortaleza y Símbolo", "Qumrán y los Rollos del Mar Muerto", "Sinagogas Antiguas en Galilea e Israel", "La Diáspora Judía a través de la Arqueología", "El Museo de Israel en Jerusalén", "Yad Vashem: Memorial del Holocausto", "El Museo de la Diáspora (ANU) en Tel Aviv", "Lugares Sagrados en Hebrón: Tumba de los Patriarcas", "Safed (Tzfat): Cuna de la Kabbalah", "Tiberíades (Tveria) y su Historia",
        ]; // ¡Más de 500 títulos iniciales!
        const judaismThemes = [
            "historias del Tanakh", "personajes bíblicos judíos", "historia antigua de Israel", "el Segundo Templo",
            "el Talmud y la ley judía", "filosofía judía medieval", "Maimónides", "Rashi", "Kabbalah y misticismo judío",
            "historia de los judíos en España", "historia de los judíos Ashkenazí", "historia de los judíos Sefardí",
            "historia de los judíos Mizrají", "Jasidismo", "la Haskalá", "Sionismo moderno", "el Holocausto (Shoá)",
            "el Estado de Israel", "fiestas judías (Yamim Tovim)", "ciclo de vida judío", "prácticas y rituales judíos",
            "Shabat", "Kashrut", "sinagoga y oración", "Tzedaká y ética judía", "corrientes del judaísmo moderno",
            "antisemitismo", "cultura Yiddish", "cultura Ladina", "lengua hebrea", "símbolos judíos", "arqueología bíblica"
        ];
        const textApiConfig = {
            model: "mistral", // o un modelo más potente si se requiere más profundidad
            systemPrompt: "Eres un erudito e historiador especializado en Estudios Judaicos. Tu tarea es explicar el tema, figura, texto o concepto del judaísmo indicado, de manera informativa, precisa, respetuosa y contextualizada históricamente. Cubre sus orígenes, significado, desarrollo, importancia cultural y/o religiosa, y prácticas asociadas (si aplica). Utiliza un lenguaje claro y accesible, pero manteniendo rigor académico. El objetivo es una explicación detallada de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tema del judaísmo:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Más rápido para chat
             systemPrompt: "Actúa como un asistente experto en el tema específico del judaísmo que se está mostrando. Responde preguntas de seguimiento sobre sus detalles, contexto, o aspectos relacionados mencionados en la descripción principal. Sé conciso, preciso y mantén un tono respetuoso y educativo.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador conciso de temas para una enciclopedia sobre Judaísmo. Genera exactamente 40 nombres de figuras históricas, textos sagrados, conceptos teológicos, prácticas rituales, fiestas, períodos históricos o comunidades judías, adecuados para una descripción detallada. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo para generar 40
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que la versión anterior, pero añadiendo los elementos del minigame)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Contenedor del minigame ahora
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameContainer = document.getElementById('minigame-container');
        const minigameWall = document.getElementById('minigame-wall');
        const minigameButton = document.getElementById('minigame-button');
        const minigameLevelDisplay = document.getElementById('minigame-level');
        const minigameProgressDisplay = document.getElementById('minigame-progress');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Para chat context
        // Minigame State
        let gameActive = false;
        let currentLevel = 1;
        let stonesPlaced = 0;
        let stonesNeeded = 10; // Initial stones for level 1
        const maxLevels = 5; // Example max levels

        // ========== MINIGAME FUNCTIONS ==========
        function resetMinigame() {
            currentLevel = 1;
            stonesPlaced = 0;
            stonesNeeded = 10; // Reset stones needed for level 1
            minigameWall.innerHTML = ''; // Clear the wall
            updateMinigameUI();
            minigameButton.disabled = false;
            minigameButton.textContent = 'Colocar Piedra';
             // Pre-create stone elements for efficiency? Or create on demand. Let's try on demand.
             for (let i = 0; i < stonesNeeded * maxLevels; i++) { // Create max possible stones upfront but hidden
                const stone = document.createElement('div');
                stone.classList.add('minigame-stone');
                stone.id = `stone-${i}`; // Unique ID
                minigameWall.appendChild(stone);
            }
        }

        function updateMinigameUI() {
            minigameLevelDisplay.textContent = currentLevel;
            minigameProgressDisplay.textContent = `Piedras: ${stonesPlaced} / ${stonesNeeded}`;

            // Show placed stones visually
            const stoneElements = minigameWall.querySelectorAll('.minigame-stone');
            let totalStonesPlacedSoFar = 0;
             // Calculate total stones from previous levels + current level progress
            for(let i = 1; i < currentLevel; i++) {
                 totalStonesPlacedSoFar += 10 + (i-1)*5; // Stones needed for level i
            }
            totalStonesPlacedSoFar += stonesPlaced;

            stoneElements.forEach((stone, index) => {
                 if(index < totalStonesPlacedSoFar) {
                     stone.classList.add('placed');
                     // Add decoration based on level maybe?
                     if(currentLevel >= 3 && (index % 5 === 0)) {
                         stone.classList.add('decorative');
                     } else {
                         stone.classList.remove('decorative');
                     }
                 } else {
                     stone.classList.remove('placed', 'decorative');
                 }
            });
        }

        function handlePlaceStone() {
            if (!gameActive || stonesPlaced >= stonesNeeded) return;

            stonesPlaced++;
            updateMinigameUI();

            if (stonesPlaced >= stonesNeeded) {
                // Level Complete!
                if (currentLevel < maxLevels) {
                    currentLevel++;
                    stonesPlaced = 0;
                    stonesNeeded = 10 + (currentLevel - 1) * 5; // Increase difficulty slightly
                    updateMinigameUI(); // Update level display etc.
                    // Maybe flash the level number?
                } else {
                    // Game Complete!
                    minigameButton.disabled = true;
                    minigameButton.textContent = '¡Construido!';
                    gameActive = false; // Stop game if max level reached
                }
            }
        }

        function startGame() {
            if (!modalLoadingIndicator) return;
            console.log("Starting Minigame...");
            resetMinigame();
            gameActive = true;
            modalLoadingIndicator.style.display = 'flex'; // Show the loading area with the game
            minigameButton.disabled = false;
            minigameButton.addEventListener('click', handlePlaceStone);
        }

        function stopGame() {
            if (!modalLoadingIndicator) return;
            console.log("Stopping Minigame.");
            gameActive = false;
            modalLoadingIndicator.style.display = 'none'; // Hide the loading area
            minigameButton.removeEventListener('click', handlePlaceStone);
            minigameButton.disabled = true; // Ensure button is disabled when stopped
        }

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentTopicTitle
                ? `Eres un asistente experto únicamente en el tema del judaísmo llamado '${currentTopicTitle}'. Responde preguntas de seguimiento sobre sus detalles, contexto, o aspectos relacionados mencionados en la descripción principal. Sé conciso, preciso y mantén un tono respetuoso y educativo.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento. Por favor, intente de nuevo en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o seleccionar otro tema.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }

        async function fetchExplanationText(topicTitle) {
            return fetchTextFromApi(topicTitle, textApiConfig, false);
        }

        async function fetchChatResponse(userQuery) {
            if (!currentTopicTitle) throw new Error("Error interno: No se ha establecido el contexto del tema para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }

        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(judaismThemes) || "conceptos generales del judaísmo";
            // *** MODIFIED Prompt to request 40 titles ***
            const specificPrompt = `Genera exactamente 40 ítems (figuras, textos, conceptos, fiestas, etc.) sobre ${randomTheme}`;
            // Use the specific config for title generation
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n')
                                     .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                     .filter(line => line.length > 3 && line.length < 150); // Basic filtering
                     if (titles.length < 10) { // Expecting more given the request for 40
                         console.warn(`API generated fewer titles than expected (${titles.length} instead of 40)`);
                         if (titles.length === 0) throw new Error("La IA no generó ningún tema nuevo.");
                     }
                     return titles.slice(0, 40); // Return up to 40 generated titles
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Jewish history and culture abstract";
            // Prompt focused on conceptual/symbolic, avoiding potentially sensitive literal depictions
            const enhancedPrompt = `Conceptual artistic illustration inspired by '${safePromptText}'. Focus on symbolism, historical atmosphere, light, textures (parchment, stone), or abstract representations. Use a palette of blues, whites, golds, earth tones. Avoid depicting specific faces, explicit religious rituals unless clearly symbolic, direct text, labels, modern flags unless context is modern Israel. Respectful and evocative style.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "photorealistic human faces, offensive symbols, hate speech, text, words, labels, diagrams, charts, maps, flags (except Israeli flag in modern context), watermark, signature, cartoonish, caricature, ugly, deformed";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (code identical to previous version) ... */
             if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             stopGame(); // Explicitly stop the game and hide the loading overlay
             modalStoryContentArea.classList.add('content-hidden'); // Hide main content area
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (code identical) ... */
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() { /* ... (code identical) ... */
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... (code identical) ... */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... (code identical) ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... (code identical, uses fetchChatResponse) ... */
             const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">No hay temas disponibles en el índice.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to integrate minigame ***
        async function handleTitleClick(title) {
            resetModalState(); // Reset everything including stopping any previous game instance
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalStoryContentArea.classList.add('content-hidden'); // Hide content area initially

            startGame(); // *** START MINIGAME ***

            try {
                // Fetch text while game is running
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                stopGame(); // *** STOP MINIGAME ***

                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Show content + chat
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Image Loading (after main content is ready)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando imagen conceptual...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo cargar la imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                stopGame(); // *** STOP MINIGAME ON ERROR TOO ***
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar datos.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles to request 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más temas...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Function now requests 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más temas en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar temas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Update button text to reflect it loads 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Cargar Más Temas (40)';
             }
         }

         // *** Search Filter Function (improved normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalLoadingIndicator || !minigameButton) {
                console.error("Initialization failed: Missing essential elements (incl. minigame).");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error crítico: No se pudieron cargar los componentes de la página.</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Minigame listener (initial setup in startGame)

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            // Set initial button text for generate more
            generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Cargar Más Temas (40)';
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>