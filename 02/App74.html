<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorando la Historia de Colombia</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Historia de Colombia --- */
        :root {
            --color-primary: #0033A0; /* Azul oscuro institucional */
            --color-secondary: #CE1126; /* Rojo quemado (referencia sutil bandera) */
            --color-accent: #FCD116; /* Amarillo/Ocre (referencia sutil bandera/oro) */
            --color-background: #F4F4F4; /* Gris muy claro, casi blanco */
            --color-text: #212529; /* Negro suave */
            --color-text-muted: #6c757d; /* Gris medio */
            --color-modal-bg: #FFFFFF; /* Blanco puro para modal */
            --color-border: #DEE2E6; /* Gris claro para bordes */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 5px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.5rem; display: inline-block; }
        #modal-title { color: var(--color-primary); }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Lato', sans-serif; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #e9ecef; /* Gris más claro hover */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #002269; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(33, 37, 41, 0.85); /* Overlay oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 2rem 2.5rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 350px; /* Asegura espacio para loading */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--color-border);
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #adb5bd; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.5rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: #ffffff; }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }
        #modal-content {
            line-height: 1.75;
            color: var(--color-text);
            white-space: normal;
            overflow-y: auto;
            padding: 0 10px 1.5rem 10px; /* Padding inferior para espacio post-imagen */
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content::-webkit-scrollbar { width: 9px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { font-style: italic; color: #495057; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: bold; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        /* Estilo para la imagen insertada al final del contenido */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #e9ecef; /* Fondo claro si imagen tarda */ }
        /* Estilo para el placeholder/spinner de la imagen final */
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid #adb5bd; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.2rem; font-family: 'Lato'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #f8d7da; color: #721c24; padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #f5c6cb; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex justify-center items-center">
             <div class="flex items-center text-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-landmark mr-3"></i> <!-- Icono de hito/historia -->
                     Historia de Colombia: Un Relato Interactivo
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Descubre los Hitos de Nuestra Nación</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto">Navega a través de eventos, personajes y épocas que forjaron la Colombia de hoy. Selecciona un tema para iniciar tu viaje.</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-800 mr-2"></i> <!-- Icono libro abierto -->
                 Capítulos de Nuestra Historia
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Consultando los archivos históricos...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Temas Históricos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Elaborando relato histórico...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - Imagen se añade al final aquí -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                     <!-- Imagen y placeholder se añadirán aquí vía JS -->
                 </div>
                 <!-- NO hay contenedor de imagen fijo -->
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-700 py-6 mt-12 border-t border-gray-300">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Relatos históricos generados por IA con fines educativos e informativos. Pueden existir interpretaciones diversas de los hechos.</p>
              <p class="mt-1">Se recomienda consultar fuentes académicas y primarias para una comprensión profunda.</p>
              <p class="mt-2">© 2025 Explorando la Historia de Colombia</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // ÉPOCA PRECOLOMBINA
            "Los primeros pobladores de Colombia: ¿Quiénes eran y cuándo llegaron?",
            "La Cultura Muisca: Organización social y política",
            "La leyenda de El Dorado: Mito y realidad",
            "El Zipa y el Zaque: Líderes Muiscas",
            "La orfebrería Muisca: Técnicas y significado",
            "La Cultura Tayrona y la Ciudad Perdida (Teyuna)",
            "Ingeniería Tayrona: Terrazas y caminos",
            "La Cultura Quimbaya: Maestros de la orfebrería",
            "El Tesoro de los Quimbayas: Historia y destino",
            "La Cultura Zenú: Canales y manejo del agua",
            "La Cultura Calima: Diversidad y periodos",
            "La Cultura Tumaco-La Tolita: Cerámica y figuras",
            "San Agustín: Parque arqueológico y estatuaria monumental",
            "Tierradentro: Hipogeos y cultura funeraria",
            "Las rutas comerciales precolombinas en Colombia",
            "Cosmovisión y religión de los pueblos indígenas precolombinos",
            "Agricultura precolombina: Maíz, papa y otros cultivos",
            "El impacto de las enfermedades europeas en la población indígena",
            "Resistencia indígena a la conquista española",
            "Lenguas indígenas de Colombia: Diversidad y legado",
            "El Poporo Quimbaya: Símbolo y función",
            "Arte rupestre en Colombia: Chiribiquete y otros sitios",
            "Navegación y canoas en los ríos precolombinos",
            "Chamanismo y plantas sagradas en las culturas indígenas",
            "Astronomía y calendarios precolombinos",
            "La figura del Cacique en las sociedades indígenas",
            "Guerra y conflicto entre pueblos precolombinos",
            "Mitos de creación de las culturas Muisca y Tayrona",
            "Impacto ambiental de las sociedades precolombinas",
            "El legado genético indígena en la Colombia actual",

            // CONQUISTA Y COLONIA
            "El primer contacto: Llegada de los españoles a costas colombianas",
            "Rodrigo de Bastidas y la fundación de Santa Marta",
            "Pedro de Heredia y la fundación de Cartagena de Indias",
            "Gonzalo Jiménez de Quesada y la expedición hacia el interior",
            "La fundación de Santafé de Bogotá (1538)",
            "Sebastián de Belalcázar y la conquista del suroccidente",
            "Nicolás de Federmán y la expedición alemana",
            "La búsqueda fallida de El Dorado durante la conquista",
            "La Encomienda: Sistema de explotación indígena",
            "La Mita: Trabajo forzado en minas y haciendas",
            "La evangelización: Órdenes religiosas y conversión forzada",
            "Las Leyes Nuevas de 1542 y la protección (limitada) indígena",
            "Creación de la Real Audiencia de Santafé",
            "El Virreinato de la Nueva Granada: Establecimiento y territorio",
            "Cartagena de Indias: Puerto negrero y fortaleza militar",
            "Los ataques piratas a Cartagena (Francis Drake, Henry Morgan)",
            "La esclavitud africana en la Nueva Granada",
            "Palenques: Comunidades de cimarrones y resistencia negra (San Basilio)",
            "La economía colonial: Minería (oro, plata, esmeraldas)",
            "La economía colonial: Haciendas y agricultura",
            "El sistema de castas colonial: Mestizaje y jerarquía social",
            "La Inquisición en Cartagena de Indias",
            "La Expedición Botánica del Nuevo Reino de Granada (José Celestino Mutis)",
            "Las Reformas Borbónicas y su impacto en la Nueva Granada",
            "La Rebelión de los Comuneros (1781): Causas y consecuencias",
            "Manuela Beltrán y el inicio de la revuelta comunera",
            "José Antonio Galán: Líder comunero y su ejecución",
            "Antonio Nariño y la traducción de los Derechos del Hombre",
            "Camilo Torres Tenorio y el Memorial de Agravios",
            "La influencia de la Ilustración en la élite criolla",
            "La crisis de la monarquía española (invasión napoleónica)",
            "La vida cotidiana en la colonia: Ciudades y campo",
            "Arte y arquitectura colonial en Colombia (Barroco neogranadino)",
            "La música y las danzas durante la colonia",
            "El rol de la mujer en la sociedad colonial",
            "Educación colonial: Colegios mayores y universidades",
            "Las misiones jesuíticas en los Llanos Orientales",
            "Conflictos fronterizos coloniales (Portugal, Inglaterra)",
            "Ciencia y conocimiento en la Nueva Granada",
            "Desastres naturales y epidemias en la colonia",

            // INDEPENDENCIA Y SIGLO XIX
            "El Grito de Independencia: 20 de julio de 1810 en Santafé",
            "Las Juntas de Gobierno en la Nueva Granada",
            "La Patria Boba: Federalismo vs. Centralismo (1810-1816)",
            "Antonio Nariño vs. Camilo Torres: Líderes enfrentados",
            "La Reconquista Española: Pablo Morillo y el Régimen del Terror",
            "Policarpa Salavarrieta 'La Pola': Espía y mártir",
            "Simón Bolívar: El Libertador y su campaña militar",
            "Francisco de Paula Santander: El Hombre de las Leyes",
            "La Campaña Libertadora de 1819",
            "El Paso de los Andes: Una hazaña militar",
            "La Batalla del Pantano de Vargas",
            "La Batalla de Boyacá (7 de agosto de 1819): Sello de la independencia",
            "Creación de la Gran Colombia (1819-1831)",
            "El Congreso de Cúcuta (1821) y la primera constitución",
            "Liberación de Venezuela (Carabobo) y Ecuador (Pichincha)",
            "La Campaña del Sur: Junín y Ayacucho (liberación de Perú y Bolivia)",
            "Las tensiones internas en la Gran Colombia",
            "La Conspiración Septembrina contra Bolívar (1828)",
            "Manuela Sáenz: Libertadora del Libertador",
            "La disolución de la Gran Colombia: Causas",
            "Nacimiento de la República de la Nueva Granada (1832)",
            "Presidencia de Santander y la organización del estado",
            "La Guerra de los Supremos (1839-1842)",
            "Los partidos tradicionales: Origen de Liberales y Conservadores",
            "Las reformas liberales de mediados del siglo XIX (José Hilario López, José María Obando)",
            "La abolición de la esclavitud en Colombia (1851)",
            "La separación Iglesia-Estado y la expulsión de los Jesuitas",
            "La Constitución de 1853: Liberalismo radical",
            "La Constitución de Rionegro (1863): Estados Unidos de Colombia y federalismo extremo",
            "Las guerras civiles de 1851, 1860-1862, 1876-1877, 1885, 1895",
            "Tomás Cipriano de Mosquera: Figura dominante y controversial",
            "La Regeneración: Rafael Núñez y Miguel Antonio Caro",
            "La Constitución de 1886: Centralismo y hegemonía conservadora",
            "El Concordato de 1887 con la Santa Sede",
            "La Guerra de los Mil Días (1899-1902): Causas y desarrollo",
            "Las batallas de Peralonso y Palonegro",
            "El Tratado de Wisconsin: Fin de la Guerra de los Mil Días",
            "La Separación de Panamá (1903): Contexto e intervención estadounidense",
            "El Tratado Herrán-Hay y su rechazo por Colombia",
            "El Tratado Hay-Bunau Varilla",
            "La colonización antioqueña y el desarrollo cafetero",
            "El impacto del café en la economía y sociedad colombiana",
            "Construcción de ferrocarriles en el siglo XIX",
            "Literatura del siglo XIX: Romanticismo y Costumbrismo (Jorge Isaacs, Rafael Pombo)",
            "Prensa y opinión pública en el siglo XIX",
            "La Comisión Corográfica (Agustín Codazzi)",
            "Vida urbana y rural en el siglo XIX",
            "La medicina y la salud pública decimonónica",
            "Intentos de industrialización temprana",
            "Relaciones internacionales de Colombia en el siglo XIX",

            // SIGLO XX (Primera mitad)
            "La Hegemonía Conservadora (hasta 1930)",
            "Presidencia de Rafael Reyes: Quinquenio y modernización autoritaria",
            "El Tratado Urrutia-Thomson: Indemnización por Panamá",
            "El surgimiento del movimiento obrero y las primeras huelgas",
            "La Masacre de las Bananeras (1928): Evento y repercusiones",
            "La novela 'La Vorágine' de José Eustasio Rivera: Denuncia social",
            "El fin de la Hegemonía Conservadora: Elección de Enrique Olaya Herrera (1930)",
            "La República Liberal (1930-1946)",
            "La Guerra Colombo-Peruana (1932-1933) por Leticia",
            "La Revolución en Marcha: Reformas de Alfonso López Pumarejo (1934-1938)",
            "La reforma agraria de 1936",
            "La reforma educativa y la Universidad Nacional",
            "El Bogotazo: Asesinato de Jorge Eliécer Gaitán (9 de abril de 1948)",
            "Consecuencias inmediatas del Bogotazo: Violencia y destrucción",
            "Inicio de 'La Violencia' bipartidista (aprox. 1948-1958)",
            "Los 'pájaros' y los 'chusmeros': Actores armados de La Violencia",
            "Desplazamiento forzado y masacres durante La Violencia",
            "El papel de Laureano Gómez y Mariano Ospina Pérez",
            "El surgimiento de las guerrillas liberales y comunistas (autodefensas campesinas)",
            "El golpe de estado de Gustavo Rojas Pinilla (1953)",
            "La dictadura de Rojas Pinilla: Obras públicas y represión",
            "La caída de Rojas Pinilla (1957)",
            "El Frente Nacional: Acuerdo bipartidista para alternar el poder (1958-1974)",
            "Objetivos y críticas al Frente Nacional",
            "Primer gobierno del Frente Nacional: Alberto Lleras Camargo",
            "Segundo gobierno del Frente Nacional: Guillermo León Valencia",
            "La Alianza para el Progreso y su impacto en Colombia",
            "Surgimiento de las guerrillas modernas: FARC-EP (1964)",
            "Surgimiento de las guerrillas modernas: ELN (1964)",
            "Surgimiento de las guerrillas modernas: EPL (1967)",
            "Tercer gobierno del Frente Nacional: Carlos Lleras Restrepo (Reformas)",
            "El INCORA y la reforma agraria de Lleras Restrepo",
            "Cuarto gobierno del Frente Nacional: Misael Pastrana Borrero",
            "Las elecciones de 1970: Fraude electoral contra Rojas Pinilla (ANAPO)?",
            "Surgimiento del M-19 (Movimiento 19 de Abril) (1974)",
            "El fin formal del Frente Nacional y la persistencia del bipartidismo",
            "El 'boom' marimbero en la Costa Caribe",
            "El Estatuto de Seguridad de Julio César Turbay Ayala (1978)",
            "El robo de armas del Cantón Norte por el M-19 (1979)",
            "La Bonanza Cafetera de los años 70",
            "Crecimiento urbano y migraciones internas",
            "Desarrollo industrial y modelo de sustitución de importaciones",
            "Literatura colombiana del siglo XX (antes de García Márquez)",
            "Arte colombiano: Débora Arango, Alejandro Obregón, Fernando Botero",
            "Música popular colombiana: Cumbia, Porro, Vallenato, Bambuco",
            "El cine colombiano: Primeras décadas",
            "El deporte colombiano: Primeros éxitos internacionales",

            // SIGLO XX (Segunda mitad) y SIGLO XXI
            "El narcotráfico: Surgimiento de los carteles (Medellín, Cali)",
            "Pablo Escobar Gaviria: Ascenso y poder",
            "El Cartel de Medellín vs. el Estado Colombiano",
            "Asesinatos de Rodrigo Lara Bonilla, Guillermo Cano, Luis Carlos Galán",
            "El Narcoterrorismo: Bombas y magnicidios",
            "La toma del Palacio de Justicia por el M-19 (1985)",
            "La retoma del Palacio de Justicia por el Ejército: Tragedia y desaparecidos",
            "La erupción del Nevado del Ruiz y la tragedia de Armero (1985)",
            "Presidencia de Virgilio Barco: Lucha contra el narcotráfico",
            "Presidencia de César Gaviria: Apertura económica",
            "La Asamblea Nacional Constituyente y la Constitución de 1991",
            "Principales cambios introducidos por la Constitución de 1991 (Tutela, Fiscalía, etc.)",
            "La desmovilización del M-19, EPL, Quintín Lame",
            "La muerte de Pablo Escobar (1993)",
            "El Cartel de Cali: Los hermanos Rodríguez Orejuela",
            "El Proceso 8.000: Narcofinanciación de la campaña de Ernesto Samper",
            "El surgimiento y expansión del paramilitarismo: Las AUC (Autodefensas Unidas de Colombia)",
            "Masacres paramilitares: Mapiripán, El Salado, etc.",
            "Presidencia de Andrés Pastrana: Los diálogos del Caguán con las FARC",
            "El Plan Colombia: Ayuda militar y social de EE.UU.",
            "Presidencia de Álvaro Uribe Vélez: Política de Seguridad Democrática",
            "Ofensiva militar contra las FARC: Operación Jaque, muerte de Raúl Reyes",
            "El escándalo de los 'Falsos Positivos'",
            "La desmovilización de las AUC: Proceso de Santa Fe de Ralito (Justicia y Paz)",
            "Presidencia de Juan Manuel Santos: Inicio de los diálogos de paz con las FARC",
            "Los Acuerdos de Paz de La Habana (2016)",
            "El Plebiscito por la Paz y la victoria del 'No'",
            "Reimplementación del Acuerdo de Paz vía Congreso",
            "La Jurisdicción Especial para la Paz (JEP)",
            "Retos del posconflicto: Seguridad, desarrollo rural, reintegración",
            "Persistencia del conflicto con el ELN y disidencias de las FARC",
            "El Paro Nacional de 2019 y 2021: Causas y protestas sociales",
            "La crisis migratoria venezolana y su impacto en Colombia",
            "Desafíos económicos de Colombia en el siglo XXI (petróleo, diversificación)",
            "Avances y retos en derechos humanos en Colombia",
            "Gabriel García Márquez y el Boom Latinoamericano (Cien Años de Soledad)",
            "Otros escritores colombianos contemporáneos destacados",
            "Cine colombiano reciente: Reconocimiento internacional",
            "Música colombiana contemporánea: Shakira, Juanes, J Balvin, etc.",
            "Ciencia y tecnología en la Colombia moderna",
            "El papel de Colombia en organismos internacionales (OEA, CAN, Alianza del Pacífico)",
            "Desafíos ambientales: Deforestación, minería ilegal, cambio climático",
            "La diversidad cultural de Colombia: Regiones y expresiones",
            "El fútbol colombiano: Pasión y reflejo social",
            "El ciclismo colombiano: 'Escarabajos' y triunfos",
            "Gastronomía colombiana: Platos típicos regionales",
            "Turismo en Colombia: Crecimiento y potencial",
            // Conceptos transversales
            "El bipartidismo liberal-conservador: Una constante histórica",
            "El centralismo vs. federalismo en la historia colombiana",
            "El problema de la tierra: Concentración y conflicto agrario",
            "El papel de las Fuerzas Armadas en la historia política",
            "La corrupción como problema histórico y estructural",
            "La violencia política en Colombia: Ciclos y características",
            "El desplazamiento forzado: Una tragedia recurrente",
            "El impacto del narcotráfico en la sociedad y la cultura",
            "La búsqueda de la paz: Intentos fallidos y logros",
            "La construcción de la identidad nacional colombiana",
            "Relaciones Colombia-Estados Unidos a lo largo de la historia",
            "Relaciones Colombia-Venezuela: Tensiones y hermandad",
            "El regionalismo en Colombia: Antioquia, Costa Caribe, Valle, etc.",
            "Mujeres destacadas en la historia de Colombia",
            "Movimientos sociales y sindicalismo en Colombia"
        ];
        const historyThemes = [
            "la Época Precolombina en Colombia", "la Conquista y Colonia española", "la Independencia de Colombia",
            "el siglo XIX colombiano y sus guerras civiles", "la Guerra de los Mil Días y la separación de Panamá",
            "la Hegemonía Conservadora y la República Liberal", "La Violencia bipartidista y el Bogotazo",
            "el Frente Nacional", "el surgimiento del conflicto armado moderno (guerrillas)",
            "el narcotráfico y los carteles", "la Constitución de 1991", "el paramilitarismo en Colombia",
            "el Proceso de Paz con las FARC", "figuras presidenciales clave de Colombia", "la economía colombiana a través del tiempo",
            "cultura y sociedad colombiana (arte, literatura, música)", "movimientos sociales en Colombia",
            "relaciones internacionales de Colombia", "desafíos contemporáneos de Colombia"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un historiador experto en Colombia, riguroso y objetivo. Tu tarea es explicar detalladamente eventos, periodos, conceptos o figuras clave de la historia colombiana para un público general interesado pero informado. Proporciona contexto, fechas importantes, actores principales, causas, desarrollo, consecuencias y diferentes interpretaciones (si aplica). Usa un lenguaje claro, estructurado y formal. El objetivo es un relato histórico conciso pero completo de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tema de la historia de Colombia:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un compendio de historia. Genera exactamente 15 temas, eventos, personajes o preguntas clave sobre la Historia de Colombia, adecuados para ser explicados en detalle. Devuelve *solo* la lista de temas/preguntas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Contenedor del texto e imagen final
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ========== (Sin cambios funcionales)
        async function fetchTextFromApi(prompt, config) { /* ... */
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo.`);
                 throw new Error(`Error de comunicación con la API: ${error.message}`);
             }
         }
        async function fetchExplanationText(conceptTitle) { /* ... */
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de")) {
                   throw new Error("La IA no pudo generar un relato adecuado o suficientemente detallado para este tema.");
               }
             return text;
         }
        async function fetchGeneratedTitles() { /* ... */
             const randomTheme = getRandomElement(historyThemes) || "eventos clave de la historia colombiana";
             const specificPrompt = `Genera 15 temas o preguntas clave sobre ${randomTheme}`;
             console.log("Generating titles with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150);
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de temas.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a HISTORIA COLOMBIA
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "escena histórica colombiana abstracta";
            // Prompt ENFOCADO en abstracción, simbolismo, evitando literalidad y texto.
            const enhancedPrompt = `Abstract artistic representation inspired by the Colombian historical theme '${safePromptText}'. Symbolic imagery, evocative landscape, cultural patterns, pre-columbian goldwork aesthetic, colonial architecture elements, or abstract representation of conflict/peace. Avoid literal depictions, flags, or text. Moody, atmospheric.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            // NEGATIVE PROMPT: Clave para evitar texto, banderas, fotos, diagramas.
            const negativePrompt = "text, words, writing, labels, titles, numbers, graphs, charts, diagrams, photograph, realistic portrait, modern people, flag of Colombia, user interface, map, newspaper, book page, specific identifiable historical figures looking at camera";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios funcionales)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); // Manejo básico LaTeX si aparece
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); // Subíndices
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); // Superíndices
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); // Flechas
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); // Fórmulas (poco probable aquí)
             // Manejo de Markdown para títulos/énfasis
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             // Párrafos
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; // No envolver títulos/fórmulas ya existentes
                 let content = block.replace(/\n/g, '<br>'); // Convertir saltos de línea dentro de un bloque en <br>
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Sin cambios funcionales)
        function showModal() { /* ... */ if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { /* ... */
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
         }
        function resetModalState() { /* ... */
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = ''; // Limpia texto e imagen anterior
             modalErrorMessage.textContent = '';
         }

        // ========== UI & EVENT HANDLERS ========== (Sin cambios funcionales, lógica de imagen al final mantenida)
        function getRandomElement(arr) { /* ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... */
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]);
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay temas históricos disponibles.</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        // *** MODIFIED: handleTitleClick mantiene la lógica de imagen al final ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = ''; // Limpia
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // 1. Obtener y formatear texto
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // 2. Ocultar carga, mostrar texto PRIMERO
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation; // Inyectar texto
                modalStoryContentArea.classList.remove('content-hidden');

                // 3. *** RESET SCROLL *** después de que el texto es visible
                modalContent.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // 4. Preparar y añadir placeholder/spinner DENTRO de #modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-palette placeholder-icon"></i> <!-- Icono paleta/arte -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando visualización conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Añadir al final

                // 5. Crear y añadir elemento imagen real (empieza a cargar)
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual para ${title}`;
                imgElement.style.display = 'none'; // Oculta hasta cargar

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove(); // Quitar placeholder
                    imgElement.style.display = 'block'; // Mostrar imagen
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-image-slash placeholder-icon"></i> <!-- Icono imagen rota -->
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">No se pudo cargar la visualización.</p>
                    `; // Actualizar placeholder en error
                };

                // Obtener URL y asignar src DESPUÉS de añadir listeners
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Añadir img al final del contenido
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">Error al generar URL de imagen.</p>
                    `;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = ''; // Limpiar en caso de error
            }
        }

        async function handleGenerateMoreTitles() { /* ... */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Investigando...'; // Texto temático
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block';
                 } else {
                     alert("No se pudieron encontrar más temas históricos en este momento."); // Texto temático
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar temas: ${error.message}`); // Texto temático
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Temas Históricos'; // Texto temático
             }
         }


        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p style="color: var(--color-secondary); font-size: 1.5em; text-align: center; padding-top: 5em;">Error: No se pudieron cargar los componentes esenciales de la página.</p>'; return; } // Error temático
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>