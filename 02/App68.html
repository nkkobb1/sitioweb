<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conceptos de Programación Nivel Experto</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Programación Experto (Dark Theme) --- */
        :root {
            --color-primary: #38bdf8; /* Light Blue (Links, interactive) */
            --color-secondary: #34d399; /* Emerald Green (Success, accent) */
            --color-background: #1f2937; /* Dark Gray-Blue */
            --color-surface: #374151;  /* Slightly Lighter Dark */
            --color-text: #e5e7eb; /* Light Gray (Main text) */
            --color-text-muted: #9ca3af; /* Medium Gray */
            --color-modal-bg: #1f2937; /* Same as background or slightly different dark */
            --color-border: #4b5563; /* Gray for borders */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.15); /* Adjusted for dark */
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.2), 0 2px 4px -2px rgb(0 0 0 / 0.15);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.25), 0 4px 6px -4px rgb(0 0 0 / 0.2);
            --border-radius: 6px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; }
        h1, h2, h3, h4, .logo { font-family: 'Poppins', sans-serif; font-weight: 700; } /* Distinct font for titles */
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-surface); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-surface); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 80px; font-family: 'Inter', sans-serif; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #4b5563; /* Slightly lighter surface on hover */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-background); padding: 0.75rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Inter', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #7dd3fc; /* Lighter blue */ box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #6b7280; color: var(--color-text-muted); cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.9); /* Darker, less transparent overlay */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-border); /* Add border to modal */
            padding: 2rem;
            max-width: 950px; /* Allow slightly wider modal */
            width: 95%;
            max-height: 90vh;
            min-height: 350px; /* Increased min-height */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 50%; width: 35px; height: 35px; font-size: 1.5rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: var(--color-border); color: var(--color-text); }
        #modal-title { color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1.5rem; font-size: 1.9rem; line-height: 1.3; }
        #modal-content { line-height: 1.8; color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 18px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content::-webkit-scrollbar { width: 10px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 5px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 5px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        /* Styling for code blocks (simple approach) */
        #modal-content pre { background-color: #2d3748; border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: 1em; margin: 1.5em 0; overflow-x: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.95em; color: #d1d5db; }
        #modal-content code { background-color: rgba(75, 85, 99, 0.5); /* Darker inline code bg */ padding: 0.2em 0.4em; border-radius: 3px; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; color: #f3f4f6; }
        #modal-content pre code { background-color: transparent; padding: 0; border-radius: 0; font-size: 1em; } /* Reset inline style within pre */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Poppins', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: bold; }
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.45em; }
        #modal-content h3 { font-size: 1.3em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.15em; color: var(--color-text-muted); border-bottom: none;}
        #modal-content .formula { /* Keep for potential math formulas if AI uses them */ text-align: center; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 1.1em; padding: 0.8em; margin: 1.2em 0; border: 1px solid var(--color-border); background-color: var(--color-surface); border-radius: var(--border-radius); overflow-x: auto; white-space: nowrap; }
        #modal-content .formula sub, #modal-content .formula sup { font-size: 0.8em; line-height: 0; position: relative; vertical-align: baseline; }
        #modal-content .formula sub { top: 0.5em; }
        #modal-content .formula sup { top: -0.5em; }
        #modal-image-container { width: 100%; height: 260px; /* Slightly taller */ background-color: var(--color-surface); border-radius: var(--border-radius); overflow: hidden; display: none; align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; margin-top: 1.5rem; }
        #modal-image-container.visible { display: flex; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(255, 255, 255, 0.1); width: 38px; height: 38px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 3.2rem; color: var(--color-border); display: none; } /* Code/Chip Icon */
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(31, 41, 55, 0.95); /* Loading overlay matches bg */ display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 7px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.25rem; font-family: 'Inter'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #5f2732; /* Dark red background */ color: #fecdd3; /* Light pink text */ padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #b91c1c; /* Darker red border */ margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-4 flex justify-center items-center">
             <div class="flex items-center text-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-code mr-3"></i>
                     Programación Experta
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Explorando Conceptos Avanzados</h1>
             <p class="text-xl text-gray-400 mb-8 max-w-3xl mx-auto">Sumérgete en temas complejos de programación y arquitectura de software con explicaciones detalladas generadas por IA. Elige un concepto para profundizar.</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-cogs text-emerald-400 mr-2"></i>
                 Conceptos Fundamentales (Avanzado)
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Compilando lista de conceptos...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Conceptos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Sintetizando conocimiento...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                 </div>
                  <!-- Image Container (Initially Hidden) -->
                 <div id="modal-image-container">
                     <div class="spinner"></div>
                      <i class="fas fa-microchip placeholder-icon"></i> <!-- Icono Placeholder: Chip o similar -->
                     <img id="modal-image" alt="Visualización abstracta del concepto de programación" />
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-bug"></i> <!-- Bug icon for error -->
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-800 text-gray-400 py-6 mt-12 border-t border-gray-700">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA con fines educativos sobre programación avanzada. La precisión técnica puede variar.</p>
              <p class="mt-1">Verifica siempre con documentación oficial, expertos y experimentación propia.</p>
              <p class="mt-2">© 2025 Programación Experta</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Algoritmos y Estructuras de Datos (Avanzado)
            "Análisis de Complejidad Amortizado", "Algoritmos Probabilísticos (Ej. Bloom Filters, HyperLogLog)", "Algoritmos de Grafos Avanzados (Ej. Max Flow, Min Cut)", "Programación Dinámica: Técnicas y Patrones", "Estructuras de Datos Persistentes", "Estructuras de Datos Sucintas", "Skip Lists: Implementación y Análisis", "Árboles B+ y su uso en Bases de Datos", "Tries (Árboles de Prefijos) y sus Aplicaciones", "Hashing Perfecto y Cuckoo Hashing", "Algoritmos Geométricos Computacionales (Ej. Convex Hull)", "Algoritmos de Aproximación para NP-Hard", "Teoría de Complejidad: Clases P, NP, NP-Completo, NP-Hard", "Reducciones Polinomiales", "Algoritmos Online vs Offline", "Streaming Algorithms (Algoritmos para Flujos de Datos)",

            // Paradigmas de Programación (Avanzado)
            "Programación Funcional: Monads y Functores Explicados", "Programación Funcional: Inmutabilidad y Efectos Secundarios", "Programación Funcional: Técnicas (Currying, Partial Application)", "Programación Reactiva (RxJava, RxJs, Project Reactor)", "Programación Orientada a Aspectos (AOP)", "Metaprogramación: Reflexión Avanzada y Code Generation", "Metaprogramación: Decoradores/Atributos en Profundidad", "Lenguajes de Dominio Específico (DSL): Diseño e Implementación", "Programación Lógica (Prolog): Fundamentos", "Principios SOLID: Aplicación Práctica y Errores Comunes", "Patrones de Diseño GoF: Uso Avanzado y Combinaciones", "Patrones GRASP (General Responsibility Assignment Software Patterns)", "Patrones Arquitectónicos (Microservicios, CQRS, Event Sourcing)", "Programación Concurrente vs Paralela: Diferencias Clave", "Programación Orientada a Agentes",

            // Concurrencia y Paralelismo
            "Modelos de Memoria y Sincronización (Java Memory Model, C++ Memory Order)", "Exclusión Mutua: Mutexes, Semáforos, Monitores", "Algoritmos y Estructuras de Datos Lock-Free / Wait-Free", "Detección y Prevención de Deadlocks", "Condiciones de Carrera: Identificación y Solución", "El Problema Productor-Consumidor: Soluciones Avanzadas", "Actores (Modelo Actor): Akka, Erlang/OTP", "Futuros, Promesas y Async/Await: Mecanismos Internos", "Programación Paralela con OpenMP / MPI", "GPU Computing (CUDA / OpenCL): Conceptos", "Message Queues (RabbitMQ, Kafka, SQS): Arquitectura y Casos de Uso", "Corrutinas (Kotlin, Python, Go): Funcionamiento Interno", "Transactional Memory (Software/Hardware)",

            // Sistemas Distribuidos y Arquitectura
            "Teorema CAP: Consistencia, Disponibilidad, Tolerancia a Particiones", "Consistencia Eventual vs Fuerte: Modelos y Trade-offs", "Algoritmos de Consenso Distribuido (Paxos, Raft)", "Bases de Datos Distribuidas: Sharding y Replicación", "Estrategias Avanzadas de Caching (Write-Through, Write-Back, Cache Invalidation)", "Balanceo de Carga: Algoritmos y Técnicas", "API Gateways y Service Mesh (Istio, Linkerd)", "Descubrimiento de Servicios (Consul, etcd, Zookeeper)", "Patrón Circuit Breaker: Implementación y Beneficios", "CQRS (Command Query Responsibility Segregation)", "Event Sourcing: Principios y Desafíos", "Arquitectura Hexagonal (Puertos y Adaptadores)", "Diseño Orientado al Dominio (DDD): Conceptos Clave (Bounded Context, Aggregate)", "Microservicios: Comunicación Síncrona vs Asíncrona", "Sagas para Transacciones Distribuidas", "Serverless Computing: Arquitectura y Limitaciones", "Infraestructura como Código (IaC): Terraform, Pulumi, CloudFormation", "Orquestación de Contenedores (Kubernetes): Arquitectura Interna", "Observabilidad: Logging, Métricas, Tracing Distribuido",

            // Lenguajes, Runtimes y Compiladores
            "Algoritmos de Recolección de Basura (Garbage Collection): Mark-Sweep, Generational, G1, ZGC/Shenandoah", "Compilación Just-In-Time (JIT): Funcionamiento y Optimizations", "Máquinas Virtuales (JVM, CLR): Arquitectura Interna", "Gestión de Memoria Avanzada: Stack vs Heap, Memory Pooling, Arenas", "Análisis y Prevención de Fugas de Memoria (Memory Leaks)", "Sistemas de Tipos Avanzados: Tipos Dependientes, Refinement Types", "Inferencia de Tipos: Algoritmo Hindley-Milner", "Covarianza y Contravarianza en Sistemas de Tipos", "Genericidad y Polimorfismo Paramétrico Avanzado", "Intérpretes vs Compiladores: Proceso de Traducción", "Fases de un Compilador: Análisis Léxico, Sintáctico, Semántico", "Árboles de Sintaxis Abstracta (AST): Generación y Manipulación", "Representación Intermedia (IR): LLVM IR, Bytecode", "Optimización de Compiladores: Técnicas Comunes (Inlining, Loop Unrolling)", "WebAssembly (Wasm): Conceptos y Casos de Uso",

            // Redes y Protocolos
            "TCP/IP: Control de Congestión (Reno, Cubic, BBR)", "TCP/IP: Slow Start, Fast Retransmit/Recovery", "HTTP/2 y HTTP/3: Diferencias y Mejoras (Multiplexing, QUIC)", "WebSockets: Protocolo y Casos de Uso Avanzados", "RPC (Remote Procedure Call): gRPC vs REST", "Protocolos de Serialización (Protobuf, Avro, MessagePack)", "TLS/SSL: Handshake en Detalle", "DNS: Funcionamiento Interno y Tipos de Registros", "UDP vs TCP: Cuándo Usar Cada Uno", "QUIC: El Protocolo sobre UDP",

            // Bases de Datos (Avanzado)
            "Motores de Almacenamiento (InnoDB, MyISAM, RocksDB): Arquitectura Interna", "Indexación Avanzada: Índices Compuestos, Cubrientes, Espaciales (R-Tree)", "Niveles de Aislamiento de Transacciones (Serializable, Snapshot Isolation)", "Control de Concurrencia Multiversión (MVCC)", "Optimización de Consultas SQL: Planes de Ejecución", "Bases de Datos NoSQL: Tipos (Key-Value, Document, Column-Family, Graph)", "Bases de Datos NewSQL", "Bases de Datos Vectoriales para IA/ML", "Replicación Lógica vs Física en Bases de Datos",

            // Seguridad
            "Criptografía Simétrica vs Asimétrica: Algoritmos (AES, RSA)", "Funciones Hash Criptográficas (SHA-256, SHA-3) y HMAC", "Firmas Digitales: Funcionamiento y Aplicaciones", "Ataques Comunes: SQL Injection, XSS, CSRF (Mitigación Avanzada)", "Ataques de Denegación de Servicio (DoS/DDoS): Tipos y Mitigación", "Autenticación vs Autorización: OAuth 2.0 y OpenID Connect", "JSON Web Tokens (JWT): Estructura y Seguridad", "Gestión Segura de Secretos (Vault, KMS)", "Seguridad en Contenedores y Kubernetes", "Análisis Estático y Dinámico de Seguridad (SAST/DAST)",

            // Sistemas Operativos (Avanzado)
            "Interacción Kernel / User Space: System Calls Internals", "Planificadores de CPU Avanzados (CFS, BFS)", "Mecanismos de Comunicación Inter-Procesos (IPC): Pipes, Shared Memory, Sockets", "Gestión de Memoria Virtual: Paginación y Segmentación Detallada", "Copy-on-Write (CoW)", "Sistemas de Archivos Avanzados (ZFS, Btrfs): Características", "Virtualización: Tipos (Full, Paravirtualization, Containerization)",

            // Prácticas de Ingeniería de Software (Avanzado)
            "Test-Driven Development (TDD): Más Allá de Rojo-Verde-Refactor", "Behavior-Driven Development (BDD) con Gherkin", "Pruebas de Propiedad (Property-Based Testing)", "Pruebas de Mutación", "Integración Continua y Despliegue Continuo (CI/CD): Pipelines Complejas", "Canary Releases y Blue-Green Deployments", "Ingeniería del Caos (Chaos Engineering)", "Refactorización a Gran Escala", "Manejo de Deuda Técnica Estratégico", "Revisión de Código Efectiva en Equipos Grandes",

            // Otros Temas Avanzados
            "Computación Cuántica: Qubits y Puertas Lógicas (Conceptos)", "Blockchain: Mecanismos de Consenso (Proof-of-Work, Proof-of-Stake)", "Contratos Inteligentes (Smart Contracts)", "Métodos Formales: Verificación de Software", "Inteligencia Artificial / Machine Learning para Desarrolladores (APIs, Despliegue)", "Procesamiento del Lenguaje Natural (NLP): Técnicas Básicas", "Ética en la Inteligencia Artificial y el Software"
            // ... (Continuar añadiendo hasta acercarse a 400 o más)
        ];
        const programmingThemes = [
            "algoritmos avanzados", "estructuras de datos complejas", "programación funcional profunda",
            "concurrencia y paralelismo experto", "sistemas distribuidos y arquitectura", "compiladores y runtimes",
            "bases de datos internas", "seguridad informática avanzada", "redes y protocolos detallados",
            "patrones de diseño y arquitectura", "metaprogramación", "ingeniería de software experta",
            "teoría de la computación", "sistemas operativos internos", "programación reactiva", "blockchain y cripto"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un Ingeniero de Software Principal / Arquitecto de Software con vasta experiencia y profundo conocimiento teórico y práctico. Tu tarea es explicar conceptos de programación y ciencias de la computación de nivel experto de forma detallada, precisa y clara para otros ingenieros experimentados. Profundiza en los mecanismos internos, los trade-offs, casos de uso complejos, posibles implementaciones (pseudocódigo o descripciones claras), y relaciona el concepto con otros temas avanzados. Usa terminología técnica precisa. El objetivo es una explicación exhaustiva de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente concepto:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un glosario técnico avanzado. Genera exactamente 15 conceptos o preguntas clave sobre programación o ciencias de la computación de nivel experto. Deben ser temas complejos y específicos. Devuelve *solo* la lista de conceptos/preguntas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // --- Variable to hold the current scroll listener ---
        let currentScrollHandler = null;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) {
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo más tarde o con otro concepto.`);
                 throw new Error(`Error de comunicación con la API: ${error.message}`);
             }
        }
        async function fetchExplanationText(conceptTitle) {
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              // Mantener una verificación de longitud mínima razonable, aunque el objetivo sea mayor
              if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de") || text.toLowerCase().includes("as an ai language model")) {
                   throw new Error("La IA no pudo generar una explicación suficientemente detallada o adecuada para este concepto experto.");
               }
             return text;
         }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(programmingThemes) || "conceptos de programación avanzada";
             const specificPrompt = `Genera 15 conceptos o preguntas clave sobre ${randomTheme}, de nivel experto`;
             console.log("Generating titles with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             // Filter more strictly for advanced topics
             const titles = text.split('\n')
                                .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                .filter(line => line.length > 15 && line.length < 150 && !line.toLowerCase().includes("básico") && !line.toLowerCase().includes("introducción"));
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de conceptos expertos.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "abstract programming concept";
             // Enhanced prompt for abstract tech visualization
             const enhancedPrompt = `Abstract digital art representing '${safePromptText}'. Visualization of complex algorithms, data structures, or system architecture. Use glowing nodes, interconnected lines, circuit board patterns, binary code streams, futuristic geometric shapes, logic flow visualization. Dark background, tech aesthetic.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Negative prompt to avoid irrelevant or simplistic elements
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, graphs, charts, diagrams, UI, interface, buttons, menus, person, people, office, desk, computer screen, laptop, keyboard, mouse, simple code snippet, logo, brand, mascot, realistic photo, drawing, illustration, tutorial screenshot";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ==========
         function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();

            // --- Handle Code Blocks First (Markdown style ```) ---
            // Replace ```language\n code \n``` blocks with <pre><code>
            formatted = formatted.replace(/```(\w*)\s*\n([\s\S]*?)\n```/g, (match, lang, code) => {
                const languageClass = lang ? `language-${lang}` : ''; // For potential syntax highlighting library later
                // Escape HTML within the code block
                const escapedCode = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                return `<pre><code class="${languageClass}">${escapedCode.trim()}</code></pre>`;
            });
             // Replace ```\n code \n``` blocks (no language specified)
             formatted = formatted.replace(/```\s*\n([\s\S]*?)\n```/g, (match, code) => {
                 const escapedCode = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                 return `<pre><code>${escapedCode.trim()}</code></pre>`;
             });


            // --- Standard Formatting (AFTER code blocks) ---
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             // Handle italics '*' carefully to avoid conflict with potential inline code `*` characters if ``` fails
             // Only apply if not preceded/followed by `
             formatted = formatted.replace(/(?<!`)(\*([^*]+)\*)(?!`)/g, '<em>$2</em>');

            // --- Handle Inline Code (`) ---
            // Needs to be done AFTER bold/italic to avoid conflicts
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

            // --- Handle Paragraphs (split by double newline AFTER other block elements like <pre>, <h1> etc.) ---
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                 // If it's already a block element handled above, keep it as is
                if (block.startsWith('<h') || block.startsWith('<p class="formula">') || block.startsWith('<pre>')) {
                    return block;
                }
                // Otherwise, wrap in <p> and handle internal newlines as <br>
                let content = block.replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');

            return formatted;
        }


        // ========== MODAL FUNCTIONS ==========
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }

        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll
            console.log("Scroll set to 0 on hideModal");
            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
                console.log("Scroll listener removed on hideModal.");
            }
            resetModalState();
        }

        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.classList.remove('visible');
             modalImageContainer.style.display = 'none';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
            if (!titleListContainer || !titlesLoading) return;
            const shuffledTitles = shuffleArray([...titles]);
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay conceptos disponibles.</p>'; return; }
            shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalImageContainer.style.display = 'none';
            modalImageContainer.classList.remove('visible');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
            }

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText); // Use updated formatter

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalContent.scrollTop = 0; // Reset scroll after content visible
                console.log("Scroll set to 0 after content visible");

                // Prepare image (hidden)
                modalImageSpinner.style.display = 'block';
                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL:", title);
                     modalImageSpinner.style.display = 'none';
                     modalImagePlaceholder.style.display = 'block';
                 }

                // Setup scroll listener for conditional image visibility
                const scrollBuffer = 25; // Slightly larger buffer for longer content
                currentScrollHandler = () => {
                    const isScrollable = modalContent.scrollHeight > modalContent.clientHeight;
                    const isAtBottom = (modalContent.scrollTop + modalContent.clientHeight) >= (modalContent.scrollHeight - scrollBuffer);

                    if (!isScrollable || isAtBottom) {
                         if (!modalImageContainer.classList.contains('visible')) {
                             console.log(`Showing image. Scrollable: ${isScrollable}, At Bottom: ${isAtBottom}`);
                             modalImageContainer.classList.add('visible');
                             modalImageContainer.style.display = 'flex';
                         }
                         if ((isScrollable || !isScrollable) && currentScrollHandler) {
                            modalContent.removeEventListener('scroll', currentScrollHandler);
                            currentScrollHandler = null;
                            console.log("Scroll listener removed.");
                         }
                     }
                };
                modalContent.addEventListener('scroll', currentScrollHandler);
                console.log("Scroll listener added.");
                setTimeout(currentScrollHandler, 150); // Initial check

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = '';
                 if (currentScrollHandler) {
                    modalContent.removeEventListener('scroll', currentScrollHandler);
                    currentScrollHandler = null;
                 }
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más allá...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block';
                 } else {
                     alert("No se pudieron generar nuevos conceptos expertos en este momento.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar conceptos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Conceptos';
             }
         }


        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p style="color: white; background: #1f2937; padding: 2rem; text-align: center;">Error crítico inicializando la aplicación.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>