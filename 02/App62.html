<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glosario de Términos de Derecho Comercial</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Derecho Comercial --- */
        :root {
            --color-primary: #1d4ed8; /* Blue-700 (Profesional) */
            --color-secondary: #4b5563; /* Gray-600 (Serio) */
            --color-background: #f9fafb; /* Light Gray */
            --color-text: #1f2937; /* Dark Gray */
            --color-text-muted: #6b7280; /* Medium Gray */
            --color-modal-bg: #ffffff; /* White */
            --color-border: #d1d5db; /* Lighter Gray Border */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); }
        h1, h2, h3, h4, .logo { font-family: 'Quicksand', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.5rem; display: inline-block; } /* Primary border */
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; } /* Slightly wider items */
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Align left for longer terms */ font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1e40af; box-shadow: var(--shadow-sm); } /* Darker blue */
        #generate-more-btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; } /* Darker overlay */
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem 2rem; max-width: 900px; /* Wider modal */ width: 95%; max-height: 90vh; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e5e7eb; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.5rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #d1d5db; color: var(--color-text); }
        #modal-title { color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; font-size: 1.6rem; /* Slightly larger title */ }
        #modal-content { line-height: 1.75; /* Slightly more spacing */ color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 15px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content::-webkit-scrollbar { width: 8px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Quicksand', sans-serif; margin-top: 1.8em; margin-bottom: 0.8em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.3em; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.2em; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-secondary); }
        #modal-content .formula { /* Keep in case needed, but less likely */ text-align: center; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 1.1em; padding: 0.8em; margin: 1.2em 0; border: 1px solid var(--color-border); background-color: #f9fafb; border-radius: var(--border-radius); overflow-x: auto; white-space: nowrap; }
        #modal-content .formula sub, #modal-content .formula sup { font-size: 0.8em; line-height: 0; position: relative; vertical-align: baseline; }
        #modal-content .formula sub { top: 0.5em; }
        #modal-content .formula sup { top: -0.5em; }
        #modal-image-container { width: 100%; height: 250px; /* Slightly taller image area */ background-color: #f3f4f6; border-radius: var(--border-radius); overflow: hidden; display: none; /* Start hidden */ align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; margin-top: 1rem; }
        #modal-image-container.visible { display: flex; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 3rem; color: var(--color-border); display: none; } /* Larger placeholder */
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.15rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: var(--border-radius); border: 1px solid #fecaca; margin-top: 1rem; text-align: center; flex-shrink: 0; }
        .error-msg i { margin-right: 0.5rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-3 flex justify-center items-center">
             <div class="flex items-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-balance-scale-right mr-2"></i> Glosario Comercial
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Descifrando el Derecho Comercial</h1>
             <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Conceptos clave del mundo mercantil y societario explicados de forma clara por IA. ¡Selecciona un término!</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-file-contract text-gray-500 mr-2"></i>
                 Términos a Explorar
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Consultando códigos...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Términos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Elaborando definición...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                 </div>
                  <!-- Image Container (Initially Hidden) -->
                 <div id="modal-image-container">
                     <div class="spinner"></div>
                      <i class="fas fa-scroll placeholder-icon"></i> <!-- Placeholder icon -->
                     <img id="modal-image" alt="Visualización abstracta del concepto legal" />
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i> <!-- More severe icon -->
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-5 mt-12 border-t border-gray-200">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Glosario generado por IA con fines informativos y educativos. Esta información no constituye asesoría legal profesional.</p>
              <p class="mt-1">Consulte siempre a un abogado calificado para situaciones específicas. © 2025 Glosario Comercial</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Conceptos Generales y Sujetos
            "¿Qué es el Derecho Comercial?", "Fuentes del Derecho Comercial (Ley, Costumbre, Jurisprudencia)", "El Concepto de Acto de Comercio", "Clasificación de los Actos de Comercio (Objetivos, Subjetivos, Mixtos)", "El Comerciante: Definición y Requisitos", "Obligaciones Profesionales del Comerciante (Registro, Contabilidad)", "El Establecimiento de Comercio: Elementos", "La Empresa como Unidad Económica", "El Fondo de Comercio (Goodwill)", "La Propiedad Industrial: Marcas y Patentes", "El Nombre Comercial y el Emblema", "La Competencia Desleal: Actos Prohibidos", "Defensa de la Competencia: Prácticas Restrictivas", "El Registro Mercantil: Funciones y Efectos", "Libros de Comercio Obligatorios", "Contabilidad Mercantil: Principios Básicos", "El Auxiliar de Comercio (Factor, Dependiente, Mancebo)", "Agentes Comerciales y Corredores", "La Representación Mercantil (Apoderamiento)", "Prescripción en Materia Mercantil",
            // Contratos Mercantiles (Generales y Específicos)
            "Teoría General del Contrato Mercantil", "Formación del Consentimiento Mercantil", "Contratos por Adhesión y Condiciones Generales", "Cláusulas Abusivas en Contratos Mercantiles", "Prueba de los Contratos Mercantiles", "Interpretación de los Contratos Mercantiles", "El Contrato de Compraventa Mercantil", "Obligaciones del Vendedor Mercantil", "Obligaciones del Comprador Mercantil", "Transmisión del Riesgo en la Compraventa", "Ventas Especiales (Plaza a Plaza, Sobre Muestras, a Prueba)", "Contrato de Suministro", "Contrato Estimatorio (Consignación)", "Contrato de Permuta Mercantil", "Contrato de Transporte Terrestre de Mercancías", "Carta de Porte: Documento Clave", "Responsabilidad del Transportista", "Contrato de Comisión Mercantil (Mandato sin representación)", "Contrato de Agencia Comercial", "Contrato de Corretaje o Mediación", "Contrato de Depósito Mercantil", "Depósitos en Almacenes Generales", "El Warrant y el Certificado de Depósito", "Contrato de Préstamo Mercantil (Mutuo)", "Intereses en Operaciones Mercantiles", "Contrato de Cuenta Corriente Mercantil", "Contrato de Fianza Mercantil", "Contrato de Seguro: Principios", "Elementos del Contrato de Seguro (Interés, Riesgo, Prima)", "Póliza de Seguro", "Tipos de Seguros (Daños, Personas)", "Contrato de Edición", "Contrato de Publicidad", "Contrato de Leasing (Arrendamiento Financiero)", "Contrato de Factoring", "Contrato de Franquicia (Franchising)", "Contrato de Know-How", "Contrato de Joint Venture (Unión Temporal)", "Contrato de Distribución Comercial", "Contrato de Concesión Mercantil", "Contrato de Maquila", "Contratos Electrónicos: Formación y Validez", "Firma Electrónica y Digital", "Comercio Electrónico (E-commerce)", "Contratos Internacionales: Incoterms", "Arbitraje Comercial Nacional e Internacional", "Cláusula Compromisoria y Compromiso Arbitral", "Laudo Arbitral: Ejecución",
            // Sociedades Comerciales
            "Concepto y Elementos de la Sociedad Comercial", "Personalidad Jurídica de las Sociedades", "Clasificación de las Sociedades (Personas, Capital, Mixtas)", "Sociedad Colectiva: Características y Responsabilidad", "Sociedad en Comandita Simple", "Sociedad en Comandita por Acciones", "Sociedad de Responsabilidad Limitada (SRL / Ltda.)", "Capital Social y Aportes en la SRL", "Cuotas Sociales: Transmisión", "Órganos de la SRL (Gerencia, Junta de Socios)", "Sociedad Anónima (S.A.): Características", "Constitución de la Sociedad Anónima (Suscripción)", "Capital Autorizado, Suscrito y Pagado", "Acciones: Concepto y Clases", "Derechos y Obligaciones del Accionista", "Transmisión de Acciones", "La Junta General de Accionistas: Tipos y Competencias", "Convocatoria y Quórum en la Junta General", "El Órgano de Administración en la S.A. (Directorio, Administrador Único)", "Responsabilidad de los Administradores", "El Órgano de Fiscalización (Revisor Fiscal, Síndico)", "Aumento y Reducción de Capital Social", "Disolución de Sociedades: Causales", "Liquidación del Patrimonio Social", "Fusión de Sociedades", "Escisión de Sociedades", "Transformación de Sociedades", "Sociedad por Acciones Simplificada (SAS)", "Empresa Unipersonal (si aplica en la jurisdicción)", "Grupos de Empresas y Control Societario", "Sociedades Extranjeras: Sucursales", "Acuerdos Parasociales o de Accionistas", "Derecho de Receso o Separación del Socio", "Exclusión de Socios", "Impugnación de Acuerdos Sociales",
            // Títulos Valores (Instrumentos Negociables)
            "Teoría General de los Títulos Valores", "Características (Literalidad, Autonomía, Incorporación, Legitimación)", "Clasificación de los Títulos Valores (Nominativos, A la Orden, Al Portador)", "La Letra de Cambio: Concepto y Requisitos", "Personas que Intervienen (Librador, Girado, Tomador)", "Aceptación de la Letra de Cambio", "El Endoso: Formas y Efectos", "Endoso en Propiedad, en Procuración y en Garantía", "El Aval: Garantía Cambiaria", "Vencimiento de la Letra de Cambio", "El Pago de la Letra de Cambio", "El Protesto: Concepto y Clases", "Acciones Cambiarias (Directa, de Regreso)", "Excepciones Cambiarias", "El Pagaré: Similitudes y Diferencias con la Letra", "El Cheque: Concepto y Función Económica", "Requisitos Esenciales del Cheque", "Clases de Cheques (Cruzado, Certificado, de Gerencia)", "Presentación y Pago del Cheque", "Protesto del Cheque por Falta de Pago", "Acciones por Falta de Pago del Cheque", "El Certificado de Depósito a Término (CDT)", "Bonos u Obligaciones Emitidas por Sociedades", "Acciones como Títulos Valores", "Desmaterialización de Títulos Valores", "Factura Cambiaria de Compraventa", "Repos sobre Títulos Valores", "Custodia de Títulos Valores",
            // Derecho Concursal (Insolvencia)
            "Insolvencia Empresarial: Concepto", "El Concurso de Acreedores (Proceso Concursal)", "Presupuestos del Concurso (Objetivo y Subjetivo)", "Solicitud y Declaración del Concurso", "Efectos de la Declaración del Concurso (Patrimoniales, Personales)", "La Administración Concursal (Síndico, Liquidador)", "La Masa Activa del Concurso", "La Masa Pasiva: Clasificación de Créditos", "Créditos Privilegiados, Ordinarios y Subordinados", "Prelación de Créditos: Orden de Pago", "El Convenio de Acreedores", "La Liquidación Concursal", "Calificación del Concurso (Fortuito o Culpable)", "Responsabilidad en Caso de Concurso Culpable", "Acuerdos de Reestructuración Empresarial", "Insolvencia Transfronteriza", "La 'Segunda Oportunidad' para Personas Físicas (si aplica)",
            // Propiedad Intelectual y Competencia
            "Diferencia entre Propiedad Industrial e Intelectual", "Marcas: Concepto y Tipos (Nominativas, Figurativas, Mixtas)", "Registro de Marcas: Procedimiento y Efectos", "Derechos y Obligaciones del Titular de la Marca", "Nulidad y Cancelación de la Marca", "Patentes de Invención: Requisitos (Novedad, Actividad Inventiva)", "Procedimiento de Concesión de Patentes", "Modelos de Utilidad", "Diseños Industriales", "Secretos Empresariales: Protección", "Licencia de Uso de Propiedad Industrial", "Acciones por Infracción de Derechos de Propiedad Industrial", "Indicaciones Geográficas y Denominaciones de Origen", "Software y Derecho de Autor en el Comercio", "Nombres de Dominio en Internet", "Publicidad Comparativa: Límites", "Actos de Confusión y Engaño", "Denigración y Explotación de la Reputación Ajena", "Violación de Secretos Empresariales como Competencia Desleal", "Inducción a la Infracción Contractual", "Prácticas Monopolísticas Absolutas y Relativas", "Abuso de Posición Dominante", "Control de Concentraciones Empresariales",
            // Otros Ámbitos Relevantes
            "Derecho Marítimo Comercial", "Contrato de Fletamento (Por Viaje, Por Tiempo)", "Conocimiento de Embarque (Bill of Lading)", "Avería Gruesa y Simple", "Seguro Marítimo", "Derecho Aeronáutico Comercial", "Contrato de Transporte Aéreo", "Responsabilidad del Transportista Aéreo", "Derecho Bancario: Operaciones Activas y Pasivas", "Contrato de Cuenta Corriente Bancaria", "Transferencias y Medios de Pago Electrónicos", "Tarjetas de Crédito y Débito", "Mercado de Valores: Regulación", "Oferta Pública de Valores (OPV)", "Intermediarios Bursátiles (Bolsas, Corredores)", "Información Privilegiada (Insider Trading)", "Derecho del Consumidor: Principios", "Garantía Legal de Productos", "Publicidad Engañosa o Abusiva", "Cláusulas de Permanencia Mínima", "Protección de Datos Personales en el Comercio", "Derecho Tributario Mercantil (IVA, Impuesto sobre Sociedades)", "Zonas Francas y Regímenes Aduaneros Especiales",
            // Términos Adicionales
            "Abanderamiento de Buques", "Acción Pauliana o Revocatoria", "Acta de Asamblea/Junta", "Activo y Pasivo Social", "Acuerdo Marco", "Administrador de Hecho y de Derecho", "Adquirente de Buena Fe", "Afección Real", "Afianzamiento Mercantil", "Agencia Marítima", "Ajuste Razonable (Contabilidad)", "Albarán", "Amortización (Contable y Financiera)", "Anatocismo (Interés sobre Interés)", "Apelación (en procesos mercantiles)", "Apertura de Crédito", "Aportación en Especie", "Arancel", "Arras o Señal", "Arrendamiento de Local de Negocio", "Asiento Contable", "Auditoría de Cuentas", "Autocontratación", "Avalista", "Balance General", "Beneficiario (Seguro, Título Valor)", "Bienes Fungibles y No Fungibles", "Bolsa de Valores", "Boicot", "Caducidad", "Calidad de Comerciante", "Cancelación (Registro, Título)", "Canon (Franquicia, Arrendamiento)", "Capacidad para Contratar", "Capitalización de Intereses", "Carta de Crédito Documentario", "Cartera de Valores", "Casación (en procesos mercantiles)", "Caución", "Cesión de Contrato", "Cesión de Créditos", "Ciclo Contable", "Cláusula Penal", "Cliente", "Cobranza Delegada", "Código de Comercio", "Coeficiente de Solvencia", "Colusión", "Comerciante Individual", "Comerciante Social", "Comiso", "Comisión de Apertura", "Comisionista", "Comodato (Préstamo de Uso)", "Compraventa a Plazos", "Comprobante de Pago", "Comunicación Comercial", "Concesionario", "Condición Resolutoria y Suspensiva", "Conflicto de Intereses (Administradores)", "Conformidad (en la Compraventa)", "Conglomerado Empresarial", "Conocimiento (Obligación de Informar)", "Consentimiento Informado (Consumidor)", "Consignatario", "Consolidación (Contable)", "Consorcio", "Consumidor Final", "Contabilidad Analítica", "Contabilidad de Costos", "Contenedor (Transporte)", "Contingente Arancelario", "Contrabando", "Contragarantía", "Contraprestación", "Contrato Aleatorio", "Contrato Bilateral y Unilateral", "Contrato Conmutativo", "Contrato de Adhesión", "Contrato de Engineering", "Contrato de Escrow (Depósito en Garantía)", "Contrato de Hospedaje", "Contrato de Mandato Mercantil", "Contrato de Obra por Empresa", "Contrato Oneroso y Gratuito", "Contrato Preliminar o Promesa", "Contrato Real y Consensual", "Contrato Sinalagmático", "Control Cambiario", "Convenio de Doble Imposición", "Cooperativa", "Copropiedad", "Corredor de Seguros", "Costumbre Mercantil", "Cotización (Bolsa, Precios)", "Crédito Comercial", "Crédito Documentario", "Crédito Fiscal", "Crédito Refaccionario", "Crédito Sindicado", "Cuenta de Explotación", "Cuenta de Participación", "Culpa Grave, Leve, Levísima", "Cupón (de Acción, de Bono)", "Curador (en Concurso)", "Dación en Pago", "Daño Emergente y Lucro Cesante", "Declaración Unilateral de Voluntad", "Defecto Oculto (Vicio Redhibitorio)", "Deflación", "Delegación (de Deuda, de Firma)", "Demanda y Oferta", "Denuncia (Infracción)", "Dependiente de Comercio", "Depreciación", "Derecho de Asistencia y Voto", "Derecho de Exclusiva", "Derecho de Información (Accionista)", "Derecho de Oposición (Fusión, Escisión)", "Derecho de Preferencia (Suscripción)", "Derecho de Retención", "Derecho de Retracto", "Descuento Bancario", "Descuento Comercial", "Desistimiento", "Despacho a Libre Práctica", "Deuda Subordinada", "Deudor y Acreedor", "Devengo", "Diligencia Debida (Due Diligence)", "Directiva (Unión Europea)", "Dividendo Activo y Pasivo", "Divisa", "Dolo (Vicio del Consentimiento)", "Domicilio Social", "Dumping", "Ejercicio Social", "Embargo", "Emisión (Acciones, Bonos)", "Emplazamiento", "Empresa Familiar", "Empresa Pública", "Endosante y Endosatario", "Enriquecimiento Injusto", "Entidad de Crédito", "Error (Vicio del Consentimiento)", "Estatutos Sociales", "Estiba y Desestiba", "Evicción", "Excepción de Contrato no Cumplido", "Exención Fiscal", "Expediente de Regulación de Empleo (ERE)", "Exportación e Importación", "Expropiación", "Extinción de Obligaciones", "Factoraje (Factoring)", "Falsedad Documental", "Fianza Solidaria", "Filial", "Firma Mancomunada", "Fletador y Fletante", "Flujo de Caja (Cash Flow)", "Formación Sucesiva (Sociedad)", "Franquiciador y Franquiciado", "Fraude de Acreedores", "Fuerza Mayor y Caso Fortuito", "Fusión por Absorción", "Garantía a Primer Requerimiento", "Garantía Mobiliaria", "Gastos Deducibles", "Gestión de Negocios Ajenos", "Giro Postal o Bancario", "Gravamen", "Grupo de Interés Económico", "Hacienda Pública", "Hecho Relevante (Mercado de Valores)", "Hipoteca Mobiliaria", "Holding", "Homologación (de Convenio Concursal)", "Honorarios", "Impago", "Impuesto sobre Beneficios", "Impugnación de Paternidad (Marca)", "Incidente Concursal", "Incumplimiento Contractual", "Indemnización por Clientela (Agencia)", "Índice Bursátil", "Inflación", "Informe de Gestión", "Infracción Cambiaria", "Inhabilitación (Comerciante, Administrador)", "Inmatriculación (Buque, Aeronave)", "Innovación", "Insolvencia Punible", "Inspección Fiscal", "Instancia (Judicial, Administrativa)", "Instrumento Financiero", "Inteligencia Artificial en el Comercio", "Interdicción", "Interés Legal del Dinero", "Interés Moratorio", "Intermediario Financiero", "Internacionalización de la Empresa", "Inversión Extranjera Directa (IED)", "Investigación y Desarrollo (I+D)", "Junta Universal", "Jurisdicción Voluntaria", "Justificante de Recepción", "Laudo Firme", "Lealtad Comercial", "Legado", "Legitimación Activa y Pasiva", "Lesión Enorme", "Letra Resaca", "Lex Mercatoria", "Libertad de Establecimiento", "Libre Circulación de Mercancías", "Libre Prestación de Servicios", "Licitación Pública", "Línea de Crédito", "Liquidación de Impuestos", "Lista de Morosos", "Litigio", "Litispendencia", "Logística Comercial", "Marca Blanca", "Marca Comunitaria (UE)", "Marca Notoria y Renombrada", "Margen Comercial", "Matriz (Sociedad)", "Mediación Mercantil", "Medidas Cautelares", "Memorando de Entendimiento (MOU)", "Mercado Común", "Mercado Continuo", "Mercado de Futuros y Opciones", "Mercado Gris", "Mercancías Peligrosas", "Microempresa y PYME", "Ministerio Fiscal", "Minorista y Mayorista", "Mitigación del Daño", "Modelo de Negocio", "Modificación Estructural (Sociedades)", "Mora del Acreedor y del Deudor", "Muestra Comercial", "Multa Coercitiva", "Mutuo Disenso", "Nacionalización", "Navegabilidad", "Negligencia", "Negociación Colectiva", "Netting (Compensación)", "Nicho de Mercado", "NIF (Número de Identificación Fiscal)", "Novación", "Nulidad Absoluta y Relativa", "Objeto Social", "Obligación de Dar, Hacer o No Hacer", "Obligación Facultativa y Alternativa", "Obligación Mancomunada y Solidaria", "Oferta Vinculante", "Omisión", "OPA (Oferta Pública de Adquisición)", "Operación Vinculada", "Pacto Comisorio", "Pacto de Exclusividad", "Pacto de Retroventa", "Pagaré No a la Orden", "Papel Comercial", "Paraíso Fiscal", "Paralización (de Pagos)", "Participación Preferente", "Pasarela de Pago", "Pasivo Contingente", "Patente Europea", "Patrimonio Neto", "Perfeccionamiento del Contrato", "Peritaje", "Permiso de Trabajo", "Persona Jurídica", "Plan de Negocios", "Plan de Viabilidad (Concurso)", "Plazo de Gracia", "Pliego de Condiciones", "Plusvalía", "Poder General y Especial", "Política de Privacidad", "Póliza de Fletamento", "Preaviso", "Precio Alzado", "Precontrato", "Prenda sin Desplazamiento", "Presunción (Legal, Judicial)", "Preterición (Hereditaria)", "Prima de Emisión/Asunción", "Principio de Buena Fe", "Principio de Legalidad", "Principio de Oportunidad", "Principio de Publicidad Registral", "Prior Tempore, Potior Iure", "Privilegio (Crédito)", "Proa", "Procedimiento Abreviado", "Procurador", "Proveedor", "Provision de Fondos", "Proyecto de Fusión/Escisión", "Publicidad Ilícita", "Puerto Franco", "Quita y Espera", "Ratio Financiero", "Ratificación", "Reaseguro", "Recargo de Equivalencia", "Recesión", "Recibo", "Reclamación", "Reconocimiento de Deuda", "Reconversión Industrial", "Recurso (Administrativo, Judicial)", "Red Franquiciada", "Reducción de Capital Obligatoria", "Regalías (Royalties)", "Registro de Buques", "Registro de la Propiedad Intelectual", "Reglamento (UE)", "Rehabilitación (Concurso)", "Reivindicación", "Remate", "Remesa Documentaria", "Rendición de Cuentas", "Rentabilidad", "Renting", "Representación Legal", "Repudio (Herencia)", "Resarcimiento", "Rescisión por Lesión", "Reserva de Dominio", "Reserva Legal", "Resolución Contractual", "Responsabilidad Civil Extracontractual", "Responsabilidad Objetiva", "Restitución", "Retracto Legal", "Retroactividad", "Revalorización", "Reversión", "Revocación", "Riesgo Cambiario", "Riesgo País", "Rotura de Stock", "Saneamiento por Evicción", "Saneamiento por Vicios Ocultos", "Saturación de Mercado", "Secreto Bancario", "Sector Primario, Secundario, Terciario", "Segregación (de funciones)", "Seguro de Caución", "Seguro de Crédito", "Seguro de Responsabilidad Civil", "Seguro Obligatorio", "Sell-out", "Sentencia Firme", "Separación de Bienes", "Servicio Postventa", "Servidumbre", "Shareholder Agreement", "Signo Distintivo", "Simulación (Absoluta, Relativa)", "Siniestro", "Sistema Arbitral de Consumo", "Sistema Financiero", "Sobregiro", "Sociedad Civil", "Sociedad de Capital Riesgo", "Sociedad de Garantía Recíproca (SGR)", "Sociedad Dominante y Dominada", "Sociedad en Formación", "Sociedad Irregular", "Sociedad Pantalla", "Sociedad Profesional", "Software Libre vs. Propietario", "Solvencia", "Stand-by (Carta de Crédito)", "Subagencia", "Subarriendo", "Subasta", "Subcontratación", "Subfianza", "Subrogación", "Subsidio", "Subvención", "Sucesor Universal y Particular", "Sucumbencia", "Sujeto Pasivo (Impuesto)", "Superávit", "Suspensión de Pagos", "Sustitución Fideicomisaria", "Swap (Permuta Financiera)", "Talonario (Cheques)", "Tarjeta de Flota", "Tarifa Plana", "Tasa de Descuento", "Tasa Interna de Retorno (TIR)", "Tasación", "Tenedor (Título Valor)", "Tercería de Dominio", "Tercero de Buena Fe", "Término Esencial", "Testaferro", "Tipo de Cambio", "Tipo de Interés Nominal (TIN)", "Titular Real", "Titularización de Activos", "Tráfico Jurídico", "Transacción", "Transferencia Bancaria", "Transgénicos (Patentes)", "Transporte Multimodal", "Traspaso (Local de Negocio)", "Tratado de Libre Comercio (TLC)", "Tributo", "Trueque", "Trust (Fideicomiso Anglosajón)", "Unanimidad", "Unión de Empresas", "Unión Europea (Normativa Comercial)", "Usabilidad (Web)", "Usucapión (Prescripción Adquisitiva)", "Usufructo", "Utilidad Neta", "Valor Añadido Bruto (VAB)", "Valor Contable", "Valor de Mercado", "Valor Facial o Nominal", "Valor Residual", "Venta a Pérdida", "Venta en Pública Subasta", "Venta Multinivel", "Venture Capital", "Verificación de Créditos (Concurso)", "Vicio del Consentimiento", "Videoconferencia (Juntas)", "Vigilancia Tecnológica", "Vinculación Contractual", "Voto Electrónico", "Voto Plural", "Vulnerabilidad (Consumidor)", "Web Hosting", "Working Capital (Fondo de Maniobra)", "Yield (Rendimiento)", "Zona Económica Exclusiva", "Zozobra (Naufragio)"
        ];

        const commercialLawThemes = [
             "contratos mercantiles", "sociedades comerciales", "títulos valores", "derecho concursal", "propiedad industrial e intelectual", "competencia económica", "derecho marítimo y transporte", "comercio electrónico y digital", "derecho bancario y financiero", "derecho del consumidor", "registro mercantil", "aspectos generales del derecho comercial", "seguros mercantiles", "representación y auxiliares", "procedimientos mercantiles y arbitraje"
        ];

        const textApiConfig = {
            model: "mistral",
            systemPrompt: `Eres un experto catedrático en Derecho Comercial, capaz de explicar conceptos complejos de forma extremadamente clara, precisa y detallada para estudiantes o profesionales que no son expertos en un área específica. Tu tarea es definir y explicar exhaustivamente el siguiente término o concepto de derecho comercial. Debes incluir: 1. Definición clara y concisa. 2. Marco legal principal (mención de leyes o códigos relevantes si aplica, sin citar artículos específicos). 3. Elementos esenciales o características distintivas. 4. Implicaciones prácticas y ejemplos claros (hipotéticos o generales). 5. Diferencias con conceptos similares si es relevante. 6. Posibles controversias o aspectos clave a considerar. Utiliza un lenguaje formal pero accesible, estructurando la explicación con párrafos bien definidos y subtítulos claros (usando markdown como #, ##, ### o ####). El objetivo es una explicación completa y rigurosa de unas 1200-1300 palabras. Basa tu explicación únicamente en el siguiente término/concepto:`,
            timeoutSeconds: 150 // Increased timeout
        };

        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un glosario. Genera exactamente 15 términos o conceptos clave sobre Derecho Comercial, adecuados para ser definidos y explicados detalladamente. Devuelve *solo* la lista de términos/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40 // Slightly longer for potentially complex terms
        };

        // ========== DOM ELEMENTS ========== (sin cambios)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // --- Variable to hold the current scroll listener ---
        let currentScrollHandler = null;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) {
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url}`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
             }
        }

        async function fetchExplanationText(conceptTitle) {
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              // Adjust length check for the new target
              if (text.trim().length < 1000 || text.toLowerCase().includes("cannot fulfill")) {
                   throw new Error("La IA no pudo generar una explicación suficientemente detallada para este concepto.");
               }
             return text;
        }

        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(commercialLawThemes) || "conceptos generales";
             const specificPrompt = `Genera 15 términos o conceptos clave sobre ${randomTheme} en Derecho Comercial`;
             console.log("Generating concepts with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n')
                .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                .filter(line => line.length > 3 && line.length < 150); // Allow slightly longer terms
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de conceptos.");
             return titles.slice(0, 15);
        }

        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "commercial law abstract concept";
             // Prompt adapted for legal/commercial theme
             const enhancedPrompt = `Abstract visualization symbolizing the legal or commercial concept of '${safePromptText}', minimalist style, focus on structure, contracts, or interactions, conceptual art`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Stronger negative prompt against literal representations
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, equations, paragraphs, documents, contracts with text, law books, judge, gavel, scales of justice, courtroom, people, figures, suits, office, building, specific objects, currency symbols, diagrams, charts, graphs, schematics, signatures, seals, stamps, realistic photo, drawing of people";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
        }


        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Scroll Reset Logic Maintained)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }

        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll
            console.log("Scroll set to 0 on hideModal");
            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
                console.log("Scroll listener removed on hideModal.");
            }
            resetModalState();
        }

        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.classList.remove('visible');
             modalImageContainer.style.display = 'none'; // Ensure hidden initially
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (Scroll Reset Logic Maintained)
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }

        function displayTitles(titles) {
            if (!titleListContainer || !titlesLoading) return;
            const shuffledTitles = shuffleArray([...titles]);
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay términos disponibles.</p>'; return; }
            shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
        }

        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalImageContainer.style.display = 'none';
            modalImageContainer.classList.remove('visible');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
            }

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.scrollTop = 0; // <<<--- RESET SCROLL HERE
                console.log("Scroll set to 0 after content visible");

                // Prepare image loading (container still hidden)
                modalImageSpinner.style.display = 'block';
                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL:", title);
                     modalImageSpinner.style.display = 'none';
                     modalImagePlaceholder.style.display = 'block';
                 }

                // Setup Scroll Listener for Conditional Image Visibility
                const scrollBuffer = 20; // Slightly larger buffer
                currentScrollHandler = () => {
                    const nearBottom = (modalContent.scrollTop + modalContent.clientHeight) >= (modalContent.scrollHeight - scrollBuffer);
                    const contentFits = modalContent.scrollHeight <= modalContent.clientHeight;

                    if (contentFits || nearBottom) {
                         if (!modalImageContainer.classList.contains('visible')) {
                             console.log(`Image condition met (Fits: ${contentFits}, NearBottom: ${nearBottom}). Showing image.`);
                             modalImageContainer.classList.add('visible');
                             modalImageContainer.style.display = 'flex';
                         }
                         // Optional: Remove listener once image is shown to save resources
                         // modalContent.removeEventListener('scroll', currentScrollHandler);
                         // currentScrollHandler = null;
                         // console.log("Scroll listener potentially removed after showing image.");
                    } else {
                         // Optional: Hide if scrolled back up significantly (might cause flickering)
                         // if (modalImageContainer.classList.contains('visible')) {
                         //    modalImageContainer.classList.remove('visible');
                         //    modalImageContainer.style.display = 'none';
                         //    console.log("Scrolled up, hiding image.");
                         // }
                    }
                };
                modalContent.addEventListener('scroll', currentScrollHandler);
                console.log("Scroll listener added.");
                 // Initial check in case content is too short to scroll or already at bottom
                 setTimeout(currentScrollHandler, 150); // Check shortly after setup

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error al definir: ${error.message}`; // Custom error message
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = '';
                 if (currentScrollHandler) {
                    modalContent.removeEventListener('scroll', currentScrollHandler);
                    currentScrollHandler = null;
                 }
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando...'; // Updated text
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se pudieron generar nuevos términos en este momento."); }
             } catch (error) { console.error("Failed generation:", error); alert(`Error: ${error.message}`);
             } finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Términos'; } // Updated text
         }

        // ========== INITIALIZATION ========== (sin cambios)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p>Error crítico.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>