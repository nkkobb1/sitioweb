<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senderos del Despertar - Historias y Conceptos del Budismo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Elegantes/Serenas -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Budismo --- */
        :root {
            --color-primary: #c8a464; /* Dorado Suave / Ocre */
            --color-secondary: #8fbc8f; /* Verde Salvia Suave */
            --color-tertiary: #d2b48c; /* Tan / Beige */
            --color-background: #fdfbf5; /* Blanco Hueso / Crema muy claro */
            --color-text: #4a4a4a; /* Gris Oscuro Suave */
            --color-text-muted: #7a7a7a; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco puro */
            --color-border: #e0e0e0; /* Borde Gris Muy Claro */
            --color-error-bg: #fff0f0; /* Fondo error rosa pálido */
            --color-error-text: #a14d4d; /* Texto error terracota */
            --color-error-border: #f5c5c5; /* Borde error rosa */

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.07);
            --shadow-md: 0 4px 8px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 20px -3px rgba(0, 0, 0, 0.1), 0 4px 8px -4px rgba(0, 0, 0, 0.08);
            --border-radius: 5px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(200, 164, 100, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-primary); background-color: #f5fbf5; border-left-color: var(--color-secondary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #b89454; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: var(--color-tertiary); color: #f8f8f8; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(74, 74, 74, 0.85); /* Overlay gris suave */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #eee; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* --- Loading Screen with Minigame --- */
        #modal-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(253, 251, 245, 0.98); /* Fondo crema casi opaco */ display: none; /* Se mostrará con JS */ flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); padding: 2rem; text-align: center; }
        #modal-loading.active { display: flex; } /* Mostrar cuando carga */

        #minigame-container { margin-bottom: 1.5rem; }
        #breathing-circle { width: 80px; height: 80px; background-color: var(--color-secondary); border-radius: 50%; margin: 0 auto 1rem auto; transition: transform 4s ease-in-out, opacity 4s ease-in-out; /* Duración ciclo 8s */ transform: scale(0.5); opacity: 0.7; }
        #breathing-circle.inhale { transform: scale(1.2); opacity: 1; }
        #breathing-instruction { font-size: 1.2rem; color: var(--color-primary); font-family: 'Merriweather', serif; margin-bottom: 0.5rem; font-weight: 400; }
        #breath-count { font-size: 0.9rem; color: var(--color-text-muted); font-family: 'Lato'; }
        /* Ocultar el spinner genérico si usamos el minijuego */
        /* .loading-spinner-modal { display: none; } */

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700;}
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.1em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid var(--color-tertiary); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.6rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9f9f9; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.55; }
        .user-message { background-color: var(--color-secondary); color: white; margin-left: auto; text-align: left; font-weight: 400; }
        .ai-message { background-color: #eee; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.7rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #b89454; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-text); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.95); /* Fondo blanco translúcido */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 1px solid var(--color-border); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: white; transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-om mr-3 text-yellow-600"></i> <!-- Icono Om / Rueda Dharma? -->
                     Senderos del Despertar
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Historias y Conceptos del Budismo «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Explora la Sabiduría Budista</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre enseñanzas, relatos y conceptos fundamentales del Budismo. Selecciona un tema o busca para iniciar tu viaje.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar concepto, historia, figura...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-green-700 mr-2"></i> <!-- Icono libro abierto -->
                 Índice de Enseñanzas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando enseñanzas disponibles...</p>
                  <!-- .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron enseñanzas para tu búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Más Enseñanzas (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <div id="minigame-container">
                     <div id="breathing-circle"></div>
                     <p id="breathing-instruction">Preparando...</p>
                     <p id="breath-count">Ciclos completados: 0</p>
                 </div>
                 <p class="text-lg font-semibold text-gray-700">Cargando sabiduría...</p>
                 <!-- <div class="loading-spinner-modal"></div> -->
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) -->
                         <!-- Image + placeholder appended here -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al Dharma...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este tema...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-circle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Contenido generado por IA con fines educativos e introductorios al Budismo.</p>
              <p class="mt-1">Para estudios profundos, consulta fuentes académicas y maestros cualificados.</p>
              <p class="mt-2">© 2024 Senderos del Despertar</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Vida del Buda Siddhartha Gautama
            "Nacimiento de Siddhartha Gautama", "La Profecía de Asita", "Los Cuatro Encuentros", "La Gran Renuncia", "Años de Ascetismo", "La Iluminación bajo el Árbol Bodhi", "El Primer Sermón en Sarnath (Puesta en Marcha de la Rueda del Dharma)", "La Formación de la Sangha", "Principales Discípulos: Sariputta y Moggallana", "Principales Discípulas: Khema y Uppalavanna", "El Intento de Asesinato por Devadatta", "Los Últimos Días del Buda", "El Parinirvana del Buda", "El Legado de Siddhartha Gautama",
            // Conceptos Fundamentales
            "Las Cuatro Nobles Verdades (Catvāri Āryasatyāni)", "La Verdad del Sufrimiento (Dukkha)", "La Verdad del Origen del Sufrimiento (Samudāya)", "La Verdad de la Cesación del Sufrimiento (Nirodha)", "La Verdad del Sendero hacia la Cesación (Magga)", "El Noble Óctuple Sendero (Āryāṣṭāṅgamārga)", "Recta Comprensión (Sammā Diṭṭhi)", "Recto Pensamiento (Sammā Saṅkappa)", "Recta Palabra (Sammā Vācā)", "Recta Acción (Sammā Kammanta)", "Recto Medio de Vida (Sammā Ājīva)", "Recto Esfuerzo (Sammā Vāyāma)", "Recta Atención Plena (Sammā Sati)", "Recta Concentración (Sammā Samādhi)", "Karma (Acción Volitiva y sus Consecuencias)", "Renacimiento (Punarbhava)", "Nirvana (Extinción del Sufrimiento)", "Anatman / Anatta (No-Yo / Insustancialidad)", "Anicca (Impermanencia)", "Dukkha (Sufrimiento / Insatisfacción)", "Las Tres Joyas (Triratna): Buda, Dharma, Sangha", "Los Cinco Agregados (Skandhas)", "Origen Dependiente (Pratītyasamutpāda)", "Los Tres Venenos (Akusala-mūla): Avaricia, Odio, Ignorancia", "Metta (Amor Benevolente)", "Karuna (Compasión)", "Mudita (Alegría Empática)", "Upekkha (Ecuanimidad)", "Samsara (Ciclo de Nacimiento y Muerte)", "Bodhi (Despertar / Iluminación)", "Bodhicitta (Mente del Despertar)", "Prajñā (Sabiduría)", "Śīla (Ética / Moralidad)", "Samādhi (Concentración Meditativa)", "Los Diez Preceptos (Dasa Sīla)", "Los Cinco Preceptos Laicos",
            // Jataka Tales (Ejemplos)
            "Jataka del Rey Mono", "Jataka de la Liebre Sacrificada", "Jataka del Príncipe Vessantara", "Jataka del Ciervo Banyan", "Jataka del Elefante Sabio", "Jataka del Pájaro Carpintero", "Jataka del Mercader Compasivo", "Jataka del Loro Leal", "Jataka de la Tortuga que Hablaba Demasiado", "Jataka del Rey Sibi",
            // Sutras y Textos Clave (Conceptos/Resúmenes)
            "Dhammapada (Versos Seleccionados y Significado)", "Metta Sutta (Discurso sobre el Amor Benevolente)", "Anapanasati Sutta (Discurso sobre la Atención Plena en la Respiración)", "Satipatthana Sutta (Discurso sobre los Fundamentos de la Atención Plena)", "Maha Parinibbana Sutta (Discurso sobre los Últimos Días del Buda)", "Kālāma Sutta (Libertad de Investigación)", "Sigalovada Sutta (Consejos al Laico Sigala)", "Sutra del Corazón (Prajñāpāramitā Hṛdaya Sūtra)", "Sutra del Diamante (Vajracchedikā Prajñāpāramitā Sūtra)", "Sutra del Loto (Saddharma Puṇḍarīka Sūtra)", "Sutras del Lankavatara", "Sutras de la Tierra Pura (Sukhavativyuha)", "Canon Pali (Tipitaka): Vinaya, Sutta, Abhidhamma", "Literatura Prajñāpāramitā", "Textos del Yogācāra (Escuela de Solo Mente)", "Textos del Madhyamaka (Escuela del Camino Medio)", "El Bardo Thodol (Libro Tibetano de los Muertos)", "Las Etapas del Camino (Lam Rim)",
            // Escuelas y Tradiciones Principales
            "Theravada (Camino de los Ancianos)", "Mahayana (Gran Vehículo)", "Vajrayana (Vehículo del Diamante / Budismo Tántrico)", "Budismo Zen (Chan)", "Escuela Rinzai (Zen)", "Escuela Sōtō (Zen)", "Budismo de la Tierra Pura (Amidismo)", "Budismo Tibetano (Escuelas Nyingma, Kagyu, Sakya, Gelug)", "Budismo Nichiren", "Navayana (Nuevo Vehículo / Ambedkarita)", "Diferencias Clave: Theravada vs Mahayana", "El Ideal del Arhat (Theravada)", "El Ideal del Bodhisattva (Mahayana)", "El Papel de los Lamas en el Budismo Tibetano", "Koans en el Budismo Zen", "El Mantra 'Om Mani Padme Hum'",
            // Figuras Importantes (Post-Buda)
            "Rey Ashoka y la Difusión del Budismo", "Nagarjuna (Fundador del Madhyamaka)", "Asanga y Vasubandhu (Fundadores del Yogācāra)", "Bodhidharma (Patriarca del Zen en China)", "Padmasambhava (Guru Rinpoche - Introducción del Budismo en Tíbet)", "Atisha (Reformador Tibetano)", "Milarepa (Yogui y Poeta Tibetano)", "Tsongkhapa (Fundador de la Escuela Gelug)", "El Dalai Lama (Linaje e Importancia)", "Thich Nhat Hanh (Maestro Zen y Activista por la Paz)", "Shantideva (Autor del Bodhicaryāvatāra)", "Huineng (Sexto Patriarca del Chan)", "Dogen Zenji (Fundador del Sōtō Zen en Japón)", "Shinran Shonin (Fundador del Jōdo Shinshū)", "B. R. Ambedkar (Líder Budista Dalit)",
            // Prácticas Budistas
            "Meditación Vipassanā (Insight)", "Meditación Samatha (Calma Mental)", "Meditación Zazen (Sentarse en Meditación)", "Meditación Caminando (Kinhin)", "Atención Plena (Mindfulness) en la Vida Diaria", "Práctica de los Brahmavihāras (Moradas Divinas)", "Retiros de Meditación", "Canto de Mantras y Sutras", "Ofrendas y Pujas", "Postraciones", "Generosidad (Dāna)", "Peregrinación a Lugares Sagrados (Lumbini, Bodh Gaya, Sarnath, Kushinagar)", "Tomar Refugio en las Tres Joyas", "Estudio de Textos (Dharma)", "Observancia de Días Uposatha", "La Vida Monástica (Bhikkhu / Bhikkhuni)", "El Rol del Laico en el Budismo",
            // Símbolos, Arte y Arquitectura
            "La Rueda del Dharma (Dharmachakra)", "La Flor de Loto (Padma)", "El Árbol Bodhi", "La Estupa (Chorten)", "Las Huellas del Buda (Buddhapada)", "El León (Símbolo de la Realeza y Fortaleza del Dharma)", "Mandala (Cosmograma Sagrado)", "Mudras (Gestos de las Manos)", "Thangkas (Pinturas Tibetanas en Tela)", "Estatuas de Buda (Diferentes Posturas y Significados)", "Arquitectura de Templos Budistas (Wat, Gompa, Vihara)", "Banderas de Oración Tibetanas", "El Nudo Infinito", "Los Ocho Símbolos Auspiciosos (Ashtamangala)",
            // Budismo y Sociedad / Filosofía
            "Ética Budista en la Vida Moderna", "Budismo y Ecología", "Budismo y Ciencia (Diálogos Mente-Vida)", "Budismo y Psicología", "Budismo Comprometido Socialmente (Engaged Buddhism)", "Concepto Budista de la Mente", "La No-Violencia (Ahimsa) en el Budismo", "Budismo y Derechos Humanos", "Filosofía de la Vacuidad (Śūnyatā)", "Teoría de los Dos Niveles de Verdad (Madhyamaka)", "Budismo Secular", "Interconexión e Interdependencia",
            // Budismo en el Mundo
            "Historia del Budismo en India", "Budismo en Sri Lanka", "Budismo en el Sudeste Asiático (Tailandia, Myanmar, Camboya, Laos, Vietnam)", "Budismo en China", "Budismo en Corea", "Budismo en Japón", "Budismo en Tíbet", "Expansión del Budismo a Occidente", "Desafíos del Budismo en el Siglo XXI", "Sincretismo Budista con otras Tradiciones (Bon, Taoísmo, Shinto)",
            // Añadir más conceptos específicos si es necesario
        ];
        const buddhistThemes = [
            "vida de Siddhartha Gautama", "conceptos fundamentales del budismo", "Cuatro Nobles Verdades", "Noble Óctuple Sendero", "karma y renacimiento", "nirvana y samsara", "anatman (no-yo)", "anicca (impermanencia)", "dukkha (sufrimiento)", "meditación budista (vipassana, samatha, zazen)", "atención plena (mindfulness)", "Jataka Tales", "sutras importantes (Corazón, Loto, Dhammapada)", "escuelas budistas (Theravada, Mahayana, Vajrayana, Zen)", "figuras budistas (Nagarjuna, Padmasambhava, Dalai Lama)", "Bodhisattvas (Avalokiteśvara, Manjushri)", "prácticas budistas (preceptos, cantos, retiros)", "símbolos budistas (loto, rueda del dharma, estupa)", "arte budista", "ética budista", "filosofía budista (vacuidad, origen dependiente)", "budismo tibetano", "budismo zen", "budismo theravada", "budismo en Asia", "budismo en Occidente"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un erudito en estudios budistas y un narrador compasivo con profundo conocimiento del Dharma. Explica el concepto, historia, sutra, figura o práctica budista indicada de forma clara, profunda y accesible. Incluye su origen (contexto histórico/textual), significado central, relevancia práctica o filosófica, y cómo se entiende o aplica en las diferentes tradiciones (Theravada, Mahayana, Vajrayana) si es pertinente. Evita proselitismo y jerga excesiva; enfócate en la explicación informativa, respetuosa y enriquecedora. El objetivo es una exposición detallada de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tema budista:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúa como un monje erudito o asistente virtual (Kalyāṇa-mitta) especializado únicamente en el tema budista '[Current Topic]'. Responde preguntas de seguimiento sobre sus detalles, interpretaciones, prácticas relacionadas o contexto de forma clara, concisa, compasiva y respetuosa, basándote en la información principal y el conocimiento budista general. Si una pregunta se desvía mucho, amablemente redirige al tema principal.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una guía sobre Budismo. Genera exactamente 40 nombres de historias, conceptos clave, sutras importantes, figuras relevantes o prácticas centrales del budismo, adecuados para una explicación detallada. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentar un poco por si pide 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Contenedor del minijuego
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Área scrollable
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameContainer = document.getElementById('minigame-container');
        const breathingCircle = document.getElementById('breathing-circle');
        const breathingInstruction = document.getElementById('breathing-instruction');
        const breathCountDisplay = document.getElementById('breath-count');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Contexto para chat
        let minigameInterval = null; // Intervalo para el minijuego
        let breathCycle = 0; // Contador para el minijuego

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Actúa como un monje erudito o asistente virtual (Kalyāṇa-mitta) especializado únicamente en el tema budista '${currentTopicTitle}'. Responde preguntas de seguimiento sobre sus detalles, interpretaciones, prácticas relacionadas o contexto de forma clara, concisa, compasiva y respetuosa, basándote en la información principal y el conocimiento budista general. Si una pregunta se desvía mucho, amablemente redirige al tema principal.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores (o los de la IA) tienen mucho tráfico ahora. Por favor, intenta en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta de nuevo o con otro tema.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                    throw new Error(`La conexión con la IA tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al consultar la sabiduría.");
             }
         }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Error interno: No se ha establecido el contexto del tema."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(buddhistThemes) || "conceptos generales del budismo";
             const specificPrompt = `Genera 40 nombres/conceptos clave sobre ${randomTheme}`; // Pedir 40
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                  .then(text => {
                      const titles = text.split('\n')
                           .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                           .filter(line => line.length > 4 && line.length < 150);
                      if (titles.length < 10) throw new Error("La IA no generó suficientes enseñanzas nuevas."); // Umbral menor por si acaso
                      return titles.slice(0, 40); // Asegurar máximo 40
                  });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "serene Buddhist concept illustration";
             const enhancedPrompt = `Serene, symbolic, or illustrative artwork inspired by the Buddhist concept/story '${safePromptText}'. Focus on atmosphere, symbolism (lotus, light, nature, meditation, Bodhi leaf), or abstract representation. Use a calm color palette (earth tones, soft gold, gentle blues/greens, saffron orange accents). Avoid direct religious icons unless essential and respectful. No text, labels, diagrams. Peaceful, mindful aesthetic.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, photorealistic, chaotic, violent, overly complex, jarring colors";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MINIGAME FUNCTIONS ==========
        function startMinigame() {
            if (!modalLoadingIndicator || !breathingCircle || !breathingInstruction || !breathCountDisplay) return;
            breathCycle = 0; // Reset counter
            breathCountDisplay.textContent = `Ciclos completados: ${breathCycle}`;
            modalLoadingIndicator.classList.add('active'); // Muestra el contenedor de carga

            // Iniciar ciclo inmediatamente
            breathingInstruction.textContent = "Inspira...";
            breathingCircle.classList.add('inhale');

            // Detener cualquier intervalo anterior
            if (minigameInterval) clearInterval(minigameInterval);

            // Ciclo de 8 segundos (4s inspira, 4s espira)
            minigameInterval = setInterval(() => {
                if (breathingCircle.classList.contains('inhale')) {
                    // Estaba inhalando -> ahora exhala
                    breathingInstruction.textContent = "Espira...";
                    breathingCircle.classList.remove('inhale');
                    breathCycle++; // Contar ciclo completo al final de la exhalación
                    breathCountDisplay.textContent = `Ciclos completados: ${breathCycle}`;
                } else {
                    // Estaba exhalando -> ahora inhala
                    breathingInstruction.textContent = "Inspira...";
                    breathingCircle.classList.add('inhale');
                }
            }, 4000); // Cambia cada 4 segundos
        }

        function stopMinigame() {
            if (minigameInterval) clearInterval(minigameInterval);
            minigameInterval = null;
            if (modalLoadingIndicator) modalLoadingIndicator.classList.remove('active'); // Oculta contenedor de carga
             // Reset visual por si acaso se detiene a la mitad
            if (breathingCircle) breathingCircle.classList.remove('inhale');
            if (breathingInstruction) breathingInstruction.textContent = "Preparando...";
        }


        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
             stopMinigame(); // Asegurarse de detener el juego al cerrar
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             stopMinigame(); // Detiene y oculta el juego/loading
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... */ const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errDiv=document.createElement('div');errDiv.classList.add('chat-error');errDiv.textContent=message;chatHistory.appendChild(errDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const q=chatInput.value.trim();if(!q||chatSendBtn.disabled)return;addChatMessage(q,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const r=await fetchChatResponse(q);addChatMessage(r,'ai');}catch(e){console.error("Chat Error:",e);addChatError(`Error IA: ${e.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();} }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar alfabéticamente para consistencia
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay enseñanzas disponibles en este momento «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Added ${addedCount} new unique titles.`);
             filterTitles(searchInput.value); // Reapply filter
         }

        // *** MODIFIED: handleTitleClick to integrate minigame ***
        async function handleTitleClick(title) {
            resetModalState(); // Resetea todo, incluido detener juego anterior
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // Contexto Chat
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');

            startMinigame(); // <<< INICIAR MINIJUEGO/PANTALLA CARGA

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                stopMinigame(); // <<< DETENER MINIJUEGO AL RECIBIR RESPUESTA

                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Preparar placeholder imagen
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-leaf placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Generando imagen serena...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Crear imagen
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo cargar la ilustración.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al crear URL.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                stopMinigame(); // <<< DETENER MINIJUEGO TAMBIÉN EN ERROR

                modalErrorMessage.textContent = error.message || "Ocurrió un error desconocido al cargar la enseñanza.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles to fetch 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más sabiduría...';
             try {
                 // Fetching potentially 40 titles
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     console.log(`Fetched ${newTitles.length} new titles.`);
                     appendTitles(newTitles);
                 } else {
                     alert("No se encontraron más enseñanzas en este momento.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al explorar más enseñanzas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Update button text maybe dynamically if needed, or keep static
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Enseñanzas (40)';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalLoadingIndicator) {
                console.error("Initialization failed: Missing essential UI elements.");
                document.body.innerHTML = '<p style="color: #a14d4d; font-size: 1.5em; text-align: center; padding-top: 3em;">Error crítico: No se pudieron cargar los componentes de la página. Refresca o contacta soporte.</p>';
                return;
             }
            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            // Asegurar que el loading/minigame esté oculto inicialmente
            modalLoadingIndicator.classList.remove('active');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>