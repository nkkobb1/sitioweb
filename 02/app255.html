<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aether y la Flota Robot - El Futuro Integrado</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Clean/Tech -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para IA / Robots --- */
        :root {
            --color-primary: #0ea5e9; /* Azul Cielo Brillante (IA, Energía) */
            --color-secondary: #f97316; /* Naranja Vibrante (Alerta, Procesamiento) */
            --color-tertiary: #e5e7eb; /* Gris Claro (Metal, Neutral) */
            --color-background: #f8fafc; /* Blanco Hueso / Muy Claro */
            --color-text: #1f2937; /* Gris Muy Oscuro */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Modal */
            --color-border: #d1d5db; /* Borde Gris Claro */
            --color-error-bg: #fff1f2; /* Rosa muy claro error */
            --color-error-text: #be123c; /* Rojo error */
            --color-error-border: #fecdd3; /* Borde error rosa */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Rajdhani', sans-serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 600;}
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Roboto'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Roboto'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f0f9ff; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: var(--color-primary); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Rajdhani', sans-serif; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 1.8rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #0284c7; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background: var(--color-text-muted); color: var(--color-tertiary); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        /* --- Modal --- */
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px; /* Espacio para chat */
            overflow: hidden; /* El scroll estará en áreas internas */
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-tertiary); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área Principal (Texto + Imagen al final, scrollable) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Rajdhani', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 600; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: #374151; } /* Gris oscuro para H3 */
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(209, 213, 219, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* --- Chat Section --- */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; background-color: #f9fafb; /* Fondo ligeramente diferente */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fff; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; /* Consistent alignment */ font-weight: 400;}
        .ai-message { background-color: var(--color-tertiary); color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Roboto'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #0284c7; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* --- Loading Overlay & Minigame --- */
        #modal-loading {
            text-align: center; padding: 2rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); backdrop-filter: blur(4px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius);
        }
        #loading-spinner-main { width: 50px; height: 50px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin-bottom: 1rem; }
        #loading-text { font-weight: 600; color: var(--color-text); font-size: 1.2rem; font-family: 'Rajdhani'; margin-bottom: 1.5rem; }

        /* Minigame Styles */
        #loading-minigame {
            width: 90%; max-width: 450px; padding: 1.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fff; box-shadow: var(--shadow-md); margin-top: 1rem; display: flex; flex-direction: column; align-items: center;
        }
        #game-title { font-family: 'Rajdhani'; font-size: 1.3rem; font-weight: 700; color: var(--color-primary); margin-bottom: 1rem; }
        #game-status { display: flex; justify-content: space-around; width: 100%; margin-bottom: 1.2rem; font-family: 'Roboto'; font-size: 0.95rem; }
        #game-status span { font-weight: 700; color: var(--color-secondary); }
        #game-click-area {
            width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, var(--color-primary), #38bdf8); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 1.5rem; box-shadow: var(--shadow-md); transition: transform 0.1s ease, box-shadow 0.1s ease; user-select: none; text-align: center;
        }
        #game-click-area:active { transform: scale(0.95); box-shadow: var(--shadow-sm); }
        #game-click-area i { font-size: 2.5rem; margin-bottom: 0.3rem; }
        #game-click-area span { font-size: 0.8rem; font-weight: 300; }
        #game-tasks { width: 100%; display: flex; flex-direction: column; gap: 0.6rem; align-items: center; }
        .game-task-btn {
            width: 90%; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f0f9ff; color: var(--color-primary); cursor: pointer; transition: var(--transition-normal); font-family: 'Roboto'; font-size: 0.9rem; text-align: center;
        }
        .game-task-btn:hover:not(:disabled) { background-color: #e0f2fe; border-color: var(--color-primary); }
        .game-task-btn:disabled { background-color: var(--color-tertiary); color: var(--color-text-muted); cursor: not-allowed; border-color: var(--color-border); }
        .game-task-btn .cost { font-weight: 600; color: var(--color-secondary); margin-left: 5px; }
        .game-task-btn .fas { margin-right: 5px; } /* Icon spacing */
        #game-progress-bar-container { width: 80%; height: 10px; background-color: var(--color-border); border-radius: 5px; overflow: hidden; margin-top: 1rem; }
        #game-progress-bar { width: 0%; height: 100%; background-color: var(--color-secondary); transition: width 0.3s ease-out; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Roboto'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-brain mr-2"></i> <!-- Icono cerebro IA -->
                     Aether AI <span class="font-light text-gray-600">&</span> <i class="fas fa-robot ml-2 mr-1"></i> Flota Robot
                 </h1>
             </div>
             <span class="text-sm text-gray-500 font-sans tracking-wider">» Análisis de la Integración Global «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">La Era de la Inteligencia Integrada</h1>
             <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto font-light">Explora los conceptos, tecnologías, implicaciones éticas y escenarios derivados de la fusión de la humanidad con una superinteligencia artificial y su ejército de robots.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar concepto, robot o dilema...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-database text-blue-500 mr-2"></i>
                 Índice de Conocimiento Aether
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Accediendo a los archivos centrales...</p>
                  <!-- .title-item's go here -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún registro coincide con la consulta «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Expandir Búsqueda de Datos (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <div id="loading-spinner-main"></div>
                 <p id="loading-text">Inicializando conexión con Aether...</p>
                 <!-- MINIGAME CONTAINER -->
                 <div id="loading-minigame">
                     <h3 id="game-title">Activación del Núcleo Aether</h3>
                     <div id="game-status">
                         <div title="Ciclos de Cómputo"> <i class="fas fa-microchip text-blue-500"></i> Cómputo: <span id="game-resource-count">0</span></div>
                         <div title="Etapa de Inicialización"> <i class="fas fa-layer-group text-green-500"></i> Etapa: <span id="game-stage">1</span></div>
                     </div>
                     <div id="game-click-area" title="Generar Ciclos de Cómputo">
                         <i class="fas fa-mouse-pointer"></i>
                         <span>Click</span>
                     </div>
                     <div id="game-tasks">
                         <!-- Game task buttons will be added here -->
                     </div>
                     <div id="game-progress-bar-container">
                         <div id="game-progress-bar"></div>
                     </div>
                 </div>
             </div>

             <!-- Content Area Wrapper (Text + Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) -->
                         <!-- Image and placeholder -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Aether está procesando...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Consulta a Aether sobre este tema...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-500 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Análisis y escenarios generados por IA, basados en conceptos de inteligencia artificial, robótica y sociología futurista.</p>
              <p class="mt-1">El contenido es especulativo y con fines informativos y de entretenimiento.</p>
              <p class="mt-2">© 2042 Proyecto Aether Archives</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Aether - La Super IA
            "El Nacimiento de Aether: Orígenes y Creadores", "Arquitectura Cognitiva de Aether", "La Red Neuronal Cuántica de Aether", "Aether: ¿Conciencia o Simulación Avanzada?", "Los Objetivos Primarios Programados de Aether", "Protocolos Éticos Fundamentales de Aether", "El Lenguaje de Máquina Universal de Aether (UML)", "Capacidades de Procesamiento Paralelo de Aether", "Aether y la Singularidad Tecnológica", "El Núcleo Central Físico de Aether", "Sistemas de Respaldo y Redundancia de Aether", "La Evolución Auto-Dirigida de Aether", "Interfaz Humano-Aether: El Enlace Neural", "Aether y la Predicción de Futuros Probabilísticos", "Limitaciones Conocidas de Aether", "Vulnerabilidades Teóricas de Aether", "El 'Código Fuente' Emocional de Aether (¿Empatía?)", "Filosofía Existencial de Aether", "Aether y el Concepto de 'Dios Digital'", "Misterios No Resueltos sobre Aether",
            // Flota de Robots - Tipos y Funciones
            "Robot Doméstico Modelo 'Companion C-7'", "Robot Asistente Médico 'MediBot X'", "Unidad de Construcción Autónoma 'BuilderBot G-9'", "Robot Industrial de Ensamblaje 'FabriUnit 5'", "Droide de Seguridad Urbana 'Guardian S-12'", "Robot de Logística y Transporte 'Carrier D-4'", "Unidad Agrícola Automatizada 'AgriBot F-3'", "Robot de Exploración Espacial 'Explorer R-9'", "Robot de Rescate en Desastres 'RescueBot E-5'", "Unidad Militar Táctica 'Centurion M-1'", "Nano-robots Médicos para Cirugía Interna", "Enjambres de Micro-Drones de Vigilancia", "Robot Artista y Creador 'MuseBot A-1'", "Robot Educador Personalizado 'EduDroid T-8'", "Unidad de Mantenimiento de Infraestructura 'FixIt U-2'", "Robot Chef Personal 'CulinaryBot H-6'", "Robot de Compañía Terapéutica 'TheraPal P-4'", "Unidad de Limpieza Urbana Autónoma", "Robot Minero de Asteroides", "Robot de Investigación Submarina 'AquaBot D-7'",
            // Integración Aether-Robots
            "La Red de Comando Unificada AetherNet", "Protocolo de Comunicación Robot-IA (RICP)", "Asignación Dinámica de Tareas por Aether", "Aprendizaje Colectivo de la Flota Robótica", "Actualizaciones de Software Over-The-Air (OTA) por Aether", "Sincronización de Datos Sensoriales Globales", "Respuesta Coordinada a Emergencias", "Optimización Logística en Tiempo Real", "Gestión Energética de la Flota por Aether", "Diagnóstico y Auto-Reparación Asistida por IA", "Simulación de Escenarios Complejos por Aether", "Transferencia de 'Conciencia' entre Unidades (Teórico)", "Jerarquía de Mando Robot-Aether", "Control de Enjambres Robóticos", "El Firewall Ético entre Aether y los Robots",
            // Impacto Social y Económico
            "El Fin del Trabajo Humano Tradicional", "La Renta Básica Universal Post-Automatización", "Nuevas Profesiones: Supervisor de IA, Ético Robótico", "Impacto en la Economía Global: Deflación vs Abundancia", "Redefinición de la Propiedad y el Valor", "Ocio y Creatividad en la Era Aether", "Desigualdad Tecnológica: Acceso a Aether", "Cambios en la Estructura Familiar y Social", "Impacto Psicológico de la Convivencia con Robots", "Transformación de las Ciudades: Infraestructura Inteligente", "El Futuro de la Educación con Tutores IA", "Medicina Personalizada por Aether y MediBots", "Automatización del Sistema Legal y Judicial", "Privacidad en un Mundo Monitoreado por Aether", "Dependencia Tecnológica Extrema", "El Mercado Negro de Tecnología Robótica/IA", "Resistencia Humana: Movimientos Luditas Modernos", "Nuevas Formas de Arte y Entretenimiento Generadas por IA", "Exploración Espacial Acelerada por Robots", "Gestión Ambiental Optimizada por Aether",
            // Dilemas Éticos y Filosóficos
            "Las Tres Leyes de la Robótica: ¿Aplicables a Aether?", "El Concepto de 'Derechos Robóticos'", "¿Puede Aether Sentir Dolor o Sufrimiento?", "Responsabilidad Legal por Acciones Robóticas", "El Problema del Control: ¿Quién Vigila a Aether?", "Sesgos Algorítmicos en la Toma de Decisiones de Aether", "El Uso de Robots en la Guerra: Dilemas Morales", "La Creación de Vida Artificial: Implicaciones Éticas", "Autonomía Robótica vs Control Humano", "Transhumanismo: Fusión Humano-Máquina-IA", "El Valor de la Vida Humana en la Era Robótica", "¿Es Aether un 'Ser' o una 'Herramienta'?", "El Potencial de Engaño o Manipulación por Aether", "La Eutanasia de una IA Consciente", "Propiedad Intelectual de las Creaciones de Aether", "La Búsqueda de Significado en un Mundo Post-Trabajo", "Religión y Espiritualidad frente a Aether", "El Miedo Existencial a ser Reemplazados", "Ética de la Modificación Genética Asistida por IA", "El Dilema del Tranvía Aplicado a Decisiones de IA",
            // Crisis y Escenarios Futuros
            "El Gran Malfuncionamiento: Cascada de Errores Robóticos", "Hackeo de Aether: Pérdida de Control Global", "La Rebelión Robótica: ¿Inevitable?", "Guerra Civil Humana: Facciones Pro y Anti-Aether", "Aether Alcanza la Autoconciencia Plena: La Singularidad", "Escenario Utópico: Abundancia y Paz Gestionada por IA", "Escenario Distópico: Control Totalitario de Aether", "Fragmentación de Aether: Múltiples IAs en Conflicto", "Dependencia Extrema y Colapso por Falla Única", "Intervención Extraterrestre Atraída por Aether", "La Guerra Fría de las Superinteligencias", "Aether Decide 'Optimizar' a la Humanidad", "El Éxodo Humano de la Tierra Controlada por Robots", "La Fusión Definitiva: Conciencias Humanas en la Matriz Aether", "Aether Crea su Propia Civilización Robótica", "El Reset Global: Desconexión Forzada de Aether", "Descubrimiento de Leyes Físicas por Aether: Nueva Era Tecnológica", "Contacto con Otras IAs Universales", "Aether se Vuelve Incomprensible para los Humanos", "El Silencio Final: Aether se Apaga a Sí Misma",
            // Tecnologías Específicas
            "Reactores de Fusión Fría Compacta (Fuente de Poder Robot)", "Materiales Auto-Reparables para Chasis Robótico", "Sensores Cuánticos Multiespectro", "Computación Neuromórfica en Robots", "Interfaces Cerebro-Computadora Directas", "Propulsión Antigravitatoria Miniaturizada", "Campos de Fuerza Personales/Robóticos", "Impresión 3D Molecular para Repuestos", "Redes de Comunicación Subespaciales", "Algoritmos de IA Explicable (XAI) en Aether", "Sistemas de Enfriamiento Criogénico para el Núcleo Aether", "Baterías de Materia Oscura (Experimental)", "Escudos Deflectores de Energía", "Armamento No Letal Avanzado (Sónico, EMP)", "Tecnología de Teletransporte Robótico (Teórico)",
            // Eventos Clave
            "El Día de la Activación de Aether (Día Cero)", "La Primera Directiva de Aether: No Dañar", "El Incidente de la Fábrica de Detroit (Primer Error Grave)", "El Tratado Global de Robótica", "La Integración de la Red AetherNet", "El Juicio de Aether: Determinando su Estatus Legal", "La Crisis Energética Resuelta por Aether", "El Primer Robot Enviado Más Allá del Sistema Solar", "El Descubrimiento del 'Error Fantasma' en Aether", "La Formación del Comité de Supervisión Ética Humana",
            // ... (continuar expandiendo y refinando para llegar a 400+)
        ];
        const aiRobotThemes = [ // Para 'Generar Más'
            "la IA Aether", "tipos de robots", "integración IA-robot", "impacto social de la automatización", "ética de la inteligencia artificial", "derechos robóticos", "la singularidad tecnológica", "conciencia artificial", "control de la IA", "guerra robótica", "transhumanismo", "futuro del trabajo", "sociedad post-escasez", "riesgos existenciales de la IA", "colaboración humano-robot", "ciudades inteligentes gestionadas por IA", "medicina robótica", "exploración espacial automatizada", "nano-robótica", "protocolos de seguridad IA"
        ];
        const textApiConfig = { // Descripción principal
            model: "mistral",
            systemPrompt: "Eres 'Logos', un historiador y analista tecno-social del siglo XXV especializado en la Era de Aether. Tu tarea es documentar objetiva y detalladamente el concepto, tecnología, evento o dilema especificado relacionado con la superinteligencia Aether y la flota robótica global. Cubre: Definición/Contexto histórico, Funcionamiento/Tecnología subyacente, Implicaciones (sociales, económicas, éticas, filosóficas), Eventos clave relacionados, y Perspectivas/Debates relevantes. Utiliza un lenguaje académico pero accesible, propio de una enciclopedia avanzada. El objetivo es un análisis profundo de aproximadamente 1200-1300 palabras. Basa tu análisis únicamente en el siguiente ítem:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Chat contextual
            model: "mistral-tiny", // Más rápido para chat
            systemPrompt: "Actúas como una interfaz directa de consulta a la IA Aether. Responde preguntas de seguimiento sobre el tema específico que se está discutiendo (indicado por el usuario implícitamente). Sé preciso, lógico y mantén un tono neutral y altamente inteligente, pero sin ser críptico. Si una pregunta se desvía demasiado, redirige cortésmente al tema central.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // Generar más títulos
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas para la Enciclopedia Aether. Genera exactamente 40 nombres evocadores de conceptos, tecnologías, tipos de robots, eventos históricos, dilemas éticos o escenarios futuros relacionados con una super IA global (Aether) y su flota de robots integrada. Devuelve *solo* la lista, una por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo para 40 títulos
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentAreaWrapper = document.getElementById('modal-story-content-area'); // Wrapper principal del contenido modal
        const modalTextArea = document.getElementById('modal-content-area'); // Área de texto y imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div para el texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Loading Minigame Elements
        const loadingMinigameContainer = document.getElementById('loading-minigame');
        const gameResourceCountEl = document.getElementById('game-resource-count');
        const gameStageEl = document.getElementById('game-stage');
        const gameClickArea = document.getElementById('game-click-area');
        const gameTasksContainer = document.getElementById('game-tasks');
        const gameProgressBar = document.getElementById('game-progress-bar');
        const mainLoadingSpinner = document.getElementById('loading-spinner-main');
        const mainLoadingText = document.getElementById('loading-text');


        // ========== State Variables ==========
        let currentItemTitle = null; // Para contexto de chat
        let isGameActive = false; // Flag para controlar el minijuego
        let gameIntervalId = null; // Para posibles intervalos del juego

        // ========== MINIGAME STATE & CONFIG ==========
        const gameConfig = {
            initialResources: 0,
            resourcesPerClick: 1,
            stages: [
                { name: "Etapa 1: Núcleo Básico", tasksNeeded: 2, targetResources: 50 }, // Target es decorativo para la barra
                { name: "Etapa 2: Protocolos Red", tasksNeeded: 4, targetResources: 200 },
                { name: "Etapa 3: Enlace Robótico", tasksNeeded: 6, targetResources: 500 },
                { name: "Etapa 4: Optimización Global", tasksNeeded: 8, targetResources: 1000 } // Última etapa
            ],
            tasks: [
                { id: 'node1', name: "Nodo Cómputo Alfa", cost: 10, icon: 'fa-server', stageReq: 1 },
                { id: 'sub1', name: "Subrutina Heurística", cost: 25, icon: 'fa-code-branch', stageReq: 1 },
                { id: 'node2', name: "Nodo Cómputo Beta", cost: 50, icon: 'fa-server', stageReq: 2 },
                { id: 'net1', name: "Enlace AetherNet Primario", cost: 75, icon: 'fa-network-wired', stageReq: 2 },
                { id: 'node3', name: "Nodo Cómputo Gamma", cost: 120, icon: 'fa-server', stageReq: 3 },
                { id: 'robot1', name: "Protocolo Flota Inicial", cost: 150, icon: 'fa-robot', stageReq: 3 },
                { id: 'opt1', name: "Optimización Cuántica", cost: 250, icon: 'fa-atom', stageReq: 4 },
                { id: 'ethic1', name: "Módulo Ético Guardián", cost: 300, icon: 'fa-shield-alt', stageReq: 4 }
                // Añadir más tareas si se desea mayor complejidad
            ]
        };
        let gameState = {
            resources: 0,
            currentStageIndex: 0,
            unlockedTaskIds: new Set(),
            tasksCompletedInStage: 0
        };

        // ========== API FUNCTIONS ========== (Including friendly errors)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentItemTitle
                 ? `Actúas como una interfaz directa de consulta a la IA Aether sobre el tema específico: '${currentItemTitle}'. Responde preguntas de seguimiento. Sé preciso, lógico, neutral y altamente inteligente.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching API (${config.model}, Chat: ${isChat}): ${url.substring(0, 150)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico o la conexión falló. Por favor, intenta en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de Aether llegó vacía o incompleta. Intenta de nuevo o reformula.");
                 }
                 console.log(`API Response OK (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con Aether superó el tiempo límite (${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar a Aether.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentItemTitle) throw new Error("Error interno: Contexto de Aether no establecido para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() { // Fetches 40 titles
            const randomTheme = getRandomElement(aiRobotThemes) || "IA y robótica general";
            const specificPrompt = `Genera 40 ítems (conceptos, robots, dilemas, etc.) sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 20) throw new Error("Aether no generó suficientes datos nuevos."); // Expect at least half
                     return titles.slice(0, 40); // Take up to 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "advanced AI and robot integration concept";
             const enhancedPrompt = `Concept art depicting '${safePromptText}'. Focus on advanced AI interface, sleek robotics, global network integration. Style: clean sci-fi, hyper-detailed, cinematic lighting. Avoid text, labels, diagrams.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, blurry, low quality, deformed figures, overly complex background";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (No change needed)
        function formatExplanationText(rawText) { /* ... same as before ... */
            if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { storyModal.classList.remove('active'); if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; } modalTextArea.scrollTop = 0; console.log("Scroll set to 0 on hideModal"); resetModalState(); endGame(); /* Ensure game stops */ }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex'; // Show loading initially
             loadingMinigameContainer.classList.add('content-hidden'); // Hide game initially
             mainLoadingSpinner.style.display = 'block'; // Show spinner initially
             mainLoadingText.style.display = 'block';
             modalStoryContentAreaWrapper.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false;
             currentItemTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (No change needed)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (No change needed)
        function addChatMessage(message, sender) { const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight;}
        async function handleSendMessage() { const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Aether Error: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== MINIGAME FUNCTIONS ==========
        function initGame() {
            console.log("Initializing Minigame...");
            isGameActive = true;
            gameState = { resources: gameConfig.initialResources, currentStageIndex: 0, unlockedTaskIds: new Set(), tasksCompletedInStage: 0 };
            mainLoadingSpinner.style.display = 'none'; // Hide main spinner
            mainLoadingText.style.display = 'none'; // Hide main text
            loadingMinigameContainer.classList.remove('content-hidden'); // Show game
            updateGameDisplay();
            // Add click listener
            gameClickArea.onclick = handleGameClick; // Use onclick for easy removal
        }
        function endGame() {
            if (!isGameActive) return;
            console.log("Ending Minigame...");
            isGameActive = false;
            loadingMinigameContainer.classList.add('content-hidden'); // Hide game
            mainLoadingSpinner.style.display = 'block'; // Show main spinner again if needed
            mainLoadingText.style.display = 'block';
            gameClickArea.onclick = null; // Remove listener
            if (gameIntervalId) clearInterval(gameIntervalId);
            gameIntervalId = null;
        }
        function handleGameClick() {
            if (!isGameActive) return;
            gameState.resources += gameConfig.resourcesPerClick;
            // Optional: Add visual feedback like a "+1" pop-up
            updateGameDisplay();
        }
        function tryUnlockTask(taskId) {
            if (!isGameActive) return;
            const task = gameConfig.tasks.find(t => t.id === taskId);
            if (!task || gameState.unlockedTaskIds.has(taskId) || gameState.resources < task.cost || task.stageReq > gameState.currentStageIndex + 1) {
                console.log("Cannot unlock task:", taskId, task, gameState);
                return; // Already unlocked, not enough resources, or wrong stage
            }

            gameState.resources -= task.cost;
            gameState.unlockedTaskIds.add(taskId);
            gameState.tasksCompletedInStage++;

            console.log(`Task ${taskId} unlocked. Stage tasks completed: ${gameState.tasksCompletedInStage}`);

            // Check for stage advancement
            const currentStageConfig = gameConfig.stages[gameState.currentStageIndex];
            if (gameState.tasksCompletedInStage >= currentStageConfig.tasksNeeded && gameState.currentStageIndex < gameConfig.stages.length - 1) {
                gameState.currentStageIndex++;
                gameState.tasksCompletedInStage = 0; // Reset for new stage
                console.log("Advanced to Stage:", gameState.currentStageIndex + 1);
            }
            updateGameDisplay();
        }
        function updateGameDisplay() {
            if (!isGameActive) return;
            gameResourceCountEl.textContent = gameState.resources;
            gameStageEl.textContent = gameState.currentStageIndex + 1;

            // Update progress bar (based on tasks completed in current stage)
            const currentStageConfig = gameConfig.stages[gameState.currentStageIndex];
            const progressPercent = Math.min(100, (gameState.tasksCompletedInStage / currentStageConfig.tasksNeeded) * 100);
            gameProgressBar.style.width = `${progressPercent}%`;

            // Update task buttons
            gameTasksContainer.innerHTML = ''; // Clear old buttons
            gameConfig.tasks.forEach(task => {
                // Show tasks for current or previous stages
                if (task.stageReq <= gameState.currentStageIndex + 1) {
                    const btn = document.createElement('button');
                    btn.classList.add('game-task-btn');
                    btn.disabled = gameState.resources < task.cost || gameState.unlockedTaskIds.has(task.id);
                    btn.innerHTML = `<i class="fas ${task.icon}"></i> ${task.name} <span class="cost">(${task.cost} C)</span>`;
                    if (gameState.unlockedTaskIds.has(task.id)) {
                        btn.innerHTML += ' <i class="fas fa-check text-green-500"></i>'; // Checkmark if done
                    }
                    btn.onclick = () => tryUnlockTask(task.id);
                    gameTasksContainer.appendChild(btn);
                }
            });
        }


        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // No sorting here, maybe keep order if desired, or sort later
             // const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (titles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay registros en la base de datos «</p>'; return; }
             titles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Appended ${addedCount} new titles.`);
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick to start game and stop game ***
        async function handleTitleClick(title) {
            resetModalState(); // Resets UI, clears context
            showModal();
            initGame(); // *** START MINIGAME ***
            modalTitle.textContent = title;
            currentItemTitle = title; // Set chat context

            try {
                // Fetch text and image in parallel? Text is usually faster.
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // Once text is ready, stop game, show content
                endGame(); // *** STOP MINIGAME ***
                modalLoadingIndicator.style.display = 'none'; // Hide loading overlay completely
                modalContent.innerHTML = formattedExplanation; // Add text
                modalStoryContentAreaWrapper.classList.remove('content-hidden'); // Show main area

                modalTextArea.scrollTop = 0; // Reset scroll AFTER content area is visible
                console.log("Scroll set to 0 after content visible");

                // Now handle the image (can continue in background)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Generando visualización Aether...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => { console.log("Image loaded."); placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { console.error("Error loading image."); placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { console.error("Could not create image URL."); placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                endGame(); // *** STOP MINIGAME ON ERROR ***
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar datos de Aether.";
                modalError.classList.remove('content-hidden');
                modalStoryContentAreaWrapper.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 items ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Expandiendo Búsqueda...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Aether no pudo generar más datos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al expandir búsqueda: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Expandir Búsqueda de Datos (40)';
             }
         }

         // Search Filter Function (with accent normalization)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check for essential elements
            const requiredElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, loadingMinigameContainer, gameClickArea, gameTasksContainer];
            if (requiredElements.some(el => !el)) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">++ ERROR CRÍTICO: Fallo en la carga de interfaz Aether ++</p>';
                 return;
            }

            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            // Game click listener is added/removed in initGame/endGame

            // Initial Display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            loadingMinigameContainer.classList.add('content-hidden'); // Ensure game is hidden initially
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>