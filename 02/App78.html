<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Historias de Romance</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes más suaves/elegantes -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Romance --- */
        :root {
            --color-primary: #d81b60; /* Rosa Intenso pero Cálido */
            --color-secondary: #ffb300; /* Dorado Suave (Ámbar) */
            --color-background: #fff8f0; /* Crema Muy Claro */
            --color-text: #5d4037; /* Marrón Oscuro Cálido */
            --color-text-muted: #8d6e63; /* Marrón Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro para Modal */
            --color-border: #d7ccc8; /* Marrón Muy Claro / Beige */
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.08), 0 1px 2px 0 rgba(0, 0, 0, 0.04); /* Sombras más suaves */
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            --border-radius: 8px; /* Bordes más redondeados */
            --transition-normal: all 0.3s ease-in-out; /* Transición un poco más suave */
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; }
        /* Usar fuente elegante para títulos */
        h1.logo, h1.page-title, h2.section-title, #modal-title { font-family: 'Playfair Display', serif; font-weight: 700; }
        h1.logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        #modal-title { color: var(--color-primary); }
        .navbar { background-color: rgba(255, 248, 240, 0.85); /* Fondo navbar crema semi-transparente */ backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.5rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Lato', sans-serif; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #fff3e0; /* Crema dorado suave hover */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #ad1457; /* Rosa más oscuro */ box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #bcaaa4; /* Marrón claro deshabilitado */ color: #efdcd5; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(93, 64, 55, 0.8); /* Overlay marrón translúcido */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 2.5rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            min-height: 350px; /* Altura mínima para pantalla de carga */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: #eee; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }
        #modal-content {
            line-height: 1.8;
            color: var(--color-text);
            white-space: normal;
            overflow-y: auto;
            padding: 0 10px 1.5rem 10px; /* Padding inferior */
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-secondary) var(--color-border); /* Scrollbar dorado/beige */
        }
        #modal-content::-webkit-scrollbar { width: 10px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-text); font-style: italic; opacity: 0.9; } /* Énfasis sutil */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: bold; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-text); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        /* Estilo para la imagen insertada al final del contenido */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); }
        /* Estilo para el placeholder/spinner de la imagen final */
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(215, 204, 200, 0.5); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 248, 240, 0.97); /* Fondo de carga crema */ display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.4rem; font-family: 'Playfair Display'; text-shadow: 1px 1px 2px rgba(255,255,255,0.3); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #ffcdd2; /* Fondo error rosa pálido */ color: #c62828; /* Texto rojo oscuro */ padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #ef9a9a; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body class="bg-cream-100">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex justify-center items-center">
             <div class="flex items-center text-center">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-heart mr-3 text-pink-600 animate-pulse"></i> <!-- Icono corazón -->
                     Corazón de Tinta
                     <i class="fas fa-feather-alt ml-3 text-pink-600 transform rotate-12"></i> <!-- Icono pluma -->
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Donde Nacen las Historias de Amor</h1>
             <p class="text-xl text-brown-600 mb-8 max-w-3xl mx-auto">Elige un comienzo, una chispa, un encuentro... y deja que la magia del romance se despliegue en una historia única generada para ti.</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-amber-600 mr-2"></i> <!-- Icono libro abierto -->
                 Selecciona una Chispa...
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-brown-400 col-span-full text-center text-lg">Buscando inspiración en las estrellas...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Historias
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Tejiendo hilos de romance...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - La imagen se añadirá aquí al final -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Story text (HTML) goes here -->
                     <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-heart-broken"></i> <!-- Icono corazón roto -->
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-cream-200 text-brown-700 py-6 mt-12 border-t border-brown-200">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias generadas por IA para inspirar y emocionar. Cada relato es una chispa única de ficción romántica.</p>
              <p class="mt-1">Disfruta del viaje a través de encuentros inesperados y conexiones profundas.</p>
              <p class="mt-2">© 2025 Corazón de Tinta</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Encuentros Fortuitos / Amor a Primera Vista
            "El café derramado en la librería", "La melodía compartida en el metro", "Perdidos bajo la misma lluvia torrencial", "El último asiento libre en el tren", "La risa que cruzó la habitación llena", "Un perro perdido los unió", "Confusión de maletas en el aeropuerto", "Ayuda inesperada con un mapa en París", "Miradas cruzadas en la galería de arte", "El libro olvidado en el banco del parque", "Atrapados juntos en el ascensor", "La canción que ambos tarareaban", "Error de número telefónico que cambió todo", "Voluntarios en el mismo refugio animal", "El paraguas compartido en un día gris", "Testigos de la misma estrella fugaz", "Vecinos que nunca se habían hablado", "Una nota dejada en un libro de segunda mano", "El turista perdido y el local amable", "La clase de cocina donde todo salió mal (o bien)", "Pidiendo el mismo café extraño", "El concierto al aire libre bajo la luna", "Una cometa enredada en un árbol", "Ayudando a recoger frutas caídas del mercado", "El debate apasionado en el club de lectura", "Encontrarse en la cima de la montaña al amanecer", "Esperando en la misma fila interminable", "El graffiti que ambos admiraban", "Salvando a un gato juntos", "Buscando el mismo vinilo raro",
            // Friends to Lovers / Amor Cocido a Fuego Lento
            "El pacto de ser 'solo amigos' que se rompió", "Confesiones bajo un cielo estrellado", "El compañero de estudio que se volvió indispensable", "La amistad que sobrevivió a la distancia y se transformó", "El 'wingman'/'wingwoman' que se enamoró", "Años de cartas que revelaron sentimientos ocultos", "El viaje de amigos que lo cambió todo", "Cuidándose mutuamente en la enfermedad", "El proyecto compartido que encendió la chispa", "La boda de un amigo en común", "Recordando juntos la infancia", "El secreto que solo se confiaron el uno al otro", "La mudanza que los acercó (o separó temporalmente)", "Descubriendo hobbies ocultos del otro", "El apoyo incondicional en tiempos difíciles", "La broma interna que se volvió significativa", "Aprendiendo a bailar juntos para un evento", "La noche de juegos que reveló más que competitividad", "Compartiendo sueños y miedos más profundos", "El momento 'eureka' de que siempre fue él/ella", "Celebrando los éxitos del otro como propios", "La tradición anual que se volvió romántica", "Defendiéndose mutuamente ante los demás", "El silencio cómodo que decía más que las palabras", "Superando un malentendido que fortaleció el vínculo", "Cocinar juntos y quemar la cena", "El 'accidente' de quedarse dormidos juntos en el sofá", "La primera vez que se vieron como algo más", "Regalos de cumpleaños que siempre acertaban", "El miedo a arruinar la amistad",
            // Enemies to Lovers / Rivales Apasionados
            "Rivales académicos obligados a trabajar juntos", "Competidores empresariales con una atracción innegable", "El abogado/a contra el/la que siempre litigaba", "Vecinos ruidosos en guerra... hasta que hablaron", "Artistas con visiones opuestas forzados a colaborar", "El crítico mordaz y el objeto de su crítica", "Dos chefs compitiendo por la misma estrella Michelin", "Políticos de bandos opuestos con química secreta", "Herederos de familias enfrentadas", "El choque cultural que generó chispas", "El organizador de bodas vs. el fotógrafo cínico", "Un debate online que pasó al mundo real", "Atrapados por una tormenta de nieve en una cabaña", "El policía y el 'informante' reacio", "Compañeros de trabajo que se saboteaban... al principio", "La disputa por el último puesto de estacionamiento", "Entrenadores de equipos rivales", "El músico callejero y el dueño del local cercano", "Obligados a compartir un espacio de oficina diminuto", "La apuesta que los obligó a conocerse", "El escéptico y la creyente discutiendo sobre lo paranormal", "Protector vs. protegida que no quiere protección", "El bibliotecario estricto y la lectora caótica", "Dos guías turísticos compitiendo por el mismo grupo", "La discusión sobre la última porción de pizza", "El hacker y la experta en ciberseguridad", "Héroe y villano con un pasado complicado", "El periodista buscando la exclusiva y la fuente esquiva", "Compañeros de piso incompatibles", "La 'princesa' y el 'rebelde' del reino vecino",
            // Segunda Oportunidad / Amores Reencontrados
            "El amor de instituto reencontrado años después", "La carta que llegó con una década de retraso", "Volver al pueblo natal y encontrar al 'que se escapó'", "Divorciados que se dan cuenta de su error", "El reencuentro en una reunión de antiguos alumnos", "La promesa olvidada que resurge", "Un objeto perdido que los vuelve a conectar", "Cuidando a un familiar común", "El mensaje equivocado que reabre la comunicación", "Trabajando juntos en un proyecto inesperado", "Redescubriendo la ciudad donde se enamoraron", "La canción que los transporta al pasado", "Una vieja fotografía encontrada", "Perdón después de una traición pasada", "Criando a un hijo/a separados, redescubren su amor", "El destino los sienta juntos en un avión", "Un diario antiguo revela sentimientos no dichos", "La boda de sus propios hijos", "Enfrentando juntos una crisis del pasado", "La terapia de pareja... años después", "Volviendo a visitar su 'lugar especial'", "Cumpliendo una vieja lista de deseos juntos", "El secreto que los separó y ahora los une", "Aprendiendo a amar las versiones adultas del otro", "Reconstruyendo la confianza perdida", "Una llamada telefónica después de años de silencio", "La caja de recuerdos encontrada en el desván", "El fantasma de un amor que nunca murió", "Entendiendo por qué se separaron la primera vez", "La chispa que nunca se apagó del todo",
            // Romance Histórico / De Época
            "La dama y el caballero prohibido", "Un amor secreto durante la guerra", "La institutriz y el señor de la mansión", "El pirata y la noble rescatada (o secuestrada)", "Un matrimonio concertado que florece en amor", "La artista bohemia y el aristócrata en París", "Amor epistolar a través de continentes", "El soldado que regresa a casa y encuentra el amor cambiado", "La espía que se enamora de su objetivo", "Un romance en la corte real lleno de intrigas", "El herrero del pueblo y la hija del boticario", "Sobreviviendo juntos a la Revolución Francesa", "El explorador y la 'salvaje' princesa indígena", "Un amor nacido en los salones de baile de la Regencia", "La sufragista y el policía conservador", "Enamorados en lados opuestos de la Guerra Civil Americana", "El médico rural y la maestra recién llegada", "Un romance secreto en el Lejano Oeste", "La bibliotecaria y el arqueólogo en Egipto", "Amor en tiempos de la Peste Negra", "La actriz de teatro y el dramaturgo melancólico", "Un viaje en el Orient Express lleno de misterio y romance", "La vikinga fuerte y el monje erudito", "Amor en la corte del Rey Arturo", "El constructor de catedrales y la joven de la vidriera", "Un romance prohibido en la antigua Roma", "La geisha y el comerciante extranjero en Japón feudal", "Superando las barreras de clase en la Inglaterra victoriana", "El relojero y la dama autómata", "Un amor que desafía las convenciones sociales de su tiempo",
            // Fantasía / Ciencia Ficción Romántica
            "El caballero dragón y la princesa que no necesita rescate", "Un amor entre un ángel y un demonio", "La hechicera y el guerrero destinados a ser enemigos", "Enamorarse de una estrella caída a la Tierra", "El último humano y la IA que desarrolló sentimientos", "Un romance a través de dimensiones paralelas", "La cazadora de monstruos y el vampiro renegado", "El príncipe tritón y la bióloga marina", "Amor en una nave espacial generacional", "La guardiana del bosque mágico y el leñador perdido", "Un romance con un fantasma atrapado", "El viajero del tiempo que se enamora en el pasado (o futuro)", "La princesa alienígena exiliada y el piloto terrestre", "Un amor que desafía una profecía oscura", "La curandera elfa y el enano herrero", "Enamorarse del avatar de alguien en un mundo virtual", "El cambiaformas que no puede controlar su corazón", "Un romance en una ciudad flotante", "La bibliotecaria de libros prohibidos y el inquisidor", "Amor más allá de la muerte (literalmente)", "La piloto rebelde y el emperador galáctico", "Un romance con un ser hecho de pura energía", "La sirena que comercia su voz por amor", "El último mago y la científica escéptica", "Un amor que florece en un mundo post-apocalíptico", "La guardiana del faro interdimensional", "Enamorarse de un sueño recurrente que se vuelve real", "El autómata que aprende a amar", "Un romance cuántico: conectados a través del universo", "La diosa olvidada y el mortal que la recuerda",
            // Otros Tropos y Escenarios
            "Romance de oficina con reglas estrictas", "Amor en un reality show (¿real o fingido?)", "El guardaespaldas que se enamora de su cliente", "Un romance durante un viaje por carretera improvisado", "Fingir ser pareja para una boda familiar", "Amor a distancia con desafíos modernos", "El músico famoso y la fan 'normal'", "Un romance en un viñedo italiano", "La panadera y el crítico gastronómico", "Amor que florece en un grupo de apoyo", "La florista y el arquitecto que rediseña su calle", "Un romance en una pequeña isla remota", "El escritor bloqueado y su musa inesperada", "Amor entre dos personas con pasados dolorosos", "La veterinaria y el dueño de una mascota exótica", "Un romance que comienza con un malentendido hilarante", "Amor en la tercera edad: nunca es tarde", "El guía de rafting y la turista aventurera", "Un amor que supera barreras culturales y lingüísticas", "La astrónoma y el poeta bajo el mismo cielo", "Romance en un retiro de yoga o meditación", "El restaurador de arte y el misterio de un cuadro", "Un amor que nace cuidando un jardín secreto", "La barista que dibuja en las tazas y el cliente diario", "El profesor de literatura y la librera local", "Amor en un crucero alrededor del mundo", "La fotógrafa de naturaleza y el guardabosques", "Un romance que comienza con una apuesta perdida", "El chef de un food truck y la bloguera de comida", "Amor que surge de una rivalidad amistosa online",
            // Títulos más evocadores / poéticos
            "Donde el mar besa la orilla", "Susurros en la biblioteca a medianoche", "El color de tus ojos al atardecer", "Cartas atadas con hilo de seda", "Bajo el árbol de los secretos compartidos", "La melodía que nos encontró", "Ecos de una promesa en la nieve", "El faro que guía hacia ti", "Un mapa dibujado en pecas", "La llave olvidada del jardín secreto", "Cuando florecieron los cerezos tardíos", "El último baile bajo la luna de agosto", "Polvo de estrellas en tus pestañas", "El aroma del café y los comienzos", "Si las paredes de esta librería hablaran", "El puente donde nuestros caminos se cruzaron", "La cicatriz que contaba nuestra historia", "Mil grullas de papel para un deseo", "El reflejo en la ventana del tren", "La constelación que lleva tu nombre", "Náufragos en la isla del quizás", "El reloj de arena de nuestros momentos", "Tinta invisible en páginas compartidas", "El silencio después de la tormenta", "Donde crecen las flores silvestres del perdón", "La partitura inacabada", "Besos con sabor a sal y verano", "El horizonte donde te esperaré", "Fragmentos de risa en el viento", "La ciudad dormida bajo nuestro secreto", "El hilo rojo que nos ataba", "Cuando el tiempo se detuvo en esa mirada", "La brújula que apuntaba a tu corazón", "Sombras danzantes a la luz de las velas", "El jardín de invierno de nuestros recuerdos", "La ecuación imperfecta del amor", "Nombres grabados en la corteza del viejo roble", "El eco de tu voz en mis sueños", "Laberinto de calles, destino encontrado", "La última luciérnaga del verano",
            // Conceptos / Preguntas
            "¿Puede el amor verdadero superar cualquier obstáculo?", "¿Qué pasa si tu alma gemela vive en otro siglo?", "¿Es posible enamorarse de alguien a quien nunca has visto?", "La ciencia detrás de la química instantánea", "El lenguaje secreto de las miradas", "El amor como fuerza transformadora", "¿Existe el destino en el romance?", "La diferencia entre pasión y amor duradero", "Cómo sanar un corazón roto para volver a amar", "El papel de la casualidad en los encuentros románticos", "El amor en la era digital: desafíos y ventajas", "¿Puede un amor prohibido tener un final feliz?", "La importancia de la comunicación en la pareja", "El sacrificio como máxima prueba de amor", "Encontrar el amor cuando menos te lo esperas", "El miedo a la vulnerabilidad en el romance", "Amores platónicos que trascienden", "¿Qué significa 'amar incondicionalmente'?", "El primer amor: ¿marca para siempre?", "Cómo mantener viva la chispa a lo largo del tiempo", "El romance como viaje de autodescubrimiento", "¿Puede la amistad ser la base más sólida para el amor?", "La influencia de la familia en las relaciones amorosas", "El poder curativo del amor", "Amores que desafían las expectativas sociales", "El arte de la carta de amor perdida", "¿Qué buscar en una pareja para toda la vida?", "El perdón como pilar del amor duradero", "La magia de los pequeños gestos cotidianos", "El amor como inspiración artística"
        ];
        const romanceThemes = [
            "historias de amor a primera vista", "romances de segunda oportunidad", "amor entre amigos (friends-to-lovers)", "rivales que se enamoran (enemies-to-lovers)", "amor en lugares inesperados", "romance histórico", "fantasía romántica", "ciencia ficción romántica", "amor a distancia", "romance de oficina", "bodas y enredos familiares", "viajes y descubrimientos amorosos", "romance juvenil (Young Adult)", "amor maduro / tardío", "romance paranormal", "comedia romántica", "drama romántico", "amor prohibido", "romance LGTBQ+", "historias de almas gemelas", "triángulos amorosos", "romance slow burn (a fuego lento)", "romance en pueblos pequeños", "amor en grandes ciudades", "romance epistolar o digital", "historias sobre superar el desamor"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres una sensible y elocuente escritora de historias de romance. Tu tarea es tejer una narrativa conmovedora, emotiva y cautivadora basada en el título o la premisa proporcionada. Desarrolla personajes creíbles con profundidad emocional, crea una atmósfera evocadora y explora la dinámica romántica con sensibilidad y detalle. Enfócate en el viaje emocional, los diálogos significativos, las descripciones sensoriales y un arco argumental que explore la conexión, los desafíos y el crecimiento de la relación. Busca un final satisfactorio (no necesariamente un 'felices para siempre' perfecto, pero sí emocionalmente resonante). El objetivo es una historia corta de aproximadamente 1200-1300 palabras.",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un libro de cuentos románticos. Genera exactamente 15 ideas, títulos o premisas para historias de romance, que sean evocadoras y variadas en tono y escenario. Devuelve *solo* la lista de ideas/títulos, una por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Contenedor del texto Y la imagen final
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ========== (Sin cambios estructurales, solo contenido de prompts)
        async function fetchTextFromApi(prompt, config) {
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo.`);
                 throw new Error(`Error de comunicación con la API: ${error.message}`);
             }
        }
        async function fetchExplanationText(conceptTitle) { // Renombrado internamente, ahora es fetchStoryText
            const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de")) {
                   throw new Error("La IA no pudo tejer una historia adecuada o suficientemente detallada para esta chispa.");
               }
             return text;
         }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(romanceThemes) || "ideas de romance inesperado";
             const specificPrompt = `Genera 15 ideas o títulos para historias de romance sobre ${randomTheme}`;
             console.log("Generating titles with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             // Ajuste ligero del filtro para títulos potencialmente más cortos en romance
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 4 && line.length < 150);
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas románticas.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a ROMANCE
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "romantic encounter scene";
             // Prompt ENFOCADO en ambiente romántico, luz suave, conexión.
             const enhancedPrompt = `Romantic, evocative scene inspired by '${safePromptText}'. Soft lighting, painterly style, focus on emotion, connection, or atmosphere. Maybe a couple (can be abstract or silhouetted), beautiful scenery (sunset, starry night, cozy cafe), or symbolic objects (flower, letter, lock). Ethereal, dreamy mood. Avoid text or UI elements.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // NEGATIVE PROMPT: Evitar elementos discordantes, texto, etc.
             const negativePrompt = "text, words, labels, letters, captions, writing, numbers, diagrams, charts, graphs, UI, interface, menu, buttons, watermark, signature, multiple panels, collage, realistic photo, screenshot, violence, gore, horror, sadness, loneliness, crowd, busy street, harsh lighting, mundane objects";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Sin cambios estructurales)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = ''; // Clear previous text and image
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (Sin cambios estructurales)
        function getRandomElement(arr) { /* ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... */
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]);
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-brown-400 col-span-full text-center">No hay chispas disponibles.</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        // *** handleTitleClick: Lógica para añadir imagen al final del texto se MANTIENE ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // 1. Fetch and format story text
                const rawStoryText = await fetchExplanationText(title); // Reusing function name, it fetches story now
                const formattedStory = formatExplanationText(rawStoryText);

                // 2. Stop loading indicator, display text FIRST
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedStory; // Inject text content
                modalStoryContentArea.classList.remove('content-hidden');

                 // 3. *** RESET SCROLL *** after text content is in and visible
                modalContent.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // 4. Prepare and append image placeholder/spinner WITHIN #modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Creando imagen evocadora...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Add placeholder at the end

                // 5. Create and append the actual image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización romántica inspirada en ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-camera placeholder-icon" style="opacity: 0.5;"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">No se pudo cargar la imagen.</p>
                    `;
                };

                // Get URL and set src AFTER attaching handlers
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append image element to content
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">Error al generar URL de imagen.</p>
                    `;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = ''; // Clear partial content on error
            }
        }

        async function handleGenerateMoreTitles() { // Lógica sin cambios, solo textos
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando musas...'; // Thematic text
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block';
                 } else {
                     alert("Las musas están esquivas... No se encontraron nuevas historias."); // Thematic text
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error buscando inspiración: ${error.message}`); // Thematic text
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Historias'; // Thematic text
             }
         }


        // ========== INITIALIZATION ========== (Sin cambios estructurales)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p style="color: #c62828; font-size: 2em; text-align: center; padding-top: 5em; font-family: \'Playfair Display\';">¡Oh, no! El libro de historias de amor no se abre.</p>'; return; } // Thematic error
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>