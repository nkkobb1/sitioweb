<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cybernetic Synergy League - Archivos Oficiales</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes eSports/Tech -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Titillium+Web:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #00f2ea; /* Azul Eléctrico/Cyan Vivo */
            --color-secondary: #ff8c00; /* Naranja Energético */
            --color-tertiary: #a020f0; /* Morado Vibrante */
            --color-background: #0d1117; /* Gris Muy Oscuro GitHub-like */
            --color-background-alt: #161b22; /* Gris Oscuro Ligeramente más claro */
            --color-text: #c9d1d9; /* Gris Claro Suave */
            --color-text-muted: #8b949e; /* Gris Medio */
            --color-modal-bg: #1a202c; /* Azul/Gris Oscuro Intenso */
            --color-border: #30363d; /* Borde Gris Oscuro */
            --color-error-bg: #4d1212;
            --color-error-text: #fca5a5;
            --color-error-border: #ef4444;

            --shadow-sm: 0 1px 2px 0 rgba(0, 242, 234, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 242, 234, 0.15), 0 2px 4px -2px rgba(0, 242, 234, 0.1);
            --shadow-lg: 0 0 25px -5px rgba(0, 242, 234, 0.25), 0 8px 10px -6px rgba(0, 242, 234, 0.2);
            --border-radius: 4px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Titillium Web', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 300; }
        h1, h2, h3, h4, .logo, button { font-family: 'Rajdhani', sans-serif; font-weight: 600; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 7px rgba(0, 242, 234, 0.8); }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; text-shadow: 0 0 5px rgba(255, 140, 0, 0.7); }
        .navbar { background-color: rgba(13, 17, 23, 0.85); backdrop-filter: blur(8px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-background-alt); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Titillium Web'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 242, 234, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        /* Lista de Títulos */
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-background-alt); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); border-left: 4px solid var(--color-tertiary); /* Borde izquierdo morado */ min-height: 65px; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; }
        .title-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-secondary); border-left-color: var(--color-secondary); color: var(--color-secondary); background-color: var(--color-modal-bg); }

        /* Botón Generar Más */
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-secondary), var(--color-tertiary)); color: var(--color-background); padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-size: 1.1rem; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: none; font-weight: 700; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-tertiary), var(--color-secondary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        /* Modal Principal */
        #story-modal { /* Estilos base sin cambios */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(13, 17, 23, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: var(--border-radius); padding: 1.5rem 2rem; max-width: 980px; width: 96%; max-height: 90vh; min-height: 450px; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: var(--color-background); transform: rotate(90deg); box-shadow: 0 0 10px var(--color-secondary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área Contenido (Texto + Imagen) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(48, 54, 61, 0.5); }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(48, 54, 61, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Rajdhani', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 600; letter-spacing: 0.5px; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; }
        /* Imagen Final + Placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: 0 0 15px rgba(0, 242, 234, 0.3); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(48, 54, 61, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Sección de Chat */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: var(--color-background-alt); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) rgba(48, 54, 61, 0.5); }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(48, 54, 61, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-family: 'Titillium Web'; font-size: 0.95rem;}
        .user-message { background-color: var(--color-secondary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400; }
        .ai-message { background-color: var(--color-border); color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: var(--color-background-alt); color: var(--color-text); border-radius: var(--border-radius); font-family: 'Titillium Web'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #00e0e0; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Titillium Web';}
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Pantalla de Carga Modal */
        #modal-loading { text-align: center; padding: 3rem 1rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(13, 17, 23, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        /* Estilo para el texto de carga dinámico */
        #loading-text { font-weight: 400; color: var(--color-text); font-size: 1.1rem; font-family: 'Titillium Web'; text-shadow: 0 0 5px var(--color-primary); min-height: 2em; /* Espacio para que no salte */ display: flex; align-items: center; justify-content: center; transition: opacity 0.3s ease; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Mensaje de Error */
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Titillium Web'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Imagen Fullscreen */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(13, 17, 23, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-trophy mr-2"></i> <!-- Icono trofeo -->
                     Cybernetic Synergy League
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Archivos Oficiales de la CSL «</span>
         </div>
     </nav>

     <!-- Contenido Principal -->
     <main class="container mx-auto px-4 pb-16">
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Donde la Fuerza y el Cálculo Colisionan</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Explora las disciplinas híbridas, conoce a los cyber-atletas y robots legendarios, y descubre las tecnologías que definen la Cybernetic Synergy League (CSL).</p>
         </section>

         <!-- Buscador -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar disciplina, equipo, jugador, tecnología...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Lista de Títulos -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-stream text-purple-400 mr-2"></i> <!-- Icono lista/stream -->
                 Índice de la Liga
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Accediendo a los registros de la CSL...</p>
                  <!-- .title-item van aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron registros coincidentes en los archivos de la CSL «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Cargar Más Registros (40)
                  </button>
             </div>
         </section>
     </main>

     <!-- Modal de Explicación -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Indicador de Carga -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p id="loading-text">Iniciando enlace de datos...</p> <!-- Texto dinámico aquí -->
             </div>

             <!-- Área Contenido Modal -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Área Texto Scrollable -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Texto HTML -->
                         <!-- Imagen + Placeholder -->
                     </div>
                 </div>
                 <!-- Sección Chat Fija -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando consulta CSL...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Consulta sobre este registro CSL...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>
                 <!-- Área de Error -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Overlay Imagen Fullscreen -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada CSL">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Archivos de la Cybernetic Synergy League generados por IA con fines ilustrativos y de entretenimiento.</p>
              <p class="mt-1">La CSL y sus componentes son ficticios.</p>
              <p class="mt-2">© 2088 CSL Archives Division</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Disciplinas Híbridas Principales
            "Kinetic Chess (Ajedrez Cinético)", "Velocity Grid (Rejilla de Velocidad)", "Quantum Leap Obstacle Course", "Synaptic Sprint (Carrera Sináptica)", "Calculus Climb (Escalada de Cálculo)", "Aegis Arena (Arena Égida - Defensa)", "Logic Locksmith (Cerrajero Lógico)", "Momentum Maze (Laberinto de Momentum)", "Precision Point (Puntería de Precisión Híbrida)", "Code Breaker Dash (Carrera Rompecódigos)", "Grav-Ball (Pelota Gravitacional)", "Neural Net Navigation (Navegación por Red Neural)", "Titan Trials (Pruebas del Titán - Fuerza/Estrategia)", "Data Heist Relay (Relevo Robo de Datos)", "Resonance Rally (Rally de Resonancia)", "Chronos Course (Pista Cronos - Tiempo)", "Cryo-Circuit Challenge", "Plasma Pathway Pursuit", "Singularity Soccer (Fútbol Singularidad)", "Warp Wall Run",
            // Equipos Famosos (Ejemplos)
            "Neo-Kyoto Ronin", "Berlin Blackouts", "Mumbai Mechanauts", "Rio Grid Runners", "Silicon Sentinels (San Francisco)", "Cairo Cyber-Pharaohs", "London Logicians", "Moscow Maulers", "Seoul Synapses", "Johannesburg Juggernauts", "Zero-G Gladiators (Estación Orbital)", "Deep Blue Dynamics (Corporativo)", "Ares Arbiters (Marte Colony)", "Vulcan Vanguard (Corporativo)", "Titan Tech Titans", "Nomad Nexus (Itinerante)", "Crimson Calculators", "Emerald Enforcers", "Azure Assassins", "Obsidian Overlords",
            // Jugadores/Cyber-Atletas Notables (Humanos con Aumentos)
            "Jax 'Razor' Riley (Humano, Velocidad/Reflejos)", "Dr. Aris Thorne (Humano, Estratega/Cálculo)", "Lena 'Banshee' Petrova (Humana, Agilidad/Sónica)", "Kenji 'Oni' Tanaka (Humano, Fuerza/Combate)", "Samira 'Glitch' Khan (Humana, Hacker/Intrusión)", "Marcus 'Rhino' Johnson (Humano, Resistencia/Defensa)", "Isabelle 'Silke' Dubois (Humana, Precisión/Sigilo)", "Andrei 'Volt' Volkov (Humano, Energía/Manipulación)", "Carmen 'Nova' Rodriguez (Humana, Adaptabilidad)", "Ragnar 'Forge' Bjornsson (Humano, Ingeniería/Reparación)",
            // Modelos de Robot/IA Notables
            "Unidad 'Centurion' Mark VII (Robot, Fuerza Bruta/Defensa)", "Modelo 'Oracle' X (IA, Cálculo/Predicción)", "Serie 'Wraith' (Robot, Sigilo/Reconocimiento)", "Plataforma 'Golem' (Robot, Construcción/Obstáculos)", "Unidad 'Pathfinder' (Robot, Navegación/Logística)", "IA Táctica 'Athena' (Estratega Central)", "Modelo 'Chrono' (Robot, Manipulación Temporal Local)", "Serie 'Guardian' (Robot, Escolta/Protección)", "Unidad 'Catalyst' (Robot, Soporte/Energía)", "IA Creativa 'Muse' (Diseño/Innovación)",
            // Arenas y Sedes Icónicas
            "The Nexus Arena (Sede Central CSL)", "Zero-G Colosseum (Estación Orbital)", "Magma Core Stadium (Islandia)", "Sky-Spire Circuit (Ciudad Vertical)", "Bioluminescent Basin (Arena Submarina)", "Quantum Quandary Complex", "The Data Cathedral", "Kinetic Coliseum", "Synaptic Stadium", "Cryo-Chamber Arena",
            // Tecnología Clave
            "Implantes Neuronales de Aumento (Reflejos/Cálculo)", "Exoesqueletos de Potencia Clase Atleta", "Sistemas de IA Táctica en Tiempo Real", "Interfaz Cerebro-Máquina Directa (ICM)", "Generadores de Campo de Fuerza Personales", "Sistemas de Propulsión Gravitacional Personal", "Armamento No Letal Estandarizado (CSL)", "Materiales Adaptativos de Blindaje", "Red de Comunicación Cuántica de la Liga", "Drones Tácticos Autónomos (Observación/Interferencia)", "Sistemas de Realidad Aumentada Integrados (HUD)", "Tecnología de Clonación Rápida (Equipos de Entrenamiento)", "Nanobots de Reparación/Mejora Fisiológica", "Simuladores de Entrenamiento Neural Profundo", "Sistemas de Predicción de Trayectoria Avanzados",
            // Reglas y Conceptos
            "Protocolo de Sinergia Humano-Robot", "Sistema de Puntuación Híbrido (SPH)", "Regulación de Aumentos Cibernéticos", "Clasificación de Robots por Capacidad", "Código Ético de la IA en Competición", "Zonas de Cálculo Designadas", "Penalizaciones por Desincronización", "Formato del Campeonato Mundial CSL", "Ligas Regionales (NA-CSL, EU-CSL, ASIA-CSL)", "Transferencias de Jugadores y Unidades Robóticas", "Estrategias Comunes (Blitz Calc, Iron Wall, Phantom Flow)", "Controversia sobre la 'Conciencia Emergente' en IAs", "Historia de la Fundación de la CSL", "El 'Gran Colapso' y la Reforma de la Liga", "Rivalidades Históricas entre Equipos",
            // Roles Tácticos Comunes
            "El 'Anchor' (Humano/Robot Defensivo)", "El 'Striker' (Humano/Robot Ofensivo Rápido)", "El 'Tactician' (IA/Humano Estratega)", "El 'Scout' (Robot/Humano Reconocimiento)", "El 'Disruptor' (Robot/Humano Contramedidas)", "El 'Heavy' (Robot/Humano Fuerza Bruta)", "El 'Support' (Robot/Humano Asistencia)", "El 'Calculator' (IA/Humano Procesamiento)", "El 'Navigator' (Robot/Humano Trayectoria)", "El 'Engineer' (Robot/Humano Mantenimiento/Construcción)",
            // Más Disciplinas... (para variedad y 'Generar Más')
            "Zero-Sum Scramble", "Pattern Lock Pursuit", "Echo Chamber Challenge", "Force Field Football", "Synchro-Swim Tactics (Bajo Agua)", "Orbital Relay Race", "Geothermal Gauntlet", "Code Weaving Competition", "Bio-Bridge Building", "Psionic Puzzle Box", "Neutronium Lift Challenge", "Dark Matter Dodgeball (Conceptual)", "Temporal Target Practice", "Acoustic Maze Navigation", "Holographic Hunt", "Energy Conduit Control", "Subspace Sprint", "Matter Manipulation Match", "Logic Labyrinth", "Gridiron Gambit", "Quantum Quartets", "Tectonic Tower Takedown", "Fusion Freestyle", "Gravity Golf", "Neural Knot Untangling"
            // ... y así sucesivamente, intentando cubrir más combinaciones y conceptos.
        ];
        const leagueThemes = [ // Para generar más títulos
            "disciplinas híbridas CSL", "equipos CSL", "cyber-atletas famosos", "robots CSL notables", "arenas CSL", "tecnología de aumentos", "IA táctica", "reglas CSL", "estrategias CSL", "historia de la CSL", "campeonatos CSL", "roles de jugador CSL", "fuerza vs cálculo", "sinergia humano-robot", "deportes del futuro", "competición cibernética", "controversias CSL", "entrenamiento CSL"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un comentarista experto y analista de la 'Cybernetic Synergy League' (CSL), la liga premier donde humanos con aumentos y robots avanzados compiten juntos en disciplinas híbridas que requieren fuerza física y cálculo complejo. Proporciona un análisis detallado, vibrante y técnico del [deporte/equipo/jugador/tecnología/concepto CSL] solicitado. Cubre: concepto/reglas/historia, habilidades humano/robot necesarias, estrategias clave, ejemplos/récords notables, tecnología involucrada y su impacto/rol dentro de la CSL. Usa lenguaje deportivo/técnico apropiado para la liga. Extensión objetivo: 1200-1300 palabras. Enfócate estrictamente en el contexto CSL y el ítem: ",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // O 'mistral' si tiny es insuficiente
            systemPrompt: "Actúa como un asistente AI de los Archivos CSL, experto únicamente en '[CURRENT_ITEM_TITLE]' de la Cybernetic Synergy League. Responde preguntas concisas sobre sus detalles, reglas, historia o tecnología, basándote en la información principal. Mantente estrictamente en el tema.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Genera exactamente 40 nombres/conceptos diversos y emocionantes relacionados con la 'Cybernetic Synergy League' (CSL): deportes híbridos, equipos, jugadores (humanos/robots), tecnología, reglas, arenas, etc. Formato: un ítem por línea. Sin números, introducciones ni despedidas.",
            timeoutSeconds: 60 // Más tiempo para generar 40
        };
        // *** FRASES DE CARGA ***
        const loadingPhrases = [
            "Calculando vectores de sinergia...", "Optimizando interfaz neuronal...", "Calibrando actuadores robóticos...",
            "Cargando protocolos de la Liga...", "Estableciendo enlace cuántico...", "Analizando datos biométricos...",
            "Booting sistemas de IA táctica...", "Compilando estrategias de juego...", "Renderizando entorno de arena...",
            "Verificando registros CSL...", "Securizando conexión a los Archivos...", "Desfragmentando núcleos de memoria...",
            "Ajustando parámetros de gravedad artificial...", "Comprobando niveles de energía...", "Iniciando simulación de física...",
            "Cargando perfiles de cyber-atletas...", "Actualizando bases de datos de robots...", "Accediendo a archivos históricos...",
            "Pre-calculando trayectorias balísticas...", "Sincronizando relojes de competición...", "Validando firmas energéticas...",
            "Alineando campos de fuerza...", "Testeando sistemas de comunicación...", "Optimizando algoritmos de predicción...",
            "Desplegando drones de observación...", "Cargando texturas holográficas...", "Activando protocolos de seguridad...",
            "Analizando patrones de juego rivales...", "Revisando regulaciones de aumentos...", "Consultando código ético de IA...",
            "Estableciendo conexión con red CSL...", "Verificando integridad de datos...", "Optimizando flujo de información...",
            "Recalibrando sensores ópticos...", "Ajustando respuestas hápticas...", "Cargando modelos 3D de arena...",
            "Simulando condiciones atmosféricas...", "Comprobando protocolos anti-trampas...", "Accediando a registros de campeonatos...",
            "Preparando transmisión holográfica...", "Inicializando sistemas de puntuación...", "Cargando perfiles de equipos...",
            "Analizando estadísticas de rendimiento...", "Consultando historial de enfrentamientos...", "Verificando autorización de acceso...",
            "Descomprimiendo archivos de reglas...", "Optimizando latencia de red...", "Ajustando parámetros de IA asistente...",
            "Cargando efectos visuales de energía...", "Preparando sistemas de repetición instantánea...", "Validando especificaciones técnicas...",
            "Consultando archivos de leyendas CSL...", "Revisando protocolos de emergencia...", "Estableciendo prioridades tácticas...",
            "Ajustando sensibilidad de controles...", "Cargando módulos de idioma...", "Optimizando consumo energético...",
            "Verificando conexión de implantes...", "Analizando ancho de banda disponible...", "Preparando interfaz de usuario...",
            "Cargando shaders de partículas...", "Comprobando actualizaciones de firmware...", "Consultando predicciones meteorológicas...",
            "Estableciendo enlace seguro con servidores...", "Optimizando rutas de datos...", "Cargando perfiles de comentaristas...",
            "Ajustando niveles de audio...", "Verificando licencias de software...", "Preparando análisis post-partida...",
            "Cargando historial de transferencias...", "Analizando datos de mercado CSL...", "Consultando archivos de patrocinadores...",
            "Verificando compatibilidad de hardware...", "Optimizando algoritmos de aprendizaje...", "Preparando sesión de entrenamiento virtual...",
            "Cargando datos de terreno...", "Ajustando simulación de multitudes...", "Verificando protocolos de juego limpio...",
            "Consultando bases de datos médicas...", "Optimizando sistemas de refrigeración...", "Preparando informe técnico...",
            "Cargando logros y trofeos...", "Analizando posibles vulnerabilidades...", "Estableciendo protocolos de comunicación segura...",
            "Verificando estado de la red neuronal...", "Optimizando procesos en segundo plano...", "Cargando datos de clasificación...",
            "Ajustando parámetros de dificultad...", "Verificando firmas de ADN digital...", "¡Preparados para la sinergia!"
        ];

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales mayores)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalLoadingText = document.getElementById('loading-text'); // Para frases dinámicas
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentLeagueItemTitle = null; // Contexto Chat
        let loadingIntervalId = null; // Para el intervalo de frases

        // ========== API & UTILITY FUNCTIONS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        // *** FUNCIÓN PARA LIMPIAR TEXTO DE POLLINATIONS ***
        function cleanPollinationsPromo(text) {
            if (!text) return '';
            // Expresiones regulares para buscar patrones comunes al final.
            // Busca saltos de línea opcionales (\n*), seguido de frases comunes, y opcionalmente un enlace.
            const promoPatterns = [
                /\n*\s*---\n*Generated by Pollinations AI.*?$/is,
                /\n*\s*Let me know if you'd like me to.*?$/is,
                /\n*\s*I can also help you with.*?$/is,
                /\n*\s*Feel free to ask.*?$/is,
                /\n*\s*Powered by Pollinations\.ai.*?$/is,
                /\n*\s*\[.*?pollinations\.ai.*?\]\(.*?pollinations\.ai.*?\).*?$/is // Enlaces markdown
            ];
            let cleanedText = text;
            promoPatterns.forEach(pattern => {
                cleanedText = cleanedText.replace(pattern, '');
            });
            // Quita espacios en blanco sobrantes al final
            return cleanedText.trim();
        }

        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentLeagueItemTitle
                ? `Actúa como un asistente AI de los Archivos CSL, experto únicamente en '${currentLeagueItemTitle}'. Responde preguntas concisas sobre sus detalles, reglas, historia o tecnología, basándote en la información principal. Mantente estrictamente en el tema.`
                : config.systemPrompt + (isChat ? '' : prompt); // Añadir el prompt al system prompt para descripciones principales

            const encodedSystem = encodeURIComponent(systemPromptToUse);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            // *** PARA DESCRIPCIONES, EL PROMPT VA EN EL SYSTEM, NO EN LA URL ***
            const url = `https://text.pollinations.ai/${isChat ? encodedPrompt : 'generate'}?${params.toString()}`; // Usar 'generate' si el prompt está en system

            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                // *** PARA DESCRIPCIONES, AHORA ES POST PORQUE EL PROMPT VA EN SYSTEM Y PUEDE SER LARGO ***
                // La API de text.pollinations ahora soporta POST para prompts largos en system
                // const response = await fetch(url, { signal: controller.signal }); // GET original
                 const response = await fetch(url, {
                     method: 'GET', // Mantener GET si funciona, o probar POST si da error 414 (URI too long)
                     signal: controller.signal
                     // Si se necesita POST:
                     // method: 'POST',
                     // headers: { 'Content-Type': 'application/json' },
                     // body: JSON.stringify({ prompt: isChat ? prompt : '' }) // Prompt en body si es POST
                 });

                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(${response.status}) Los servidores CSL están bajo carga pesada. Intenta en unos momentos.`);
                }
                const rawText = await response.text();
                if (!rawText || rawText.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta reformular.");
                }
                console.log(`API Response received (${rawText.length} chars)`);
                // *** LIMPIAR PROMO AQUÍ ***
                return cleanPollinationsPromo(rawText);
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`Conexión CSL inestable (>${config.timeoutSeconds}s). Reintentando enlace...`);
                }
                throw new Error(error.message || "Error de comunicación desconocido con los Archivos CSL.");
            }
        }
        async function fetchExplanationText(itemTitle) {
            return fetchTextFromApi(itemTitle, textApiConfig, false); // false = no es chat
        }
        async function fetchChatResponse(userQuery) {
            if (!currentLeagueItemTitle) throw new Error("Error interno: Contexto CSL no establecido para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true); // true = es chat
        }
        async function fetchGeneratedTitles() { // *** PIDE 40 TÍTULOS ***
            const randomTheme = getRandomElement(leagueThemes) || "conceptos generales CSL";
            const specificPrompt = `Genera 40 ítems sobre ${randomTheme}`; // Prompt ya está en la config
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false) // Pasa el prompt aquí si se usa GET
                 .then(text => {
                     const titles = text.split('\n')
                                      .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                      .filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 20) throw new Error("La IA no generó suficientes registros nuevos."); // Umbral más bajo por si acaso
                     return titles.slice(0, 40); // Devuelve hasta 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Cybernetic Synergy League action";
             const enhancedPrompt = `Dynamic action scene or concept art for '${safePromptText}' from the Cybernetic Synergy League (CSL). Show humans with cybernetics and robots competing/collaborating in a futuristic sports arena. Focus on energy, movement, hybrid human-robot synergy, calculations visualized. Style: eSports illustration, cinematic, vibrant colors (${getRandomElement(['electric blue', 'energetic orange', 'vibrant purple'])}, neon accents). Avoid text/logos.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, label, title, caption, logo, watermark, signature, diagram, chart, graph, menu, button, multiple panels, collage, simple background, blurry, low quality, deformed figures, photorealistic";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim(); // Ya debería estar limpia de promo
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL & LOADING PHRASES FUNCTIONS ==========
        function startLoadingPhrases() {
            if (loadingIntervalId) clearInterval(loadingIntervalId); // Clear previous if any
            modalLoadingText.style.opacity = 1; // Make sure it's visible
            loadingIntervalId = setInterval(() => {
                 modalLoadingText.textContent = getRandomElement(loadingPhrases);
            }, 1800); // Change phrase every 1.8 seconds
        }
        function stopLoadingPhrases() {
             if (loadingIntervalId) {
                 clearInterval(loadingIntervalId);
                 loadingIntervalId = null;
             }
             // Optionally reset text after a short delay to avoid abrupt change
             setTimeout(() => {
                 if (!loadingIntervalId) { // Check if it wasn't restarted immediately
                      modalLoadingText.textContent = "Procesando datos..."; // Reset default
                      modalLoadingText.style.opacity = 0; // Hide smoothly
                 }
             }, 300);
        }
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            resetModalState(); // This should also stop loading phrases
        }
        function resetModalState() {
             stopLoadingPhrases(); // *** STOP LOADING PHRASES ***
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentLeagueItemTitle = null;
             hideFullscreenImage();
             modalLoadingText.textContent = "Iniciando enlace de datos..."; // Reset initial loading text
             modalLoadingText.style.opacity = 1; // Make sure it's visible for next load
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden'; }
        function hideFullscreenImage() { /* ... */ if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src=''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... */ const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Error IA: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();} }

        // ========== UI & EVENT HANDLERS ==========
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... */ if(!titleListContainer||!titlesLoading)return;const sortedTitles=titles.sort((a,b)=>a.localeCompare(b));titleListContainer.innerHTML='';titlesLoading.style.display='none';if(sortedTitles.length===0){titleListContainer.innerHTML='<p class="text-gray-400 col-span-full text-center font-sans">» No hay registros CSL disponibles «</p>';return;}sortedTitles.forEach(title=>titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { /* ... */ if(!titleListContainer||!newTitles||newTitles.length===0)return;const existingTitles=new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item=>item.dataset.title));newTitles.forEach(title=>{if(!existingTitles.has(title)){titleListContainer.appendChild(createTitleItem(title));}});filterTitles(searchInput.value); }

        // *** MODIFIED: handleTitleClick to use loading phrases ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentLeagueItemTitle = title;
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';
            startLoadingPhrases(); // *** START LOADING PHRASES ***

            try {
                const explanationText = await fetchExplanationText(title); // Fetches and cleans promo
                const formattedExplanation = formatExplanationText(explanationText);

                stopLoadingPhrases(); // *** STOP PHRASES on success before showing content ***
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;

                // Image Handling (same logic, after text is set)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Generando visualización CSL...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización CSL de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display='block'; imgElement.addEventListener('click',()=>{showFullscreenImage(imgElement.src);}); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if(imageUrl){ imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                stopLoadingPhrases(); // *** STOP PHRASES on error ***
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar datos CSL.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 items ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Accediendo Archivos Extendidos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron recuperar más registros CSL en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al acceder a registros extendidos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Cargar Más Registros (40)';
             }
         }

         // *** Search Filter Function (sin cambios) ***
         function filterTitles(searchTerm) { /* ... */ const term=searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();const titleItems=titleListContainer.querySelectorAll('.title-item');let visibleCount=0;titleItems.forEach(item=>{const titleText=item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");const isVisible=titleText.includes(term);item.classList.toggle('hidden',!isVisible);if(isVisible)visibleCount++;});noResultsMsg.classList.toggle('hidden',visibleCount>0); }

        // ========== INITIALIZATION ==========
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalLoadingText) {
                 console.error("Initialization failed: Missing essential CSL interface components.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">++ ERROR CRÍTICO: Fallo al cargar interfaz CSL ++</p>';
                 return;
             }
            // Listeners (Modal, Generate More, Search, Chat, Fullscreen) - Sin cambios
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>