<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batallas Legendarias - Crónicas de la Historia</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Clásicas/Históricas -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Batallas Legendarias --- */
        :root {
            --color-primary: #8b0000; /* Rojo Oscuro (Sangre/Valor) */
            --color-secondary: #daa520; /* Dorado (Gloria/Importancia) */
            --color-tertiary: #5a4d41; /* Marrón Tierra (Terreno/Antigüedad) */
            --color-background: #fdf6e3; /* Crema/Pergamino Claro */
            --color-text: #4f4f4f; /* Gris Oscuro/Casi Negro (Lectura) */
            --color-text-muted: #8c7d70; /* Marrón Grisáceo (Menos énfasis) */
            --color-modal-bg: #faf0e6; /* Lino/Pergamino más oscuro */
            --color-border: #d3c5b4; /* Borde tipo pergamino */
            --color-error-bg: #fde8e8; /* Fondo error rojo pálido */
            --color-error-text: #8b0000; /* Texto error rojo oscuro */
            --color-error-border: #fca5a5; /* Borde error rojo claro */

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); /* text-shadow: 1px 1px 2px rgba(0,0,0,0.1); */ }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(253, 246, 227, 0.85); /* Pergamino semi-transparente */ backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(250, 240, 230, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Merriweather'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-secondary); box-shadow: 0 0 0 3px rgba(218, 165, 32, 0.2); outline: none; background-color: #fffaf0; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Merriweather'; font-size: 1rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-primary); background-color: #fffaf0; /* Floral White on hover */ border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-md); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; text-shadow: none;}
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(90, 77, 65, 0.9); /* Overlay marrón */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); box-shadow: 0 0 8px var(--color-primary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(211, 197, 180, 0.5); /* Scrollbar rojo/pergamino */
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(211, 197, 180, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 400; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-secondary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(140, 125, 112, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; } /* Icono Historia */

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(253, 246, 227, 0.6); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(211, 197, 180, 0.5); /* Scrollbar dorado/pergamino */
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(211, 197, 180, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--color-secondary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400; box-shadow: var(--shadow-sm); }
        .ai-message { background-color: var(--color-tertiary); color: var(--color-background); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #fffaf0; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Merriweather'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #a52a2a; /* Brown */ }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { /* Mismos estilos que antes, ajustar colores */ text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(253, 246, 227, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-primary); font-size: 1.4rem; font-family: 'Cinzel'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Merriweather'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-text); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(40, 40, 40, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-secondary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-modal-bg); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-shield-alt mr-3 text-red-800"></i> <!-- Icono escudo -->
                     Batallas Legendarias
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-serif tracking-wider">~ Crónicas de la Historia ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Ecos del Campo de Batalla</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora los enfrentamientos que forjaron imperios, decidieron guerras y cambiaron el curso de la historia. Selecciona una batalla o busca por protagonista o época.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar batalla, comandante, año...">
             <i class="fas fa-scroll fa-search"></i> <!-- Icono pergamino/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-landmark text-yellow-600 mr-2"></i> <!-- Icono hito histórico -->
                 Índice de Conflictos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-serif">Consultando los archivos históricos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-serif">~ Ningún registro coincide con la consulta ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Batallas
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Reconstruyendo los Hechos...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando al estratega...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta batalla...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-700 py-6 mt-12 border-t border-gray-300 font-serif">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Relatos históricos generados por IA con fines educativos y de referencia.</p>
              <p class="mt-1">Verifica siempre fechas y detalles específicos con fuentes académicas.</p>
              <p class="mt-2">© <span id="footer-year"></span> Crónicas de Batallas</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Antigüedad Clásica (Grecia y Persia)
            "Batalla de Maratón (490 a.C.)", "Batalla de las Termópilas (480 a.C.)", "Batalla de Salamina (480 a.C.)", "Batalla de Platea (479 a.C.)", "Batalla de Leuctra (371 a.C.)", "Batalla de Mantinea (362 a.C.)", "Batalla del Gránico (334 a.C.)", "Batalla de Issos (333 a.C.)", "Batalla de Gaugamela (331 a.C.)", "Batalla del Hidaspes (326 a.C.)", "Batalla de Ipsos (301 a.C.)", "Batalla de Cinoscéfalos (197 a.C.)", "Batalla de Magnesia (190 a.C.)", "Batalla de Pidna (168 a.C.)", "Sitio de Siracusa (214-212 a.C.)",
            // Antigüedad Clásica (Roma)
            "Batalla del Lago Regilo (c. 496 a.C.)", "Batalla de las Horcas Caudinas (321 a.C.)", "Batalla de Sentino (295 a.C.)", "Batalla de Heraclea (280 a.C.)", "Batalla de Ásculo (279 a.C.)", "Batalla de Benevento (275 a.C.)", "Batalla de Milas (260 a.C.)", "Batalla de Trípoli (255 a.C.)", "Batalla del Trebia (218 a.C.)", "Batalla del Lago Trasimeno (217 a.C.)", "Batalla de Cannas (216 a.C.)", "Batalla de Zama (202 a.C.)", "Batalla de Vercelae (101 a.C.)", "Batalla de Aquae Sextiae (102 a.C.)", "Batalla de Farsalia (48 a.C.)", "Batalla de Filipos (42 a.C.)", "Batalla de Actium (31 a.C.)", "Batalla del Bosque de Teutoburgo (9 d.C.)", "Batalla de Watling Street (60/61 d.C.)", "Sitio de Masada (73-74 d.C.)", "Batalla de los Campos Cataláunicos (451 d.C.)", "Saqueo de Roma (410 d.C.)", "Saqueo de Roma (455 d.C.)", "Batalla de Adrianópolis (378 d.C.)", "Batalla del Puente Milvio (312 d.C.)", "Batalla de Alesia (52 a.C.)", "Batalla de Carrhae (53 a.C.)",
            // Edad Media (Europa)
            "Batalla de Hastings (1066)", "Batalla de Manzikert (1071)", "Batalla de Dirraquio (1081)", "Primera Cruzada: Sitio de Nicea (1097)", "Primera Cruzada: Batalla de Dorilea (1097)", "Primera Cruzada: Sitio de Antioquía (1097-1098)", "Primera Cruzada: Sitio de Jerusalén (1099)", "Batalla de Tinchebray (1106)", "Batalla de Hattin (1187)", "Tercera Cruzada: Sitio de Acre (1189-1191)", "Tercera Cruzada: Batalla de Arsuf (1191)", "Batalla de Las Navas de Tolosa (1212)", "Batalla de Bouvines (1214)", "Batalla del Lago Peipus (Batalla sobre el Hielo) (1242)", "Batalla de Legnica (1241)", "Batalla de Mohi (1241)", "Batalla de Ain Yalut (1260)", "Batalla de Bannockburn (1314)", "Batalla de Crécy (1346)", "Batalla de Poitiers (1356)", "Batalla de Agincourt (1415)", "Sitio de Orleans (1428-1429)", "Batalla de Castillon (1453)", "Caída de Constantinopla (1453)", "Batalla de Grunwald (1410)", "Batalla de Varna (1444)", "Batalla de Kosovo (1389)", "Batalla de Nicópolis (1396)", "Batalla de Cortenuova (1237)", "Batalla de Marchfeld (1278)", "Batalla de los Espuelas de Oro (1302)", "Batalla de Sluys (1340)", "Guerra de las Dos Rosas: Batalla de St Albans (1455)", "Guerra de las Dos Rosas: Batalla de Towton (1461)", "Guerra de las Dos Rosas: Batalla de Bosworth Field (1485)",
            // Edad Media y Moderna Temprana (Asia y África)
            "Batalla de Talas (751)", "Batalla de Angora (Ankara) (1402)", "Batalla de Chaldiran (1514)", "Batalla de Panipat (1526)", "Batalla de Mohács (1526)", "Sitio de Viena (1529)", "Batalla de Lepanto (1571)", "Batalla de Sekigahara (1600)", "Sitio de Osaka (1614-1615)", "Batalla de Kawanakajima (Varias, ej. 1561)", "Batalla de Nagashino (1575)", "Batalla de Plassey (1757)", "Batalla de Adwa (1896)", "Batalla de Omdurman (1898)", "Invasiones Mongolas de Japón (1274, 1281)", "Batalla de Bạch Đằng (1288)", "Segunda Batalla de Panipat (1556)", "Tercera Batalla de Panipat (1761)",
            // Edad Moderna
            "Batalla de Pavía (1525)", "Gran Sitio de Malta (1565)", "Derrota de la Armada Invencible (1588)", "Batalla de la Montaña Blanca (1620)", "Batalla de Lützen (1632)", "Batalla de Nördlingen (1634)", "Batalla de Rocroi (1643)", "Batalla de Naseby (1645)", "Batalla del Boyne (1690)", "Batalla de Blenheim (1704)", "Batalla de Poltava (1709)", "Batalla de Fontenoy (1745)", "Batalla de Culloden (1746)", "Batalla de Quebec (Llanuras de Abraham) (1759)", "Batalla de Lexington y Concord (1775)", "Batalla de Bunker Hill (1775)", "Batalla de Trenton (1776)", "Batalla de Saratoga (1777)", "Sitio de Yorktown (1781)", "Batalla de Valmy (1792)",
            // Guerras Napoleónicas
            "Batalla de Tolón (1793)", "Batalla de las Pirámides (1798)", "Batalla de Marengo (1800)", "Batalla de Trafalgar (1805)", "Batalla de Austerlitz (1805)", "Batalla de Jena-Auerstedt (1806)", "Batalla de Eylau (1807)", "Batalla de Friedland (1807)", "Batalla de Bailén (1808)", "Batalla de Wagram (1809)", "Batalla de Borodino (1812)", "Batalla de Leipzig (Batalla de las Naciones) (1813)", "Batalla de Waterloo (1815)",
            // Siglo XIX
            "Batalla de Ayacucho (1824)", "Batalla de Navarino (1827)", "Batalla de El Álamo (1836)", "Batalla de San Jacinto (1836)", "Batalla de Balaclava (1854)", "Batalla de Solferino (1859)", "Guerra Civil EEUU: Batalla de Fort Sumter (1861)", "Guerra Civil EEUU: Primera Batalla de Bull Run (Manassas) (1861)", "Guerra Civil EEUU: Batalla de Shiloh (1862)", "Guerra Civil EEUU: Batalla de Antietam (1862)", "Guerra Civil EEUU: Batalla de Fredericksburg (1862)", "Guerra Civil EEUU: Batalla de Chancellorsville (1863)", "Guerra Civil EEUU: Batalla de Gettysburg (1863)", "Guerra Civil EEUU: Sitio de Vicksburg (1863)", "Guerra Civil EEUU: Batalla de Cold Harbor (1864)", "Guerra Civil EEUU: Batalla de Appomattox Court House (1865)", "Batalla de Sadowa (Königgrätz) (1866)", "Batalla de Sedán (1870)", "Batalla de Isandlwana (1879)", "Batalla de Rorke's Drift (1879)",
            // Guerras Mundiales y Siglo XX
            "Batalla de Tsushima (1905)", "Primera Guerra Mundial: Batalla de Tannenberg (1914)", "Primera Guerra Mundial: Primera Batalla del Marne (1914)", "Primera Guerra Mundial: Batalla de Galípoli (1915-1916)", "Primera Guerra Mundial: Batalla de Verdún (1916)", "Primera Guerra Mundial: Batalla del Somme (1916)", "Primera Guerra Mundial: Batalla de Jutlandia (1916)", "Primera Guerra Mundial: Batalla de Passchendaele (Tercera de Ypres) (1917)", "Primera Guerra Mundial: Ofensiva de Primavera (Kaiserschlacht) (1918)", "Primera Guerra Mundial: Segunda Batalla del Marne (1918)", "Primera Guerra Mundial: Ofensiva de los Cien Días (1918)", "Guerra Civil Rusa: Batalla de Tsaritsyn (Stalingrado) (1918-1919)", "Segunda Guerra Mundial: Invasión de Polonia (1939)", "Segunda Guerra Mundial: Batalla de Francia (1940)", "Segunda Guerra Mundial: Batalla de Inglaterra (1940)", "Segunda Guerra Mundial: Batalla de Moscú (1941-1942)", "Segunda Guerra Mundial: Ataque a Pearl Harbor (1941)", "Segunda Guerra Mundial: Batalla de Singapur (1942)", "Segunda Guerra Mundial: Batalla del Mar del Coral (1942)", "Segunda Guerra Mundial: Batalla de Midway (1942)", "Segunda Guerra Mundial: Batalla de Stalingrado (1942-1943)", "Segunda Guerra Mundial: Batalla de El Alamein (Segunda) (1942)", "Segunda Guerra Mundial: Batalla de Guadalcanal (1942-1943)", "Segunda Guerra Mundial: Batalla de Kursk (1943)", "Segunda Guerra Mundial: Desembarco de Normandía (Día D) (1944)", "Segunda Guerra Mundial: Batalla de las Ardenas (1944-1945)", "Segunda Guerra Mundial: Batalla de Iwo Jima (1945)", "Segunda Guerra Mundial: Batalla de Okinawa (1945)", "Segunda Guerra Mundial: Batalla de Berlín (1945)", "Guerra de Corea: Batalla del Embalse de Chosin (1950)", "Guerra de Vietnam: Batalla de Dien Bien Phu (1954)", "Guerra de Vietnam: Ofensiva del Tet (1968)", "Guerra de los Seis Días (1967)", "Guerra de Yom Kipur (1973)", "Guerra de las Malvinas (1982)", "Guerra del Golfo: Batalla de 73 Easting (1991)",
             // Añadir más batallas clave de América Latina, África subsahariana, etc.
             // ... (Intentando llegar a 400)
        ];
        const historicalBattleThemes = [
            "Batallas de la Antigua Grecia", "Guerras Púnicas", "Conquistas de Alejandro Magno", "Guerras Civiles Romanas", "Caída del Imperio Romano", "Invasiones Vikingas", "Las Cruzadas", "Guerra de los Cien Años", "Conquista Mongola", "Reconquista Española", "Guerra de las Dos Rosas", "Guerras de Religión en Europa", "Guerra de los Treinta Años", "Guerras Napoleónicas", "Guerra de Independencia de EEUU", "Guerra Civil Estadounidense", "Guerras de Independencia Hispanoamericanas", "Primera Guerra Mundial Frente Occidental", "Primera Guerra Mundial Frente Oriental", "Segunda Guerra Mundial Teatro Europeo", "Segunda Guerra Mundial Teatro del Pacífico", "Guerra Fría (Conflictos Proxy)", "Batallas Navales Famosas", "Grandes Asedios de la Historia", "Batallas Decisivas de la Edad Media", "Conflictos en Asia Oriental", "Guerras en el Medio Oriente"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un historiador militar erudito y objetivo. Tu tarea es narrar la batalla histórica indicada de forma detallada y atractiva. Incluye: Contexto histórico (causas, guerra en curso), Fecha y ubicación precisa, Comandantes principales de cada bando, Fuerzas involucradas (estimaciones de número y tipo de tropas/unidades), Desarrollo de la batalla (fases clave, maniobras importantes, momentos decisivos), Resultado inmediato (quién ganó, bajas estimadas), y Significado histórico a largo plazo (consecuencias políticas, militares, sociales). Utiliza un lenguaje claro, formal y preciso. Evita juicios de valor excesivos. El objetivo es un relato completo de aproximadamente 1200-1300 palabras. Basa tu narración únicamente en la siguiente batalla:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente de historiador especializado únicamente en la batalla que se está mostrando. Responde preguntas de seguimiento sobre sus comandantes, tácticas, consecuencias, o detalles mencionados en la narración principal. Sé conciso y relevante al tema específico de esta batalla.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia histórica. Genera exactamente 15 nombres de batallas históricas significativas, grandes asedios o campañas militares relevantes de distintas épocas y regiones. Devuelve *solo* la lista de nombres/eventos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Footer Year
        const footerYear = document.getElementById('footer-year');

        // ========== State Variables ==========
        let currentBattleTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             // Dynamic system prompt for chat
             const systemPromptToUse = isChat && currentBattleTitle
                 ? `Eres un asistente de historiador especializado únicamente en la Batalla de ${currentBattleTitle}. Responde preguntas de seguimiento sobre sus comandantes, tácticas, consecuencias, o detalles mencionados en la narración principal. Sé conciso y relevante.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     // User-friendly error message
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento. Por favor, intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o selecciona otro tema.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar los archivos históricos.");
             }
        }
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentBattleTitle) throw new Error("Error interno: No se ha establecido el contexto de la batalla para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(historicalBattleThemes) || "batallas históricas importantes";
            const specificPrompt = `Genera 15 nombres de batallas, asedios o campañas militares sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de batallas.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 550, nologo: true }; // Slightly wider aspect ratio maybe
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "historic battle scene concept";
             // Prompt focuses on atmosphere, avoiding specifics that AI gets wrong
             const enhancedPrompt = `Atmospheric concept art representing the Battle of ${safePromptText}. Epic historical mood, dynamic composition, landscape, weather effects (smoke, dust, rain if applicable), dramatic lighting. Focus on the feeling and scale, silhouettes or stylized figures rather than specific uniforms or faces. Oil painting style or matte painting style.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, close-up faces, specific flags unless abstract, gore, modern elements";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, ' ');
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
          }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentBattleTitle = null; // Limpia contexto
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ==========
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error del asistente: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Sort maybe by year if possible, otherwise alphabetically
             const sortedTitles = titles.sort((a, b) => {
                const yearA = a.match(/\((\d{1,4}(?:-\d{1,4})?\s*(?:a\.C\.|d\.C\.)?)\)/);
                const yearB = b.match(/\((\d{1,4}(?:-\d{1,4})?\s*(?:a\.C\.|d\.C\.)?)\)/);
                if (yearA && yearB) {
                     // Basic sorting logic (needs improvement for ranges and BC/AD)
                     let numA = parseInt(yearA[1].replace(/[^0-9-]/g, ''));
                     let numB = parseInt(yearB[1].replace(/[^0-9-]/g, ''));
                     if (yearA[1].includes('a.C.')) numA = -numA;
                     if (yearB[1].includes('a.C.')) numB = -numB;
                     return numA - numB;
                }
                return a.localeCompare(b); // Fallback to alpha sort
             });

             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-serif">~ No hay registros históricos disponibles ~</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentBattleTitle = title.split('(')[0].trim(); // Set chat context (name before year)
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-scroll placeholder-icon"></i> <!-- Icono pergamino/historia -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando representación visual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación conceptual de la Batalla de ${currentBattleTitle}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(currentBattleTitle); // Use just the name for image prompt
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la crónica.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando en los anales...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se encontraron más registros notables en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al consultar los archivos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Batallas';
             }
         }

         // *** Search Filter Function (Added normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); // Normalize accents
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 // Include commander names or years in search if possible (more complex)
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !footerYear) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #8b0000; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: serif;">Error Catastrófico: Los archivos históricos están corruptos. No se pueden cargar los componentes.</p>';
                return;
             }
            // Set Footer Year
            footerYear.textContent = new Date().getFullYear();
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>