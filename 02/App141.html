<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historias de Éxito - Biblioteca Inspiradora</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y profesionales -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Historias de Éxito --- */
        :root {
            --color-primary: #2563eb; /* Azul Corporativo Intenso */
            --color-secondary: #f59e0b; /* Dorado/Ámbar para acentos */
            --color-tertiary: #10b981; /* Verde Esmeralda (Crecimiento) */
            --color-background: #f9fafb; /* Blanco Hueso / Gris muy claro */
            --color-text: #1f2937; /* Gris Oscuro Casi Negro */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro para Modal */
            --color-border: #e5e7eb; /* Borde Gris Claro */
            --color-error-bg: #fff1f2; /* Fondo error rosa pálido */
            --color-error-text: #be123c; /* Texto error rojo oscuro */
            --color-error-border: #fecdd3; /* Borde error rosa */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Montserrat', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Poppins'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alinear a la izquierda para nombres largos */ font-weight: 500; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Poppins'; font-size: 0.95rem; }
        .title-item i { margin-right: 0.7rem; color: var(--color-primary); width: 1.1em; text-align: center; } /* Icono opcional en cada item */
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #eff6ff; /* Azul muy claro hover */ }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-tertiary)); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Montserrat', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; text-shadow: none; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-tertiary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-text-muted); color: #e5e7eb; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); /* Overlay Gris Oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Montserrat', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(229, 231, 235, 0.8); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary); } /* Icono dorado */

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 1rem; border-radius: 15px; /* Más redondeado */ max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; border-bottom-right-radius: 3px; text-align: left; }
        .ai-message { background-color: #e5e7eb; color: var(--color-text); margin-right: auto; border-bottom-left-radius: 3px; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: 20px; /* Input redondeado */ font-family: 'Poppins'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-primary); color: white; border: none; border-radius: 20px; cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #1d4ed8; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 500; color: var(--color-text); font-size: 1.3rem; font-family: 'Montserrat'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Poppins'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-text); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-secondary); box-shadow: var(--shadow-lg); border-radius: var(--border-radius); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-trophy mr-3 text-yellow-500"></i> <!-- Icono Trofeo -->
                     Historias de Éxito
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Biblioteca Inspiradora «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Descubre Caminos al Triunfo</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora las jornadas de individuos, empresas e ideas que transformaron el mundo. Aprende de sus desafíos y logros.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar persona, empresa o concepto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-600 mr-2"></i> <!-- Icono Libro Abierto -->
                 Índice de Historias
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Accediendo al archivo de historias...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron historias para tu búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Solicitar Nuevas Historias
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Procesando Historia...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                      <p class="text-sm font-semibold text-gray-600 mb-2 text-center font-montserrat">Consulta sobre esta historia:</p>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Analizando consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Ej: ¿Cuál fue su mayor desafío?">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias generadas por IA con fines educativos e inspiradores.</p>
              <p class="mt-1">La información debe ser verificada para decisiones importantes.</p>
              <p class="mt-2">© 2025 Biblioteca Inspiradora</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Emprendedores y Negocios (Personas)
            "Steve Jobs (Apple)", "Bill Gates (Microsoft)", "Jeff Bezos (Amazon)", "Elon Musk (Tesla, SpaceX)", "Mark Zuckerberg (Meta/Facebook)", "Larry Page y Sergey Brin (Google/Alphabet)", "Oprah Winfrey (Harpo Productions)", "Walt Disney (The Walt Disney Company)", "Henry Ford (Ford Motor Company)", "Thomas Edison (General Electric)", "Warren Buffett (Berkshire Hathaway)", "Richard Branson (Virgin Group)", "Howard Schultz (Starbucks)", "Sam Walton (Walmart)", "Jack Ma (Alibaba)", "Sara Blakely (Spanx)", "Reed Hastings (Netflix)", "Phil Knight (Nike)", "Michael Dell (Dell Technologies)", "Larry Ellison (Oracle)", "Indra Nooyi (PepsiCo)", "Mary Barra (General Motors)", "Satya Nadella (Microsoft CEO)", "Sundar Pichai (Alphabet/Google CEO)", "Tim Cook (Apple CEO)", "Coco Chanel (Chanel)", "Estée Lauder (Estée Lauder Companies)", "Ray Kroc (McDonald's expansión)", "Soichiro Honda (Honda)", "Akio Morita (Sony)", "Masayoshi Son (SoftBank)", "Carlos Slim (América Móvil)", "Amancio Ortega (Inditex/Zara)", "Bernard Arnault (LVMH)", "Mukesh Ambani (Reliance Industries)", "Madam C.J. Walker (Cosméticos)", "J.K. Rowling (Harry Potter)", "George Lucas (Lucasfilm)", "Steven Spielberg (Director/Productor)", "Arianna Huffington (HuffPost/Thrive Global)", "Reid Hoffman (LinkedIn)", "Brian Chesky (Airbnb)", "Travis Kalanick (Uber - Inicio)", "Daniel Ek (Spotify)", "Jan Koum y Brian Acton (WhatsApp)", "Kevin Systrom y Mike Krieger (Instagram)", "Ben Silbermann (Pinterest)", "Jack Dorsey (Twitter/Square)", "Fred Smith (FedEx)", "Jeff Immelt (General Electric - Transición)", "Meg Whitman (eBay/HP)", "Sheryl Sandberg (Facebook COO/Lean In)", "Ginni Rometty (IBM)", "Marissa Mayer (Yahoo - Intento de turnaround)", "Martha Stewart (Living Omnimedia)", "Tony Hsieh (Zappos)", "Nick Woodman (GoPro)", "Howard Hughes (Aviación/Cine/Negocios)", "John D. Rockefeller (Standard Oil)", "Andrew Carnegie (Carnegie Steel)", "Cornelius Vanderbilt (Ferrocarriles/Transporte)", "J.P. Morgan (Finanzas)", "Milton Hershey (Hershey's Chocolate)", "Debbi Fields (Mrs. Fields Cookies)", "Colonel Sanders (KFC)", "Anita Roddick (The Body Shop)", "Ingvar Kamprad (IKEA)", "James Dyson (Dyson)", "Michael Bloomberg (Bloomberg L.P.)", "Pierre Omidyar (eBay)",
            // Compañías y Marcas
            "La Historia de Apple", "La Historia de Microsoft", "La Historia de Google", "La Historia de Amazon", "La Historia de Meta (Facebook)", "La Historia de Netflix", "La Historia de Tesla", "La Historia de SpaceX", "La Historia de Disney", "La Historia de Coca-Cola", "La Historia de Nike", "La Historia de Starbucks", "La Historia de McDonald's", "La Historia de Ford", "La Historia de Toyota", "La Historia de Samsung", "La Historia de Sony", "La Historia de IBM", "La Historia de Intel", "La Historia de Procter & Gamble", "La Historia de Johnson & Johnson", "La Historia de LEGO", "La Historia de IKEA", "La Historia de Zara (Inditex)", "La Historia de LVMH", "La Historia de Berkshire Hathaway", "La Historia de Goldman Sachs", "La Historia de Pixar", "La Historia de Adobe", "La Historia de Salesforce", "La Historia de Oracle", "La Historia de Cisco", "La Historia de Airbnb", "La Historia de Uber", "La Historia de Spotify", "La Historia de WhatsApp", "La Historia de Instagram", "La Historia de Twitter", "La Historia de LinkedIn", "La Historia de FedEx", "La Historia de UPS", "La Historia de Boeing", "La Historia de Airbus", "La Historia de General Electric (GE)", "La Historia de Siemens", "La Historia de Nestlé", "La Historia de Unilever", "La Historia de Mars, Incorporated", "La Historia de 3M", "La Historia de BMW", "La Historia de Mercedes-Benz", "La Historia de Volkswagen", "La Historia de Honda", "La Historia de Canon", "La Historia de Nikon", "La Historia de Nintendo", "La Historia de PayPal", "La Historia de Visa", "La Historia de Mastercard", "La Historia de American Express", "La Historia de The New York Times", "La Historia de BBC", "La Historia de CNN", "La Historia de National Geographic", "La Historia de Khan Academy", "La Historia de Wikipedia", "La Historia de Linux (Open Source)", "La Historia de Android", "La Historia del iPhone", "El Ascenso de Silicon Valley", "La Revolución del E-commerce", "La Transformación Digital", "El Impacto de la Inteligencia Artificial (Empresas Pioneras)", "El Desarrollo de la Biotecnología (Empresas Clave)", "La Industria de los Videojuegos", "El Fenómeno de las Redes Sociales",
            // Ciencia e Innovación
            "Albert Einstein (Teoría de la Relatividad)", "Marie Curie (Radioactividad, Premios Nobel)", "Isaac Newton (Leyes del Movimiento, Cálculo)", "Charles Darwin (Teoría de la Evolución)", "Nikola Tesla (Corriente Alterna, Invenciones)", "Galileo Galilei (Astronomía, Método Científico)", "Louis Pasteur (Pasteurización, Vacunas)", "Alexander Fleming (Penicilina)", "Jonas Salk (Vacuna contra la Polio)", "Rosalind Franklin (Estructura del ADN)", "James Watson y Francis Crick (Modelo del ADN)", "Stephen Hawking (Cosmología, Agujeros Negros)", "Alan Turing (Computación, Código Enigma)", "Tim Berners-Lee (World Wide Web)", "Grace Hopper (Programación, COBOL)", "Carl Sagan (Divulgación Científica, Cosmos)", "Rachel Carson (Primavera Silenciosa, Ecologismo)", "Jane Goodall (Primatología, Conservación)", "Gregor Mendel (Genética)", "Max Planck (Teoría Cuántica)", "Niels Bohr (Modelo Atómico)", "Leonardo da Vinci (Polímata: Arte y Ciencia)", "Arquímedes (Matemáticas, Física)", "Hipatia de Alejandría (Filosofía, Matemáticas)", "Ada Lovelace (Primera Programadora)", "Katherine Johnson, Dorothy Vaughan, Mary Jackson (NASA 'Hidden Figures')", "El Proyecto Manhattan (Desarrollo Atómico - Contexto Histórico)", "El Proyecto Genoma Humano", "El descubrimiento de los Antibióticos", "La Revolución Verde (Agricultura)", "La Conquista del Espacio (Programa Apolo)", "El Desarrollo de Internet", "La Invención del Transistor", "La Creación de la Imprenta (Gutenberg)", "El Desarrollo de la Fotografía", "El Advenimiento de la Electricidad", "Avances en la Medicina Moderna", "Innovaciones en Energías Renovables", "Descubrimientos en Inteligencia Artificial", "Hitos de la Exploración Espacial (Voyager, Hubble)",
            // Arte, Cultura y Deporte
            "William Shakespeare (Literatura)", "Miguel de Cervantes (Don Quijote)", "Gabriel García Márquez (Cien Años de Soledad)", "Frida Kahlo (Pintura, Icono Cultural)", "Pablo Picasso (Cubismo, Arte Moderno)", "Vincent van Gogh (Postimpresionismo)", "Ludwig van Beethoven (Música Clásica)", "Wolfgang Amadeus Mozart (Música Clásica)", "The Beatles (Impacto Musical y Cultural)", "Michael Jackson (Rey del Pop)", "Bob Dylan (Música y Poesía)", "Aretha Franklin (Reina del Soul)", "Pelé (Fútbol)", "Michael Jordan (Baloncesto)", "Serena y Venus Williams (Tenis)", "Roger Federer (Tenis)", "Rafael Nadal (Tenis)", "Novak Djokovic (Tenis)", "Lionel Messi (Fútbol)", "Cristiano Ronaldo (Fútbol)", "Usain Bolt (Atletismo)", "Simone Biles (Gimnasia)", "Muhammad Ali (Boxeo, Activismo)", "Jackie Robinson (Béisbol, Rompiendo Barreras)", "Jesse Owens (Atletismo, Olimpiadas 1936)", "Babe Ruth (Béisbol)", "Wayne Gretzky (Hockey sobre Hielo)", "El Renacimiento Italiano (Florencia)", "La Ilustración (Movimiento Intelectual)", "El Movimiento por los Derechos Civiles (EEUU)", "El Movimiento Sufragista", "El Impacto de Hollywood en la Cultura Global", "El Desarrollo del Cine", "La Época Dorada de la Televisión", "El Nacimiento del Rock and Roll", "El Surgimiento del Hip Hop", "El Fenómeno K-Pop (BTS, Blackpink)", "El Mundo de los E-sports", "El Legado de los Juegos Olímpicos", "La Magia del Cirque du Soleil", "El Universo Cinematográfico de Marvel (MCU)", "El Éxito de la Saga Star Wars", "La Influencia de la Moda (Diseñadores Icónicos)", "Grandes Obras Arquitectónicas (Historia y Logro)",
            // Impacto Social y Activismo
            "Martin Luther King Jr. (Derechos Civiles)", "Nelson Mandela (Anti-Apartheid, Reconciliación)", "Mahatma Gandhi (Independencia India, No Violencia)", "Malala Yousafzai (Educación Femenina)", "Greta Thunberg (Activismo Climático)", "Rosa Parks (Derechos Civiles)", "Eleanor Roosevelt (Derechos Humanos)", "Madre Teresa de Calcuta (Labor Humanitaria)", "Muhammad Yunus (Microcréditos, Banco Grameen)", "Bill y Melinda Gates (Fundación Gates, Filantropía)", "Jimmy Wales (Wikipedia)", "Sal Khan (Khan Academy)", "Blake Mycoskie (TOMS Shoes - Modelo One for One)", "Scott Harrison (charity: water)", "Bryan Stevenson (Equal Justice Initiative)", "Desmond Tutu (Anti-Apartheid, Verdad y Reconciliación)", "Harvey Milk (Derechos LGTB+)", "Gloria Steinem (Feminismo)", "Cesar Chavez (Derechos de los Trabajadores Agrícolas)", "Florence Nightingale (Enfermería Moderna)", "Clara Barton (Cruz Roja Americana)", "El Movimiento Abolicionista", "La Lucha por el Sufragio Femenino", "Avances en los Derechos LGTB+", "El Movimiento Ambientalista Moderno", "La Creación de las Naciones Unidas", "Médicos Sin Fronteras (MSF)", "Amnistía Internacional", "Cruz Roja / Media Luna Roja Internacional", "La Filantropía Moderna (Giving Pledge)", "El Concepto de Empresa Social", "Iniciativas de Comercio Justo", "Proyectos de Conservación Exitosos", "Campañas Globales de Salud Pública (Erradicación de Enfermedades)", "El Poder del Voluntariado",
            // Conceptos y Estrategias
            "Superando la Adversidad: Historias de Resiliencia", "Del Fracaso al Éxito: Aprender de los Errores", "La Importancia de la Persistencia", "Innovación Disruptiva: Cambiando Industrias", "Construyendo un Equipo Exitoso", "Liderazgo Transformacional", "El Poder del Networking", "Estrategias de Crecimiento Empresarial", "Marketing Viral: Casos de Estudio", "Creando una Marca Personal Fuerte", "El Arte de la Negociación", "Gestión del Tiempo y Productividad", "Inteligencia Emocional en el Liderazgo", "La Mentalidad de Crecimiento (Growth Mindset)", "El Efecto Red (Network Effect)", "Lean Startup: Metodología Ágil", "Design Thinking: Enfoque en el Usuario", "Economía Colaborativa (Sharing Economy)", "El Modelo Freemium", "Estrategia del Océano Azul", "Crowdfunding Exitoso", "La Revolución del Trabajo Remoto", "Sostenibilidad como Ventaja Competitiva", "Diversidad e Inclusión en las Empresas", "Mentoría y Desarrollo Profesional", "El Equilibrio entre Vida Personal y Profesional", "La Toma de Decisiones Bajo Presión", "La Comunicación Efectiva", "Adaptabilidad y Flexibilidad", "Visión a Largo Plazo", "Ética en los Negocios", "Responsabilidad Social Corporativa (RSC)", "La Curiosidad como Motor de Innovación", "Fomentando una Cultura de Innovación", "Midiendo el Éxito: Métricas Clave", "Internacionalización de Empresas", "Gestión de Crisis y Reputación", "El Legado y la Sucesión", "Filantropía Estratégica"
             // Total: Alrededor de 300-350. El botón 'Generar Más' complementará.
        ];
        const successStoryThemes = [ // Temas para el botón "Generar Más"
            "emprendimiento tecnológico", "líderes empresariales influyentes", "innovaciones científicas disruptivas", "artistas que cambiaron el mundo", "leyendas del deporte", "activistas por los derechos humanos", "compañías globales icónicas", "éxito en la industria del entretenimiento", "superación de grandes desafíos", "impacto social y filantropía", "revoluciones culturales", "descubrimientos médicos", "pioneros de la exploración", "éxito en el mundo digital", "estrategias de negocio exitosas", "marcas con legado histórico", "movimientos que transformaron la sociedad", "logros en ingeniería y arquitectura", "historias de resiliencia personal"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un biógrafo experto, analista de negocios e historiador especializado en narrar historias de éxito. Tu tarea es contar la historia inspiradora de la persona, empresa, concepto o evento indicado. Detalla el contexto inicial, los desafíos enfrentados, las decisiones clave tomadas, los momentos cruciales, el impacto logrado y las lecciones que se pueden aprender. Usa un tono cautivador, informativo y motivador. El objetivo es una narrativa completa de aproximadamente 1200-1300 palabras. Basa tu historia únicamente en el siguiente tema:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
             systemPrompt: "Actúa como un experto conocedor únicamente de la historia de éxito que se está mostrando. Responde preguntas de seguimiento sobre detalles específicos, personajes clave, momentos importantes o lecciones mencionadas en la narrativa principal. Sé conciso y enfócate estrictamente en el tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una biblioteca de historias de éxito. Genera exactamente 15 nombres de personas famosas por su éxito, empresas icónicas, movimientos transformadores o conceptos clave de logro, adecuados para una narrativa inspiradora detallada. Devuelve *solo* la lista de nombres/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Cambiado nombre para claridad

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `Eres un experto conocedor únicamente de la historia de éxito llamada '${currentStoryTitle}'. Responde preguntas de seguimiento sobre detalles específicos, personajes clave, momentos importantes o lecciones mencionadas en la narrativa principal. Sé conciso y enfócate estrictamente en el tema actual.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento. Por favor, intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o el tema.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(storyTitle) { // Renombrado para claridad
            return fetchTextFromApi(storyTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentStoryTitle) throw new Error("Error interno: No se ha establecido el contexto de la historia para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(successStoryThemes) || "historias de éxito variadas";
             const specificPrompt = `Genera 15 nombres/conceptos sobre ${randomTheme} para historias de éxito`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de historias.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "symbol of success and achievement";
             // Prompt ENFOCADO en concepto/símbolo, NO retratos realistas, NO texto.
             const enhancedPrompt = `Symbolic or conceptual representation inspired by the success story of '${safePromptText}'. Focus on themes like growth, innovation, overcoming obstacles, achievement, legacy. Use inspirational or professional color palettes (blues, greens, golds, white). Avoid text, labels, realistic portraits, graphs, charts. Abstract or semi-abstract artistic interpretation.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, graphs, charts, diagrams, map, flag, realistic person, photorealistic, ugly, deformed, blurry, low quality, watermark, signature";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (sin cambios lógicos)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null; // Reset context
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios lógicos)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios lógicos)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ========== (sin cambios lógicos)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }

        function createTitleItem(title) {
             const div = document.createElement('div');
             div.className = 'title-item';
             // Opcional: Añadir icono basado en tipo (persona, empresa, concepto) - requeriría lógica adicional
             // div.innerHTML = `<i class="fas fa-user-tie"></i> ${title}`; // Ejemplo icono persona
             div.textContent = title; // Simple por ahora
             div.setAttribute('data-title', title);
             div.addEventListener('click', () => handleTitleClick(title));
             return div;
        }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); // Ordenar alfabéticamente
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay historias disponibles.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-aplicar filtro
         }

        // MODIFIED: handleTitleClick - Cambiado nombre de variable de contexto
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title); // Usa nombre de función actualizado
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-lightbulb placeholder-icon"></i> <!-- Icono bombilla/idea -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Creando visualización conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => { showFullscreenImage(imgElement.src); });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon" style="color: var(--color-error-text);"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon" style="color: var(--color-error-text);"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la historia.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // MODIFIED: handleGenerateMoreTitles - Texto del botón
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando inspiración...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar nuevas historias en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar historias: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Solicitar Nuevas Historias';
             }
         }

        // Search Filter Function (sin cambios lógicos, normalización ya incluida)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (sin cambios lógicos)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error crítico: Fallo al cargar componentes de la interfaz.</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>