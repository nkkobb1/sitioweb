<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ciencia Sencilla - Conceptos de Gramática Española</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Base (Temática Gramática) --- */
        :root {
            --color-primary: #059669; /* Emerald-600 */
            --color-secondary: #f97316; /* Orange-500 */
            --color-background: #f8fafc; /* Cool Gray 50 */
            --color-text: #1f2937; /* Cool Gray 800 */
            --color-text-muted: #6b7280; /* Cool Gray 500 */
            --color-modal-bg: #ffffff;
            --color-border: #e5e7eb; /* Cool Gray 200 */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); }
        h1, h2, h3, h4, .logo { font-family: 'Quicksand', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #047857; /* Emerald 700 */ box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.8); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem; max-width: 850px; width: 95%; max-height: 90vh; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e5e7eb; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.4rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #d1d5db; color: var(--color-text); }
        #modal-title { color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; }
        #modal-content { line-height: 1.7; color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 10px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content::-webkit-scrollbar { width: 8px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.2em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Quicksand', sans-serif; margin-top: 1.8em; margin-bottom: 0.8em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.3em; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.2em; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-secondary); }
        #modal-content .formula { /* Mantener por si la IA genera algo así */ text-align: center; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 1.1em; padding: 0.8em; margin: 1.2em 0; border: 1px solid var(--color-border); background-color: #f9fafb; border-radius: var(--border-radius); overflow-x: auto; white-space: nowrap; }
        #modal-content .formula sub, #modal-content .formula sup { font-size: 0.8em; line-height: 0; position: relative; vertical-align: baseline; }
        #modal-content .formula sub { top: 0.5em; }
        #modal-content .formula sup { top: -0.5em; }
        #modal-image-container { width: 100%; height: 220px; background-color: #f3f4f6; border-radius: var(--border-radius); overflow: hidden; display: none; /* Start hidden */ align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; margin-top: 1rem; }
        #modal-image-container.visible { display: flex; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 2.5rem; color: var(--color-border); display: none; }
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: var(--border-radius); border: 1px solid #fecaca; margin-top: 1rem; text-align: center; flex-shrink: 0; }
        .error-msg i { margin-right: 0.5rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-3 flex justify-center items-center">
             <div class="flex items-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-spell-check mr-2"></i> Ciencia Sencilla: Gramática
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Descifrando Nuestro Idioma</h1>
             <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Explora la estructura del español con explicaciones claras de gramática por IA. ¡Selecciona un concepto!</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-book text-orange-500 mr-2"></i>
                 Conceptos a Conjugar
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Buscando reglas...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Conceptos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Redactando explicación...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                 </div>
                  <!-- Image Container (Initially Hidden) -->
                 <div id="modal-image-container">
                     <div class="spinner"></div>
                     <i class="fas fa-paragraph placeholder-icon"></i> <!-- Placeholder icon -->
                     <img id="modal-image" alt="Visualización abstracta del concepto gramatical" />
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-circle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-5 mt-12 border-t border-gray-200">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA con fines educativos. La gramática es compleja, consulta fuentes académicas.</p>
              <p class="mt-1">© 2025 Ciencia Sencilla</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            "¿Qué es un Sustantivo?", "Sustantivos Comunes y Propios", "Sustantivos Concretos y Abstractos", "Sustantivos Individuales y Colectivos",
            "El Género de los Sustantivos", "El Número de los Sustantivos", "Formación del Plural", "¿Qué es un Artículo?", "Artículos Determinados (el, la, los, las)",
            "Artículos Indeterminados (un, una, unos, unas)", "El Artículo Neutro 'lo'", "Contracciones: Al y Del", "¿Qué es un Adjetivo?",
            "Adjetivos Calificativos", "Adjetivos Relacionales", "Adjetivos Numerales (Cardinales, Ordinales)", "Adjetivos Demostrativos (este, ese, aquel)",
            "Adjetivos Posesivos (mi, tu, su...)", "Adjetivos Indefinidos (alguno, ninguno, otro...)", "Grados del Adjetivo (Positivo, Comparativo, Superlativo)",
            "Concordancia: Sustantivo y Adjetivo", "¿Qué es un Pronombre?", "Pronombres Personales de Sujeto (yo, tú, él...)",
            "Pronombres Personales Tónicos de Complemento (mí, ti, sí...)", "Pronombres Personales Átonos de Complemento (me, te, se, nos, os, lo, la, le...)",
            "Leísmo, Laísmo y Loísmo: Uso correcto", "Pronombres Demostrativos (este, ese, aquel...)", "Pronombres Posesivos (mío, tuyo, suyo...)",
            "Pronombres Indefinidos (alguien, nadie, algo...)", "Pronombres Relativos (que, quien, cual, cuyo...)", "Pronombres Interrogativos (qué, quién, cuál...)",
            "Pronombres Exclamativos (qué, quién, cuánto...)", "¿Qué es un Verbo?", "El Infinitivo, Gerundio y Participio", "Las Conjugaciones (-ar, -er, -ir)",
            "La Raíz y la Desinencia Verbal", "Modos Verbales: Indicativo", "Modos Verbales: Subjuntivo", "Modos Verbales: Imperativo",
            "Tiempos Verbales Simples del Indicativo", "Tiempos Verbales Compuestos del Indicativo", "Tiempos Verbales Simples del Subjuntivo",
            "Tiempos Verbales Compuestos del Subjuntivo", "Formas del Imperativo", "Verbos Regulares e Irregulares", "Principales Verbos Irregulares",
            "Verbos Copulativos: Ser, Estar y Parecer", "Diferencias entre Ser y Estar", "La Voz Activa", "La Voz Pasiva (Pasiva Perifrástica y Pasiva Refleja)",
            "Perífrasis Verbales: Concepto y Tipos", "Perífrasis Modales (poder, deber...)", "Perífrasis Aspectuales (ir a + inf, estar + gerundio...)",
            "¿Qué es un Adverbio?", "Tipos de Adverbios (Lugar, Tiempo, Modo...)", "Adverbios Terminados en -mente", "Locuciones Adverbiales",
            "Grados del Adverbio", "¿Qué es una Preposición?", "Lista de Preposiciones (a, ante, bajo...)", "Usos Comunes de las Preposiciones",
            "Locuciones Preposicionales", "¿Qué es una Conjunción?", "Conjunciones Coordinantes (Copulativas, Disyuntivas, Adversativas...)",
            "Conjunciones Subordinantes (Completivas, Causales, Finales...)", "Locuciones Conjuntivas", "¿Qué es una Interjección?",
            "Tipos de Interjecciones (Propias e Impropias)", "La Oración: Concepto y Partes", "Sujeto y Predicado", "El Núcleo del Sujeto y del Predicado",
            "Tipos de Sujeto (Explícito, Omitido, Agente...)", "Tipos de Predicado (Nominal y Verbal)", "El Atributo (con verbos copulativos)",
            "Complemento Directo (CD)", "Identificación del Complemento Directo", "Complemento Indirecto (CI)", "Identificación del Complemento Indirecto",
            "Complemento Circunstancial (CC)", "Tipos de Complemento Circunstancial (Lugar, Tiempo, Modo...)", "Complemento de Régimen Verbal (CRV o Suplemento)",
            "Complemento Agente (en la voz pasiva)", "Complemento Predicativo (C. Pvo)", "Oraciones según la Actitud del Hablante",
            "Oraciones Enunciativas (Afirmativas, Negativas)", "Oraciones Interrogativas (Totales, Parciales, Directas, Indirectas)",
            "Oraciones Exclamativas", "Oraciones Dubitativas", "Oraciones Desiderativas (Optativas)", "Oraciones Imperativas (Exhortativas)",
            "Oraciones Impersonales: Concepto", "Impersonales con Verbos Meteorológicos", "Impersonales Gramaticalizadas (haber, hacer, ser)",
            "Impersonales Reflejas (con 'se')", "Impersonales Eventuales u Ocasionales", "La Oración Compuesta: Concepto",
            "Oraciones Yuxtapuestas", "Oraciones Coordinadas: Tipos", "Coordinadas Copulativas (y, e, ni)", "Coordinadas Disyuntivas (o, u)",
            "Coordinadas Adversativas (pero, mas, sino, sin embargo...)", "Coordinadas Distributivas (bien... bien, ya... ya...)",
            "Coordinadas Explicativas (es decir, o sea...)", "Oraciones Subordinadas: Concepto", "Subordinadas Sustantivas: Funciones",
            "Subordinadas Sustantivas de Sujeto", "Subordinadas Sustantivas de Complemento Directo", "Subordinadas Sustantivas de Complemento Indirecto",
            "Subordinadas Sustantivas de Atributo", "Subordinadas Sustantivas de Complemento de Régimen", "Subordinadas Sustantivas de Complemento del Nombre",
            "Subordinadas Sustantivas de Complemento del Adjetivo", "Subordinadas Adjetivas o de Relativo", "El Pronombre Relativo como Nexo",
            "Subordinadas Adjetivas Especificativas", "Subordinadas Adjetivas Explicativas", "Subordinadas Adverbiales: Tipos",
            "Subordinadas Adverbiales de Lugar", "Subordinadas Adverbiales de Tiempo", "Subordinadas Adverbiales de Modo",
            "Subordinadas Adverbiales Comparativas", "Subordinadas Adverbiales Causales", "Subordinadas Adverbiales Finales",
            "Subordinadas Adverbiales Concesivas", "Subordinadas Adverbiales Condicionales", "Subordinadas Adverbiales Consecutivas",
            "Signos de Puntuación: El Punto", "Usos de la Coma", "El Punto y Coma", "Los Dos Puntos", "Puntos Suspensivos",
            "Signos de Interrogación y Exclamación: Uso", "El Guion y la Raya", "Las Comillas: Tipos y Usos", "Los Paréntesis y los Corchetes",
            "Reglas Generales de Acentuación", "Palabras Agudas, Llanas, Esdrújulas y Sobresdrújulas", "La Tilde Diacrítica",
            "Acentuación de Diptongos, Triptongos e Hiatos", "Acentuación de Monosílabos", "Acentuación de Palabras Compuestas",
            "Acentuación de Formas Verbales con Pronombre Enclítico", "Acentuación de Adverbios en -mente", "Acentuación de Mayúsculas",
            "Uso de la 'B' y la 'V'", "Uso de la 'G' y la 'J'", "Uso de la 'H'", "Uso de la 'C', 'Z' y 'S'", "Uso de la 'LL' y la 'Y'",
            "Uso de la 'R' y 'RR'", "Prefijos Comunes y su Significado", "Sufijos Comunes y su Significado", "Familias Léxicas (Palabras Derivadas)",
            "Campo Semántico vs. Campo Léxico", "Sinónimos y Antónimos: Tipos", "Palabras Homónimas (Homógrafas y Homófonas)",
            "Palabras Parónimas", "Palabras Polisémicas", "Denotación y Connotación", "Figuras Retóricas Comunes (Metáfora, Símil, Hipérbole, Personificación)",
            "Cohesión Textual: Mecanismos", "Coherencia Textual: Propiedades", "Registros Lingüísticos (Formal e Informal)", "El Lenguaje Coloquial",
            "Neologismos, Arcaísmos y Extranjerismos", "Variedades Diatópicas del Español (Dialectos)", "Dequeísmo y Queísmo: Cómo Evitarlos",
            "Funciones del Lenguaje (Referencial, Emotiva...)", "Formación de Palabras: Derivación, Composición, Parasíntesis",
            "Siglas, Acrónimos y Abreviaturas", "El Discurso Directo e Indirecto: Estilos", "Errores Gramaticales Frecuentes"
        ];
        const grammarThemes = [
            "morfología nominal", "morfología verbal", "sintaxis de la oración simple", "sintaxis de la oración compuesta",
            "clases de palabras", "ortografía acentual", "ortografía literal", "puntuación", "semántica léxica",
            "normativa y usos correctos", "tipos de oraciones", "complementos verbales", "perífrasis verbales",
            "usos del subjuntivo", "la voz pasiva", "oraciones impersonales", "conectores textuales", "cohesión y coherencia",
            "formación de palabras", "variedades del español", "pronombres y sus tipos", "el adverbio y sus clases",
            "preposiciones y conjunciones", "análisis sintáctico básico", "figuras retóricas"
        ];
        const textApiConfig = { model: "mistral", systemPrompt: "Eres un lingüista experto y un excelente divulgador especializado en gramática española. Tu tarea es explicar conceptos gramaticales, desde básicos hasta más complejos, de forma muy clara, sencilla y detallada para un público general o estudiantes. Utiliza ejemplos claros y relevantes, analogías si ayudan, y define cualquier término técnico necesario. Estructura la explicación lógicamente usando párrafos y ocasionalmente sub-títulos (usando markdown como #, ##, ### o ####). El objetivo es una explicación completa y fácil de entender de unas 700-800 palabras. Basa tu explicación únicamente en el siguiente concepto gramatical:", timeoutSeconds: 100 };
        const titleGenerationConfig = { model: "mistral", systemPrompt: "Actúa como un generador de ideas conciso. Genera exactamente 15 conceptos o preguntas clave sobre gramática española, adecuados para ser explicados de forma sencilla. Devuelve *solo* la lista de conceptos/preguntas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.", timeoutSeconds: 30 };

        // ========== DOM ELEMENTS ========== (sin cambios)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // --- Variable to hold the current scroll listener ---
        let currentScrollHandler = null;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) { /* ... (sin cambios) ... */
            const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url}`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
             }
        }
        async function fetchExplanationText(conceptTitle) { /* ... (sin cambios) ... */
            const text = await fetchTextFromApi(conceptTitle, textApiConfig);
             if (text.trim().length < 500 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo ayudarte con eso")) {
                   throw new Error("La IA no pudo generar una explicación adecuada para este concepto gramatical.");
               }
            return text;
        }
        async function fetchGeneratedTitles() { /* ... (Actualizado prompt base) ... */
            const randomTheme = getRandomElement(grammarThemes) || "conceptos esenciales";
            const specificPrompt = `Genera 15 conceptos o preguntas clave sobre ${randomTheme} en gramática española`;
            console.log("Generating concepts with prompt:", specificPrompt);
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
            // Filtrado más estricto para títulos gramaticales (suelen ser más cortos)
            const titles = text.split('\n')
                .map(line => line.replace(/^[-\d.\s*¿?¡!]+/, '').replace(/[¿?¡!]+$/, '').trim()) // Quita numeración y signos al inicio/final
                .filter(line => line.length > 3 && line.length < 100 && /\w/.test(line)); // Asegura que tenga letras
            if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de conceptos gramaticales.");
            return titles.slice(0, 15);
        }
        function createPollinationsImageUrl(promptText, options = {}) { /* ... (Actualizado prompt y negative prompt) ... */
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "spanish grammar concept abstract";
            // Prompt más enfocado en estructura y lenguaje
            const enhancedPrompt = `Abstract visualization related to the spanish language grammar concept of '${safePromptText}', conceptual art, focus on structure, connection, or communication patterns, minimalist style`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            // Negative prompt reforzado para gramática
            const negativePrompt = "text, words, letters, writing, handwriting, sentences, paragraphs, punctuation marks, specific examples, book page, dictionary entry, grammar rules written out, syntax tree diagram, verb conjugation table, person, people, realistic photo, drawing of classroom, teacher, student, blackboard, whiteboard";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (igual que la versión anterior) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (sin cambios en la lógica del scroll y listener)
        function showModal() { /* ... (igual) ... */ if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { /* ... (igual) ... */
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll
            console.log("Scroll set to 0 on hideModal");
            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
                console.log("Scroll listener removed on hideModal.");
            }
            resetModalState();
        }
        function resetModalState() { /* ... (igual) ... */
            if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
            modalLoadingIndicator.style.display = 'flex';
            modalStoryContentArea.classList.add('content-hidden');
            modalError.classList.add('content-hidden');
            modalTitle.textContent = '';
            modalContent.innerHTML = '';
            modalImage.src = '';
            modalImage.style.display = 'none';
            modalImageSpinner.style.display = 'none';
            modalImagePlaceholder.style.display = 'none';
            modalImageContainer.classList.remove('visible');
            modalImageContainer.style.display = 'none';
            modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (sin cambios en la lógica del scroll y listener)
        function getRandomElement(arr) { /* ... (igual) ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... (igual) ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... (igual) ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... (igual) ... */
            if (!titleListContainer || !titlesLoading) return;
            const shuffledTitles = shuffleArray([...titles]);
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay conceptos disponibles.</p>'; return; }
            shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... (igual) ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        async function handleTitleClick(title) { /* ... (igual, con lógica de scroll y listener) ... */
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalImageContainer.style.display = 'none';
            modalImageContainer.classList.remove('visible');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
            }

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.scrollTop = 0; // <<<--- RESET SCROLL AQUÍ
                console.log("Scroll set to 0 after content visible");

                modalImageSpinner.style.display = 'block';
                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL:", title);
                     modalImageSpinner.style.display = 'none';
                     modalImagePlaceholder.style.display = 'block';
                 }

                const scrollBuffer = 15;
                currentScrollHandler = () => {
                     if (modalContent.scrollHeight <= modalContent.clientHeight) {
                         console.log("Content fits, showing image immediately.");
                         modalImageContainer.classList.add('visible');
                         modalImageContainer.style.display = 'flex';
                         modalContent.removeEventListener('scroll', currentScrollHandler);
                         currentScrollHandler = null;
                    } else if ((modalContent.scrollTop + modalContent.clientHeight) >= (modalContent.scrollHeight - scrollBuffer)) {
                        console.log("Scroll end reached, showing image.");
                        modalImageContainer.classList.add('visible');
                        modalImageContainer.style.display = 'flex';
                        modalContent.removeEventListener('scroll', currentScrollHandler);
                        currentScrollHandler = null;
                        console.log("Scroll listener removed after showing image.");
                    }
                };
                modalContent.addEventListener('scroll', currentScrollHandler);
                console.log("Scroll listener added.");
                setTimeout(currentScrollHandler, 100); // Check inicial

            } catch (error) {
                console.error("Failed to display explanation:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error al cargar: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = '';
                 if (currentScrollHandler) {
                    modalContent.removeEventListener('scroll', currentScrollHandler);
                    currentScrollHandler = null;
                 }
            }
        }
        async function handleGenerateMoreTitles() { /* ... (Actualizado texto botón) ... */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando...'; // Cambiado texto de carga
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se pudieron generar nuevos conceptos gramaticales en este momento."); }
             } catch (error) { console.error("Failed generation:", error); alert(`Error al generar: ${error.message}`);
             } finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Conceptos'; }
         }

        // ========== INITIALIZATION ========== (sin cambios)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p>Error crítico.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>