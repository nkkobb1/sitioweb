<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmovisión Yoruba - Guía Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Respetuosas y Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Religión Yoruba --- */
        :root {
            /* Paleta Inspirada (Ejemplos, ajustar según diseño) */
            --color-olodumare-bg: #f8fafc; /* Blanco Hueso/Cielo Claro */
            --color-obatala: #ffffff;
            --color-yemaya: #0077be; /* Azul Marino */
            --color-oshun: #ffbf00; /* Dorado/Amarillo */
            --color-shango: #ff0000; /* Rojo */
            --color-ogun: #006400; /* Verde Oscuro */
            --color-elegua: #000000; /* Negro (y Rojo) */
            --color-text: #333333; /* Gris muy oscuro / Casi negro */
            --color-text-muted: #555555;
            --color-modal-bg: #fdfbf7; /* Blanco cálido/Crema */
            --color-border: #e0dccc; /* Borde Arena/Tierra clara */
            --color-accent: var(--color-oshun); /* Un color para acentos generales */

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
            --border-radius: 5px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-olodumare-bg); color: var(--color-text); line-height: 1.75; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-ogun); /* Verde oscuro para el logo */ }
        h1.page-title { color: var(--color-shango); /* Rojo para título principal */ font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-oshun); padding-bottom: 0.7rem; display: inline-block; font-weight: 700;}
        #modal-title { color: var(--color-yemaya); /* Azul para título modal */ font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-oshun); box-shadow: 0 0 0 3px rgba(255, 191, 0, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-oshun); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-obatala); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 700; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Lato'; font-size: 0.95rem; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-yemaya); color: var(--color-yemaya); background-color: #f0f8ff; /* Azul muy pálido hover */ }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-ogun), var(--color-oshun)); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-oshun), var(--color-ogun)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: #cccccc; color: #888888; cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; text-shadow: none;}
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(51, 51, 51, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Increased height for loading game/chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #eee; border: 1px solid var(--color-border); border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-shango); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Loading Overlay & Minigame */
        #modal-loading { text-align: center; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(253, 251, 247, 0.98); /* Modal bg with opacity */ display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); padding: 2rem; }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-accent); border-radius: 50%; animation: spin 1.2s linear infinite; margin-bottom: 1.5rem; }
        #modal-loading p.loading-text { font-weight: 700; color: var(--color-text); font-size: 1.3rem; font-family: 'Merriweather'; }
        /* Minigame Styles */
        #loading-minigame { display: none; /* Shown by JS */ flex-direction: column; align-items: center; justify-content: space-around; width: 100%; height: 100%; padding: 1rem; }
        #ase-click-target { width: 100px; height: 100px; background-color: var(--color-oshun); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s ease, box-shadow 0.2s ease; margin-bottom: 1.5rem; box-shadow: var(--shadow-md); border: 3px solid white; }
        #ase-click-target:active { transform: scale(0.95); }
        #ase-click-target i { font-size: 3rem; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); } /* Example icon */
        #ase-display { font-size: 1.8rem; font-weight: 700; color: var(--color-ogun); margin-bottom: 1rem; font-family: 'Merriweather'; }
        #ase-per-second-display { font-size: 0.9rem; color: var(--color-text-muted); margin-bottom: 1.5rem; }
        #orisha-unlocks { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; max-width: 80%; }
        .orisha-icon { font-size: 1.8rem; padding: 0.5rem; border-radius: 50%; background-color: #e0e0e0; color: #999; transition: all 0.3s ease; opacity: 0.5; }
        .orisha-icon.unlocked { background-color: var(--color-icon-bg, #e0e0e0); color: var(--color-icon-fg, #ffffff); opacity: 1; transform: scale(1.1); box-shadow: var(--shadow-sm); }
        #minigame-instructions { font-size: 0.9em; color: var(--color-text-muted); margin-top: 1.5rem; }


        /* Area de Contenido Principal (Texto + Imagen + Chat) */
        #modal-story-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; }
        /* Scrollable Text Area */
        #modal-content-area { flex-grow: 1; min-height: 0; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-oshun) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-oshun); border-radius: var(--border-radius); }
        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-ogun); font-weight: 700; }
        #modal-content em { color: var(--color-yemaya); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.1em; margin-bottom: 1em; color: var(--color-shango); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.4em; } #modal-content h2 { font-size: 1.25em; } #modal-content h3 { font-size: 1.1em; color: var(--color-ogun); } #modal-content h4 { font-size: 1em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 2px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-lg); border-color: var(--color-oshun); }
        #modal-content .image-placeholder { /* Similar a antes, ajustar colores */ display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(224, 220, 204, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-accent); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: auto; /* Push chat to bottom */ flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; background-color: #f9f6f2; /* Slightly different bg for chat */ border-radius: 0 0 var(--border-radius) var(--border-radius); padding: 1rem; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fff; scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: var(--color-yemaya) var(--color-border); }
        #chat-history::-webkit-scrollbar { width: 6px; } #chat-history::-webkit-scrollbar-track { background: var(--color-border); } #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-yemaya); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95em; }
        .user-message { background-color: var(--color-ogun); color: white; margin-left: auto; text-align: left; } /* User messages green */
        .ai-message { background-color: #eef; color: var(--color-text); margin-right: auto; text-align: left; border: 1px solid #dde; } /* AI messages light blueish */
        .chat-error { color: var(--color-shango); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.3rem; }
        #chat-input-area { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 2px rgba(255, 191, 0, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-yemaya); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #005a9e; }
        #chat-send-btn:disabled { background-color: #b0c4de; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Error Message */
        .error-msg { background-color: #fff1f2; color: #c53030; padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #fecaca; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 700; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: #c53030; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { /* Style as before, maybe adjust bg color */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(50, 50, 50, 0.9); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-obatala); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: rgba(255,255,255,0.8); border: 1px solid #ccc; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: #333; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-shango); color: white; transform: scale(1.1); }

        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-sun mr-3 text-yellow-500"></i> <!-- Icono Sol/Olodumare -->
                     Cosmovisión Yoruba
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Guía Interactiva «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora la Sabiduría Ancestral</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre los Orishas, conceptos fundamentales y prácticas de la rica tradición religiosa Yoruba.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar Orisha, concepto, ritual...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-600 mr-2"></i> <!-- Icono libro -->
                 Temas y Entidades
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando índice de conocimientos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron entradas para tu búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Expandir Conocimiento
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Overlay -->
             <div id="modal-loading">
                 <!-- Default Loading (Hidden when game active) -->
                 <div id="default-loading-content">
                    <div class="loading-spinner-modal"></div>
                    <p class="loading-text">Accediendo a la sabiduría...</p>
                 </div>
                 <!-- Minigame Area -->
                 <div id="loading-minigame">
                     <div id="ase-display">Asé: 0</div>
                     <div id="ase-per-second-display"></div>
                     <div id="ase-click-target" title="Haz clic para acumular Asé">
                         <i class="fas fa-hand-sparkles"></i> <!-- Icono representativo -->
                     </div>
                     <div id="orisha-unlocks">
                         <!-- Icons added by JS -->
                     </div>
                     <p id="minigame-instructions">Acumula Asé mientras esperas...</p>
                 </div>
             </div>

             <!-- Main Content Area (Shown After Loading) -->
             <div id="modal-story-content-area" class="content-hidden">
                 <!-- Scrollable Text + Image Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Explanation text & image placeholder/image -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                    <div id="chat-history"></div>
                    <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando Oráculo...</div>
                    <div id="chat-input-area">
                        <input type="text" id="chat-input" placeholder="Pregunta sobre este tema...">
                        <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                    </div>
                 </div>
                 <!-- Error Display -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Contenido generado por IA como introducción a la religión tradicional Yoruba. Consulte fuentes académicas y practicantes para un entendimiento profundo.</p>
              <p class="mt-1">La representación visual y textual es interpretativa y con fines educativos.</p>
              <p class="mt-2">© 2025 Guía Interactiva Yoruba</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Orishas Principales
            "Olodumare (Ser Supremo)", "Obatalá (Creación, Paz, Pureza)", "Yemayá (Maternidad, Mar, Fertilidad)", "Oshún (Amor, Belleza, Ríos, Dulzura)", "Shangó (Trueno, Fuego, Justicia, Danza)", "Ogún (Hierro, Guerra, Trabajo, Tecnología)", "Eleguá / Eshu (Caminos, Mensajero, Tramposo)", "Orúnmila (Sabiduría, Destino, Adivinación Ifá)", "Oyá (Viento, Muerte, Cambio, Mercado)", "Babalu Ayé / Omolú (Enfermedades, Curación, Tierra)", "Osanyin / Osain (Hierbas, Medicina Natural, Secretos del Bosque)", "Erinlẹ (Cazador, Medicina, Abundancia)", "Orisha Oko (Agricultura, Fertilidad de la Tierra)", "Ibeji (Gemelos Divinos, Suerte)", "Osun (Vigilancia, Protección, Espíritu del Río)", // Staff, no la Orisha Oshun
            // Conceptos Fundamentales
            "Asé (Poder Espiritual, Energía Vital)", "Orí (Destino Personal, Cabeza Espiritual)", "Iwá Pele (Buen Carácter)", "Egun (Espíritus Ancestrales)", "Ifá (Sistema de Adivinación y Sabiduría)", "Odù Ifá (Signos Sagrados de Ifá)", "Cosmología Yoruba (Orun y Aye)", "Ajogun (Fuerzas Adversas/Obstáculos)", "Ebó (Ofrenda, Sacrificio Ritual)", "Ìwà (Carácter, Existencia)", "Oríkì (Alabanzas, Poemas de Orientación)", "Mojuba (Rezo de Respeto y Petición)", "Ẹ̀sìn Ìbílẹ̀ Yorùbá (Definición de la Religión)", "Reencarnación (Atunwa)", "Tabúes (Eewo)",
            // Adivinación
            "Adivinación con Ifá (Opón Ifá, Ikin, Opele)", "Adivinación con Obi Abata (Nuez de Kola)", "Adivinación con Erindilogun (16 Caracoles)", "Interpretación de los Odù Ifá", "El papel del Babalawo", "El papel de la Iyalorisha / Babalorisha", "El papel de la Iyanifa", "Consulta Espiritual (Dafa)",
            // Rituales y Ceremonias
            "Iniciación en Ifá (Itefa)", "Iniciación Osha (Kari Osha)", "Presentación al Tambor (Aña)", "Ceremonias Funerarias (Itutu)", "Lavatorio de Santos (Omiero)", "Rogación de Cabeza (Kobori Eleda)", "Bembé / Toque de Santo", "Alimentar a los Orishas", "Rituales de Limpieza (Sarayeye)", "Matanza Ritual", "Fiestas Anuales de los Orishas",
            // Objetos Sagrados y Símbolos
            "Elekes / Collares de Fundamento", "Idé (Pulsera de Orula/Orishas)", "Otanes (Piedras Sagradas)", "Agbébe (Abanico de Oshun/Yemayá)", "Herramientas de Ogún", "Maraca de Shangó (Shekere)", "Garabato de Eleguá", "Iruke (Cola de Caballo de Oya/Obatalá)", "Tinaja (Representación de Olokun/Yemayá)", "Calabaza (Igbadu, Contenedor)", "Osun de Babalawo (Bastón)", "Opón Ifá (Tablero de Ifá)", "Ikin Ifá (Nueces de Palma Sagradas)", "Opele Ifá (Cadena de Adivinación)", "Caracoles Cowrie (Diloggún)", "Tambores Batá (Iyá, Itótele, Okónkolo)", "Ashé de Santo (Objetos de Poder)",
            // Diáspora y Sincretismo
            "Santería / Regla de Osha-Ifá (Cuba)", "Candomblé (Brasil - Naciones Ketu, Jeje, Angola)", "Lucumí (Término cubano)", "Orisha Tradicional vs Diáspora", "Sincretismo con el Catolicismo", "Influencia Yoruba en el Caribe", "Influencia Yoruba en América del Sur", "Preservación de la Tradición en la Diáspora", "Ifá en Occidente", "Nuevos Linajes y Prácticas",
            // Historia y Cultura
            "Ile-Ife (Ciudad Sagrada)", "Historia del Pueblo Yoruba", "Mitología Yoruba (Patakís)", "Proverbios Yoruba", "Música y Danza Yoruba", "Arte Yoruba (Máscaras, Esculturas)", "Idioma Yoruba y su importancia religiosa", "Organización Social Tradicional Yoruba", "Roles de Género en la Tradición", "Ética y Moral Yoruba",
            // Orishas Menores / Regionales / Aspectos
            "Olokun (Profundidades del Océano)", "Dada (Niños, Vegetales)", "Ajé Shaluga (Riqueza, Prosperidad)", "Logun Ede (Hijo de Oshun e Erinle)", "Obba (Matrimonio, Fidelidad, Ríos)", "Yewá (Cementerios, Muerte, Pureza)", "Iroko (Ceiba Sagrada)", "Aggayú Solá (Volcanes, Padre de Shangó)", "Nana Burukú (Madre Ancestral, Lodo Primordial)", "Oshosi (Cazador Justiciero)", "Inle (Médico Divino)", "Boromu y Borosia (Guardianes de Secretos)", "Caminos (Avatares) de los Orishas (Ej: Eleguá Laroye)", "Las Siete Potencias Africanas (Concepto sincrético)",
             // Añadir más con Generar Más...
        ];
        const yorubaThemes = [
            "Orishas principales", "conceptos yoruba", "adivinación Ifá", "rituales yoruba", "objetos sagrados yoruba",
            "cosmología yoruba", "Egun y ancestros", "Santería y Candomblé", "historia yoruba", "patakís importantes",
            "ética yoruba (Iwa Pele)", "Odù Ifá específicos", "roles sacerdotales (Babalawo, Iyalorisha)", "música y danza ritual",
            "sincretismo religioso", "influencia yoruba en la diáspora", "Orishas menos conocidos", "símbolos yoruba"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un erudito respetuoso y conocedor profundo de la religión tradicional Yoruba (Ẹ̀sìn Ìbílẹ̀ Yorùbá) y sus expresiones en la diáspora (como Santería/Osha-Ifá y Candomblé). Tu tarea es explicar el Orisha, concepto, ritual u otro tema Yoruba indicado, de manera detallada, precisa y culturalmente sensible. Cubre su significado, atributos, historias (patakís) relevantes si aplica, simbolismo, prácticas asociadas y su importancia dentro de la cosmovisión Yoruba. Evita simplificaciones excesivas, estereotipos o lenguaje sensacionalista. Cita fuentes o perspectivas académicas si es posible, pero mantén un tono accesible. El objetivo es una explicación completa de aproximadamente 1200-1300 palabras. Basa tu respuesta únicamente en el siguiente tema Yoruba:",
            timeoutSeconds: 240 // Aumentar timeout si 4 min es real
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúa como un asistente informado y respetuoso, especializado únicamente en el tema Yoruba que se está mostrando. Responde preguntas de seguimiento sobre sus detalles, contexto o prácticas relacionadas mencionadas en la descripción principal. Sé conciso, preciso y mantén siempre un tono respetuoso hacia la tradición.",
            timeoutSeconds: 50
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una guía sobre la religión tradicional Yoruba. Genera exactamente 40 nombres de Orishas (principales y menos conocidos), conceptos filosóficos, sistemas de adivinación, rituales importantes, objetos sagrados o temas culturales relacionados. Asegura variedad. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Más tiempo para generar 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingOverlay = document.getElementById('modal-loading');
        const defaultLoadingContent = document.getElementById('default-loading-content'); // Spinner y texto default
        const minigameContainer = document.getElementById('loading-minigame'); // Área del minijuego
        const modalStoryContentArea = document.getElementById('modal-story-content-area'); // Wrapper contenido principal (post-carga)
        const modalTextArea = document.getElementById('modal-content-area'); // Área texto+imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const aseDisplay = document.getElementById('ase-display');
        const asePerSecondDisplay = document.getElementById('ase-per-second-display');
        const aseClickTarget = document.getElementById('ase-click-target');
        const orishaUnlocksContainer = document.getElementById('orisha-unlocks');

        // ========== State Variables ==========
        let currentTopic = null; // Contexto para chat
        let isGameActive = false;
        let gameLoopInterval = null;
        let aseCount = 0;
        let asePerClick = 1;
        let asePerSecond = 0;
        const unlockLevels = [ // Define niveles y recompensas del minijuego
            { name: 'Elegua', threshold: 50, effect: { aps: 1 }, icon: 'fas fa-key', color: '#D40000', bgColor: '#000000' }, // +1 APS
            { name: 'Ogun', threshold: 250, effect: { apc: 2 }, icon: 'fas fa-hammer', color: '#FFFFFF', bgColor: '#006400' }, // +2 APC
            { name: 'Oshun', threshold: 1000, effect: { aps: 5, bonusChance: 0.1, bonusMult: 5 }, icon: 'fas fa-water', color: '#000000', bgColor: '#FFBF00' }, // +5 APS, 10% chance x5 click
            { name: 'Shango', threshold: 4000, effect: { apc: 5 }, icon: 'fas fa-bolt', color: '#FFFFFF', bgColor: '#FF0000' }, // +5 APC
            { name: 'Yemaya', threshold: 10000, effect: { aps: 15 }, icon: 'fas fa-anchor', color: '#FFFFFF', bgColor: '#0077BE' }, // +15 APS
            { name: 'Obatala', threshold: 25000, effect: { apc: 10, aps: 10 }, icon: 'fas fa-dove', color: '#808080', bgColor: '#FFFFFF' }, // +10 APC, +10 APS
            { name: 'Orunmila', threshold: 75000, effect: { aps: 50, bonusChance: 0.05, bonusMult: 10}, icon: 'fas fa-book-open', color: '#8B4513', bgColor: '#32CD32'} // +50 APS, 5% chance x10 click
        ];
        let unlockedOrishaIndices = [];

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentTopic
                ? `Eres un asistente informado y respetuoso, especializado únicamente en el tema Yoruba '${currentTopic}'. Responde preguntas de seguimiento sobre sus detalles, contexto o prácticas relacionadas mencionadas en la descripción principal. Sé conciso, preciso y mantén siempre un tono respetuoso hacia la tradición.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            // Seed no relevante para chat o Yoruba (más determinismo no deseado aquí)
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text (Chat: ${isChat}): ${url.substring(0, 200)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, o la solicitud no pudo ser procesada. Por favor, intenta de nuevo en unos segundos.`);
                }
                const text = await response.text();
                 if (!text || text.trim().length < 50) { // Check for minimal length
                    throw new Error("La respuesta de la IA fue demasiado corta o vacía. Intenta de nuevo o con otro tema.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA. Intenta de nuevo.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopic) throw new Error("Error interno: Contexto no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(yorubaThemes) || "conceptos generales Yoruba";
            const specificPrompt = `Genera 40 ítems (Orishas, conceptos, rituales, etc.) sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 10) throw new Error("La IA no generó suficientes ideas nuevas."); // Pedimos 40, esperamos al menos 10
                     return titles.slice(0, 40); // Devolver hasta 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Yoruba spiritual concept";
            // Prompt ENFOCADO en arte simbólico/conceptual, NO fotos, NO diagramas. Respetuoso.
            const enhancedPrompt = `Symbolic artistic representation inspired by the Yoruba concept or Orisha '${safePromptText}'. Focus on atmosphere, natural elements (water, fire, earth, plants), abstract patterns, traditional Yoruba art influence (wood carving, beadwork style). Use a rich, natural color palette. Avoid depicting human figures unless essential and respectful. No text, labels. Evocative, spiritual, respectful interpretation.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
             const negativePrompt = "photorealistic, photograph, real person, face, diagram, chart, text, words, label, letters, map, flag, offensive, disrespectful, cartoonish, simple icon, logo, watermark, signature, multiple images, collage";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             // Basic Markdown & cleanup
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => `${base}<sup>${exponent.replace('−', '-')}</sup>`);
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             // Paragraph handling
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 // Replace single newlines within a block with spaces for better flow
                 let content = block.replace(/(?<!\n)\n(?!\n)/g, ' ');
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
        }

        // ========== MINIGAME FUNCTIONS ==========
        function startGame() {
            if (!minigameContainer || !defaultLoadingContent) return;
            console.log("Starting Minigame...");
            // Reset game state
            aseCount = 0;
            asePerClick = 1;
            asePerSecond = 0;
            unlockedOrishaIndices = [];
            updateGameUI(); // Initial UI state

            // Setup unlocks display
            orishaUnlocksContainer.innerHTML = '';
            unlockLevels.forEach((level, index) => {
                const iconEl = document.createElement('span');
                iconEl.className = 'orisha-icon';
                iconEl.id = `orisha-icon-${index}`;
                iconEl.title = `${level.name} (Bloqueado)`;
                iconEl.innerHTML = `<i class="${level.icon}"></i>`;
                // Set initial style using CSS variables for easier update later
                iconEl.style.setProperty('--color-icon-fg', '#999');
                iconEl.style.setProperty('--color-icon-bg', '#e0e0e0');
                orishaUnlocksContainer.appendChild(iconEl);
            });

            // Show game, hide spinner
            defaultLoadingContent.style.display = 'none';
            minigameContainer.style.display = 'flex';
            isGameActive = true;

            // Start game loop
            if (gameLoopInterval) clearInterval(gameLoopInterval);
            gameLoopInterval = setInterval(gameTick, 1000); // Update every second
        }
        function stopGame() {
            if (!isGameActive || !minigameContainer || !defaultLoadingContent) return;
            console.log("Stopping Minigame...");
            isGameActive = false;
            if (gameLoopInterval) {
                clearInterval(gameLoopInterval);
                gameLoopInterval = null;
            }
            // Hide game, show spinner/text again (or let content appear)
            minigameContainer.style.display = 'none';
            defaultLoadingContent.style.display = 'flex'; // Show default spinner until content loads
        }
        function gameTick() {
            if (!isGameActive) return;
            aseCount += asePerSecond;
            checkUnlocks();
            updateGameUI();
        }
        function handleAseClick() {
            if (!isGameActive) return;
            let clickValue = asePerClick;
            // Check for bonus chance from unlocks
            let bonusApplied = false;
             unlockedOrishaIndices.forEach(index => {
                 const level = unlockLevels[index];
                 if (level.effect.bonusChance && Math.random() < level.effect.bonusChance) {
                     clickValue *= (level.effect.bonusMult || 1);
                     console.log(`Bonus applied from ${level.name}!`);
                     bonusApplied = true; // Visual feedback could be added here
                 }
             });

            aseCount += clickValue;
             // Simple visual feedback on click
             aseClickTarget.style.transform = 'scale(0.9)';
             setTimeout(() => { aseClickTarget.style.transform = 'scale(1)'; }, 100);

            checkUnlocks();
            updateGameUI();
        }
        function checkUnlocks() {
             unlockLevels.forEach((level, index) => {
                 if (!unlockedOrishaIndices.includes(index) && aseCount >= level.threshold) {
                     console.log(`Unlocked ${level.name}!`);
                     unlockedOrishaIndices.push(index);
                     // Apply effects
                     if (level.effect.apc) asePerClick += level.effect.apc;
                     if (level.effect.aps) asePerSecond += level.effect.aps;
                     // Update icon style
                     const iconEl = document.getElementById(`orisha-icon-${index}`);
                     if (iconEl) {
                         iconEl.classList.add('unlocked');
                         iconEl.title = `${level.name} (Desbloqueado!)`;
                         // Apply specific colors if defined
                         if(level.color) iconEl.style.setProperty('--color-icon-fg', level.color);
                         if(level.bgColor) iconEl.style.setProperty('--color-icon-bg', level.bgColor);
                     }
                 }
             });
        }
        function updateGameUI() {
             if (!isGameActive || !aseDisplay || !asePerSecondDisplay) return;
             aseDisplay.textContent = `Asé: ${Math.floor(aseCount)}`;
             asePerSecondDisplay.textContent = `(${asePerSecond}/seg | ${asePerClick}/clic)`;
         }


        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             // Stop game if it was running
             if (isGameActive) stopGame();
             // Reset UI elements
             modalLoadingOverlay.style.display = 'flex'; // Show loading overlay initially
             defaultLoadingContent.style.display = 'flex'; // Show spinner initially
             minigameContainer.style.display = 'none'; // Hide game
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopic = null;
             hideFullscreenImage(); // Ensure fullscreen is closed
         }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios funcionales)
        function addChatMessage(message, sender) { /* ... */ const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errDiv=document.createElement('div');errDiv.className='chat-error';errDiv.textContent=message;chatHistory.appendChild(errDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */
             const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return;
             addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block';
             try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); }
             catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); }
             finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); }
         }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay entradas en el índice «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick to integrate Minigame ***
        async function handleTitleClick(title) {
            resetModalState(); // Resets everything including game state
            showModal();
            modalTitle.textContent = title; // Set title early
            currentTopic = title; // Set chat context
            modalError.classList.add('content-hidden');
            modalLoadingOverlay.style.display = 'flex'; // Ensure loading overlay is visible

            // *** START MINIGAME ***
            startGame();

            try {
                // Fetch the main content - THIS CAN TAKE TIME
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                 // *** STOP MINIGAME (on success) ***
                 stopGame(); // Stop before showing content
                 modalLoadingOverlay.style.display = 'none'; // Hide loading overlay

                modalContent.innerHTML = formattedExplanation; // Add text
                modalStoryContentArea.classList.remove('content-hidden'); // Show content area
                modalTextArea.scrollTop = 0; // Reset scroll

                // Image Placeholder & Loading (inside modalContent)
                const placeholderDiv = document.createElement('div'); /* ... as before */
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Generando representación visual...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img'); /* ... as before */
                imgElement.className = 'final-image';
                imgElement.alt = `Representación visual de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                 else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`; }

            } catch (error) {
                 // *** STOP MINIGAME (on error) ***
                 stopGame(); // Stop game even if fetch failed
                 modalLoadingOverlay.style.display = 'none'; // Hide loading overlay

                console.error("Failed display:", error);
                modalErrorMessage.textContent = error.message || "Ocurrió un error desconocido al cargar el contenido.";
                modalError.classList.remove('content-hidden');
                // Show the content area so the error is visible, but clear potentially partial content
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden'); // Hide chat on main error
            }
            // Note: 'finally' block isn't strictly needed here for stopping the game,
            // as it's stopped explicitly in both success and error paths *before* hiding the loader.
        }

        async function handleGenerateMoreTitles() {
             const btn = generateMoreBtn; // Alias for brevity
             const spinner = btn.querySelector('i');
             btn.disabled = true;
             spinner.classList.remove('hidden');
             btn.childNodes[btn.childNodes.length -1].nodeValue = " Buscando más..."; // Update text
             try {
                 const newTitles = await fetchGeneratedTitles(); // Requests 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron encontrar más temas en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar más temas: ${error.message}`);
             } finally {
                 btn.disabled = false;
                 spinner.classList.add('hidden');
                 btn.childNodes[btn.childNodes.length -1].nodeValue = " Expandir Conocimiento"; // Restore text
             }
         }

        // Search Filter Function (added normalize for accents)
        function filterTitles(searchTerm) {
            const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
            const titleItems = titleListContainer.querySelectorAll('.title-item');
            let visibleCount = 0;
            titleItems.forEach(item => {
                const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const isVisible = titleText.includes(term);
                item.classList.toggle('hidden', !isVisible);
                if (isVisible) visibleCount++;
            });
            noResultsMsg.classList.toggle('hidden', visibleCount > 0);
        }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check essential elements...
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameContainer || !aseClickTarget) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error crítico: No se pudieron cargar los componentes de la interfaz.</p>';
                 return;
             }
            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            // Minigame Listener
            aseClickTarget.addEventListener('click', handleAseClick);

            // Initial Display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>