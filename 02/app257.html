<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Santería: Historias y Conocimientos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes - Una más evocadora para títulos, una clara para cuerpo -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Santería --- */
        :root {
            --color-primary: #8B4513; /* Marrón Saddle Brown (Tierra, Ancestros) */
            --color-secondary: #FFFFFF; /* Blanco (Obatalá, Pureza) */
            --color-tertiary: #FFD700; /* Dorado (Oshún, Riqueza) - Acento */
            --color-accent-blue: #00008B; /* Azul Oscuro (Yemayá, Olokun) */
            --color-accent-red: #DC143C; /* Rojo Carmesí (Shangó, Ogun) */
            --color-accent-green: #006400; /* Verde Oscuro (Ogun, Orula) */
            --color-background: #fdfaf4; /* Blanco Hueso / Crema muy pálido */
            --color-text: #4d2c1a; /* Marrón oscuro para texto */
            --color-text-muted: #a0522d; /* Siena / Marrón más claro */
            --color-modal-bg: #fffefb; /* Blanco ligeramente crema para modal */
            --color-border: #d2b48c; /* Tan / Canela claro para bordes */
            --color-error-bg: #fde8e8; /* Fondo error rojo muy pálido */
            --color-error-text: #9b2c2c; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo claro */

            --shadow-sm: 0 2px 4px 0 rgba(139, 69, 19, 0.1);
            --shadow-md: 0 5px 8px -1px rgba(139, 69, 19, 0.15), 0 3px 5px -2px rgba(139, 69, 19, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(139, 69, 19, 0.2), 0 4px 6px -4px rgba(139, 69, 19, 0.15);
            --border-radius: 5px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; font-size: 1.9rem; }
        .navbar { background-color: rgba(255, 254, 251, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-secondary); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.2); outline: none; background-color: var(--color-secondary); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-secondary); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Lato'; font-size: 0.95rem; position: relative; overflow: hidden;}
        .title-item::before { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 3px; background-color: var(--color-primary); transition: width 0.3s ease; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #fef8f0; }
        .title-item:hover::before { width: 100%; }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-secondary); padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: none; box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { background-color: #6b310a; box-shadow: var(--shadow-md); transform: translateY(-1px); }
        #generate-more-btn:disabled { background-color: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-secondary); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(77, 44, 26, 0.9); /* Overlay marrón translúcido */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Altura para juego y contenido */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-secondary); transform: rotate(90deg); }
        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-modal-bg); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-accent-green); font-style: italic; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-accent-red); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(160, 82, 45, 0.3); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Loading Indicator & MINIGAME Area */
        #modal-loading { text-align: center; padding: 2rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 254, 251, 0.97); display: none; /* Hidden by default */ flex-direction: column; align-items: center; justify-content: space-around; /* Space out elements */ z-index: 55; border-radius: var(--border-radius); }
        #modal-loading.active { display: flex; } /* Show when loading */
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin-bottom: 1rem; }
        #modal-loading-text { font-weight: 400; color: var(--color-text); font-size: 1.2rem; font-family: 'Cinzel'; margin-bottom: 1.5rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Minigame Styles */
        #minigame-container { width: 90%; max-width: 450px; height: 200px; background-color: rgba(210, 180, 140, 0.2); border: 1px solid var(--color-border); border-radius: var(--border-radius); position: relative; overflow: hidden; box-shadow: inset 0 0 10px rgba(139, 69, 19, 0.1); }
        #minigame-info { position: absolute; top: 8px; left: 10px; right: 10px; display: flex; justify-content: space-between; font-size: 0.9rem; font-family: 'Lato'; font-weight: 700; color: var(--color-primary); padding: 0 5px; background: rgba(255,254,251,0.7); border-radius: 3px;}
        #minigame-instructions { font-size: 0.8rem; color: var(--color-text-muted); font-style: italic; margin-top: 0.7rem; font-family: 'Lato';}
        .minigame-item { position: absolute; font-size: 1.8rem; cursor: pointer; transition: transform 0.1s ease, opacity 0.3s ease; user-select: none; }
        .minigame-item:hover { transform: scale(1.2); }
        .item-clicked { transform: scale(0.8); opacity: 0; } /* Feedback on click */
        /* Example item colors (adjust based on icons used) */
        .item-shell { color: var(--color-secondary); text-shadow: 1px 1px 2px #aaa; } /* Cowrie */
        .item-candle { color: #ffcc33; } /* Yellow candle */
        .item-water { color: var(--color-accent-blue); } /* Blue water drop */
        .item-fire { color: var(--color-accent-red); } /* Red flame */
        .item-leaf { color: var(--color-accent-green); } /* Green leaf */
        .item-stone { color: #777; } /* Grey stone */

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(77, 44, 26, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-tertiary); box-shadow: var(--shadow-lg); background-color: var(--color-modal-bg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-tertiary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-tertiary); color: var(--color-primary); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-book-open mr-3 text-yellow-600"></i> <!-- Icono libro abierto / sabiduría -->
                     Historias de Santería
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Conocimiento y Tradición «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explorando la Regla de Ocha-Ifá</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Un viaje interactivo por los Orishas, patakís, rituales y conceptos fundamentales de la tradición afrocubana.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar Orisha, concepto, historia...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-feather-alt text-yellow-700 mr-2"></i> <!-- Icono Pluma/Escriba -->
                 Índice de Sabiduría
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los archivos ancestrales...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron entradas para esta búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar Más Conocimientos (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator WITH MINIGAME -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p id="modal-loading-text">Obteniendo sabiduría...</p>
                 <!-- Minigame Area -->
                 <div id="minigame-area" class="w-full flex flex-col items-center">
                      <h3 class="text-lg font-semibold font-['Cinzel'] text-primary mb-2">Juego de Ofrendas</h3>
                      <div id="minigame-container">
                           <!-- Items will be added here by JS -->
                           <div id="minigame-info">
                                <span id="minigame-score">Aché: 0</span>
                                <span id="minigame-level">Nivel: 1</span>
                           </div>
                      </div>
                      <p id="minigame-instructions">¡Recolecta las ofrendas antes de que desaparezcan!</p>
                 </div>
                 <!-- End Minigame Area -->
             </div>
             <!-- END Loading Indicator -->

             <!-- Content Area Wrapper (Scrollable Text) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Esta guía interactiva ofrece información general sobre la Regla de Ocha-Ifá (Santería) con fines educativos y de referencia cultural.</p>
              <p class="mt-1">Se recomienda consultar fuentes académicas y a practicantes respetados para un entendimiento profundo. Respete siempre las tradiciones.</p>
              <p class="mt-2">© 2025 Conocimiento Ancestral Interactivo</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Orishas Principales y Fundamentales
            "Elegguá (Eleguá, Eshu): El Dueño de los Caminos", "Oggún (Ogún): El Dueño del Hierro y la Guerra", "Oshosi (Ochosi): El Cazador y la Justicia", "Obatalá: Padre de Todos, Dueño de las Cabezas", "Yemayá: Madre del Mundo, Dueña del Mar", "Oshún (Ochún): Dueña del Río, Amor y Dulzura", "Shangó (Changó): Rey de la Religión, Dueño del Fuego y el Tambor", "Oyá (Yansa): Dueña del Cementerio, Vientos y Centella", "Aggayú Solá: El Gigante, Dueño del Volcán y el Desierto", "Orula (Orunmila): El Orisha de la Adivinación, Testigo de la Creación", "Babalú Ayé (San Lázaro): Orisha de las Enfermedades y la Curación", "Olokun: Deidad Profunda del Océano", "Ibeyis (Jimaguas): Los Gemelos Divinos", "Osain (Ozain): Dueño de las Hierbas y Secretos del Monte", "Inle: El Médico Divino, Orisha de la Pesca", "Orisha Oko: Deidad de la Agricultura y la Fertilidad", "Dadá: Orisha de los Recién Nacidos y Vegetales", "Naná Burukú: Anciana Deidad de los Pantanos y la Muerte", "Obba: Orisha del Matrimonio y Sacrificio", "Yewá: Orisha de la Muerte y Castidad", "Asowano (Babalú Ayé): Camino específico", "Iroko: La Ceiba Sagrada", "Oduduwa (Oddua): Considerado Creador de la Tierra", "Olofi / Olorun / Olodumare: La Deidad Suprema Trina",
            // Conceptos Fundamentales
            "Aché (Ashé): La Energía Vital Universal", "Ifá: El Sistema de Adivinación y Cuerpo Literario", "Regla de Ocha (Santería): Sincretismo y Orígenes", "Regla de Ifá: Sacerdocio de los Babalawos", "Patakí: Las Historias Sagradas de los Orishas", "Ebbó: Las Ofrendas y Sacrificios", "Diloggún: Adivinación con Caracoles", "Obí: Adivinación con Coco", "Omiero: Líquido Sagrado de Hierbas", "Iyawó (Iyabó): El Iniciado en Kariosha", "Kariosha (Hacer Santo): Ceremonia de Iniciación Principal", "Padrino y Madrina (Babalorisha / Iyalorisha)", "Babalawo: Sacerdote de Ifá", "Oriaté: Maestro de Ceremonias en Kariosha", "Adimú: Ofrendas sencillas de comida", "Igba: La Jícara Sagrada", "Otanes: Las Piedras Sagradas de los Orishas", "Elekes (Collares): Símbolos de los Orishas", "Guerreros (Elegguá, Oggún, Oshosi, Osun)", "Osun: El Vigilante del Ori", "Eggun: Los Espíritus de los Ancestros", "Misa Espiritual: Comunicación con los Eggun", "Bóveda Espiritual: Altar para los Ancestros", "Casa de Santo (Ilé Osha): El Templo Religioso", "Tambor Batá: Los Tambores Sagrados", "Toque de Santo (Bembé): Fiesta religiosa con tambores", "Montarse (Posesión Espiritual)", "Caminos de los Orishas: Avatares o Manifestaciones", "Sincretismo Religioso: Orishas y Santos Católicos", "Iré: La Suerte, Bendición o Bienestar", "Osorbo (Ogguo): La Negatividad o Dificultad", "Oddun (Odu): Los Signos de Ifá y Diloggún", "Tabú (Ewe): Prohibiciones Personales", "Ori: La Cabeza como Deidad Personal", "Libreta de Santo (Itá): Registro de la Iniciación", "Derecho: Pago por Ceremonias o Consultas",
            // Rituales y Ceremonias Importantes
            "Entrega de Elekes (Collares)", "Entrega de Guerreros", "Ceremonia de 'Mano de Orula' (Awofakan / Ikofafun)", "Rogación de Cabeza (Kobori Eleda)", "Limpieza Espiritual (Saranyenye)", "Baños Lustrales con Hierbas", "Ceremonia del Río (Para Oshún)", "Ceremonia del Mar (Para Yemayá)", "Dar de Comer a la Tierra", "Cajón de Muerto: Ceremonia para Eggun", "Itutu: Ceremonia Funeraria", "Pinaldo (Cuchillo): Ceremonia para Sacrificar", "Lavatorio de Santo: Purificación de Objetos Sagrados", "Presentación al Tambor", "Matanza (Sacrificio Animal): Significado y Ética", "Plaza: Ceremonia de Mercado Simbólico", "Cumpleaños de Santo", "Bajadas de Orishas (Consultas especiales)",
            // Herramientas y Atributos
            "Herramientas de Oggún", "Herramientas de Oshosi", "Maraca de Shangó (Aché)", "Abanico de Oshún (Abebé)", "Corona de Obatalá", "Ancla o Sol de Yemayá", "Garabato de Elegguá", "Machete de Oggún", "Arco y Flecha de Oshosi", "Pilón de Shangó", "Tinaja de Olokun", "Muletas de Babalú Ayé", "Iruke: Cola de Caballo Ceremonial", "Tablero de Ifá (Opón Ifá)", "Ikin Ifá: Nueces de Palma Sagradas", "Okpele (Ekuele): Cadena de Adivinación de Ifá", "Cascarilla (Efun): Yeso Sagrado", "Manteca de Corojo (Epó)", "Manteca de Cacao (Orí)", "Pimienta de Guinea (Ataré)", "Miel de Abejas (Oñi)", "Aguardiente (Otí)", "Tabaco (Achá)", "Velas (Ataná)",
            // Aspectos Culturales e Históricos
            "Orígenes Yorubas de la Santería", "La Trata de Esclavos y la Diáspora Africana", "Cabildos Afrocubanos", "Figuras Históricas de la Santería en Cuba", "Expansión de la Santería a otros países", "Relación entre Santería, Palo Mayombe y Espiritismo", "Persecución y Resistencia de la Religión", "Representación de la Santería en el Arte y la Música", "Influencia en la Cultura Cubana", "Debates y Controversias Modernas", "Ética y Práctica Responsable", "La Santería en la Actualidad", "El Papel de la Mujer en la Santería", "Jerarquía Sacerdotal",
            // Preguntas Comunes y Mitos
            "¿La Santería es magia negra?", "¿Se adoran estatuas de santos?", "¿Qué significa 'ser hijo de un Orisha'?", "¿Es necesario el sacrificio animal?", "¿Cualquiera puede iniciarse?", "¿Qué diferencia hay entre un Santero y un Babalawo?", "¿Qué es el 'ángel de la guarda' en Santería?", "¿Cómo funcionan las consultas?", "¿Se puede practicar Santería y otra religión?", "Mitos comunes sobre Elegguá", "Leyendas sobre la creación del mundo según Ifá", "Historias de amor entre Orishas", "Patakís sobre la rivalidad entre Oggún y Shangó", "El viaje de Obatalá", "Las pruebas de Oshún", "Las aventuras de los Ibeyis",
             // ... Añadir más conceptos específicos, patakís detallados, caminos de Orishas, etc. El botón "Generar Más" ayudará.
        ];
        const santeriaThemes = [ // Para 'Generar Más'
            "Orishas principales", "Orishas menores", "Patakís de Shangó", "Patakís de Yemayá", "Conceptos de Ifá", "Rituales de iniciación", "Ceremonias para Eggun", "Adivinación en Santería", "Hierbas sagradas (Ewe)", "Sincretismo religioso", "Historia de la Regla de Ocha", "Ética en la Santería", "Instrumentos musicales sagrados", "Atributos de los Orishas", "Oddun de Ifá específicos", "Preguntas frecuentes sobre Santería", "Mitos y leyendas Yorubas", "La diáspora Yoruba", "Santería fuera de Cuba", "Relación con otras religiones afroamericanas"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral", // O un modelo más potente si está disponible y es necesario
            systemPrompt: "Eres un Olosha (Santero/a) mayor y respetado, o un Babalawo con profundo conocimiento de la Regla de Ocha-Ifá (Santería). Tu propósito es explicar de manera clara, respetuosa y precisa el Orisha, concepto, patakí, ritual o tema indicado. Evita el sensacionalismo y el lenguaje vulgar. Enfócate en la tradición afrocubana. Describe los aspectos fundamentales, simbolismo, relevancia y contexto dentro de la religión. Si es un Orisha, menciona sus dominios, colores, números, herramientas básicas y algún patakí relevante. Si es un concepto, define su significado e importancia. Si es un ritual, explica su propósito general (sin revelar secretos iniciáticos). Mantén un tono informativo y reverente. Extensión aproximada: 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tema de la Santería:",
            timeoutSeconds: 150 // Mantener o aumentar ligeramente si es necesario
        };
        const titleGenerationConfig = { // Para generar más títulos
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso sobre la Regla de Ocha-Ifá (Santería). Genera exactamente 40 nombres de Orishas (incluyendo caminos específicos si es posible), conceptos religiosos, tipos de rituales, patakís importantes, herramientas sagradas o preguntas comunes sobre la Santería. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas. Asegura variedad y relevancia dentro de la tradición afrocubana.",
            timeoutSeconds: 60 // Aumentar ligeramente para 40 títulos
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        // Loading & Game Elements
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Contenedor principal de carga/juego
        const modalLoadingSpinner = modalLoadingIndicator.querySelector('.loading-spinner-modal');
        const modalLoadingText = document.getElementById('modal-loading-text');
        const minigameArea = document.getElementById('minigame-area');
        const minigameContainer = document.getElementById('minigame-container');
        const minigameScoreDisplay = document.getElementById('minigame-score');
        const minigameLevelDisplay = document.getElementById('minigame-level');
        // Content Area
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== MINIGAME STATE & CONFIG ==========
        let gameActive = false;
        let gameScore = 0;
        let gameLevel = 1;
        let clicksNeededForNextLevel = 10;
        let itemSpawnInterval;
        let itemLifespanTimeout;
        const gameConfig = {
            spawnRateMs: 1200, // Initial spawn rate
            minSpawnRateMs: 400, // Fastest spawn rate at higher levels
            itemLifespanMs: 3500, // How long items stay on screen
            minItemLifespanMs: 1500, // Fastest lifespan
            levelUpMultiplier: 1.8, // How much harder the next level gets
            spawnRateDecrease: 100, // How much faster items spawn per level
            lifespanDecrease: 200 // How much shorter items live per level
        };
        const gameItems = [ // Font Awesome icons & classes
            { icon: 'fa-regular fa-circle', class: 'item-shell', value: 1 }, // Simulate cowrie shell
            { icon: 'fa-solid fa-candle-holder', class: 'item-candle', value: 1 },
            { icon: 'fa-solid fa-droplet', class: 'item-water', value: 1 },
            { icon: 'fa-solid fa-fire-flame-curved', class: 'item-fire', value: 1 },
            { icon: 'fa-solid fa-leaf', class: 'item-leaf', value: 1 },
            { icon: 'fa-solid fa-cubes-stacked', class: 'item-stone', value: 1 }, // Simulate stones/otanes
             { icon: 'fa-solid fa-drum', class: 'item-drum', value: 2 }, // Tambor - more points?
            { icon: 'fa-solid fa-feather', class: 'item-feather', value: 2 } // Pluma - more points?
        ];


        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) {
            const encodedPrompt = encodeURIComponent(prompt);
            const encodedSystem = encodeURIComponent(config.systemPrompt);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                     // *** MENSAJE DE ERROR AMIGABLE ***
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento. Por favor, intenta de nuevo en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("La respuesta de la IA llegó vacía. Puede ser un tema muy específico o un error temporal.");
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Tu conexión puede ser lenta o los servidores están ocupados.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }
        async function fetchExplanationText(conceptTitle) {
             return fetchTextFromApi(conceptTitle, textApiConfig);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(santeriaThemes) || "conceptos generales de Santería";
            const specificPrompt = `Genera 40 ítems sobre ${randomTheme}`;
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            return fetchTextFromApi(specificPrompt, configForThisRequest)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 10) throw new Error("La IA no generó suficientes ideas nuevas."); // Ajustar umbral si es necesario
                     return titles.slice(0, 40); // Asegurarse de devolver hasta 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Santeria spiritual concept";
             // Prompt ENFOCADO en simbolismo, atmósfera, colores. MUY CUIDADOSO con representaciones.
             const enhancedPrompt = `Symbolic and atmospheric representation inspired by the Santería (Regla de Ocha) concept of '${safePromptText}'. Focus on abstract elements, nature (sea, river, forest, fire, wind), relevant colors (white, blue, yellow, red, green, brown), light, energy flow, intricate patterns like beadwork or shells. Evocative and respectful mood.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // NEGATIVE PROMPT crucial aquí
             const negativePrompt = "photorealistic human figures, deities, faces, saints, jesus, catholic imagery, disrespectful stereotypes, cartoonish, simplistic, text, words, labels, captions, ugly, deformed, blurry, low quality, watermark, signature, direct representation of Orisha unless specifically requested and done abstractly";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (Same as previous version) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
             endMinigame(); // Asegurarse de detener el juego
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.classList.remove('active'); // Ocultar carga/juego
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = ''; // Limpia texto e imagen
             modalErrorMessage.textContent = '';
             endMinigame(); // Asegurarse de limpiar estado del juego
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (Same as previous version) ... */
             if (!imageFullscreenOverlay || !fullscreenImage) return;
             fullscreenImage.src = imgSrc;
             imageFullscreenOverlay.classList.add('active');
             document.body.style.overflow = 'hidden';
         }
        function hideFullscreenImage() { /* ... (Same as previous version) ... */
             if (!imageFullscreenOverlay) return;
             imageFullscreenOverlay.classList.remove('active');
             if (!storyModal.classList.contains('active')) {
                  document.body.style.overflow = '';
             }
             fullscreenImage.src = '';
         }

        // ========== MINIGAME FUNCTIONS ==========
        function updateGameDisplay() {
            minigameScoreDisplay.textContent = `Aché: ${gameScore}`;
            minigameLevelDisplay.textContent = `Nivel: ${gameLevel}`;
        }

        function levelUp() {
            gameLevel++;
            gameScore = 0; // Reset score for next level or keep accumulating? Let's keep accumulating for now.
            clicksNeededForNextLevel = Math.floor(clicksNeededForNextLevel * gameConfig.levelUpMultiplier);
            // Make game harder
            gameConfig.spawnRateMs = Math.max(gameConfig.minSpawnRateMs, gameConfig.spawnRateMs - gameConfig.spawnRateDecrease);
            gameConfig.itemLifespanMs = Math.max(gameConfig.minItemLifespanMs, gameConfig.itemLifespanMs - gameConfig.lifespanDecrease);

            console.log(`Level Up! Nivel ${gameLevel}, Next: ${clicksNeededForNextLevel} clicks. Spawn: ${gameConfig.spawnRateMs}ms, Lifespan: ${gameConfig.itemLifespanMs}ms`);
            updateGameDisplay();

            // Restart spawn interval with new rate
            clearInterval(itemSpawnInterval);
            itemSpawnInterval = setInterval(spawnGameItem, gameConfig.spawnRateMs);
        }

        function handleItemClick(event) {
            if (!gameActive) return;
            const itemElement = event.target;
            const itemValue = parseInt(itemElement.dataset.value || 1);

            gameScore += itemValue;
            updateGameDisplay();

            // Visual feedback
            itemElement.classList.add('item-clicked');
            // Remove after animation/transition
            setTimeout(() => {
                 if(itemElement.parentNode) { // Check if still exists
                      itemElement.remove();
                 }
            }, 300); // Match this with CSS transition duration

            // Check for level up
            if (gameScore >= clicksNeededForNextLevel) {
                levelUp();
            }
        }

        function spawnGameItem() {
            if (!gameActive || !minigameContainer) return;

            const itemData = getRandomElement(gameItems);
            const itemElement = document.createElement('i');
            itemElement.className = `fas ${itemData.icon} minigame-item ${itemData.class}`;
            itemElement.dataset.value = itemData.value;

            // Random position within the container
            const containerRect = minigameContainer.getBoundingClientRect();
            // Adjust for item size to prevent overflow
            const maxLeft = containerRect.width - 30;
            const maxTop = containerRect.height - 30;
            itemElement.style.left = `${Math.random() * maxLeft}px`;
            itemElement.style.top = `${Math.random() * maxTop}px`;

            itemElement.addEventListener('click', handleItemClick);
            minigameContainer.appendChild(itemElement);

            // Make item disappear after a while
             const currentLifespan = gameConfig.itemLifespanMs;
            setTimeout(() => {
                 if (itemElement.parentNode) { // Check if it wasn't clicked and removed already
                    itemElement.style.opacity = '0'; // Fade out
                    setTimeout(() => { // Remove from DOM after fade
                        if(itemElement.parentNode) itemElement.remove();
                    }, 300); // Match opacity transition
                 }
            }, currentLifespan);
        }

        function startMinigame() {
            console.log("Starting Minigame");
            gameActive = true;
            gameScore = 0;
            gameLevel = 1;
            clicksNeededForNextLevel = 10; // Reset clicks needed
            // Reset dynamic config values to initial state if modified previously
             gameConfig.spawnRateMs = 1200;
             gameConfig.itemLifespanMs = 3500;

            updateGameDisplay();
            minigameContainer.innerHTML = ''; // Clear previous items
             // Start spawning items
            clearInterval(itemSpawnInterval); // Clear any previous interval
            itemSpawnInterval = setInterval(spawnGameItem, gameConfig.spawnRateMs);
             modalLoadingIndicator.classList.add('active'); // Ensure loading overlay is visible
             minigameArea.classList.remove('content-hidden'); // Show game area
        }

        function endMinigame() {
            console.log("Ending Minigame");
            gameActive = false;
            clearInterval(itemSpawnInterval);
            if (minigameContainer) minigameContainer.innerHTML = ''; // Clear items
             if (minigameArea) minigameArea.classList.add('content-hidden'); // Hide game area
             // Do not hide the entire modalLoadingIndicator here, it's controlled elsewhere
        }


        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay entradas en los archivos ancestrales «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to integrate minigame start/stop ***
        async function handleTitleClick(title) {
            resetModalState(); // Reset general state
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.classList.add('active'); // Show loading overlay
            modalStoryContentArea.classList.add('content-hidden'); // Hide content area initially

            startMinigame(); // *** START THE MINIGAME ***

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                endMinigame(); // *** STOP MINIGAME on success ***
                modalLoadingIndicator.classList.remove('active'); // Hide loading overlay
                modalContent.innerHTML = formattedExplanation; // Add text
                modalStoryContentArea.classList.remove('content-hidden'); // Show content area

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-om placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Creando reflejo visual...</p>`; // Icono Om/Espiritual
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación simbólica de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Reflejo visual no disponible.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                endMinigame(); // *** STOP MINIGAME on error ***
                modalLoadingIndicator.classList.remove('active'); // Hide loading overlay
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar sabiduría.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 items ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando Oráculos...';
             try {
                 // Request 40 titles
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Los oráculos no revelaron nuevos conocimientos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al consultar los oráculos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Revelar Más Conocimientos (40)';
             }
         }

        // *** Search Filter Function (sin cambios) ***
        function filterTitles(searchTerm) { /* ... (Same as previous version, check normalization) ... */
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameContainer) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #8B4513; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: \'Cinzel\';">Maferefun Olofi! Ha ocurrido un error al cargar los componentes de la página.</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            minigameArea.classList.add('content-hidden'); // Ensure game area is hidden initially
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>