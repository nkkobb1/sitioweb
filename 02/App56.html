<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glosario Jurídico - Nivel Intermedio</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #2563eb; /* Blue-600 */
            --color-secondary: #7e22ce; /* Purple-700 */
            --color-background: #f9fafb; /* Gray-50 */
            --color-text: #1f2937;      /* Gray-800 */
            --color-text-muted: #6b7280; /* Gray-500 */
            --color-modal-bg: #ffffff;
            --color-border: #e5e7eb;    /* Gray-200 */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); }
        h1, h2, h3, h4, .logo { font-family: 'Quicksand', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; } /* Wider minmax */
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1d4ed8; box-shadow: var(--shadow-sm); } /* Darker blue */
        #generate-more-btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.8); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem; max-width: 900px; width: 95%; max-height: 90vh; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; } /* Slightly wider max-width */
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e5e7eb; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.4rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #d1d5db; color: var(--color-text); }
        #modal-title { color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; font-size: 1.6rem; } /* Slightly larger title */
        #modal-content { line-height: 1.7; color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 10px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content::-webkit-scrollbar { width: 8px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.2em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Quicksand', sans-serif; margin-top: 1.8em; margin-bottom: 0.8em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.3em; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.2em; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-secondary); }
        #modal-content .formula { /* Keep for potential math/logic terms */ text-align: center; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 1.1em; padding: 0.8em; margin: 1.2em 0; border: 1px solid var(--color-border); background-color: #f9fafb; border-radius: var(--border-radius); overflow-x: auto; white-space: nowrap; }
        #modal-content .formula sub, #modal-content .formula sup { font-size: 0.8em; line-height: 0; position: relative; vertical-align: baseline; }
        #modal-content .formula sub { top: 0.5em; }
        #modal-content .formula sup { top: -0.5em; }
        #modal-image-container { width: 100%; height: 220px; background-color: #f3f4f6; border-radius: var(--border-radius); overflow: hidden; display: none; /* Start hidden */ align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; margin-top: 1rem; }
        #modal-image-container.visible { display: flex; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 2.5rem; color: var(--color-border); display: none; }
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: var(--border-radius); border: 1px solid #fecaca; margin-top: 1rem; text-align: center; flex-shrink: 0; }
        .error-msg i { margin-right: 0.5rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-3 flex justify-center items-center">
             <div class="flex items-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-balance-scale mr-2"></i> Glosario Jurídico Intermedio
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Descifrando el Lenguaje Legal</h1>
             <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Explora conceptos clave del derecho con explicaciones claras por IA. ¡Selecciona un término para profundizar!</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-book-open text-purple-700 mr-2"></i>
                 Términos a Explorar
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Buscando jurisprudencia...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Términos
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Compilando definición...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                 </div>
                  <!-- Image Container (Initially Hidden) -->
                 <div id="modal-image-container">
                     <div class="spinner"></div>
                     <i class="fas fa-landmark placeholder-icon"></i> <!-- Placeholder icon -->
                     <img id="modal-image" alt="Visualización abstracta del concepto legal" />
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-circle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-5 mt-12 border-t border-gray-200">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA con fines educativos e informativos. No constituyen asesoramiento legal. Consulte siempre a un profesional del derecho.</p>
              <p class="mt-1">© 2025 Glosario Jurídico Intermedio</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [ // Expanded List - Aim for variety and intermediate level
            "Contrato de Arrendamiento Urbano", "Recurso de Apelación Civil", "Habeas Corpus: Procedimiento y Ámbito", "Sociedad de Responsabilidad Limitada (SRL)", "Sociedad Anónima (S.A.): Características", "Delito Doloso vs. Delito Culposo", "Responsabilidad Civil Extracontractual", "Prescripción Adquisitiva (Usucapión)", "Nulidad Absoluta vs. Nulidad Relativa", "Derecho de Sucesiones: Herencia y Legado", "Principio de Legalidad Penal", "Principio de Tipicidad", "Cosa Juzgada Formal y Material", "Jurisprudencia Vinculante", "Acto Administrativo: Elementos y Vicios", "Recurso Contencioso-Administrativo", "Medidas Cautelares en Proceso Civil", "Concurso de Acreedores Voluntario", "Propiedad Intelectual: Derechos de Autor", "Marcas y Patentes: Registro y Protección", "Litigio Estratégico: Concepto y Fines", "Debido Proceso Legal (Garantías)", "Acción de Amparo o Tutela", "Contrato de Compraventa Mercantil", "Letra de Cambio y Pagaré", "Cheque: Tipos y Endoso", "Responsabilidad Penal de las Personas Jurídicas", "Derecho Ambiental: Principios Rectores", "Delitos contra la Administración Pública", "Prevaricación Administrativa", "Cohecho (Soborno)", "Tráfico de Influencias", "Malversación de Caudales Públicos", "Derecho Laboral: Contrato de Trabajo", "Despido Improcedente vs. Nulo", "Convenio Colectivo de Trabajo", "Seguridad Social: Cotizaciones y Prestaciones", "Derecho Fiscal: Impuesto sobre la Renta (IRPF/ISR)", "Impuesto sobre el Valor Añadido (IVA/VAT)", "Impuesto de Sociedades", "Planificación Fiscal vs. Evasión Fiscal", "Derecho Internacional Público: Fuentes", "Tratados Internacionales: Celebración y Efectos", "Corte Internacional de Justicia (CIJ)", "Derecho Internacional Humanitario", "Derecho de la Unión Europea (si aplica): Principios", "Instituciones de la UE (Parlamento, Comisión, Consejo)", "Derecho Mercantil: Competencia Desleal", "Defensa de la Competencia (Antitrust)", "Contratos de Distribución y Agencia", "Contrato de Franquicia", "Arbitraje Comercial Nacional e Internacional", "Mediación y Conciliación", "Derecho Procesal Civil: Demanda y Contestación", "Prueba en el Proceso Civil (Documental, Testifical, Pericial)", "Sentencia Civil: Contenido y Efectos", "Ejecución de Sentencias", "Derecho Procesal Penal: Fases (Instrucción, Juicio Oral)", "Ministerio Fiscal (Fiscalía): Funciones", "Prueba en el Proceso Penal", "Presunción de Inocencia", "Recurso de Casación Penal", "Derecho Constitucional: Control de Constitucionalidad", "Tribunal Constitucional: Funciones", "Derechos Fundamentales: Protección", "Separación de Poderes", "Formas de Gobierno y Estado", "Contrato de Seguro: Póliza y Siniestro", "Contrato de Transporte Terrestre", "Propiedad Horizontal (Comunidades de Propietarios)", "Servidumbres Legales y Voluntarias", "Derecho de Superficie", "Contrato de Préstamo Bancario", "Garantías Reales: Hipoteca y Prenda", "Garantías Personales: Fianza", "Derecho de Familia: Régimen Económico Matrimonial", "Divorcio y Separación: Procedimientos", "Filiación: Determinación y Efectos", "Adopción Nacional e Internacional", "Responsabilidad Médica (Mala Praxis)", "Protección de Datos Personales (GDPR o similar)", "Comercio Electrónico: Regulación", "Contratos Informáticos (Licencias, Desarrollo)", "Firma Electrónica: Validez Legal", "Delitos Informáticos (Ciberdelincuencia)", "Extradición Activa y Pasiva", "Orden Europea de Detención y Entrega (si aplica)", "Asilo y Refugio", "Nacionalidad y Extranjería", "Recurso de Inconstitucionalidad", "Cuestión de Inconstitucionalidad", "Derecho Urbanístico: Licencias y Planificación", "Expropiación Forzosa", "Bienes de Dominio Público", "Contratos del Sector Público (Licitaciones)", "Procedimiento Administrativo Sancionador", "Silencio Administrativo Positivo y Negativo", "Responsabilidad Patrimonial de la Administración", "Derecho Bancario: Productos Financieros", "Supervisión Bancaria (Banco Central)", "Mercado de Valores: Regulación", "Oferta Pública de Adquisición (OPA)", "Sociedades Cotizadas: Obligaciones", "Auditoría de Cuentas", "Propiedad Industrial: Diseños Industriales", "Secreto Empresarial", "Competencia Judicial Internacional", "Ley Aplicable a Contratos Internacionales", "Exequátur: Reconocimiento de Sentencias Extranjeras", "Laudo Arbitral Internacional", "Derecho del Mar: Zonas Marítimas", "Derecho Aeronáutico y Espacial", "Teoría General del Contrato: Elementos Esenciales", "Vicios del Consentimiento (Error, Dolo, Violencia)", "Interpretación de los Contratos", "Incumplimiento Contractual y Remedios", "Cláusula Penal", "Resolución y Rescisión Contractual", "Teoría General de la Obligación", "Fuentes de las Obligaciones", "Clases de Obligaciones (Dar, Hacer, No Hacer)", "Obligaciones Solidarias y Mancomunadas", "Pago o Cumplimiento", "Mora del Deudor y del Acreedor", "Daño Emergente y Lucro Cesante", "Causa y Objeto del Contrato", "Forma de los Contratos", "Representación Voluntaria y Legal", "Mandato y Poder Notarial", "Gestión de Negocios Ajenos sin Mandato", "Enriquecimiento Injusto (sin causa)", "Abuso del Derecho", "Buena Fe Contractual", "Derechos Reales Limitados (Usufructo, Uso, Habitación)", "Posesión: Concepto y Protección", "Interdictos Posesorios", "Acción Reivindicatoria", "Acción Declarativa de Dominio", "Tercería de Dominio", "Registro de la Propiedad (o similar): Principios", "Inmatriculación de Fincas", "Fe Pública Registral", "Hipoteca Mobiliaria y Prenda sin Desplazamiento"
        ];
        const legalThemes = [ // Themes for generating more terms
            "derecho civil (contratos)", "derecho civil (obligaciones)", "derecho civil (reales)", "derecho de sucesiones", "derecho de familia", "derecho mercantil (sociedades)", "derecho mercantil (títulos valores)", "derecho mercantil (contratos)", "derecho concursal", "propiedad intelectual e industrial", "derecho penal (parte general)", "derecho penal (parte especial)", "derecho procesal civil", "derecho procesal penal", "recursos judiciales", "derecho administrativo (general)", "contratación pública", "derecho urbanístico", "derecho ambiental", "derecho constitucional", "protección de derechos fundamentales", "derecho internacional público", "derecho internacional privado", "derecho de la Unión Europea", "derecho laboral", "seguridad social", "derecho fiscal (tributario)", "derecho bancario", "mercado de valores", "protección de datos", "derecho digital", "arbitraje y mediación", "filosofía del derecho"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un jurista experto y un excelente comunicador. Tu tarea es explicar términos o conceptos jurídicos de nivel intermedio de forma muy clara, precisa y detallada para estudiantes de derecho o profesionales que buscan profundizar. Utiliza definiciones rigurosas pero comprensibles, ejemplos prácticos (quizás pequeños casos hipotéticos), referencias a principios legales relevantes y estructura la explicación lógicamente usando párrafos y subtítulos (formato markdown #, ##, ###, ####). Evita la jerga excesiva o defínela claramente. El objetivo es una explicación exhaustiva y fácil de seguir de unas 1200-1300 palabras. Basa tu explicación únicamente en el siguiente término o concepto:",
            timeoutSeconds: 150 // Increased timeout
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso. Genera exactamente 15 términos o conceptos jurídicos de nivel intermedio, adecuados para ser explicados detalladamente. Devuelve *solo* la lista de términos/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 30
        };

        // ========== DOM ELEMENTS ========== (sin cambios)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // --- Variable to hold the current scroll listener ---
        let currentScrollHandler = null;

        // ========== API FUNCTIONS ========== (sin cambios en la lógica interna)
        async function fetchTextFromApi(prompt, config) {
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}) - Timeout: ${config.timeoutSeconds}s: ${url}`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
             }
         }
        async function fetchExplanationText(conceptTitle) {
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
             // Adjusted word count check slightly lower to be less strict, API might not hit exact target
              if (text.trim().length < 1000 || text.toLowerCase().includes("cannot fulfill")) {
                   throw new Error("La IA no pudo generar una explicación adecuada o suficientemente detallada para este término.");
               }
             return text;
         }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(legalThemes) || "conceptos jurídicos generales";
             const specificPrompt = `Genera 15 términos o conceptos jurídicos de nivel intermedio sobre ${randomTheme}`;
             console.log("Generating terms with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150); // Increased max length slightly
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de términos.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "legal concept abstract";
             // Enhanced prompt for abstract legal visuals
             const enhancedPrompt = `Abstract symbolic representation of the legal concept '${safePromptText}', minimalist style, conceptual art, focus on balance, structure, or justice`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Stronger negative prompt against literal representations
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, paragraphs, sentences, paragraphs, documents, book pages, specific laws, articles, codes, courtroom, judge, lawyer, people, jury, gavel, scales of justice (literal), columns (literal), police, handcuffs, prison bars, realistic photo, signature, logo, diagram, chart, graph, illustration with text";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            // LaTeX-like elements first
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            // LaTeX Display Math
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            // Markdown Headings
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            // Markdown Bold/Italics
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Paragraphs
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, '<br>'); // Treat single newlines within a block as <br>
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Lógica de scroll y listener sin cambios)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll on close
            console.log("Scroll set to 0 on hideModal");
            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
                console.log("Scroll listener removed on hideModal.");
            }
            resetModalState();
        }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.classList.remove('visible');
             modalImageContainer.style.display = 'none';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (Lógica de scroll y listener sin cambios)
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]);
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay términos disponibles.</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalImageContainer.style.display = 'none';
            modalImageContainer.classList.remove('visible');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
            }

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;

                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.scrollTop = 0; // <<<--- RESET SCROLL HERE
                console.log("Scroll set to 0 after content visible");

                modalImageSpinner.style.display = 'block';
                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL:", title);
                     modalImageSpinner.style.display = 'none';
                     modalImagePlaceholder.style.display = 'block';
                 }

                const scrollBuffer = 15;
                currentScrollHandler = () => {
                    if (modalContent.scrollHeight <= modalContent.clientHeight) {
                         console.log("Content fits, showing image immediately.");
                         modalImageContainer.classList.add('visible');
                         modalImageContainer.style.display = 'flex';
                         modalContent.removeEventListener('scroll', currentScrollHandler);
                         currentScrollHandler = null;
                    } else if ((modalContent.scrollTop + modalContent.clientHeight) >= (modalContent.scrollHeight - scrollBuffer)) {
                        console.log("Scroll end reached, showing image.");
                        modalImageContainer.classList.add('visible');
                        modalImageContainer.style.display = 'flex';
                        modalContent.removeEventListener('scroll', currentScrollHandler);
                        currentScrollHandler = null;
                        console.log("Scroll listener removed after showing image.");
                    }
                };
                modalContent.addEventListener('scroll', currentScrollHandler);
                console.log("Scroll listener added.");
                 setTimeout(currentScrollHandler, 100);

            } catch (error) {
                console.error("Failed to display explanation:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error al cargar: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = '';
                 if (currentScrollHandler) {
                    modalContent.removeEventListener('scroll', currentScrollHandler);
                    currentScrollHandler = null;
                 }
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando doctrina...'; // Themed loading text
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se pudieron generar nuevos términos en este momento."); }
             } catch (error) { console.error("Failed term generation:", error); alert(`Error: ${error.message}`);
             } finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Términos'; }
         }

        // ========== INITIALIZATION ========== (sin cambios)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p>Error crítico al inicializar.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>