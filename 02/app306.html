<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas de Civilizaciones Perdidas y Misterios</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Google -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- *** NUEVO: Preload Font Awesome Solid font file *** -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">

    <style>
        /* --- Estilos Adaptados: Lost Civilizations & Theories --- */
        :root {
            --color-primary: #8B4513; /* Marrón Tierra/Madera */
            --color-secondary: #008080; /* Teal/Turquesa Misterioso */
            --color-tertiary: #FFD700; /* Oro Antiguo */
            --color-background: #F5F5DC; /* Beige/Papiro */
            --color-text: #3D405B; /* Gris Azulado Oscuro */
            --color-text-muted: #707070; /* Gris Medio */
            --color-modal-bg: #FAF0E6; /* Lino */
            --color-border: #C19A6B; /* Camel/Arenisca */
            --color-locked-bg: #E0DCD1; /* Gris Piedra Claro */
            --color-locked-text: #9F8C76; /* Gris Piedra Oscuro */
            --color-error-bg: #fde8e8;
            --color-error-text: #9b2c2c;
            --color-error-border: #fecaca;

            --shadow-sm: 0 2px 5px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 10px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 20px rgba(0, 0, 0, 0.18), 0 3px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 5px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.8; font-weight: 400; background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c19a6b' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
        h1, h2, h3, h4, .logo, #generate-more-btn, #unlock-ad-button, #loading-text { font-family: 'Roboto', sans-serif; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 1px 1px 1px rgba(0,0,0,0.1); }
        h2.section-title { color: var(--color-secondary); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; font-size: 1.7rem; font-family: 'Merriweather', serif; text-transform: none; letter-spacing: normal; text-align: center; }
        .navbar { background-color: rgba(245, 245, 220, 0.9); backdrop-filter: blur(4px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }

        /* Search Bar */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Merriweather'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic;}
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.2); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        /* Title List & Items */
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.1rem 1.3rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 700; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between; min-height: 70px; font-family: 'Merriweather', serif; font-size: 1.08rem; position: relative; overflow: hidden; border-left: 6px solid var(--color-border); }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-left-color: var(--color-primary); color: var(--color-primary); background-color: #fff; }
        .title-item .title-text { flex-grow: 1; margin-right: 12px; }
        .title-item .lock-icon { color: var(--color-text-muted); font-size: 1.2rem; flex-shrink: 0; }

        /* Locked Title Items */
        .title-item.locked { background-color: var(--color-locked-bg); color: var(--color-locked-text); cursor: pointer; border-color: #B0A998; border-left-color: var(--color-locked-text); opacity: 0.9; }
        .title-item.locked:hover { transform: none; box-shadow: var(--shadow-sm); background-color: var(--color-locked-bg); color: var(--color-locked-text); border-left-color: var(--color-primary); }
        .title-item.locked .title-text { font-weight: 400; }
        .title-item.locked .lock-icon { color: var(--color-primary); animation: pulse-lock 1.8s infinite ease-in-out; }
        @keyframes pulse-lock { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.1); opacity: 1; } }

        /* Generate More Button */
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 1rem 2rem; border: none; border-radius: var(--border-radius); cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-text-muted); color: var(--color-background); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        /* Story Modal (Principal) */
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(61, 64, 91, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border: 2px solid var(--color-border); border-radius: var(--border-radius); padding: 1.8rem 2.2rem; max-width: 1050px; width: 95%; max-height: 90vh; min-height: 480px; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: rgba(193, 154, 107, 0.7); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }

        /* Modal Content Area (Scrollable) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 15px; margin-bottom: 1.2rem; scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border); }
        #modal-content-area::-webkit-scrollbar { width: 12px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(193, 154, 107, 0.3); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 3px solid rgba(193, 154, 107, 0.3); }

        #modal-content { padding: 0 10px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.6em; font-size: 1.12rem; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto', sans-serif; margin-top: 2.4em; margin-bottom: 1.3em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 700; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.6em; color: var(--color-primary); border-bottom-width: 2px; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-primary); border-bottom: none; font-weight: 400; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; font-weight: 400; font-style: italic; font-family: 'Merriweather'; text-transform: none; letter-spacing: normal;}
        /* Imagen Final */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.8rem auto 1.8rem auto; border: 2px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; margin: 2.8rem auto 1.8rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 6px solid rgba(193, 154, 107, 0.5); width: 50px; height: 50px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 1rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3.5rem; color: var(--color-tertiary);}

        /* Chat Section */
        #chat-section { border-top: 1px dashed var(--color-border); padding-top: 1.5rem; margin-top: 1.8rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 300px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(250, 240, 230, 0.6); scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #chat-history::-webkit-scrollbar { width: 10px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(193, 154, 107, 0.3); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.7rem 1.1rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.7; font-size: 1.05rem; font-family: 'Merriweather'; }
        .user-message { background-color: var(--color-tertiary); color: var(--color-text); margin-left: auto; text-align: right; border-radius: var(--border-radius) 0 var(--border-radius) var(--border-radius); box-shadow: var(--shadow-sm); }
        .ai-message { background-color: #E0F2F7; /* Light Teal */ color: var(--color-text); margin-right: auto; text-align: left; border-radius: 0 var(--border-radius) var(--border-radius) var(--border-radius); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.95em; }
        #chat-input-area { display: flex; gap: 0.8rem; }
        #chat-input { flex-grow: 1; padding: 0.8rem 1.1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Merriweather'; font-size: 1.05rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 2px rgba(0, 128, 128, 0.2); }
        #chat-send-btn { padding: 0.8rem 1.4rem; background-color: var(--color-secondary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1.1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #006666; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.6rem; font-size: 1em; color: var(--color-text-muted); display: none; font-family: 'Roboto'; }
        #chat-loading .fa-spinner { margin-right: 0.6rem; }

        /* --- NEW: Loading Overlay with Memory Game --- */
        #modal-loading { text-align: center; padding: 1rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(250, 240, 230, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #modal-loading.active { display: flex; }
        #loading-status { margin-bottom: 1.5rem; }
        #loading-text { font-weight: 700; color: var(--color-primary); font-size: 1.5rem; margin-bottom: 0.7rem; }
        #memory-game-status { font-weight: 400; color: var(--color-secondary); font-size: 1.1rem; font-family: 'Roboto'; margin-bottom: 1.5rem; }
        #memory-game-canvas { background-color: #E0DCD1; border: 3px solid var(--color-secondary); border-radius: 8px; display: block; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1); cursor: pointer; }
        #loading-final-text { font-weight: 400; color: var(--color-text-muted); font-size: 1rem; font-family: 'Merriweather'; font-style: italic; margin-top: 1.5rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Styles for Memory Game Tiles (within draw function) */
        .memory-tile { /* Base style, managed in JS draw */ }
        .tile-face-down { /* Style for face down */ }
        .tile-face-up { /* Style for face up */ }
        .tile-matched { /* Style for matched tiles */ }
        .tile-selected { /* Style for selected tile */ }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Merriweather'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(40, 40, 40, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-tertiary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-tertiary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-tertiary); color: var(--color-primary); transform: scale(1.1); }

        /* Unlock Modal */
        #unlock-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(61, 64, 91, 0.9); display: none; align-items: center; justify-content: center; z-index: 70; padding: 1rem; font-family: 'Merriweather', serif; }
        #unlock-modal.active { display: flex; }
        .unlock-modal-content { background-color: var(--color-modal-bg); padding: 3rem 2.5rem 2.5rem 2.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); text-align: center; max-width: 550px; width: 90%; position: relative; border: 2px solid var(--color-border); }
        .unlock-modal-close-btn { position: absolute; top: 12px; right: 12px; background: transparent; border: none; font-size: 2rem; color: var(--color-text-muted); cursor: pointer; line-height: 1; transition: color 0.2s ease; }
        .unlock-modal-close-btn:hover { color: var(--color-primary); }
        #unlock-modal h3 { font-family: 'Roboto', sans-serif; color: var(--color-primary); font-size: 1.8rem; margin-bottom: 1.2rem; }
        #unlock-modal p { color: var(--color-text); margin-bottom: 2rem; line-height: 1.8; font-size: 1.15rem; }
        #unlock-ad-button { background: linear-gradient(45deg, var(--color-tertiary), var(--color-primary)); color: white; padding: 1rem 2.5rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto', sans-serif; font-size: 1.3rem; cursor: pointer; transition: var(--transition-normal); margin-bottom: 1.5rem; display: inline-block; box-shadow: var(--shadow-md); text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        #unlock-ad-button:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-primary), var(--color-tertiary)); box-shadow: var(--shadow-lg); transform: translateY(-2px); }
        #unlock-ad-button:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; box-shadow: none; transform: none; }
        /* Removed countdown display */
        #unlock-status { font-size: 1.1rem; color: var(--color-secondary); margin-top: 1rem; font-weight: 700; min-height: 25px; }

    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-12">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                  <h1 class="logo text-3xl sm:text-4xl">
                      <i class="fas fa-atlas mr-2 text-brown-700"></i> <!-- Atlas -->
                      <i class="fas fa-question-circle mx-1 text-teal-600"></i> <!-- Question -->
                      <i class="fas fa-search-location mr-3 text-yellow-600"></i> <!-- Search Location -->
                      Misterios Olvidados
                 </h1>
             </div>
             <span class="text-xs text-gray-600 font-sans tracking-wider uppercase">» Descifrando Enigmas Ancestrales «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Ecos de lo Perdido</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-4xl mx-auto font-light italic">Explora las leyendas de civilizaciones desaparecidas, tecnologías imposibles y teorías que desafían la historia conocida.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar Atlantis, Nazca, Anunnaki, teoría...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-map-marked-alt text-teal-700 mr-2"></i> <!-- Map Icon -->
                 Archivos Prohibidos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los Registros Akáshicos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Este misterio aún no ha sido desenterrado... «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Desenterrar Más Misterios (40)
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal (Principal) -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>
             <!-- Loading Overlay with Memory Game -->
             <div id="modal-loading">
                 <div id="loading-status">
                     <p id="loading-text">Decodificando Símbolos...</p>
                     <p id="memory-game-status">Pares Encontrados: 0 / 8</p> <!-- Example Status -->
                 </div>
                 <canvas id="memory-game-canvas" width="320" height="320"></canvas> <!-- Adjusted size maybe -->
                 <p id="loading-final-text">Mientras se revela el conocimiento, ¡ejercita tu memoria ancestral!</p>
             </div>
             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 flex-shrink-0"></h2>
                     <div id="modal-content"></div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                      <h3 class="text-lg font-semibold text-center mb-2 text-secondary font-roboto">Consulta al Investigador</h3>
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Analizando teorías...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Profundizar en este misterio...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                     <i class="fas fa-exclamation-triangle"></i>
                     <span id="modal-error-message"></span>
                 </div>
             </div>
         </div>
     </div>

      <!-- Unlock Modal -->
      <div id="unlock-modal">
          <div class="unlock-modal-content">
              <button class="unlock-modal-close-btn" id="unlock-modal-close" aria-label="Cerrar">&times;</button>
              <h3><i class="fas fa-key mr-2 text-yellow-600"></i> Conocimiento Bloqueado</h3>
              <p>Ciertos secretos requieren un tributo. Haz clic en "ANUNCIO" para desbloquear este archivo perdido.</p>
              <button id="unlock-ad-button">
                  <i class="fas fa-unlock-alt mr-2"></i> ANUNCIO (Desbloquear)
              </button>
              <!-- Countdown removed -->
              <div id="unlock-status"></div>
              <input type="hidden" id="unlock-target-title" value="">
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Misterio">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-800 text-gray-400 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Exploraciones de civilizaciones perdidas y teorías alternativas generadas por IA, basadas en mitos, leyendas e investigaciones.</p>
              <p class="mt-1">La información presentada mezcla hechos, hipótesis y especulación. Investiga más por tu cuenta.</p>
              <p class="mt-2">© 2025 Archivos Xeno-Arqueológicos</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const adUrl = 'https://increasingbelieveabonnement.com/pcmu77j4?key=1f38fa224b5ecf757563a32d2d8ac126';
        // Removed: unlockCountdownSeconds
        const lockPercentage = 0.7;
        const themePrefix = 'LostCiv'; // Unique prefix
        const userUnlockedKey = `unlockedTitles_${themePrefix}`;
        const initialLockStateSetFlagKey = `initialLockStateSet_${themePrefix}`;
        const initialLockedSetKey = `initialLockedSet_${themePrefix}`;

        const predefinedTitles = [
            // Civilizaciones Clásicas Perdidas
            "Atlantis: Mito Platónico o Realidad Sumergida?", "Lemuria: El Continente Perdido del Pacífico", "Mu: ¿Civilización Madre en el Pacífico?", "Hiperbórea: La Tierra Mítica del Norte Eterno", "Thule: Última Avanzada Aria o Isla Polar?", "Shambhala: El Reino Oculto en los Himalayas", "El Dorado: La Leyenda de la Ciudad de Oro", "Aztlán: Origen Mítico de los Aztecas", "Iram de los Pilares: La Ciudad Perdida del Desierto", "Ys: La Ciudad Bretona Engullida por el Mar",
            // Lugares y Estructuras Misteriosas
            "El Triángulo de las Bermudas: ¿Portal o Fenómeno Natural?", "El Monumento Submarino de Yonaguni: ¿Natural o Artificial?", "Las Líneas de Nazca: Geoglifos para los Dioses?", "Göbekli Tepe: El Templo Más Antiguo y su Propósito", "Puma Punku: Cortes de Piedra Imposibles en Bolivia", "Teotihuacán: ¿Construido por Gigantes o Extraterrestres?", "Machu Picchu: Secretos de la Ciudad Inca", "Isla de Pascua (Rapa Nui): El Misterio de los Moáis", "Stonehenge: Observatorio Astronómico o Lugar Ritual?", "Las Esferas de Piedra de Costa Rica: Origen Desconocido", "El Camino de Bimini: ¿Restos Atlantes o Formación Natural?", "Baalbek: Las Piedras Más Grandes Trabajadas por el Hombre", "Derinkuyu y Kaymaklı: Ciudades Subterráneas de Capadocia", "El Laberinto de Creta: ¿Mito o Realidad Histórica?", "Carnac: Alineamientos Megalíticos en Francia",
            // Artefactos Anómalos (Ooparts)
            "El Mecanismo de Anticitera: ¿Una Computadora Antigua?", "El Manuscrito Voynich: Código Indescifrable o Engaño?", "La Batería de Bagdad: ¿Electricidad en la Antigüedad?", "El Mapa de Piri Reis: ¿Muestra la Antártida sin Hielo?", "Las Figurillas de Acámbaro: ¿Dinosaurios con Humanos?", "El Martillo de Londres (Texas): ¿Atrapado en Roca Antigua?", "Los Cráneos de Cristal: ¿Legado Maya o Falsificaciones?", "La Lente de Nimrud: ¿Telescopio Asirio?", "Las Tuberías de Baigong: ¿Metalurgia Prehistórica?", "La Fuente Magna: ¿Escritura Cuneiforme en Bolivia?",
            // Teorías Heterodoxas
            "Teoría de los Antiguos Astronautas: ¿Visitas Extraterrestres?", "Anunnaki: ¿Dioses Sumerios o Viajeros Estelares?", "La Hipótesis del Gran Cataclismo Global (Diluvio Universal)", "Teoría de la Tierra Hueca: ¿Civilizaciones Intra-terrestres?", "Tecnología Avanzada en la Antigüedad: ¿Evidencias Ocultas?", "Ciclos Solares y Caída de Civilizaciones", "Conocimiento Secreto de Sociedades Antiguas (Egipcios, Mayas)", "La Conexión Piramidal Global: ¿Red Energética?", "Teoría de la Panspermia: ¿Vida Sembrada en la Tierra?", "Realidades Simuladas y Fallos en la Matriz Histórica", "La Gran Pirámide de Giza: Más Allá de una Tumba", "Orion Correlation Theory (Teoría de la Correlación de Orión)", "Intervencionismo Extraterrestre en la Evolución Humana", "Uso de Sonido (Levitación Acústica) en Construcciones Antiguas", "Registros Akáshicos: ¿Biblioteca Universal del Conocimiento?",
            // Figuras y Textos Enigmáticos
            "Enoch: El Profeta que Caminó con Dios (y Vio Secretos)", "Hermes Trismegisto y la Tabla Esmeralda", "Zoroastro y el Culto de Mitra", "Los Esenios y los Manuscritos del Mar Muerto", "Apolonio de Tiana: ¿Un Mago Errante?", "El Libro de Thoth: Sabiduría Egipcia Perdida", "Los Textos Sánscritos y las Vimanas (Naves Voladoras)", "El Zohar y la Cábala Mística", "Las Profecías de Nostradamus: ¿Aciertos o Ambigüedad?", "Edgar Cayce: El Profeta Durmiente y sus Lecturas",
            // ... (Continuar hasta ~400 títulos, explorando más lugares, artefactos, teorías específicas, conexiones culturales, etc.)
             "La Cultura Vinča y su escritura temprana", "Çatalhöyük: Asentamiento neolítico complejo", "La Civilización del Indo: Escritura sin descifrar", "Sanxingdui: Máscaras de bronce chinas enigmáticas", "El Reino de Saba: Riqueza y misterio", "La Cultura Clovis y su desaparición", "Dogon: Conocimiento astronómico avanzado?", "Olmecas: Cabezas colosales y orígenes", "Caral-Supe: La civilización más antigua de América", "Norte Chico: ¿Civilización sin cerámica?", "Tiahuanaco: Ingeniería pre-incaica", "El Disco de Festo: Escritura única minoica", "La Atlántida de Helike: Ciudad griega sumergida", "Tartaria: ¿Imperio global olvidado o teoría conspirativa?", "Las Cuevas de Longyou: Excavaciones masivas inexplicables", "El Triángulo del Dragón (Mar del Diablo): ¿Equivalente Pacífico al de las Bermudas?", "El Incidente del Paso Dyatlov: ¿Explicación sobrenatural?", "El Bosque Hoia Baciu: Fenómenos paranormales en Rumanía", "El Lago Baikal: Misterios del lago más profundo", "Monte Shasta: ¿Base OVNI o portal dimensional?", "Las Montañas de la Superstición: La Mina del Holandés Perdido", "Oak Island: El Pozo del Dinero y la maldición", "El Dorado en Colombia: Laguna de Guatavita", "Paititi: La ciudad perdida inca en la selva", "Z: La ciudad perdida de Percy Fawcett en Brasil", "La búsqueda de la Lanza Sagrada (Lanza de Longinus)", "El Arca de la Alianza: ¿Dónde está?", "El Santo Grial: ¿Cáliz o linaje?", "La Piedra Filosofal: Transmutación y elixir", "El Libro de las Puertas (Egipcio)", "El Libro de los Muertos Tibetano (Bardo Thodol)", "Los Papiros Mágicos Griegos", "Gnosticismo: Conocimiento secreto y demiurgo", "Maniqueísmo: Dualismo cósmico", "Catarismo: Herejía medieval y tesoros ocultos", "Los Templarios: Poder, secretos y caída", "Rosacrucismo: Sociedad secreta esotérica", "Masonería: Símbolos y rituales", "Illuminati: ¿Conspiración mundial?", "El Priorato de Sión: ¿Realidad o ficción Da Vinci?", "La Hipótesis Siluriana: ¿Civilización industrial pre-humana?", "Arqueología Prohibida: Evidencias suprimidas?", "Criptozoología y criaturas legendarias (¿restos de eras perdidas?)" // etc.
        ];
        const lostCivThemes = [
            "Atlantis teorías", "Antiguos astronautas evidencia", "Lugares misteriosos Tierra", "Artefactos fuera de lugar", "Civilizaciones perdidas Pacífico", "Tecnología antigua imposible", "Cataclismos prehistóricos", "Tierra Hueca leyendas", "Sociedades secretas antiguas", "Textos sagrados ocultos", "Pirámides globales conexión", "Megalitismo inexplicable", "Mitos creación Anunnaki", "Símbolos antiguos poder", "Conocimiento perdido Egipto"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un Investigador de lo Oculto y Guardián de Saberes Olvidados. Presenta información sobre la civilización perdida, lugar misterioso, artefacto anómalo o teoría consultada. Equilibra datos arqueológicos/históricos conocidos con las teorías, leyendas y especulaciones asociadas. Adopta un tono intrigante y exploratorio, invitando a cuestionar la historia oficial. Extensión objetivo: 1200-1300 palabras. Investiga y expone sobre:",
            timeoutSeconds: 180
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como asistente del Investigador. Responde preguntas específicas sobre el misterio recién expuesto. Clarifica detalles sobre evidencias, teorías alternativas, figuras clave mencionadas o implicaciones. Céntrate estrictamente en el tema tratado, manteniendo un tono de curiosidad informada.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Genera una lista concisa de 40 temas específicos y variados sobre civilizaciones perdidas, lugares misteriosos, artefactos anómalos (Ooparts) y teorías históricas alternativas. Devuelve *solo* la lista de ítems, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60
        };
        // --- NEW: Memory Game Symbols ---
        const memoryGameSymbols = [ // <<< Array actualizado con icono corregido
             '<i class="fas fa-landmark"></i>',       // &#xf66f;
             '<i class="fas fa-eye"></i>',           // &#xf06e;
             '<i class="fas fa-compass"></i>',      // &#xf14e;
             '<i class="fas fa-key"></i>',           // &#xf084;
             '<i class="fas fa-scroll"></i>',        // &#xf70e;
             '<i class="fas fa-question-circle"></i>', // &#xf059; <<< CAMBIADO
             '<i class="fas fa-meteor"></i>',        // &#xf753;
             '<i class="fas fa-hat-wizard"></i>'     // &#xf6e8;
        ];

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        const memoryGameCanvas = document.getElementById('memory-game-canvas');
        const memoryGameStatusText = document.getElementById('memory-game-status');
        const loadingText = document.getElementById('loading-text');
        const unlockModal = document.getElementById('unlock-modal');
        const unlockModalCloseBtn = document.getElementById('unlock-modal-close');
        const unlockAdButton = document.getElementById('unlock-ad-button');
        const unlockStatusDisplay = document.getElementById('unlock-status');
        const unlockTargetTitleInput = document.getElementById('unlock-target-title');

        // ========== NEW: MEMORY MATCH GAME LOGIC ==========
        const MemoryGame = {
            canvas: null,
            ctx: null,
            statusElement: null,
            symbols: memoryGameSymbols,
            gridSize: 4, // 4x4 grid = 16 tiles = 8 pairs
            tileSize: 80, // Size of each tile
            tiles: [], // Array to hold tile objects { id, symbol, isFlipped, isMatched, x, y }
            flippedTiles: [], // Max 2 tiles currently flipped
            matchesFound: 0,
            totalPairs: 0,
            canFlip: true, // Prevent clicking during animations/checks
            isRunning: false,
            tileColorFaceDown: '#C19A6B', // Camel/Arenisca
            tileColorFaceUp: '#FAF0E6',   // Lino
            tileColorMatched: '#E0DCD1', // Gris Piedra Claro (matched)
            symbolColor: '#8B4513',    // Marrón Tierra
            matchedSymbolColor: '#9F8C76', // Gris Piedra Oscuro (matched)

            init(canvasElement, statusElement) {
                this.canvas = canvasElement;
                if (!this.canvas) { console.error("Memory game canvas not found!"); return; }
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = this.gridSize * this.tileSize;
                this.canvas.height = this.gridSize * this.tileSize;
                this.statusElement = statusElement;
                this.canvas.addEventListener('click', this.handleClick.bind(this));
                this.totalPairs = (this.gridSize * this.gridSize) / 2;
                console.log("Memory Game Initialized");
            },

            start() {
                if (this.isRunning) return;
                console.log("Starting Memory Game");
                this.isRunning = true;
                this.matchesFound = 0;
                this.flippedTiles = [];
                this.canFlip = true;
                this.shuffleAndDeal();
                this.updateStatus();
                this.draw();
            },

            stop() {
                if (!this.isRunning) return;
                console.log("Stopping Memory Game");
                this.isRunning = false;
                if(this.ctx) this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            },

            shuffleAndDeal() {
                this.tiles = [];
                let idCounter = 0;
                let currentSymbols = [];
                for (let i = 0; i < this.totalPairs; i++) {
                    currentSymbols.push(this.symbols[i]);
                    currentSymbols.push(this.symbols[i]);
                }
                currentSymbols = shuffleArray(currentSymbols);
                for (let r = 0; r < this.gridSize; r++) {
                    for (let c = 0; c < this.gridSize; c++) {
                        const x = c * this.tileSize;
                        const y = r * this.tileSize;
                        const symbol = currentSymbols.pop();
                        this.tiles.push({
                            id: idCounter++, symbol: symbol, isFlipped: false, isMatched: false, x: x, y: y, row: r, col: c
                        });
                    }
                }
            },

            draw() {
                if (!this.isRunning || !this.ctx) return;
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                this.tiles.forEach(tile => {
                    const x = tile.x; const y = tile.y;
                    const size = this.tileSize - 4;
                    const cornerRadius = 8;
                    let fillColor = this.tileColorFaceDown;
                    if (tile.isMatched) { fillColor = this.tileColorMatched; }
                    else if (tile.isFlipped) { fillColor = this.tileColorFaceUp; }

                    this.ctx.fillStyle = fillColor;
                    this.ctx.beginPath();
                    this.ctx.moveTo(x + cornerRadius + 2, y + 2);
                    this.ctx.lineTo(x + size - cornerRadius + 2, y + 2);
                    this.ctx.quadraticCurveTo(x + size + 2, y + 2, x + size + 2, y + cornerRadius + 2);
                    this.ctx.lineTo(x + size + 2, y + size - cornerRadius + 2);
                    this.ctx.quadraticCurveTo(x + size + 2, y + size + 2, x + size - cornerRadius + 2, y + size + 2);
                    this.ctx.lineTo(x + cornerRadius + 2, y + size + 2);
                    this.ctx.quadraticCurveTo(x + 2, y + size + 2, x + 2, y + size - cornerRadius + 2);
                    this.ctx.lineTo(x + 2, y + cornerRadius + 2);
                    this.ctx.quadraticCurveTo(x + 2, y + 2, x + cornerRadius + 2, y + 2);
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();

                    if (tile.isFlipped || tile.isMatched) {
                         // *** MODIFICADO: Añadir fontWeight '900' ***
                        this.ctx.font = `900 ${this.tileSize * 0.5}px "Font Awesome 6 Free"`;
                        this.ctx.fillStyle = tile.isMatched ? this.matchedSymbolColor : this.symbolColor;
                        this.ctx.textAlign = 'center';
                        this.ctx.textBaseline = 'middle';

                        let symbolChar = '?';
                        const classMatch = tile.symbol.match(/fa-([a-z-]+)/);
                         if (classMatch) {
                            // Mapear nombre a código Unicode
                            switch(classMatch[1]) {
                                case 'landmark': symbolChar = '\uf66f'; break;
                                case 'eye': symbolChar = '\uf06e'; break;
                                case 'compass': symbolChar = '\uf14e'; break;
                                case 'key': symbolChar = '\uf084'; break;
                                case 'scroll': symbolChar = '\uf70e'; break;
                                case 'question-circle': symbolChar = '\uf059'; break; // <<< CÓDIGO CORRESPONDIENTE
                                case 'meteor': symbolChar = '\uf753'; break;
                                case 'hat-wizard': symbolChar = '\uf6e8'; break;
                            }
                        }
                        this.ctx.fillText(symbolChar, x + this.tileSize / 2, y + this.tileSize / 2 + 2);
                    }
                });
            },

            handleClick(event) {
                if (!this.isRunning || !this.canFlip) return;
                const rect = this.canvas.getBoundingClientRect();
                const x = event.clientX - rect.left; const y = event.clientY - rect.top;
                const col = Math.floor(x / this.tileSize); const row = Math.floor(y / this.tileSize);
                const clickedTileIndex = row * this.gridSize + col;
                const clickedTile = this.tiles[clickedTileIndex];
                if (!clickedTile || clickedTile.isMatched || clickedTile.isFlipped) { return; }
                clickedTile.isFlipped = true;
                this.flippedTiles.push(clickedTile);
                this.draw();
                if (this.flippedTiles.length === 2) {
                    this.canFlip = false;
                    this.checkForMatch();
                }
            },

            checkForMatch() {
                const [tile1, tile2] = this.flippedTiles;
                if (tile1.symbol === tile2.symbol) {
                    console.log("Match Found!");
                    tile1.isMatched = true; tile2.isMatched = true;
                    this.matchesFound++; this.flippedTiles = [];
                    this.updateStatus(); this.canFlip = true; this.draw();
                    if (this.matchesFound === this.totalPairs) { console.log("Memory Game Won!"); }
                } else {
                    console.log("No Match");
                    setTimeout(() => {
                        tile1.isFlipped = false; tile2.isFlipped = false;
                        this.flippedTiles = []; this.canFlip = true; this.draw();
                    }, 800);
                }
            },

            updateStatus() {
                if (this.statusElement) {
                    this.statusElement.textContent = `Pares Encontrados: ${this.matchesFound} / ${this.totalPairs}`;
                }
            }
        };

        // ========== State Variables ==========
        let currentTopicTitle = null;
        let initialLockedTitles = loadInitialLockedSet();
        // Removed: countdownInterval

        // ========== LocalStorage Functions ==========
        function getJsonFromStorage(key) { try { const stored = localStorage.getItem(key); return stored ? JSON.parse(stored) : null; } catch (e) { console.error(`Error reading key ${key} from localStorage:`, e); return null; } }
        function setJsonInStorage(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error(`Error saving key ${key} to localStorage:`, e); } }
        function getUnlockedTitles() { const unlockedArray = getJsonFromStorage(userUnlockedKey); return new Set(unlockedArray || []); }
        function saveUnlockedTitles(unlockedSet) { setJsonInStorage(userUnlockedKey, Array.from(unlockedSet)); }
        function isTitleUnlockedByUser(title) { return getUnlockedTitles().has(title); }
        function unlockTitlePermanentlyByUser(title) { if (!title) return; const unlockedByUser = getUnlockedTitles(); if (!unlockedByUser.has(title)) { unlockedByUser.add(title); saveUnlockedTitles(unlockedByUser); console.log(`Title permanently unlocked by user: ${title}`); updateTitleItemLockStatus(title, false); } }
        function loadInitialLockedSet() { const lockedArray = getJsonFromStorage(initialLockedSetKey); return new Set(lockedArray || []); }
        function saveInitialLockedSet(lockedSet) { setJsonInStorage(initialLockedSetKey, Array.from(lockedSet)); }
        function isInitialLockStateSet() { return localStorage.getItem(initialLockStateSetFlagKey) === 'true'; }
        function setInitialLockStateFlag() { localStorage.setItem(initialLockStateSetFlagKey, 'true'); }
        function isTitleInitiallyLocked(title) { return initialLockedTitles.has(title); }

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Actúa como asistente del Investigador. Responde preguntas específicas sobre '${currentTopicTitle}'. Clarifica detalles, teorías, evidencias o implicaciones. Sé conciso y mantén el tono exploratorio.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) ¡Señal perdida! Los servidores de archivos ocultos están inaccesibles. Intenta de nuevo.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("El Investigador encontró páginas en blanco (respuesta vacía). Intenta de nuevo.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La consulta tardó demasiado (>${config.timeoutSeconds}s). La conexión es débil o el misterio es muy profundo. Inténtalo de nuevo.`);
                 throw new Error(error.message || "Error desconocido contactando a los guardianes del saber.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Error interno: Contexto del Misterio perdido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(lostCivThemes) || "misterios históricos variados";
             const specificPrompt = `Genera 40 ideas específicas sobre ${randomTheme}`;
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 10) throw new Error("La IA no desenterró suficientes ideas de misterios.");
                     return titles.slice(0, 40);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Lost civilization or ancient mystery";
            const enhancedPrompt = `Atmospheric digital painting illustrating '${safePromptText}'. Evoke mystery, ancient ruins, forgotten knowledge, perhaps subtle cosmic or unexplained elements. Use earthy tones with accents of gold, turquoise or deep purple. Style: slightly stylized, painterly, focus on mood and atmosphere. No text, words, labels.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, photorealistic, modern elements, people clearly visible";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText) { if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted; }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { storyModal.classList.remove('active'); if (!imageFullscreenOverlay.classList.contains('active') && !unlockModal.classList.contains('active')) { document.body.style.overflow = ''; } modalTextArea.scrollTop = 0; MemoryGame.stop(); resetModalState(); }
        function resetModalState() { modalLoadingIndicator.classList.remove('active'); modalStoryContentArea.classList.add('content-hidden'); modalError.classList.add('content-hidden'); modalTitle.textContent = ''; modalContent.innerHTML = ''; modalErrorMessage.textContent = ''; chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; currentTopicTitle = null; hideFullscreenImage(); chatSection.classList.remove('content-hidden'); MemoryGame.stop(); }
        function showUnlockModal(titleToUnlock) { unlockTargetTitleInput.value = titleToUnlock; unlockStatusDisplay.textContent = ''; unlockAdButton.disabled = false; unlockModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideUnlockModal() { unlockModal.classList.remove('active'); if (!storyModal.classList.contains('active') && !imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; } }

        // ========== FULLSCREEN IMAGE FUNCTIONS ==========
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active') && !unlockModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender) { const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error Investigador: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.setAttribute('data-title', title); const textSpan = document.createElement('span'); textSpan.className = 'title-text'; textSpan.textContent = title; div.appendChild(textSpan); const initiallyLocked = isTitleInitiallyLocked(title); const unlockedByUser = isTitleUnlockedByUser(title); const isEffectivelyLocked = initiallyLocked && !unlockedByUser; div.setAttribute('data-locked', isEffectivelyLocked ? 'true' : 'false'); div.style.cursor = 'pointer'; if (isEffectivelyLocked) { div.classList.add('locked'); const lockIcon = document.createElement('i'); lockIcon.className = 'fas fa-lock lock-icon'; div.appendChild(lockIcon); } else { div.classList.remove('locked'); } div.addEventListener('click', () => handleTitleClick(title, div)); return div; }
        function updateTitleItemLockStatus(title, isLocked) { const titleItem = titleListContainer.querySelector(`.title-item[data-title="${CSS.escape(title)}"]`); if (titleItem) { titleItem.setAttribute('data-locked', isLocked ? 'true' : 'false'); titleItem.classList.toggle('locked', isLocked); let lockIcon = titleItem.querySelector('.lock-icon'); if (isLocked && !lockIcon) { lockIcon = document.createElement('i'); lockIcon.className = 'fas fa-lock lock-icon'; titleItem.appendChild(lockIcon); } else if (!isLocked && lockIcon) { lockIcon.remove(); } } }
        function displayTitles(titles) { if (!titleListContainer || !titlesLoading) return; if (!isInitialLockStateSet() && titles.length > 0) { console.log("Setting initial lock state for the first time..."); const shuffled = shuffleArray([...titles]); const lockCount = Math.floor(titles.length * lockPercentage); const newInitialLockedSet = new Set(); for (let i = 0; i < lockCount; i++) { newInitialLockedSet.add(shuffled[i]); } saveInitialLockedSet(newInitialLockedSet); setInitialLockStateFlag(); initialLockedTitles = newInitialLockedSet; console.log(`Initially locked ${initialLockedTitles.size} titles and saved state.`); } else { console.log(`Initial lock state already set. Loaded ${initialLockedTitles.size} initially locked titles.`); } const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none'; if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay misterios registrados por ahora... «</p>'; return; } sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title)); let newTitlesAddedToInitialLock = false; newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); if (!initialLockedTitles.has(title)) { initialLockedTitles.add(title); newTitlesAddedToInitialLock = true; } } }); if (newTitlesAddedToInitialLock) { saveInitialLockedSet(initialLockedTitles); console.log("Added new generated titles to the persistent initial locked set."); } filterTitles(searchInput.value); }
        function handleTitleClick(title, titleElement) { const isLocked = titleElement.getAttribute('data-locked') === 'true'; if (isLocked) { console.log(`Title "${title}" is locked. Showing unlock modal.`); showUnlockModal(title); } else { console.log(`Title "${title}" is unlocked. Proceeding to load.`); loadContentForTitle(title); } }

        // loadContentForTitle (Adaptado para usar MemoryGame)
        async function loadContentForTitle(title) {
            resetModalState(); showModal(); currentTopicTitle = title;
            modalTitle.textContent = title;
            modalStoryContentArea.classList.add('content-hidden');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.classList.add('active');
            MemoryGame.start(); // <<< Start Memory Game
            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);
                MemoryGame.stop(); // <<< Stop Memory Game
                modalLoadingIndicator.classList.remove('active');
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0; // Reset scroll

                // Load Image
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Desenterrando imagen...</p>`;
                modalContent.appendChild(placeholderDiv);
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración sobre ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`; };
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL imagen.</p>`;}

            } catch (error) { console.error("Failed display:", error); MemoryGame.stop(); modalLoadingIndicator.classList.remove('active'); modalErrorMessage.textContent = error.message || "Error desconocido al desenterrar este misterio."; modalError.classList.remove('content-hidden'); modalStoryContentArea.classList.remove('content-hidden'); modalContent.innerHTML = ''; chatSection.classList.add('content-hidden'); }
        }

        // --- MODIFIED: handleAdButtonClick - No countdown ---
        function handleAdButtonClick() {
            const titleToUnlock = unlockTargetTitleInput.value;
            if (!titleToUnlock || unlockAdButton.disabled) return;
            console.log(`Ad button clicked for title: ${titleToUnlock}`);
            window.open(adUrl, '_blank'); // Open ad link immediately
            unlockAdButton.disabled = true; // Disable button immediately
            unlockStatusDisplay.textContent = 'Desbloqueando Archivo...'; // Show unlocking status

            // Unlock title permanently FOR USER immediately
            unlockTitlePermanentlyByUser(titleToUnlock);

            // Wait a short moment for visual feedback, then proceed
            setTimeout(() => {
                unlockStatusDisplay.textContent = '¡Conocimiento Adquirido!';
                // Another short delay before closing and loading
                setTimeout(() => {
                    hideUnlockModal();
                    loadContentForTitle(titleToUnlock); // Load content directly
                }, 800); // 0.8s after "Acquired!" message
            }, 500); // 0.5s after clicking ad button
        }

        // handleGenerateMoreTitles
        async function handleGenerateMoreTitles() { if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return; generateMoreBtn.disabled = true; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Excavando más secretos...'; try { const newTitles = await fetchGeneratedTitles(); if (newTitles && newTitles.length > 0) { appendTitles(newTitles); } else { alert("No se pudieron desenterrar más misterios ahora."); } } catch (error) { console.error("Failed title generation:", error); alert(`Error buscando misterios: ${error.message}`); } finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Desenterrar Más Misterios (40)'; } }

         // Search Filter Function
         function filterTitles(searchTerm) { const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); const titleItems = titleListContainer.querySelectorAll('.title-item'); let visibleCount = 0; titleItems.forEach(item => { const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const isVisible = titleText.includes(term); item.classList.toggle('hidden', !isVisible); if (isVisible) visibleCount++; }); noResultsMsg.classList.toggle('hidden', visibleCount > 0); }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check essential elements
              if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !memoryGameCanvas || !memoryGameStatusText || !unlockModal || !unlockModalCloseBtn || !unlockAdButton || !unlockStatusDisplay || !unlockTargetTitleInput) {
                console.error("Initialization failed: Missing essential UI elements (check memory game elements).");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: ¡El mapa está incompleto! Faltan componentes.</p>';
                return;
             }

            MemoryGame.init(memoryGameCanvas, memoryGameStatusText); // <<< Initialize Memory Game

            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            unlockModalCloseBtn.addEventListener('click', hideUnlockModal);
            unlockModal.addEventListener('click', (event) => { if (event.target === unlockModal) hideUnlockModal(); });
            unlockAdButton.addEventListener('click', handleAdButtonClick); // <<< Uses modified handler

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>