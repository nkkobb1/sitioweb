<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS5 Game Codex</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y modernas -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para PS5 Games --- */
        :root {
            --color-primary: #0070d1; /* Azul PlayStation */
            --color-secondary: #8c8c8c; /* Gris Medio/Plata */
            --color-background: #f0f2f5; /* Gris Muy Claro / Blanco Hueso */
            --color-text: #1f1f1f; /* Negro Suave */
            --color-text-muted: #595959; /* Gris Oscuro */
            --color-modal-bg: #ffffff; /* Blanco Puro para Modal */
            --color-border: #d9d9d9; /* Borde Gris Claro */
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.07), 0 1px 2px -1px rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -1px rgb(0 0 0 / 0.06);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.05);
            --border-radius: 8px; /* Bordes más redondeados */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.6; }
        /* Fuente Tech/Gamer para el logo/título */
        h1.logo, h1.page-title { font-family: 'Orbitron', sans-serif; font-weight: 700; color: var(--color-primary); letter-spacing: 1px; }
        h2.section-title, #modal-title { font-family: 'Orbitron', sans-serif; font-weight: 500; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; }
        #modal-title { color: var(--color-primary); }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.25rem; }
        .title-item {
            background-color: var(--color-modal-bg);
            padding: 1.25rem 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: var(--transition-normal);
            text-align: center;
            font-weight: 600; /* Más peso para títulos */
            color: var(--color-text);
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 75px; /* Aumentar altura mínima */
            font-family: 'Inter', sans-serif;
        }
        .title-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
            color: var(--color-primary);
            background-color: #e6f7ff; /* Azul muy pálido */
        }
        #generate-more-btn {
            grid-column: 1 / -1;
            background: linear-gradient(45deg, var(--color-primary), #005bb5); /* Gradiente azul */
            color: white;
            padding: 0.9rem 1.8rem; /* Botón más grande */
            border: none;
            border-radius: var(--border-radius);
            font-family: 'Inter', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition-normal), transform 0.1s ease;
            margin-top: 2rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-sm);
        }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, #005bb5, var(--color-primary)); box-shadow: var(--shadow-md); transform: scale(1.02); }
        #generate-more-btn:active:not(:disabled) { transform: scale(0.98); }
        #generate-more-btn:disabled { background: var(--color-secondary); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 31, 31, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 2rem 2.5rem;
            max-width: 1000px; /* Más ancho para contenido de juegos */
            width: 95%;
            max-height: 90vh;
            min-height: 350px; /* Asegurar espacio para carga */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            border-top: 5px solid var(--color-primary); /* Detalle azul arriba */
        }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(180deg); }
        #modal-title { font-size: 2.2rem; /* Título más prominente */ text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.2; }
        #modal-content {
            line-height: 1.7;
            color: var(--color-text);
            white-space: normal;
            overflow-y: auto;
            padding: 0 15px 1.5rem 15px; /* Padding aumentado ligeramente */
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content::-webkit-scrollbar { width: 10px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: #005bb5; font-style: italic; } /* Énfasis en azul oscuro */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Inter', sans-serif; font-weight: 700; margin-top: 2em; margin-bottom: 1em; color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; }
        #modal-content h1 { font-size: 1.5em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: #383838; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        /* Estilo para la imagen insertada al final */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border-radius: var(--border-radius); box-shadow: var(--shadow-md); border: 1px solid var(--color-border); }
        /* Estilo para el placeholder/spinner de la imagen final */
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 5px solid rgba(0, 0, 0, 0.1); width: 45px; height: 45px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 70px; height: 70px; border: 7px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.4rem; font-family: 'Inter'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fff1f0; /* Fondo error rojo pálido */ color: #d9363e; /* Texto rojo */ padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid #ffccc7; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold; }
        .error-msg i { margin-right: 0.8rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex justify-center items-center">
             <div class="flex items-center text-center">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-gamepad mr-3 text-blue-600"></i> <!-- Icono gamepad -->
                     PS5 Game Codex
                     <i class="fab fa-playstation ml-3 text-blue-600"></i> <!-- Icono PS -->
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Tu Biblioteca Definitiva de PS5</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto">Sumérgete en análisis detallados de los juegos que definen la PlayStation 5. Elige un título para cargar su ficha.</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-layer-group text-blue-600 mr-2"></i> <!-- Icono capas/colección -->
                 Selecciona un Juego
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Accediendo a la base de datos de juegos...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Cargar Más Juegos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Cargando análisis...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - La imagen se añadirá aquí al final -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                     <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                 </div>
                 <!-- NO HAY CONTENEDOR DE IMAGEN SEPARADO AQUÍ -->
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-300">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Análisis generados por IA con fines informativos y de entretenimiento sobre videojuegos de PS5.</p>
              <p class="mt-1">Todas las marcas y nombres de juegos son propiedad de sus respectivos dueños.</p>
              <p class="mt-2">© 2025 PS5 Game Codex</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // --- Lanzamiento y Primer Año PS5 ---
            "Marvel's Spider-Man: Miles Morales", "Demon's Souls (Remake)", "Astro's Playroom", "Sackboy: A Big Adventure", "Returnal", "Ratchet & Clank: Rift Apart", "Deathloop", "Kena: Bridge of Spirits", "Horizon Forbidden West", "Gran Turismo 7", "Elden Ring", "Ghostwire: Tokyo", "Stray", "God of War Ragnarök", "The Callisto Protocol", "Marvel's Spider-Man 2", "Final Fantasy XVI", "Hogwarts Legacy",
            // --- Exclusivos de Consola (Temporales o Completos) ---
            "Final Fantasy VII Rebirth", "Rise of the Ronin", "Stellar Blade", "Forspoken", "Marvel's Wolverine (Anticipado)", "Death Stranding Director's Cut", "Ghost of Tsushima Director's Cut", "Nioh Collection (Nioh 1 & 2 Remastered)", "Silent Hill 2 (Remake) (Anticipado)", "Abandoned (Anticipado - si sigue vivo)", "Pragmata (Anticipado)", "Babylon's Fall", // (Aunque cerró, fue exclusivo)
            "Pacific Drive", "Helldivers 2", "Foamstars", "Concord (Anticipado)", "Fairgame$ (Anticipado)",
            // --- Grandes Third Party Multiplataforma ---
            "Cyberpunk 2077 (con actualización PS5)", "Resident Evil Village", "Assassin's Creed Valhalla", "Call of Duty: Modern Warfare III (2023)", "Call of Duty: Black Ops Cold War", "Battlefield 2042", "Dying Light 2 Stay Human", "Tiny Tina's Wonderlands", "Star Wars Jedi: Survivor", "Street Fighter 6", "Mortal Kombat 1", "Diablo IV", "Baldur's Gate 3", "Alan Wake 2", "Avatar: Frontiers of Pandora", "Like a Dragon: Infinite Wealth", "Tekken 8", "Suicide Squad: Kill the Justice League", "Skull and Bones", "Lies of P", "Armored Core VI: Fires of Rubicon", "Lords of the Fallen (2023)", "Remnant 2", "Dead Space (Remake)", "Resident Evil 4 (Remake)", "Atomic Heart", "Hi-Fi Rush (posible port)", "Sea of Thieves (posible port)", "Grounded (posible port)", "Pentiment (posible port)", "Starfield (muy improbable, pero añadir por completitud de debate)", "Red Dead Redemption 2 (con posible mejora PS5)", "Grand Theft Auto V (Enhanced & Expanded)", "Grand Theft Auto VI (Anticipado)", "The Witcher 3: Wild Hunt Complete Edition (PS5 Update)", "No Man's Sky (con actualizaciones PS5)", "Destiny 2 (con actualizaciones PS5)", "Apex Legends (con versión PS5)", "Fortnite (con mejoras PS5)", "Genshin Impact (con versión PS5)", "Warframe (con versión PS5)", "Overwatch 2", "Control: Ultimate Edition", "Marvel's Avengers (hasta su cierre)", "Marvel's Guardians of the Galaxy", "Gotham Knights", "Hitman 3 (World of Assassination)", "Far Cry 6", "Watch Dogs: Legion", "Immortals Fenyx Rising", "Outriders", "Back 4 Blood", "Aliens: Fireteam Elite", "Tales of Arise", "Scarlet Nexus", "Lost Judgment", "Yakuza: Like a Dragon", "Persona 5 Royal (versión PS5)", "Persona 3 Reload", "Like a Dragon Gaiden: The Man Who Erased His Name", "Dragon's Dogma 2", "Rise of P (Error, es Lies of P)", "Eiyuden Chronicle: Hundred Heroes", "Sand Land", "Prince of Persia: The Lost Crown", "Immortals of Aveum", "Atlas Fallen", "Exoprimal", "System Shock (Remake)", "RoboCop: Rogue City", "Payday 3", "The Crew Motorfest", "Need for Speed Unbound", "F1 23", "EA Sports FC 24", "Madden NFL 24", "NBA 2K24", "MLB The Show 23", "WWE 2K24", "AEW Fight Forever",
            // --- Indies Notables en PS5 ---
            "Hades", "Cult of the Lamb", "Sifu", "Neon White", "Tunic", "Solar Ash", "The Pathless", "Bugsnax", "Disco Elysium: The Final Cut", "Little Nightmares II", "It Takes Two", "A Plague Tale: Requiem", "Chicory: A Colorful Tale", "Inscryption", "Outer Wilds (con actualización PS5)", "Risk of Rain 2", "Deep Rock Galactic", "Death's Door", "Ember Lab (desarrollador de Kena)", "Annapurna Interactive (publisher frecuente)", "Devolver Digital (publisher frecuente)", "Team Cherry (Hollow Knight: Silksong - Anticipado)", "The Forgotten City", "Twelve Minutes", "Oxenfree II: Lost Signals", "Season: A Letter to the Future", "Thirsty Suitors", "Venba", "Cocoon", "Viewfinder", "Dredge", "Humanity", "Goodbye Volcano High", "Salt and Sacrifice", "Trek to Yomi", "Endling - Extinction is Forever", "Rollerdrome", "Signalis", "Chained Echoes", "Sea of Stars", "Blasphemous 2", "The Talos Principle 2", "Jusant", "Pizza Tower (posible port)", "Dave the Diver", "Bomb Rush Cyberfunk", "World of Horror",
            // --- Remakes / Remasters / Colecciones Específicas ---
            "The Last of Us Part I", "The Last of Us Part II Remastered", "Uncharted: Legacy of Thieves Collection", "Alan Wake Remastered", "Mass Effect Legendary Edition", "Crysis Remastered Trilogy", "Tony Hawk's Pro Skater 1 + 2", "Crash Bandicoot 4: It's About Time (versión PS5)", "Life is Strange Remastered Collection", "Metal Gear Solid: Master Collection Vol. 1", "Metal Gear Solid Δ: Snake Eater (Anticipado)", "Tomb Raider I-III Remastered", "Persona Collection (concepto)", "Yakuza Remastered Collection (PS5)", "Final Fantasy Pixel Remaster", "Quake II Remastered", "Star Wars: Knights of the Old Republic Remake (Estado incierto)",
            // --- Juegos de VR (PS VR2) - Mención importante ---
            "Horizon Call of the Mountain", "Resident Evil Village VR Mode", "Gran Turismo 7 VR Mode", "Kayak VR: Mirage", "Star Wars: Tales from the Galaxy's Edge Enhanced Edition", "Moss & Moss: Book II", "No Man's Sky VR", "The Walking Dead: Saints & Sinners - Chapter 1 & 2", "Pavlov", "Firewall Ultra", "Synapse", "Crossfire: Sierra Squad", "Resident Evil 4 VR Mode", "Arizona Sunshine 2", "Beat Saber", "Pistol Whip", "Demeo", "Red Matter 2", "Before Your Eyes", "Song in the Smoke: Rekindled", "After the Fall", "Zenith: The Last City", "Among Us VR", "Job Simulator / Vacation Simulator", "Fantavision 202X", "Tentacular", "Cosmonious High", "The Light Brigade", "Synth Riders", "Walkabout Mini Golf", "Cities: VR - Enhanced Edition", "Creed: Rise to Glory - Championship Edition", "The Dark Pictures: Switchback VR", "Thumper", "Runner", "What the Bat?", "Jurassic World Aftermath Collection", "Humanity (Modo VR)", "Paper Beast Enhanced Edition", "The Last Clockwinder", "Another Fisherman's Tale", "Organ Quarter", "Propagation: Paradise Hotel", "Pixel Ripped 1978 & 1995", "Green Hell VR", "Madison VR", "Phasmophobia (Anticipado VR)", "Behemoth (Anticipado VR)", "Aces of Thunder (Anticipado VR)",
            // --- Conceptos / Hardware / Características ---
            "Tecnología del DualSense: Haptic Feedback", "Tecnología del DualSense: Adaptive Triggers", "Audio 3D Tempest Engine", "SSD Ultrarrápido y Tiempos de Carga", "Ray Tracing en PS5", "Modos Gráficos: Rendimiento vs Fidelidad", "Retrocompatibilidad de PS5 con PS4", "PlayStation Plus: Catálogo de Juegos", "PlayStation Portal (Remote Player)", "PS VR2: Especificaciones y Experiencia", "El Futuro de los Exclusivos de PlayStation", "Comparativa PS5 vs Xbox Series X", "La Evolución de PlayStation Studios", "El impacto de las Adquisiciones (Bungie, etc.)", "Cross-Play y Cross-Progression en PS5", "El mercado de juegos Indies en PlayStation", "Servicios de Suscripción vs Compra Tradicional", "Accesibilidad en juegos de PS5", "El potencial del Unreal Engine 5 en PS5", "La importancia del Diseño de Sonido en PS5", "Almacenamiento Expandible en PS5 (M.2 SSD)", "El diseño de la consola PS5", "Ediciones Especiales de Consola y Mando PS5", "Juegos como Servicio (GaaS) en PS5", "La transición generacional PS4 a PS5", "El papel de la Nube (Cloud Gaming) en PlayStation", "Desafíos de Desarrollo para PS5", "Trofeos de PlayStation: Evolución y Significado", "Actualizaciones gratuitas de PS4 a PS5", "El uso de la Activity Card UI", "Share Screen y Share Play en PS5", "Integración con Discord en PS5", "La estrategia de Sony con los PC Ports", "El ecosistema PlayStation: Consola, VR, Portal", "Juegos Free-to-Play populares en PS5", "El género RPG en PS5", "Juegos de Lucha en PS5", "Shooters en primera persona (FPS) en PS5", "Juegos de Aventura Narrativa en PS5", "Plataformas 3D en PS5", "Juegos de Carreras y Simulación en PS5", "Juegos de Terror en PS5", "Juegos Cooperativos Locales y Online en PS5", "El resurgir de los Soulslike en PS5", "Juegos con fuerte componente multijugador en PS5", "Innovación en Gameplay gracias al DualSense", "El futuro del Audio 3D", "La promesa del 8K y 120Hz en PS5", "Realidad Virtual: Más allá del entretenimiento", "El impacto de la IA en los juegos de PS5", "Mecánicas de juego únicas en títulos de PS5", "Narrativa ambiental en juegos de PS5", "Dirección artística destacada en PS5", "Banda sonora memorable en juegos de PS5", "Personajes icónicos de la generación PS5", "Momentos inolvidables en juegos de PS5", "La comunidad PlayStation", "Eventos digitales (State of Play, Showcase)", "El legado de PlayStation", "La competencia en la industria actual", "Tendencias futuras en videojuegos para consola", "El impacto de la pandemia en el lanzamiento de PS5", "Desarrollo sostenible en la industria del videojuego", "Representación y diversidad en juegos de PS5"
            // Añadir más si es necesario para llegar a ~400
        ];
        const gameThemes = [
            "exclusivos de PS5", "RPGs de PS5", "juegos de acción y aventura en PS5", "indie games en PS5",
            "shooters en PS5", "juegos de terror para PS5", "remakes y remasters de PS5", "juegos con uso intensivo del DualSense",
            "títulos de lanzamiento de PS5", "juegos multijugador populares en PS5", "aventuras narrativas en PS5",
            "juegos de mundo abierto en PS5", "plataformas 3D para PS5", "juegos de PS VR2",
            "grandes lanzamientos third-party en PS5", "juegos con Ray Tracing en PS5", "joyas ocultas de PS5",
            "próximos lanzamientos anticipados para PS5", "soulslike en PS5", "juegos de lucha en PS5",
            "simuladores de carreras en PS5", "juegos japoneses (JRPGs, etc.) en PS5"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un analista experto y entusiasta de videojuegos, especializado en la consola PlayStation 5. Tu tarea es proporcionar un análisis detallado y bien estructurado de juegos de PS5 (o conceptos relacionados con la plataforma). Describe la premisa, jugabilidad central, innovaciones (especialmente el uso del DualSense, audio 3D, SSD), apartado gráfico y técnico en PS5, diseño de sonido, narrativa (si aplica), puntos fuertes y débiles, recepción crítica y comercial, y su relevancia dentro del catálogo de PS5 o del género. Si es un concepto, explícalo detalladamente con ejemplos de juegos. Usa un lenguaje claro, atractivo y objetivo, apto para jugadores informados. El objetivo es un análisis de aproximadamente 1200-1300 palabras. Basa tu análisis únicamente en el siguiente juego o concepto de PS5:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un catálogo de videojuegos. Genera exactamente 15 títulos de juegos de PlayStation 5 (PS5) o conceptos clave relacionados con la consola/ecosistema PS5, adecuados para ser analizados en detalle. Devuelve *solo* la lista de títulos/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Contenedor del texto + imagen final
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ========== (Sin cambios funcionales)
        async function fetchTextFromApi(prompt, config) { /* ... */
            const encodedPrompt = encodeURIComponent(prompt);
            const encodedSystem = encodeURIComponent(config.systemPrompt);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo.`);
                throw new Error(`Error de comunicación con la API: ${error.message}`);
            }
         }
        async function fetchExplanationText(conceptTitle) { /* ... */
            const text = await fetchTextFromApi(conceptTitle, textApiConfig);
             if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de")) {
                  throw new Error("La IA no pudo generar un análisis adecuado o suficientemente detallado para este título/concepto.");
              }
            return text;
        }
        async function fetchGeneratedTitles() { /* ... */
            const randomTheme = getRandomElement(gameThemes) || "juegos populares de PS5";
            const specificPrompt = `Genera 15 títulos de juegos de PS5 o conceptos clave sobre ${randomTheme}`;
            console.log("Generating titles with prompt:", specificPrompt);
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
            const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150); // Min length 3 for game titles
            if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de títulos.");
            return titles.slice(0, 15);
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a JUEGOS PS5
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 1024, height: 576, nologo: true }; // Ratio 16:9
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "PlayStation 5 gameplay moment";
            // Prompt ENFOCADO en arte conceptual, atmósfera del juego.
            const enhancedPrompt = `High-quality concept art inspired by the PS5 game '${safePromptText}'. Focus on atmospheric visuals, key characters or environments, gameplay essence, vibrant colors or specific mood. Cinematic, detailed digital painting style.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            // NEGATIVE PROMPT: Evitar texto, logos, UI, fotos realistas.
            const negativePrompt = "text, words, title, logo, UI elements, HUD, button prompts, controller overlay, menu, screenshot, photograph, real person, blurry, low quality, multiple panels, collage, text overlay, watermark, signature";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            // Basic Markdown-like replacements
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); // Remove \text{} potentially from math mode if API adds it
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); // Subscript basic
            formatted = formatted.replace(/(\w)\^\{?([\w\d+\-−*]+)\}?/g, (match, base, exponent) => { // Superscript basic (allow more chars)
                const cleanExponent = exponent.replace('−', '-');
                return `${base}<sup>${cleanExponent}</sup>`;
            });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); // Arrow
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); // Display math (less likely, but safe)
            // Headers
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            // Emphasis
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Paragraphs (split by double newline, then wrap non-header blocks in <p>)
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) {
                    return block; // Keep headers/formulas as is
                }
                // Handle potential list items (simple heuristic: starts with *, -, or number.)
                if (block.match(/^[\*\-]\s+/) || block.match(/^\d+\.\s+/)) {
                     // Basic list handling - wrap lines in <li>, could be improved
                     const listItems = block.split('\n').map(item => `<li>${item.replace(/^[\*\-\d\.]+\s*/, '').trim()}</li>`).join('');
                     const listType = block.startsWith('*') || block.startsWith('-') ? 'ul' : 'ol';
                     return `<${listType}>${listItems}</${listType}>`;
                }
                // Regular paragraph: replace single newlines with <br> within the block
                let content = block.replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');

            return formatted;
        }


        // ========== MODAL FUNCTIONS ========== (Sin cambios funcionales)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = ''; // Clear previous text and image
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (Sin cambios funcionales)
        function getRandomElement(arr) { /* ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... */
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]);
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay títulos disponibles.</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        // *** MODIFIED: handleTitleClick (Functionality identical to previous version) ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = ''; // Clear previous content
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // 1. Fetch and format text
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // 2. Stop loading indicator, display text FIRST
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation; // Inject text content
                modalStoryContentArea.classList.remove('content-hidden');

                 // 3. *** RESET SCROLL *** after text content is in and visible
                modalContent.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // 4. Prepare and append image placeholder/spinner WITHIN #modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder'; // Class for styling
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando imagen conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Add placeholder at the end

                // 5. Create and append the actual image element (starts loading)
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image'; // Class for styling
                imgElement.alt = `Arte conceptual de ${title}`; // Alt text updated
                imgElement.style.display = 'none'; // Hide until loaded

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove(); // Remove the placeholder
                    imgElement.style.display = 'block'; // Show the image
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-ban placeholder-icon"></i> <!-- Changed icon -->
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">No se pudo cargar la imagen.</p>
                    `; // Update placeholder on error
                };

                // Get URL and set src AFTER attaching handlers
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append the image element to the content
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">Error al generar URL de imagen.</p>
                    `;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = ''; // Clear partial content on error
            }
        }

        async function handleGenerateMoreTitles() { /* ... */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando...'; // Thematic text
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; // Hide button temporarily
                     appendTitles(newTitles);
                     // Move button back to the end of the grid container
                     if (titleListContainer && titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block'; // Show button again
                 } else {
                     alert("No se pudieron encontrar más juegos en la base de datos."); // Thematic text
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al cargar más juegos: ${error.message}`); // Thematic text
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Cargar Más Juegos'; // Thematic text
             }
         }


        // ========== INITIALIZATION ========== (Sin cambios funcionales)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) {
                console.error("Initialization failed! Critical elements missing.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: sans-serif;">Error crítico: No se pudieron cargar los componentes principales de la aplicación.</p>';
                return;
            }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            // Close modal if clicking outside the content wrapper
            storyModal.addEventListener('click', (event) => {
                if (event.target === storyModal) {
                    hideModal();
                }
            });
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>