<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon Ball: What If...? - Historias Alternas IA</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fonts: Bangers for Titles, Oswald for headings, Nunito for body -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Oswald:wght@400;700&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #f97316; /* Orange */
            --color-secondary: #3b82f6; /* Blue */
            --color-accent: #facc15; /* Yellow */
            --color-background: #1e293b; /* Dark Slate Blue */
            --color-text: #f1f5f9; /* Light Slate Gray */
            --color-text-darker: #94a3b8; /* Medium Slate Gray */
            --color-modal-bg: #334155; /* Darker Slate Blue */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.5);
            --border-radius: 6px;
            --transition-normal: all 0.2s ease-in-out;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
             /* Optional subtle background pattern */
            background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23334155' fill-opacity='0.1'%3E%3Cpath d='M80 0v80H0V0h80zM40 0c22.09139 0 40 17.90861 40 40S62.09139 80 40 80 0 62.09139 0 40 17.90861 0 40 0zm0 8c17.673112 0 32 14.326888 32 32s-14.326888 32-32 32S8 57.673112 8 40 22.326888 8 40 8z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* Titles using Bangers */
        h1.page-title, .logo, #modal-title {
            font-family: 'Bangers', cursive;
            color: var(--color-primary);
            letter-spacing: 2px;
            -webkit-text-stroke: 1px #0f172a; /* Outline effect */
             text-stroke: 1px #0f172a;
             paint-order: stroke fill;
        }
         h2.section-title {
            font-family: 'Oswald', sans-serif;
            font-weight: 700;
            color: var(--color-accent);
            text-transform: uppercase;
            border-bottom: 3px solid var(--color-secondary);
            padding-bottom: 0.5rem;
            display: inline-block;
         }
         #modal-title { /* Specific modal title adjustments */
             -webkit-text-stroke-width: 0.5px; /* Thinner stroke */
             text-stroke-width: 0.5px;
             margin-bottom: 1.5rem; /* More space */
             line-height: 1.1;
         }


        .navbar {
            background: linear-gradient(to right, #0f172a, #1e293b); /* Gradient background */
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            position: sticky;
            top: 0;
            z-index: 20;
            border-bottom: 2px solid var(--color-secondary);
        }

        /* Title List Styling */
        #title-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.25rem;
        }

        .title-item {
            background: linear-gradient(135deg, var(--color-modal-bg), #475569); /* Gradient item */
            padding: 1.25rem 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: var(--transition-normal);
            text-align: center;
            font-weight: 600;
            color: var(--color-text);
            border: 1px solid #64748b; /* Slate border */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70px;
        }

        .title-item:hover {
            transform: scale(1.03);
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.6); /* Orange glow */
            border-color: var(--color-primary);
            color: white;
        }

        /* Generate More Button */
        #generate-more-btn {
             grid-column: 1 / -1;
             background: linear-gradient(to right, var(--color-secondary), #2563eb); /* Blue gradient */
             color: white;
             padding: 0.75rem 1.5rem;
             border: none;
             border-radius: 30px; /* Pill shape */
             font-family: 'Oswald', sans-serif;
             font-weight: bold;
             cursor: pointer;
             transition: var(--transition-normal);
             margin-top: 2rem;
             text-transform: uppercase;
             letter-spacing: 1px;
             box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }
        #generate-more-btn:hover:not(:disabled) {
             background: linear-gradient(to right, #1d4ed8, #2563eb); /* Darker blue */
             box-shadow: 0 4px 10px rgba(59, 130, 246, 0.5);
             transform: translateY(-2px);
        }
         #generate-more-btn:active:not(:disabled) {
             transform: translateY(0px);
             box-shadow: 0 1px 3px rgba(0,0,0,0.4);
         }
         #generate-more-btn:disabled {
             background: var(--color-text-darker);
             color: #cbd5e1;
             cursor: not-allowed;
             opacity: 0.7;
         }
         #generate-more-btn .fa-sync-alt {
             color: white;
         }


        /* Modal Styling */
        #story-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(15, 23, 42, 0.92); /* Darker Slate overlay */
            display: none; align-items: center; justify-content: center;
            z-index: 50; padding: 1rem;
        }
        #story-modal.active { display: flex; }

        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            border: 2px solid var(--color-secondary);
            padding: 1.5rem 2rem; /* More horizontal padding */
            max-width: 800px; width: 95%; max-height: 90vh;
            overflow: hidden; /* Hide wrapper scroll */
            position: relative; box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column;
        }

        .modal-close-btn {
            position: absolute; top: 10px; right: 10px;
            background: var(--color-text-darker); border: none; border-radius: 50%;
            width: 35px; height: 35px; font-size: 1.5rem; font-weight: bold;
            color: var(--color-background); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition-normal); z-index: 10;
        }
        .modal-close-btn:hover {
            background-color: var(--color-primary); color: white; transform: rotate(180deg);
        }

        /* --- Modal Content Order & Scroll --- */
        #modal-title { /* Bangers font applied globally */
             line-height: 1.2; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0;
        }

        #modal-content { /* Text Area */
            line-height: 1.7; color: var(--color-text); white-space: pre-wrap;
            overflow-y: auto; margin-bottom: 1.5rem; padding-right: 10px;
            flex-grow: 1; min-height: 0; /* Essential for scroll */
            scrollbar-width: thin; scrollbar-color: var(--color-accent) var(--color-background);
        }
        #modal-content::-webkit-scrollbar { width: 8px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-background); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-accent); border-radius: 4px; border: 2px solid var(--color-background); }
        #modal-content p:not(:last-child) { margin-bottom: 1em; }


        #modal-image-container { /* Image Area */
            width: 100%; height: 250px; /* Taller image */
            background-color: #0f172a; /* Darkest slate */
            border-radius: var(--border-radius); overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--color-secondary); flex-shrink: 0;
        }
        #modal-image-container img {
            width: 100%; height: 100%; object-fit: cover; display: none;
            /* No pixelation needed for DB style */
        }
        #modal-image-container .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1); width: 36px; height: 36px;
            border-radius: 50%; border-left-color: var(--color-primary); /* Orange spinner */
            animation: spin 1s linear infinite; display: none;
        }
        #modal-image-container .placeholder-icon {
             font-size: 3rem; color: var(--color-secondary); display: none;
        }

        /* Loading Indicator */
        #modal-loading {
            text-align: center; padding: 3rem 0; position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--color-modal-bg); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 5;
            border-radius: var(--border-radius);
        }
        .loading-spinner-modal {
            width: 60px; height: 60px; border: 6px solid var(--color-secondary);
            border-top-color: var(--color-primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 1rem auto;
        }
        #modal-loading p {
            font-family: 'Oswald', sans-serif; font-weight: 700;
            color: var(--color-text); font-size: 1.2rem; text-transform: uppercase;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }
        }

        /* Error message styling */
        .error-msg {
            background-color: rgba(220, 38, 38, 0.15); /* Red tint */
            color: #f87171; /* Lighter Red */
            padding: 1rem; border-radius: var(--border-radius);
            border: 1px solid #ef4444; /* Red border */
            margin-top: 1rem; text-align: center; flex-shrink: 0;
        }
        .error-msg i { margin-right: 0.5rem; }
        .content-hidden { display: none; }

    </style>
</head>
<body>
    <!-- Header/Navbar -->
    <nav class="navbar mb-10"> <!-- More margin -->
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <h1 class="logo text-3xl sm:text-4xl">
                    <i class="fas fa-dragon mr-2"></i> Dragon Ball: What If...?
                </h1>
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <main class="container mx-auto px-4 pb-16">
        <!-- Hero section -->
        <section class="mb-12 text-center">
            <h1 class="page-title text-6xl sm:text-7xl mb-4">Explora Otras Líneas Temporales</h1>
            <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto">¿Qué hubiera pasado si...? Elige un escenario y la IA reescribirá la historia. ¡Su poder es de más de 9000!</p>
        </section>

        <!-- Title List Container -->
        <section class="mb-10">
            <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                <i class="fas fa-scroll text-yellow-400 mr-2"></i>
                Escenarios Alternativos
            </h2>
            <div id="title-list">
                 <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg">Detectando anomalías temporales...</p>
            </div>
            <div id="generate-more-container" class="text-center mt-8">
                <button id="generate-more-btn">
                     <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                    Explorar Más Posibilidades
                 </button>
            </div>
        </section>

    </main>

    <!-- Story Modal -->
    <div id="story-modal">
        <div class="modal-content-wrapper">
            <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

            <!-- Loading Indicator -->
            <div id="modal-loading">
                <div class="loading-spinner-modal"></div>
                <p>Calculando divergencia...</p>
            </div>

            <!-- Content Area -->
            <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                <h2 id="modal-title" class="text-3xl md:text-4xl mb-4"></h2>
                <!-- Text Content (Scrollable) -->
                <div id="modal-content" class="text-lg">
                    <!-- Story text here -->
                </div>
                 <!-- Image Container -->
                <div id="modal-image-container">
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <img id="modal-image" alt="Ilustración del escenario alternativo" />
                </div>
                 <!-- Error Display Area -->
                <div id="modal-error" class="error-msg content-hidden">
                     <i class="fas fa-exclamation-triangle"></i>
                     <span id="modal-error-message"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-black text-gray-600 py-5 mt-12">
        <div class="container mx-auto px-4 text-center text-xs">
            <p>Historias generadas por IA. Inspirado en Dragon Ball de Akira Toriyama / Bird Studio / Shueisha / Toei Animation. No afiliado.</p>
            <p class="mt-1">© 2025 What If DB</p>
        </div>
    </footer>

    <script>
        // ========== CONFIG & DATA ==========

        // --- Expanded DB "What If" Titles (> 150) ---
        const predefinedTitles = [
            "¿Qué pasaría si Goku nunca se hubiera golpeado la cabeza?", "¿Qué pasaría si Raditz se hubiera unido a los Guerreros Z?",
            "¿Qué pasaría si Nappa hubiera sobrevivido?", "¿Qué pasaría si Vegeta hubiera derrotado a Goku en la Tierra?",
            "¿Qué pasaría si Krilin hubiera matado a Vegeta?", "¿Qué pasaría si Gohan hubiera continuado su entrenamiento después de Cell?",
            "¿Qué pasaría si Goku hubiera llegado a Namek antes?", "¿Qué pasaría si Vegeta hubiera alcanzado el Super Saiyan en Namek?",
            "¿Qué pasaría si Dende hubiera deseado la inmortalidad para Freezer?", "¿Qué pasaría si Nail se hubiera fusionado con Gohan?",
            "¿Qué pasaría si Goku hubiera usado el Kaioken x100 contra Freezer?", "¿Qué pasaría si Freezer hubiera destruido Namek inmediatamente?",
            "¿Qué pasaría si el Capitán Ginyu se hubiera quedado con el cuerpo de Goku?", "¿Qué pasaría si Bardock hubiera sobrevivido y llegado a la Tierra?",
            "¿Qué pasaría si el Rey Vegeta hubiera derrotado a Freezer?", "¿Qué pasaría si Trunks del futuro hubiera llegado durante la saga Saiyan?",
            "¿Qué pasaría si Goku hubiera muerto por el virus del corazón?", "¿Qué pasaría si el Dr. Gero hubiera creado androides buenos?",
            "¿Qué pasaría si Cell hubiera absorbido a Krilin en lugar de C-17?", "¿Qué pasaría si Vegeta hubiera dejado que Cell alcanzara la perfección?",
            "¿Qué pasaría si Gohan SSJ2 hubiera matado a Cell inmediatamente?", "¿Qué pasaría si Goku se hubiera quedado muerto después de Cell?",
            "¿Qué pasaría si Mr. Satan hubiera sido expuesto durante los Cell Games?", "¿Qué pasaría si Videl nunca hubiera aprendido a volar?",
            "¿Qué pasaría si Gohan hubiera derrotado a Dabura fácilmente?", "¿Qué pasaría si Vegeta nunca hubiera sucumbido a Babidi (Majin Vegeta)?",
            "¿Qué pasaría si Majin Buu (Gordo) nunca se hubiera hecho amigo de Mr. Satan?", "¿Qué pasaría si Gotenks hubiera derrotado a Super Buu?",
            "¿Qué pasaría si Gohan Místico hubiera derrotado a Buu-Gotenks?", "¿Qué pasaría si Goku no hubiera perdido el pendiente Pothara?",
            "¿Qué pasaría si Vegetto hubiera destruido a Buu inmediatamente?", "¿Qué pasaría si Buu Pequeño hubiera ganado?",
            "¿Qué pasaría si Uub nunca hubiera aparecido?", "¿Qué pasaría si Beerus hubiera destruido la Tierra?",
            "¿Qué pasaría si Goku hubiera aceptado ser un Dios de la Destrucción?", "¿Qué pasaría si Vegeta hubiera alcanzado el Super Saiyan Dios primero?",
            "¿Qué pasaría si Golden Freezer hubiera entrenado más tiempo?", "¿Qué pasaría si Zamasu hubiera deseado algo diferente?",
            "¿Qué pasaría si Goku Black hubiera ganado?", "¿Qué pasaría si el Torneo del Poder hubiera tenido reglas diferentes?",
            "¿Qué pasaría si el Universo 7 hubiera perdido el Torneo del Poder?", "¿Qué pasaría si Jiren hubiera pedido un deseo diferente?",
            "¿Qué pasaría si Broly (DBS) hubiera sido encontrado por Goku primero?", "¿Qué pasaría si Moro hubiera absorbido a Beerus?",
            "¿Qué pasaría si Granola hubiera deseado ser el más fuerte PARA SIEMPRE?", "¿Qué pasaría si Gas hubiera derrotado a Goku y Vegeta?",
            "¿Qué pasaría si Black Freezer hubiera aparecido antes?", "¿Qué pasaría si Goku y Vegeta nunca se hubieran fusionado?",
            "¿Qué pasaría si Goten y Trunks se tomaran el entrenamiento en serio?", "¿Qué pasaría si Piccolo se hubiera vuelto malvado de nuevo?",
            "¿Qué pasaría si Yamcha fuera el guerrero más fuerte?", "¿Qué pasaría si Tenshinhan hubiera seguido siendo rival de Goku?",
            "¿Qué pasaría si Chaos hubiera alcanzado un gran poder?", "¿Qué pasaría si Bulma se hubiera convertido en luchadora?",
            "¿Qué pasaría si el Maestro Roshi hubiera seguido entrenando intensamente?", "¿Qué pasaría si Pan alcanzara el Super Saiyan de niña?",
            "¿Qué pasaría si Bra (Bulla) tuviera potencial de lucha como su padre?", "¿Qué pasaría si Tarble hubiera sido un guerrero de élite?",
            "¿Qué pasaría si Raditz y Goku hubieran entrenado juntos?", "¿Qué pasaría si Gine (madre de Goku) hubiera escapado con él?",
            "¿Qué pasaría si el Planeta Vegeta nunca hubiera sido destruido?", "¿Qué pasaría si los Saiyans hubieran conquistado la Tierra?",
            "¿Qué pasaría si Turles hubiera ganado?", "¿Qué pasaría si Lord Slug hubiera recuperado su juventud permanentemente?",
            "¿Qué pasaría si Cooler hubiera derrotado a Goku?", "¿Qué pasaría si el Androide 13 hubiera absorbido a Goku?",
            "¿Qué pasaría si Broly (Z) hubiera ganado en su primera aparición?", "¿Qué pasaría si Bojack hubiera conquistado la Tierra?",
            "¿Qué pasaría si Janemba no hubiera sido derrotado?", "¿Qué pasaría si Hildegarn hubiera sido incontrolable?",
            "¿Qué pasaría si Tapion se hubiera quedado en el presente?", "¿Qué pasaría si existiera un Super Saiyan 4 canónico?",
            "¿Qué pasaría si Goku hubiera aprendido el Ultra Instinto antes?", "¿Qué pasaría si Vegeta hubiera aprendido el Hakai de Beerus?",
            "¿Qué pasaría si Gohan hubiera dominado el estado Místico como Goku el SSJ?", "¿Qué pasaría si Piccolo se fusionara con Kami permanentemente desde el principio?",
            "¿Qué pasaría si el Dr. Brief hubiera construido armas anti-Saiyan?", "¿Qué pasaría si la Patrulla Roja hubiera triunfado?",
            "¿Qué pasaría si Tao Pai Pai hubiera matado a Goku?", "¿Qué pasaría si el Rey Piccolo hubiera conquistado el mundo?",
            "¿Qué pasaría si Goku no hubiera conocido a Bulma?", "¿Qué pasaría si Krilin nunca hubiera muerto?",
            "¿Qué pasaría si Launch (Lunch) controlara sus transformaciones?", "¿Qué pasaría si Pilaf hubiera pedido ser joven y fuerte?",
            "¿Qué pasaría si las Esferas del Dragón tuvieran límites más estrictos?", "¿Qué pasaría si Porunga pudiera conceder cualquier deseo?",
            "¿Qué pasaría si Super Shenron fuera malvado?", "¿Qué pasaría si Zeno Sama se aburriera de los universos?",
            "¿Qué pasaría si el Gran Sacerdote (Daishinkan) se rebelara?", "¿Qué pasaría si los Ángeles pudieran luchar libremente?",
            "¿Qué pasaría si Vados fuera más fuerte que Whis?", "¿Qué pasaría si hubiera un universo sin Saiyans?",
            "¿Qué pasaría si los Namekianos fueran una raza conquistadora?", "¿Qué pasaría si la raza de Freezer fuera pacífica?",
            "¿Qué pasaría si los Demonios del Frío fueran héroes?", "¿Qué pasaría si los Androides hubieran protegido la Tierra?",
            "¿Qué pasaría si Majin Buu hubiera absorbido a Beerus?", "¿Qué pasaría si Cell hubiera absorbido a Majin Buu?",
            "¿Qué pasaría si Baby (GT) hubiera poseído a Goku?", "¿Qué pasaría si los Dragones Oscuros (GT) hubieran ganado?",
            "¿Qué pasaría si Super Androide 17 (GT) fuera invencible?", "¿Qué pasaría si Goku Jr. y Vegeta Jr. se encontraran antes?",
            "¿Qué pasaría si la fusión Pothara fuera permanente como se dijo al principio?", "¿Qué pasaría si la Danza Metamoru no tuviera límite de tiempo?",
            "¿Qué pasaría si Gogeta y Vegetto lucharan entre sí?", "¿Qué pasaría si existiera una fusión triple?",
            "¿Qué pasaría si Bulma inventara un anulador de Ki?", "¿Qué pasaría si Chi-Chi hubiera seguido luchando?",
            "¿Qué pasaría si Goku se hubiera casado con Bulma?", "¿Qué pasaría si Vegeta se hubiera quedado con Bulma del futuro?",
            "¿Qué pasaría si Mirai Trunks nunca hubiera regresado a su tiempo?", "¿Qué pasaría si Mai del futuro tuviera habilidades especiales?",
            "¿Qué pasaría si el Torneo de Cell hubiera sido un Battle Royale?", "¿Qué pasaría si el Torneo del Poder fuera de eliminación directa?",
            "¿Qué pasaría si Hit pudiera detener el tiempo indefinidamente?", "¿Qué pasaría si Cabba alcanzara el Super Saiyan 3?",
            "¿Qué pasaría si Caulifla y Kale se fusionaran con Pothara (Kefla Definitiva)?", "¿Qué pasaría si Toppo Dios de la Destrucción fuera el más fuerte?",
            "¿Qué pasaría si Dyspo fuera más rápido que la luz?", "¿Qué pasaría si Ribrianne hubiera ganado los corazones de todos?",
            "¿Qué pasaría si Monaka realmente fuera súper fuerte?", "¿Qué pasaría si Jaco fuera un luchador de élite?",
            "¿Qué pasaría si Frost fuera realmente bueno?", "¿Qué pasaría si Magetta fuera inmune a los insultos?",
            "¿Qué pasaría si Botamo no pudiera ser dañado?", "¿Qué pasaría si el Universo 6 hubiera ganado el torneo contra el 7?",
            "¿Qué pasaría si Champa hubiera conseguido las Super Esferas del Dragón?", "¿Qué pasaría si Goku hubiera usado el Mafuba contra Zamasu?",
            "¿Qué pasaría si Gowasu hubiera detenido a Zamasu antes?", "¿Qué pasaría si el Plan Cero Mortales hubiera tenido éxito?",
            "¿Qué pasaría si Arale fuera un personaje canónico en Super?", "¿Qué pasaría si las Fuerzas Especiales Ginyu fueran una amenaza real?",
            "¿Qué pasaría si Zarbon y Dodoria hubieran traicionado a Freezer?", "¿Qué pasaría si Cui fuera rival de Vegeta?",
            "¿Qué pasaría si el Imperio de Freezer nunca hubiera caído?", "¿Qué pasaría si King Cold fuera el verdadero Emperador del Mal?",
            "¿Qué pasaría si Babidi hubiera controlado a Cell?", "¿Qué pasaría si Dabura hubiera luchado contra Goku SSJ3?",
            "¿Qué pasaría si Pui Pui o Yakon hubieran sido un desafío?", "¿Qué pasaría si el Supremo Kaiosama fuera un guerrero formidable?",
            "¿Qué pasaría si Kibito Kai nunca se hubiera separado?", "¿Qué pasaría si el Anciano Kaiosama no hubiera sido liberado de la Espada Z?",
            "¿Qué pasaría si la Espada Z nunca se hubiera roto?", "¿Qué pasaría si Gohan se hubiera quedado atrapado en la Habitación del Tiempo?"
        ];

        // --- NEW: DB themes for title generation variety ---
        const dragonBallThemes = [
            "Goku", "Vegeta", "Gohan", "Piccolo", "Trunks", "Goten", "Krilin", "Bulma", "Freezer", "Cell", "Majin Buu",
            "los Androides", "la saga Saiyan", "la saga de Namek", "los Cell Games", "la saga de Buu", "Dragon Ball Super",
            "el Torneo del Poder", "las fusiones (Gotenks, Vegetto, Gogeta)", "las transformaciones Super Saiyan",
            "el Ultra Instinto", "el Ultra Ego", "los Dioses de la Destrucción", "los Ángeles", "Zeno Sama",
            "viajes en el tiempo", "líneas temporales alternativas", "villanos ganando", "héroes volviéndose malos",
            "personajes secundarios obteniendo poder", "las Esferas del Dragón", "el Planeta Vegeta", "los Namekianos",
            "el ejército de Freezer", "la Patrulla Roja", "el Otro Mundo", "las películas Z (Broly, Janemba, etc.)", "Dragon Ball GT"
        ];

        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un gran conocedor del universo Dragon Ball y un excelente narrador. Explora de forma creativa y coherente las consecuencias de un escenario hipotético ('What If...?') en el universo Dragon Ball. Describe cómo cambiarían los eventos, las interacciones entre personajes, los niveles de poder y el posible destino de esa línea temporal alternativa. Escribe una historia corta (aprox. 300-500 palabras) basada únicamente en el siguiente título:",
            timeoutSeconds: 60
        };

         const titleGenerationConfig = {
             model: "mistral",
             systemPrompt: "Actúa como un generador de ideas conciso y creativo. Genera exactamente 15 ideas de títulos intrigantes para escenarios hipotéticos ('What if...?') del universo Dragon Ball, basados en el tema proporcionado. Devuelve *solo* la lista de títulos, uno por línea. No incluyas números, guiones, introducciones ni despedidas. Cada línea debe ser solo un título tipo '¿Qué pasaría si...?' o similar.",
             // prompt set dynamically
             timeoutSeconds: 30,
             // seed set dynamically
         };

        // ========== DOM ELEMENTS ========== (Variables remain the same)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ==========

        async function fetchTextFromApi(prompt, config) {
            const encodedPrompt = encodeURIComponent(prompt);
            const encodedSystem = encodeURIComponent(config.systemPrompt);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Seed: ${config.seed || 'N/A'}): ${url}`); // Log URL

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
            }
        }

        async function fetchStoryText(title) {
             const text = await fetchTextFromApi(title, textApiConfig);
              if (text.trim().length < 50 || text.toLowerCase().includes("cannot fulfill")) {
                  throw new Error("La IA no pudo generar una historia adecuada para este título.");
              }
             return text;
        }

        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(dragonBallThemes) || "personajes secundarios"; // Get random theme
            const specificPrompt = `Genera 15 títulos de historias 'What if...?' de Dragon Ball sobre ${randomTheme}`; // Create specific prompt
            console.log("Generating titles with prompt:", specificPrompt);

            const configForThisRequest = {
                ...titleGenerationConfig,
                seed: Math.floor(Math.random() * 1000000) // Add random seed
            };

            const text = await fetchTextFromApi(specificPrompt, configForThisRequest); // Use specific prompt and config

            const titles = text.split('\n')
                               .map(line => line.replace(/^[-\d.\s*]+/, '').trim()) // Clean list markers
                               .filter(line => line.length > 10 && line.length < 150 && (line.toLowerCase().startsWith("¿qué pasaría si") || line.toLowerCase().startsWith("what if"))); // Filter for valid titles
            if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de títulos válidas.");
            return titles.slice(0, 15);
        }

        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText.replace(/^¿Qué pasaría si |^What if /i, '') : "Goku fighting"; // Remove prefix for better image prompt
            // Enhanced DB style prompt
            const enhancedPrompt = `Dragon Ball Z anime art style, Akira Toriyama style, dynamic action scene depicting '${safePromptText}', vibrant colors, energy aura, intense expression, clean line art`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, letters, UI, interface, menu, buttons, overlay, watermark, signature, writing, 3d render, realistic, photorealistic, low quality, blurry";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== MODAL FUNCTIONS ========== (Logic unchanged)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { if(!storyModal) return; storyModal.classList.remove('active'); document.body.style.overflow = ''; resetModalState(); }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = ''; modalContent.textContent = ''; modalContent.scrollTop = 0;
             modalImage.src = ''; modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none';
             modalImageContainer.style.display = 'flex'; modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (Logic unchanged)
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let currentIndex = array.length, randomIndex; while (currentIndex > 0) { randomIndex = Math.floor(Math.random() * currentIndex); currentIndex--; [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]]; } return array; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { if (!titleListContainer || !titlesLoading) return; const shuffledTitles = shuffleArray([...titles]); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none'; if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center">No hay escenarios disponibles.</p>'; return; } shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        async function handleTitleClick(title) {
            resetModalState(); showModal(); modalTitle.textContent = title;
            modalContent.textContent = ''; modalImageContainer.style.display = 'none';
            modalError.classList.add('content-hidden'); modalLoadingIndicator.style.display = 'flex';

            try {
                const storyText = await fetchStoryText(title);
                modalLoadingIndicator.style.display = 'none'; modalContent.textContent = storyText;
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'flex'; modalImageSpinner.style.display = 'block';

                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image for title:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else { console.error("Could not create image URL for title:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; }
            } catch (error) {
                console.error("Failed to display story:", error); modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `${error.message}`; modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); modalImageContainer.style.display = 'none';
                modalContent.textContent = '';
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Generando...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Uses varied prompt + seed
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se pudieron generar nuevas posibilidades en este momento."); }
             } catch (error) { console.error("Failed to generate more titles:", error); alert(`Error al generar más posibilidades: ${error.message}`); }
             finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Posibilidades'; }
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Initialization failed: Critical elements missing."); document.body.innerHTML = '<p style="padding: 2rem; text-align: center; color: red;">Error crítico al cargar la página. Faltan elementos esenciales.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal); generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles); // Display initial shuffled list
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>