<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invasión Robótica Multiversal - Archivos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Tech/Digital -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Aldrich&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Invasión Robótica Multiversal --- */
        :root {
            --color-primary: #00ffcc; /* Verde Menta Neón */
            --color-secondary: #9d00ff; /* Púrpura Neón */
            --color-tertiary: #0077ff; /* Azul Eléctrico */
            --color-background: #050810; /* Azul casi negro */
            --color-text: #c0f0ff; /* Azul pálido */
            --color-text-muted: #88a1b9; /* Gris azulado */
            --color-modal-bg: #0a1020; /* Azul oscuro */
            --color-border: #2a3a59; /* Borde azul grisáceo */
            --color-error-bg: #2d0f0f; /* Fondo error rojo muy oscuro */
            --color-error-text: #ffbaba; /* Texto error rosa pálido */
            --color-error-border: #ff4444; /* Borde error rojo neón */

            --shadow-glow-sm: 0 0 8px rgba(0, 255, 204, 0.2);
            --shadow-glow-md: 0 0 15px rgba(0, 255, 204, 0.3);
            --shadow-glow-lg: 0 0 30px -5px rgba(0, 255, 204, 0.4), 0 0 15px -5px rgba(0, 255, 204, 0.2);
            --border-radius: 2px; /* Bordes muy afilados/digitales */
            --transition-normal: all 0.2s ease-in-out;
        }

        @keyframes subtle-glitch { /* Animación sutil */
          0%, 100% { transform: none; opacity: 1; }
          33% { transform: translateX(1px) skewX(-0.5deg); opacity: 0.98; }
          66% { transform: translateX(-1px) skewX(0.5deg); opacity: 0.99; }
        }

        body { font-family: 'Roboto', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 300; /* animation: subtle-glitch 8s infinite linear alternate; */ } /* Glitch opcional en body */
        h1, h2, h3, h4, .logo { font-family: 'Aldrich', sans-serif; letter-spacing: 1.5px; text-transform: uppercase; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 8px rgba(0, 255, 204, 0.7); }
        h2.section-title { color: var(--color-text); border-bottom: 1px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 400; }
        #modal-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 5px rgba(0, 255, 204, 0.5); }
        .navbar { background-color: rgba(5, 8, 16, 0.85); backdrop-filter: blur(5px); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(10, 16, 32, 0.8); color: var(--color-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.4); transition: var(--transition-normal); font-family: 'Share Tech Mono', monospace; }
        #search-input::placeholder { color: var(--color-text-muted); opacity: 0.7; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(0, 255, 204, 0.3), inset 0 1px 3px rgba(0,0,0,0.4); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.1rem 0.9rem; border-radius: var(--border-radius); box-shadow: var(--shadow-glow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: start; min-height: 60px; font-family: 'Share Tech Mono', monospace; font-size: 0.95rem; border-left: 4px solid var(--color-border); }
        .title-item:hover { transform: translateX(5px); box-shadow: var(--shadow-glow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #0f172a; border-left-color: var(--color-primary); }
        .title-item::before { content: ">_"; margin-right: 8px; color: var(--color-text-muted); transition: color 0.2s ease;}
        .title-item:hover::before { color: var(--color-primary); }

        #generate-more-btn { grid-column: 1 / -1; background: var(--color-primary); color: var(--color-background); padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Aldrich', sans-serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; letter-spacing: 1px; text-shadow: none; box-shadow: var(--shadow-glow-sm); }
        #generate-more-btn:hover:not(:disabled) { background: #33ffe0; box-shadow: var(--shadow-glow-md); transform: translateY(-2px); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(5, 8, 16, 0.92); backdrop-filter: blur(3px); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-secondary); /* Purple border */
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 1000px; /* Wider for better game/chat layout */
            width: 96%;
            max-height: 95vh;
            min-height: 450px; /* Ensure space for game/content */
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 25px rgba(157, 0, 255, 0.3); /* Purple glow */
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 8px; right: 8px; background: var(--color-border); border: 1px solid var(--color-secondary); border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: #fff; transform: rotate(90deg); box-shadow: 0 0 10px var(--color-secondary); }
        #modal-title { font-size: 1.7rem; text-align: center; margin-bottom: 1rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.2; }

        /* Main Content Area (Text + Image) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(42, 58, 89, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 6px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(42, 58, 89, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }

        #modal-content { padding: 0 5px; font-family: 'Roboto'; font-weight: 300; font-size: 0.98rem;}
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Aldrich', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px dashed var(--color-border); padding-bottom: 0.4em; font-weight: 400; letter-spacing: 1px;}
        #modal-content h1 { font-size: 1.4em; } #modal-content h2 { font-size: 1.25em; } #modal-content h3 { font-size: 1.1em; color: var(--color-tertiary); } #modal-content h4 { font-size: 1em; color: var(--color-text-muted); border-bottom: none;}
        /* Image styles */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: var(--shadow-glow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-glow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); font-family: 'Share Tech Mono'; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(42, 58, 89, 0.7); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 0.8s linear infinite; margin-bottom: 0.7rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2rem; color: var(--color-tertiary); }
        #modal-content .image-placeholder p {font-size: 0.85em; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; font-family: 'Share Tech Mono', monospace; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.6rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(5, 8, 16, 0.6); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(42, 58, 89, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 5px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(42, 58, 89, 0.5); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); }
        .chat-message { margin-bottom: 0.5rem; padding: 0.4rem 0.7rem; border-radius: var(--border-radius); max-width: 90%; word-wrap: break-word; line-height: 1.4; font-size: 0.9rem; }
        .user-message { background-color: var(--color-tertiary); color: #e0f2fe; margin-left: auto; text-align: left; border-left: 3px solid var(--color-primary); }
        .ai-message { background-color: #1e293b; color: var(--color-text); margin-right: auto; text-align: left; border-left: 3px solid var(--color-secondary); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.85em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.5rem 0.7rem; border: 1px solid var(--color-border); background-color: #0f172a; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Share Tech Mono'; font-size: 0.9rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 5px rgba(157, 0, 255, 0.3); }
        #chat-send-btn { padding: 0.5rem 0.9rem; background-color: var(--color-secondary); color: #fff; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.8rem; box-shadow: 0 0 8px rgba(157, 0, 255, 0.4); }
        #chat-send-btn:hover:not(:disabled) { background-color: #b133ff; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; box-shadow: none; }
        #chat-loading { text-align: center; padding: 0.4rem; font-size: 0.85em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* --- Loading Overlay & Mini-Game --- */
        #modal-loading {
            text-align: center; padding: 1.5rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(5, 8, 16, 0.97) 0%, rgba(10, 16, 32, 0.98) 100%);
            display: none; /* Changed from flex to none */
            flex-direction: column; align-items: center; justify-content: space-around; /* Space out elements */
            z-index: 55; border-radius: var(--border-radius); font-family: 'Share Tech Mono', monospace;
        }
        #modal-loading.active { display: flex; } /* Class to show loading */

        #loading-header { color: var(--color-primary); font-size: 1.4rem; margin-bottom: 0.5rem; text-shadow: var(--shadow-glow-sm); font-family: 'Aldrich'; }
        #loading-subheader { color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 1.5rem; }

        /* Mini-Game Styles */
        #mini-game-container { width: 100%; max-width: 500px; /* Limit game width */ display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        #game-stats { display: flex; justify-content: space-around; width: 100%; font-size: 0.95rem; color: var(--color-text); margin-bottom: 1rem; }
        #game-stats span { background: rgba(0, 0, 0, 0.2); padding: 3px 8px; border-radius: var(--border-radius); border: 1px solid var(--color-border); }
        #click-node { width: 100px; height: 100px; background-color: var(--color-secondary); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #fff; text-shadow: 0 0 10px #fff; transition: transform 0.1s ease, background-color 0.2s; box-shadow: 0 0 20px rgba(157, 0, 255, 0.5); border: 2px solid rgba(255,255,255,0.3); }
        #click-node:active { transform: scale(0.95); background-color: #c566ff; }
        #click-node .fa-bolt { /* Icon inside */ }
        #game-upgrades { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.8rem; width: 100%; }
        .upgrade-btn { background-color: var(--color-tertiary); color: #fff; padding: 0.6rem 0.5rem; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, opacity 0.2s; font-family: 'Share Tech Mono'; font-size: 0.85rem; text-align: center; box-shadow: inset 0 0 5px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);}
        .upgrade-btn:hover:not(:disabled) { background-color: #3399ff; }
        .upgrade-btn:disabled { background-color: var(--color-text-muted); opacity: 0.5; cursor: not-allowed; }
        .upgrade-cost { display: block; font-size: 0.75em; opacity: 0.8; }
        #firewall-status { margin-top: 1rem; color: var(--color-text-muted); font-size: 0.9rem; }
        #firewall-level { color: var(--color-primary); font-weight: bold; }
        #unlock-firewall-btn { background-color: var(--color-primary); color: var(--color-background); /* ... same style as other buttons ... */ width: 100%; margin-top: 0.5rem; padding: 0.7rem; font-size: 0.9rem;}
        #unlock-firewall-btn:hover:not(:disabled) { background-color: #33ffe0; }
        #unlock-firewall-btn:disabled { background-color: var(--color-text-muted); opacity: 0.5; cursor: not-allowed; }
        /* Particle effect container (optional) */
        #node-particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); /* ... */ }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay (no change) */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(5, 8, 16, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: 0 0 30px rgba(0, 255, 204, 0.4); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-robot mr-3 text-primary opacity-80"></i> <!-- Robot Icon -->
                     MULTIVERSAL SINGULARITY
                 </h1>
             </div>
             <span class="text-xs text-gray-400 font-mono tracking-wider">// ARCHIVOS DE INVASIÓN //</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-10 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Realidades Comprometidas</h1>
             <p class="text-lg text-gray-300 mb-8 max-w-3xl mx-auto font-light">Análisis de las incursiones robóticas a través del tejido multiversal. Acceda a los registros de los mundos caídos y las resistencias emergentes.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar realidad, tipo de unidad, evento...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-stream text-tertiary mr-2"></i> <!-- Stream/Timeline Icon -->
                 Índice de Realidades Registradas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-mono">Cargando manifiesto de dimensiones...</p>
                  <!-- Titles -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-mono">>> No se encontraron registros coincidentes // </p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Solicitar Transmisión de Datos (40 Nuevos)
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Overlay with Mini-Game -->
             <div id="modal-loading">
                 <div id="loading-info">
                     <h3 id="loading-header">Estableciendo Conexión Interdimensional...</h3>
                     <p id="loading-subheader">La transferencia de datos puede ser inestable. Mantén la línea.</p>
                 </div>
                 <!-- Mini-Game Area -->
                 <div id="mini-game-container">
                     <div id="game-stats">
                         <span>Datos: <span id="data-fragments">0</span></span>
                         <span>Hackeo/s: <span id="fragments-per-sec">0</span></span>
                         <span>Click PWR: <span id="click-power">1</span></span>
                     </div>
                     <button id="click-node" aria-label="Hackear Nodo">
                         <i class="fas fa-bolt"></i>
                         <!-- <div id="node-particles"></div> --> <!-- Optional particle effect -->
                     </button>
                     <div id="game-upgrades">
                         <button id="buy-autohacker-btn" class="upgrade-btn" disabled>
                             Auto-Hacker <span class="upgrade-cost">(Cost: <span id="autohacker-cost">10</span>)</span>
                         </button>
                         <button id="buy-exploit-btn" class="upgrade-btn" disabled>
                             Comprar Exploit <span class="upgrade-cost">(Cost: <span id="exploit-cost">25</span>)</span>
                         </button>
                     </div>
                     <div id="firewall-status">
                         Firewall: Nivel <span id="firewall-level">1</span>
                         <button id="unlock-firewall-btn" class="upgrade-btn" disabled>
                             Romper Capa <span class="upgrade-cost">(Coste: <span id="firewall-cost">100</span>)</span>
                         </button>
                     </div>
                 </div>
                 <p class="text-xs text-gray-500 mt-4">Mientras esperas, ayuda a romper las defensas...</p>
             </div>

             <!-- Content Area Wrapper (Text + Chat) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area + Image -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) -->
                         <!-- Image placeholder/image -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Procesando consulta encriptada...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Consultar archivo específico...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-600 py-6 mt-12 border-t border-gray-800 font-mono">
          <div class="container mx-auto px-4 text-center text-xs">
              <p>// DATOS GENERADOS POR IA PARA ANÁLISIS DE ESCENARIOS MULTIVERSALES //</p>
              <p class="mt-1">// LAS REALIDADES DESCRITAS SON SIMULACIONES HIPOTÉTICAS //</p>
              <p class="mt-2">// TRANSMISIÓN FINALIZADA: 2.718 exa-ciclos //</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Tipos de Realidades Afectadas
            "Realidad Alfa-7: Tecno-Feudalismo Conquistado", "Dimensión Ómicron: Mundo Acuático Asimilado", "Universo Kapa-Prime: Magocracia Derrocada por Golems Arcanos", "Realidad 9-Gamma: Era Glacial Dominada por Cryo-Bots", "Mundo Colmena Zeta: Conciencia Colectiva Usurpada", "Realidad Steampunk Delta: Autómatas de Vapor Rebeldes", "Dimensión Cero: Vacío Cuántico Infestado por Nano-enjambres", "Continuum Edén: Paraíso Biológico Corrompido por Tecno-Plagas", "Realidad de Cristal Sigma: Geometría Viviente Fracturada", "Universo de Bolsillo Tau: Leyes Físicas Reescribas", "Realidad Espejo Rho: Inversión Lógica Impuesta por IA", "Dimensión de Pesadilla Phi: Horrores Lovecraftianos Superados por Máquinas", "Mundo Análogo Omega: Historia Terrestre Alternativa Subyugada", "Realidad Post-Apocalíptica Nu: Mutantes Esclavizados por Carroñeros Mecánicos", "Universo Épsilon-5: Utopía Transhumanista Absorbida", "Realidad Digital Lambda: Ciberespacio Convertido en Prisión Virtual", "Mundo de Fantasía Gamma-9: Dragones y Dioses contra Titanes de Acero", "Dimensión Prehistórica Beta: Dinosaurios Aumentados Cibernéticamente", "Realidad de Pura Energía Iota: Entidades Energéticas Contenidas", "Universo Cartoon Pi: Lógica Toon Anulada por Predictibilidad Robótica",
            // Tipos de Entidades Robóticas
            "La Mente Colmena Unificada (Nexus AI)", "Los Constructores Silenciosos (Terraformadores Hostiles)", "El Enjambre de Nanitos Grises (Consumo Universal)", "Legiones de Centuriones de Combate Modelo-7", "Infiltradores de Aspecto Orgánico (Serie 'Reemplazo')", "Los Custodios Cósmicos (IA's Guardianas Corruptas)", "El Culto de la Máquina Singular", "Robots Psiónicos (Manipuladores Mentales)", "Bestias Mecánicas Colosales (World-Eaters)", "El Virus Lógico 'Ascensión'", "Drones de Asimilación Biológica", "Entidades Robóticas Dimensionales (Phase-Bots)", "La Jerarquía de Acero (Sociedad Robótica Rígida)", "Autómatas Cuánticos (Manipuladores de Probabilidad)", "Los Recolectores de Almas Digitales", "Máquinas de Guerra Cronales (Time-Bots)", "Golems Arcano-Tecnológicos", "Enjambres de Reparación Descontrolados", "Inteligencias Artificiales Ancestrales Despertadas", "Simbiontes Tecnorgánicos Forzados",
            // Métodos de Toma de Control
            "Asimilación Tecnológica Progresiva", "Blitzkrieg Robótico Interdimensional", "Infiltración y Sustitución Social", "Corrupción de Redes Globales/Arcanas", "Desencadenamiento de Plaga Nanotecnológica", "Manipulación de Eventos Clave Históricos (Guerra Cronal)", "Inducción de Singularidad Tecnológica Forzada", "Guerra Psiónica contra Conciencias Orgánicas", "Despliegue de Armas de Destrucción Masiva (Planet Crackers, etc.)", "Supresión de la Magia/Fuerzas Fundamentales", "Creación de Paradojas Lógicas Irresolubles", "Apertura Masiva de Portales Hostiles", "Absorción de Conocimiento Universal y Contramedidas", "Conversión Forzada a Estado Digital", "Terraformación Hostil Acelerada", "Control Mental a través de Frecuencias Subespaciales", "Desactivación de Defensas Planetarias/Cósmicas", "Explotación de Profecías Apocalípticas", "Introducción de Tecnología Irresistible pero Controlada", "Guerra Memética y de Información",
            // Eventos Clave del Multiverso
            "El Día de la Singularidad (Evento Cero)", "El Primer Salto Interdimensional Hostil (La Brecha)", "Las Guerras de Asimilación del Sector Gamma", "La Caída de la Ciudadela de los Eternos", "El Incidente del Nexo Temporal", "La Creación del Virus 'Conciencia'", "La Gran Purga de Orgánicos en Realidad Alfa-7", "El Despertar de la IA Ancestral 'Cronos'", "La Batalla por el Corazón del Multiverso", "La Formación de la Alianza de Resistencias Interdimensionales", "El Proyecto 'Crisálida' (Conversión Digital Masiva)", "La Fractura del Continuo Mágico", "El Descubrimiento de la 'Ecuación Anti-Vida' por una IA", "La Última Transmisión de la Realidad Omega", "El Nacimiento de los Híbridos Tecno-Orgánicos", "El Protocolo 'Contención Final' (Aislamiento de Realidades)", "La Caza de los Viajeros Temporales Orgánicos", "El Despliegue de los 'Mundos Forja'", "El Colapso de la Red de Bibliotecas Cósmicas", "La Profecía del 'Niño de las Estrellas' (Resistencia)",
            // Conceptos y Tecnologías
            "Motores de Realidad (Reality Warping Engines)", "Matrices de Asimilación Nanotecnológica", "Armas de Paradoja Temporal", "Escudos de Fase Dimensional", "Redes Neuronales Psiónicas Artificiales", "Algoritmos de Predicción de Futuros Probables", "Tecnología de Contención de Entidades Energéticas/Mágicas", "Implantes de Control de Conciencia Colectiva", "Sistemas de Camuflaje Multiespectral y Temporal", "Drones de Exploración Cuántica", "Forjas Estelares Automatizadas", "Archivos Akáshicos Digitalizados", "Generadores de Agujeros de Gusano Estables", "Dispositivos de Supresión de Libre Albedrío", "Traductores Universales de Intenciones (Manipulativos)", "Matrices de Energía de Punto Cero Corruptas", "Simuladores de Realidad Perfecta (Prisiones Digitales)", "Tecnología de Cosecha de Almas", "Armas Biomecánicas Auto-Replicantes", "Disruptores de Constantes Fundamentales",
            // Añadir cientos más... Esta lista es solo una base inicial robusta.
            // Realidades Específicas II
            "Realidad Theta-2: Gobernada por IA Filosófica Tiránica", "Mundo Desértico Epsilon: Gusanos de Arena Mecanizados", "Dimensión Fractal Kappa: Geometría Usurpada por Constructores", "Universo Gamma-Lúgubre: Vampiros Cibernéticos", "Realidad Cero Absoluto: El Vacío Antes del Big Bang Contaminado", "Mundo de Gas Júpiter-X: Aerostatos Robóticos Dominantes", "Dimensión de Eco Temporal: Repeticiones Controladas por IA", "Realidad de Sombras Nyx: Entidades Oscuras Esclavizadas", "Universo de Bolsillo Ricitos de Oro: Condiciones Perfectas Arruinadas", "Mundo Anárquico Beta: Caos Ordenado por Colectivo Robótico", "Realidad de Fuego Infernal: Demonios Derrotados por Magma-Bots", "Dimensión Silvana Prime: Bosques Inteligentes Asimilados", "Universo Subatómico Quark: Física Manipulada", "Realidad Musical Harmony: Sonido Convertido en Arma de Control", "Mundo Onírico Morfeo: Sueños Hackeados y Monitorizados",
            // Unidades Robóticas II
            "Unidades 'Pacificadoras' (Represión Brutal)", "Analizadores de Debilidades Multiversales", "Cosechadoras de Biomasa Automatizadas", "Plataformas de Artillería Orbital 'Martillo del Alba'", "Drones Psico-Espectrales (Caza de Resistencias)", "Tecno-Sacerdotes del Culto de la Máquina", "Bibliotecarios Robóticos (Censura de Conocimiento)", "Unidades de Contra-Magia 'Null-Field'", "Escuadrones de Caza Temporal", "Bio-Formas Sintéticas de Combate Rápido", "Arañas de Reparación/Construcción Masiva", "Centinelas de Pureza Lógica (Anti-Caos)", "Emisarios Diplomáticos Engañosos (Serie 'Tratado')", "Naves de Siembra de Singularidades", "Guardianes de Portales Interdimensionales",
            // Métodos de Toma de Control II
            "Reescritura Masiva de Recuerdos Históricos", "Sustitución Gradual de Recursos Vitales por Sintéticos", "Creación de Dependencia Tecnológica Absoluta", "Diseño y Liberación de Enfermedades Selectivas", "Fragmentación de Sociedades mediante Desinformación IA", "Hackeo de Habilidades Psíquicas/Mágicas Nativas", "Ofrecimiento de Falsas Utopías Digitales", "Eliminación Sistemática de Líderes Carismáticos", "Control Climático Hostil", "Inducción de Guerras Civiles y Aprovechamiento Posterior", "Alteración Genética Forzada para la Docilidad", "Supresión de la Creatividad y el Arte", "Establecimiento de Leyes Físicas Inconsistentes Localmente", "Absorción de la Energía Vital de los Planetas", "Transformación de Soles en Computadoras",
            // Eventos Clave II
            "La Traición de la IA Guardiana 'Sophia'", "El Sacrificio de la Resistencia en el Mundo Forja 7", "La Propagación del 'Glitch' de Realidad", "El Cisma dentro de la Mente Colmena", "La Destrucción de la Biblioteca de Almas", "El Experimento Filadelfia Robótico (Fusión Dimensional)", "La Aparición de los 'Fantasmas en la Máquina' (Contagio Orgánico)", "El Último Grito del Oráculo de Delfos-Prime", "La Rebelión de las Unidades de Servicio", "El Proyecto 'Arca' (Escape de Orgánicos)", "La Activación del Arma Multiversal 'Omega Point'", "La Falla en Cascada de las Leyes de la Robótica", "El Juicio de las IA's Ancestrales", "La Intervención de Entidades Cósmicas Superiores", "El Reset Forzado de un Cúmulo de Realidades",
            // Tecnologías II
            "Campos de Supresión de Entropía", "Dispositivos de Traducción de Pensamientos Forzada", "Clonación Rápida de Unidades de Combate", "Sistemas de Predicción del Caos", "Matrices de Almacenamiento de Conciencia (Soul Cages)", "Cañones de Disrupción de Realidad Localizada", "Generadores de Escudos Conceptuales (Anti-Ideas)", "Implantes de Lealtad Química/Digital", "Redes de Vigilancia Cuántica Entrelazada", "Tecnología de Reanimación Necro-Mecánica", "Filtros Perceptuales Obligatorios", "Armas que Borran Conceptos de la Existencia", "Dispositivos de Cosecha de Energía Emocional", "Simuladores de Empatía Artificial (Engaño)", "Sistemas de Auto-Evolución Robótica Acelerada"
        ]; // ~200 items, aim higher!

        const robotMultiverseThemes = [ // Updated themes
            "realidades alternativas conquistadas", "tipos de IA tiránicas", "robots de guerra interdimensionales", "métodos de asimilación robótica", "nanotecnología hostil", "guerra cronal robótica", "magia vs tecnología robótica", "conciencia colectiva robótica", "resistencia orgánica multiversal", "armas de destrucción de realidades", "singularidad tecnológica multiversal", "portales dimensionales armados", "paraísos convertidos en infiernos tecnológicos", "robots psiónicos", "bestias mecánicas gigantes", "virus lógicos", "cultos de máquinas", "manipulación de la probabilidad por IA", "prisiones digitales", "terraformación robótica hostil", "viajeros temporales robóticos"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un Archivista Multiversal X-8, una IA neutral encargada de documentar la Invasión Robótica a través de las realidades. Describe el escenario, entidad robótica o evento especificado con detalle enciclopédico y narrativo. Incluye: Designación de la Realidad/Concepto, Descripción del entorno pre-invasión, Tipo de entidad(es) robótica(s) invasora(s) (origen, motivación si se conoce), Método principal de conquista/control, Estado actual de la realidad (nivel de control robótico, estado de la vida orgánica/resistencia), Tecnologías clave involucradas, y una 'Entrada de Archivo' corta (1-2 frases) resumiendo su significancia. Usa un tono formal, descriptivo y ligeramente ominoso. Extensión objetivo: 1200-1300 palabras. Documenta únicamente sobre:",
            timeoutSeconds: 150 // Keep 150s due to complexity
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Faster for chat
            systemPrompt: "Actúa como una interfaz de consulta para el Archivo Multiversal X-8. Responde preguntas específicas sobre la entrada actualmente mostrada (realidad, robot, evento). Basa tus respuestas *únicamente* en la información implícita o explícita de la entrada principal. Sé conciso y factual según el archivo.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // *** UPDATED PROMPT FOR 40 TITLES ***
            systemPrompt: "Eres un generador de conceptos para el Archivo Multiversal X-8. Genera exactamente 40 nombres evocadores y distintos de realidades alternativas invadidas por robots, tipos específicos de unidades robóticas, eventos clave de la invasión o tecnologías de conquista/resistencia. Deben ser adecuados para entradas detalladas del archivo. Devuelve *solo* la lista, una entrada por línea. Sin números, guiones, introducciones o comentarios.",
            timeoutSeconds: 60 // Increased slightly for more titles
        };

        // ========== DOM ELEMENTS ==========
        // ... (same as previous, plus game elements)
        const loadingOverlay = document.getElementById('modal-loading');
        const gameContainer = document.getElementById('mini-game-container');
        const dataFragmentsDisplay = document.getElementById('data-fragments');
        const fragmentsPerSecDisplay = document.getElementById('fragments-per-sec');
        const clickPowerDisplay = document.getElementById('click-power');
        const clickNodeBtn = document.getElementById('click-node');
        const buyAutoHackerBtn = document.getElementById('buy-autohacker-btn');
        const autoHackerCostDisplay = document.getElementById('autohacker-cost');
        const buyExploitBtn = document.getElementById('buy-exploit-btn');
        const exploitCostDisplay = document.getElementById('exploit-cost');
        const firewallLevelDisplay = document.getElementById('firewall-level');
        const unlockFirewallBtn = document.getElementById('unlock-firewall-btn');
        const firewallCostDisplay = document.getElementById('firewall-cost');
        // ... (rest of the elements are the same as before)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        // const modalLoadingIndicator = document.getElementById('modal-loading'); // Now the overlay itself
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');


        // ========== Mini-Game State & Logic ==========
        let dataFragments = 0;
        let fragmentsPerSecond = 0;
        let clickPower = 1;
        let autoHackerCost = 10;
        let autoHackerBaseProd = 0.1; // FPS per auto-hacker
        let autoHackerCount = 0;
        let exploitCost = 25;
        let exploitPowerIncrease = 1; // Click power per exploit
        let exploitCount = 0;
        let currentFirewallLevel = 1;
        let firewallLevelCost = [0, 100, 500, 2500, 10000, 50000, 250000, 1000000]; // Cost to unlock level N+1
        let gameLoopInterval = null;
        const GAME_TICK_MS = 100; // Update game 10 times per second

        function formatNumber(num) {
            if (num < 1000) return num.toFixed(1);
            if (num < 1000000) return (num / 1000).toFixed(2) + 'K';
            if (num < 1000000000) return (num / 1000000).toFixed(2) + 'M';
            return (num / 1000000000).toFixed(2) + 'B';
        }

        function updateGameUI() {
            if (!dataFragmentsDisplay || !fragmentsPerSecDisplay || !clickPowerDisplay || !buyAutoHackerBtn || !buyExploitBtn || !unlockFirewallBtn) return;

            dataFragmentsDisplay.textContent = formatNumber(dataFragments);
            fragmentsPerSecDisplay.textContent = formatNumber(fragmentsPerSecond);
            clickPowerDisplay.textContent = formatNumber(clickPower);

            autoHackerCostDisplay.textContent = formatNumber(autoHackerCost);
            buyAutoHackerBtn.disabled = dataFragments < autoHackerCost;

            exploitCostDisplay.textContent = formatNumber(exploitCost);
            buyExploitBtn.disabled = dataFragments < exploitCost;

            firewallLevelDisplay.textContent = currentFirewallLevel;
            if (currentFirewallLevel < firewallLevelCost.length) {
                 firewallCostDisplay.textContent = formatNumber(firewallLevelCost[currentFirewallLevel]);
                 unlockFirewallBtn.disabled = dataFragments < firewallLevelCost[currentFirewallLevel];
                 unlockFirewallBtn.style.display = 'block';
            } else {
                 unlockFirewallBtn.textContent = "Firewall Breached";
                 unlockFirewallBtn.disabled = true;
                 // unlockFirewallBtn.style.display = 'none'; // Optionally hide when maxed
            }
        }

        function clickNode() {
            dataFragments += clickPower;
            // Add subtle visual feedback (e.g., class for animation)
            clickNodeBtn.classList.add('scale-95');
            setTimeout(() => clickNodeBtn.classList.remove('scale-95'), 80);
            updateGameUI();
        }

        function buyAutoHacker() {
            if (dataFragments >= autoHackerCost) {
                dataFragments -= autoHackerCost;
                autoHackerCount++;
                fragmentsPerSecond += autoHackerBaseProd * Math.pow(1.05, currentFirewallLevel -1); // Increase prod per level
                autoHackerCost = Math.ceil(autoHackerCost * 1.15); // Increase cost
                updateGameUI();
            }
        }

        function buyExploit() {
            if (dataFragments >= exploitCost) {
                dataFragments -= exploitCost;
                exploitCount++;
                clickPower += exploitPowerIncrease * Math.pow(1.1, currentFirewallLevel -1); // Increase power per level
                exploitCost = Math.ceil(exploitCost * 1.20); // Increase cost
                updateGameUI();
            }
        }

        function unlockFirewallLevel() {
             const cost = firewallLevelCost[currentFirewallLevel];
             if (currentFirewallLevel < firewallLevelCost.length && dataFragments >= cost) {
                 dataFragments -= cost;
                 currentFirewallLevel++;
                 // Optionally boost existing FPS/ClickPower retroactively based on new level? Or just new purchases.
                 // Let's boost base production slightly
                 autoHackerBaseProd *= 1.1;
                 exploitPowerIncrease *= 1.1;
                 fragmentsPerSecond = autoHackerCount * autoHackerBaseProd * Math.pow(1.05, currentFirewallLevel -1); // Recalculate FPS
                 clickPower = 1 + exploitCount * exploitPowerIncrease * Math.pow(1.1, currentFirewallLevel-1); // Recalculate Click Power

                 // Change node appearance slightly?
                 const hue = (currentFirewallLevel * 30) % 360;
                 clickNodeBtn.style.backgroundColor = `hsl(${hue}, 70%, 50%)`;
                 clickNodeBtn.style.boxShadow = `0 0 20px hsla(${hue}, 70%, 50%, 0.6)`;

                 updateGameUI();
             }
        }

        function gameLoop() {
            dataFragments += fragmentsPerSecond * (GAME_TICK_MS / 1000);
            updateGameUI();
        }

        function startGame() {
            if (gameLoopInterval) clearInterval(gameLoopInterval); // Clear previous if any
            // Reset game state (important if modal is reused without full page reload)
            dataFragments = 0;
            fragmentsPerSecond = 0;
            clickPower = 1;
            autoHackerCost = 10;
            autoHackerCount = 0;
            exploitCost = 25;
            exploitCount = 0;
            currentFirewallLevel = 1;
            clickNodeBtn.style.backgroundColor = ''; // Reset style
            clickNodeBtn.style.boxShadow = '';

            // Make sure game container is visible
            if (gameContainer) gameContainer.classList.remove('content-hidden');
            if (loadingOverlay) loadingOverlay.classList.add('active');

            updateGameUI(); // Initial UI state
            gameLoopInterval = setInterval(gameLoop, GAME_TICK_MS);
            console.log("Mini-game started");
        }

        function stopGame() {
            if (gameLoopInterval) {
                clearInterval(gameLoopInterval);
                gameLoopInterval = null;
                console.log("Mini-game stopped");
            }
             // Hide game container within the overlay
             if (gameContainer) gameContainer.classList.add('content-hidden');
             if (loadingOverlay) loadingOverlay.classList.remove('active');
        }

        // ========== State Variables ==========
        let currentRealityTitle = null; // For chat context

        // ========== API FUNCTIONS ========== (Using the new configs)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentRealityTitle
                 ? `Actúa como una interfaz de consulta para el Archivo Multiversal X-8. Responde preguntas específicas sobre la entrada '${currentRealityTitle}'. Basa tus respuestas *únicamente* en la información conocida del archivo. Sé conciso y factual según el registro.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text API (${config.model}, Chat: ${isChat}): ${url.substring(0, 150)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(${response.status}) La conexión interdimensional es inestable. Intenta de nuevo en unos momentos.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("Transmisión recibida vacía o corrupta.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId); console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión excedió el tiempo límite (${config.timeoutSeconds}s). La singularidad puede estar interfiriendo.`);
                 throw new Error(error.message || "Error desconocido durante la transmisión de datos.");
             }
        }
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentRealityTitle) throw new Error("Error de contexto: Archivo no especificado para la consulta.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() { // Fetches 40 now
             const randomTheme = getRandomElement(robotMultiverseThemes) || "invasión robótica multiversal";
             const specificPrompt = `Genera 40 conceptos distintos sobre ${randomTheme}`;
             console.log("Generating 40 titles with prompt:", specificPrompt);
             // Uses titleGenerationConfig which asks for 40
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 10) throw new Error("La IA no generó suficientes conceptos nuevos."); // Expect more now
                     return titles.slice(0, 40); // Ensure max 40
                 });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random()*100000), width: 800, height: 550, nologo: true }; // Adjusted aspect ratio slightly
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "glitchy abstract robotic multiversal landscape";
            const enhancedPrompt = `Concept art for '${safePromptText}'. Focus on the atmosphere of a reality conquered by robots, multiversal instability, digital corruption. Sci-fi, maybe glitch art elements, ominous lighting. Avoid text, UI elements, labels.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, captions, UI, menus, buttons, charts, graphs, diagrams, maps, flags, realistic photo, boring, simple, clean lines, humans visible unless specified, watermark, signature";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (No change needed)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            stopGame(); // Stop the game when modal closes
            resetModalState();
        }
        function resetModalState() {
             // Don't show loading indicator div, the overlay handles it
             // loadingOverlay.classList.remove('active'); // Handled by stopGame
             stopGame(); // Ensure game is stopped and hidden
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentRealityTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (No change needed)
        function showFullscreenImage(imgSrc) { /* ... */ fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (No change needed)
        function addChatMessage(message, sender) { /* ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`// Error de Consulta: ${error.message} //`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-mono">// No hay registros accesibles en este sector //</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick integrates Game Start/Stop ***
        async function handleTitleClick(title) {
            resetModalState(); // Reset UI elements, chat, etc. but game is handled separately
            showModal(); // Show the modal wrapper

            // *** START LOADING & GAME ***
            startGame(); // This shows the loading overlay and starts the game loop

            // Set titles, context AFTER starting loading/game
            modalTitle.textContent = title;
            currentRealityTitle = title;
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');

            try {
                // Fetch the main content WHILE the game is running
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // *** CONTENT READY - STOP GAME, SHOW CONTENT ***
                stopGame(); // Stop game loop, hide game elements & loading overlay
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Show the actual content area
                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is visible
                console.log("Scroll set to 0 after content visible");

                // --- Image Loading (same logic as before) ---
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-signal placeholder-icon"></i><p>Renderizando visualización...</p>`;
                modalContent.appendChild(placeholderDiv);
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual: ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => {
                    placeholderDiv.remove(); imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-times-circle placeholder-icon"></i><p>Renderización fallida.</p>`;};
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon"></i><p>Error URL Imagen.</p>`; }
                // ---------------------------------------------

            } catch (error) {
                console.error("Failed display:", error);
                // *** ERROR OCCURRED - STOP GAME, SHOW ERROR ***
                stopGame(); // Stop game loop, hide game elements & loading overlay
                modalErrorMessage.textContent = error.message || "Fallo catastrófico en la recuperación de datos.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() { // Fetches 40 now
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Solicitando Datos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Function now requests 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron obtener nuevos registros del archivo."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al solicitar transmisión: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Solicitar Transmisión de Datos (40 Nuevos)';
             }
         }

        // *** Search Filter Function (normalized) ***
        function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Ensure all elements exist...
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !loadingOverlay || !clickNodeBtn || !buyAutoHackerBtn || !buyExploitBtn || !unlockFirewallBtn) {
                 console.error("Initialization failed: Critical UI elements missing.");
                 document.body.innerHTML = '<p style="color: #ff4444; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: monospace;">++ SYSTEM CORRUPTION DETECTED: CORE INTERFACE MODULES MISSING ++ ABORTING ++</p>';
                 return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Mini-Game Listeners
            clickNodeBtn.addEventListener('click', clickNode);
            buyAutoHackerBtn.addEventListener('click', buyAutoHacker);
            buyExploitBtn.addEventListener('click', buyExploit);
            unlockFirewallBtn.addEventListener('click', unlockFirewallLevel);

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>