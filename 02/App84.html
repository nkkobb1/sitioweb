<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enciclopedia Digimon - Digidex</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes: Orbitron para títulos, Lato para cuerpo -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Digimon --- */
        :root {
            --color-primary: #0d6efd; /* Azul Digivice/Cielo Digital */
            --color-secondary: #ffc107; /* Amarillo/Dorado Energía/Datos */
            --color-accent: #fd7e14; /* Naranja Fuego/Agumon */
            --color-background: #f8f9fa; /* Blanco Hueso/Gris Muy Claro */
            --color-text: #212529; /* Negro/Gris Oscuro */
            --color-text-muted: #6c757d; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro para Modal */
            --color-border: #dee2e6; /* Borde Gris Claro */
            --shadow-sm: 0 .125rem .25rem rgba(0, 0, 0, .075);
            --shadow-md: 0 .5rem 1rem rgba(0, 0, 0, .15);
            --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, .175);
            --border-radius: 6px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.6; }
        /* Fuente temática para logo/título */
        h1.logo, h1.page-title { font-family: 'Orbitron', sans-serif; font-weight: 700; color: var(--color-primary); }
        h2.section-title, #modal-title { font-family: 'Orbitron', sans-serif; font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-secondary); padding-bottom: 0.6rem; display: inline-block; }
        #modal-title { color: var(--color-primary); }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.25rem; }
        .title-item {
            background-color: var(--color-modal-bg);
            padding: 1rem 0.8rem; /* Ajuste padding */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: var(--transition-normal);
            text-align: center;
            font-weight: 700; /* Más bold */
            color: var(--color-text);
            border: 1px solid var(--color-border);
            display: flex;
            flex-direction: column; /* Para icono arriba */
            align-items: center;
            justify-content: center;
            min-height: 80px;
            font-family: 'Lato', sans-serif;
            position: relative;
            overflow: hidden;
        }
        .title-item::before { /* Efecto hover sutil */
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background-color: var(--color-primary);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }
        .title-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-secondary);
            color: var(--color-primary);
        }
        .title-item:hover::before { width: 80%; }
        .title-item i { /* Icono pequeño */
           font-size: 1.5rem;
           margin-bottom: 0.5rem;
           color: var(--color-text-muted);
           transition: var(--transition-normal);
        }
         .title-item:hover i { color: var(--color-accent); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-accent)); color: white; padding: 0.8rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Orbitron', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { box-shadow: var(--shadow-md); transform: scale(1.03); background: linear-gradient(45deg, var(--color-accent), var(--color-primary)); }
        #generate-more-btn:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; box-shadow: none; transform: none; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.75); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 2rem 2.5rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 350px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: var(--color-text-muted); border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.6rem; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: var(--color-primary); transform: rotate(90deg); }
        #modal-title { font-size: 2.2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }
        #modal-content {
            line-height: 1.7;
            color: var(--color-text);
            white-space: normal;
            overflow-y: auto;
            padding: 0 10px 1.5rem 10px;
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content::-webkit-scrollbar { width: 10px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-accent); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Orbitron', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: bold; letter-spacing: 0.5px; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-accent); border-color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        /* Estilo para imagen y placeholder */
        #modal-content .final-image { display: block; max-width: 70%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: var(--color-background); padding: 5px; box-shadow: var(--shadow-sm); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); border: 2px dashed var(--color-border); border-radius: var(--border-radius); padding: 1rem; width: 70%; background-color: var(--color-background); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3.5rem; color: var(--color-secondary); }
        #modal-content .image-placeholder p { font-size: 0.9em; margin-top: 0.5rem; font-weight: bold; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 7px solid var(--color-border); border-top-color: var(--color-primary); border-right-color: var(--color-secondary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.4rem; font-family: 'Orbitron'; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #f8d7da; color: #721c24; padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #f5c6cb; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex justify-center items-center">
             <div class="flex items-center text-center">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-paw mr-3 text-orange-500"></i> <!-- Icono huella -->
                     Enciclopedia Digimon
                     <i class="fas fa-database ml-3 text-yellow-500"></i> <!-- Icono base de datos -->
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">¡Explora el Mundo Digital!</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto">Descubre información detallada sobre cientos de Digimon. ¡Selecciona un nombre para cargar sus datos!</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-search text-blue-600 mr-2"></i> <!-- Icono búsqueda -->
                 Selecciona un Digimon
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Escaneando la Red...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     ¡Descubrir Más Digimon!
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Cargando datos Digimon...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - La imagen se añadirá aquí al final -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Digimon description (HTML) goes here -->
                     <!-- Image placeholder/spinner and final image will be appended here via JS -->
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-600 py-6 mt-12 border-t border-gray-300">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Datos generados por IA con fines informativos y de entretenimiento sobre el universo Digimon.</p>
              <p class="mt-1">Los detalles pueden variar según la fuente (anime, manga, juegos). Consulta fuentes oficiales para datos canónicos.</p>
              <p class="mt-2">© 2025 Enciclopedia Digimon</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Fresh / In-Training I
            "Botamon", "Poyomon", "Punimon", "Leafmon", "Jyarimon", "Zerimon", "Conomon", "Cocomon", "Chibomon", "Kuramon", "Datirimon", "Pitchmon", "YukimiBotamon", "Pupumon", "Paomon", "Fufumon", "Pipimon", "Puttimon", "Puyomon", "Tsubumon", "Dodomon", "Puwamon", "Chibickmon", "Bommon", "Curimon", "Sakumon", "Babydmon", "Popomon", "Cotsucomon",
            // In-Training / In-Training II
            "Koromon", "Tokomon", "Tsunomon", "Motimon", "Tanemon", "Bukamon", "Yokomon", "Nyaromon", "Pagumon", "Gummymon", "Kokomon", "DemiVeemon", "Upamon", "Poromon", "Minomon", "Xiaomon", "Gigimon", "Viximon", "Hopmon", "Wanyamon", "Budmon", "Kyaromon", "Yaamon", "Dorimon", "Frimon", "Kapurimon", "Chocomon", "Sunmon", "Moonmon", "Missimon", "Monodramon", "Ketomon", "Puroromon", "Kakkinmon", "Bebydomon", "Puyoyomon", "Pinamon", "Pokomon", "Chapmon", "Pusumon", "Pukamon", "Bosamon", "Sakuttomon",
            // Rookie / Child
            "Agumon", "Gabumon", "Piyomon", "Tentomon", "Palmon", "Gomamon", "Patamon", "Gatomon (Tailmon)", "Veemon", "Hawkmon", "Armadillomon (Armadimon)", "Wormmon", "Guilmon", "Terriermon", "Renamon", "Impmon", "Lopmon", "Flamemon (Agnimon's human form)", "Strabimon (Lobomon's human form)", "Dorumon", "Ryudamon", "Lalamon", "Gaomon", "Falcomon (2006)", "Kudamon (2006)", "Kamemon", "Shoutmon", "Gummdramon", "Hackmon", "Zubamon", "Agumon (2006)", "Gabumon (2006)", "Piyomon (2006)", "Tentomon (2006)", "Palmon (2006)", "Gomamon (2006)", "Patamon (2006)", "Plotmon (Salamon)", "Elecmon", "Kunemon", "Betamon", "Penguinmon", "Otamamon", "Gazimon", "Gizamon", "Syakomon", "Muchomon", "Floramon", "Mushroomon", "DemiDevimon (PicoDevimon)", "Candlemon (Candmon)", "Psychemon", "Tsukaimon", "ModokiBetamon", "Crabmon (Ganimon)", "Gotsumon", "Tapirmon (Bakumon)", "SnowAgumon", "ToyAgumon", "ClearAgumon", "BlackAgumon", "BlackGabumon", "SnowGoblimon", "Goblimon", "Shamanmon", "Bearmon", "Kotemon", "Koemon (Monmon)", "Bokomon", "Neemon", "Coronamon", "Lunamon", "Dracomon (Blue/Green)", "Monitamon", "Cutemon", "Chikurimon", "Ghostmon", "Pulsemon", "Espimon", "Jazamon", "Pomumon", "Herissmon", "Agumon (Black)", "Veemon (Black)", "Guilmon (Black)", "Lucemon", "Morphomon", "Salomon (Plotmon)", "Solarmon", "Hagurumon", "Kokuwamon", "Shamamon", "Muchomon", "Dokunemon", "Liollmon", "Phascomon", "Commandramon", "Keramon", "Arkadimon (Rookie)", "FanBeemon", "PawnChessmon (White/Black)", "Alraumon", "Chuumon", "Labramon", "Terriermon Assistant", "Junkmon", "Vorvomon", "Blucomon", "Gammamon", "Angoramon", "Jellymon", "Loogamon", "Bulucomon", "Paledramon (Child)", // Assuming some context might list its pre-evo this way
            // Champion / Adult
            "Greymon", "Garurumon", "Birdramon", "Kabuterimon", "Togemon", "Ikkakumon", "Angemon", "Devimon", "ExVeemon", "Aquilamon", "Ankylomon", "Stingmon", "Growlmon (Growmon)", "Gargomon", "Kyubimon", "IceDevimon", "Turuiemon", "Wizardmon (Wizarmon)", "Leomon", "Ogremon", "Meramon", "Centarumon (Kentaurosmon)", "Unimon", "Bakemon", "Shellmon", "Seadramon", "Coelamon", "Monochromon", "Tyranomon (Tyrannomon)", "Drimogemon", "Numemon", "Sukamon", "Vegiemon", "Kuwagamon", "Kokatorimon", "Mojyamon", "Nanimon", "Gesomon", "Octomon", "Flymon", "DarkTyrannomon", "Cyclonemon", "Deltamon", "Raremon", "Tuskmon", "Snimon", "Yanmamon", "SandYanmamon", "Soulmon", "Saberdramon", "RedVegiemon", "Woodmon", "Starmon", "Reppamon", "Kyukimon", "Youkomon", "Grizzlymon", "Hanumon", "Gorillamon", "Apemon", "Musyamon", "Hookmon", "Armormon", "Nohemon", "Moosemon", "Togemogumon", "ShellNumemon", "GoldNumemon", "Geremon", "PlatinumSukamon", "Etemonkey", "Chamelemon", "Tortomon (Tortamon)", "MoriShellmon", "Icemon", "Thunderballmon (Mamemon type)", "Tankmon", "Clockmon", "Guardromon", "Mekanorimon", "Piddomon", "Thunderbirmon", "Halsemon", "Shurimon", "Digmon", "Submarimon", "Pegasusmon", "Nefertimon", "Greymon (Blue)", "Garurumon (Black)", "Airdramon", "Veedramon", "Coredramon (Blue/Green)", "GeoGreymon", "Gaogamon", "Sunflowmon", "Peckmon", "Gwappamon", "Sangloupmon", "Dracmon", "Strikedramon", "Ginryumon", "Sealsdramon", "Tobucatmon", "Firamon", "Lekismon", "Revolmon", "KaratsukiNumemon", "Deputymon", "Agunimon", "Lobomon (Wolfmon)", "Kumamon (Chackmon)", "Kazemon (Fairymon)", "Beetlemon (Blitzmon)", "Loewemon (Löwemon)", "JagerLoewemon", "ExTyrannomon", "Vilemon", "Devidramon", "Dokugumon", "Fugamon", "Hyougamon", "Wendigomon", "Allomon", "Lynxmon", "Sethmon", "Yaksamon", "Mantaraymon", "Tylomon", "Archelomon", "Frogmon", "Quetzalmon", "Pipismon", "Pteramon", "Searchmon", "FlaWizardmon", "Kenkimon", "Bitmon", "Boarmon", "Bullmon", "Butterflymon", "Chameleomon", "Elephanmon", "Fladramon", "Gargoylemon", "Goatmon", "GoldVeedramon", "Harpymon", "Honeybeemon", "Kangarumon", "Lighdramon", "Magnamon (sometimes considered Champ)", "Maildramon", "Manbomon", "Mothmon", "Opossummon", "Orcamon", "Peacockmon", "Ponchomon", "Praidmon", "Pucchiemon (Green/Pink)", "Raidramon", "Rinkmon", "Sagittarimon", "Seahomon", "Sheepmon", "Stegomon", "Swanmon", "Toucanmon", "Kongoumon", "Monmon (Targetmon)", "Gekomon", "Otamamon (Red)", "Kiwimon", " Blossomon", "Kabukimon", "Buraimon", "Shadramon", "Togemon X", "Greymon X", "Garurumon X", "Kabuterimon X", "Growlmon X", "Kyubimon X", "Omekamon", "Hudiemon", "Filmon", "Stefilmon", "Machmon", "Shootmon", "Racemon", "Weddinmon", "Ajatarmon", "Mimicmon", "Runnermon", "Namakemon", "Mitamamon (Champion)", "Betsumon", "Damemon", "Tuwarmon (Champion)", "Arkadimon (Champion)", "Dorugamon", "LoaderLiomon", "KnightChessmon (White/Black)", "Waspmon", "CannonBeemon (Champion)", "Volcamon", "Growlmon (Orange)", "Growlmon (Yellow)", "IceLeomon", "BaoHuckmon", "Zubaeagermon", "Bulkmon", "Exermon", "Runnermon", "Namakemon", "BetelGammamon", "KausGammamon", "WezenGammamon", "GulusGammamon", "SymbareAngoramon", "Thetismon", "Lamortmon", "Examon (Child)", // Context specific
            // Ultimate / Perfect
            "MetalGreymon (Vaccine/Virus)", "WereGarurumon", "Garudamon", "MegaKabuterimon (AtlurKabuterimon Red/Blue)", "Lillymon (Lilimon)", "Zudomon", "MagnaAngemon (HolyAngemon)", "Angewomon", "Myotismon (Vamdemon)", "Paildramon", "Silphymon", "Shakkoumon", "WarGrowlmon (MegaloGrowmon)", "Rapidmon (Armor/Perfect)", "Taomon", "Antylamon (Deva/Data/Virus)", "Beelzemon (Impmon's Matrix Evo)", "Cyberdramon (2010)", "BurningGreymon (Vritramon)", "KendoGarurumon (Garmmon)", "Korikakumon (Blizzarmon)", "Zephyrmon (Shutumon)", "MetalKabuterimon (Bolgmon)", "Duskmon", "Velgemon (Velgrmon)", "RizeGreymon", "MachGaogamon", "Lilamon", "Yatagaramon (2006)", "Shawujinmon", "Chirinmon", "Hisyaryumon", "DORUguremon", "Grademon", "SkullGreymon", "MegaSeadramon", "MetalTyrannomon", "MetalMamemon", "Mamemon", "Monzaemon", "Etemon", "Andromon", "Giromon", "Datamon (Nanomon)", "Vademon", "Piximon (Piccolomon)", "Digitamamon", "Megadramon", "SkullSatamon", "LadyDevimon", "Infermon", "Okuwamon", "MarineDevimon", "Scorpiomon (Anomalocarimon)", "Dragomon (Dagomon)", "BlueMeramon", "WaruSeadramon", "ShogunGekomon", "TonosamaGekomon", "Garbagemon (Gerbemon)", "Triceramon", "Cherrymon (Jyureimon)", "Pumpkinmon", "Deramon", "Asuramon", "Phantomon", "Boltmon (Considered Mega by some)", "ExTyrannomon", "Jagamon", "MameTyramon", "MarineAngemon (Considered Mega by some)", "Mermaimon", "Panjyamon", "Parrotmon", "SkullMeramon", "Volcanomon", "WaruMonzaemon", "Gigadramon", "Kimeramon (Chimairamon)", "Machinedramon (MugenDramon - as component)", "MetalEtemon", "AeroVeedramon", "Volcanicdramon", "Wingdramon", "Groundramon", "CatchMamemon", "Mitamamon", "Tempomon", "Entmon", "Cerberumon", "Mephistomon", "Mihiramon (Deva)", "Sandiramon (Deva)", "Sinduramon (Deva)", "Pajiramon (Deva)", "Vajiramon (Deva)", "Indaramon (Deva)", "Kumbhiramon (Deva)", "Vikaralamon (Deva)", "Makuramon (Deva)", "Majiramon (Deva)", "Caturamon (Deva)", "Lucemon Falldown Mode", "Arkadimon (Ultimate)", "Dinobeemon", "Knightmon", "MagnaKidmon", "BigMamemon", "BishopChessmon (W/B)", "RookChessmon (W/B)", "CannonBeemon", "Calamaramon", "Ranamon", "Arbormon", "Petaldramon", "Gigasmon", "Grottomon", "Sephirothmon", "Mercuremon", "Reichmon", "Aldamon", "BeoWolfmon", "Rapidmon (Gold)", "Pajramon", "Indramon", "Orochimon", "Whamon Perfect", "Divermon (Hangyomon)", "Arukenimon", "Mummymon", "BlackWarGrowlmon", "BlackRapidmon", "BlackMegaGargomon (Matrix Evo context)", "SaviorHuckmon", "Duramon", "Astamon", "Tsuwarmon", "MetallifeKuwagamon", "MegaloGrowmon X", "WereGarurumon X", "Taomon (Silver)", "NeoDevimon", "SkullBaluchimon", "CaptainHookmon", "Splashmon", "Olegmon (Ultimate component)", "Zamielmon (Ultimate component)", "Gravimon (Ultimate component)", "Apollomon Whispered", "Doumon", "Jyagamon", "Manticoremon", "Matadormon", "Meicrackmon (VM)", "Pistmon", "Rafflesimon (Component)", "Regulumon", "Rebellimon", "Technodramon", "BloomLordmon (Component)", "Canoweissmon", "Fumamon", "Vamdemon (Myotismon)", "Zanmetsumon", "Achillesmon", // Sometimes debated
            // Mega / Ultimate (JP)
            "WarGreymon", "MetalGarurumon", "Phoenixmon (Hououmon)", "HerculesKabuterimon", "Rosemon", "Vikemon", "Seraphimon", "Ophanimon", "Magnadramon (Holydramon)", "Imperialdramon Dragon Mode", "Imperialdramon Fighter Mode", "Imperialdramon Paladin Mode", "GranKuwagamon", "Valkyrimon", "Azulongmon (Qinglongmon)", "Zhuqiaomon", "Baihumon", "Ebonwumon (Xuanwumon)", "Gallantmon (Dukemon)", "MegaGargomon (SaintGalgomon)", "Sakuyamon", "Beelzemon Blast Mode", "Justimon", "Lopmon (Mega - Cherubimon)", "Cherubimon (Virtue/Vice)", "Susanoomon", "EmperorGreymon (KaiserGreymon)", "MagnaGarurumon (MagnaGarurumon)", "AncientGreymon", "AncientGarurumon", "AncientKazemon", "AncientBeetlemon", "AncientMegatheriumon", "AncientVolcanomon", "AncientTroiamon", "AncientMermaidmon", "AncientWisemon", "AncientSphinxmon", "ShineGreymon", "MirageGaogamon", "Rosemon Burst Mode", "Ravemon", "Vikaralamon", "QueenChessmon", "KingChessmon", "Sleipmon (Kentaurosmon)", "Darkdramon", "Valdurmon", "Chaosmon", "UltimateChaosmon", "Omnimon (Omegamon)", "Omnimon Zwart", "Omnimon Zwart Defeat", "Omnimon Merciful Mode", "Alphamon", "Dukemon Crimson Mode", "Sakuyamon Miko Mode", "Beelzemon X", "Gallantmon X", "MegaGargomon X", "Alphamon Ouryuken", "UlforceVeedramon", "UlforceVeedramon X", "Gankoomon", "Jesmon", "Jesmon GX", "Craniamon", "Dynasmon", "LordKnightmon (Crusadermon)", "Examon", "Duftmon (Leopardmon)", "Duftmon Leopard Mode", "Magnamon X", "Omnimon X", "WarGreymon X", "MetalGarurumon X", "Phoenixmon X", "HerculesKabuterimon X", "Rosemon X", "Vikemon X", "Seraphimon X", "Ophanimon X", "Magnadramon X", "MedievalDukemon", "ChaosDukemon", "Megidramon", "BlackWarGreymon", "BlackMetalGarurumon", "Diaboromon", "Armageddemon", "Apocalymon", "Millenniummon", "MoonMillenniummon", "ZeedMillenniummon", "MaloMyotismon (BelialVamdemon)", "Daemon (Creepymon)", "Daemon Super Ultimate", "Lilithmon (Laylamon)", "Leviamon", "Barbamon", "Belphemon Sleep Mode", "Belphemon Rage Mode", "Lucemon Satan Mode", "Lucemon Larva", "Ogudomon X", "Plutomon", "Neptunemon", "Ceresmon", "Ceresmon Medium", "Jupitermon", "Juno mon", "Junomon Hysteric Mode", "Marsmon", "Mercurymon (Mega)", "Minervamon", "Mervamon", "Bacchusmon", "Apollomon", "Dianamon", "Venusmon", "Vulcanusmon", "Machinedramon (Mugendramon)", "Piedmon", "Puppetmon (Pinocchimon)", "MetalSeadramon", "VenomMyotismon", "GigaSeadramon", "Gulfmon", "Ghoulmon (SkullMammon)", "Boltmon", "PrinceMamemon", "KingEtemon", "Plesiomon", "Aegisdramon", "BanchoLeomon", "BanchoStingmon", "BanchoMamemon", "BanchoGolemon", "BanchoLilymon", "DarkKnightmon", "GrandisKuwagamon", "TigerVespamon", "Gaioumon", "Samudramon", "Breakdramon", "Slayerdramon", "Ouryumon", "Rafflesimon", "BloomLordmon", "Hydramon", "God dmon (Goldramon)", "Magnamon", "Rapidmon (Armor)", "Arkadimon (Mega)", "Arkadimon (Super Ultimate)", "HiAndromon", "MarineAngemon", "MetalEtemon", "SaberLeomon", "Rosemon X", "ShineGreymon Burst Mode", "MirageGaogamon Burst Mode", "Ravemon Burst Mode", "Argomon (Mega)", "PileVolcamon", "AncientGreymon", "VictoryGreymon", "ZeedGarurumon", "Shoutmon X7 Superior Mode", "Arresterdramon Superior Mode", "GraceNovamon", "Durandamon", "Bryweludramon", "Raguelmon", "Rasielmon", "Meicoomon (Mega)", "Ordinemon", "HeavyLeomon", "Achillesmon", "Agumon - Bond of Bravery", "Gabumon - Bond of Friendship", "Eosmon (Mega)", "Mitamamon (Mega)", "FrosVelgrmon", "Proximamon", "Regalecusmon", "Siriusmon", "Arcturusmon", "Diarbbitmon", "Amphimon", "Ajatarmon (Mega form context)", "Gaiamon (Concept)", "Dominimon", "ClavisAngemon", "SlashAngemon", "Quartzmon", "Ogudomon", "Shakamon", "LovelyAngemon", "Rasenmon", "Rasenmon Fury Mode", "Paledramon (Mega context)", "Metallicdramon", "Zhangwumon", "Quantumon", "Fenriloogamon", "TyrantKabuterimon", "Hexeblaumon", "Crusadermon (LordKnightmon)", "Jesmon X", "Gankoomon X", "Imperialdramon Dragon Mode (Black)", "Imperialdramon Fighter Mode (Black)", "NoblePumpkinmon",
            // Armor
            "Flamedramon", "Raidramon", "Magnamon", "Sethmon", "Halsemon", "Shurimon", "Toucanmon", "Digmon", "Submarimon", "Nefertimon", "Pegasusmon", "Manbomon", "Mantaraymon", "Ponchomon", "Prairiemon", "Rinkmon", "Sagittarimon", "Sheepmon", "Swanmon", "Tylomon", "Yaksamon", "Allomon", "Lynxmon", "Maildramon", "Opossummon", "Orcamon", "Peacockmon", "Pteramon", "Quetzalmon", "Stegomon", "Boarmon", "Bullmon", "Butterflymon", "Chameleomon", "Elephantmon", "Frogmon", "Gargoylemon", "Goatmon", "Honeybeemon", "Kangarumon", "Moosemon", "Nohemon", "Pipismon", "Searchmon", "Seahomon", "Kongoumon", "Pucchiemon (Green/Pink)", "Bitmon", "FlaWizardmon", "Kenkimon", "Togemogumon", "Archelomon", "Baronmon", "Shadramon", "Kabukimon", "Coatlmon", "Rapidmon (Armor Gold)",
            // Hybrids (Warrior Ten etc.)
            "Agunimon", "BurningGreymon", "EmperorGreymon", "Lobomon", "KendoGarurumon", "MagnaGarurumon", "Kazemon", "Zephyrmon", "AncientKazemon", "Beetlemon", "MetalKabuterimon", "AncientBeetlemon", "Kumamon", "Korikakumon", "AncientMegatheriumon", "Lowemon", "JagerLowemon", "AncientSphinxmon", "Arbormon", "Petaldramon", "AncientTroiamon", "Ranamon", "Calamaramon", "AncientMermaidmon", "Gigasmon", "Grottomon", "AncientVolcanomon", "Mercurymon", "Sephirothmon", "AncientWisemon", "Duskmon", "Velgemon", // Lowemon related
            // Appmon (Standard/Super/Ultimate/God Grade)
            "Gatchmon", "Navimon", "Musimon", "Hackmon (App)", "Dokamon", "Perorimon", "Recomon", "Dosukomon", "Raidramon (App)", "Mediamon", "Revivemon", "Globemon", "Timemon", "Oujamon", "Entermon", "Poseidomon", "Hadesmon", "Uranusmon", "Gaiamon (App)", "Deusmon", "Shutmon", "Logomon", "Warudamon", "Biomon", "Fakemon", "Bootmon", "Logimon", "Weathermon", "Scopemon", "Sociamon", "Satellamon", "Charismon", "Beautymon", "Damedamon", // (List Appmon selectively)
            // Other/Special/Xros
            "OmniShoutmon", "OmegaShoutmon", "Shoutmon X2", "Shoutmon X3", "Shoutmon X4", "Shoutmon X5", "Shoutmon X7", "DarkKnightmon", "MusoKnightmon", "Ballistamon", "Dorulumon", "Starmon (Xros)", "Pickmon", "Cutemon", "Dondokomon", "Tactimon", "Blastmon", "Lilithmon (Xros)", "MetalGreymon (Xros Wars)", "DeckerGreymon", "ZekeGreymon", "Cyberdramon (Xros Wars)", "Dracomon", "Gumdramon", "Arresterdramon", "Tuwarmon", "Damemon", "Psychemon (Xros)", "Astamon (Xros)", "Clockmon (Xros)", "Greymon (Xros Wars)", "MailBirdramon", "Sparrowmon", "Mervamon", "Beelzemon (Xros Wars)", "Wizardmon (Xros Wars)", "Ignitemon", "DeadlyAxemon", "SkullKnightmon", "Baalmon", "ChuuChuumon", "Shoutmon DX", "Shoutmon EX6", "Shoutmon X7F Superior Mode", "GreyKnightsmon", "OmegaShoutmon X", "Olegmon", "Gravimon", "Zamielmon", "Splashmon", "Apollomon (Xros)"
        ];
        const digimonThemes = [
            "Rookie Digimon", "Champion Digimon", "Ultimate Digimon (Perfect)", "Mega Digimon (Ultimate JP)", "Armor Digivolutions", "Hybrid Digimon (Legendary Warriors)",
            "Royal Knights", "Seven Great Demon Lords", "Olympus XII", "Four Great Dragons", "Four Holy Beasts (Sovereigns)", "Deva Digimon",
            "Digimon from Adventure (01/02)", "Digimon from Tamers", "Digimon from Frontier", "Digimon from Savers/Data Squad", "Digimon from Xros Wars/Fusion", "Digimon from App Monsters", "Digimon from Tri", "Digimon from Last Evolution Kizuna", "Digimon from Ghost Game",
            "Virus Attribute Digimon", "Data Attribute Digimon", "Vaccine Attribute Digimon", "Free Attribute Digimon", "Variable Attribute", "Unknown Attribute",
            "Dragon Type Digimon", "Beast Type Digimon", "Bird Type Digimon", "Insect Type Digimon", "Plant Type Digimon", "Aquatic Type Digimon", "Holy Type Digimon", "Dark Type Digimon", "Machine/Cyborg Type Digimon", "X-Antibody Digimon", "Appmon Chips", "Burst Mode Digimon"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres una base de datos viviente y experta en Digimon, similar a un Digivice avanzado o a Gennai. Tu tarea es proporcionar una descripción EXHAUSTIVA y detallada del Digimon solicitado. Incluye su Nivel (Rookie, Champion, Ultimate, Mega, etc.), Tipo (ej: Dragon, Beast, Holy), Atributo (Vaccine, Data, Virus, Free, Variable, Unknown), una descripción detallada de su apariencia física y diseño, sus ataques principales conocidos (con descripciones breves si es posible), su personalidad general (basada en apariciones en anime, manga o juegos), líneas evolutivas comunes (pre-evoluciones y evoluciones), y cualquier aparición o rol notable que haya tenido en las distintas series o videojuegos de Digimon. Sé lo más completo posible, como si estuvieras creando una entrada para la enciclopedia Digimon definitiva. El objetivo es un texto de aproximadamente 1200-1300 palabras.",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador rápido de nombres para una Digidex. Genera exactamente 15 nombres de Digimon existentes (pueden ser de cualquier nivel, generación o forma). Devuelve *solo* la lista de nombres, uno por línea. No incluyas números, guiones, introducciones, niveles ni despedidas. Solo los nombres.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (sin cambios estructurales)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Contenedor para texto e imagen final
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ========== (sin cambios funcionales, solo prompts)
        async function fetchTextFromApi(prompt, config) {
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo.`);
                 throw new Error(`Error de comunicación con la API: ${error.message}`);
             }
        }
        async function fetchExplanationText(conceptTitle) {
            const text = await fetchTextFromApi(conceptTitle, textApiConfig);
             if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de") || text.toLowerCase().includes("lo siento")) {
                  throw new Error("La IA no pudo generar datos adecuados o suficientemente detallados para este Digimon.");
              }
            return text;
        }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(digimonThemes) || "Digimon populares";
             const specificPrompt = `Genera 15 nombres de Digimon relacionados con ${randomTheme}`;
             console.log("Generating titles with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 2 && line.length < 50); // Nombres cortos
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes nombres de Digimon.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(digimonName, options = {}) { // Prompt adaptado a DIGIMON
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safeName = typeof digimonName === 'string' && digimonName.trim() !== '' ? digimonName : "Agumon";
            // Prompt ENFOCADO en el Digimon, estilo anime/oficial
            const enhancedPrompt = `${safeName}, Digimon, digital monster, detailed official art style illustration, dynamic pose, simple digital world background (optional), full body shot if possible.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            // NEGATIVE PROMPT: Evitar texto, humanos, baja calidad.
            const negativePrompt = "text, words, letters, signature, watermark, logo, human figure, trainer, tamer, digivice, card game text, multiple digimon, low quality, blurry, deformed, bad anatomy, extra limbs, text overlay, UI elements, photorealistic, real life";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, '<br>'); // Keep line breaks within paragraphs
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (sin cambios funcionales)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function getDigimonIcon() { // Simple function for variety
             const icons = ['fa-paw', 'fa-dragon', 'fa-robot', 'fa-ghost', 'fa-feather-alt', 'fa-bug', 'fa-fish', 'fa-shield-alt', 'fa-fire', 'fa-bolt', 'fa-snowflake', 'fa-leaf', 'fa-dna'];
             return getRandomElement(icons);
         }
        function createTitleItem(title) {
             const div = document.createElement('div');
             div.className = 'title-item';
             const icon = document.createElement('i');
             icon.className = `fas ${getDigimonIcon()}`; // Add random thematic icon
             div.appendChild(icon);
             const span = document.createElement('span');
             span.textContent = title;
             div.appendChild(span);
             div.setAttribute('data-title', title);
             div.addEventListener('click', () => handleTitleClick(title)); return div;
         }
        function displayTitles(titles) {
            if (!titleListContainer || !titlesLoading) return;
            // const shuffledTitles = shuffleArray([...titles]); // Maybe don't shuffle Digimon list? Keep alphabetical? Or group? Let's keep the order for now.
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (titles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay Digimon en la base de datos.</p>'; return; }
            titles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        // *** MODIFIED: handleTitleClick logic for image placement remains the same ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // 1. Fetch and format text
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // 2. Stop loading indicator, display text
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                // 3. RESET SCROLL after text content is visible
                modalContent.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // 4. Prepare and append image placeholder within #modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p>Generando imagen del Digimon...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Add placeholder at the end of text

                // 5. Create and append the actual image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Imagen de ${title}`;
                imgElement.style.display = 'none'; // Hide until loaded

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove(); // Remove placeholder
                    imgElement.style.display = 'block'; // Show image
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-eye-slash placeholder-icon"></i>
                        <p>Error al cargar la imagen.</p>
                    `; // Update placeholder on error
                };

                // Get URL and set src
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append image element
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle placeholder-icon"></i>
                        <p>Error al generar URL de imagen.</p>
                    `;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error al cargar datos: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = ''; // Clear partial content
            }
        }

        async function handleGenerateMoreTitles() { // Thematic text updates
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando señal...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block';
                 } else {
                     alert("No se encontraron nuevos Digimon en la red en este momento.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar Digimon: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> ¡Descubrir Más Digimon!';
             }
         }


        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Initialization failed. Critical components missing."); document.body.innerHTML = '<p style="color: red; font-size: 2em; text-align: center; padding-top: 5em;">¡Error Crítico! No se pudo inicializar la Digidex.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles); // Display initial list
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>