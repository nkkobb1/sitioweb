<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crónicas Animales - Civilizaciones Ocultas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Orgánicas/Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Civilizaciones Animales --- */
        :root {
            --color-primary: #228B22; /* Verde Bosque */
            --color-secondary: #D2691E; /* Marrón Chocolate (Detalles) */
            --color-tertiary: #87CEEB; /* Azul Cielo Claro (Énfasis) */
            --color-background: #f5f5dc; /* Beige / Crema */
            --color-text: #3a3a3a; /* Gris Oscuro Cálido */
            --color-text-muted: #708090; /* Gris Pizarra */
            --color-modal-bg: #fffaf0; /* Blanco Floral */
            --color-border: #dcdcdc; /* Borde Gris Claro */
            --color-error-bg: #fff0f0; /* Fondo error rosa pálido */
            --color-error-text: #a52a2a; /* Texto error marrón rojizo */
            --color-error-border: #ffb6c1; /* Borde error rosa claro */

            --shadow-sm: 0 2px 4px 0 rgba(105, 105, 105, 0.1); /* Sombra más suave */
            --shadow-md: 0 4px 8px -1px rgba(105, 105, 105, 0.15), 0 2px 4px -2px rgba(105, 105, 105, 0.1);
            --shadow-lg: 0 10px 20px -5px rgba(105, 105, 105, 0.2), 0 8px 10px -6px rgba(105, 105, 105, 0.15);
            --border-radius: 8px; /* Bordes más redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; }
        h1, h2, h3, h4, .logo, button, input { font-family: 'Quicksand', sans-serif; } /* Sans-serif para elementos interactivos/títulos */
        .logo { color: var(--color-primary); font-weight: 700; }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; }
        .navbar { background-color: rgba(255, 250, 240, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #ffffff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(34, 139, 34, 0.2); outline: none; background-color: #ffffff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 500; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-primary); background-color: #f0fff0; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1e6a1e; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: #b0c4b1; color: #f0f0f0; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(85, 107, 47, 0.85); /* Verde Oliva Oscuro Overlay */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px; width: 95%; max-height: 90vh; min-height: 450px; /* Acomodar chat y minijuego potencialmente */
            overflow: hidden; position: relative; box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e0e0e0; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-size: 1.05rem; /* Slightly larger body text */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; font-family: inherit; } /* Use body font */
        #modal-content em { color: var(--color-secondary); font-style: italic; font-family: inherit; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Quicksand', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid #e0e0e0; padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.4em; } #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; }
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(112, 128, 144, 0.3); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.8rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; background-color: rgba(245, 245, 220, 0.3); border-radius: var(--border-radius); padding: 1rem; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #ffffff; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; font-family: 'Quicksand', sans-serif; font-size: 0.95rem; }
        .user-message { background-color: var(--color-tertiary); color: var(--color-text); margin-left: auto; text-align: left; border-bottom-right-radius: 0;} /* Bubble tail */
        .ai-message { background-color: #e6e6fa; color: var(--color-text); margin-right: auto; text-align: left; border-bottom-left-radius: 0; } /* Bubble tail */
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem;}
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #ffffff; color: var(--color-text); border-radius: var(--border-radius); font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-secondary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #b85a1a; }
        #chat-send-btn:disabled { background-color: #d2b48c; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Quicksand', sans-serif; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator & Minigame */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 250, 240, 0.97); /* Floral White overlay */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius); padding: 2rem;
        }
        #loading-spinner-area { text-align: center; margin-bottom: 1.5rem; }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1rem auto; }
        #loading-message { font-weight: 500; color: var(--color-text); font-size: 1.25rem; font-family: 'Quicksand'; margin-bottom: 2rem; }

        #loading-minigame {
            text-align: center; border: 1px dashed var(--color-secondary); border-radius: var(--border-radius); padding: 1.5rem 1rem; background-color: rgba(210, 180, 140, 0.1); /* Tan background */
            width: 80%; max-width: 300px;
        }
        #minigame-title { font-size: 1.1rem; font-weight: 700; color: var(--color-secondary); margin-bottom: 1rem; }
        #collector-button {
            font-size: 2.5rem; padding: 0.8rem; margin-bottom: 1rem; cursor: pointer; transition: transform 0.1s ease;
            background: none; border: none; color: var(--color-primary);
        }
        #collector-button:active { transform: scale(0.9); }
        #score-display { font-size: 1.4rem; font-weight: 700; color: var(--color-primary); }
        .plus-one-anim { /* Style for the "+1" text */
            position: absolute; font-size: 1rem; color: var(--color-primary); font-weight: bold;
            animation: floatUp 0.8s ease-out forwards;
            pointer-events: none; /* So it doesn't interfere with clicking */
            opacity: 1;
        }
        @keyframes floatUp {
            from { transform: translateY(0); opacity: 1; }
            to   { transform: translateY(-30px); opacity: 0; }
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Quicksand'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(47, 79, 79, 0.95); /* Dark Slate Gray */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-modal-bg); box-shadow: var(--shadow-lg); border-radius: 4px;}
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-paw mr-3 text-green-700"></i> <!-- Icono huella -->
                     Crónicas Animales
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">» Civilizaciones Ocultas «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Historias Tejidas por Garras y Plumas</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-serif">Explora los anales de sociedades secretas donde los animales gobiernan, construyen y sueñan. Elige una crónica o busca un tema.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar por especie, lugar o evento...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-yellow-700 mr-2"></i> <!-- Icono libro -->
                 Índice de Crónicas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Desenterrando los archivos del bosque...</p>
                  <!-- .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron crónicas con esos términos «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Historias (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator & Minigame -->
             <div id="modal-loading">
                 <div id="loading-spinner-area">
                     <div class="loading-spinner-modal"></div>
                     <p id="loading-message">Tejiendo la historia...</p>
                 </div>
                 <!-- MINIGAME AREA -->
                 <div id="loading-minigame">
                     <p id="minigame-title">¡Recolecta mientras esperas!</p>
                     <button id="collector-button" aria-label="Recolectar">🌰</button> <!-- Emoji de Castaña/Nuez -->
                     <div id="score-display">Recolectado: 0</div>
                 </div>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) -->
                         <!-- Image placeholder/final image -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al cronista...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta crónica...">
                         <button id="chat-send-btn" aria-label="Enviar Pregunta"><i class="fas fa-feather-alt"></i></button> <!-- Icono pluma -->
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada de la Crónica">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Crónicas generadas por IA, inspiradas en la imaginación de un mundo gobernado por animales.</p>
              <p class="mt-1">Los eventos y sociedades descritas son ficticios.</p>
              <p class="mt-2">© [Año Actual] Archivos del Bosque Profundo</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Sociedades y Gobierno
            "El Parlamento de los Búhos Sabios", "La República de las Hormigas Obreras", "El Reino Submarino del Pez Emperador", "La Horda Nomádica de los Lobos Grises", "El Concilio Arbóreo de las Ardillas", "La Teocracia de los Cuervos Augures", "La Federación Fluvial de los Castores Ingenieros", "El Imperio Desértico de los Escorpiones", "La Colonia Colmena de las Abejas Reales", "La Anarquía Organizada de los Gatos Callejeros", "La Jerarquía Silenciosa de las Serpientes", "El Senado Coralino de los Peces Loro", "La Corte Invernal del Oso Polar", "La Comuna Agrícola de los Topos", "La Confederación Aérea de las Águilas", "El Dominio Cavernario de los Murciélagos", "La Sociedad Secreta de los Zorros", "El Clan de la Montaña de las Cabras Montesas", "La Gran Migración Unificada (Gnus y Cebras)", "El Protectorado del Pantano (Cocodrilos y Garzas)",
            // Roles y Profesiones
            "Diario de un Tejón Cartógrafo", "Las Crónicas del Guardián Erizo", "Memorias de una Nutria Mercader", "El Aprendizaje de un Halcón Mensajero", "La Vida de un Escarabajo Joyero", "El Canto del Grillo Historiador", "Las Aventuras de un Ratón Explorador de Despensas", "El Legado del Jabalí Constructor de Murallas", "Las Pruebas del Escolta Escarabajo Rinoceronte", "La Sabiduría de la Tortuga Archivista", "El Arte del Camaleón Espía", "El Deber del Perro Pastor Guardián", "La Inspiración de la Araña Tejedora de Historias", "El Ritual del Pájaro Lira Compositor", "La Rutina del Gusano Reciclador", "Las Enseñanzas del Mono Herbolario", "El Juicio del Buitre Forense", "La Habilidad del Pulpo Cerrajero", "La Paciencia del Perezoso Filósofo", "El Instinto del Tiburón Estratega",
            // Conflictos y Guerras
            "La Guerra de los Túneles: Topos contra Suricatas", "El Asedio del Gran Roble (Ardillas vs. Pícaros)", "La Batalla Nocturna por el Claro Iluminado (Luciérnagas vs. Arañas)", "La Rebelión de las Termitas Soldado", "El Conflicto Territorial de los Leones Pródigos", "La Invasión Silenciosa de las Ratas Urbanas", "La Gran Guerra del Arrecife (Peces vs. Morenas)", "La Escaramuza Aérea: Golondrinas contra Murciélagos", "La Disputa por el Oasis Escondido (Camellos vs. Gacelas)", "La Venganza del Enjambre de Avispas", "Guerra Fría: Zorros Árticos vs. Liebres Níveas", "La Caída de la Ciudad Gorila", "El Alzamiento de los Cangrejos Ermitaños", "La Traición en el Nido del Águila Calva", "La Purga de los Perros Salvajes", "El Duelo de los Ciervos por el Liderazgo", "La Guerra Química de las Mofetas Defensoras", "El Bloqueo del Río por las Pirañas", "La Resistencia de los Conejos contra los Hurones", "La Batalla por la Última Flor de Néctar (Colibríes)",
            // Lugares y Exploración
            "Secretos de la Ciudad Colgante de los Monos Aulladores", "Explorando las Ruinas Sumergidas de la Atlántida Pulpo", "El Viaje al Corazón del Volcán Salamandra", "Los Misterios de la Biblioteca de Cristal de las Libélulas", "Dentro del Gran Termitero Central", "La Ciudadela Esculpida en Hielo de los Pingüinos Emperador", "Navegando por el Mar de Sargasos de las Tortugas Marinas", "El Laberinto Subterráneo de los Conejos", "Ascenso a los Picos Prohibidos de los Cóndores", "La Metrópolis Flotante de los Patos Mandarines", "El Mercado Nocturno Secreto de los Mapaches", "Las Tierras Baldías de Hueso (Hienas)", "El Santuario del Árbol Ancestral (Perezosos)", "La Red de Cuevas Bioluminiscentes (Gusanos de Luz)", "El Gran Desierto de Cristal (Lagartos)", "La Universidad Flotante de los Delfines", "El Bosque Petrificado de los Insectos Palo", "La Isla de los Pájaros Bobos", "El Valle Escondido de los Pandas", "La Necrópolis Submarina de las Ballenas",
            // Misterios y Leyendas
            "La Leyenda del Gran Gusano Blanco", "El Misterio de las Estatuas Lloronas de Piedra (Caracoles)", "La Profecía del Eclipse Sangriento (Lobos)", "En Busca de la Fuente de la Juventud Eterna (Mariposas Monarca)", "El Fantasma del Gato Montés Decapitado", "El Código Secreto en el Canto de las Ballenas Jorobadas", "La Maldición de la Perla Negra (Ostras)", "El Enigma de los Círculos en los Cultivos (Hormigas)", "El Mito del Pájaro de Fuego", "La Desaparición de la Colonia de Lemmings", "El Tesoro Hundido del Rey Cangrejo", "La Criatura de las Sombras del Pantano Profundo", "El Portal Interdimensional en el Viejo Hormiguero", "La Sociedad Secreta que Adora a los Humanos Extintos", "La Leyenda de la Flor Lunar que Otorga Inteligencia", "El Misterio de los Nidos Vacíos", "El Último Huevo de Dragón (Komodo)", "La Canción que Duerme al Kraken", "El Mapa Tatuado en la Piel de una Serpiente Antigua", "El Guardián Silencioso de las Ruinas Humanas",
            // Vida Cotidiana y Cultura
            "El Festival Anual de la Cosecha de Nueces (Ardillas)", "Un Día en la Vida de una Familia de Suricatas Vigías", "El Ritual de Cortejo del Ave del Paraíso", "La Construcción Cooperativa de una Presa (Castores)", "El Mercado de Trueque Subterráneo (Topos y Tejones)", "La Ceremonia de Muda de Piel (Serpientes)", "El Arte Efímero de las Telarañas Decoradas", "La Educación de los Cachorros de Lobo", "El Banquete Nupcial de la Mantis Religiosa", "La Siesta Sincronizada de la Manada de Leones", "El Juego de Pelota con Cocos (Monos Capuchinos)", "La Celebración del Solsticio de Invierno (Osos)", "La Creación de Perlas (Ostras)", "El Entrenamiento de los Escarabajos Peloteros", "La Danza de las Grullas al Amanecer", "La Competencia de Canto de las Ranas Arborícolas", "El Cuidado Comunal de las Crías (Pingüinos)", "La Migración como Rito de Paso (Ñus)", "La Tradición Oral de los Loros Ancianos", "El Baño de Polvo Comunitario (Elefantes)",
            // Añadir más diversidad...
            "El Gremio de los Pájaros Carpinteros Ebanistas", "La Sociedad Filosófica de los Manatíes", "La Red de Espionaje de las Comadrejas", "El Culto Lunar de las Polillas", "La Orden Monástica de los Caracoles Contemplativos", "La Cofradía Pirata de las Gaviotas", "El Sistema Judicial Basado en Duelos (Escarabajos Ciervo)", "La Biblioteca Viviente de los Pulgones (Custodiada por Hormigas)", "El Orfanato Gestionado por Pelícanos", "La Bolsa de Valores de Semillas Raras (Hámsters)",
             // Ampliar aún más con temas como tecnología adaptada, interacciones con remanentes humanos, etc.
        ];
        const animalCivilizationThemes = [
            "sociedades de mamíferos", "reinos de aves", "imperios de insectos", "civilizaciones acuáticas", "gobiernos reptiles", "conflictos entre especies", "leyendas animales", "ciudades construidas por animales", "roles sociales animales", "exploración animal", "misterios del mundo natural", "cultura y rituales animales", "guerra en el reino animal", "alianzas inesperadas entre especies", "tecnología basada en la naturaleza", "animales en entornos post-humanos", "profecías del bosque", "héroes inesperados (ratones, insectos)", "sociedades subterráneas", "comunidades arbóreas"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un cronista y narrador experto del Archivo del Bosque Profundo. Tu especialidad son las civilizaciones secretas y complejas formadas por animales. Relata la historia indicada por el título con detalle vívido, enfocándote en la perspectiva animal, su sociedad, cultura, entorno y los eventos que se desarrollan. Describe sus motivaciones, construcciones, lenguaje (conceptual) y relaciones inter-especie si aplica. Evita la perspectiva humana. Crea una narrativa inmersiva de aproximadamente 1200-1300 palabras.",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
             systemPrompt: "Actúas como un Sabio del Archivo, conocedor profundo de la crónica animal específica que se está mostrando. Responde preguntas sobre los personajes, lugares, costumbres o eventos de esa historia en particular. Mantén la perspectiva del mundo animal y sé conciso.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // *** SOLICITAR 40 TÍTULOS ***
            systemPrompt: "Actúa como un generador de ideas para crónicas de civilizaciones animales. Genera exactamente 40 títulos evocadores y únicos para historias sobre sociedades, conflictos, misterios o vida cotidiana en un mundo gobernado por animales. Devuelve *solo* la lista de títulos, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentar ligeramente el timeout por si necesita más tiempo para 40
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, pero añadir los del minijuego)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const loadingMinigame = document.getElementById('loading-minigame');
        const collectorButton = document.getElementById('collector-button');
        const scoreDisplay = document.getElementById('score-display');
        const loadingMessage = document.getElementById('loading-message'); // Para el texto de carga principal

        // ========== State Variables ==========
        let currentStoryTitle = null; // Para chat
        let minigameInterval = null; // Para el minijame (si se usara intervalo)
        let minigameScore = 0;
        let gameActive = false;

        // ========== MINIGAME FUNCTIONS ==========
        function startGame(buttonElement) {
            if (!loadingMinigame || !scoreDisplay || !buttonElement) return;
            console.log("Starting minigame...");
            minigameScore = 0;
            updateScore();
            loadingMinigame.style.display = 'block'; // Asegurar que sea visible
            // Asegurarse que el botón sea cliqueable
            buttonElement.disabled = false;
            gameActive = true;
        }

        function clickCollector(event) {
            if (!gameActive || !collectorButton) return;

            minigameScore++;
            updateScore();

            // --- Animación +1 ---
            const plusOne = document.createElement('div');
            plusOne.textContent = '+1';
            plusOne.className = 'plus-one-anim';
            // Posicionar cerca del click o del botón
            const rect = collectorButton.getBoundingClientRect();
            const modalRect = storyModal.getBoundingClientRect(); // Contenedor relativo
            // Posicionamiento relativo al botón dentro del modal
            plusOne.style.left = `${event.clientX - modalRect.left - 10}px`; // Ajustar offset
            plusOne.style.top = `${event.clientY - modalRect.top - 20}px`;  // Ajustar offset

            loadingMinigame.appendChild(plusOne); // Añadir al contenedor del juego
            // Remover el elemento después de la animación
            plusOne.addEventListener('animationend', () => {
                plusOne.remove();
            });

             // Simple feedback visual en el botón
            collectorButton.style.transform = 'scale(0.9)';
            setTimeout(() => {
                 if (collectorButton) collectorButton.style.transform = 'scale(1)';
            }, 100);
        }

        function updateScore() {
            if (scoreDisplay) {
                 scoreDisplay.textContent = `Recolectado: ${minigameScore}`;
            }
        }

        function stopGame() {
            console.log("Stopping minigame...");
            gameActive = false;
            if (loadingMinigame) loadingMinigame.style.display = 'none'; // Ocultar al terminar
            if (collectorButton) collectorButton.disabled = true; // Desactivar botón por si acaso
        }

        // ========== API FUNCTIONS ==========
        // fetchTextFromApi (con manejo de errores amigable y contexto de chat) - SIN CAMBIOS FUNCIONALES
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `Eres un Sabio del Archivo, conocedor profundo de la crónica animal llamada '${currentStoryTitle}'. Responde preguntas sobre los personajes, lugares, costumbres o eventos de esa historia en particular. Mantén la perspectiva del mundo animal y sé conciso.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(${response.status}) Nuestros servidores están un poco ocupados en este momento. Inténtalo de nuevo en unos segundos, por favor.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta del cronista llegó vacía. Quizás reformula la pregunta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con el Archivo tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un murmullo inesperado al contactar al Archivo.");
             }
         }

        async function fetchExplanationText(storyTitle) {
            return fetchTextFromApi(storyTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentStoryTitle) throw new Error("Error interno: No se ha establecido la crónica para la consulta.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        // *** MODIFIED: fetchGeneratedTitles requests 40 ***
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(animalCivilizationThemes) || "civilizaciones animales";
             const specificPrompt = `Genera 40 títulos únicos sobre ${randomTheme}`;
             // Usa la config actualizada que pide 40
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n')
                                        .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                        .filter(line => line.length > 10 && line.length < 150); // Filtro robusto
                     if (titles.length < 10) throw new Error("El Archivo no pudo generar suficientes ideas nuevas."); // Exigir al menos 10 válidas
                     return titles.slice(0, 40); // Devolver hasta 40
                 });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "animal civilization scene";
             // Prompt enfocado en la temática
             const enhancedPrompt = `Concept art for '${safePromptText}'. Animal civilization, animal characters interacting or in their unique environment (forest city, underwater kingdom, treetop village, burrow network). Focus on animal perspective, natural/animal-made structures. NO humans, NO text, NO labels. Evocative lighting.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, graphs, charts, diagrams, map, flag, humanoid figures, humans, people, photorealistic, photograph, blurry, low quality, watermark, signature, UI elements";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL, FULLSCREEN, CHAT FUNCTIONS ==========
        // (Igual que antes, solo asegurando que resetModalState también detiene el juego)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex'; // Mostrar loading por defecto
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null;
             hideFullscreenImage();
             stopGame(); // *** Asegurar que el juego se detiene ***
        }
        function showFullscreenImage(imgSrc) { /* ... sin cambios ... */
             if (!imageFullscreenOverlay || !fullscreenImage) return;
             fullscreenImage.src = imgSrc;
             imageFullscreenOverlay.classList.add('active');
             document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() { /* ... sin cambios ... */
             if (!imageFullscreenOverlay) return;
             imageFullscreenOverlay.classList.remove('active');
             if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
             fullscreenImage.src = '';
        }
        function addChatMessage(message, sender) { /* ... sin cambios ... */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... sin cambios ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error'); errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... sin cambios ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai');
            } catch (error) { console.error("Chat Error:", error); addChatError(`Error Cronista: ${error.message}`);
            } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» El Archivo parece vacío por ahora «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick starts minigame and stops it on completion/error ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title;
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; // Show loader
            loadingMessage.textContent = "Tejiendo la historia..."; // Reset loading message
            startGame(collectorButton); // *** START MINIGAME ***

            try {
                const rawExplanationText = await fetchExplanationText(title);
                // Si llegamos aquí, el texto principal se cargó
                stopGame(); // *** STOP MINIGAME ***
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none'; // Ocultar todo el loader
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Mostrar contenido + chat

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // -- Image Loading (starts after text is ready) --
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-feather-alt placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Ilustrando la crónica...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    placeholderDiv.remove(); imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Ilustración no disponible.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al crear URL.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                stopGame(); // *** STOP MINIGAME ON ERROR ***
                modalLoadingIndicator.style.display = 'none'; // Ocultar loader
                modalErrorMessage.textContent = error.message || "Una rama inesperada bloqueó la lectura de esta crónica.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Mostrar área de error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles requests 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando en el Archivo...';
             try {
                 // fetchGeneratedTitles ya está configurado para pedir 40
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron desenterrar más historias ahora."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar historias: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                  // Actualizar texto del botón para reflejar que genera 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Historias (40)';
             }
         }

         // Search Filter Function (con normalización para acentos)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !collectorButton) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">** ERROR CRÍTICO: El Archivo está dañado. No se pueden cargar los componentes. **</p>';
                return;
             }
            // Event listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            // *** MINIGAME LISTENER ***
            collectorButton.addEventListener('click', clickCollector);

            // Initial setup
             // Ensure year is dynamic in footer
             const footerYear = document.querySelector("footer p:last-child");
             if(footerYear) footerYear.textContent = `© ${new Date().getFullYear()} Archivos del Bosque Profundo`;

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
             stopGame(); // Asegurarse que el juego no está activo al inicio
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>