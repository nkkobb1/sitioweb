<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secretos del Ilusionismo Avanzado</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Elegantes / Misteriosas -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Ilusionismo Avanzado --- */
        :root {
            --color-primary: #c0a062; /* Dorado Antiguo */
            --color-secondary: #8a0303; /* Rojo Vino Oscuro */
            --color-tertiary: #4a0e6c; /* Púrpura Profundo */
            --color-background: #1a1a1a; /* Negro/Gris Muy Oscuro */
            --color-text: #e8e6e3; /* Blanco Roto / Beige Claro */
            --color-text-muted: #a8a29e; /* Gris Claro Cálido */
            --color-modal-bg: #262626; /* Gris Oscuro */
            --color-border: #57534e; /* Borde Gris Marrón */
            --color-error-bg: #4f1a1a;
            --color-error-text: #fecaca;
            --color-error-border: #ef4444;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -4px rgba(0, 0, 0, 0.4), 0 0 15px rgba(192, 160, 98, 0.2); /* Sombra dorada */
            --border-radius: 4px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Playfair Display', serif; font-weight: 700; }
        .logo { color: var(--color-primary); text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 1px 1px 5px rgba(0,0,0,0.5); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; font-size: 2rem; }
        .navbar { background-color: rgba(26, 26, 26, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #3f3f46; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(192, 160, 98, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Lato'; font-size: 1.05rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #3f3f46; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-secondary), var(--color-tertiary)); color: var(--color-primary); padding: 0.9rem 1.8rem; border: 1px solid var(--color-primary); border-radius: var(--border-radius); font-family: 'Playfair Display', serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-tertiary), var(--color-secondary)); box-shadow: var(--shadow-lg); transform: scale(1.03); border-color: #ecd19a; }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; border-color: var(--color-border); }
        #generate-more-btn .fa-sync-alt { color: var(--color-primary); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 1000px; /* Slightly wider for content */
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Taller for potential game */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg); box-shadow: 0 0 10px var(--color-primary); }
        #modal-title { text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Loading Indicator Area (Will contain game) */
        #modal-loading { text-align: center; padding: 1rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 26, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        #modal-loading.visible { opacity: 1; visibility: visible; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.3rem; font-family: 'Playfair Display'; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); margin-bottom: 1.5rem; }
        /* Default spinner (fallback or brief view) */
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ----- MINIGAME STYLES ----- */
        #minigame-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: center; background-color: #3f3f46; padding: 1.5rem; border-radius: var(--border-radius); border: 1px solid var(--color-primary); box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        #game-instructions { font-size: 1rem; color: var(--color-text-muted); margin-bottom: 1rem; font-family: 'Lato'; text-align: center; }
        #sequence-display { font-size: 1.8rem; color: var(--color-primary); margin-bottom: 1.5rem; min-height: 3rem; display: flex; align-items: center; justify-content: center; gap: 0.8rem; font-family: 'Playfair Display'; letter-spacing: 2px; }
        #symbols-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; }
        .game-symbol { font-size: 2.2rem; color: var(--color-text); background-color: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition-normal); box-shadow: var(--shadow-sm); }
        .game-symbol:hover { background-color: #57534e; transform: scale(1.1); color: var(--color-primary); border-color: var(--color-primary); }
        .game-symbol.correct { background-color: #166534; color: #a7f3d0; border-color: #6ee7b7; animation: pulse-correct 0.5s ease; }
        .game-symbol.incorrect { background-color: var(--color-secondary); color: #fecaca; border-color: #f87171; animation: shake-incorrect 0.5s ease; }
        @keyframes pulse-correct { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        @keyframes shake-incorrect { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        #game-progress { width: 100%; display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--color-text-muted); font-family: 'Lato'; padding: 0 0.5rem; }
        #game-level, #game-score { color: var(--color-primary); font-weight: 700; }
        /* ----- END MINIGAME STYLES ----- */

        /* Main Content Area (Text + Image + Chat) */
        #modal-story-content-area { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; opacity: 0; visibility: hidden; transition: opacity 0.4s 0.1s ease, visibility 0.4s 0.1s ease; } /* Fade in after loading */
         #modal-story-content-area.visible { opacity: 1; visibility: visible; }

        #modal-content-area { /* Scrollable part */ flex-grow: 1; min-height: 0; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(87, 83, 78, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 9px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(87, 83, 78, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-size: 1.05rem; } /* Slightly larger base font */
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: #d8b4fe; /* Light purple for emphasis */ font-style: italic; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Playfair Display', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 700; }
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; font-style: italic; }
        /* Image styles */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 3rem auto 1.5rem auto; border: 2px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: 0 0 20px rgba(192, 160, 98, 0.3); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: 0 0 30px rgba(192, 160, 98, 0.5); }
        #modal-content .image-placeholder { /* Styles similar to previous */ display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { /* Styles similar */ border: 4px solid rgba(87, 83, 78, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.8rem; color: var(--color-primary); opacity: 0.7;}

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 260px; background-color: rgba(0,0,0,0.2); }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.7rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(26, 26, 26, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) rgba(87, 83, 78, 0.5); }
        #chat-history::-webkit-scrollbar { width: 7px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(87, 83, 78, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.55; box-shadow: var(--shadow-sm); }
        .user-message { background-color: var(--color-primary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400; }
        .ai-message { background-color: #57534e; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #3f3f46; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); background-color: var(--color-modal-bg); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #d4b37a; transform: scale(1.05); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; transform: none;}
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; color: var(--color-primary); }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1) rotate(180deg); }
    </style>
</head>
<body class="antialiased">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-hat-magician mr-3 text-purple-400"></i> <!-- Icono sombrero -->
                     Secretos del Ilusionismo
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» El Arte Avanzado del Engaño «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Desvelando Misterios Avanzados</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Explora los principios, la psicología y las técnicas detrás de las ilusiones más sofisticadas. Selecciona un secreto o busca por nombre.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar ilusión, principio o técnica...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll text-yellow-200 mr-2"></i> <!-- Icono pergamino -->
                 Archivo de Secretos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Accediendo a los archivos clasificados...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún secreto encontrado bajo esos parámetros «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar Más Secretos (40)
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator / MINIGAME Area -->
             <div id="modal-loading">
                 <!-- Default Spinner (briefly shown or fallback) -->
                 <div class="loading-spinner-modal"></div>
                 <!-- Minigame Container (initially hidden) -->
                 <div id="minigame-container" style="display: none;">
                     <p id="game-instructions">Memoriza la secuencia y repítela...</p>
                     <div id="sequence-display">
                         <!-- Sequence icons appear here -->
                     </div>
                     <div id="symbols-area">
                         <!-- Clickable symbols appear here -->
                     </div>
                     <div id="game-progress">
                         <span>Nivel: <span id="game-level">1</span></span>
                         <span>Puntos: <span id="game-score">0</span></span>
                     </div>
                 </div>
                 <p id="loading-status-text" class="mt-4 text-lg text-gray-300 font-sans">Desvelando el misterio...</p>
             </div>

             <!-- Content Area Wrapper (Initially hidden) -->
             <div id="modal-story-content-area">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image placeholder/image added here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                      <div id="chat-history"></div>
                      <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al maestro...</div>
                      <div id="chat-input-area">
                          <input type="text" id="chat-input" placeholder="Pregunta más sobre esta ilusión...">
                          <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                      </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos y de entretenimiento sobre el arte del ilusionismo.</p>
              <p class="mt-1">Los métodos descritos son interpretaciones conceptuales y no necesariamente revelaciones completas.</p>
              <p class="mt-2">© MMXCIV Archivos Secretos de la Magia</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // GRANDES ILUSIONES CLÁSICAS Y MODERNAS
            "La Desaparición del Elefante (Houdini)", "El Tanque de Agua Chino (Water Torture Cell - Houdini)", "Atravesando la Gran Muralla China (Copperfield)", "La Desaparición de la Estatua de la Libertad (Copperfield)", "Levitación Aérea (Copperfield 'Flying')", "La Metamorfosis (Intercambio instantáneo)", "Serrando a una Persona por la Mitad (Variaciones avanzadas)", "La Mujer Zig-Zag", "El Cubo de Rubik Gigante Resuelto Instantáneamente", "Caminando sobre el Agua (Dynamo/Blaine)", "La Bala Atrapada con los Dientes", "Teletransportación a través de la Audiencia", "La Jaula Desvanecida (con persona o animal)", "El Coche que Aparece de la Nada", "El Escape de la Camisa de Fuerza (Suspendido)", "Enterrado Vivo (Escape)", "Aguantando la Respiración Bajo el Agua (Tiempo Extendido - Blaine)", "El Hombre Flotante (Street Magic - Blaine/Dynamo)", "Producción Infinita de Objetos (Botellas, etc.)", "El Portal Interdimensional (Aparición/Desaparición)", "La Mesa Flotante Espiritista (Avanzado)", "La Silla Eléctrica (Simulación de escape)", "El Espejo que Atraviesa", "Predicción del Titular del Periódico", "El Viaje en el Tiempo (Ilusión escénica)", "La Lámpara Flotante", "La Rosa Flotante y Ardiente", "La Sombra Viviente", "El Cuarto Inclinado (Anti-Gravedad)", "La Caja de Espadas", "La Aparición de un Helicóptero/Avión", "El Escape de la Caja Fuerte", "Manipulación del Fuego (Control aparente)", "El Efecto Mátrix (Esquivar objetos)", "Congelar el Tiempo (Street Magic)", "La Baraja Invisible (Rutina avanzada)",
            // PRINCIPIOS Y TÉCNICAS DE MISDIRECTION
            "Misdirection Temporal (Off-beat)", "Misdirection Espacial (Dirección de la mirada)", "Misdirection de Atención Dividida", "Misdirection por Intensidad (Movimiento grande oculta pequeño)", "Misdirection por Interés (Objeto brillante)", "Misdirection por Anticipación", "Misdirection Auditiva", "El Uso del Silencio en Misdirection", "La Psicología de la Atención Selectiva", "El Punto Ciego Natural", "Creación de Falsas Memorias", "La Técnica del 'Multiple Out'", "Forzaje Psicológico (Magician's Choice)", "Lectura en Frío (Cold Reading) Avanzada", "Lectura Muscular (Muscle Reading / Contact Mind Reading)", "El Principio de Dualidad (Doble Realidad)", "La Importancia del Guion (Patter)", "Construcción de la Persona Mágica (Character)", "Manejo del Público (Audience Management)", "Control de la Línea de Visión", "Uso de Cómplices (Stooges / Plants) - Ética y Técnica", "Uso de Gimmicks Ocultos (Principios)", "El Arte del 'Timing' y Ritmo", "La Técnica de 'Limpieza' (Clean-up)", "Manejo de Errores (Outs)", "Psicología de la Percepción de lo Imposible", "El Efecto Forer / Barnum", "Anclaje Emocional en la Magia", "Sugestión e Hipnosis Ligera en Escena", "El Lenguaje Corporal del Ilusionista", "Teoría del Engaño y Autoengaño", "Secretismo vs. Exposición en Magia", "Ética en el Mentalismo y la Ilusión", "Construcción de una Rutina Mágica", "Adaptación al Entorno (Close-up vs Escenario)",
            // SLEIGHT OF HAND (MANIPULACIÓN AVANZADA)
            "Empalme Clásico (Classic Palm - Monedas/Cartas)", "Empalme de Dedos (Finger Palm)", "Empalme Trasero (Back Palm / Back Clip)", "Empalmes Múltiples (Multiple Palms)", "El Cambio de Color Erdnase (Color Change)", "La Cuenta Falsa Elmsley (Elmsley Count)", "La Cuenta Falsa Jordan (Jordan Count)", "El Salto de Carta Invisible (Invisible Pass)", "El Salto Clásico (Classic Pass) - Perfeccionamiento", "La Floritura 'Cascade'", "La Floritura 'Spring'", "Abanicos a Una Mano y Dos Manos (Fans)", "Cortes Falsos Avanzados (False Shuffles/Cuts)", "El Control Secreto de Carta (Card Control Techniques)", "Producción Múltiple de Cartas (Card Production)", "Desaparición Completa de Moneda (Complete Coin Vanish)", "Producción Múltiple de Monedas (Coin Roll / Production)", "El 'Muscle Pass' con Monedas", "Rutinas Avanzadas con Dedales (Thimble Magic)", "Manipulación Avanzada de Bolas de Billar", "Producción y Desaparición de Pañuelos (Silk Magic)", "El Nudo que se Desata Solo", "Manipulación de Cigarrillos (Aparición/Desaparición)", "Técnicas de Carga y Descarga (Loading/Stealing)", "El 'Topit' - Uso Avanzado", "El 'Servante' - Principios", "Manipulación de Relojes (Robo escénico)", "El Arte del 'Lapping'", "Técnicas de Doblado de Metales (Metal Bending)", "Rutinas con Anillos Chinos (Linking Rings - Avanzado)",
            // MENTALISMO AVANZADO
            "Rutina de Preguntas y Respuestas (Q&A Act)", "Predicción en Sobre Sellado (Sealed Envelope Prediction)", "El Efecto 'Cualquier Carta en Cualquier Número' (ACAAN)", "Dibujo Duplicado (Drawing Duplication)", "Telepatía a Dos (Two-Person Code Act)", "El Libro Test (Book Test) - Métodos Avanzados", "Influencia Mental / Sugestión Directa", "Efecto Confabulación (Predicción detallada)", "Identificación de Objetos Ocultos (Billets)", "Psicometría (Lectura de objetos)", "Visión con los Ojos Vendados (Blindfold Act)", "Memorización Extrema (Mnemonics)", "Cálculo Relámpago (Lightning Calculation)", "Hipnosis Escénica (Principios y Ética)", "El Detector de Mentiras Humano", "Telekinesis Psicológica (PK Touches)", "Predicción con Pizarras Espiritistas", "El Centro del Desgarro (Center Tear)", "Inducción de Estados Emocionales", "Creación de Sincronicidades Aparentes",
            // HISTORIA Y FIGURAS
            "Jean-Eugène Robert-Houdin: El Padre de la Magia Moderna", "Harry Houdini: El Rey de las Esposas y Escapes", "Howard Thurston: El Último Gran Mago de Escenario Clásico", "Dai Vernon: El Profesor", "Cardini: El Maestro de la Manipulación Silenciosa", "Harry Blackstone Sr. & Jr.: Dinastía Mágica", "David Copperfield: La Era de las Grandes Ilusiones Televisadas", "Doug Henning: La Magia Hippie y el Renacimiento", "Siegfried & Roy: Espectáculo y Exotismo", "Penn & Teller: La Anti-Magia y la Exposición", "Lance Burton: Elegancia Clásica Moderna", "Derren Brown: El Maestro del Mentalismo Psicológico", "David Blaine: La Magia Callejera y de Resistencia", "Dynamo: Magia Visual Urbana", "La Edad de Oro de la Magia (Finales s. XIX - Principios s. XX)", "El Teatro del Misterio Egipcio (Ancient Egypt)", "La Magia en la Edad Media y el Renacimiento", "El Rol de la Mujer en la Magia", "Clubes y Sociedades Mágicas (Magic Circle, SAM, IBM)", "Libros Fundamentales de Ilusionismo (Expert at the Card Table, Stars of Magic)", "La Influencia del Espiritismo en la Magia", "El Desarrollo Tecnológico y la Ilusión", "El Futuro del Ilusionismo",
            // CONCEPTOS ADICIONALES
            "Ilusiones Ópticas y su Aplicación", "Principios de Trampantojo (Trompe-l'œil)", "Iluminación Escénica para Ilusionistas", "Diseño de Sonido y Música en Magia", "El Arte del Storytelling en la Ilusión", "Vestuario y Apariencia del Mago", "Construcción de Props y Gimmicks", "Magia con Espejos (Pepper's Ghost)", "Uso de Hilo Invisible Avanzado", "Magia con Químicos (Flash Paper, Smoke)", "Principios de Neumática e Hidráulica en Ilusiones", "Electrónica y Micro-tecnología en Magia", "Magia con Drones", "Realidad Aumentada y Magia Digital", "Magia Cómica (Principios)", "Magia Infantil (Consideraciones)", "Magia Corporativa y de Ferias", "Protección de Secretos Mágicos", "Derechos de Autor y Originalidad en Magia", "El Impacto Psicológico de la Magia en el Espectador"
             // ... (Adding more categories and specific tricks can easily reach 300-400+)
        ];
        const illusionismThemes = [
            "grandes ilusiones escénicas", "magia de cerca avanzada", "escapismo extremo", "mentalismo psicológico", "manipulación de cartas", "manipulación de monedas", "principios de misdirection", "historia de la magia", "ilusionistas famosos", "psicología del engaño", "técnicas de sleight of hand", "magia con tecnología", "construcción de ilusiones", "mentalismo de escenario", "magia callejera (street magic)", "lectura en frío y lenguaje corporal", "efectos de levitación", "efectos de desaparición", "predicciones imposibles", "hipnosis escénica", "magia con objetos cotidianos (avanzada)", "ilusiones ópticas en magia", "magia cómica", "secretos de la magia clásica"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres 'El Guardián de los Secretos', un erudito historiador y maestro ilusionista retirado. Tu propósito es explicar los principios, la psicología, la historia y las posibles metodologías (sin revelar todos los detalles cruciales, manteniendo el misterio) detrás del truco, técnica o concepto de ilusionismo avanzado indicado. Enfócate en el *efecto* para el público, las *técnicas de misdirection* empleadas, los *principios psicológicos* en juego y el *contexto histórico* si es relevante. Usa un lenguaje evocador, respetuoso del arte y ligeramente enigmático. El objetivo es un ensayo profundo de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tema:",
            timeoutSeconds: 180 // Increased timeout
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente del Guardián de los Secretos, especializado únicamente en la ilusión o concepto que se está mostrando. Responde preguntas de seguimiento sobre sus aspectos históricos, psicológicos o técnicos generales (mencionados en la descripción principal), manteniendo siempre el respeto por el arte y sin revelar secretos específicos del método. Sé conciso y mantente enfocado en el tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // MODIFIED: Ask for 40 titles
            systemPrompt: "Actúa como un generador de ideas conciso para un archivo secreto de ilusionismo. Genera exactamente 40 nombres evocadores de trucos de magia avanzados, técnicas de ilusionismo, principios psicológicos o conceptos relacionados con el arte del engaño. Devuelve *solo* la lista de nombres/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Slightly more time for more titles
        };
        const availableGameSymbols = [ // Icons for the minigame
             '<i class="fas fa-hat-magician"></i>', '<i class="fas fa-star"></i>', '<i class="fas fa-clover"></i>', // spade, heart, diamond, clover from fontawesome free weren't rendering well consistently
             '<i class="fas fa-key"></i>', '<i class="fas fa-eye"></i>', '<i class="fas fa-infinity"></i>',
             '<i class="fas fa-bolt"></i>', '<i class="fas fa-moon"></i>', '<i class="fas fa-sun"></i>', '<i class="fas fa-question"></i>'
             // Add more icons if needed for higher levels
        ];

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameContainer = document.getElementById('minigame-container');
        const gameInstructions = document.getElementById('game-instructions');
        const sequenceDisplay = document.getElementById('sequence-display');
        const symbolsArea = document.getElementById('symbols-area');
        const gameLevelDisplay = document.getElementById('game-level');
        const gameScoreDisplay = document.getElementById('game-score');
        const loadingStatusText = document.getElementById('loading-status-text');
        const defaultSpinner = modalLoadingIndicator.querySelector('.loading-spinner-modal');

        // ========== State Variables ==========
        let currentIllusionTitle = null;
        let isGameActive = false;
        let currentSequence = [];
        let playerSequenceIndex = 0;
        let gameLevel = 1;
        let gameScore = 0;
        let sequenceDisplayTimeout;
        let gameSymbolListeners = []; // To store removeEventListener info

        // ========== MINIGAME LOGIC ==========
        function getRandomSymbol(count = availableGameSymbols.length) {
            const limit = Math.min(count, availableGameSymbols.length);
            return availableGameSymbols[Math.floor(Math.random() * limit)];
        }

        function generateSequence(level) {
            const length = 3 + Math.floor(level / 2); // Sequence length increases every 2 levels
            const sequence = [];
            for (let i = 0; i < length; i++) {
                // Use more symbols as level increases
                const symbolDiversity = 4 + Math.min(level, availableGameSymbols.length - 4);
                sequence.push(getRandomSymbol(symbolDiversity));
            }
            return sequence;
        }

        function displaySequenceBriefly(callback) {
            sequenceDisplay.innerHTML = currentSequence.join('');
            gameInstructions.textContent = "¡Memoriza!";
            symbolsArea.innerHTML = ''; // Hide symbols while showing sequence

            const displayTime = Math.max(1000, 3000 - level * 150); // Less time for higher levels

            clearTimeout(sequenceDisplayTimeout); // Clear previous timeout if any
            sequenceDisplayTimeout = setTimeout(() => {
                sequenceDisplay.innerHTML = Array(currentSequence.length).fill('<i class="far fa-circle"></i>').join(''); // Show placeholders
                gameInstructions.textContent = "Repite la secuencia...";
                setupClickableSymbols();
                if (callback) callback();
            }, displayTime);
        }

        function setupClickableSymbols() {
            symbolsArea.innerHTML = ''; // Clear previous symbols
            gameSymbolListeners.forEach(info => info.element.removeEventListener('click', info.handler)); // Remove old listeners
            gameSymbolListeners = [];

            // Decide which symbols to show (current sequence symbols + some distractors)
            const symbolsToShow = new Set(currentSequence);
            const numDistractors = Math.min(2 + Math.floor(level / 3), availableGameSymbols.length - symbolsToShow.size);
            while (symbolsToShow.size < currentSequence.length + numDistractors) {
                symbolsToShow.add(getRandomSymbol());
            }

            // Shuffle and display
            const shuffledSymbols = shuffleArray(Array.from(symbolsToShow));
            shuffledSymbols.forEach(symbolHTML => {
                const symbolDiv = document.createElement('div');
                symbolDiv.className = 'game-symbol';
                symbolDiv.innerHTML = symbolHTML;
                const handler = () => handleSymbolClick(symbolDiv, symbolHTML);
                symbolDiv.addEventListener('click', handler);
                symbolsArea.appendChild(symbolDiv);
                gameSymbolListeners.push({ element: symbolDiv, handler: handler }); // Store listener info
            });
        }

        function handleSymbolClick(symbolDiv, clickedSymbolHTML) {
            if (!isGameActive || playerSequenceIndex >= currentSequence.length) return;

            const expectedSymbolHTML = currentSequence[playerSequenceIndex];

            if (clickedSymbolHTML === expectedSymbolHTML) {
                playerSequenceIndex++;
                gameScore += level; // More points for higher levels
                gameScoreDisplay.textContent = gameScore;
                symbolDiv.classList.add('correct');
                // Play a subtle correct sound (optional)
                // new Audio('path/to/correct.mp3').play();

                setTimeout(() => symbolDiv.classList.remove('correct'), 400); // Remove feedback class

                if (playerSequenceIndex === currentSequence.length) {
                    // Sequence Complete! Level Up!
                    levelUp();
                } else {
                     // Update placeholders
                     let placeholders = '';
                     for(let i=0; i<currentSequence.length; i++) {
                         placeholders += (i < playerSequenceIndex) ? currentSequence[i] : '<i class="far fa-circle"></i>';
                     }
                     sequenceDisplay.innerHTML = placeholders;
                }
            } else {
                // Incorrect Symbol
                symbolDiv.classList.add('incorrect');
                 // Play a subtle incorrect sound (optional)
                // new Audio('path/to/incorrect.mp3').play();
                gameInstructions.textContent = "¡Incorrecto! Intenta de nuevo la secuencia.";
                 setTimeout(() => {
                     symbolDiv.classList.remove('incorrect');
                     // Reset current sequence attempt
                     playerSequenceIndex = 0;
                     sequenceDisplay.innerHTML = Array(currentSequence.length).fill('<i class="far fa-circle"></i>').join(''); // Reset placeholders
                     // Optionally briefly re-show sequence or just let user try again
                 }, 500);
            }
        }

        function levelUp() {
             level++;
             gameLevelDisplay.textContent = level;
             gameInstructions.textContent = `¡Nivel ${level} superado! Prepárate...`;
             playerSequenceIndex = 0;
             currentSequence = generateSequence(level);
             setTimeout(() => displaySequenceBriefly(), 1500); // Pause before next level
        }

        function startGame() {
            if (!modalLoadingIndicator || !minigameContainer || !defaultSpinner) return;
            console.log("Starting Minigame...");
            isGameActive = true;
            level = 1;
            gameScore = 0;
            playerSequenceIndex = 0;
            gameLevelDisplay.textContent = level;
            gameScoreDisplay.textContent = gameScore;
            currentSequence = generateSequence(level);

            defaultSpinner.style.display = 'none'; // Hide spinner
            minigameContainer.style.display = 'flex'; // Show game
            modalLoadingIndicator.classList.add('visible'); // Make loading area visible

            displaySequenceBriefly();
            loadingStatusText.textContent = "Mientras esperas, ¡desbloquea el secreto!";
        }

        function stopGame() {
            if (!isGameActive || !modalLoadingIndicator || !minigameContainer || !defaultSpinner) return;
            console.log("Stopping Minigame...");
            isGameActive = false;
            clearTimeout(sequenceDisplayTimeout); // Stop any pending sequence display
            gameSymbolListeners.forEach(info => info.element.removeEventListener('click', info.handler)); // Clean up listeners
            gameSymbolListeners = [];

            minigameContainer.style.display = 'none'; // Hide game
            defaultSpinner.style.display = 'block'; // Show spinner briefly? Or just hide loading
            modalLoadingIndicator.classList.remove('visible'); // Hide loading area
            loadingStatusText.textContent = "Desvelando el misterio..."; // Reset text
        }

        // ========== API FUNCTIONS ========== (Increased titles, timeout)
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentIllusionTitle
                ? `Eres un asistente del Guardián de los Secretos, especializado únicamente en '${currentIllusionTitle}'. Responde preguntas de seguimiento sobre sus aspectos históricos, psicológicos o técnicos generales (mencionados en la descripción principal), manteniendo siempre el respeto por el arte y sin revelar secretos específicos del método. Sé conciso y mantente enfocado.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text (Timeout: ${config.timeoutSeconds}s, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico o el secreto es demasiado profundo. Intenta en unos segundos.`);
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("La respuesta del Guardián llegó vacía. Intenta preguntar de otra manera.");
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') throw new Error(`La conexión con los archivos secretos tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                throw new Error(error.message || "Ocurrió un error inesperado al consultar los archivos secretos.");
            }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentIllusionTitle) throw new Error("Error interno: Contexto de la ilusión perdido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(illusionismThemes) || "ilusionismo avanzado general";
            // MODIFIED: Ask for 40
            const specificPrompt = `Genera 40 nombres/conceptos de trucos o técnicas de ilusionismo sobre ${randomTheme}`;
            console.log("Generating 40 titles with prompt:", specificPrompt);
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 10) throw new Error("La IA no generó suficientes ideas de secretos."); // Expect at least 10 even if asking for 40
                     return titles.slice(0, 40); // Return up to 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "mystery magic illusion concept art";
             const enhancedPrompt = `Atmospheric concept art for the magic illusion or principle '${safePromptText}'. Focus on mood, mystery, symbolism (light, shadow, impossible objects, hands). Elegant, slightly dark aesthetic. Avoid text, diagrams, or overly literal depictions of method.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, diagram, chart, simple, plain background, photorealistic, boring, tutorial, explanation, technical drawing, ugly, deformed";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (No changes needed)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             stopGame(); // Ensure game stops if modal is closed prematurely
             modalLoadingIndicator.classList.remove('visible'); // Hide loading area
             modalStoryContentArea.classList.remove('visible'); // Hide content area
             modalStoryContentArea.classList.add('content-hidden'); // Use class for safety
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentIllusionTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (No changes needed)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (No changes needed)
        function addChatMessage(message, sender) { /* ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» No hay secretos en los archivos actualmente «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to integrate MINIGAME ***
        async function handleTitleClick(title) {
            resetModalState(); // Reset general state first
            showModal();
            modalTitle.textContent = title;
            currentIllusionTitle = title;
            modalError.classList.add('content-hidden');

            // *** START MINIGAME ***
            startGame();

            try {
                // Fetch text in the background WHILE game is running
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // *** STOP MINIGAME (on success) ***
                stopGame();

                // Display content
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalStoryContentArea.classList.add('visible'); // Trigger fade-in
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Image Loading (same logic as before)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-theater-masks placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Creando visualización...</p>`;
                modalContent.appendChild(placeholderDiv);
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación conceptual de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización no disponible.</p>`; };
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                 // *** STOP MINIGAME (on error) ***
                 stopGame();
                modalErrorMessage.textContent = error.message || "Error desconocido al desvelar el secreto.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalStoryContentArea.classList.add('visible'); // Make error area visible
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
            // Note: The `finally` block is implicitly handled by stopping the game in both try and catch paths before showing content/error.
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 titles ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             // MODIFIED: Update button text
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando los archivos profundos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches up to 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron revelar más secretos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al revelar secretos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // MODIFIED: Update button text
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Revelar Más Secretos (40)';
             }
         }

         // Search Filter Function (handle accents)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Add checks for new game elements if crucial
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameContainer || !symbolsArea) {
                console.error("Initialization failed: Missing essential UI or Game elements.");
                document.body.innerHTML = '<p style="color: #f87171; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: serif;">¡El Gran Grimorio está incompleto! Faltan componentes esenciales de la interfaz.</p>';
                return;
             }
            // Standard Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            minigameContainer.style.display = 'none'; // Ensure game is hidden initially
            modalLoadingIndicator.classList.remove('visible'); // Ensure loading screen is hidden
             modalStoryContentArea.classList.add('content-hidden'); // Ensure content area starts hidden
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>