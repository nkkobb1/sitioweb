<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enciclopedia de Falacias Argumentativas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y académicas -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Falacias Argumentativas --- */
        :root {
            --color-primary: #2563eb; /* Azul Sólido (Confianza, Claridad) */
            --color-secondary: #10b981; /* Verde Esmeralda (Énfasis, Chat) */
            --color-tertiary: #6b7280; /* Gris Medio (Secundario) */
            --color-background: #f3f4f6; /* Gris Muy Claro (Fondo página) */
            --color-text: #1f2937; /* Gris Oscuro (Texto principal) */
            --color-text-muted: #4b5563; /* Gris Medio-Oscuro (Texto secundario) */
            --color-modal-bg: #ffffff; /* Blanco (Fondo modal) */
            --color-border: #d1d5db; /* Borde Gris Claro */
            --color-error-bg: #fef2f2; /* Fondo error rojo muy claro */
            --color-error-text: #991b1b; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; }
        /* Texto principal en Merriweather para legibilidad */
        #modal-content { font-family: 'Merriweather', serif; }
        h1, h2, h3, h4, .logo { font-family: 'Lato', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.1rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 60px; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); border-left-color: var(--color-primary); background-color: #eff6ff; /* Azul muy claro hover */ }
        .title-item i { margin-right: 0.6rem; color: var(--color-primary); opacity: 0.6; transition: opacity 0.2s ease; }
        .title-item:hover i { opacity: 1; }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1d4ed8; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 900px; /* Un poco más estrecho para texto */
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e5e7eb; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; }
        #modal-title { font-size: 1.7rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; line-height: 1.75; /* Mayor interlineado para Merriweather */ font-size: 1.05rem; /* Ligeramente más grande */}
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; font-family: 'Lato'; /* Usar Lato para strong para contraste */ }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Lato', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 700; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.1em; color: var(--color-text); }
        #modal-content h4 { font-size: 1.0em; color: var(--color-text-muted); border-bottom: none; font-weight: 700;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); text-align: center;}
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(209, 213, 219, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; margin-bottom: 0.3rem;}

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.6rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; /* Fondo chat muy claro */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-family: 'Lato'; font-size: 0.95rem;}
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; /* Keep left align for readability */ }
        .ai-message { background-color: #e5e7eb; /* Gris claro AI */ color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.3rem;}
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15); }
        #chat-send-btn { padding: 0.7rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #1d4ed8; }
        #chat-send-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Lato';}
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 500; color: var(--color-text); font-size: 1.2rem; font-family: 'Lato'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1rem 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Lato'; font-size: 0.95rem;}
        .error-msg i { margin-right: 0.6rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); background-color: white; /* Fondo blanco por si la imagen es transparente */ }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-balance-scale mr-2"></i> <!-- Icono balanza -->
                     Falacias Argumentativas
                 </h1>
             </div>
             <span class="text-sm text-gray-600">Guía Interactiva de Pensamiento Crítico</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Identifica y Evita Errores Lógicos</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto">Explora las falacias más comunes, comprende su estructura y aprende a construir argumentos más sólidos.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar falacia o concepto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-600 mr-2"></i> <!-- Icono libro -->
                 Índice de Falacias y Conceptos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Cargando índice...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden">No se encontraron coincidencias para tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Conceptos Relacionados
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Analizando argumento...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area"> <!-- Este es el contenedor que necesita scrollTop=0 -->
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                         <p class="text-center text-sm text-gray-500 p-2">¿Tienes dudas sobre esta falacia? Pregúntame.</p>
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Ej: Dame otro ejemplo de esto...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Visualización Conceptual Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Contenido generado por IA como herramienta educativa sobre lógica y argumentación.</p>
              <p class="mt-1">Consulta fuentes académicas para estudios profundos. La IA puede cometer errores.</p>
              <p class="mt-2">© 2025 Guía de Pensamiento Crítico</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Falacias de Relevancia (Atinencia)
            "Argumentum ad Hominem (Ataque Personal)",
            "Ad Hominem Circunstancial",
            "Ad Hominem Tu Quoque ('Y tú también')",
            "Falacia del Hombre de Paja (Straw Man)",
            "Argumentum ad Populum (Apelación a la Mayoría)",
            "Argumentum ad Baculum (Apelación a la Fuerza)",
            "Argumentum ad Misericordiam (Apelación a la Piedad)",
            "Argumentum ad Verecundiam (Apelación a la Autoridad Inapropiada)",
            "Argumentum ad Ignorantiam (Apelación a la Ignorancia)",
            "Falacia de la Pista Falsa (Red Herring)",
            "Ignoratio Elenchi (Conclusión Irrelevante)",
            "Falacia Genética",
            "Apelación a la Tradición (Ad Antiquitatem)",
            "Apelación a la Novedad (Ad Novitatem)",
            "Apelación a la Naturaleza",
            "Apelación a la Riqueza (Argumentum ad Crumenam)",
            "Apelación a la Pobreza (Argumentum ad Lazarum)",
            "Falacia del Francotirador de Texas",
            "Falacia de la Asociación Culpable (Guilt by Association)",
            "Envenenamiento del Pozo (Poisoning the Well)",
            "Falacia del Histrión (Argument from Emotion)", // Variante ad populum
            "Falacia 'Ningún Escocés Verdadero' (No True Scotsman)",
            "Transferencia (Falacia Publicitaria)",
            "Testimonio (Falacia Publicitaria)",
            "Falacia de Estilo sobre Sustancia",

            // Falacias de Inducción Deficiente (Datos Insuficientes)
            "Generalización Precipitada (Hasty Generalization)",
            "Muestra Sesgada",
            "Falacia de Accidente (Dicto Simpliciter)",
            "Falacia Inversa de Accidente",
            "Falsa Causa (Post Hoc Ergo Propter Hoc)",
            "Falsa Causa (Cum Hoc Ergo Propter Hoc / Correlación no implica Causalidad)",
            "Falacia de la Pendiente Resbaladiza (Slippery Slope)",
            "Falsa Analogía",
            "Falacia del Jugador (Gambler's Fallacy)",
            "Falacia de la Mano Caliente (Hot Hand Fallacy)",
            "Supresión de Pruebas (Cherry Picking)",
            "Evidencia Anecdótica",
            "Falacia de Composición",
            "Falacia de División",
            "Falacia Ludica (Ludic Fallacy)",
            "Falacia Pro Hominem (Opuesto a Ad Hominem)",

            // Falacias de Presunción (Suposiciones Injustificadas)
            "Petición de Principio (Petitio Principii / Begging the Question)",
            "Argumento Circular",
            "Pregunta Compleja (Plurium Interrogationum)",
            "Falso Dilema / Falsa Dicotomía",
            "Falacia del Término Medio (Argument to Moderation)",
            "Bifurcación",
            "Falacia de la Continuidad (Falacia del Montón / Sorites)",
            "Falacia Naturalista (Apelar a la Naturaleza)",
            "Falacia Moralista",
            "Wishful Thinking (Pensamiento Ilusorio)",

            // Falacias de Ambigüedad (Lenguaje Impreciso)
            "Equivocación (Equivocation)",
            "Anfibología (Amphiboly)",
            "Falacia del Énfasis (Acento)",
            "Falacia por Asociación de Ideas",
            "Falacia de Reificación (Hipostatización)",
            "Lenguaje Cargado Emocionalmente",
            "Eufemismos y Disfemismos",
            "Jerga Innecesaria (Obscurantismo)",
            "Anfibología Sintáctica",

            // Falacias Formales (Errores en la Estructura Lógica)
            "Afirmación del Consecuente",
            "Negación del Antecedente",
            "Falacia del Cuarto Término (Quaternio Terminorum)",
            "Falacia del Medio No Distribuido",
            "Falacia del Ilícito Mayor",
            "Falacia del Ilícito Menor",
            "Falacia Existencial",
            "Conversión Ilícita",
            "Obversión Ilícita",
            "Contraposición Ilícita",
            "Falacia de Afirmar una Disyunción",
            "Falacia de Negar una Conjunción",
            "Falacia Modales (Error en lógica modal)",
            "Argumento de la Falacia (Ad Logicam)", // Falacia informal sobre una formal

            // Conceptos Relacionados y Principios de Argumentación
            "Pensamiento Crítico: Definición",
            "Argumento Válido vs. Argumento Sólido",
            "Deducción vs. Inducción vs. Abducción",
            "Sesgo Cognitivo: Definición",
            "Sesgo de Confirmación",
            "Sesgo de Anclaje",
            "Heurística de Disponibilidad",
            "Heurística de Representatividad",
            "Efecto Dunning-Kruger",
            "Sesgo de Retrospección (Hindsight Bias)",
            "Sesgo de Status Quo",
            "Aversión a la Pérdida",
            "Error Fundamental de Atribución",
            "Efecto Halo",
            "Pensamiento de Grupo (Groupthink)",
            "Navaja de Ockham (Principio de Parsimonia)",
            "Carga de la Prueba (Onus Probandi)",
            "Principio de Caridad en Argumentación",
            "Refutación vs. Réplica",
            "Contraargumento",
            "Premisas y Conclusión",
            "Indicadores de Premisa y Conclusión",
            "Diagramación de Argumentos",
            "Silogismo Categórico",
            "Silogismo Hipotético",
            "Silogismo Disyuntivo",
            "Modus Ponens",
            "Modus Tollens",
            "Leyes de De Morgan",
            "Reducción al Absurdo (Reductio ad Absurdum)",
            "Retórica: Ethos, Pathos, Logos",
            "Sofisma",
            "Paralogismo",
            "Propaganda y Persuasión",
            "Desinformación y Noticias Falsas (Fake News)",
            "Verificabilidad y Falsabilidad (Popper)",
            "Argumentación Basada en Evidencia",
            // ... (Continuar expandiendo con más sesgos, principios, etc.)
        ];
        const fallacyThemes = [
            "falacias de relevancia", "falacias de inducción deficiente", "falacias de presunción",
            "falacias de ambigüedad", "falacias formales", "errores comunes de razonamiento",
            "sesgos cognitivos", "principios de lógica", "argumentación y debate",
            "pensamiento crítico", "psicología del razonamiento", "retórica y persuasión",
            "falacias en publicidad", "falacias en política", "errores estadísticos comunes"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un experto en lógica, filosofía y pensamiento crítico. Tu tarea es explicar detalladamente la falacia argumentativa, sesgo cognitivo o principio de argumentación indicado. Debes incluir: 1. Definición clara y concisa. 2. Estructura lógica (si aplica, especialmente en falacias formales). 3. Explicación de por qué es un error de razonamiento o una suposición inválida. 4. Varios ejemplos ilustrativos claros y variados (cotidianos, históricos, ficticios). 5. Cómo identificar esta falacia o concepto. 6. Estrategias para evitar cometerla o caer en ella. 7. Posibles relaciones con otras falacias o sesgos. Utiliza un lenguaje académico pero accesible. El objetivo es una explicación exhaustiva de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúa como un tutor de lógica especializado únicamente en el concepto (falacia, sesgo, principio) que se está discutiendo actualmente. Responde preguntas específicas sobre su definición, ejemplos, estructura o cómo evitarlo. Sé conciso, preciso y mantente estrictamente dentro del tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de conceptos para una enciclopedia de pensamiento crítico. Genera exactamente 15 nombres de falacias lógicas (formales o informales), sesgos cognitivos o principios de argumentación relevantes. Devuelve *solo* la lista de nombres/conceptos, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area'); // Wrapper principal
        const modalTextArea = document.getElementById('modal-content-area'); // Contenedor scrollable de texto+imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div para el texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentFallacyTitle = null; // Contexto del chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            // System prompt dinámico para chat
            const systemPromptToUse = isChat && currentFallacyTitle
                ? `Eres un tutor de lógica especializado únicamente en el concepto llamado '${currentFallacyTitle}'. Responde preguntas específicas sobre su definición, ejemplos, estructura o cómo evitarlo. Sé conciso, preciso y mantente estrictamente dentro del tema actual.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, intenta en unos segundos.`);
                }
                let text = await response.text();
                 // *** FILTRAR PUBLICIDAD DE POLLINATIONS ***
                 text = text.replace(/powered by pollinations[\s\S]*/i, '').trim();

                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta de nuevo o reformula la pregunta.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La solicitud tardó demasiado (>${config.timeoutSeconds}s). Por favor, verifica tu conexión e inténtalo de nuevo.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al obtener la información.");
            }
        }

        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentFallacyTitle) throw new Error("Error interno: No se ha establecido el contexto de la falacia para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(fallacyThemes) || "falacias lógicas variadas";
             const specificPrompt = `Genera 15 nombres de falacias, sesgos cognitivos o principios de argumentación sobre ${randomTheme}`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                  .then(text => {
                      const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                      if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de conceptos.");
                      return titles.slice(0, 15);
                  });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 700, height: 500, nologo: true }; // Imagen más pequeña
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "logical fallacy abstract concept";
             // Prompt para imagen conceptual/abstracta
             const enhancedPrompt = `Abstract conceptual visualization representing the logical fallacy or reasoning error '${safePromptText}'. Symbolic, metaphorical, focus on confusion, broken logic, misleading path, illusion. Avoid literal representations, text, diagrams, people. Style: minimalist, surreal, or graphic illustration.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Negative prompt fuerte contra elementos literales
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, graphs, charts, diagrams, realistic people arguing, specific symbols with clear meaning, simple illustration, photograph, clear narrative";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, ' '); // Reemplaza saltos internos con espacio
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            // *** ASEGURAR RESET SCROLL DEL CONTENEDOR CORRECTO ***
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal (target: modalTextArea)");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '<p class="text-center text-sm text-gray-500 p-2">¿Tienes dudas sobre esta falacia? Pregúntame.</p>'; // Reset with prompt
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentFallacyTitle = null; // Limpia contexto
             // Reset Fullscreen Image
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden'; }
        function hideFullscreenImage() { /* ... */ if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src=''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios funcionales)
        function addChatMessage(message, sender) { /* ... */ const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errDiv=document.createElement('div');errDiv.classList.add('chat-error');errDiv.textContent=message;chatHistory.appendChild(errDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */
            const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;
            // Clear initial prompt if it's still there
            const initialPrompt = chatHistory.querySelector('p.text-gray-500');
            if (initialPrompt) initialPrompt.remove();

            addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';
            try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}
            catch(error){console.error("Chat Error:",error);addChatError(`Error IA: ${error.message}`);}
            finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}
         }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title) {
             const div = document.createElement('div');
             div.className = 'title-item';
             // Añadir un icono genérico o basado en categoría (simplificado aquí)
             const icon = document.createElement('i');
             icon.className = 'fas fa-lightbulb fa-fw'; // Icono genérico
             div.appendChild(icon);
             const textSpan = document.createElement('span');
             textSpan.textContent = title;
             div.appendChild(textSpan);
             div.setAttribute('data-title', title);
             div.addEventListener('click', () => handleTitleClick(title));
             return div;
         }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' })); // Sort Spanish
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay falacias o conceptos disponibles.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
            if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
        }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentFallacyTitle = title; // Set chat context
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title); // fetchTextFromApi already filters ad
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                 // *** ASEGURAR SCROLL RESET EN EL CONTENEDOR CORRECTO ***
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible (target: modalTextArea)");

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-project-diagram placeholder-icon"></i> <!-- Icono diagrama/abstracto -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo generar la visualización.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append image to the text content div
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al crear URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Ocurrió un error inesperado al cargar la explicación.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = ''; // Clear partial content
                chatSection.classList.add('content-hidden'); // Hide chat on main error
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más conceptos...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más conceptos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar conceptos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Conceptos Relacionados';
             }
         }

         // Search Filter Function (with Spanish normalization)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check essential elements
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalTextArea) { // Added modalTextArea check
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Faltan componentes esenciales de la interfaz.</p>';
                return;
             }
            // Setup listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>