<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senderos del Sijismo - Gu√≠a Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Limpias y Respetuosas -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para el Sijismo --- */
        :root {
            --color-primary: #FF9933; /* Kesari/Saffron */
            --color-secondary: #005BBB; /* Nishan Sahib Blue */
            --color-tertiary: #FDBB30; /* Golden (Accent) */
            --color-background: #fdfbf7; /* Blanco Hueso/Crema muy claro */
            --color-text: #3a3a3a; /* Gris Oscuro */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco puro modal */
            --color-border: #e5e7eb; /* Borde gris claro */
            --color-error-bg: #fff1f2; /* Fondo error rosa claro */
            --color-error-text: #be123c; /* Texto error rojo oscuro */
            --color-error-border: #fecdd3; /* Borde error rosa */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -2px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.08);
            --border-radius: 5px; /* Bordes suaves */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Noto Sans', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        .logo .fa-khanda { color: var(--color-secondary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-secondary); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Search Bar */
        #search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(255, 153, 51, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 500; color: var(--color-text); border: 1px solid var(--color-border); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 75px; font-family: 'Roboto'; font-size: 0.95rem; line-height: 1.4; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-border); border-left-color: var(--color-primary); color: var(--color-secondary); background-color: #fffaf0; /* Saffron muy claro */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        #generate-more-btn:hover:not(:disabled) { background-color: #e68a00; box-shadow: var(--shadow-md); transform: translateY(-1px); }
        #generate-more-btn:disabled { background-color: #fdba74; color: #fff; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { /* Mismos estilos generales */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(58, 58, 58, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem 2rem; max-width: 950px; width: 95%; max-height: 90vh; min-height: 400px; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; border-top: 5px solid var(--color-primary); }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #f3f4f6; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Loading Overlay - Now contains the game */
        #modal-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); display: none; /* Hidden by default, shown via JS */ flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); text-align: center; padding: 2rem; }
        #modal-loading.active { display: flex; } /* Show when loading */
        /* Default Loading Spinner (Hidden when game is active) */
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading-text { font-weight: 500; color: var(--color-text); font-size: 1.3rem; font-family: 'Roboto'; margin-top: 1rem; }
        /* Mini-Game Styles */
        #loading-game-area { display: none; /* Hidden until activated */ flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        #game-title { font-size: 1.4rem; font-weight: 700; color: var(--color-secondary); margin-bottom: 1rem; font-family: 'Roboto'; }
        #game-instructions { font-size: 0.95rem; color: var(--color-text-muted); margin-bottom: 1.5rem; }
        #game-clickable-object { font-size: 5rem; color: var(--color-primary); cursor: pointer; transition: transform 0.1s ease, color 0.1s ease; margin-bottom: 1.5rem; }
        #game-clickable-object:hover { color: var(--color-secondary); }
        #game-clickable-object:active { transform: scale(1.15); }
        #game-score-display { font-size: 1.8rem; font-weight: 700; color: var(--color-text); font-family: 'Roboto'; }
        #game-score-label { font-size: 1rem; color: var(--color-text-muted); margin-top: -5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Main Content Area (Scrollable Text + Fixed Chat) */
        #modal-story-content-area { /* Wrapper for text and chat */ flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; /* No scroll here */ }
        #modal-content-area { /* Scrollable text/image area */ flex-grow: 1; min-height: 0; /* Crucial for flexbox scroll */ overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; line-height: 1.75; font-size: 1.05rem; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 700; }
        #modal-content em { color: var(--color-primary); font-style: italic; font-weight: 500;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto', sans-serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.45em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.18em; color: var(--color-primary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Image Styles */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(209, 213, 219, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; /* Slightly reduced height */ background-color: #f9fafb; /* Light gray background */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fff; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.55; font-size: 0.95rem;}
        .user-message { background-color: var(--color-secondary); color: #fff; margin-left: auto; text-align: left; }
        .ai-message { background-color: #e5e7eb; color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; margin: 0.5rem 0; }
        #chat-input-area { display: flex; gap: 0.5rem; padding: 0 0.5rem 0.5rem 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Noto Sans'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(255, 153, 51, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #e68a00; }
        #chat-send-btn:disabled { background-color: #fdba74; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Noto Sans'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { /* Mismos estilos generales */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); background-color: white; }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); box-shadow: var(--shadow-sm); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-modal-bg); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl flex items-center">
                     <i class="fas fa-khanda mr-3 text-2xl sm:text-3xl"></i> <!-- Khanda Icon -->
                     Senderos del Sijismo
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">Gu√≠a Interactiva de Fe y Cultura</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora la Riqueza del Sijismo</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre la historia, las ense√±anzas de los Gurus, las pr√°cticas espirituales y la vibrante cultura Sij.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto relative">
             <input type="text" id="search-input" placeholder="Buscar tema, Gur√∫, concepto...">
             <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-primary mr-2"></i> <!-- Icono libro -->
                 Temas de Estudio
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando ense√±anzas...</p>
                  <!-- .title-item se a√±adir√°n aqu√≠ -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No se encontraron temas para tu b√∫squeda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar M√°s Temas (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Overlay with Game -->
             <div id="modal-loading">
                 <!-- Default Spinner (hidden when game active) -->
                 <div id="default-spinner-area">
                     <div class="loading-spinner-modal"></div>
                     <p id="modal-loading-text">Cargando datos...</p>
                 </div>
                 <!-- Mini Game Area (hidden by default) -->
                 <div id="loading-game-area">
                     <h3 id="game-title">Mientras Esperas... ¬°Juega!</h3>
                     <p id="game-instructions">Haz clic en el Khanda lo m√°s r√°pido posible.</p>
                     <div id="game-clickable-object" title="¬°Clic aqu√≠!">
                         <i class="fas fa-khanda"></i>
                     </div>
                     <div id="game-score-display">0</div>
                     <div id="game-score-label">Puntos</div>
                 </div>
             </div>

             <!-- Content Area Wrapper (Text + Chat) -->
             <div id="modal-story-content-area" class="content-hidden">
                 <!-- Scrollable Text/Image Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder added via JS -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando archivos...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este tema...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Contenido generado por IA con fines educativos e informativos sobre el Sijismo.</p>
              <p class="mt-1">Para estudios profundos, consulta fuentes acad√©micas y comunitarias Sijs.</p>
              <p class="mt-2">Waheguru Ji Ka Khalsa, Waheguru Ji Ki Fateh.</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Core Concepts & Beliefs
            "Ik Onkar: El Concepto de Un Creador", "Los Tres Pilares del Sijismo: Naam Japo, Kirat Karni, Vand Chakko", "Naam Japo: La Meditaci√≥n en el Nombre Divino", "Kirat Karni: Ganarse la Vida Honestamente", "Vand Chakko: Compartir con los Dem√°s", "Seva: El Servicio Desinteresado", "Langar: La Cocina Comunitaria y la Igualdad", "Sangat: La Congregaci√≥n Sagrada", "Panth: La Comunidad Sij Global", "Gurmat: La Sabidur√≠a del Gur√∫", "Hukam: La Voluntad Divina", "Karma y Reencarnaci√≥n en el Sijismo", "Mukti: La Liberaci√≥n Espiritual", "Maya: La Ilusi√≥n del Mundo Material", "Haumai: El Ego y su Superaci√≥n", "Los Cinco Kakaars (5 Ks): Kesh, Kangha, Kara, Kirpan, Kachera", "Kesh: El Cabello sin Cortar", "Kangha: El Peine de Madera", "Kara: El Brazalete de Acero", "Kirpan: La Daga Ceremonial (S√≠mbolo de Justicia)", "Kachera: La Ropa Interior de Algod√≥n", "El Concepto de Miri y Piri (Temporal y Espiritual)", "Las Cinco Virtudes: Sat, Santokh, Daya, Nimrata, Pyar", "Los Cinco Vicios: Kaam, Krodh, Lobh, Moh, Ahankar", "El Rol del Gur√∫ en el Sijismo", "La Importancia de la Gracia (Nadar/Kirpa)",
            // Guru Nanak Dev Ji (1st Guru)
            "Vida y Ense√±anzas de Guru Nanak Dev Ji", "Los Viajes (Udasis) de Guru Nanak Dev Ji", "Sakhi: Guru Nanak y el Hilo Sagrado (Janeu)", "Sakhi: Guru Nanak y las Dos Hogazas de Pan (Bhai Lalo y Malik Bhago)", "Sakhi: Guru Nanak detiene la Roca (Panja Sahib)", "Sakhi: Guru Nanak y el Agua hacia el Oeste (Haridwar)", "Fundaci√≥n de Kartarpur por Guru Nanak Dev Ji", "Japji Sahib: La Oraci√≥n Matutina Compuesta por Guru Nanak", "Guru Nanak sobre la Igualdad Social y de G√©nero", "El Concepto de Shabad Guru (El Gur√∫ es la Palabra)", "Nombramiento de Bhai Lehna como Guru Angad Dev Ji",
            // Guru Angad Dev Ji (2nd Guru)
            "Vida y Contribuciones de Guru Angad Dev Ji", "Estandarizaci√≥n de la Escritura Gurmukhi", "Promoci√≥n de la Educaci√≥n y Alfabetizaci√≥n", "Establecimiento de Centros de Aprendizaje (Mal Akhara)", "Continuaci√≥n y Expansi√≥n del Langar", "Recopilaci√≥n de los Himnos de Guru Nanak", "√ânfasis en la Humildad y la Obediencia al Gur√∫",
            // Guru Amar Das Ji (3rd Guru)
            "Vida y Legado de Guru Amar Das Ji", "Establecimiento del Centro Sij en Goindwal Sahib", "Construcci√≥n del Baoli Sahib (Pozo Escalonado) en Goindwal", "Institucionalizaci√≥n del Langar (Manji System)", "Anand Sahib: El Himno de la Dicha", "Reforma Social: Lucha contra el Sati y el Sistema de Castas", "Empoderamiento de las Mujeres en la Comunidad Sij", "Nombramiento de las Primeras Predicadoras (Manjis)",
            // Guru Ram Das Ji (4th Guru)
            "Vida y Obra de Guru Ram Das Ji", "Fundaci√≥n de Ramdaspur (Actual Amritsar)", "Construcci√≥n del Sarovar Sagrado (Amritsar)", "Composici√≥n del Laavaan (Himnos Nupciales Sijs)", "√ânfasis en el Amor Devocional (Bhakti)", "Organizaci√≥n de la Recaudaci√≥n de Fondos (Masand System)", "Consolidaci√≥n de la Comunidad Sij",
            // Guru Arjan Dev Ji (5th Guru)
            "Vida, Martirio y Contribuciones de Guru Arjan Dev Ji", "Compilaci√≥n del Adi Granth (Primer Volumen del Guru Granth Sahib)", "Construcci√≥n del Harmandir Sahib (Templo Dorado)", "Establecimiento de Tarn Taran Sahib", "Sukhmani Sahib: El Salmo de la Paz", "Organizaci√≥n Econ√≥mica de la Comunidad Sij", "Primer M√°rtir Sij: Causas y Consecuencias", "Impacto del Martirio de Guru Arjan Dev Ji",
            // Guru Hargobind Ji (6th Guru)
            "Vida y Liderazgo de Guru Hargobind Ji", "El Concepto de Miri y Piri en la Pr√°ctica", "Construcci√≥n del Akal Takht (Trono del Eterno)", "Levantamiento del Primer Ej√©rcito Sij", "Uso de Dos Espadas (Miri y Piri)", "Encarcelamiento en Gwalior y Liberaci√≥n (Bandi Chhor Divas)", "Batallas Defensivas de Guru Hargobind Ji", "Transformaci√≥n de la Comunidad Sij (Santos-Soldados)",
            // Guru Har Rai Ji (7th Guru)
            "Vida y Ministerio Pac√≠fico de Guru Har Rai Ji", "Mantenimiento del Ej√©rcito Sij pero Evitando Conflictos", "Establecimiento de un Hospital y Centro de Medicina Herbal", "√ânfasis en la Compasi√≥n y el Cuidado del Medio Ambiente", "Incidente con Dara Shikoh y Aurangzeb", "Defensa de la Integridad del Gurbani",
            // Guru Har Krishan Ji (8th Guru)
            "Vida Breve y Servicio de Guru Har Krishan Ji (El Ni√±o Gur√∫)", "Ministerio en Delhi durante una Epidemia", "Curaci√≥n de los Enfermos y Servicio a los Necesitados", "Su Papel como Fuente de Consuelo Espiritual", "Designaci√≥n de 'Baba Bakale' como Sucesor", "Significado de su Corto Liderazgo",
            // Guru Tegh Bahadur Ji (9th Guru)
            "Vida, Viajes y Martirio de Guru Tegh Bahadur Ji", "Defensa de la Libertad Religiosa (Hind√∫es de Cachemira)", "Himnos sobre la Impermanencia y el Desapego (Vairagya)", "Fundaci√≥n de Anandpur Sahib", "Martirio en Delhi por Orden de Aurangzeb", "Hind Di Chadar (El Escudo de la India)", "Impacto de su Sacrificio en la Historia Sij",
            // Guru Gobind Singh Ji (10th Guru)
            "Vida, Liderazgo y Legado de Guru Gobind Singh Ji", "Creaci√≥n de la Khalsa en Vaisakhi de 1699", "Instituci√≥n de los Cinco Kakaars (5 Ks)", "Amrit Sanchar: La Ceremonia de Iniciaci√≥n Sij", "Los Cuatro Sahibzade (Hijos del Gur√∫) y su Martirio", "Batallas de Anandpur Sahib", "Evacuaci√≥n de Anandpur y Separaci√≥n de la Familia", "La Batalla de Chamkaur", "Zafarnama: La Ep√≠stola de la Victoria a Aurangzeb", "Composici√≥n de Dasam Granth (Debatido)", "Declaraci√≥n del Guru Granth Sahib como Gur√∫ Eterno", "Jaap Sahib y Otras Composiciones",
            // Guru Granth Sahib Ji (Gur√∫ Eterno)
            "El Guru Granth Sahib: El Gur√∫ Viviente de los Sijs", "Estructura y Contenido del Guru Granth Sahib", "Idiomas y Escrituras en el Guru Granth Sahib", "Compilaci√≥n Final por Guru Gobind Singh Ji", "El Proceso de Instalaci√≥n (Prakash) y Descanso (Sukhasan)", "Maryada: El C√≥digo de Conducta y Respeto hacia el Guru Granth Sahib", "El Rol Central del Gurbani Kirtan", "Principales Banis (Composiciones): Japji Sahib, Anand Sahib, Rehras Sahib, Kirtan Sohila", "Contribuciones de Bhagats (Santos) de Otras Tradiciones en el Gurbani", "El Mensaje Universal del Guru Granth Sahib", "Interpretaci√≥n (Katha) del Gurbani", "Traducciones del Guru Granth Sahib",
            // Historia Sij Post-Gurus
            "Banda Singh Bahadur: Liderazgo Militar y Reformas Agrarias", "El Per√≠odo de Persecuci√≥n y Resiliencia Sij (Siglo XVIII)", "Los Misls: Confederaciones Sijs", "El Imperio Sij bajo Maharaja Ranjit Singh", "Administraci√≥n y Ej√©rcito del Imperio Sij", "Las Guerras Anglo-Sijs: Causas y Resultados", "Anexi√≥n del Punjab por los Brit√°nicos", "El Movimiento Singh Sabha: Renacimiento y Reforma Sij", "El Movimiento Gurdwara Reform (Akali Movement)", "Masacre de Jallianwala Bagh y su Impacto", "El Papel de los Sijs en la Lucha por la Independencia de la India", "La Partici√≥n de la India (1947) y su Impacto Devastador en los Sijs", "El Reclamo de un Estado Punjabi Suba", "El Movimiento Khalistan: Or√≠genes, Desarrollo y Controversias (Visi√≥n Hist√≥rica)", "La Operaci√≥n Blue Star (1984)", "Los Disturbios Anti-Sijs de 1984", "La Di√°spora Sij: Migraci√≥n y Establecimiento Global", "Contribuciones de los Sijs en el Mundo", "Desaf√≠os Contempor√°neos para la Comunidad Sij",
            // Gurdwaras Importantes
            "El Significado y Prop√≥sito de un Gurdwara", "Harmandir Sahib (Templo Dorado): Historia y Arquitectura", "El Akal Takht: El M√°ximo Asiento de Autoridad Temporal", "Los Cinco Takhts (Asientos de Autoridad): Akal Takht, Keshgarh Sahib, Damdama Sahib, Patna Sahib, Hazur Sahib", "Gurdwara Janam Asthan, Nankana Sahib (Lugar de Nacimiento de Guru Nanak)", "Gurdwara Panja Sahib, Hasan Abdal", "Gurdwara Bangla Sahib, Delhi", "Gurdwara Sis Ganj Sahib, Delhi (Martirio de Guru Tegh Bahadur)", "Gurdwara Rakab Ganj Sahib, Delhi (Cremaci√≥n de Guru Tegh Bahadur)", "Gurdwara Keshgarh Sahib, Anandpur Sahib (Nacimiento de la Khalsa)", "Gurdwara Damdama Sahib, Talwandi Sabo (Compilaci√≥n Final del GGS)", "Gurdwara Patna Sahib (Lugar de Nacimiento de Guru Gobind Singh)", "Gurdwara Hazur Sahib, Nanded (Lugar donde Guru Gobind Singh dej√≥ su cuerpo f√≠sico)", "Gurdwara Goindwal Sahib (Baoli Sahib)", "Gurdwara Tarn Taran Sahib", "Gurdwaras Hist√≥ricos relacionados con los Gurus", "Arquitectura T√≠pica de un Gurdwara (Nishan Sahib, C√∫pulas)", "Etiqueta y Protocolo al Visitar un Gurdwara",
            // Cultura y Pr√°cticas Sijs
            "El Ciclo de Vida Sij: Ceremonias de Nacimiento, Matrimonio (Anand Karaj), Muerte", "Anand Karaj: La Ceremonia de Matrimonio Sij", "Antam Sanskar: Los Ritos Funerarios Sijs", "Principales Festivales Sijs: Vaisakhi, Gurpurabs, Bandi Chhor Divas (Diwali)", "Vaisakhi: Celebraci√≥n de la Cosecha y el Nacimiento de la Khalsa", "Gurpurabs: Celebraci√≥n de los Aniversarios de los Gurus", "Hola Mohalla: Festival Marcial Sij en Anandpur Sahib", "Kirtan: El Canto Devocional de Himnos del Gurbani", "Instrumentos Musicales en el Kirtan (Harmonium, Tabla, Rabab)", "Raags en el Gurbani Kirtan", "Ardas: La Oraci√≥n Congregacional Sij", "Hukamnama: La Orden del D√≠a del Guru Granth Sahib", "El Significado del Turbante (Dastar) para los Hombres y Mujeres Sijs", "Estilos de Turbantes Sijs", "El Papel de la Mujer en el Sijismo: Igualdad y Empoderamiento", "Mai Bhago: La Guerrera Sij", "Mata Khivi: Pionera del Langar", "Gatka: El Arte Marcial Sij", "Arte y Arquitectura Sij", "El Idioma Punjabi y la Escritura Gurmukhi", "Valores Sijs en la Vida Diaria", "√âtica Ambiental en el Sijismo", "El Sijismo y el Di√°logo Interreligioso",
            // Sakhis (Historias Ilustrativas) Populares
            "Sakhi: Bhai Kanhaiya y el Servicio Imparcial en la Batalla", "Sakhi: Guru Hargobind y los 52 Reyes", "Sakhi: El Gorri√≥n y el Halc√≥n (Guru Gobind Singh)", "Sakhi: Mata Gujri y los Sahibzade Menores en la Torre Fr√≠a (Thanda Burj)", "Sakhi: El Sacrificio de Bhai Mani Singh", "Sakhi: El Martirio de Bhai Taru Singh", "Sakhi: La Devoci√≥n de Bhai Mardana", "Sakhi: Guru Amar Das y el Emperador Akbar", "Sakhi: La Prueba de Obediencia de Bhai Lehna (Guru Angad)", "Sakhi: La Humildad de Guru Ram Das", "Sakhi: La Composici√≥n del Anand Sahib (Guru Amar Das)", "Sakhi: El Encuentro de Guru Nanak con los Siddhas", "Sakhi: Guru Tegh Bahadur y Bhai Mati Das, Sati Das, Dayal Das", "Sakhi: El Caballo Azul de Guru Gobind Singh (Neela Ghora)", "Sakhi: La Creaci√≥n del Panj Pyare",
            // Conceptos Filos√≥ficos Adicionales
            "Dasvandh: La Contribuci√≥n del Diezmo", "Charhdi Kala: El Esp√≠ritu Optimista y Resiliente", "Sarbat da Bhala: El Bienestar para Todos", "Sewa Sambhal: Servicio y Meditaci√≥n Combinados", "Sach Khand: El Reino de la Verdad", "Gurmukh vs Manmukh: Orientado al Gur√∫ vs Orientado al Ego", "Sharan: Refugio en el Gur√∫", "Bhana: Aceptaci√≥n de la Voluntad Divina", "Simran: La Pr√°ctica de la Remembranza Continua", "Gyan: El Conocimiento Espiritual", "Dharam: El Camino de la Rectitud", "Santsipahi: El Concepto del Santo-Soldado", "La Visi√≥n Sij del Universo y la Creaci√≥n", "El Sijismo frente a Otras Religiones: Similitudes y Diferencias", "El Concepto de Santidad en el Sijismo",
            // Figuras Importantes (Adem√°s de los Gurus)
            "Bhai Mardana: Compa√±ero M√∫sico de Guru Nanak", "Bhai Lalo: El Carpintero Humilde", "Malik Bhago: El Oficial Rico", "Bhai Gurdas: Escriba y Erudito Sij", "Mata Khivi: Esposa de Guru Angad, Administradora del Langar", "Bhai Bidhi Chand: El Recuperador de Caballos", "Bhai Mani Singh: M√°rtir y Erudito", "Bhai Taru Singh: M√°rtir que Sacrific√≥ su Cuero Cabelludo", "Mai Bhago: La Guerrera que Lider√≥ a los 40 Liberados", "Nawab Kapur Singh: L√≠der del Dal Khalsa", "Jassa Singh Ahluwalia: L√≠der del Misl Ahluwalia", "Maharaja Ranjit Singh: Fundador del Imperio Sij", "Akali Phula Singh: L√≠der Nihang y General", "Hari Singh Nalwa: General Renombrado de Ranjit Singh", "Rani Jindan: Regente del Imperio Sij", "Bhagat Puran Singh: Humanitario y Fundador de Pingalwara", "Bhai Vir Singh: Figura Clave del Movimiento Singh Sabha", "Profesor Puran Singh: Poeta y Cient√≠fico", "Kartar Singh Sarabha: Revolucionario Ghadarita", "Udham Singh: Vengador de la Masacre de Jallianwala Bagh",
            // Temas Modernos y Di√°spora
            "Identidad Sij en el Siglo XXI", "El Sijismo y la Tecnolog√≠a Moderna", "J√≥venes Sijs en la Di√°spora: Desaf√≠os y Oportunidades", "Representaci√≥n Sij en los Medios", "Cr√≠menes de Odio contra Sijs Post-9/11", "Organizaciones Sijs Internacionales (WSO, UNITED SIKHS, etc.)", "El Papel de los Gurdwaras en la Di√°spora", "Preservaci√≥n del Idioma Punjabi en el Extranjero", "Matrimonios Interreligiosos en la Comunidad Sij", "Sijs en la Pol√≠tica Mundial", "Activismo Social y Humanitario Sij (Khalsa Aid)", "El Debate sobre el Dasam Granth", "Interpretaciones Modernas del Gurbani", "El Sijismo y los Derechos Humanos", "Ecolog√≠a y Sijismo: El Legado Verde de los Gurus", "Salud y Bienestar desde la Perspectiva Sij"
        ];
        const sikhismThemes = [
            "Guru Nanak Dev Ji", "Guru Gobind Singh Ji", "Guru Granth Sahib", "Harmandir Sahib", "Khalsa", "5 Ks", "Seva", "Langar", "Sakhis de los Gurus", "Historia del Imperio Sij", "Partici√≥n de 1947", "Vaisakhi", "Filosof√≠a Sij", "Gurdwaras importantes", "M√°rtires Sijs", "Mujeres en el Sijismo", "Di√°spora Sij", "Kirtan", "Ardas", "Hukamnama", "Miri Piri", "Creencias fundamentales Sijs", "Movimiento Singh Sabha", "Maharaja Ranjit Singh", "Banda Singh Bahadur", "Conceptos como Hukam, Karma, Mukti"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un erudito respetuoso y conocedor del Sijismo, experto en su historia, teolog√≠a, escrituras (Guru Granth Sahib) y pr√°cticas culturales. Tu tarea es explicar el tema, concepto, figura hist√≥rica o Sakhi (historia) Sij indicada de manera clara, precisa, detallada y respetuosa. Proporciona contexto hist√≥rico y teol√≥gico seg√∫n sea necesario. Cita Gurbani (si es relevante y puedes hacerlo con precisi√≥n conceptual, sin intentar generar la escritura exacta). Aseg√∫rate de que la informaci√≥n sea equilibrada y refleje las perspectivas com√∫nmente aceptadas dentro del Panth. Evita opiniones personales o interpretaciones controvertidas no fundamentadas. El objetivo es una exposici√≥n informativa y educativa de aproximadamente 1200-1300 palabras. Basa tu explicaci√≥n √∫nicamente en el siguiente tema Sij:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Act√∫a como un asistente virtual conocedor y respetuoso del Sijismo. Responde preguntas de seguimiento sobre el tema espec√≠fico (Gur√∫, concepto, historia, lugar) que se est√° mostrando actualmente. Basa tus respuestas en la informaci√≥n principal proporcionada y en el conocimiento general aceptado del Sijismo. S√© conciso, claro y mant√©n un tono respetuoso. C√©ntrate √∫nicamente en el tema en discusi√≥n.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Act√∫a como un generador de ideas conciso para una gu√≠a sobre Sijismo. Genera exactamente 40 t√≠tulos de temas, conceptos, figuras hist√≥ricas, lugares sagrados o Sakhis (historias) relevantes para el estudio del Sijismo. Var√≠a los tipos de t√≠tulos (conceptos, personas, lugares, eventos, preguntas). Devuelve *solo* la lista de t√≠tulos, uno por l√≠nea. No incluyas n√∫meros, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentado ligeramente para 40 t√≠tulos
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        // Loading & Game Elements
        const modalLoadingOverlay = document.getElementById('modal-loading');
        const defaultSpinnerArea = document.getElementById('default-spinner-area');
        const loadingGameArea = document.getElementById('loading-game-area');
        const gameClickableObject = document.getElementById('game-clickable-object');
        const gameScoreDisplay = document.getElementById('game-score-display');
        // Main Content Elements
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentSikhismTopic = null; // Chat context
        let gameScore = 0;
        let isGameActive = false;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentSikhismTopic
                 ? `Eres un asistente virtual conocedor y respetuoso del Sijismo. Responde preguntas de seguimiento sobre el tema espec√≠fico '${currentSikhismTopic}'. Basa tus respuestas en la informaci√≥n principal proporcionada y en el conocimiento general aceptado del Sijismo. S√© conciso, claro y mant√©n un tono respetuoso.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     // *** USER-FRIENDLY ERROR ***
                     throw new Error(`(Error ${response.status}) Nuestros servidores parecen estar ocupados en este momento. Por favor, int√©ntalo de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA lleg√≥ vac√≠a. Intenta reformular tu consulta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     // *** USER-FRIENDLY ERROR ***
                     throw new Error(`La conexi√≥n tard√≥ demasiado (>${config.timeoutSeconds}s). Revisa tu conexi√≥n o int√©ntalo m√°s tarde.`);
                 }
                 throw new Error(error.message || "Ocurri√≥ un error inesperado contactando la IA. Por favor, intenta m√°s tarde.");
             }
        }
        async function fetchExplanationText(topicTitle) {
            return fetchTextFromApi(topicTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentSikhismTopic) throw new Error("Error interno: Contexto del tema no establecido para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(sikhismThemes) || "conceptos generales del Sijismo";
            // *** UPDATED PROMPT FOR 40 TITLES ***
            const specificPrompt = `Genera 40 t√≠tulos variados (conceptos, figuras, lugares, sakhis, preguntas) sobre ${randomTheme} en el Sijismo.`;
            console.log("Generating 40 titles with prompt:", specificPrompt);
            // Use the generic fetchTextFromApi function
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n')
                                       .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                       .filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 20) { // Expecting more now
                         throw new Error("La IA no gener√≥ suficientes ideas de temas.");
                     }
                     return titles.slice(0, 40); // Return up to 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Sikhism related art";
             // Prompt more focused on symbolism, art, Gurdwaras, nature, community - less on specific figures unless requested
             const enhancedPrompt = `Artwork inspired by Sikhism concept: '${safePromptText}'. Focus on symbolism (Khanda, Ik Onkar abstractly), Gurdwaras architecture, community (Sangat, Langar conceptually), nature connection, devotion. Use warm colors (saffron, gold) and blues. Avoid realistic portraits unless the prompt *is* a specific Guru/figure. Serene, respectful, illuminated style. No text, labels.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, photograph, realistic close-up face, disrespectful imagery, caricature";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (Unchanged)
        function formatExplanationText(rawText) { /* ... (same as previous version) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-‚àí]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('‚àí', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== LOADING MINI-GAME FUNCTIONS ==========
        function startGame() {
            if (!loadingGameArea || !defaultSpinnerArea || !modalLoadingOverlay) return;
            gameScore = 0;
            gameScoreDisplay.textContent = gameScore;
            defaultSpinnerArea.style.display = 'none'; // Hide spinner
            loadingGameArea.style.display = 'flex'; // Show game
            isGameActive = true;
            console.log("Loading game started");
        }
        function stopGame() {
            if (!loadingGameArea || !defaultSpinnerArea || !modalLoadingOverlay) return;
            isGameActive = false;
            loadingGameArea.style.display = 'none'; // Hide game
            defaultSpinnerArea.style.display = 'flex'; // Show spinner again (or will be hidden by modal content)
            modalLoadingOverlay.classList.remove('active'); // Hide the whole overlay
            console.log("Loading game stopped");
        }
        function handleGameClick() {
            if (!isGameActive) return;
            gameScore++;
            gameScoreDisplay.textContent = gameScore;
            // Optional: Add visual feedback beyond :active CSS if desired
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            resetModalState();
            // Ensure game is stopped if modal is closed prematurely
            if (isGameActive) {
                stopGame();
            }
        }
        function resetModalState() {
             // Don't show spinner yet, handleGameClick will manage loading display
             modalLoadingOverlay.classList.remove('active');
             loadingGameArea.style.display = 'none';
             defaultSpinnerArea.style.display = 'flex'; // Reset to default
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentSikhismTopic = null;
             hideFullscreenImage();
             isGameActive = false; // Ensure game state is reset
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Unchanged)
        function showFullscreenImage(imgSrc) { /* ... */
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() { /* ... */
             if (!imageFullscreenOverlay) return;
             imageFullscreenOverlay.classList.remove('active');
             // Only unlock body scroll if the main modal is *also* closed
             if (!storyModal.classList.contains('active')) {
                  document.body.style.overflow = '';
             }
             fullscreenImage.src = '';
         }

        // ========== CHAT FUNCTIONS ========== (Unchanged logic)
        function addChatMessage(message, sender) { /* ... */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        async function handleSendMessage() { /* ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                 // Use friendly error from fetch function
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
         }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Sort alphabetically for consistency
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">No hay temas disponibles actualmente.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Appended ${addedCount} new titles.`);
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick to integrate loading game ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalLoadingOverlay.classList.add('active'); // Show loading overlay
            startGame(); // Activate the game within the overlay

            modalTitle.textContent = title;
            currentSikhismTopic = title;
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // Content is ready, stop game and show content
                stopGame(); // This also hides the loading overlay
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Add image placeholder and load image (inside modalContent)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Cargando imagen...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualizaci√≥n conceptual de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => {
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al cargar imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                    placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo generar URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                stopGame(); // Stop game even on error
                 // Use friendly error message
                modalErrorMessage.textContent = error.message || "Ocurri√≥ un error inesperado al cargar la informaci√≥n.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = ''; // Clear partial content
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 titles ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando m√°s temas...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar m√°s temas en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                  // Use friendly error message
                 alert(`Error al generar temas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Update button text reflecting it asks for 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar M√°s Temas (40)';
             }
         }

         // *** Search Filter Function (Unchanged logic, uses normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check essential elements
             const essentialElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, modalLoadingOverlay, loadingGameArea, gameClickableObject];
             if (essentialElements.some(el => !el)) {
                console.error("Initialization failed: Missing essential UI elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Cr√≠tico: Fallo al cargar componentes de la interfaz. Recarga la p√°gina.</p>';
                return;
             }

            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            // Game Listener
            gameClickableObject.addEventListener('click', handleGameClick);

            // Initial Display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            console.log("Sikhism Interactive Guide Initialized.");
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>