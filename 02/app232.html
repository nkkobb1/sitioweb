<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historias del Islam - Relatos y Enseñanzas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Elegantes y Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Historias del Islam --- */
        :root {
            --color-primary: #005f73; /* Azul Petróleo Profundo */
            --color-secondary: #e9d8a6; /* Dorado Arena Pálido */
            --color-tertiary: #0a9396; /* Verde Azulado Vibrante */
            --color-background: #f8f9fa; /* Blanco Roto / Crema muy claro */
            --color-text: #343a40; /* Gris Oscuro Casi Negro */
            --color-text-muted: #6c757d; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro Modal */
            --color-border: #dee2e6; /* Borde Gris Claro */
            --color-error-bg: #fff3cd; /* Fondo error amarillo claro */
            --color-error-text: #856404; /* Texto error oscuro */
            --color-error-border: #ffeeba; /* Borde error amarillo */

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.06);
            --border-radius: 5px; /* Bordes suaves */
            --transition-normal: all 0.25s ease-in-out;
        }
        /* Sutil patrón de fondo opcional */
        /* body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url('data:image/svg+xml,...'); opacity: 0.03; z-index: -1; } */

        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700;}
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: white; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 95, 115, 0.15); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Lato'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-tertiary); color: var(--color-primary); background-color: #f1fcfc; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #00495a; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: #adb5bd; color: #e9ecef; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(52, 58, 64, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* More height needed for chat + content */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e9ecef; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Area Contenido Principal (Texto + Imagen al final) + Chat */
        #modal-story-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; /* Hide outer scroll */ }
        #modal-content-area { flex-grow: 1; min-height: 0; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-family: 'Merriweather', serif; font-weight: 400; color: #495057; } /* Slightly darker text */
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700;}
        #modal-content h1 { font-size: 1.4em; } #modal-content h2 { font-size: 1.3em; } #modal-content h3 { font-size: 1.15em; color: var(--color-tertiary); } #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-tertiary); }

        /* Chat Section */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: auto; /* Push to bottom */ flex-shrink: 0; display: flex; flex-direction: column; max-height: 230px; /* Slightly less height */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f8f9fa; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; } #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); } #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-family: 'Lato', sans-serif; font-size: 0.95rem; }
        .user-message { background-color: var(--color-secondary); color: #5e4f2a; /* Darker text for contrast */ margin-left: auto; text-align: left; font-weight: 400;}
        .ai-message { background-color: #e9ecef; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #00495a; } #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; } #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator & Minigame */
        #modal-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); display: none; /* Initially hidden */ flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); padding: 2rem; text-align: center; }
        #modal-loading.active { display: flex; } /* Show when active */
        #loading-text { font-weight: 700; color: var(--color-primary); font-size: 1.4rem; font-family: 'Merriweather'; margin-bottom: 1.5rem; }
        #game-container { width: 250px; height: 250px; background-color: #e9ecef; border: 2px solid var(--color-tertiary); border-radius: var(--border-radius); position: relative; overflow: hidden; box-shadow: var(--shadow-sm); margin-bottom: 1rem; }
        .game-piece { position: absolute; width: 25px; height: 25px; background-color: var(--color-primary); border: 1px solid var(--color-secondary); cursor: pointer; transition: transform 0.1s ease-out, background-color 0.2s; }
        .game-piece.correct { background-color: var(--color-tertiary); transform: scale(1.1); }
        .game-piece.incorrect { background-color: #dc3545; animation: shake 0.3s; }
        #game-score { font-family: 'Lato', sans-serif; font-size: 1rem; color: var(--color-text-muted); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Error Message */
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: #c08405; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); background-color: white; }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-modal-bg); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                      <i class="fas fa-moon mr-3 text-yellow-500"></i> <!-- Icono Luna -->
                     Historias del Islam
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">Relatos y Enseñanzas</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora la Riqueza del Legado Islámico</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre figuras, eventos y conceptos que han moldeado la historia y la fe. Selecciona un tema o busca.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar personaje, evento, concepto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-700 mr-2"></i> <!-- Icono libro abierto -->
                 Índice Temático
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando índice...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No se encontraron temas para tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Más Temas (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator & Minigame -->
             <div id="modal-loading">
                 <p id="loading-text">Cargando Información...</p>
                 <div id="game-container">
                     <!-- El minijuego se generará aquí -->
                 </div>
                 <p id="game-score">Puntuación: 0</p>
                 <p class="text-sm text-gray-500 mt-2">Haz clic en las piezas que aparecen para completar el patrón.</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder appended here via JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este tema...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Relatos generados por IA con fines educativos e informativos sobre la historia y cultura islámica.</p>
              <p class="mt-1">Para estudios profundos, consulta fuentes académicas y religiosas reconocidas.</p>
              <p class="mt-2">© 2025 Relatos del Islam</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Profetas Pre-Islámicos (Corán)
            "Historia de Adán (Adam)", "El Arca de Noé (Nuh)", "La Fe de Abraham (Ibrahim)", "Abraham y la Construcción de la Kaaba", "El Sacrificio de Ismael (Ismail)", "La Paciencia de Job (Ayyub)", "Historia de Lot (Lut) y las ciudades", "José (Yusuf) en Egipto", "Moisés (Musa) y el Faraón", "Las Tablas de Moisés", "David (Dawud) y Goliat (Jalut)", "La Sabiduría de Salomón (Sulayman)", "Jonás (Yunus) y la Ballena", "Zacarías (Zakariyya) y Juan el Bautista (Yahya)", "Jesús (Isa) y su Nacimiento Milagroso", "Los Milagros de Jesús (Isa)", "La Ascensión de Jesús (Isa)",
            // Profeta Muhammad (PBUH) - Vida y Eventos Clave
            "Nacimiento del Profeta Muhammad (PBUH)", "La Infancia y Juventud del Profeta", "El Matrimonio con Jadiya (Khadijah)", "La Primera Revelación en la Cueva de Hira", "Los Primeros Musulmanes", "La Persecución en La Meca", "El Boicot contra los Banu Hashim", "El Año de la Tristeza", "El Viaje Nocturno (Isra) y la Ascensión (Miraj)", "La Hégira (Hijra): Migración a Medina", "El Establecimiento de la Comunidad en Medina", "La Constitución de Medina", "La Batalla de Badr", "La Batalla de Uhud", "La Batalla del Foso (Khandaq)", "El Tratado de Hudaybiyyah", "La Conquista Pacífica de La Meca", "El Discurso de Despedida del Profeta", "El Fallecimiento del Profeta Muhammad (PBUH)",
            // Compañeros (Sahaba) Hombres
            "Abu Bakr As-Siddiq: El Primer Califa", "Umar ibn al-Jattab: El Segundo Califa", "Uthman ibn Affan: El Tercer Califa", "Ali ibn Abi Talib: El Cuarto Califa", "Hamza ibn Abdul-Muttalib: El León de Dios", "Bilal ibn Rabah: El Muecín del Profeta", "Salman al-Farsi: El Buscador de la Verdad", "Abu Hurairah: Narrador de Hadices", "Khalid ibn al-Walid: La Espada de Dios", "Abdullah ibn Masud: Erudito del Corán", "Sa'd ibn Abi Waqqas: Conquistador de Persia", "Zayd ibn Harithah: El Hijo Adoptivo del Profeta", "Mus'ab ibn Umayr: El Primer Embajador del Islam", "Ja'far ibn Abi Talib: El de las Dos Alas", "Abd al-Rahman ibn Awf: El Comerciante Bendecido",
            // Compañeras (Sahabiyat) Mujeres
            "Khadijah bint Khuwaylid: La Primera Esposa y Creyente", "Aisha bint Abi Bakr: Madre de los Creyentes", "Fatimah bint Muhammad: Hija del Profeta", "Umm Salamah: Sabiduría y Consejo", "Zaynab bint Jahsh: Matrimonio Divino", "Sumayyah bint Khabbat: La Primera Mártir", "Asma bint Abi Bakr: La de los Dos Cinturones", "Umm Ayman: La Nodriza del Profeta", "Safiyya bint Huyayy: Esposa del Profeta", "Hafsa bint Umar: Guardiana del Corán", "Nusaybah bint Ka'ab (Umm Ammarah): Guerrera en Uhud",
            // Califato Rashidun (Bien Guiado)
            "La Elección de Abu Bakr", "Las Guerras de Apostasía (Ridda)", "La Compilación del Corán bajo Abu Bakr", "Las Conquistas Islámicas bajo Umar", "La Administración de Umar ibn al-Jattab", "La Expansión bajo Uthman", "La Recopilación Final del Corán (Mushaf de Uthman)", "La Fitna (Guerra Civil) durante Ali", "La Batalla del Camello", "La Batalla de Siffin", "El Arbitraje entre Ali y Muawiyah", "El Califato de Hasan ibn Ali",
            // Dinastías y Periodos Históricos
            "El Califato Omeya (Umayyad) en Damasco", "La Construcción de la Cúpula de la Roca", "La Expansión Omeya en el Norte de África y España", "La Batalla de Karbala y el Martirio de Husayn", "El Califato Abasí en Baghdad", "La Edad de Oro del Islam (Ciencia y Cultura Abasí)", "La Casa de la Sabiduría (Bayt al-Hikmah)", "Harun al-Rashid y las Mil y Una Noches", "La Caída de Baghdad (Mongoles)", "El Islam en Al-Ándalus (España Musulmana)", "La Mezquita de Córdoba", "El Palacio de la Alhambra en Granada", "La Dinastía Fatimí en Egipto", "La Fundación de El Cairo y Al-Azhar", "Salahuddin Ayyubi (Saladino) y las Cruzadas", "La Reconquista de Jerusalén por Salahuddin", "El Imperio Otomano: Ascenso y Expansión", "La Conquista de Constantinopla (Mehmed II)", "Suleimán el Magnífico", "El Imperio Safávida en Persia", "El Imperio Mogol en la India", "El Taj Mahal", "La Expansión del Islam en el Sudeste Asiático", "La Expansión del Islam en África Subsahariana",
            // Figuras Clave Post-Rashidun
            "Imam Abu Hanifah (Fundador Escuela Hanafi)", "Imam Malik ibn Anas (Fundador Escuela Maliki)", "Imam Al-Shafi'i (Fundador Escuela Shafi'i)", "Imam Ahmad ibn Hanbal (Fundador Escuela Hanbali)", "Imam Bukhari (Compilador de Hadices)", "Imam Muslim (Compilador de Hadices)", "Al-Khwarizmi (Padre del Álgebra)", "Ibn Sina (Avicena): Médico y Filósofo", "Al-Ghazali: Teólogo y Místico", "Ibn Rushd (Averroes): Filósofo", "Ibn al-Haytham (Alhacén): Padre de la Óptica", "Rumi: Poeta Místico Sufí", "Ibn Khaldun: Historiador y Sociólogo", "Ibn Battuta: El Gran Viajero", "Al-Biruni: Erudito Universal", "Ibn Taymiyyah: Teólogo", "Muhammad al-Fatih (Mehmed II)", "Akbar el Grande (Mogol)", "Sayyid Qutb (Siglo XX)", "Malcom X (El-Hajj Malik El-Shabazz)",
            // Conceptos y Pilares del Islam
            "Tawhid: La Unicidad Absoluta de Dios", "Shahada: El Testimonio de Fe", "Salat: La Oración Ritual Islámica", "Zakat: La Caridad Obligatoria", "Sawm: El Ayuno en Ramadán", "Hajj: La Peregrinación a La Meca", "El Sagrado Corán: Revelación y Significado", "La Sunnah: El Ejemplo del Profeta", "Los Hadices: Dichos y Hechos del Profeta", "Sharia: La Ley Islámica (Concepto y Fuentes)", "Fiqh: La Jurisprudencia Islámica", "Halal y Haram: Lo Permitido y Prohibido", "Jihad: Esfuerzo y Lucha (Significados)", "Ángeles en el Islam (Malaikah)", "Profetas en el Islam (Anbiya)", "El Día del Juicio (Yawm al-Qiyamah)", "El Paraíso (Jannah) y el Infierno (Jahannam)", "Qadar: La Predestinación Divina", "Ihsan: La Excelencia en la Adoración", "Taqwa: La Conciencia de Dios", "Ummah: La Comunidad Musulmana Global", "Dawah: La Invitación al Islam", "La Importancia de la Familia en el Islam", "El Respeto a los Padres", "La Ética del Comercio en el Islam", "La Prohibición de la Usura (Riba)", "El Cuidado del Medio Ambiente en el Islam",
            // Lugares Sagrados y Centros Históricos
            "La Kaaba en La Meca", "Masjid al-Haram (La Gran Mezquita de La Meca)", "El Pozo de Zamzam", "Monte Arafat", "Masjid an-Nabawi (La Mezquita del Profeta en Medina)", "Masjid Quba (Primera Mezquita del Islam)", "Masjid Al-Aqsa y la Cúpula de la Roca (Jerusalén)", "Damasco: Capital Omeya", "Baghdad: Capital Abasí", "Córdoba: Capital de Al-Ándalus", "Granada y la Alhambra", "Estambul (Constantinopla): Capital Otomana", "El Cairo y la Universidad Al-Azhar", "Kufa e importancia histórica", "Karbala: Lugar del Martirio de Husayn", "Samarcanda y Bujará: Centros de Saber", "Tombuctú: Centro Islámico en África",
            // Ramas y Escuelas de Pensamiento
            "Sunismo: Orígenes y Creencias", "Chiismo: Orígenes y Creencias (Duodecimanos, Ismailíes, Zaydíes)", "Sufismo: El Misticismo Islámico", "Las Cuatro Escuelas Sunitas de Jurisprudencia (Madhhabs)", "Escuelas Chiítas de Jurisprudencia", "Jariyismo (Khawarij): Orígenes", "Mu'tazilismo: Teología Racionalista", "Asharismo y Maturidismo: Escuelas Teológicas Sunitas", "Salafismo y Wahhabismo (Contexto Histórico)",
            // Arte, Cultura y Ciencia
            "La Caligrafía Islámica", "El Arte Geométrico Islámico", "La Arquitectura de las Mezquitas", "La Poesía Árabe Pre-Islámica e Islámica", "Las Mil y Una Noches (Alf Layla wa-Layla)", "Contribuciones Islámicas a las Matemáticas (Álgebra, Algoritmos)", "Contribuciones Islámicas a la Astronomía", "Contribuciones Islámicas a la Medicina", "Contribuciones Islámicas a la Óptica", "Contribuciones Islámicas a la Química (Alquimia)", "Contribuciones Islámicas a la Filosofía", "El Papel y su Difusión desde el Mundo Islámico", "El Astrolabio y otros instrumentos", "Sistemas de Irrigación y Agricultura",
            // Historias Específicas del Corán/Hadiz
            "La Gente de la Cueva (Ashab al-Kahf)", "Dhul-Qarnayn y las Murallas", "La Reina de Saba (Bilqis) y Salomón", "Luqman el Sabio y sus Consejos", "La Parábola de los Dos Jardines", "Historia de Qarun (Coré)", "El Becerro de Oro", "La Vaca Amarilla (Surat Al-Baqarah)", "La Mesa Servida (Surat Al-Ma'idah)", "El Dueño del Elefante (Ashab al-Fil)",
            // Temas Contemporáneos (Contextualizados Históricamente)
            "El Islam en el Mundo Moderno", "Movimientos de Reforma Islámica (Siglos XIX-XX)", "El Fin del Califato Otomano", "El Islam y la Globalización", "Desafíos de la Comunidad Musulmana en Occidente", "El Diálogo Interreligioso", "Finanzas Islámicas Contemporáneas", "El Rol de la Mujer en Sociedades Musulmanas (Perspectivas)", "El Islam y la Ciencia Moderna"
            // Asegurarse de tener suficientes títulos, añadir más si es necesario.
        ];
        const islamThemes = [ // Temas para generar más títulos
            "profetas del Islam", "compañeros del Profeta Muhammad", "mujeres importantes en el Islam", "califas Rashidun", "historia Omeya", "historia Abasí", "Edad de Oro Islámica", "Al-Ándalus", "Imperio Otomano", "Salahuddin Ayyubi", "pilares del Islam", "conceptos teológicos islámicos", "lugares sagrados del Islam", "ciencia en el mundo islámico medieval", "arte y arquitectura islámica", "escuelas de jurisprudencia (Fiqh)", "misticismo Sufí", "historias del Corán", "figuras históricas musulmanas", "expansión del Islam"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un respetado historiador y erudito en estudios islámicos. Tu tarea es narrar la historia, vida o concepto del Islam indicado de manera detallada, precisa, objetiva y respetuosa. Proporciona contexto histórico, menciona figuras clave, explica la importancia religiosa o cultural, y si es aplicable, extrae lecciones o enseñanzas morales basadas en fuentes tradicionales. Evita especulaciones no fundamentadas y mantén un tono académico pero accesible. El objetivo es una narrativa completa de aproximadamente 1200-1300 palabras. Basa tu relato únicamente en el siguiente tema:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúas como un asistente informativo especializado únicamente en el tema islámico específico que se está mostrando. Responde preguntas de seguimiento sobre detalles, personajes, contexto o significado mencionados en la narración principal. Sé conciso, preciso y respetuoso.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // Prompt para 40 títulos
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia sobre el Islam. Genera exactamente 40 nombres de personajes, eventos históricos, conceptos teológicos, lugares importantes o historias relevantes del Islam, adecuados para una narración detallada. Devuelve *solo* la lista, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentar un poco el timeout para 40 títulos
        };

        // ========== MINIGAME CONFIG ==========
        const gameConfig = {
            gridSize: 5, // 5x5 grid
            pieceSize: 40, // px
            spawnInterval: 1500, // ms between new pieces
            pieceLife: 4000, // ms piece stays visible
            maxActivePieces: 5,
            scoreIncrement: 10,
        };

        // ========== DOM ELEMENTS ==========
        // ... (igual que antes: searchInput, titleListContainer, etc.)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const gameContainer = document.getElementById('game-container');
        const gameScoreDisplay = document.getElementById('game-score');
        const loadingText = document.getElementById('loading-text');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Contexto para chat
        let gameIntervalId = null;
        let gameScore = 0;
        let activePieces = []; // Almacena info de piezas activas
        let gameTimeoutId = null; // Para detener el juego si la API es muy rápida

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Eres un asistente informativo especializado únicamente en el tema islámico '${currentTopicTitle}'. Responde preguntas sobre detalles mencionados en la narración principal. Sé conciso, preciso y respetuoso.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     // *** MENSAJE DE ERROR AMIGABLE ***
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento. Por favor, intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta con otro tema.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
         }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) {
             if (!currentTopicTitle) throw new Error("Error interno: Contexto del tema no establecido para el chat.");
             return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        // *** MODIFIED: fetchGeneratedTitles to fetch 40 ***
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(islamThemes) || "historia islámica general";
             // Solicitar 40 títulos
             const specificPrompt = `Genera 40 nombres/conceptos/personajes/eventos sobre ${randomTheme} en el Islam`;
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) }; // Usar config de títulos
             return fetchTextFromApi(specificPrompt, configForThisRequest, false) // Usar el config para 40 títulos
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 10) throw new Error("La IA no generó suficientes temas nuevos."); // Aceptar menos de 40 si es necesario
                     return titles.slice(0, 40); // Devolver hasta 40
                 });
         }
         function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Islamic art pattern";
             // ** CRUCIAL: Modify prompt to avoid forbidden depictions **
             const enhancedPrompt = `Symbolic or conceptual representation inspired by '${safePromptText}'. Islamic art style, geometric patterns, calligraphy, architectural elements (mosque silhouette, minaret), landscapes (desert, oasis), light effects. AVOID depicting human figures, faces, or prophets directly. Focus on symbolism and atmosphere.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "photograph, realistic human figure, face, portrait, prophet depiction, specific person, text, words, labels, logo, signature, watermark, blurry, low quality";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (misma función que antes) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            stopGame(); // Asegurarse de detener el juego al cerrar
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.classList.remove('active'); // Ocultar loading/game
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
             // Reset game specific things if needed
             gameScore = 0;
             if(gameScoreDisplay) gameScoreDisplay.textContent = "Puntuación: 0";
             if(gameContainer) gameContainer.innerHTML = ''; // Limpiar piezas viejas
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (misma función que antes) ... */
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
         }
        function hideFullscreenImage() { /* ... (misma función que antes) ... */
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
         }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        function addChatError(message) { /* ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        async function handleSendMessage() { /* ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
         }

        // ========== MINIGAME FUNCTIONS ==========
        function startGame() {
            if (!modalLoadingIndicator || !gameContainer || !gameScoreDisplay || !loadingText) return;
            console.log("Starting game...");
            resetModalState(); // Ensure clean state before showing loading
            modalLoadingIndicator.classList.add('active'); // Show the loading container
            loadingText.textContent = "Cargando Información..."; // Reset loading text
            gameScore = 0;
            gameScoreDisplay.textContent = "Puntuación: 0";
            gameContainer.innerHTML = ''; // Clear previous game pieces
            activePieces = [];

            // Start spawning pieces
            gameIntervalId = setInterval(spawnPiece, gameConfig.spawnInterval);

            // Set a timeout to stop the game eventually, even if API is super fast
            // This prevents the game running indefinitely if something goes wrong.
             gameTimeoutId = setTimeout(() => {
                 console.log("Game timeout reached, stopping game proactively.");
                 if (modalLoadingIndicator.classList.contains('active')) { // Only stop if still loading
                     stopGame();
                     // Optionally show a "still loading" message without the game
                     loadingText.textContent = "Casi listo...";
                     gameContainer.innerHTML = '<p style="font-size:0.9em; padding: 1em; color: var(--color-text-muted);">Finalizando carga...</p>';
                 }
             }, textApiConfig.timeoutSeconds * 900); // Stop game slightly before API timeout

        }
        function stopGame() {
            console.log("Stopping game...");
            clearInterval(gameIntervalId);
             clearTimeout(gameTimeoutId); // Clear the proactive stop timeout
            gameIntervalId = null;
            gameTimeoutId = null;
            // Remove any remaining pieces visually (optional)
             if (gameContainer) gameContainer.innerHTML = '';
            activePieces = [];
            // Don't hide modalLoadingIndicator here, handleTitleClick will do that
        }
        function spawnPiece() {
            if (!gameContainer || activePieces.length >= gameConfig.maxActivePieces) return;

            const piece = document.createElement('div');
            piece.classList.add('game-piece');
            const pieceId = `piece-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`;
            piece.id = pieceId;

            // Random position within the container
            const maxX = gameContainer.clientWidth - gameConfig.pieceSize;
            const maxY = gameContainer.clientHeight - gameConfig.pieceSize;
            const x = Math.floor(Math.random() * (maxX + 1));
            const y = Math.floor(Math.random() * (maxY + 1));
            piece.style.left = `${x}px`;
            piece.style.top = `${y}px`;

            // Add piece info to active list
            const pieceData = { id: pieceId, element: piece, timeoutId: null };
            activePieces.push(pieceData);

            // Make piece disappear after a while if not clicked
            pieceData.timeoutId = setTimeout(() => {
                removePiece(pieceId, false); // Remove as missed
            }, gameConfig.pieceLife);

            // Add click listener
            piece.addEventListener('click', () => handlePieceClick(pieceId));

            gameContainer.appendChild(piece);
        }
        function handlePieceClick(pieceId) {
            const pieceIndex = activePieces.findIndex(p => p.id === pieceId);
            if (pieceIndex === -1) return; // Piece already removed or clicked

            const pieceData = activePieces[pieceIndex];
            clearTimeout(pieceData.timeoutId); // Stop the removal timeout

            // Mark as correct (visual feedback)
            pieceData.element.classList.add('correct');

            // Update score
            gameScore += gameConfig.scoreIncrement;
            gameScoreDisplay.textContent = `Puntuación: ${gameScore}`;

            // Remove piece after a short delay
            setTimeout(() => {
                removePiece(pieceId, true);
            }, 300); // Keep visible briefly after correct click
        }
        function removePiece(pieceId, clickedCorrectly) {
            const pieceIndex = activePieces.findIndex(p => p.id === pieceId);
            if (pieceIndex === -1) return; // Already removed

            const pieceData = activePieces[pieceIndex];
            if (pieceData.element && pieceData.element.parentNode) {
                if (!clickedCorrectly && pieceData.element.classList.contains('game-piece')) {
                    // Optional: Add 'incorrect' visual feedback for missed pieces
                    // pieceData.element.classList.add('incorrect');
                     // setTimeout(() => pieceData.element.remove(), 300); // Remove after shake
                    pieceData.element.remove(); // Just remove immediately if missed
                } else {
                    pieceData.element.remove();
                }
            }

            // Remove from active list
            activePieces.splice(pieceIndex, 1);
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">No hay temas disponibles.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Reapply filter
         }

        // *** MODIFIED: handleTitleClick to manage game state ***
        async function handleTitleClick(title) {
            resetModalState(); // Clears previous state
            showModal(); // Shows modal structure
            modalTitle.textContent = title;
            currentTopicTitle = title; // Set chat context
            chatHistory.innerHTML = ''; // Clear chat

            // *** START LOADING & GAME ***
            startGame();

            try {
                // Fetch explanation while game runs
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // *** STOP GAME and HIDE loading indicator ***
                stopGame();
                modalLoadingIndicator.classList.remove('active');

                // Display content
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0; // Reset scroll AFTER content visible
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder (inside modalContent)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Generando imagen simbólica...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Create and load image
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación simbólica de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => {
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`;

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                    placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                // *** STOP GAME and HIDE loading indicator on error too ***
                stopGame();
                modalLoadingIndicator.classList.remove('active');

                // Show error message
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el tema.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles to fetch 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando Más Temas...';
             try {
                 // Fetch 40 titles using the updated function
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más temas en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar temas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                  // Update button text to reflect 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Temas (40)';
             }
         }

         // Search Filter Function (con normalización para tildes)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalLoadingIndicator || !gameContainer) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error crítico: Faltan componentes esenciales de la página.</p>';
                return;
             }
            // Event Listeners (Modal, Generate More, Search, Chat, Fullscreen)
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial Display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>