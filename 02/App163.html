<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Susurros del Vacío - Cuentos Lovecraftianos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Lovecraftianas/Clásicas -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Cuentos Lovecraftianos --- */
        :root {
            --color-primary: #582c8d; /* Púrpura Profundo / Insidioso */
            --color-secondary: #0a7d5d; /* Verde Abisal / Musgo Antiguo */
            --color-tertiary: #e2b14b; /* Ámbar / Oro Viejo (Acentos) */
            --color-background: #1a1a1d; /* Gris Muy Oscuro / Casi Negro Carbón */
            --color-text: #c5c6c7; /* Gris Pálido / Pergamino Claro */
            --color-text-muted: #8f8f8f; /* Gris Medio Desgastado */
            --color-modal-bg: #24252a; /* Gris Oscuro Desaturado */
            --color-border: #4b4f58; /* Borde Gris Plomo */
            --color-error-bg: #3a1e1e; /* Rojo Sangre Seca Oscuro */
            --color-error-text: #d7a0a0; /* Texto Error Pálido */
            --color-error-border: #8c2d2d; /* Borde Error Oscuro */

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.6), 0 4px 6px -2px rgba(0, 0, 0, 0.5);
            --border-radius: 4px; /* Bordes ligeramente suaves */
            --transition-normal: all 0.3s ease-in-out;

            /* Subtle Background Texture */
            /* background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%233a3a3f" fill-opacity="0.05"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); */
        }
        body { font-family: 'Crimson Text', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel Decorative', cursive; font-weight: 700; letter-spacing: 1.5px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px rgba(88, 44, 141, 0.6); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }
        h2.section-title { color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; margin-bottom: 1.5rem !important; }
        #modal-title { color: var(--color-tertiary); font-weight: 700; text-shadow: 0 0 5px rgba(226, 177, 75, 0.4); }
        .navbar { background-color: rgba(26, 26, 29, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 3rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1.05rem; background-color: rgba(36, 37, 42, 0.8); color: var(--color-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); transition: var(--transition-normal); font-family: 'Crimson Text', serif; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(88, 44, 141, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 75px; font-family: 'Crimson Text', serif; font-size: 1.1rem; opacity: 0.9; border-left: 4px solid var(--color-border); }
        .title-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-tertiary); background-color: #2f3136; border-left-color: var(--color-primary); opacity: 1; }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(135deg, var(--color-secondary), var(--color-primary)); color: var(--color-text); padding: 0.9rem 1.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-family: 'Cinzel Decorative', cursive; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.6); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); box-shadow: var(--shadow-lg); border-color: var(--color-tertiary); color: var(--color-tertiary); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; border-color: var(--color-border); text-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-text); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 29, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.8rem 2.2rem;
            max-width: 980px; /* Slightly wider for readability */
            width: 96%;
            max-height: 92vh;
            min-height: 450px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; opacity: 0.8; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-text); transform: rotate(-90deg); box-shadow: 0 0 8px var(--color-primary); opacity: 1; }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.4; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(75, 79, 88, 0.4);
        }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(75, 79, 88, 0.4); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 8px; }
        #modal-content p { margin-bottom: 1.5em; text-indent: 1.5em; /* Indentación Lovecraftiana */ text-align: justify; }
        #modal-content p:first-of-type { text-indent: 0; } /* No indent first paragraph */
        #modal-content strong { color: var(--color-tertiary); font-weight: 600; font-style: italic; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel Decorative', cursive; margin-top: 2.5em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px dotted var(--color-border); padding-bottom: 0.6em; font-weight: 400; letter-spacing: 1px; text-align: center; text-indent: 0 !important; /* No indent headers */ }
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.15em; color: var(--color-text-muted); border-bottom: none; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; /* Imagen no tan ancha */ height: auto; margin: 3rem auto 1.5rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; filter: sepia(0.2) contrast(0.9) brightness(0.9); }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: 0 0 15px rgba(88, 44, 141, 0.4); filter: sepia(0) contrast(1) brightness(1); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(75, 79, 88, 0.7); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1.2s linear infinite; margin-bottom: 1rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; opacity: 0.6; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px dashed var(--color-border); padding-top: 1.2rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(26, 26, 29, 0.7); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(75, 79, 88, 0.4);
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(75, 79, 88, 0.4); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; font-size: 0.95rem; }
        .user-message { background-color: var(--color-secondary); color: #e1e1e1; margin-left: auto; text-align: left; box-shadow: var(--shadow-sm); }
        .ai-message { background-color: #4b4f58; color: var(--color-text); margin-right: auto; text-align: left; box-shadow: var(--shadow-sm); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #2f3136; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Crimson Text', serif; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); background-color: #3a3c41; }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: var(--color-text); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #6a3aa6; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.6rem; font-size: 0.9em; color: var(--color-text-muted); font-style: italic; display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 4rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 29, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 7px solid var(--color-border); border-top-color: var(--color-primary); border-bottom-color: var(--color-secondary); border-radius: 50%; animation: spin 1.5s linear infinite; margin: 0 auto 2rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.4rem; font-family: 'Cinzel Decorative'; text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Crimson Text', serif; font-size: 1.05rem; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 29, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 96%; max-height: 96%; object-fit: contain; border: 2px solid var(--color-border); box-shadow: var(--shadow-lg); filter: brightness(1.1); /* Slightly brighter fullscreen */ }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 42px; height: 42px; font-size: 1.9rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); opacity: 0.8; }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-text); transform: scale(1.1) rotate(90deg); opacity: 1; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-12">
         <div class="container mx-auto px-4 py-5 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-4 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-book-dead mr-3 text-purple-400"></i> <!-- Icono Necronomicon -->
                     Susurros del Vacío
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider italic">» Antología Interactiva del Horror Cósmico «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-20">
         <!-- Hero section -->
         <section class="mb-14 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-6">Horrores Innombrables</h1>
             <p class="text-xl text-gray-300 mb-10 max-w-4xl mx-auto font-light leading-relaxed">Atrévete a explorar los abismos prohibidos de la imaginación. Selecciona un fragmento arcano o busca un tema para desenterrar relatos olvidados al estilo del maestro de Providence.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-12 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar por título, entidad o lugar maldito...">
             <i class="fas fa-search fa-eye"></i> <!-- Icono ojo/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-12">
             <h2 class="section-title text-3xl sm:text-4xl mb-10 text-center mx-auto">
                 <i class="fas fa-scroll text-amber-400 mr-2"></i> <!-- Icono pergamino -->
                 Fragmentos Arcanos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans italic">Consultando los tomos prohibidos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-6 hidden font-sans italic">» Ningún fragmento coincide con vuestra funesta búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-10">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Desenterrar Más Relatos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Descifrando el Manuscrito...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image and placeholder added via JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <h4 class="text-center text-sm text-gray-400 mb-2 font-sans italic">Consultar al Erudito sobre este Relato:</h4>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> El erudito reflexiona...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Inquirir sobre entidades, lugares o sucesos...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-7 mt-16 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Relatos generados por IA, inspirados en el horror cósmico de H.P. Lovecraft y su círculo.</p>
              <p class="mt-1">El contenido es ficticio y con fines de entretenimiento atmosférico.</p>
              <p class="mt-2">© 1928 Archivos de la Universidad Miskatonic (División Interactiva)</p> <!-- Año temático -->
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
             // Location-Based
            "La Sombra sobre Innsmouth", "El Horror de Dunwich", "El Festival (Kingsport)", "El Ceremonial", "La Ciudad Sin Nombre", "En las Montañas de la Locura", "La Casa Evitada", "El Pantano de la Luna", "A Través de las Puertas de la Llave de Plata (Kadath)", "La Llamada de Cthulhu (R'lyeh)", "El Modelo de Pickman (Boston)", "El Morador de las Tinieblas (Providence)", "La Declaración de Randolph Carter (Cementerio)", "El Clérigo Maligno (Inglaterra Rural)", "Aire Frío (Nueva York)", "La Música de Erich Zann (Calle D'Auseil)", "El Horror de Red Hook", "La Búsqueda en Sueños de la Ignota Kadath", "La Abominación de Yondo (Desierto)", "Las Ratas en las Paredes (Exham Priory)", "El Túmulo (Oklahoma)", "La Antigua Raza (Australia Occidental)", "El Templo Sumergido", "El Árbol en la Colina Solitaria", "La Ciénaga Negra de Azathoth", "Las Profundidades Glaciales de Leng", "El Laberinto de la Perdición en Yuggoth", "Las Torres Basálticas de Carcosa", "El Jardín Adumbrado de K'naa", "Las Ruinas Ciclopeas bajo el Mar Arábigo", "El Monasterio Silencioso de Hiperbórea", "La Biblioteca Prohibida de Pnakotus", "El Observatorio Estelar de Arkham", "El Manicomio de Danvers", "El Pozo de Shoggoths en la Antártida", "La Capilla de la Contemplación Oscura", "El Mercado Nocturno de Ulthar", "Los Túneles bajo Sentinel Hill", "El Refugio de la Secta Estelar", "La Torre Negra de Yuggoth", "El Santuario Escondido de Tsathoggua", "Las Cavernas de Cristal de Zothique", "El Osario Olvidado de Commoriom", "La Mansión Marchita de los Curwen", "El Faro Abandonado de Devil's Reef", "El Teatro de Marionetas de Nyarlathotep", "La Fundición Desolada de Akeley", "El Astillero Maldito de Innsmouth", "El Museo Oculto de Cabot", "La Finca Bishop en el Bosque",
             // Entity-Based
            "Dagón", "Nyarlathotep", "El Caos Reptante (Nyarlathotep)", "Azathoth", "El Sultán Demonio (Azathoth)", "Yog-Sothoth", "La Llave y la Puerta (Yog-Sothoth)", "Shub-Niggurath", "La Cabra Negra de los Bosques (Shub-Niggurath)", "Hastur el Innombrable", "El Rey de Amarillo (Hastur)", "Cthulhu", "El Gran Cthulhu Durmiente", "Tsathoggua", "El Durmiente de N'kai (Tsathoggua)", "Yig, el Padre de las Serpientes", "Ghatanothoa", "El Horror Petrificante (Ghatanothoa)", "Los Primigenios (Elder Things)", "La Gran Raza de Yith", "Los Mi-Go de Yuggoth", "Los Hongos de Yuggoth (Mi-Go)", "Los Perros de Tíndalos", "Los Profundos (Deep Ones)", "Los Shoggoths", "La Progenie Informe (Shoggoths)", "Los Gules", "Los Nocturnos (Night-gaunts)", "Los Byakhee", "Servidores de los Otros Dioses", "Los Colores Surgidos del Espacio", "El Horror Tentacular de R'lyeh", "El Susurro Espectral de Kadath", "El Vigilante Silencioso de Yuggoth", "La Entidad Geométrica de Xiclotl", "El Parásito Dimensional", "El Heraldo de la Entropía Final", "La Conciencia Colectiva de Cygnus X-1", "El Devorador de Soles", "El Tejedor de Pesadillas", "El Arquitecto de la Locura", "La Sombra Hambrienta", "El Ladrón de Mentes Estelar", "El Gusano que Roía la Noche", "La Semilla Estelar de la Perdición", "El Coleccionista de Almas Perdidas", "El Eco de la Realidad Rota", "El Guardián del Umbral Prohibido", "El Hongo Cerebral de Mícar", "La Plaga Psíquica de Aldebarán", "El Parpadeo en el Rincón del Ojo", "El Reflejo Inverso", "La Sinfonía Silenciosa de Azathoth", "El Tumor Creciente del Cosmos",
             // Object-Based
            "El Necronomicón", "El Libro de Eibon", "Los Manuscritos Pnakóticos", "El Cultes des Goules", "De Vermis Mysteriis", "El Texto de R'lyeh", "El Trapezoedro Resplandeciente", "La Llave de Plata", "El Espejo de Nitocris", "El Amuleto de los Perros de Tíndalos", "El Símbolo Arcano", "La Lámpara de Alhazred", "El Ídolo Cthoniano", "La Flauta del Caos (Azathoth)", "El Sello de Yog-Sothoth", "La Tiara de los Profundos", "El Cilindro Cerebral Mi-Go", "El Cristal de Visión Yithiana", "La Daga Ritual de los Gules", "El Fragmento Estelar (Color)", "El Orbe de la Locura Eterna", "La Caja de Música de Erich Zann", "El Reloj de Arena del Tiempo Roto", "El Mapa de las Estrellas Oscuras", "La Pluma del Poeta Loco", "El Talismán de Protección Inútil", "El Cáliz de la Sangre Antigua", "El Códice Negro de Hiperbórea", "El Anillo de Sello de Carcosa", "La Estatua Viviente de Mu", "El Motor de Diferencia Temporal", "El Compás No-Euclidiano", "La Lente de la Otra Dimensión", "El Cubo Enigmático de Valusia", "El Pergamino de los Secretos Ofidios", "La Máscara del Rey de Amarillo", "El Diario Cifrado de Alhazred", "La Partitura Imposible", "El Autómata de Cobre de Pickman", "El Fragmento de la Ciudad Sin Nombre",
             // Event-Based
            "El Festival", "El Ceremonial", "La Llamada de Cthulhu (El Ritual)", "La Sombra sobre Innsmouth (La Redada)", "El Horror de Dunwich (El Enfrentamiento)", "El Caso de Charles Dexter Ward (La Resurrección)", "Herbert West: Reanimador", "El Modelo de Pickman (La Revelación)", "La Música de Erich Zann (El Concierto Final)", "Las Ratas en las Paredes (El Descenso)", "El Morador de las Tinieblas (El Intercambio)", "La Búsqueda en Sueños de la Ignota Kadath (El Viaje)", "La Noche del Océano (Innsmouth)", "El Sacrificio en Devil's Reef", "La Conjunción de las Estrellas Negras", "El Despertar de la Semilla Estelar", "La Apertura del Portal a Yuggoth", "La Invocación del Caos Reptante", "La Danza Macabra de los Gules", "El Canto Fúnebre de los Byakhee", "La Llegada de los Colores", "La Fusión de los Shoggoths", "El Intercambio Mental con la Gran Raza", "La Huida de los Perros de Tíndalos", "El Silencio Súbito de Azathoth", "La Transformación de Innsmouth", "El Colapso de la Geometría Estable", "La Plaga Onírica de Kadath", "El Banquete Final de los Primigenios", "La Recolección de Cerebros Mi-Go", "La Coronación del Rey de Amarillo", "El Eclipse de la Razón Pura", "La Sequía Psíquica", "El Murmullo Creciente del Vacío", "La Lluvia de Materia Cerebral", "La Gran Migración de los Profundos", "La Fractura del Espacio-Tiempo Local", "El Último Ritual de los Esotéricos", "La Desaparición de Arkham", "El Amanecer de los Mil Tentáculos",
             // Character-Based / Diary Style
            "La Declaración de Randolph Carter", "El Caso de Charles Dexter Ward", "Herbert West: Reanimador", "El Diario de Alonzo Typer", "Las Notas del Dr. Armitage", "El Testimonio del Pescador de Innsmouth", "Los Experimentos de Joseph Curwen", "Las Confesiones de un Sectario Arrepentido", "El Cuaderno de Campo de un Explorador Antártico", "La Bitácora del Capitán del Emma", "El Legado del Profesor Angell", "La Locura de Henry Akeley", "La Transformación de Edward Derby", "El Último Poema de Justin Geoffrey", "Las Visiones de Tillinghast", "Las Cartas de Asenath Waite", "El Manuscrito Inacabado de H.P. Lovecraft", "El Informe Psiquiátrico de un Soñador", "La Autobiografía de un Cambiante Yithiano", "El Lamento del Último Humano", "Los Archivos Perdidos del Museo Cabot", "Las Crónicas del Bibliotecario de Pnakotus", "El Testamento de un Viajero Temporal", "El Libro de Sombras de Keziah Mason", "Las Memorias de un Ghoul Erudito", "La Transcripción del Interrogatorio Mi-Go", "El Registro de un Superviviente de R'lyeh", "La Historia Oral de un Anciano de Dunwich", "Las Notas Cifradas de un Alquimista Prohibido", "El Sermón Final del Padre Iwanicki",
             // Abstract / Cosmic / Question-Based
            "Del Más Allá", "El Extraño", "El Color Surgido del Espacio", "Hipnos", "Lo Innombrable", "La Maldición que Cayó sobre Sarnath", "La Verdad sobre el Difunto Arthur Jermyn", "El Caos Reptante", "La Música de Erich Zann", "Polaris", "Él", "La Calle", "El Océano Nocturno", "Lo Que Trae la Luna", "Los Otros Dioses", "El Horror Sobrenatural en la Literatura", "El Miedo que Acecha", "Las Sombras sobre el Tejado", "Ecos de una Ciudad Muerta", "El Vacío Devorador", "La Geometría Imposible", "Cuando las Estrellas Son Propicias", "El Sonido del Silencio Cósmico", "La Textura de la Realidad Deshilachada", "Debajo de la Piel del Mundo", "El Patrón Oculto en el Caos", "La Última Pregunta Sin Respuesta", "¿Quiénes Eran los Constructores?", "¿Qué Se Oculta en Leng?", "¿Por Qué Cantan los Profundos?", "¿Adónde Fueron los Primigenios?", "¿Cuál es el Verdadero Nombre de Hastur?", "¿Existe un Orden Más Allá de Azathoth?", "¿Podemos Soportar la Verdad?", "¿Qué Sueña Cthulhu?", "¿Está R'lyeh Subiendo?", "¿Se Puede Matar a un Dios Exterior?", "¿Es Nuestra Locura Su Cordura?"
             // ... (Continue generating variations for locations, entities, objects, events, themes)
         ];
        const lovecraftianThemes = [
            "lugares olvidados lovecraftianos", "entidades cósmicas primigenias", "dioses exteriores y arquetípicos", "cultos secretos y prohibidos", "grimorios malditos (Necronomicón, etc.)", "artefactos arcanos lovecraftianos", "horror corporal y mutaciones", "la locura y la pérdida de cordura", "sueños y dimensiones oníricas", "geometría no euclidiana", "civilizaciones prehumanas antiguas", "el horror en Nueva Inglaterra (Arkham, Dunwich, Innsmouth)", "expediciones condenadas (Antártida, desiertos)", "ciencia ficción y horror cósmico", "la insignificancia humana", "el color surgido del espacio", "los Profundos y Cthulhu", "Nyarlathotep el caos reptante", "Yog-Sothoth la llave y la puerta", "Azathoth el caos nuclear", "Shub-Niggurath y su progenie", "Hastur y Carcosa", "los Mi-Go de Yuggoth", "la Gran Raza de Yith", "los Shoggoths informes"
        ];
        const textApiConfig = { // Para generar el cuento
            model: "mistral", // O un modelo potente adecuado para narrativa larga
            systemPrompt: "Eres un escritor de ficción de horror cósmico, emulando el estilo narrativo, temático y atmosférico de H.P. Lovecraft. Tu tarea es escribir un cuento original y completo (aproximadamente 1200-1300 palabras) basado en el título proporcionado. Enfócate en crear una atmósfera opresiva de pavor y misterio insondable. Utiliza un lenguaje evocador, arcaico y preciso. Describe entornos decadentes, conocimientos prohibidos, entidades indescriptibles y la insignificancia de la humanidad frente al cosmos. Sugiere el horror más que mostrarlo explícitamente. El protagonista debe ser a menudo un erudito, anticuario o individuo sensible que tropieza con una verdad aterradora. El final debe ser ambiguo, desolador o llevar a la locura. Basa tu relato únicamente en el siguiente título lovecraftiano:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúas como un erudito taciturno y experto en saberes arcanos y mitos de horror cósmico, similar a un profesor de la Universidad Miskatonic. Responde preguntas específicas sobre los personajes, lugares, entidades, grimorios o sucesos mencionados SOLAMENTE en el cuento lovecraftiano que se está mostrando actualmente (indicado por el título). Sé conciso, atmosférico y alude a conocimientos prohibidos. Si la pregunta se desvía del cuento actual, declina responder directamente indicando que tus conocimientos se limitan a ese fragmento.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para nuevos cuentos de horror cósmico al estilo Lovecraft. Genera exactamente 15 títulos evocadores y originales que sugieran misterio, decadencia, entidades cósmicas, lugares prohibidos o conocimiento arcano. Sigue los patrones típicos ('La Sombra sobre X', 'El Horror de Y', 'El Diario de Z', 'El Tomo de W', 'El Habitante de...', 'Susurros desde...', etc.). Devuelve *solo* la lista de títulos, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        // (Identical to previous version - Search, List, Modal, Chat, Image Overlay etc.)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Scrollable text/image area
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Text div
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Context for chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `Eres un erudito taciturno y experto en saberes arcanos, similar a un profesor de la Universidad Miskatonic. Responde preguntas específicas sobre los elementos (personajes, lugares, entidades, eventos) mencionados ÚNICAMENTE en el cuento titulado '${currentStoryTitle}'. Sé conciso, atmosférico y alude a conocimientos prohibidos. Si la pregunta no se relaciona directamente con ese cuento específico, indica cortésmente que tus conocimientos se limitan a ese fragmento en particular.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             // No seed for chat or title generation generally needed
             if (config.seed && !isChat && config !== titleGenerationConfig) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     // User-friendly, thematic error
                     throw new Error(`(Error ${response.status}) Los susurros del vacío son intensos ahora; los servidores parecen perturbados. Inténtalo de nuevo en unos instantes.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la entidad llegó como un silencio incomprensible. Intenta reformular tu consulta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con las estrellas distantes se perdió (>${config.timeoutSeconds}s). Revisa tu conexión o aguarda a que las constelaciones sean propicias.`);
                 }
                 // Propagate error (should be friendly if from !response.ok)
                 throw new Error(error.message || "Una interferencia cósmica impidió la comunicación. Vuelve a intentarlo.");
             }
        }
        // Wrappers for clarity
        async function fetchStoryText(storyTitle) {
            // Add a random seed for story variation if desired
            const config = { ...textApiConfig, seed: Math.floor(Math.random() * 100000) };
            return fetchTextFromApi(storyTitle, config, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentStoryTitle) throw new Error("Error Interno: El contexto del relato actual es desconocido.");
            return fetchTextFromApi(userQuery, chatApiConfig, true); // true for chat
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(lovecraftianThemes) || "horror cósmico general";
            const specificPrompt = `Genera 15 títulos de cuentos lovecraftianos sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La inspiración arcana no produjo suficientes títulos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "escena de horror cósmico lovecraftiano";
             // More atmospheric prompt
             const enhancedPrompt = `Dark, atmospheric, unsettling artwork in the style of Lovecraftian horror, inspired by '${safePromptText}'. Focus on mood, shadows, impossible geometry, cosmic vistas, ancient ruins, or suggested monstrous forms. Muted color palette (deep purples, sickly greens, grays). Avoid clear figures, text, labels. Eerie lighting. Oil painting or matte painting style.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "bright colors, happy, cheerful, clear figure, photorealistic, text, words, labels, diagram, chart, graph, signature, watermark, cartoon, anime, multiple images, collage";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (Adjusted for prose)
        function formatStoryText(rawText) { // Renamed for clarity
            if (!rawText) return '';
            let formatted = rawText.trim();
            // Remove potential markdown used incorrectly by AI for emphasis in prose
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '$1'); // Remove bold
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); // Keep italics for emphasis maybe? Or remove: '$1'

            // Remove potential markdown headers if AI wrongly adds them inside story
             formatted = formatted.replace(/^#+\s+(.*)$/gm, '<p><strong>$1</strong></p>'); // Convert accidental headers to bold paragraphs

            // Main formatting: Treat double newlines as paragraph breaks
            const paragraphs = formatted.split(/\n\s*\n+/).filter(p => p.trim().length > 0);
            formatted = paragraphs.map(p => `<p>${p.replace(/\n/g, ' ').trim()}</p>`).join(''); // Replace single newlines within block with space

            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll reset on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null;
             hideFullscreenImage(); // Ensure fullscreen is also hidden
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Identical logic)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (Identical logic, uses thematic prompts)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            // Basic formatting for AI response (italics)
             message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
             msgDiv.innerHTML = message.replace(/\n/g, '<br>'); // Respect newlines in chat
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = `Error del Erudito: ${message}`; // Thematic error prefix
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentStoryTitle) return;

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(error.message); // Display the friendly error from API function
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Sort maybe by length or keep random? Let's sort alphabetically for consistency.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans italic">» Los tomos están vacíos o ilegibles «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; // Show main loading

            try {
                // Fetch the story text
                const rawStoryText = await fetchStoryText(title);
                const formattedStory = formatStoryText(rawStoryText); // Use specific formatter

                modalLoadingIndicator.style.display = 'none'; // Hide main loading
                modalContent.innerHTML = formattedStory; // Display story text
                modalStoryContentArea.classList.remove('content-hidden'); // Show content wrapper

                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is potentially long
                console.log("Scroll reset after story text displayed");

                // Prepare image placeholder (append to modalContent, after text)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-eye placeholder-icon text-purple-400"></i> <!-- Thematic icon -->
                    <p style="font-size: 0.9em; margin-top: 1rem; font-style: italic;">Evocando una visión...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Create and load image
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visión atmosférica de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Image loading failed for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-ban placeholder-icon text-red-700"></i><p style="font-size:0.9em;margin-top:1rem;font-style:italic;">La visión se disipa en la estática.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append after text and placeholder logic
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon text-yellow-600"></i><p style="font-size:0.9em;margin-top:1rem;font-style:italic;">Error al canalizar la imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message; // Show friendly API error
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = ''; // Clear partial content
                chatSection.classList.add('content-hidden'); // Hide chat on main error
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando Oráculos...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Los oráculos guardan silencio por ahora."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al consultar los oráculos: ${error.message}`); // Use friendly API error
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Desenterrar Más Relatos';
             }
         }

         // Search Filter Function (Handles accents)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check for all essential elements, including chat and fullscreen
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalTextArea || !modalContent) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: #8c2d2d; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: serif;">++ Fallo Catastrófico del Sistema ++ Componentes Arcanos Ausentes ++ Abortando Carga ++</p>';
                 return;
             }
            // Event listeners (Modal, Generate More, Search, Chat, Fullscreen Image) - Identical logic
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>