<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recetas Caseras - Nivel Medio</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes cálidas y legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Pacifico&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Recetas Caseras --- */
        :root {
            --color-primary: #f97316; /* Naranja Vibrante (Comida, Energía) */
            --color-secondary: #4d7c0f; /* Verde Oliva (Ingredientes frescos) */
            --color-tertiary: #78350f; /* Marrón Cálido (Hogar, Rústico) */
            --color-background: #fefce8; /* Amarillo Pálido/Crema (Calidez) */
            --color-text: #3f3f46; /* Gris Oscuro Cálido */
            --color-text-muted: #71717a;
            --color-modal-bg: #ffffff; /* Blanco */
            --color-border: #e7e5e4; /* Borde Piedra Claro */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 8px; /* Bordes más suaves */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; }
        /* Fuente Decorativa para el Logo Principal */
        h1.logo { font-family: 'Pacifico', cursive; color: var(--color-primary); font-weight: normal; }
        h1.page-title, h2.section-title, #modal-title { font-family: 'Roboto', sans-serif; font-weight: 700; }
        h1.page-title { color: var(--color-tertiary); }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700;}
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; box-shadow: var(--shadow-sm); transition: var(--transition-normal); background-color: white; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 500; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Roboto', sans-serif; font-size: 1rem; }
        .title-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #fff7ed; /* Naranja muy claro hover */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-secondary); /* Verde */ color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #3f6212; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #a1a1aa; color: #e5e7eb; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(63, 63, 70, 0.88); /* Overlay gris cálido */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 2.5rem; /* Más padding */
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            min-height: 350px; /* Altura mínima para carga */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: #f5f5f4; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }
        #modal-content {
            line-height: 1.75;
            color: var(--color-text);
            white-space: normal;
            overflow-y: auto;
            padding: 0 10px 1.5rem 10px;
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content::-webkit-scrollbar { width: 9px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-tertiary); font-weight: bold; }
        #modal-content em { color: var(--color-primary); font-style: italic; }
        /* Estilos específicos para listas en recetas */
        #modal-content ul, #modal-content ol { margin-left: 1.8em; margin-bottom: 1.3em; }
        #modal-content li { margin-bottom: 0.6em; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-secondary); /* Verde */ border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: bold; }
        #modal-content h1 { font-size: 1.5em; color: var(--color-tertiary); } /* Marrón para H1 */
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-primary); border-bottom: none; } /* Naranja para H3 */
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos para imagen y placeholder dentro del contenido */
        #modal-content .final-image { display: block; max-width: 90%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 6px solid #e7e5e4; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 500; color: var(--color-text); font-size: 1.3rem; font-family: 'Roboto'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #ffe4e6; color: #be185d; /* Rosa/Rojo error */ padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #fecdd3; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
        .title-item.hidden { display: none; } /* Para ocultar con buscador */
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-utensils mr-2 text-orange-500"></i> <!-- Icono utensilios -->
                     Recetas Caseras
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-medium">Nivel Medio: ¡A Cocinar!</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-10 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">El Sabor de Hacerlo Tú Mismo</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto">Encuentra inspiración y recetas deliciosas para llevar tus habilidades culinarias al siguiente nivel. Busca tu antojo o explora las opciones.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-8 max-w-2xl mx-auto">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Buscar receta (ej: lasaña, pollo al curry, tarta de manzana)...">
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-carrot text-orange-500 mr-2"></i> <!-- Icono zanahoria -->
                 Selección de Recetas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Calentando los fogones...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden">¡Ups! No encontramos recetas para tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Buscar Más Ideas Culinarias
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Preparando la receta...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - La imagen se añadirá aquí al final -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Recipe text (HTML) goes here -->
                     <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-stone-100 text-stone-600 py-6 mt-12 border-t border-stone-200">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Recetas generadas por IA con fines inspiracionales y educativos. ¡Ajusta a tu gusto!</p>
              <p class="mt-1">Recuerda siempre seguir buenas prácticas de seguridad alimentaria.</p>
              <p class="mt-2">© 2025 Recetas Caseras AI</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Carnes Rojas
            "Estofado de Ternera Clásico", "Solomillo de Cerdo a la Naranja", "Lomo de Cerdo Relleno de Manzana y Ciruelas", "Albóndigas Caseras en Salsa Española", "Chili con Carne Tradicional", "Roast Beef Jugoso al Horno", "Fajitas de Ternera con Pimientos y Cebolla", "Brochetas de Ternera Marinadas a la Parrilla", "Goulash Húngaro Auténtico", "Pastel de Carne Casero con Puré de Patata Gratinado", "Cordero Asado con Hierbas Provenzales", "Osso Buco a la Milanesa", "Ropa Vieja Cubana", "Entrecot a la Pimienta Verde", "Carrilleras de Cerdo al Vino Tinto",
            // Aves
            "Pollo al Curry Estilo Hindú", "Pollo Teriyaki Casero con Arroz", "Pechugas de Pollo Rellenas de Espinacas y Queso Feta", "Pollo Asado al Limón y Romero", "Muslos de Pollo en Salsa de Champiñones", "Fajitas de Pollo Caseras", "Tacos de Pollo Desmechado (Tinga)", "Quiche de Pollo y Champiñones", "Sopa de Pollo con Fideos y Verduras", "Ensalada César con Pollo a la Parrilla", "Pollo Kiev (Pechuga Rellena de Mantequilla de Ajo)", "Coq au Vin (Pollo al Vino Tinto)", "Arroz con Pollo Estilo Latinoamericano", "Brochetas de Pollo Satay con Salsa de Cacahuete", "Pato a la Naranja (Versión Simplificada)", "Pastel de Pollo y Verduras (Chicken Pot Pie)",
            // Pescados y Mariscos
            "Salmón al Horno con Verduras Asadas", "Merluza en Salsa Verde con Almejas", "Bacalao a la Vizcaína", "Dorada a la Sal", "Calamares en su Tinta", "Gambas al Ajillo", "Mejillones a la Marinera", "Paella de Marisco Mixta (Nivel Medio)", "Zarzuela de Pescado y Marisco", "Pastel de Cabracho", "Ceviche Clásico Peruano", "Brochetas de Langostinos y Piña a la Parrilla", "Sopa de Pescado y Marisco", "Lubina al Horno con Patatas Panadera", "Pulpo a la Gallega (Pulpo á Feira)", "Fish and Chips Casero con Salsa Tártara",
            // Vegetariano / Vegano (Nivel Medio)
            "Lasaña Vegetariana de Berenjenas y Calabacín", "Curry de Garbanzos y Espinacas con Leche de Coco", "Risotto de Champiñones y Espárragos", "Quiche de Verduras de Temporada", "Albóndigas de Lentejas en Salsa de Tomate", "Pastel de Pastor Vegetariano (con Lentejas o Soja Texturizada)", "Hamburguesas Caseras de Judías Negras o Garbanzos", "Moussaka Vegetariana", "Pimientos Rellenos de Arroz y Verduras", "Ensalada de Quinoa Completa con Verduras Asadas y Aguacate", "Tacos Vegetarianos de Lentejas o Coliflor", "Sopa Minestrone Italiana", "Falafel Casero con Salsa de Yogur y Menta", "Curry Tailandés Verde Vegetariano", "Chili sin Carne (con Variedad de Judías y Verduras)", "Gratinado de Patatas y Verduras con Bechamel Vegana", "Rollitos de Primavera Vegetarianos Caseros",
            // Pastas y Arroces
            "Lasaña Boloñesa Casera", "Pasta Carbonara Auténtica (sin nata)", "Pasta Puttanesca (con Anchoas, Alcaparras y Olivas)", "Pasta al Pesto Genovés Casero", "Canelones de Carne Gratinados con Bechamel", "Risotto alla Milanese (con Azafrán)", "Arroz Negro con Calamares", "Arroz al Horno Valenciano (simplificado)", "Paella Valenciana Tradicional (simplificada)", "Fideuá de Marisco", "Macarrones con Queso (Mac and Cheese) Cremosos al Horno", "Pasta con Salsa de Vodka", "Raviolis Caseros Rellenos de Ricotta y Espinacas (con masa comprada)", "Gnocchi de Patata Caseros con Salsa de Salvia y Mantequilla", "Pad Thai con Gambas o Tofu",
            // Sopas y Cremas
            "Sopa de Cebolla Francesa Gratinada", "Crema de Calabaza Asada con Jengibre", "Sopa de Lentejas Casera con Chorizo", "Gazpacho Andaluz Tradicional", "Salmorejo Cordobés", "Crema de Champiñones Casera", "Sopa de Tomate Asado con Albahaca", "Vichyssoise (Crema Fría de Puerro y Patata)", "Crema de Espárragos Verdes", "Sopa de Ajo Castellana (Sopa de Ajo)", "Caldo Gallego", "Crema de Zanahoria y Naranja", "Sopa de Tortilla Mexicana", "Bisque de Marisco (Langostinos o Cangrejo)",
            // Entrantes y Aperitivos
            "Tortilla de Patatas Española Jugosa", "Croquetas Caseras de Jamón o Pollo", "Empanada Gallega de Atún o Carne", "Provoleta al Horno con Tomate y Orégano", "Patatas Bravas con Salsa Casera", "Hummus Casero con Pan de Pita Tostado", "Guacamole Auténtico Mexicano", "Bruschettas Variadas (Tomate y Albahaca, Champiñones, Pimiento Asado)", "Rollitos de Berenjena Rellenos de Queso Ricotta", "Pimientos del Piquillo Rellenos de Bacalao o Carne", "Tabla de Quesos y Embutidos Bien Presentada", "Volovanes Rellenos (Champiñones, Marisco)", "Brandada de Bacalao", "Tzatziki Griego (Salsa de Yogur y Pepino)", "Vitello Tonnato (Ternera con Salsa de Atún - versión entrante)",
            // Guarniciones Elaboradas
            "Gratinado de Patatas Dauphinoise", "Puré de Patatas Cremoso Casero", "Patatas Asadas al Romero y Ajo", "Verduras Asadas Variadas al Horno", "Espárragos Trigueros a la Plancha con Sal Maldón", "Setas al Ajillo", "Pisto Manchego", "Escalivada Catalana (Pimiento, Berenjena, Cebolla Asados)", "Ratatouille Provenzal", "Coles de Bruselas Asadas con Bacon y Sirope de Arce", "Champiñones Rellenos al Horno", "Timbal de Arroz con Verduras",
            // Panadería Casera (Nivel Medio)
            "Pan Casero Básico (sin amasado o amasado simple)", "Focaccia Italiana con Romero y Sal Gruesa", "Pan de Molde Integral Casero", "Masa de Pizza Casera Fácil", "Panecillos de Leche Suaves", "Bretzels Caseros (Pretzels)", "Pan de Ajo Casero Trenzado", "Bagels Caseros (hervidos y horneados)", "Pan Naan Indio Casero", "Gressinis Italianos (Palitos de Pan)",
            // Repostería y Postres
            "Tarta de Manzana Casera Clásica (con masa quebrada)", "Tarta de Queso Estilo Nueva York (Cheesecake)", "Brownies de Chocolate Intensos y Húmedos", "Coulant de Chocolate (Volcán de Chocolate)", "Tiramisú Italiano Auténtico", "Mousse de Chocolate Casera", "Flan de Huevo Casero Tradicional", "Arroz con Leche Cremoso", "Natillas Caseras con Galleta María", "Crema Catalana Quemada", "Panna Cotta con Frutos Rojos", "Tarta Tatin de Manzana (Caramelizada)", "Bizcocho de Yogur Esponjoso", "Galletas de Avena y Pasas Caseras", "Profiteroles Rellenos de Nata con Salsa de Chocolate", "Leche Frita", "Torrijas de Leche Tradicionales", "Strudel de Manzana (con masa filo)", "Lemon Pie (Tarta de Limón y Merengue)", "Clafoutis de Cerezas",
            // Desayunos y Brunch
            "Tortitas Americanas Esponjosas (Pancakes)", "Gofres Caseros (Waffles)", "Huevos Benedictinos con Salsa Holandesa Casera", "Tostadas Francesas (French Toast) con Fruta", "Quiche Lorraine Individuales", "Frittata Italiana de Verduras y Queso", "Shakshuka (Huevos Pochados en Salsa de Tomate Especiada)", "Crepes Dulces Rellenos (Chocolate, Fruta, Nata)", "Smoothie Bowl Nutritivo con Toppings", "Avena Horneada con Frutas y Frutos Secos", "Muffins Caseros (Arándanos, Chocolate)", "Scones Británicos con Nata y Mermelada",
            // Técnicas / Conceptos
            "Cómo Hacer una Bechamel Perfecta sin Grumos", "Técnica para un Risotto Cremoso", "Cómo Hacer un Sofrito Base para Guisos", "Marinar Carnes para Mejor Sabor y Textura", "Clarificar Mantequilla (Ghee Casero)", "Hacer Caldo Casero (Pollo, Verduras, Pescado)", "Cómo Escalfar Huevos Correctamente", "Técnica de Salteado Wok (Stir-fry)", "Elaborar Vinagretas Caseras Variadas", "Manejo Básico de Masas (Pizza, Pan Simple)", "Reducción de Salsas al Vino", "Cómo Cocinar Legumbres Secas Correctamente", "Preparar un Roux (Base para Salsas)", "Tostar Frutos Secos y Especias para Intensificar Sabor", "Mise en Place: La Organización en la Cocina"
             // Añadir más si es necesario...
        ];
        const recipeThemes = [
            "platos principales reconfortantes", "recetas italianas caseras", "cocina española tradicional",
            "ideas vegetarianas completas", "postres caseros clásicos", "recetas con pollo versátiles",
            "guarniciones originales", "panadería casera fácil", "sopas y cremas nutritivas",
            "cocina asiática adaptada", "recetas de pescado al horno", "ideas para brunch casero",
            "recetas con legumbres", "entrantes para compartir", "cocina mexicana casera",
            "tartas dulces caseras", "recetas con carne de cerdo", "arroces y paellas", "cocina francesa básica",
            "galletas y brownies"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un chef casero experimentado y amigable. Tu tarea es proporcionar una receta de cocina casera de nivel medio, detallada y fácil de seguir para el plato o concepto indicado. Incluye siempre: 1. Título claro. 2. Breve descripción apetitosa del plato. 3. Nivel de dificultad (Medio). 4. Tiempo estimado de preparación y cocción. 5. Número de porciones. 6. Lista completa de ingredientes con cantidades precisas (en sistema métrico preferiblemente). 7. Instrucciones paso a paso, numeradas y muy claras. 8. Consejos útiles, posibles variaciones o sugerencias de acompañamiento. Usa un tono cercano y alentador. El objetivo es una receta completa y bien explicada de aproximadamente 1200-1300 palabras. Basa tu receta únicamente en el siguiente nombre o concepto:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un recetario. Genera exactamente 15 nombres de recetas caseras de nivel medio (ni muy básicas ni extremadamente complejas) o conceptos de cocina relevantes para este nivel. Cubre diferentes tipos de platos (principales, postres, entrantes, etc.). Devuelve *solo* la lista de nombres/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ========== (Sin cambios funcionales)
        async function fetchTextFromApi(prompt, config) { /* ... */
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intenta de nuevo.`);
                 throw new Error(`Error de comunicación con la API: ${error.message}`);
             }
         }
        // Renombrado para claridad
        async function fetchRecipeText(recipeTitle) {
            const text = await fetchTextFromApi(recipeTitle, textApiConfig);
              if (text.trim().length < 500 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de")) {
                   // Umbral más bajo porque algunas recetas son más cortas
                   throw new Error("La IA no pudo generar una receta adecuada o suficientemente detallada para este plato.");
               }
             return text;
        }
        async function fetchGeneratedTitles() { /* ... */
             const randomTheme = getRandomElement(recipeThemes) || "recetas caseras variadas";
             const specificPrompt = `Genera 15 nombres de recetas caseras de nivel medio o conceptos de cocina sobre ${randomTheme}`;
             console.log("Generating titles with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 100); // Ajustar longitud si es necesario
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de recetas.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a FOTO DE COMIDA
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "delicious homemade dish";
            // Prompt ENFOCADO en foto de plato terminado, apetitoso.
            const enhancedPrompt = `High-quality photo of a delicious homemade '${safePromptText}'. Appetizing presentation, good lighting, focus on the finished dish. Food photography style, slightly rustic or modern kitchen background (blurred).`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, recipe text, instructions, diagram, chart, drawing, illustration, cartoon, multiple dishes, messy kitchen, cooking process, hands cooking, ugly food, blurry, low quality, watermark, signature";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText) { // Renombrar a formatRecipeText sería más preciso, pero mantenemos la estructura
            if (!rawText) return '';
            let formatted = rawText.trim();

            // Correcciones básicas (igual que antes, por si acaso)
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); // Podría ser útil para conversiones de Tª

            // Encabezados (ajustar si la IA usa otros patrones)
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');

            // Negrita y Cursiva
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // INTENTO de formatear listas (puede necesitar ajustes según la salida de la IA)
            // Convertir líneas que empiezan con números o guiones en listas
            formatted = formatted.replace(/^(\d+\.\s+)(.*)$/gm, '<li>$2</li>'); // Items numerados
            formatted = formatted.replace(/^[\-\*]\s+(.*)$/gm, '<li>$1</li>');   // Items con guión/asterisco

            // Agrupar <li> consecutivos en <ol> o <ul>
            // Esto es más complejo y puede fallar si hay texto entre items. Una aproximación simple:
            formatted = formatted.replace(/^(<li>.*<\/li>\s*)+/gm, (match) => {
                if (match.includes('<li') && match.includes('</li>')) { // Asegurar que son items de lista
                    // Determinar si es ol o ul (si el primer item tenía número original)
                    // Como la regex anterior quita el número, esta heurística no es perfecta.
                    // Asumimos ul por defecto si no detectamos un patrón numérico inicial fuerte.
                    // O podemos simplemente usar <ul> siempre.
                    return `<ul>\n${match.trim()}\n</ul>`;
                }
                return match; // Devolver sin cambios si no parece una lista
            });
            // Reemplazar <ol> si detectamos números (esto es una simplificación)
            formatted = formatted.replace(/<ul>\s*<li>(\d+)/g, '<ol>\n<li>$1'); // Si el primer item empieza con número, cambiar a <ol>


            // Párrafos (como antes)
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                // Si ya es un encabezado, lista o fórmula, dejarlo como está
                if (block.startsWith('<h') || block.startsWith('<ul') || block.startsWith('<ol') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' '); // Reemplaza saltos internos con espacio
                // Evitar envolver <li> sueltos en <p>
                 if (block.startsWith('<li>') && block.endsWith('</li>')) return block;
                return `<p>${content}</p>`;
            }).join('');

            // Limpieza final de saltos de línea extra alrededor de listas/encabezados
            formatted = formatted.replace(/\n\s*\n/g, '\n');

            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Sin cambios funcionales)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (Sin cambios funcionales)
        function getRandomElement(arr) { /* ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar alfabéticamente puede ser bueno para recetas
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay recetas disponibles por ahora.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... */
            if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             const addedTitles = [];
             newTitles.forEach(title => {
                 if (!existingTitles.has(title)) {
                      const newItem = createTitleItem(title);
                      titleListContainer.appendChild(newItem);
                      addedTitles.push(newItem); // Guardar referencia si es necesario
                 }
             });
              // Re-aplicar filtro actual si existe
             filterTitles(searchInput.value);
        }

        // *** MODIFIED: handleTitleClick para usar fetchRecipeText ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawRecipeText = await fetchRecipeText(title); // Usar la función renombrada
                const formattedRecipe = formatExplanationText(rawRecipeText); // Usar función de formato

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedRecipe; // Poner receta primero
                modalStoryContentArea.classList.remove('content-hidden');

                modalContent.scrollTop = 0; // Resetear scroll DESPUÉS de que el contenido es visible
                console.log("Scroll set to 0 after content visible");

                // Preparar y añadir placeholder de imagen DENTRO de modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-camera placeholder-icon"></i> <!-- Icono placeholder cámara -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando foto del plato...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Crear y añadir elemento imagen
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Foto de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-image-slash placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">No se pudo cargar la foto.</p>
                    `;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Añadir img al final
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">Error al generar URL de imagen.</p>
                    `;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error al cargar la receta: ${error.message}`; // Mensaje error específico
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
            }
        }

        async function handleGenerateMoreTitles() { /* ... */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando inspiración...'; // Texto temático
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     appendTitles(newTitles);
                 } else {
                     alert("No pudimos encontrar más ideas por ahora. ¡Intenta más tarde!"); // Texto temático
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error buscando ideas: ${error.message}`); // Texto temático
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Buscar Más Ideas Culinarias'; // Texto temático
             }
         }

         // *** Search Filter Function (sin cambios) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); // Normalizar para quitar acentos
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;

             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) {
                     visibleCount++;
                 }
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (Sin cambios funcionales)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡Error en la cocina! No se cargaron los ingredientes de la página.</p>'; // Temático
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            searchInput.addEventListener('input', (event) => { filterTitles(event.target.value); });
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden'); // Ocultar al inicio
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>