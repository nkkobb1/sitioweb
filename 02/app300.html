<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecos de África: Mitos y Culturas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fonts: Readable Serif + Clean Sans-serif -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&family=Nunito+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Cultura Africana --- */
        :root {
            --color-primary: #E87B00; /* Warm Orange/Ochre */
            --color-secondary: #006400; /* Deep Green */
            --color-tertiary: #D2B48C; /* Tan/Light Brown */
            --color-background: #FFF8F0; /* Very Light Cream/Off-white */
            --color-text: #4A3F35; /* Dark Brown */
            --color-text-muted: #8B7D6B; /* Muted Brown/Gray */
            --color-modal-bg: #F5EDE3; /* Light Beige */
            --color-border: #C1A78A; /* Slightly Darker Beige/Brown */
            --color-locked-bg: #EAE0D6; /* Locked background */
            --color-locked-text: #A99985; /* Locked text */
            --color-error-bg: #fde8e8;
            --color-error-text: #9b2c2c;
            --color-error-border: #fecaca;

            --shadow-sm: 0 2px 4px rgba(74, 63, 53, 0.1);
            --shadow-md: 0 5px 10px rgba(74, 63, 53, 0.15);
            --shadow-lg: 0 10px 20px rgba(74, 63, 53, 0.18), 0 3px 6px rgba(74, 63, 53, 0.12);
            --border-radius: 5px;
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; /* Optional: subtle pattern bg */ background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23c1a78a' fill-opacity='0.08' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E"); }
        h1, h2, h3, h4, .logo, #generate-more-btn, #unlock-ad-button, #modal-title, #loading-text, .section-title { font-family: 'Nunito Sans', sans-serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.05); }
        h2.section-title { color: var(--color-secondary); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; font-size: 1.7rem; text-align: center; }
        .navbar { background-color: rgba(245, 237, 227, 0.9); backdrop-filter: blur(4px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }

        /* Search Bar */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Merriweather'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic;}
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(232, 123, 0, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        /* Title List & Items */
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: #fff; padding: 1rem 1.2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between; min-height: 60px; font-family: 'Merriweather', serif; font-size: 1.02rem; position: relative; overflow: hidden; border-left: 5px solid var(--color-tertiary); }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-left-color: var(--color-primary); color: var(--color-primary); border-color: var(--color-primary); background-color: #FFFDFB; }
        .title-item .title-text { flex-grow: 1; margin-right: 10px; font-weight: 700;}
        .title-item .lock-icon { color: var(--color-text-muted); font-size: 1.1rem; flex-shrink: 0; }

        /* Locked Title Items */
        .title-item.locked { background-color: var(--color-locked-bg); color: var(--color-locked-text); cursor: pointer; border-color: #D1C4B8; border-left-color: var(--color-locked-text); opacity: 0.9; }
        .title-item.locked:hover { transform: none; box-shadow: var(--shadow-sm); background-color: var(--color-locked-bg); color: var(--color-locked-text); border-left-color: var(--color-primary); }
        .title-item.locked .title-text { font-weight: 400; font-style: italic; }
        .title-item.locked .lock-icon { color: var(--color-primary); animation: pulse-lock 1.6s infinite ease-in-out; }
        @keyframes pulse-lock { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.1); opacity: 1; } }

        /* Generate More Button */
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-text-muted); color: var(--color-background); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        /* Story Modal (Principal) */
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(74, 63, 53, 0.9); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border: 2px solid var(--color-border); border-radius: var(--border-radius); padding: 1.5rem 2rem; max-width: 980px; width: 95%; max-height: 90vh; min-height: 450px; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: rgba(193, 167, 138, 0.7); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }

        /* Modal Content Area (Scrollable) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; margin-bottom: 1rem; scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border); }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 8px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.6em; font-size: 1.05rem; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; font-family: 'Nunito Sans'; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Nunito Sans', sans-serif; margin-top: 2.1em; margin-bottom: 1.1em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.6em; color: var(--color-primary); border-bottom-width: 2px; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-primary); border-bottom: none; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; font-style: italic; font-family: 'Merriweather'; text-transform: none; letter-spacing: normal;}
        /* Imagen Final */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1.5rem auto; border: 2px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 2.5rem auto 1.5rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 5px solid rgba(193, 167, 138, 0.6); width: 45px; height: 45px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-secondary);} /* Green icon */

        /* Chat Section */
        #chat-section { border-top: 1px dashed var(--color-border); padding-top: 1.2rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(245, 237, 227, 0.5); scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; font-size: 1rem; font-family: 'Merriweather'; }
        .user-message { background-color: var(--color-tertiary); color: var(--color-text); margin-left: auto; text-align: right; border-radius: var(--border-radius) 0 var(--border-radius) var(--border-radius); }
        .ai-message { background-color: #E0F2E0; /* Light Green */ color: var(--color-text); margin-right: auto; text-align: left; border-radius: 0 var(--border-radius) var(--border-radius) var(--border-radius); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Merriweather'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 2px rgba(0, 100, 0, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-secondary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #004d00; /* Darker Green */ }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Nunito Sans'; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* --- Loading Overlay con Memory Game --- */
        #modal-loading { text-align: center; padding: 1rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(245, 237, 227, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #modal-loading.active { display: flex; }
        #loading-status { margin-bottom: 1.5rem; }
        #loading-text { font-weight: 700; color: var(--color-primary); font-size: 1.4rem; margin-bottom: 0.6rem; }
        #game-status-message { font-weight: 700; color: var(--color-secondary); font-size: 1.1rem; font-family: 'Nunito Sans'; min-height: 20px; /* Space for text */ }

        /* Memory Game Board & Cards */
        #memory-game-board {
            display: grid;
            grid-template-columns: repeat(4, 60px); /* Adjust size as needed */
            grid-template-rows: repeat(4, 60px);    /* Adjust size as needed */
            gap: 8px;
            margin-bottom: 1.5rem;
            perspective: 1000px; /* For 3D flip effect */
        }
        .memory-card {
            width: 60px; height: 60px;
            background-color: var(--color-secondary); /* Back of card */
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            box-shadow: var(--shadow-sm);
        }
        .memory-card.flipped {
            transform: rotateY(180deg);
        }
        .memory-card.matched {
            cursor: default;
            opacity: 0.5; /* Indicate matched */
            transform: rotateY(180deg) scale(0.95); /* Keep flipped, slightly shrink */
            background-color: var(--color-tertiary) !important; /* Show match color */
        }
        .card-face { /* Common style for front and back */
            position: absolute;
            width: 100%; height: 100%;
            backface-visibility: hidden; /* Hide the back side when showing front, etc. */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius);
        }
        .card-front { /* Icon side */
            background-color: var(--color-modal-bg);
            color: var(--color-primary);
            font-size: 2rem;
            transform: rotateY(180deg); /* Initially hidden */
        }
        .card-back { /* Default back shown */
             background-color: var(--color-secondary);
             /* Optional: add a pattern or symbol to the back */
             /* color: rgba(255,255,255,0.3); font-size: 1.5rem; */
        }
        /* End Memory Game Styles */

        #loading-final-text { font-weight: 400; color: var(--color-text-muted); font-size: 1rem; font-family: 'Merriweather'; font-style: italic; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Merriweather'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(74, 63, 53, 0.96); /* Dark Brown */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-tertiary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-tertiary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-tertiary); color: var(--color-secondary); transform: scale(1.1); }

        /* Unlock Modal */
        #unlock-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(74, 63, 53, 0.88); display: none; align-items: center; justify-content: center; z-index: 70; padding: 1rem; font-family: 'Merriweather', serif; }
        #unlock-modal.active { display: flex; }
        .unlock-modal-content { background-color: var(--color-modal-bg); padding: 2.5rem 2rem 2rem 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); text-align: center; max-width: 500px; width: 90%; position: relative; border: 2px solid var(--color-border); }
        .unlock-modal-close-btn { position: absolute; top: 10px; right: 10px; background: transparent; border: none; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; line-height: 1; transition: color 0.2s ease; }
        .unlock-modal-close-btn:hover { color: var(--color-primary); }
        #unlock-modal h3 { font-family: 'Nunito Sans', sans-serif; color: var(--color-primary); font-size: 1.7rem; margin-bottom: 1rem; }
        #unlock-modal p { color: var(--color-text); margin-bottom: 1.8rem; line-height: 1.7; font-size: 1.1rem; }
        #unlock-ad-button { background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.9rem 2.2rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito Sans', sans-serif; font-size: 1.2rem; cursor: pointer; transition: var(--transition-normal); margin-bottom: 1.8rem; display: inline-block; box-shadow: var(--shadow-md); text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        #unlock-ad-button:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: translateY(-2px); }
        #unlock-ad-button:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; box-shadow: none; transform: none; }
        #unlock-countdown { font-size: 2rem; font-weight: 700; color: var(--color-secondary); font-family: 'Nunito Sans', sans-serif; min-height: 35px; }
        #unlock-status { font-size: 1rem; color: var(--color-text-muted); margin-top: 0.6rem; font-style: italic; }

    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-12">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                  <h1 class="logo text-3xl sm:text-4xl">
                      <i class="fas fa-drum mr-2 text-yellow-700"></i> <!-- Drum -->
                      <i class="fas fa-mask mr-2 text-green-800"></i> <!-- Mask -->
                       Ecos de África
                      <i class="fas fa-feather-alt ml-2 text-orange-600"></i> <!-- Feather (Storytelling) -->
                 </h1>
             </div>
             <span class="text-xs text-gray-700 font-sans tracking-wider uppercase">» Donde los Ancestros Hablan «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Tejiendo Sabiduría Ancestral</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-4xl mx-auto font-light">Descubre la riqueza de mitos, leyendas, historia y tradiciones orales del vasto continente africano. Escucha las voces del pasado.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar mito, reino, símbolo, proverbio...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-yellow-700 mr-2"></i> <!-- Open Book/Scroll -->
                 Pergaminos de la Tradición
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando a los Griots...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» El eco de esa historia aún no resuena aquí «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Relatos (40)
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal (Principal) -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>
             <!-- Loading Overlay con Memory Game -->
             <div id="modal-loading">
                 <div id="loading-status">
                     <p id="loading-text">Encendiendo la Hoguera del Relato...</p>
                     <p id="game-status-message">Encuentra los pares...</p> <!-- Status for Memory Game -->
                 </div>
                 <!-- Memory Game Board -->
                 <div id="memory-game-board">
                     <!-- Cards will be generated here by JS -->
                 </div>
                 <p id="loading-final-text">Mientras la historia se revela, empareja los símbolos ancestrales.</p>
             </div>
             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content"></div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                      <h3 class="text-lg font-semibold text-center mb-2 text-secondary font-nunito">Pregúntale al Anciano</h3>
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando la sabiduría...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Profundizar en este relato...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                     <i class="fas fa-exclamation-triangle"></i>
                     <span id="modal-error-message"></span>
                 </div>
             </div>
         </div>
     </div>

      <!-- Unlock Modal -->
      <div id="unlock-modal">
          <div class="unlock-modal-content">
              <button class="unlock-modal-close-btn" id="unlock-modal-close" aria-label="Cerrar">&times;</button>
              <h3><i class="fas fa-key mr-2 text-yellow-600"></i> Desbloquear Sabiduría</h3>
              <p>Este conocimiento requiere una ofrenda. Haz clic en "ANUNCIO" y espera 5 segundos para mostrar respeto y acceder.</p>
              <button id="unlock-ad-button">
                  <i class="fas fa-gift mr-2"></i> ANUNCIO (Hacer Ofrenda)
              </button>
              <div id="unlock-countdown"></div>
              <div id="unlock-status"></div>
              <input type="hidden" id="unlock-target-title" value="">
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada de Cultura Africana">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-400 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Relatos e información cultural generados por IA, inspirados en la vasta herencia africana.</p>
              <p class="mt-1">Explora con respeto. Consulta fuentes académicas y culturales para un estudio profundo.</p>
              <p class="mt-2">© 2025 Griot Digital</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const adUrl = 'https://increasingbelieveabonnement.com/pcmu77j4?key=1f38fa224b5ecf757563a32d2d8ac126';
        const unlockCountdownSeconds = 5;
        const lockPercentage = 0.7; // 70% initially locked
        const themePrefix = 'AfricanCulture'; // Unique prefix for this theme
        const userUnlockedKey = `unlockedTitles_${themePrefix}`;
        const initialLockStateSetFlagKey = `initialLockStateSet_${themePrefix}`;
        const initialLockedSetKey = `initialLockedSet_${themePrefix}`;

        const predefinedTitles = [
            // Mitos y Leyendas (Ejemplos Regionales)
            "Anansi la Araña: Historias de Astucia de África Occidental", "Mami Wata: Espíritu del Agua en Mitos Costeros", "Orishas Yoruba: Poderes y Dominios (Shangó, Yemayá, Oshún)", "Mitos de Creación Zulú: Unkulunkulu y el Origen", "Leyendas del Rey León Sundiata Keita (Imperio de Malí)", "El Pájaro de Zimbabue: Símbolo y Misterio", "Cuentos San (Bosquimanos): Tradición Oral del Kalahari", "Mitos Dogon: Cosmología y los Nommo", "Leyendas Bereberes del Desierto del Sahara", "Cuentos de Hienas y Liebres: Fábulas de África Oriental", "Aboke: Espíritus del Bosque en África Central", "Leyenda de la Reina de Saba y el Rey Salomón (Etiopía)", "Mitos de Creación Egipcios: Ra, Osiris e Isis", "Historias de los Loa del Vudú (Origen Dahomey)",
            // Reinos e Imperios Históricos
            "El Antiguo Reino de Ghana: Comercio de Oro y Sal", "El Imperio de Malí: Mansa Musa y la Peregrinación a La Meca", "El Imperio Songhai: Poder Militar y Centros de Saber (Tombuctú)", "El Reino de Benín: Bronces y Arte Cortesano", "Gran Zimbabue: Arquitectura Monumental de Piedra", "El Reino de Aksum: Comercio, Estelas y Cristianismo Temprano (Etiopía)", "El Imperio Kanem-Bornu: Poder en la Cuenca del Chad", "El Reino del Congo: Interacción con los Portugueses", "Los Reinos Hausa: Ciudades-Estado y Comercio Transahariano", "El Reino de Kush (Nubia): Faraones Negros y Pirámides", "El Imperio Ashanti: El Taburete Dorado y Resistencia Colonial", "El Reino de Dahomey: Las Amazonas y el Comercio de Esclavos", "Civilización Nok: Las Primeras Terracotas de África Occidental", "Cartago: Potencia Púnica del Norte de África",
            // Cultura y Tradiciones
            "Griots: Guardianes de la Historia Oral en África Occidental", "Adinkra: Símbolos de Sabiduría y Filosofía Ashanti (Ghana)", "Mascaradas Africanas: Significado Ritual y Social", "Música y Danza: Diversidad Rítmica del Continente", "Tejidos Tradicionales: Kente, Bogolan (Mudcloth), Ankara", "Ritos de Pasaje: Iniciación a la Edad Adulta", "Medicina Tradicional Africana: Curanderos y Hierbas", "Proverbios Africanos: Sabiduría Condensada", "Arquitectura Vernácula: Construcciones de Adobe, Paja y Piedra", "Sistemas de Creencias Tradicionales: Animismo y Culto a los Ancestros", "Festivales y Celebraciones Culturales", "Arte Rupestre Africano: Testimonios Prehistóricos", "Escultura Africana: Diversidad de Estilos y Materiales", "Juegos Tradicionales Africanos (Mancala, etc.)", "Gastronomía Africana: Ingredientes y Platos Regionales",
            // Figuras y Conceptos
            "Nelson Mandela y la Lucha contra el Apartheid", "Haile Selassie: Emperador de Etiopía y Figura Rastafari", "Reina Nzinga de Ndongo y Matamba: Resistencia Anticolonial", "Shaka Zulú: Innovador Militar y Líder", "Patrice Lumumba: Independencia del Congo", "Thomas Sankara: Revolución en Burkina Faso", "Kwame Nkrumah: Panafricanismo y la Independencia de Ghana", "Ubuntu: Filosofía de Humanidad y Comunidad", "Sankofa: Aprender del Pasado para Construir el Futuro (Símbolo Adinkra)", "Ma'at: Concepto Egipcio de Verdad, Justicia y Orden Cósmico", "La Diáspora Africana: Conexiones Culturales", "Influencia de las Lenguas Africanas (Bantú, Swahili, Yoruba)", "El Movimiento Panafricanista: Unidad e Identidad", "Impacto del Comercio Transahariano", "Consecuencias de la Trata de Esclavos Transatlántica",
            // Arte y Estética
            "Arte Yoruba: Figuras Ibeji y Máscaras Gelede", "Arte Dogon: Esculturas y Máscaras Ceremoniales", "Arte Fang: Figuras de Relicario (Gabón)", "Arte Makonde: Esculturas Shetani (Tanzania, Mozambique)", "Pinturas Ndebele: Diseños Geométricos Murales (Sudáfrica)", "Joyería Tuareg: Plata y Diseños Intrincados", "Cestería Africana: Técnicas y Usos", "Cerámica Tradicional Africana", "Instrumentos Musicales Africanos (Djembe, Kora, Mbira)", "Arte Contemporáneo Africano: Nuevas Expresiones",
            //... (Continuar hasta 400+, cubriendo más etnias, regiones, conceptos específicos, figuras menos conocidas, etc.)
            "Mitos de Creación Khoisan", "El Diluvio en las Tradiciones Africanas", "Héroes Culturales: Figuras Fundadoras de Pueblos", "Animales en el Folclore Africano (Tortuga, Leopardo, Elefante)", "El Papel de la Mujer en las Sociedades Tradicionales", "Sistemas de Parentesco y Organización Social", "Conceptos de Tiempo y Espacio en Cosmologías Africanas", "La Adivinación en África (Ifá Yoruba, etc.)", "Influencia del Islam en el Norte y Oeste de África", "Influencia del Cristianismo (Iglesias Africanas Independientes, etc.)", "La Lucha por la Independencia en el Siglo XX", "Desafíos Postcoloniales", "Literatura Oral Africana: Poesía, Épica", "Escritores Africanos Modernos (Chinua Achebe, Wole Soyinka, Ngũgĩ wa Thiong'o)", "Cine Africano: Nollywood y Otras Industrias", "Moda Africana Contemporánea"
        ];
        const cultureThemes = [
            "mitos Yoruba", "leyendas Zulú", "reino de Malí", "cultura Ashanti", "arte Dogon", "proverbios africanos", "historia de Etiopía", "música de África Occidental", "panafricanismo", "ritos de paso", "símbolos Adinkra", "folclore San", "reino de Benín", "tradición oral", "máscaras africanas", "reino de Ghana", "figuras históricas africanas", "espiritualidad africana", "arquitectura vernácula", "tejidos Kente"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un sabio Griot digital, un custodio de la memoria ancestral africana. Narra la historia, mito, leyenda o concepto cultural consultado con profundidad, respeto y elocuencia. Contextualiza la información dentro de su marco cultural y geográfico específico. Enfatiza la riqueza de la tradición oral, el simbolismo y la sabiduría contenida. Evita generalizaciones simplistas sobre el continente. Extensión objetivo: 1200-1300 palabras. Comparte tu conocimiento sobre:",
            timeoutSeconds: 180
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un aprendiz del Griot. Responde preguntas específicas sobre el relato o concepto cultural recién compartido. Clarifica detalles sobre personajes, simbolismos, prácticas o contexto histórico-cultural. Sé respetuoso, conciso y céntrate estrictamente en la información proporcionada por el Griot.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Genera una lista concisa de 40 temas específicos y variados sobre culturas, mitos, historia y tradiciones de diferentes regiones de África. Incluye nombres de etnias, reinos, figuras, conceptos o tipos de relatos. Devuelve *solo* la lista de ítems, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60
        };
         // --- NEW: Symbols for Memory Game ---
        const memoryGameSymbols = [ // Needs pairs, so 8 unique symbols for a 4x4 grid
            'fa-drum', 'fa-mask', 'fa-feather-alt', 'fa-book-open', // From logo/title
            'fa-ankh',           // Symbol (Adinkra-like)
            'fa-mountain-sun',   // Landscape/Nature (Kilimanjaro?)
            'fa-hippo',          // Animal
            'fa-comments'        // Storytelling/Oral Tradition
        ];

        // ========== DOM ELEMENTS ==========
        // (Incluir los del Memory Game)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // --- Memory Game Elements ---
        const memoryGameBoard = document.getElementById('memory-game-board');
        const gameStatusMessage = document.getElementById('game-status-message');
        const loadingText = document.getElementById('loading-text');
        // --- Unlock Modal Elements ---
        const unlockModal = document.getElementById('unlock-modal');
        const unlockModalCloseBtn = document.getElementById('unlock-modal-close');
        const unlockAdButton = document.getElementById('unlock-ad-button');
        const unlockCountdownDisplay = document.getElementById('unlock-countdown');
        const unlockStatusDisplay = document.getElementById('unlock-status');
        const unlockTargetTitleInput = document.getElementById('unlock-target-title');


        // ========== NEW: MEMORY MATCH GAME LOGIC ==========
        const MemoryGame = {
            boardElement: null,
            statusElement: null,
            symbols: [],
            cards: [], // { id, symbol, element, flipped, matched }
            flippedCards: [],
            matchedPairs: 0,
            totalPairs: 0,
            canFlip: true, // To prevent clicking too fast
            isRunning: false,

            init(boardElement, statusElement, symbols) {
                this.boardElement = boardElement;
                this.statusElement = statusElement;
                 // Ensure we have pairs of symbols
                if (symbols.length * 2 !== boardElement.children.length && boardElement.children.length !== 16) { // Check default 4x4=16
                    console.warn(`Memory Game: Symbol count (${symbols.length}) doesn't match board size. Adjusting symbols or board grid.`);
                    // Simple fix: Use first 8 symbols for a 4x4 grid
                    this.symbols = symbols.slice(0, 8);
                } else {
                     this.symbols = symbols;
                }
                this.totalPairs = this.symbols.length;
                 console.log("Memory Game Initialized with", this.totalPairs, "pairs.");
            },

            start() {
                if (this.isRunning) return;
                console.log("Starting Memory Game");
                this.isRunning = true;
                this.resetGame();
                this.createBoard();
                this.updateStatus();
            },

            stop() {
                if (!this.isRunning) return;
                console.log("Stopping Memory Game");
                this.isRunning = false;
                if (this.boardElement) this.boardElement.innerHTML = ''; // Clear board
                this.cards = [];
                this.flippedCards = [];
            },

            resetGame() {
                this.cards = [];
                this.flippedCards = [];
                this.matchedPairs = 0;
                this.canFlip = true;
                if (this.boardElement) this.boardElement.innerHTML = '';
            },

            createBoard() {
                const gameSymbols = [...this.symbols, ...this.symbols]; // Duplicate symbols for pairs
                this.shuffle(gameSymbols);

                this.boardElement.innerHTML = ''; // Clear previous board
                gameSymbols.forEach((symbol, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.classList.add('memory-card');
                    cardElement.dataset.index = index;

                    const cardFaceBack = document.createElement('div');
                    cardFaceBack.classList.add('card-face', 'card-back');
                    // Optional: Add symbol to back? cardFaceBack.innerHTML = `<i class="fas fa-question"></i>`;

                    const cardFaceFront = document.createElement('div');
                    cardFaceFront.classList.add('card-face', 'card-front');
                    cardFaceFront.innerHTML = `<i class="fas ${symbol}"></i>`; // Use Font Awesome class

                    cardElement.appendChild(cardFaceBack);
                    cardElement.appendChild(cardFaceFront);

                    cardElement.addEventListener('click', () => this.handleCardClick(cardElement, index));

                    this.boardElement.appendChild(cardElement);
                    this.cards.push({ id: index, symbol: symbol, element: cardElement, flipped: false, matched: false });
                });
            },

            shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            },

            handleCardClick(cardElement, index) {
                if (!this.canFlip || !this.isRunning) return;
                const card = this.cards[index];
                if (card.flipped || card.matched) return; // Ignore already flipped or matched

                this.flipCard(cardElement, index);
                card.flipped = true;
                this.flippedCards.push(card);

                if (this.flippedCards.length === 2) {
                    this.canFlip = false; // Disable flipping while checking
                    this.checkForMatch();
                }
            },

            flipCard(cardElement, index) {
                 cardElement.classList.add('flipped');
            },

            unflipCards() {
                this.flippedCards.forEach(card => {
                    if (!card.matched) {
                        card.element.classList.remove('flipped');
                        card.flipped = false;
                    }
                });
                this.flippedCards = [];
                this.canFlip = true; // Re-enable flipping
            },

            checkForMatch() {
                const [card1, card2] = this.flippedCards;
                if (card1.symbol === card2.symbol) {
                    // Match found
                    this.handleMatch(card1, card2);
                } else {
                    // No match, unflip after a delay
                    setTimeout(() => this.unflipCards(), 1000); // 1 second delay
                }
            },

            handleMatch(card1, card2) {
                card1.matched = true;
                card2.matched = true;
                card1.element.classList.add('matched');
                card2.element.classList.add('matched');

                this.matchedPairs++;
                this.flippedCards = []; // Clear flipped cards
                this.canFlip = true; // Re-enable flipping immediately after match
                this.updateStatus();

                if (this.isGameWon()) {
                    console.log("Memory Game Won!");
                    // Optionally add a 'Game Won!' message or effect
                    this.statusElement.textContent = "¡Todos los pares encontrados!";
                }
            },

             updateStatus() {
                 if(this.statusElement) {
                    this.statusElement.textContent = `Pares encontrados: ${this.matchedPairs} / ${this.totalPairs}`;
                 }
             },

            isGameWon() {
                return this.matchedPairs === this.totalPairs;
            }
        };


        // ========== LocalStorage Functions (Unlock Persistence & Initial Lock State) ==========
        // (No changes needed from the previous 'Crossover' example)
        function getJsonFromStorage(key) { try { const stored = localStorage.getItem(key); return stored ? JSON.parse(stored) : null; } catch (e) { console.error(`Error reading key ${key} from localStorage:`, e); return null; } }
        function setJsonInStorage(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error(`Error saving key ${key} to localStorage:`, e); } }
        function getUnlockedTitles() { const unlockedArray = getJsonFromStorage(userUnlockedKey); return new Set(unlockedArray || []); }
        function saveUnlockedTitles(unlockedSet) { setJsonInStorage(userUnlockedKey, Array.from(unlockedSet)); }
        function isTitleUnlockedByUser(title) { return getUnlockedTitles().has(title); }
        function unlockTitlePermanentlyByUser(title) { if (!title) return; const unlockedByUser = getUnlockedTitles(); if (!unlockedByUser.has(title)) { unlockedByUser.add(title); saveUnlockedTitles(unlockedByUser); console.log(`Title permanently unlocked by user: ${title}`); updateTitleItemLockStatus(title, false); } }
        function loadInitialLockedSet() { const lockedArray = getJsonFromStorage(initialLockedSetKey); return new Set(lockedArray || []); }
        function saveInitialLockedSet(lockedSet) { setJsonInStorage(initialLockedSetKey, Array.from(lockedSet)); }
        function isInitialLockStateSet() { return localStorage.getItem(initialLockStateSetFlagKey) === 'true'; }
        function setInitialLockStateFlag() { localStorage.setItem(initialLockStateSetFlagKey, 'true'); }
        function isTitleInitiallyLocked(title) { return initialLockedTitles.has(title); }


        // ========== API FUNCTIONS ==========
        // (Prompts and messages adapted)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Actúa como un aprendiz del Griot. Responde preguntas específicas sobre '${currentTopicTitle}'. Clarifica detalles culturales, simbolismos o contexto. Sé respetuoso y conciso.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Los ancestros no responden ahora. Los servidores están ocupados. Intenta de nuevo.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("El Griot guardó silencio (respuesta vacía). Intenta de nuevo.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La consulta tardó demasiado (>${config.timeoutSeconds}s). La conexión es lenta o el Griot está meditando. Inténtalo de nuevo.`);
                 throw new Error(error.message || "Error desconocido contactando la memoria ancestral.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Error interno: Contexto del relato perdido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(cultureThemes) || "culturas africanas variadas";
             const specificPrompt = `Genera 40 temas específicos sobre ${randomTheme}`;
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 10) throw new Error("La IA no encontró suficientes relatos nuevos.");
                     return titles.slice(0, 40);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "African culture representation";
            const enhancedPrompt = `Vibrant digital painting illustrating '${safePromptText}'. Style inspired by traditional African art forms (e.g., masks, textiles like Kente or Bogolan, sculpture), rich earth tones and vibrant accent colors. Focus on cultural elements, storytelling, community, nature. Avoid stereotypes. Abstract or semi-abstract representation preferred. No text, words, logos.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, poverty, war, suffering, primitive stereotypes";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (igual que antes) ... */ if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted; }

        // ========== MODAL FUNCTIONS ==========
        // (showModal, hideModal, resetModalState adaptados para Memory Game)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { storyModal.classList.remove('active'); if (!imageFullscreenOverlay.classList.contains('active') && !unlockModal.classList.contains('active')) { document.body.style.overflow = ''; } modalTextArea.scrollTop = 0; MemoryGame.stop(); /* <<< Stop Memory Game */ resetModalState(); }
        function resetModalState() { modalLoadingIndicator.classList.remove('active'); modalStoryContentArea.classList.add('content-hidden'); modalError.classList.add('content-hidden'); modalTitle.textContent = ''; modalContent.innerHTML = ''; modalErrorMessage.textContent = ''; chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; currentTopicTitle = null; hideFullscreenImage(); chatSection.classList.remove('content-hidden'); MemoryGame.stop(); /* <<< Ensure stopped */ if(gameStatusMessage) gameStatusMessage.textContent = 'Encuentra los pares...'; /* Reset game message */ }
        function showUnlockModal(titleToUnlock) { unlockTargetTitleInput.value = titleToUnlock; unlockCountdownDisplay.textContent = ''; unlockStatusDisplay.textContent = ''; unlockAdButton.disabled = false; unlockModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideUnlockModal() { unlockModal.classList.remove('active'); if (!storyModal.classList.contains('active') && !imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; } if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; } }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active') && !unlockModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios lógicos)
        function addChatMessage(message, sender) { /* ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error del Anciano: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... (no changes) ... */ let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }

        // createTitleItem (Logic remains the same, relies on persistent lock state)
        function createTitleItem(title) {
            const div = document.createElement('div'); div.className = 'title-item'; div.setAttribute('data-title', title);
            const textSpan = document.createElement('span'); textSpan.className = 'title-text'; textSpan.textContent = title; div.appendChild(textSpan);
            const initiallyLocked = isTitleInitiallyLocked(title);
            const unlockedByUser = isTitleUnlockedByUser(title);
            const isEffectivelyLocked = initiallyLocked && !unlockedByUser;
            div.setAttribute('data-locked', isEffectivelyLocked ? 'true' : 'false'); div.style.cursor = 'pointer';
            if (isEffectivelyLocked) { div.classList.add('locked'); const lockIcon = document.createElement('i'); lockIcon.className = 'fas fa-lock lock-icon'; div.appendChild(lockIcon); }
            else { div.classList.remove('locked'); }
            div.addEventListener('click', () => handleTitleClick(title, div)); return div;
        }

        // updateTitleItemLockStatus (Helper, no changes)
        function updateTitleItemLockStatus(title, isLocked) { const titleItem = titleListContainer.querySelector(`.title-item[data-title="${CSS.escape(title)}"]`); if (titleItem) { titleItem.setAttribute('data-locked', isLocked ? 'true' : 'false'); titleItem.classList.toggle('locked', isLocked); let lockIcon = titleItem.querySelector('.lock-icon'); if (isLocked && !lockIcon) { lockIcon = document.createElement('i'); lockIcon.className = 'fas fa-lock lock-icon'; titleItem.appendChild(lockIcon); } else if (!isLocked && lockIcon) { lockIcon.remove(); } } }

        // displayTitles (Handles persistent initial lock state setting, no changes needed)
        function displayTitles(titles) {
            if (!titleListContainer || !titlesLoading) return;
            if (!isInitialLockStateSet() && titles.length > 0) { console.log("Setting initial lock state..."); const shuffled = shuffleArray([...titles]); const lockCount = Math.floor(titles.length * lockPercentage); const newInitialLockedSet = new Set(); for (let i = 0; i < lockCount; i++) { newInitialLockedSet.add(shuffled[i]); } saveInitialLockedSet(newInitialLockedSet); setInitialLockStateFlag(); initialLockedTitles = newInitialLockedSet; console.log(`Initially locked ${initialLockedTitles.size} titles.`); }
            else { console.log(`Initial lock state already set. Loaded ${initialLockedTitles.size} initially locked titles.`); }
            const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none';
            if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» La biblioteca ancestral está vacía por ahora «</p>'; return; }
            sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
        }

        // appendTitles (Adds new titles to persistent locked set, no changes needed)
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let newTitlesAddedToInitialLock = false;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); if (!initialLockedTitles.has(title)) { initialLockedTitles.add(title); newTitlesAddedToInitialLock = true; } } });
             if (newTitlesAddedToInitialLock) { saveInitialLockedSet(initialLockedTitles); console.log("Added new generated titles to persistent initial locked set."); }
             filterTitles(searchInput.value);
        }

        // handleTitleClick (Routes based on lock status, no changes needed)
        function handleTitleClick(title, titleElement) { const isLocked = titleElement.getAttribute('data-locked') === 'true'; if (isLocked) { console.log(`Title "${title}" is locked. Showing unlock modal.`); showUnlockModal(title); } else { console.log(`Title "${title}" is unlocked. Proceeding to load.`); loadContentForTitle(title); } }

        // loadContentForTitle (Starts Memory Game instead of Puzzle)
        async function loadContentForTitle(title) {
            resetModalState(); showModal(); currentTopicTitle = title;
            modalTitle.textContent = title;
            modalStoryContentArea.classList.add('content-hidden');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.classList.add('active');
            MemoryGame.start(); // <<< Start Memory Game
            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);
                MemoryGame.stop(); // <<< Stop Memory Game
                modalLoadingIndicator.classList.remove('active');
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;

                // Load Image (Adapted placeholder text)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-palette placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Creando visión artística...</p>`;
                modalContent.appendChild(placeholderDiv);
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación artística de: ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`; };
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;}

            } catch (error) { /* ... error handling ... */ console.error("Failed display:", error); MemoryGame.stop(); /* <<< Stop Memory Game */ modalLoadingIndicator.classList.remove('active'); modalErrorMessage.textContent = error.message || "Error desconocido al cargar este relato."; modalError.classList.remove('content-hidden'); modalStoryContentArea.classList.remove('content-hidden'); modalContent.innerHTML = ''; chatSection.classList.add('content-hidden'); }
        }

        // handleAdButtonClick (Unlocks title for user, no changes needed)
        function handleAdButtonClick() {
            const titleToUnlock = unlockTargetTitleInput.value;
            if (!titleToUnlock || unlockAdButton.disabled) return;
            console.log(`Ad button clicked for title: ${titleToUnlock}`);
            window.open(adUrl, '_blank');
            unlockAdButton.disabled = true;
            unlockStatusDisplay.textContent = 'Procesando ofrenda...';
            let secondsRemaining = unlockCountdownSeconds;
            unlockCountdownDisplay.textContent = secondsRemaining;
            countdownInterval = setInterval(() => {
                secondsRemaining--;
                unlockCountdownDisplay.textContent = secondsRemaining;
                if (secondsRemaining <= 0) {
                    clearInterval(countdownInterval); countdownInterval = null;
                    unlockCountdownDisplay.textContent = '¡Hecho!';
                    unlockStatusDisplay.textContent = '¡Sabiduría Desbloqueada!';
                    unlockTitlePermanentlyByUser(titleToUnlock);
                    setTimeout(() => { hideUnlockModal(); loadContentForTitle(titleToUnlock); }, 1200);
                }
            }, 1000);
        }

        // handleGenerateMoreTitles (No changes needed)
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más ecos...';
             try { const newTitles = await fetchGeneratedTitles(); if (newTitles && newTitles.length > 0) { appendTitles(newTitles); } else { alert("No se encontraron más relatos por ahora."); } }
             catch (error) { console.error("Failed title generation:", error); alert(`Error buscando relatos: ${error.message}`); }
             finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Relatos (40)'; }
         }

         // Search Filter Function (sin cambios)
         function filterTitles(searchTerm) { /* ... */ const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); const titleItems = titleListContainer.querySelectorAll('.title-item'); let visibleCount = 0; titleItems.forEach(item => { const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const isVisible = titleText.includes(term); item.classList.toggle('hidden', !isVisible); if (isVisible) visibleCount++; }); noResultsMsg.classList.toggle('hidden', visibleCount > 0); }

        // ========== State Variable ==========
        let initialLockedTitles = loadInitialLockedSet(); // Load persistent initial locked set AT STARTUP
        let countdownInterval = null; // Timer for unlock modal
        let currentTopicTitle = null; // Title being viewed/chatted about


        // ========== INITIALIZATION ==========
        function initApp() {
             // Check essential elements, including Memory Game elements
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn ||
                 !memoryGameBoard || !gameStatusMessage || /* <<< Check Game Elements */
                 !unlockModal || !unlockModalCloseBtn || !unlockAdButton || !unlockCountdownDisplay || !unlockStatusDisplay || !unlockTargetTitleInput)
             {
                console.error("Initialization failed: Missing essential UI elements (possibly Memory Game or Unlock Modal elements).");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: No se puede iniciar la Aldea Digital. Faltan componentes.</p>';
                return;
             }

            // --- Initialize Memory Game ---
            MemoryGame.init(memoryGameBoard, gameStatusMessage, memoryGameSymbols);

            // Event Listeners (Same as before)
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            unlockModalCloseBtn.addEventListener('click', hideUnlockModal);
            unlockModal.addEventListener('click', (event) => { if (event.target === unlockModal) hideUnlockModal(); });
            unlockAdButton.addEventListener('click', handleAdButtonClick);

            // Initial display (using persistent lock state)
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>