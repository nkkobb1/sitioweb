<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitología Griega Antigua - Relatos Interactivos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Clásicas (Serif para cuerpo, Display para títulos) -->
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Mitología Griega --- */
        :root {
            --color-primary: #B8860B; /* Oro Oscuro (Divino) */
            --color-secondary: #4682B4; /* Azul Acero (Mar/Cielo) */
            --color-tertiary: #556B2F; /* Verde Oliva Oscuro */
            --color-accent: #8B4513; /* Marrón Siena (Terracota/Tierra) */
            --color-background: #fdfdfd; /* Blanco Hueso (Mármol) */
            --color-text: #3a3b3c; /* Gris Muy Oscuro (Texto Principal) */
            --color-text-muted: #707070; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro Modal */
            --color-border: #d3d3d3; /* Borde Gris Claro (Mármol Claro) */
            --color-error-bg: #fff3e0; /* Fondo error naranja muy claro */
            --color-error-text: #d84315; /* Texto error naranja oscuro */
            --color-error-border: #ffcc80; /* Borde error naranja claro */

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.12);
            --border-radius: 4px; /* Bordes menos redondeados, más clásicos */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'EB Garamond', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400;
               background-image: linear-gradient(rgba(253, 253, 253, 0.97), rgba(253, 253, 253, 0.97)),
                                 url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23cccccc' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); /* Textura sutil */
               background-attachment: fixed;
        }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel', serif; letter-spacing: 1px; font-weight: 700; }
        .logo { color: var(--color-primary); text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
        .logo .part2 { color: var(--color-secondary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-secondary); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; font-size: 2rem; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.2rem 0.8rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1.05rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'EB Garamond'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(184, 134, 11, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: #fff; padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 500; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'EB Garamond'; font-size: 1.1rem; border-left: 4px solid var(--color-secondary); }
        .title-item:hover { transform: translateY(-4px) scale(1.01); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); border-left-color: var(--color-primary); background-color: #fffaf0; /* Crema claro hover */ }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-tertiary)); color: white; padding: 0.9rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel', serif; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; letter-spacing: 1px; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-tertiary), var(--color-primary)); box-shadow: var(--shadow-md); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(50, 50, 50, 0.9); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-top: 5px solid var(--color-primary); /* Borde superior dorado */
            border-radius: var(--border-radius);
            padding: 1.5rem 2.5rem; /* Más padding horizontal */
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 500px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }

        #modal-story-content-area { flex-grow: 1; min-height: 0; display: none; flex-direction: column; }
        #modal-story-content-area.visible { display: flex; }

        /* Área de Contenido (Texto + Imagen) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: #f1f1f1; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }

        #modal-content { padding: 0 5px; font-size: 1.1rem; /* Texto un poco más grande */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; font-family: 'EB Garamond'; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 500; font-family: 'EB Garamond';}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 400;}
        #modal-content h1 { font-size: 1.7em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.5em; }
        #modal-content h3 { font-size: 1.3em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.15em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: 0 0 12px rgba(184, 134, 11, 0.4); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(211, 211, 211, 0.8); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9f9f9; scroll-behavior: smooth;
            scrollbar-width: auto; scrollbar-color: var(--color-secondary) #e9e9e9; }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: #e9e9e9; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.7rem 1rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.6; box-shadow: var(--shadow-sm); font-family: 'EB Garamond'; }
        .user-message { background-color: var(--color-tertiary); color: white; margin-left: auto; text-align: left; font-weight: 500;}
        .ai-message { background-color: var(--color-secondary); color: white; margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'EB Garamond'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(70, 130, 180, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; flex-shrink: 0; }
        #chat-send-btn:hover:not(:disabled) { background-color: #A0522D; } /* Marrón */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'EB Garamond';}
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Screen & Oracle Game */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(160deg, rgba(70, 130, 180, 0.9) 0%, rgba(245, 245, 220, 0.95) 100%); /* Azul acero a Beige */
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius);
            padding: 2rem; color: var(--color-text); text-align: center;
        }
        #modal-loading.active { display: flex; }
        #loading-game-canvas { /* El canvas en sí es menos prominente aquí */
             display: none; /* Oculto por defecto, el juego usa divs */
        }
        #oracle-challenge-area { /* Contenedor para el juego del oráculo */
            background-color: rgba(255, 255, 255, 0.6);
            border: 1px solid var(--color-border);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            width: 90%;
            max-width: 500px;
            margin-bottom: 1rem;
        }
        #oracle-prompt { /* Donde aparece el símbolo/palabra */
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            color: var(--color-primary);
            margin-bottom: 1rem;
            min-height: 50px; /* Espacio para que no salte */
            text-align: center;
            text-shadow: 1px 1px 1px #fff;
        }
        #oracle-input-area { /* Para escribir o botones */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.8rem;
        }
        #oracle-typing-input { /* Input para escribir */
            padding: 0.6rem;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            text-align: center;
            font-family: 'EB Garamond';
            font-size: 1.1rem;
            width: 80%;
            text-transform: uppercase; /* Forzar mayúsculas */
        }
        #oracle-choices-area { /* Div para botones de opción múltiple */
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .oracle-choice-btn {
            padding: 0.6rem 1rem;
            border: 1px solid var(--color-secondary);
            background-color: white;
            color: var(--color-secondary);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: 'EB Garamond';
            font-size: 1rem;
            transition: background-color 0.2s, color 0.2s;
        }
        .oracle-choice-btn:hover { background-color: var(--color-secondary); color: white; }
        #oracle-timer-bar { /* Barra de tiempo opcional */
            width: 80%;
            height: 8px;
            background-color: var(--color-border);
            border-radius: 4px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        #oracle-timer-progress {
            height: 100%;
            width: 100%;
            background-color: var(--color-tertiary);
            transition: width 0.1s linear; /* Transición suave */
        }
        #loading-instructions { font-size: 1rem; margin-top: 0.5rem; font-family: 'EB Garamond'; color: var(--color-text-muted); }
        #loading-score { font-size: 1.6rem; font-family: 'Cinzel'; margin-top: 0.5rem; color: var(--color-primary);}
        .loading-spinner-modal { /* Fallback spinner */ width: 50px; height: 50px; border: 5px solid rgba(184, 134, 11, 0.2); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'EB Garamond'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(50, 50, 50, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: 0 0 25px rgba(184, 134, 11, 0.5); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: white; transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-landmark mr-2"></i> <!-- Icono Templo/Landmark -->
                     Mitos Griegos <span class="part2">&</span> Leyendas
                 </h1>
             </div>
             <span class="text-md text-gray-700 font-semibold font-sans tracking-wide">» El Oráculo Interactivo «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Ecos del Olimpo</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora las sagradas historias de dioses, héroes y monstruos de la Hélade. Selecciona un mito o busca un personaje para consultar al oráculo.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar (Ej: Zeus, Heracles, Medusa, Troya...)">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll mr-2"></i> <!-- Icono Pergamino -->
                 Papiros Disponibles
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando las escrituras antiguas...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» El oráculo no encuentra registros con esa consulta «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar 40 Nuevos Mitos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Oracle Game -->
             <div id="modal-loading">
                 <!-- Oracle Game Area -->
                 <div id="oracle-challenge-area">
                     <div id="oracle-prompt">...</div>
                     <div id="oracle-input-area">
                         <!-- Input o Botones se añadirán aquí por JS -->
                     </div>
                     <div id="oracle-timer-bar">
                         <div id="oracle-timer-progress"></div>
                     </div>
                 </div>
                 <!-- Game Instructions & Score -->
                 <p id="loading-instructions">¡El Oráculo te prueba! Responde rápido...</p>
                 <p id="loading-score">Aciertos: 0 | Nivel: 1</p>
                 <!-- Fallback spinner -->
                 <canvas id="loading-game-canvas" width="10" height="10"></canvas> <!-- Canvas mínimo, no visible -->
                 <div class="loading-spinner-modal content-hidden"></div>
             </div>

             <!-- Content Area Wrapper (Initially Hidden) -->
             <div id="modal-story-content-area">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image and placeholder added via JS -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando a las Musas...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta más sobre este mito...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Relatos de la mitología griega generados por IA con fines educativos y de entretenimiento.</p>
              <p class="mt-1">Basado en fuentes clásicas y académicas. Verifica siempre la información crítica.</p>
              <p class="mt-2">© 2025 Archivos del Partenón</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Dioses Olímpicos Principales
            "Zeus: Rey de los Dioses y el Cielo", "Hera: Reina de los Dioses, Matrimonio y Familia", "Poseidón: Dios de los Mares, Terremotos y Caballos", "Hades: Dios del Inframundo y los Muertos", "Atenea: Diosa de la Sabiduría, Estrategia y Guerra Justa", "Apolo: Dios de la Música, Profecía, Sol y Sanación", "Artemisa: Diosa de la Caza, Luna y Naturaleza Salvaje", "Ares: Dios de la Guerra Sangrienta y la Violencia", "Afrodita: Diosa del Amor, Belleza y Placer", "Hefesto: Dios del Fuego, Forja y Artesanos", "Hermes: Mensajero de los Dioses, Comercio y Ladrones", "Dionisio: Dios del Vino, Éxtasis y Teatro", "Deméter: Diosa de la Agricultura y Cosechas", "Hestia: Diosa del Hogar y la Familia (Primera Generación)",
            // Titanes y Deidades Primordiales
            "Urano (Caelus): Personificación del Cielo", "Gea (Terra): Personificación de la Tierra", "Cronos (Saturno): Líder de los Titanes, Dios del Tiempo", "Rea: Madre de los Dioses Olímpicos", "Océano y Tetis: Titanes del Mar", "Hiperión y Tea: Titanes de la Luz", "Ceo y Febe: Titanes de la Inteligencia y Profecía Lunar", "Crío y Jápeto: Titanes de Constelaciones y Mortalidad", "Prometeo: Titán Amigo de la Humanidad, Ladrón del Fuego", "Epimeteo y Pandora: La Caja de los Males", "Atlas: Titán que Sostiene los Cielos", "La Titanomaquia: Guerra entre Dioses y Titanes", "Caos: El Vacío Primordial", "Nyx (Noche) y Érebo (Oscuridad)", "Tártaro: El Abismo Infernal",
            // Héroes Griegos Famosos
            "Heracles (Hércules): Los Doce Trabajos", "Perseo: Asesino de Medusa y Rescatador de Andrómeda", "Teseo: Matador del Minotauro y Rey de Atenas", "Odiseo (Ulises): El Astuto Viajero de la Odisea", "Aquiles: Héroe Invulnerable de la Guerra de Troya", "Jasón y los Argonautas: La Búsqueda del Vellocino de Oro", "Belerofonte: Domador de Pegaso y Asesino de la Quimera", "Héctor: Príncipe Troyano y Defensor de su Ciudad", "Agamenón: Líder de los Griegos en Troya", "Menelao: Rey Espartano, Esposo de Helena", "Edipo: Rey Trágico de Tebas", "Atalanta: Cazadora Veloz y Heroína", "Orfeo y Eurídice: El Músico que Descendió al Hades", "Dédalo e Ícaro: El Laberinto y el Vuelo Fallido", "Cadmo: Fundador de Tebas y Matador del Dragón",
            // Monstruos y Criaturas Míticas
            "Medusa y las Gorgonas: Mirada Petrificante", "El Minotauro: Bestia del Laberinto de Creta", "La Hidra de Lerna: Cabezas Regenerativas", "Cerbero: Perro Guardián de Tres Cabezas del Hades", "La Quimera: León, Cabra y Serpiente", "Las Sirenas: Canto Mortal para los Marineros", "Escila y Caribdis: Peligros del Estrecho de Mesina", "Polifemo y los Cíclopes: Gigantes de un Solo Ojo", "Los Centauros: Mitad Hombre, Mitad Caballo (Quirón el Sabio)", "Las Harpías: Espíritus Alados del Viento", "El León de Nemea: Piel Invulnerable", "El Cancerbero (Ver Cerbero)", "Las Grayas: Ancianas que Comparten un Ojo y un Diente", "Tifón: Monstruo Gigante, Padre de Monstruos", "Equidna: Madre de Monstruos",
            // Mitos y Leyendas Clave
            "El Mito de la Creación: De Caos a los Olímpicos", "El Rapto de Perséfone por Hades", "La Guerra de Troya: Causas y Eventos Principales", "La Odisea: El Largo Viaje de Regreso de Odiseo", "La Fundación de Roma: Eneas y la Conexión Griega (Virgilio)", "El Juicio de Paris: La Manzana de la Discordia", "El Mito de Narciso y Eco", "El Mito del Rey Midas: El Toque Dorado", "El Mito de Aracne: La Tejedora Castigada", "Psique y Eros (Cupido): Amor y Pruebas", "El Mito de Sísifo: El Castigo Eterno", "El Mito de Tántalo: Hambre y Sed Eternas", "Las Danaides: Llenando una Jarra sin Fondo", "La Gigantomaquia: Guerra entre Dioses y Gigantes", "El Diluvio de Deucalión y Pirra",
            // Lugares Sagrados y Conceptos
            "El Monte Olimpo: Hogar de los Dioses", "El Inframundo (Hades): Reino de los Muertos", "Los Campos Elíseos: Paraíso de los Héroes", "Los Campos de Asfódelos: Reino de las Sombras Comunes", "El Río Estigia: Juramentos Inquebrantables", "El Oráculo de Delfos: Profecías de Apolo y la Pitia", "El Oráculo de Dodona: Susurros de Zeus en el Roble", "El Laberinto de Creta: Prisión del Minotauro", "La Acrópolis de Atenas: Templo del Partenón", "El Templo de Zeus en Olimpia: Estatua Maravilla", "Néctar y Ambrosía: Comida y Bebida de los Dioses", "Hubris: El Pecado del Exceso de Orgullo", "Némesis: La Diosa de la Venganza Justa", "Moira (Las Parcas/Fates): Tejedoras del Destino", "Las Musas: Inspiradoras de las Artes y las Ciencias",
            // Prácticas Religiosas y Festivales
            "El Concepto de Piedad (Eusebeia) Griega", "Tipos de Sacrificios a los Dioses", "Oraciones y Plegarias: Cómo se Dirigían a los Dioses", "Libaciones: Ofrendas Líquidas", "Templos Griegos: Arquitectura y Función", "Santuarios Panhelénicos (Olimpia, Delfos, Nemea, Istmia)", "Los Misterios Eleusinos: Ritos Secretos de Deméter y Perséfone", "Las Dionisias: Festivales en Honor a Dionisio (Origen del Teatro)", "Las Panateneas: Gran Festival Ateniense para Atenea", "Los Juegos Olímpicos Antiguos: Honor a Zeus", "Interpretación de Augurios y Presagios", "El Culto a los Héroes", "Prácticas Funerarias Griegas", "La Adivinación y la Mancia", "El Rol de los Sacerdotes y Sacerdotisas",
             // Expandir con más detalles de cada mito, genealogías, epítetos de dioses, etc.
        ];
        const greekMythThemes = [ // Para generar más títulos
            "Dioses Olímpicos", "Titanes y Primordiales", "Héroes Griegos", "Monstruos Míticos", "Guerra de Troya", "Odisea de Homero", "Mitos de Creación", "Inframundo Griego", "Oráculos y Profecías", "Amor y Tragedia en Mitos", "Metamorfosis (Ovidio)", "Doce Trabajos de Heracles", "Argonautas", "Mitos Tebanos (Edipo, Antígona)", "Mitos Atenienses (Teseo)", "Mitos Cretenses (Minos)", "Culto y Rituales", "Festivales Religiosos", "Templos Famosos", "Filosofía y Mito", "Arte y Mitología Griega", "Influencia Romana", "Comparación con otras Mitologías", "Personajes Femeninos Fuertes", "Conceptos (Hubris, Moira)", "Lugares Míticos (Olimpo, Estigia)", "Genealogía Divina", "Epítetos de Dioses", "Ninfas y Sátiros", "Criaturas Menores"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un erudito y narrador experto en la religión y mitología de la Antigua Grecia. Basándote en fuentes clásicas (como Homero, Hesíodo, Ovidio, los dramaturgos) y el conocimiento académico, relata o explica detalladamente el mito, personaje, lugar o concepto griego antiguo indicado. Usa un lenguaje evocador pero preciso, capturando la esencia de las creencias y narrativas helénicas. Proporciona contexto cultural o religioso cuando sea relevante. Tu respuesta debe ser una exposición completa de aproximadamente 1200-1300 palabras sobre el siguiente tema:",
            timeoutSeconds: 180
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un especialista en el mito o figura griega específica que se está discutiendo. Responde preguntas de seguimiento sobre detalles, interpretaciones, variantes del mito, o conexiones con otras historias relacionadas *únicamente con ese tema*. Sé preciso y cita fuentes implícitamente si es posible (ej: 'Según Hesíodo...', 'En la versión de Ovidio...').",
            timeoutSeconds: 50
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de temas sobre mitología y religión griega antigua. Crea exactamente 40 títulos específicos y atractivos para relatos o explicaciones detalladas. Incluye dioses, héroes, monstruos, mitos clave, lugares sagrados, conceptos religiosos o festivales. Devuelve *solo* la lista, un ítem por línea, sin números, guiones, introducciones ni conclusiones.",
            timeoutSeconds: 60
        };

        // ========== DOM ELEMENTS ==========
        // (Includes elements for the new Oracle game)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Container for game/spinner
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Oracle Game Elements
        const oracleChallengeArea = document.getElementById('oracle-challenge-area');
        const oraclePromptDisplay = document.getElementById('oracle-prompt');
        const oracleInputArea = document.getElementById('oracle-input-area');
        const oracleTimerBar = document.getElementById('oracle-timer-bar');
        const oracleTimerProgress = document.getElementById('oracle-timer-progress');
        const loadingInstructions = document.getElementById('loading-instructions');
        const loadingScoreDisplay = document.getElementById('loading-score');

        // ========== State Variables ==========
        let currentMythTitle = null;
        let gameLoopId = null; // For intervals/timeouts in the Oracle game
        let isGameRunning = false;
        let oracleGameTimeoutId = null; // Timeout for player response

        // ========== ORACLE GAME VARIABLES & LOGIC ==========
        const oracleConfig = {
            words: ["ZEUS", "HERA", "ARES", "ATHENA", "APOLLO", "ARTEMIS", "HADES", "POSEIDON", "OLYMPUS", "TITAN", "HERACLES", "ODYSSEUS", "TROYA", "MINOTAUR", "MEDUSA", "SPARTA", "ATHENS", "ORACLE", "MYTHOS", "EROS"],
            symbols: ["⚡", "🔱", "🦉", "🏹", "🏺", "🏛️", "🍇", "🔥", "☀️", "🌙"], // Example symbols (emojis work well)
            initialTimeLimit: 5000, // 5 seconds initially
            minTimeLimit: 1500, // Minimum time limit
            timeReductionPerLevel: 300, // Reduce time by 300ms per level
            pointsPerCorrect: 10,
            levelUpScore: 50, // Points to level up
            modeChangeLevel: 3, // Level at which typing input might appear
            numChoices: 3, // Number of buttons for multiple choice mode
        };

        let oracleScore = 0;
        let oracleLevel = 1;
        let currentOracleTimeLimit = oracleConfig.initialTimeLimit;
        let currentTarget = null;
        let currentChoices = []; // For multiple choice
        let isTypingMode = false; // Start with multiple choice

        function resetOracleGame() {
            oracleScore = 0;
            oracleLevel = 1;
            currentOracleTimeLimit = oracleConfig.initialTimeLimit;
            currentTarget = null;
            currentChoices = [];
            isTypingMode = false; // Reset to button mode
            oracleInputArea.innerHTML = ''; // Clear previous input/buttons
            oraclePromptDisplay.textContent = '...';
            loadingScoreDisplay.textContent = `Aciertos: 0 | Nivel: 1`;
            if (oracleGameTimeoutId) clearTimeout(oracleGameTimeoutId);
            if(oracleTimerProgress) oracleTimerProgress.style.width = '100%'; // Reset timer bar visually
            console.log("Oracle Game Reset");
        }

        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        function generateOracleChallenge() {
            if (!isGameRunning) return;

            // Determine mode (typing or multiple choice) - switch after level 3
            isTypingMode = oracleLevel >= oracleConfig.modeChangeLevel && Math.random() < 0.5; // 50% chance of typing mode after level 3

            // Select target (word or symbol)
            const targetType = Math.random() < 0.6 ? 'word' : 'symbol'; // 60% words, 40% symbols
            currentTarget = getRandomElement(targetType === 'word' ? oracleConfig.words : oracleConfig.symbols);

            oraclePromptDisplay.textContent = currentTarget;
            oracleInputArea.innerHTML = ''; // Clear previous input

            if (isTypingMode && targetType === 'word') {
                // Setup typing input
                 const input = document.createElement('input');
                 input.type = 'text';
                 input.id = 'oracle-typing-input'; // Use the ID for styling
                 input.placeholder = 'Escribe aquí...';
                 input.oninput = () => { input.value = input.value.toUpperCase(); }; // Force uppercase
                 input.onkeydown = (e) => {
                     if (e.key === 'Enter') {
                         checkOracleAnswer(input.value.trim());
                         e.preventDefault(); // Prevent form submission feel
                     }
                 };
                 oracleInputArea.appendChild(input);
                 // Focus the input field slightly delayed to ensure it's rendered
                 setTimeout(() => input.focus(), 50);
                 loadingInstructions.textContent = "¡Escribe la palabra y pulsa Enter!";
            } else {
                // Setup multiple choice buttons (always for symbols, sometimes for words)
                currentChoices = generateChoices(currentTarget, targetType);
                const choicesContainer = document.createElement('div');
                choicesContainer.id = 'oracle-choices-area'; // Use ID for styling

                currentChoices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'oracle-choice-btn';
                    button.textContent = choice;
                    button.onclick = () => checkOracleAnswer(choice);
                    choicesContainer.appendChild(button);
                });
                oracleInputArea.appendChild(choicesContainer);
                loadingInstructions.textContent = "¡Elige la opción correcta!";
            }

             // Start the timer visually and functionally
             startOracleTimer();
        }

        function generateChoices(correctAnswer, targetType) {
            const choices = new Set([correctAnswer]);
            const sourceArray = targetType === 'word' ? oracleConfig.words : oracleConfig.symbols;
            while (choices.size < oracleConfig.numChoices) {
                const randomChoice = getRandomElement(sourceArray);
                if (randomChoice !== correctAnswer) {
                    choices.add(randomChoice);
                }
            }
             // Convert Set to array and shuffle
            return Array.from(choices).sort(() => Math.random() - 0.5);
        }

        function startOracleTimer() {
            if (oracleGameTimeoutId) clearTimeout(oracleGameTimeoutId); // Clear previous timeout
            if(oracleTimerProgress) {
                 oracleTimerProgress.style.transition = 'none'; // Disable transition for reset
                 oracleTimerProgress.style.width = '100%'; // Reset visually
                 // Force reflow/repaint before starting transition
                 oracleTimerProgress.offsetHeight;
                 oracleTimerProgress.style.transition = `width ${currentOracleTimeLimit / 1000}s linear`;
                 oracleTimerProgress.style.width = '0%'; // Start depletion
            }

            oracleGameTimeoutId = setTimeout(() => {
                if (isGameRunning) {
                    // Time's up! Treat as incorrect.
                    console.log("Oracle time up!");
                    // Could add a visual cue for timeout
                    generateOracleChallenge(); // Generate next challenge
                }
            }, currentOracleTimeLimit);
        }

        function checkOracleAnswer(playerAnswer) {
             if (!isGameRunning) return;
             if (oracleGameTimeoutId) clearTimeout(oracleGameTimeoutId); // Stop the timer

             if (playerAnswer && playerAnswer === currentTarget) {
                 console.log("Oracle Correct!");
                 oracleScore += oracleConfig.pointsPerCorrect;
                 // Add visual feedback for correct answer (e.g., green flash)
                 oracleChallengeArea.style.backgroundColor = 'rgba(144, 238, 144, 0.6)'; // Light green
                 setTimeout(() => { oracleChallengeArea.style.backgroundColor = 'rgba(255, 255, 255, 0.6)'; }, 200);
                 checkOracleLevelUp();
                 generateOracleChallenge(); // Next challenge
             } else {
                 console.log("Oracle Incorrect/Input Error.");
                 // Add visual feedback for incorrect answer (e.g., red flash)
                 oracleChallengeArea.style.backgroundColor = 'rgba(255, 192, 203, 0.6)'; // Light pink/red
                 setTimeout(() => { oracleChallengeArea.style.backgroundColor = 'rgba(255, 255, 255, 0.6)'; }, 200);
                 // Optionally: Don't immediately go to next challenge, give a small pause.
                 setTimeout(() => {
                     if (isGameRunning) generateOracleChallenge();
                 }, 300); // Small delay after wrong answer
             }
             loadingScoreDisplay.textContent = `Aciertos: ${oracleScore / oracleConfig.pointsPerCorrect} | Nivel: ${oracleLevel}`;
         }

        function checkOracleLevelUp() {
            const nextLevelThreshold = oracleLevel * oracleConfig.levelUpScore;
            if (oracleScore >= nextLevelThreshold) {
                oracleLevel++;
                currentOracleTimeLimit = Math.max(oracleConfig.minTimeLimit, oracleConfig.initialTimeLimit - (oracleLevel - 1) * oracleConfig.timeReductionPerLevel);
                console.log(`Oracle Level Up! Level: ${oracleLevel}, Time Limit: ${currentOracleTimeLimit}ms`);
                 // Visual feedback for level up
                 loadingScoreDisplay.style.color = ['var(--color-primary)', 'var(--color-secondary)', 'var(--color-tertiary)'][oracleLevel % 3];
                 setTimeout(() => { loadingScoreDisplay.style.color = 'var(--color-primary)'; }, 500);
            }
        }

        function startOracleGameLoop() {
            if (isGameRunning) return;
            console.log("Starting Oracle Game Loop");
            isGameRunning = true;
            resetOracleGame();
            modalLoadingIndicator.classList.add('active');
            generateOracleChallenge(); // Start the first challenge
        }

        function stopOracleGameLoop() {
            if (!isGameRunning) return;
            console.log("Stopping Oracle Game Loop");
            isGameRunning = false;
            if (oracleGameTimeoutId) {
                clearTimeout(oracleGameTimeoutId);
                oracleGameTimeoutId = null;
            }
            // No interval to clear, it's timeout-based
        }

        // ========== AD FILTER FUNCTION ==========
        function filterAds(rawText) {
            if (!rawText) return '';
            // Regex to find the NordVPN pattern (and similar future ones potentially)
            // Looks for '---' line, optional '*', then text containing NordVPN, ending with 'Learn more', case-insensitive, multiline
            const adPattern = /^---\s*\*?.*?NordVPN.*?Learn more.*?$/gmi;
            const cleanedText = rawText.replace(adPattern, '').trim();

            if (rawText.length !== cleanedText.length) {
                console.log("Ad pattern detected and removed.");
            }
            return cleanedText;
        }

        // ========== API FUNCTIONS ========== (Calling filterAds)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentMythTitle
                 ? `Eres un especialista en el mito o figura griega '${currentMythTitle}'. Responde preguntas de seguimiento sobre detalles, interpretaciones o conexiones relacionadas *únicamente con ese tema*.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);

             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) { throw new Error(`(Error ${response.status}) Nuestros servidores están experimentando mucho tráfico. Por favor, intenta de nuevo en unos segundos.`); }
                 const rawText = await response.text();

                 // *** FILTER ADS HERE ***
                 const cleanedText = filterAds(rawText);

                 if (!cleanedText || cleanedText.trim().length < (isChat ? 10 : 400)) { throw new Error("La respuesta de la IA fue demasiado corta o vacía. Intenta de nuevo."); }
                 console.log(`API Response received (${cleanedText.length} chars after filtering)`);
                 return cleanedText; // Return cleaned text
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') { throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión.`); }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
         }

        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentMythTitle) throw new Error("Error interno: No se ha establecido el contexto del mito para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
         async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(greekMythThemes) || "mitología griega general";
            const specificPrompt = `Genera 40 títulos específicos sobre ${randomTheme}`;
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                 .then(text => {
                     const titles = text.split('\n')
                                        .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                        .filter(line => line.length > 5 && line.length < 150 && !/^\s*$/.test(line) && !line.toLowerCase().includes("aquí tienes"))
                                        .slice(0, 40);
                     if (titles.length < 15) { throw new Error("La IA no generó suficientes ideas de mitos válidas."); }
                     return titles;
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 896, height: 640, nologo: true }; // Ratio ~1.4
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "ancient greek mythology scene";
             // Prompt for Greek style
             const enhancedPrompt = `Ancient Greek mythology scene, inspired by '${safePromptText}'. Style of classical Greek vase painting (red-figure or black-figure) OR neoclassical oil painting. Dramatic composition, symbolic elements.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, signature, watermark, multiple images, collage, photograph, modern clothing, 3D render, blurry, deformed";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (Sin cambios)
        function formatExplanationText(rawText){ /* ... */ if(!rawText)return'';let formatted=rawText.trim();formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1');formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('−','-');return`${base}<sup>${cleanExponent}</sup>`;});formatted=formatted.replace(/\\rightarrow/g,'&rarr;');formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>');const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0);formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block;let content=block.replace(/\n/g,' ');return`<p>${content}</p>`;}).join('');return formatted;}

        // ========== MODAL FUNCTIONS ========== (Integrando inicio/parada del Oracle game)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            stopOracleGameLoop(); // Detener juego
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             stopOracleGameLoop(); // Asegura detener juego
             modalLoadingIndicator.classList.remove('active');
             modalStoryContentArea.classList.remove('visible');
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentMythTitle = null;
             hideFullscreenImage();
             // Reset game UI specifically
             oracleInputArea.innerHTML = '';
             oraclePromptDisplay.textContent = '...';
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios)
        function showFullscreenImage(imgSrc){if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden';}
        function hideFullscreenImage(){if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src='';}

        // ========== CHAT FUNCTIONS ========== (Sin cambios funcionales)
        function addChatMessage(message, sender) { /* ... */ const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        function addChatError(message){ /* ... */ const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        async function handleSendMessage(){const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Error IA: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}}

        // ========== UI & EVENT HANDLERS ==========
        // function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; } // Defined in Oracle section
        function createTitleItem(title) { const div=document.createElement('div');div.className='title-item';div.textContent=title;div.setAttribute('data-title',title);div.addEventListener('click',()=>handleTitleClick(title));return div; }
        function displayTitles(titles) {
            if (!titleListContainer || !titlesLoading) return;
            const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay papiros disponibles. Intenta generar más mitos. «</p>'; return; }
            sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
            console.log(`Displayed ${sortedTitles.length} titles.`);
        }
        function appendTitles(newTitles) {
            if (!titleListContainer || !newTitles || newTitles.length === 0) return;
            console.log(`Appending ${newTitles.length} new titles.`);
            const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
            let addedCount = 0;
            newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
            console.log(`Successfully added ${addedCount} unique titles.`);
            filterTitles(searchInput.value);
        }

        // *** MODIFIED: handleTitleClick to manage Oracle game start/stop ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentMythTitle = title; // Set chat context
            chatHistory.innerHTML = '';

            // *** START LOADING & Oracle Game ***
            modalLoadingIndicator.classList.add('active');
            startOracleGameLoop(); // Start the Oracle challenge

            try {
                const storyPromise = fetchExplanationText(title); // Fetches and filters ads
                const imageUrl = createPollinationsImageUrl(title); // Generate URL while waiting

                // Await story completion
                const explanationText = await storyPromise; // Already filtered

                 // *** STOP GAME & SHOW CONTENT ***
                 stopOracleGameLoop();
                 modalLoadingIndicator.classList.remove('active');
                 modalStoryContentArea.classList.add('visible');
                 modalStoryContentArea.classList.remove('content-hidden');

                // Display story
                const formattedExplanation = formatExplanationText(explanationText);
                modalContent.innerHTML = formattedExplanation;
                modalTextArea.scrollTop = 0;

                // Image Handling
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                 // Icono temático
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-paint-brush placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Invocando una visualización...</p>`;
                modalContent.appendChild(placeholderDiv);

                if (imageUrl) {
                    const imgElement = document.createElement('img');
                    imgElement.className = 'final-image';
                    imgElement.alt = `Ilustración de ${title}`;
                    imgElement.style.display = 'none';
                    imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                    imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al cargar imagen.</p>`; };
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                    placeholderDiv.innerHTML = `<i class="fas fa-ban placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo generar URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                 // *** STOP GAME & SHOW ERROR ***
                 stopOracleGameLoop();
                 modalLoadingIndicator.classList.remove('active');
                 modalStoryContentArea.classList.add('visible');
                 modalStoryContentArea.classList.remove('content-hidden');

                modalErrorMessage.textContent = error.message || "El Oráculo calla: error desconocido al cargar el mito.";
                modalError.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
            if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
            generateMoreBtn.disabled = true;
            generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando a las Musas...';
            try {
                const newTitles = await fetchGeneratedTitles(); // Fetches 40
                if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                else { alert("Las Musas no responden ahora. No se pudieron generar más mitos."); }
            } catch (error) {
                console.error("Failed title generation:", error);
                alert(`Error generando mitos: ${error.message}`);
            } finally {
                generateMoreBtn.disabled = false;
                generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Revelar 40 Nuevos Mitos';
            }
        }

        // Search Filter Function (con normalización)
        function filterTitles(searchTerm) {
            const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
            const titleItems = titleListContainer.querySelectorAll('.title-item');
            let visibleCount = 0;
            titleItems.forEach(item => {
                const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const isVisible = titleText.includes(term);
                item.classList.toggle('hidden', !isVisible);
                if (isVisible) visibleCount++;
            });
            noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0);
        }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check elements, including Oracle game elements
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !oracleChallengeArea || !oraclePromptDisplay || !oracleInputArea || !loadingScoreDisplay) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #8B4513; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: Cinzel;">¡Caos Primordial! Faltan componentes esenciales de la página.</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>