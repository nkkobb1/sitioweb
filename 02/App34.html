<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mundo Creepypasta - Relatos de Horror IA</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Using Google Fonts: Creepster for headings, Roboto Slab for readability -->
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #e53e3e; /* Red */
            --color-secondary: #4a5568; /* Gray */
            --color-background: #1a202c; /* Very Dark Blue/Gray */
            --color-text: #e2e8f0; /* Light Gray */
            --color-text-darker: #a0aec0; /* Medium Gray */
            --color-modal-bg: #2d3748; /* Dark Gray Blue */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.5);
            --border-radius: 8px;
            --transition-normal: all 0.3s ease;
        }

        body {
            font-family: 'Roboto Slab', serif;
            background-color: var(--color-background);
            color: var(--color-text);
             /* Optional: Subtle static background */
             background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill-rule="evenodd"%3E%3Cg fill="%23333" fill-opacity="0.07"%3E%3Cpath opacity=".5" d="M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z"/%3E%3Cpath d="M6 5V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h9V0h1v5h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0V0h-1v5H0v1h5v9H0v1h5v9H0v1h5v9H0v1h5v9H0v1h5v9H0v1h5v9H0v1h5v9H0v1h5v4h1v-4h9v4h1v-4h9v4h1v-4h9v4h1v-4h9v4h1v-4h9v4h1v-4h9v4h1v-4h9v4h1v-4zm-1-1h-9V5h9v90zm-10 0h-9V5h9v90zm-10 0h-9V5h9v90zm-10 0h-9V5h9v90zm-10 0h-9V5h9v90zm-10 0h-9V5h9v90zm-10 0h-9V5h9v90zm-10 0h-9V5h9v90zm-10-91h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm9-10v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-9-10h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm9-10v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-9-10h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm9-10v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-10 0v9h-9V5h9zm-9-10h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9zm10 0h9V5h-9v9z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
        }

        /* Headings using Creepster, fallbacks */
        h1, h2.creepster, .logo {
            font-family: 'Creepster', cursive, sans-serif;
            color: var(--color-primary);
            letter-spacing: 1px;
        }
         /* Specific override for modal title */
         #modal-title {
             font-family: 'Creepster', cursive, sans-serif;
             color: var(--color-primary);
         }


        .navbar {
            background-color: #11151c; /* Slightly darker than body */
            box-shadow: 0 2px 10px rgba(229, 62, 62, 0.3); /* Reddish shadow */
            position: sticky;
            top: 0;
            z-index: 20;
            border-bottom: 1px solid var(--color-secondary);
        }

        .navbar a {
            color: var(--color-text-darker);
            font-weight: bold;
        }
        .navbar a:hover {
            color: var(--color-primary);
        }

        /* Title List Styling */
        #title-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .title-item {
            background-color: var(--color-modal-bg); /* Darker item bg */
            padding: 1rem 1rem; /* Adjusted padding */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: var(--transition-normal);
            text-align: center;
            font-weight: 700; /* Bolder */
            color: var(--color-text);
            border: 1px solid var(--color-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70px; /* Adjusted height */
        }

        .title-item:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 0 15px rgba(229, 62, 62, 0.5); /* Red glow */
            border-color: var(--color-primary);
            color: white;
        }

        /* Generate More Button */
        #generate-more-btn {
             grid-column: 1 / -1; /* Span full width */
             background-color: var(--color-primary);
             color: white;
             padding: 0.75rem 1.5rem;
             border: none;
             border-radius: var(--border-radius);
             font-family: 'Roboto Slab', serif;
             font-weight: bold;
             cursor: pointer;
             transition: var(--transition-normal);
             margin-top: 1.5rem; /* Space above */
        }
        #generate-more-btn:hover:not(:disabled) {
             background-color: #c53030; /* Darker Red */
             box-shadow: var(--shadow-md);
        }
         #generate-more-btn:disabled {
             background-color: var(--color-secondary);
             cursor: not-allowed;
             opacity: 0.7;
         }

        /* Modal Styling */
        #story-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 10, 15, 0.85); /* Darker overlay */
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
            overflow-y: auto;
        }

        #story-modal.active {
            display: flex;
        }

        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-secondary);
            padding: 2rem;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--color-secondary);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-background);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: var(--transition-normal);
            z-index: 10;
        }
        .modal-close-btn:hover {
            background-color: var(--color-primary);
            color: white;
            transform: rotate(90deg);
        }

        #modal-image-container {
            width: 100%;
            height: 250px;
            background-color: #11151c; /* Very dark bg */
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--color-secondary);
            flex-shrink: 0;
        }
         #modal-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            filter: grayscale(30%) contrast(110%); /* Subtle filter */
         }
         #modal-image-container .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--color-primary); /* Red spinner */
            animation: spin 1s linear infinite; /* Faster spin */
            display: none;
         }
         #modal-image-container .placeholder-icon {
             font-size: 3rem;
             color: var(--color-secondary); /* Gray icon */
             display: none;
         }

        #modal-content {
            line-height: 1.7;
            color: var(--color-text);
            white-space: pre-wrap;
            flex-grow: 1;
            overflow-y: auto;
             /* Custom scrollbar for webkit */
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) var(--color-background);
        }
         #modal-content::-webkit-scrollbar {
             width: 8px;
         }
         #modal-content::-webkit-scrollbar-track {
             background: var(--color-background);
             border-radius: 4px;
         }
         #modal-content::-webkit-scrollbar-thumb {
             background-color: var(--color-primary);
             border-radius: 4px;
             border: 2px solid var(--color-background);
         }
         #modal-content p:not(:last-child) { /* Ensure space between paragraphs */
            margin-bottom: 1em;
        }


        /* Loading Indicator */
        #modal-loading {
            text-align: center;
            padding: 3rem 0;
        }
        .loading-spinner-modal {
            width: 60px;
            height: 60px;
            border: 6px solid var(--color-secondary);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            margin: 0 auto 1rem auto;
        }
        #modal-loading p {
            font-weight: 600;
            color: var(--color-text);
            font-size: 1.1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error message styling */
        .error-msg {
            background-color: rgba(229, 62, 62, 0.1); /* Red tint */
            color: #fc8181; /* Lighter Red Text */
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--color-primary);
            margin-top: 1rem;
            text-align: center;
        }
         .error-msg i {
             margin-right: 0.5rem;
         }

         .content-hidden {
             display: none;
         }

    </style>
</head>
<body>
    <!-- Header/Navbar -->
    <nav class="navbar mb-8">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <h1 class="logo text-3xl sm:text-4xl">
                    <i class="fas fa-ghost mr-2"></i> Mundo Creepypasta
                </h1>
            </div>
             <div class="hidden md:flex space-x-6">
                <a href="#">Archivos</a>
                <a href="#">Advertencia</a>
            </div>
             <div class="md:hidden">
                <button class="text-gray-400 hover:text-white focus:outline-none">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <main class="container mx-auto px-4 pb-16"> <!-- Reduced bottom padding -->
        <!-- Hero section -->
        <section class="mb-12 text-center">
            <h2 class="creepster text-5xl sm:text-6xl text-red-600 mb-4">Adéntrate en la Oscuridad...</h2>
            <p class="text-xl text-gray-400 mb-8 max-w-3xl mx-auto">Elige tu veneno. Haz clic en un título y deja que la IA te susurre una historia de horror.</p>
        </section>

        <!-- Title List Container -->
        <section class="mb-10">
            <h2 class="creepster text-3xl sm:text-4xl mb-6 text-center">
                <i class="fas fa-scroll text-red-500 mr-2"></i>
                Relatos Encontrados
            </h2>
            <div id="title-list">
                <!-- Titles will be inserted here by JavaScript -->
                 <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Buscando archivos corruptos...</p>
            </div>
             <!-- Button Container Below Grid -->
            <div id="generate-more-container" class="text-center mt-8">
                <button id="generate-more-btn">
                     <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> <!-- Loading icon -->
                    Generar Más Títulos
                 </button>
            </div>
        </section>

    </main>

    <!-- Story Modal -->
    <div id="story-modal">
        <div class="modal-content-wrapper">
            <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

            <!-- Loading Indicator for Text -->
            <div id="modal-loading">
                <div class="loading-spinner-modal"></div>
                <p>Invocando las sombras...</p>
            </div>

            <!-- Content Area (hidden initially) -->
            <div id="modal-story-content-area" class="content-hidden">
                <h2 id="modal-title" class="text-3xl md:text-4xl font-bold mb-5 text-center"></h2>
                <div id="modal-image-container">
                    <div class="spinner"></div> <!-- Spinner for image loading -->
                    <i class="fas fa-eye placeholder-icon"></i> <!-- Placeholder if image fails -->
                    <img id="modal-image" alt="Representación del relato" />
                </div>
                <div id="modal-content" class="text-lg">
                    <!-- Story text goes here -->
                </div>
                 <!-- Error Display Area -->
                <div id="modal-error" class="error-msg content-hidden">
                     <i class="fas fa-exclamation-triangle"></i>
                     <span id="modal-error-message"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-black text-gray-600 py-6 mt-12">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>Advertencia: Los relatos son generados por IA y pueden ser perturbadores. Procede bajo tu propio riesgo.</p>
            <p class="mt-2">© 2025 Mundo Creepypasta. La oscuridad te observa.</p>
        </div>
    </footer>

    <script>
        // ========== CONFIG & DATA ==========

        // --- Expanded List of Creepypasta Titles ---
        const predefinedTitles = [
             "La cinta VHS sin etiqueta", "El usuario desconocido de mi chat", "La niñera con ojos de botón",
             "No mires por la ventana después de las 3 AM", "El juego online que nadie recuerda", "La foto familiar donde falta alguien",
             "El sótano que se extiende", "El sonido que solo yo escucho", "Mi reflejo se mueve diferente",
             "Reglas extrañas de mi nuevo apartamento", "El parque infantil abandonado por la noche", "La canción que invoca algo",
             "Encontré un teléfono con fotos perturbadoras", "El maniquí que cambia de pose", "Nunca respondas a ese correo",
             "El bosque donde los árboles susurran nombres", "La transmisión de radio números", "El amigo imaginario que no se fue",
             "Grabaciones de voz del ático", "El hospital abandonado y sus pacientes", "La muñeca que parpadea sola",
             "Hay algo en el espejo del baño", "El ritual encontrado en un libro viejo", "Mi perro ladra a una esquina vacía",
             "El ascensor que va a un piso inexistente", "La sombra alargada bajo mi puerta", "El pueblo donde nadie duerme",
             "Desperté y mi familia fue reemplazada", "El foro de internet sobre lo imposible", "La figura en la fotografía antigua",
             "No abras la puerta después de medianoche", "El código morse en mi pared", "Mi gemelo malvado del espejo",
             "La casa que respira", "El circo abandonado", "El mensaje en la botella llegó del futuro",
             "La criatura del armario", "El túnel secreto en mi casa", "La aplicación que predice muertes",
             "Los columpios se mueven solos", "El último mensaje de un explorador urbano", "La cara en la estática de la TV",
             "Recibí una llamada de mi propio número", "El diario de un paciente mental", "La fotografía quemada",
             "El supermercado abierto 24h (demasiado tiempo)", "El olor dulce en la casa abandonada", "La niñera robótica defectuosa",
             "El hombre sonriente en mis sueños", "La señal de 'No Entrar' es por tu bien", "El faro que atrae barcos fantasma",
             "La guardería silenciosa", "El experimento militar filtrado", "Mi reflejo tiene cicatrices que yo no",
             "El parque de atracciones olvidado", "La grabación encontrada en el bosque", "El vecino que nunca sale",
             "La puerta roja al final del pasillo", "El pueblo borrado de los mapas", "La estatuilla que llora sangre",
             "No recojas autoestopistas en esta carretera", "El juguete que habla sin pilas", "La leyenda urbana que resultó ser real",
             "El vídeo maldito de YouTube", "La cabaña aislada en la nieve", "El programa de TV infantil perturbador",
             "La criatura que imita voces", "El mensaje oculto en la canción infantil", "La estación de metro abandonada",
             "El Doppelgänger en mi ciudad", "La pintura que envejece", "El lago donde la gente desaparece",
             "El archivo .exe encontrado en la deep web", "La habitación sellada", "El sonido de uñas rascando mi ventana",
             "El payaso en el desagüe", "La casa de muñecas viviente", "El ritual para ver el futuro (no lo hagas)",
             "El campamento de verano maldito", "La figura alta y delgada en la niebla", "El teléfono de juguete que recibe llamadas",
             "La carretera infinita", "El último hombre en la Tierra escuchó un golpe", "La máscara encontrada en el bosque",
             "El juego de escondite que salió mal", "La web que muestra tu muerte", "El hospital psiquiátrico en la colina",
             "La entidad en el espejo antiguo", "El ascensor a otro mundo", "La música que vuelve loca a la gente",
             "El diario encontrado en una casa demolida", "La sombra sin cuerpo", "El pueblo sumergido",
             "La grabación de seguridad nocturna", "El amigo por correspondencia inquietante", "La criatura bajo el puente",
             "El carnaval oscuro", "La app de citas con perfiles imposibles", "La biblioteca de libros prohibidos",
             "El hombre del saco es real", "La casa con demasiadas habitaciones", "El vídeo de vigilancia de mi propia casa",
             "La leyenda del Wendigo", "El sanatorio abandonado", "La ouija que funcionó",
             "El programa de radio pirata siniestro", "La fotografía de boda fantasmal", "El bosque que te observa",
             "La criatura marina desconocida", "El experimento del sueño ruso (ficción)", "La casa embrujada de Amityville (inspirado)",
             "El Slender Man (inspirado)", "El Polybius (inspirado)", "El Mothman (inspirado)",
             "La Llorona (adaptado)", "El Chupacabras (adaptado)", "El Krampus (adaptado)",
             "El sonido 'Bloop'", "La anomalía SCP (inspirado)", "El Backrooms (inspirado)",
             "El efecto Mandela perturbador", "La simulación tiene fallos", "El glitch en la matrix",
             "La transmisión interrumpida", "El número de teléfono maldito", "La webcam hackeada",
             "El GPS que lleva a lugares extraños", "La red social fantasma", "El archivo de audio 'Lavender Town Syndrome' (inspirado)",
             "El cartucho maldito de Zelda (inspirado)", "El episodio perdido de 'El Coraje del Perro Cobarde' (inspirado)", "El suicidio de Calamardo (inspirado)",
             "El mensaje subliminal en la película", "La teoría de conspiración que es verdad", "El experimento Filadelfia (inspirado)",
             "El Área 51 y sus secretos", "El proyecto MK Ultra (inspirado)", "La abducción alienígena real",
             "El hombre polilla de Point Pleasant", "El monstruo del Lago Ness (versión terror)", "El Bigfoot agresivo",
             "El Dybbuk Box (inspirado)", "La muñeca Annabelle (inspirado)", "El hotel Cecil y sus misterios",
             "El bosque de Aokigahara (con respeto)", "La isla de las muñecas (México)", "Las catacumbas de París (versión terror)",
             "El metro-2 de Moscú (leyenda)", "La ciudad subterránea de Derinkuyu (atmósfera)", "El Triángulo de las Bermudas (explicación paranormal)",
             "El incidente del paso Diatlov (interpretación)", "El misterio del Mary Celeste (interpretación)", "La desaparición de Roanoke (interpretación)",
             "El manuscrito Voynich (interpretación)", "La señal Wow! (interpretación)", "El 'Hombre de Sombrero'",
             "Los 'Niños de Ojos Negros'", "La 'Gente Sombra'", "El íncubo/súcubo",
             "El poltergeist violento", "La posesión demoníaca (relato)", "El exorcismo fallido",
             "El culto siniestro", "El sacrificio ritual", "El libro encuadernado en piel humana",
             "El Necronomicón (ficticio)", "La llamada de Cthulhu (inspirado)", "El horror cósmico lovecraftiano",
             "La criatura de Frankenstein (moderno)", "El vampiro real", "El hombre lobo urbano",
             "La momia vengativa", "El golem fuera de control", "La inteligencia artificial hostil",
             "El apocalipsis zombie (inicio)", "La plaga desconocida", "El fin del mundo silencioso",
             "El último superviviente", "La Tierra post-apocalíptica", "El viaje en el tiempo peligroso",
             "El universo paralelo oscuro", "La realidad alternativa aterradora", "El clon imperfecto",
             "La mutación genética horrible", "El experimento científico fallido", "La invasión alienígena silenciosa",
             "El parásito cerebral", "El virus que controla la mente", "La tecnología fuera de control",
             "La pesadilla recurrente que se vuelve real", "El sueño lúcido que no puedes controlar", "La parálisis del sueño con visitante",
             "El miedo irracional que cobra vida", "La fobia personificada", "La locura contagiosa",
             "La pérdida de identidad", "El doble perturbador", "La soledad extrema",
             "La claustrofobia en un lugar infinito", "La agorafobia en tu propia casa", "El miedo a la oscuridad total",
             "El silencio ensordecedor", "La mirada constante", "La sensación de ser observado"
        ];

        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un escritor experto en creepypastas y relatos de horror cortos (aproximadamente 300-500 palabras). Tu estilo es atmosférico, priorizando el suspense, la tensión psicológica, los detalles perturbadores y, a menudo, finales ambiguos o inquietantes. Evita el gore excesivo, céntrate en el miedo y lo inexplicable. Escribe un creepypasta completo basado únicamente en el siguiente título:",
            timeoutSeconds: 60 // Increased timeout for potentially longer stories
        };

         const titleGenerationConfig = {
             model: "mistral",
             systemPrompt: "Actúa como un generador de ideas conciso. Genera exactamente 15 ideas de títulos cortos y perturbadores para creepypastas o historias de terror. Devuelve *solo* la lista de títulos, uno por línea. No incluyas números, guiones, introducciones, despedidas ni ningún otro texto adicional. Cada línea debe ser solo un título.",
             prompt: "Genera 15 títulos de creepypasta", // Base prompt, can be varied
             timeoutSeconds: 30
         };

        // ========== DOM ELEMENTS ==========
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i'); // Spinner icon inside button
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ==========

        /**
         * Fetches text from Pollinations Text API with timeout and specific config.
         */
        async function fetchTextFromApi(prompt, config) {
            const encodedPrompt = encodeURIComponent(prompt);
            const encodedSystem = encodeURIComponent(config.systemPrompt);
            const params = new URLSearchParams({
                model: config.model,
                system: encodedSystem,
            });
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}): ${url}`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la API estaba vacía.");
                }
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                 }
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
            }
        }

        // Specific wrappers for story and title generation
        async function fetchStoryText(title) {
             const text = await fetchTextFromApi(title, textApiConfig);
              // Basic validation for story content
              if (text.trim().length < 100 || text.toLowerCase().includes("cannot fulfill")) {
                  console.warn("API returned potentially invalid story response:", text);
                  throw new Error("La IA no pudo generar un relato adecuado para este título.");
              }
             return text;
        }

        async function fetchGeneratedTitles() {
            const text = await fetchTextFromApi(titleGenerationConfig.prompt, titleGenerationConfig);
            // Parse the response: split by lines, trim, filter empty
            const titles = text.split('\n')
                               .map(line => line.trim())
                               .filter(line => line.length > 0);
            if (titles.length < 5) { // Expecting at least a few titles
                 console.warn("API returned too few titles:", titles);
                 throw new Error("No se pudieron generar suficientes ideas de títulos.");
            }
            // Return only up to 15, even if API returns more
            return titles.slice(0, 15);
        }


        /**
         * Generates the Pollinations Image API URL (Creepypasta themed).
         */
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = {
                seed: Math.floor(Math.random() * 10000000),
                width: 800,
                height: 600,
                nologo: true
            };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "escena de terror oscura";
            // More varied and creepy image prompts
            const styleKeywords = [
                "creepy atmosphere", "unsettling horror art", "liminal space horror",
                "analog horror style", "found footage still", "dark surrealism",
                "photorealistic horror", "disturbing painting", "eerie silence",
                "body horror concept", "psychological dread visualization"
            ];
            const randomStyle = getRandomElement(styleKeywords); // Get a random style keyword
            const enhancedPrompt = `${randomStyle} depicting ${safePromptText}, dark moody lighting, highly detailed`;

            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';

            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=bright, cheerful, happy, cute, cartoon, text, words`; // Added negative prompt
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url); // Log for debugging image prompts
            return url;
        }

        // ========== MODAL FUNCTIONS ========== (Mostly unchanged)

        function showModal() {
            if(!storyModal) return;
            storyModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function hideModal() {
             if(!storyModal) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            resetModalState();
        }

        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'block';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.textContent = '';
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.style.display = 'flex';
             modalErrorMessage.textContent = ''; // Clear specific error message
        }

        // ========== UI & EVENT HANDLERS ==========

        /**
         * Helper to get a random element from an array.
         */
        function getRandomElement(arr) {
            if (!arr || arr.length === 0) return null;
            return arr[Math.floor(Math.random() * arr.length)];
        }

        /**
         * Shuffles array in place using Fisher-Yates algorithm.
         */
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex > 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

         /**
         * Creates a single title item div.
         */
         function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            div.textContent = title;
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }

        /**
         * Displays the list of predefined titles in random order.
         */
        function displayTitles(titles) {
            if (!titleListContainer || !titlesLoading) return;

            const shuffledTitles = shuffleArray([...titles]); // Shuffle the provided titles

            titleListContainer.innerHTML = ''; // Clear previous
            titlesLoading.style.display = 'none';

            if (shuffledTitles.length === 0) {
                titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay relatos disponibles.</p>';
                return;
            }

            shuffledTitles.forEach(title => {
                titleListContainer.appendChild(createTitleItem(title));
            });
        }

        /**
         * Appends new titles to the existing list.
         */
         function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;

             newTitles.forEach(title => {
                 // Optional: Add a small delay/animation for appending?
                 titleListContainer.appendChild(createTitleItem(title));
             });
         }


        /**
         * Handles clicking on a title. Fetches and displays the story.
         */
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;

            try {
                const storyText = await fetchStoryText(title);

                modalLoadingIndicator.style.display = 'none';
                modalContent.textContent = storyText;
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageSpinner.style.display = 'block'; // Show image loading spinner AFTER text loads

                const imageUrl = createPollinationsImageUrl(title);

                 if (imageUrl) {
                     modalImage.onload = () => {
                         modalImageSpinner.style.display = 'none';
                         modalImagePlaceholder.style.display = 'none';
                         modalImage.style.display = 'block';
                     };
                     modalImage.onerror = () => {
                         console.error("Error loading image for title:", title);
                         modalImageSpinner.style.display = 'none';
                         modalImagePlaceholder.style.display = 'block';
                         modalImage.style.display = 'none';
                     };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL for title:", title);
                     modalImageSpinner.style.display = 'none';
                     modalImagePlaceholder.style.display = 'block';
                 }

            } catch (error) {
                console.error("Failed to display story:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `${error.message}`; // Display specific error
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.textContent = '';
            }
        }

         /**
         * Handles clicking the "Generate More Titles" button.
         */
         async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;

             generateMoreBtn.disabled = true;
             generateMoreBtn.textContent = 'Generando...'; // Change text
             generateMoreSpinner.classList.remove('hidden'); // Show spinner

             try {
                 const newTitles = await fetchGeneratedTitles();

                 if (newTitles && newTitles.length > 0) {
                     // Remove the button temporarily while adding titles
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     // Re-add the button container after titles are appended
                     // Ensures it stays at the bottom conceptually
                     if (titleListContainer.parentNode) { // Check if parent exists
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block'; // Show it again
                 } else {
                      // Handle case where API returned 0 valid titles
                      alert("No se pudieron generar nuevas ideas de títulos en este momento.");
                 }

             } catch (error) {
                 console.error("Failed to generate more titles:", error);
                 alert(`Error al generar más títulos: ${error.message}`); // Simple alert for user
             } finally {
                 // Always re-enable the button and reset its state
                 generateMoreBtn.disabled = false;
                 generateMoreSpinner.classList.add('hidden');
                 generateMoreBtn.textContent = 'Generar Más Títulos';
             }
         }

        // ========== INITIALIZATION ==========

        function initApp() {
            // Check for critical elements
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) {
                 console.error("Initialization failed: Critical elements missing.");
                 document.body.innerHTML = '<p style="padding: 2rem; text-align: center; color: red;">Error crítico al cargar la página. Faltan elementos esenciales.</p>';
                 return;
            }

            // --- Event Listeners ---
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

             // Close modal on overlay click
             storyModal.addEventListener('click', (event) => {
                 if (event.target === storyModal) {
                     hideModal();
                 }
             });

             // --- Initial Display ---
             // Display the initial set of predefined titles, shuffled
             displayTitles(predefinedTitles);

        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);

    </script>

</body>
</html>