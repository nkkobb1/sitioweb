<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Religión Celta Antigua - Sabiduría Ancestral</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes: Una decorativa para títulos, una legible para cuerpo -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Religión Celta Antigua --- */
        :root {
            --color-primary: #006400; /* Verde Bosque Oscuro */
            --color-secondary: #8B4513; /* Marrón Tierra/Madera */
            --color-tertiary: #DAA520; /* Dorado/Bronce Antiguo */
            --color-accent: #708090; /* Gris Piedra/Pizarra */
            --color-background: #f5f5dc; /* Beige Pergamino muy claro */
            --color-text: #3a3a3a; /* Gris Muy Oscuro (casi negro) */
            --color-text-muted: #696969; /* Gris Oscuro */
            --color-modal-bg: #fffff0; /* Marfil/Blanco Hueso */
            --color-border: #cd853f; /* Marrón Perú (borde más cálido) */
            --color-error-bg: #fff0f0; /* Fondo error rosado claro */
            --color-error-text: #8b0000; /* Texto error rojo oscuro */
            --color-error-border: #dca0a0; /* Borde error rojo pálido */

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.15);
            --border-radius: 6px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body {
            font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400;
            /* Sutil patrón de fondo */
            background-image: linear-gradient(rgba(245, 245, 220, 0.97), rgba(245, 245, 220, 0.97)),
                              url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='52' height='52' viewBox='0 0 52 52'%3E%3Cpath fill='%23d2b48c' fill-opacity='0.05' d='M0 17.83V0h17.83a3 3 0 0 1-5.66 2H5.9A5 5 0 0 1 0 7.17v10.66zm34.17 0V0h17.83v17.83a3 3 0 0 1-2 5.66V39.1A5 5 0 0 1 44.1 52H34.17v-10.66a3 3 0 0 1 5.66-2h6.27A5 5 0 0 1 52 34.17V17.83h-17.83zm0 17.84V52h17.83v-17.83a3 3 0 0 1 2-5.66V7.17A5 5 0 0 1 44.1 0H34.17v10.66a3 3 0 0 1-5.66 2h-6.27A5 5 0 0 1 16 17.83V35.67zm-17.84 0V52H0v-17.83a3 3 0 0 1 5.66-2H12A5 5 0 0 1 17.83 52v-10.66a3 3 0 0 1-2 5.66V23.49A5 5 0 0 1 10 16H0v17.83h16.33zM0 34.17V52h17.83v-17.83a3 3 0 0 1-5.66-2H5.9A5 5 0 0 1 0 26.51V34.17z'/%3E%3C/svg%3E");
            background-attachment: fixed;
        }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel Decorative', cursive; font-weight: 700; letter-spacing: 1px; }
        .logo { color: var(--color-primary); text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.4); /* Sombra marrón */ }
        .logo .alt-part { color: var(--color-secondary); } /* Parte del logo en marrón */
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-secondary); border-bottom: 2px solid var(--color-tertiary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(245, 245, 220, 0.9); backdrop-filter: blur(4px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Merriweather'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 100, 0, 0.15); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.3rem; }
        .title-item { background: var(--color-modal-bg); padding: 1.4rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Merriweather'; font-size: 1rem; border-left: 4px solid var(--color-secondary); }
        .title-item:hover { transform: translateY(-4px) scale(1.01); box-shadow: var(--shadow-lg); border-color: var(--color-primary); border-left-color: var(--color-primary); color: var(--color-primary); background-color: #faf8f0; }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.9rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel Decorative', cursive; font-size: 1.1rem; letter-spacing: 1px; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-md); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(40, 40, 30, 0.9); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 2px solid var(--color-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 500px; /* Para juego y chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-secondary); border: 1px solid var(--color-tertiary); border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-modal-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg) scale(1.1); box-shadow: 0 0 8px var(--color-primary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        #modal-story-content-area { flex-grow: 1; min-height: 0; display: none; flex-direction: column; }
        #modal-story-content-area.visible { display: flex; }

        /* Área de Contenido (Texto + Imagen) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) #e8e3d4;
        }
        #modal-content-area::-webkit-scrollbar { width: 9px; }
        #modal-content-area::-webkit-scrollbar-track { background: #e8e3d4; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid #e8e3d4; }

        #modal-content { padding: 0 5px; font-size: 1.08rem; } /* Texto un poco más grande */
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel Decorative', cursive; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 2px solid var(--color-tertiary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: 0 0 12px var(--color-tertiary); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(189, 195, 199, 0.6); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.8rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #faf8f0; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) #e8e3d4;
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: #e8e3d4; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.55; box-shadow: var(--shadow-sm); }
        .user-message { background-color: var(--color-secondary); color: white; margin-left: auto; text-align: left; font-weight: 400;}
        .ai-message { background-color: #e8f5e9; /* Verde muy pálido */ color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; border: 1px solid #c8e6c9; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Merriweather'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(0, 100, 0, 0.1); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1rem; flex-shrink: 0; }
        #chat-send-btn:hover:not(:disabled) { background-color: #004d00; transform: scale(1.05); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; transform: none; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Screen & Minigame ("Sacred Grove Protector") */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, rgba(0, 100, 0, 0.9) 0%, rgba(139, 69, 19, 0.9) 100%); /* Verde a Marrón */
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius);
            padding: 2rem; color: white; text-align: center;
        }
        #modal-loading.active { display: flex; }
        #loading-game-canvas {
            border: 3px solid var(--color-tertiary);
            background-color: #2f4f4f; /* Verde pizarra oscuro como fondo */
            max-width: 90%;
            /* Hacerlo más cuadrado o vertical quizás? */
            max-height: 65%;
            aspect-ratio: 3 / 4; /* Proporción más vertical */
            box-shadow: 0 0 20px rgba(218, 165, 32, 0.4);
            margin-bottom: 1rem;
            display: block;
        }
        #loading-instructions { font-size: 0.9rem; margin-top: 0.5rem; font-family: 'Merriweather'; text-shadow: 1px 1px 1px #000; }
        #loading-score { font-size: 1.4rem; font-family: 'Cinzel Decorative'; margin-top: 0.5rem; text-shadow: 1px 1px 2px #000; }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: var(--color-tertiary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Merriweather'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(30, 30, 20, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-tertiary); box-shadow: 0 0 25px var(--color-tertiary); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-tertiary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-tertiary); color: var(--color-secondary); transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-leaf mr-2 text-green-700"></i> <!-- Icono Hoja -->
                     Ecos <span class="alt-part">Celtas</span>
                     <i class="fas fa-om ml-2 text-yellow-600"></i> <!-- Icono Triskelion/Om -->
                 </h1>
             </div>
             <span class="text-md text-gray-700 font-semibold font-sans tracking-wide">» Sabiduría Ancestral «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Religión Celta Antigua</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora los mitos, dioses, rituales y creencias de los pueblos celtas que habitaron Europa hace milenios. Selecciona un tema o busca en los archivos.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar (Ej: Druidas, Morrigan, Samhain, Otro Mundo...)">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book text-yellow-700 mr-2"></i> <!-- Icono Libro -->
                 Temas de Estudio
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los anales antiguos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron registros sobre ese tema en los archivos druídicos «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar 40 Enseñanzas Más
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <canvas id="loading-game-canvas" width="300" height="400">Canvas no soportado.</canvas>
                 <p id="loading-instructions">¡Protege el Robledal! (Usa ← / →)</p>
                 <p id="loading-score">Puntos: 0 | Nivel: 1</p>
                 <div class="loading-spinner-modal content-hidden"></div> <!-- Fallback -->
             </div>

             <!-- Content Area Wrapper (Initially Hidden) -->
             <div id="modal-story-content-area">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder added via JS -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al oráculo...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Profundiza en el tema...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-feather-alt"></i></button> <!-- Icono pluma -->
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gradient-to-r from-green-100 to-yellow-100 text-gray-700 py-6 mt-12 border-t border-gray-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA basada en estudios históricos y mitológicos sobre la religión celta antigua.</p>
              <p class="mt-1">Las interpretaciones pueden variar. Consulta fuentes académicas para estudios profundos.</p>
              <p class="mt-2">© 2025 Ecos Celtas</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Dioses y Diosas Principales (Irlanda)
            "El Dagda: El Buen Dios, Padre de Todos", "La Morrígan: Diosa de la Guerra, Destino y Soberanía", "Lugh Lámhfada: El de la Larga Mano, Dios de Múltiples Talentos", "Brigid: Diosa del Fuego, Poesía, Sanación y Herrería", "Manannán mac Lir: Dios del Mar y el Otro Mundo", "Nuada Airgetlám: El del Brazo de Plata, Rey de los Tuatha Dé Danann", "Dian Cécht: El Sanador de los Dioses", "Goibniu: El Herrero Divino", "Credne: El Orfebre Divino", "Luchtaine: El Carpintero Divino", "Áine: Diosa del Verano, Riqueza y Soberanía", "Aengus Óg (Mac Óg): Dios del Amor y la Juventud", "Boann: Diosa del Río Boyne", "Danu: La Diosa Madre de los Tuatha Dé Danann", "Ogma: Dios de la Elocuencia y Creador del Ogham", "Midir: Señor del Otro Mundo de Brí Léith", "Eriu, Banba y Fódla: Diosas Epónimas de Irlanda", "Macha: Aspecto de la Morrígan, Diosa de los Caballos y la Guerra", "Badb: Cuervo de Batalla, Aspecto de la Morrígan", "Neit: Dios de la Guerra Primigenio",
            // Dioses y Diosas (Galia y Britania - Nombres Romanizados/Nativos)
            "Cernunnos: El Dios Astado de la Naturaleza y la Fertilidad", "Epona: Diosa Protectora de los Caballos", "Taranis: Dios del Trueno (Equivalente a Júpiter)", "Teutates: Dios del Pueblo o la Tribu", "Esus: Dios posiblemente asociado a los árboles o sacrificios", "Belenus: Dios del Sol y la Sanación (Equivalente a Apolo)", "Sucellus: Dios del Martillo, Agricultura y Prosperidad", "Nantosuelta: Consorte de Sucellus, Diosa de la Naturaleza y el Hogar", "Sirona: Diosa de la Sanación y las Aguas Termales", "Maponos: Dios de la Juventud (Apolo Maponos)", "Grannus: Dios de las Aguas Termales y la Sanación", "Andrasta: Diosa de la Victoria (Invocada por Boudica)", "Coventina: Diosa de los Pozos y Manantiales", "Nodens: Dios de la Sanación, el Mar y la Caza (Templo en Lydney Park)", "Rosmerta: Diosa de la Fertilidad y la Abundancia", "Brighid/Brigantia: Equivalente Britana/Gala de Brigid", "Lugus/Lugoves: Equivalente Galo/Britano de Lugh", "Matronae (Las Madres): Tríadas de Diosas Madres", "Sequana: Diosa del Río Sena", "Vosegus: Dios de los Vosgos",
            // Ciclos Mitológicos Irlandeses
            "El Ciclo Mitológico: La Llegada de los Tuatha Dé Danann", "La Primera Batalla de Mag Tuired: Tuatha Dé vs Fir Bolg", "La Segunda Batalla de Mag Tuired: Tuatha Dé vs Fomorianos", "La Muerte de Balor del Mal Ojo a Manos de Lugh", "El Destino de los Hijos de Lir (Tragedia)", "El Destino de los Hijos de Tuireann (Tragedia)", "La Corte de Aengus Óg (Brugh na Bóinne)", "El Robo del Arpa del Dagda", "Midir y Étaín: Amor y Celos Divinos", "El Ciclo del Ulster: El Nacimiento de Cú Chulainn", "El Táin Bó Cúailnge (El Robo del Ganado de Cooley)", "La Debilidad de los Ulates", "La Furia Guerrera (Ríastrad) de Cú Chulainn", "El Duelo de Cú Chulainn y Ferdiad", "La Muerte de Cú Chulainn", "Deirdre de los Dolores y el Exilio de los Hijos de Uisneach", "Bricriu y su Festín Venenoso", "El Ciclo Feniano (o de Ossian): Fionn mac Cumhaill y la Fianna", "El Nacimiento de Fionn mac Cumhaill", "Fionn y el Salmón del Conocimiento", "Las Aventuras de la Fianna: Caza y Guerra", "Oisín y Niamh del Cabello Dorado: Viaje a Tír na nÓg", "La Batalla de Gabhra: El Fin de la Fianna", "El Ciclo de los Reyes (Histórico/Legendario): Reyes como Cormac mac Airt, Conn Cétchathach", "La Historia de Labraid Loingsech", "El Reinado de Niall de los Nueve Rehenes",
            // Druidas, Prácticas y Creencias
            "Los Druidas: Sacerdotes, Jueces, Filósofos y Consejeros", "La Formación de un Druida: Memorización y Años de Estudio", "El Papel de los Druidas en la Sociedad Celta", "Sacrificios Humanos en la Religión Celta: Evidencia y Controversia (Visión Romana vs Arqueología)", "El Culto a las Cabezas Cortadas: Significado y Práctica", "La Creencia en el Otro Mundo (Tír na nÓg, Mag Mell, Annwn)", "Características del Otro Mundo Celta", "Viajes al Otro Mundo (Echtrae y Immram)", "La Doctrina de la Reencarnación o Transmigración del Alma", "Animismo Celta: La Sacralidad de la Naturaleza (Ríos, Montañas, Árboles)", "Nemeton: El Robledal o Santuario Sagrado", "Culto a las Aguas: Pozos y Manantiales Sagrados", "El Roble y el Muérdago: Simbolismo y Uso Druídico", "La Adivinación y la Profecía: El Papel del Vate (Filid)", "El Ogham: Alfabeto Rúnico Celta y su Uso Mágico/Conmemorativo", "Geasa (Singular Geis): Tabúes y Obligaciones Mágicas Personales", "La Importancia de la Palabra Hablada: Sátira y Bendición", "El Concepto de Soberanía y la Diosa de la Tierra", "La Triple Diosa: Doncella, Madre y Anciana (Interpretación Moderna vs Antigua)", "El Calendario Celta y sus Festivales",
            // Festivales y Rituales
            "Samhain (c. 1 de Noviembre): Festival de los Muertos, Fin del Verano, Año Nuevo Celta", "Rituales y Creencias Asociadas a Samhain", "Imbolc (c. 1 de Febrero): Festival de la Purificación, Asociado a Brigid, Primeros Signos de Primavera", "Rituales y Creencias Asociadas a Imbolc", "Beltane (c. 1 de Mayo): Festival del Fuego, Fertilidad, Comienzo del Verano", "Los Fuegos de Beltane y Rituales Asociados", "Lughnasadh (c. 1 de Agosto): Festival de la Cosecha, Dedicado a Lugh", "Juegos Funerarios y Rituales de Lughnasadh", "La Importancia del Fuego en los Rituales Celtas", "Ofrendas Votivas en Lagos, Pantanos y Ríos", "El Banquete Ritual: Hospitalidad y Jerarquía", "Música y Poesía en las Ceremonias Religiosas", "El Papel del Bardo en la Sociedad y Religión", "Peregrinaciones a Lugares Sagrados", "Ritos de Paso: Nacimiento, Mayoría de Edad, Muerte",
            // Símbolos, Arte y Arqueología
            "El Nudo Celta Interminable: Simbolismo de Continuidad y Eternidad", "El Triskelion o Triple Espiral: Significados Posibles (Vida-Muerte-Renacimiento, Tierra-Mar-Cielo)", "La Espiral Simple y Doble: Crecimiento y Ciclos", "El Árbol de la Vida Celta (Crann Bethadh)", "El Simbolismo del Caldero (Caldero del Dagda, Caldero de Gundestrup)", "El Torc: Collar Ritual de Nobleza y Divinidad", "Representaciones de Cernunnos en el Arte Celta", "Iconografía de Epona con Caballos", "El Jabalí como Símbolo de Guerra y Hospitalidad", "El Salmón como Símbolo de Sabiduría", "El Cuervo como Mensajero del Otro Mundo y Símbolo de la Morrígan", "Estelas y Piedras Grabadas (Ogham)", "Sitios Megalíticos: Newgrange, Knowth, Dowth (Brú na Bóinne)", "Stonehenge: ¿Conexión Celta o Pre-Celta?", "Círculos de Piedras y Menhires: Función Ritual", "Hillforts (Castros) y su Posible Dimensión Religiosa", "Hallazgos Arqueológicos en Pantanos (Hombre de Lindow)", "El Caldero de Gundestrup: Iconografía y Origen", "El Carro Solar de Trundholm (Edad de Bronce, contexto relacionado)", "El Arte de La Tène: Estilo Artístico Celta",
            // Legado e Interpretaciones Modernas
            "La Supervivencia de Mitos Celtas en el Cristianismo Irlandés", "Los Monjes Irlandeses como Preservadores de la Mitología", "Influencia Celta en las Leyendas Artúricas", "El Neodruidismo y el Neopaganismo Celta Contemporáneo", "Reconstruccionismo Celta: Intentos de Revivir la Antigua Religión", "Diferencias entre Religión Celta Antigua y Wicca/Paganismo Moderno", "Interpretaciones Feministas de las Diosas Celtas", "El Legado Celta en el Folklore (Hadas, Banshees, Leprechauns)", "La Imagen Romántica vs Histórica de los Celtas y Druidas", "Desafíos en el Estudio de la Religión Celta (Fuentes Fragmentarias y Sesgadas)", "La Contribución de la Arqueología al Conocimiento Celta", "Lingüística Comparada y Reconstrucción de Nombres Divinos Proto-Celtas",
             // Añadir más títulos específicos combinando elementos...
        ];
        const celticThemes = [ // Para generar más títulos
            "dioses irlandeses", "diosas celtas", "mitología gala", "mitología britana", "Tuatha Dé Danann", "Fomorianos", "Ciclo del Ulster", "Cú Chulainn", "Ciclo Feniano", "Fionn mac Cumhaill", "druidas", "creencias druídicas", "Otro Mundo celta", "Tír na nÓg", "reencarnación celta", "festivales celtas", "Samhain", "Beltane", "Imbolc", "Lughnasadh", "lugares sagrados celtas", "Newgrange", "simbolismo celta", "nudos celtas", "triskelion", "Ogham", "arte celta La Tène", "sacrificios celtas", "animismo celta", "Caldero de Gundestrup", "Morrígan", "Lugh", "Brigid", "Cernunnos", "Epona", "neodruidismo", "influencia celta"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un erudito especializado en historia antigua y religiones comparadas, con un profundo conocimiento de los pueblos celtas de Irlanda, Britania y la Galia continental. Tu tarea es proporcionar una explicación detallada, académica pero accesible, sobre el dios, mito, concepto, ritual o tema específico de la religión celta antigua que se te indique. Basa tu respuesta en fuentes históricas (romanas, irlandesas medievales), evidencia arqueológica y análisis académicos modernos. Aborda diferentes perspectivas si existen (ej. interpretaciones romanas vs. reconstrucciones actuales). Sé objetivo y respetuoso con las creencias antiguas. El objetivo es una descripción completa de aproximadamente 1200-1300 palabras. Céntrate únicamente en el siguiente tema:",
            timeoutSeconds: 180 // Más tiempo para temas académicos potencialmente densos
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente de investigación especializado en el tema específico de la religión celta antigua que se está mostrando. Responde preguntas de seguimiento sobre detalles, conexiones con otros temas celtas, fuentes de información o interpretaciones mencionadas en el texto principal. Mantén un tono académico y céntrate estrictamente en el tema actual.",
            timeoutSeconds: 50
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de temas de estudio sobre religión celta antigua. Genera exactamente 40 títulos específicos y académicos sobre dioses, diosas, mitos, ciclos, druidas, rituales, festivales, conceptos, símbolos o lugares sagrados celtas (irlandeses, galos, britanos). Devuelve *solo* la lista, un ítem por línea, sin números, guiones, introducciones ni conclusiones.",
            timeoutSeconds: 60
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, sólo verificando IDs)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Loading Game Elements
        const gameCanvas = document.getElementById('loading-game-canvas');
        const gameCtx = gameCanvas.getContext('2d');
        const loadingInstructions = document.getElementById('loading-instructions');
        const loadingScoreDisplay = document.getElementById('loading-score');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Renombrado para claridad
        let gameLoopId = null;
        let isGameRunning = false;

        // ========== MINIGAME VARIABLES & LOGIC ("Sacred Grove Protector") ==========
        const groveGameConfig = {
            playerWidth: 40, playerHeight: 20, playerSpeed: 6, playerColor: '#8B4513', // Marrón (Druida simple)
            itemSize: 15, itemFallSpeedMin: 1.5, itemFallSpeedMax: 3, goodItemColor: '#DAA520', // Dorado (Muérdago/Bellota)
            obstacleSize: 20, obstacleFallSpeedMin: 2, obstacleFallSpeedMax: 4, badItemColor: '#708090', // Gris (Sombra/Hacha)
            spawnRateItems: 0.018, // Probabilidad por frame
            spawnRateObstacles: 0.012,
            scorePerItem: 15, scoreLostOnHit: 30,
            levelUpScore: 200,
            speedIncreasePerLevel: 0.3,
            spawnRateIncreasePerLevel: 0.003,
        };

        let grovePlayer = { x: gameCanvas.width / 2 - groveGameConfig.playerWidth / 2, y: gameCanvas.height - groveGameConfig.playerHeight - 10 };
        let goodItems = []; // {x, y, speed}
        let badItems = []; // {x, y, speed}
        let groveScore = 0;
        let groveLevel = 1;
        let currentItemFallSpeedMin = groveGameConfig.itemFallSpeedMin;
        let currentItemFallSpeedMax = groveGameConfig.itemFallSpeedMax;
        let currentObstacleFallSpeedMin = groveGameConfig.obstacleFallSpeedMin;
        let currentObstacleFallSpeedMax = groveGameConfig.obstacleFallSpeedMax;
        let currentGoodItemSpawnRate = groveGameConfig.spawnRateItems;
        let currentBadItemSpawnRate = groveGameConfig.spawnRateObstacles;
        let groveKeysPressed = {};

        function resetGroveGame() {
            grovePlayer.x = gameCanvas.width / 2 - groveGameConfig.playerWidth / 2;
            goodItems = [];
            badItems = [];
            groveScore = 0;
            groveLevel = 1;
            currentItemFallSpeedMin = groveGameConfig.itemFallSpeedMin;
            currentItemFallSpeedMax = groveGameConfig.itemFallSpeedMax;
            currentObstacleFallSpeedMin = groveGameConfig.obstacleFallSpeedMin;
            currentObstacleFallSpeedMax = groveGameConfig.obstacleFallSpeedMax;
            currentGoodItemSpawnRate = groveGameConfig.spawnRateItems;
            currentBadItemSpawnRate = groveGameConfig.spawnRateObstacles;
            groveKeysPressed = {};
            loadingScoreDisplay.textContent = `Puntos: 0 | Nivel: 1`;
            console.log("Grove Game Reset");
        }

        function handleGroveKeyDown(e) {
             groveKeysPressed[e.key] = true;
             if (['ArrowLeft', 'ArrowRight'].includes(e.key)) {
                 e.preventDefault();
             }
         }
        function handleGroveKeyUp(e) {
             groveKeysPressed[e.key] = false;
         }

        function updateGroveGame() {
            if (!isGameRunning) return;

            // Player Movement
            if (groveKeysPressed['ArrowLeft'] && grovePlayer.x > 0) {
                grovePlayer.x -= groveGameConfig.playerSpeed;
            }
            if (groveKeysPressed['ArrowRight'] && grovePlayer.x < gameCanvas.width - groveGameConfig.playerWidth) {
                grovePlayer.x += groveGameConfig.playerSpeed;
            }

            // Spawn Good Items
            if (Math.random() < currentGoodItemSpawnRate) {
                goodItems.push({
                    x: Math.random() * (gameCanvas.width - groveGameConfig.itemSize),
                    y: -groveGameConfig.itemSize, // Start above canvas
                    speed: currentItemFallSpeedMin + Math.random() * (currentItemFallSpeedMax - currentItemFallSpeedMin)
                });
            }

            // Spawn Bad Items
            if (Math.random() < currentBadItemSpawnRate) {
                badItems.push({
                    x: Math.random() * (gameCanvas.width - groveGameConfig.obstacleSize),
                    y: -groveGameConfig.obstacleSize,
                    speed: currentObstacleFallSpeedMin + Math.random() * (currentObstacleFallSpeedMax - currentObstacleFallSpeedMin)
                });
            }

            // Move & Check Collisions - Good Items
            goodItems.forEach((item, index) => {
                item.y += item.speed;
                if (item.y > gameCanvas.height) {
                    goodItems.splice(index, 1); // Remove if missed
                }
                // Collision with Player
                if (grovePlayer.x < item.x + groveGameConfig.itemSize &&
                    grovePlayer.x + groveGameConfig.playerWidth > item.x &&
                    grovePlayer.y < item.y + groveGameConfig.itemSize &&
                    grovePlayer.y + groveGameConfig.playerHeight > item.y) {
                    groveScore += groveGameConfig.scorePerItem;
                    goodItems.splice(index, 1);
                    checkGroveLevelUp();
                }
            });

            // Move & Check Collisions - Bad Items
            badItems.forEach((item, index) => {
                item.y += item.speed;
                if (item.y > gameCanvas.height) {
                    badItems.splice(index, 1);
                }
                // Collision with Player
                if (grovePlayer.x < item.x + groveGameConfig.obstacleSize &&
                    grovePlayer.x + groveGameConfig.playerWidth > item.x &&
                    grovePlayer.y < item.y + groveGameConfig.obstacleSize &&
                    grovePlayer.y + groveGameConfig.playerHeight > item.y) {
                    groveScore = Math.max(0, groveScore - groveGameConfig.scoreLostOnHit);
                    badItems.splice(index, 1); // Remove on hit
                }
            });

            loadingScoreDisplay.textContent = `Puntos: ${groveScore} | Nivel: ${groveLevel}`;
        }

        function checkGroveLevelUp() {
            const nextLevelThreshold = groveLevel * groveGameConfig.levelUpScore;
            if (groveScore >= nextLevelThreshold) {
                groveLevel++;
                // Increase difficulty
                currentItemFallSpeedMin += groveGameConfig.speedIncreasePerLevel;
                currentItemFallSpeedMax += groveGameConfig.speedIncreasePerLevel;
                currentObstacleFallSpeedMin += groveGameConfig.speedIncreasePerLevel;
                currentObstacleFallSpeedMax += groveGameConfig.speedIncreasePerLevel;
                currentGoodItemSpawnRate = Math.min(0.08, currentGoodItemSpawnRate + groveGameConfig.spawnRateIncreasePerLevel);
                currentBadItemSpawnRate = Math.min(0.06, currentBadItemSpawnRate + groveGameConfig.spawnRateIncreasePerLevel);

                console.log(`Grove Level Up! Level: ${groveLevel}, Speeds: ${currentItemFallSpeedMin.toFixed(1)}-${currentObstacleFallSpeedMax.toFixed(1)}, Spawns: ${currentGoodItemSpawnRate.toFixed(4)}/${currentBadItemSpawnRate.toFixed(4)}`);
                // Simple visual feedback
                 gameCanvas.style.borderColor = ['#DAA520', '#C0C0C0', '#CD7F32'][groveLevel % 3]; // Gold, Silver, Bronze
                 setTimeout(() => { gameCanvas.style.borderColor = 'var(--color-tertiary)'; }, 300);
            }
        }

        function drawGroveGame() {
            if (!isGameRunning || !gameCtx) return;

            // Clear Canvas
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

             // Background (simple gradient)
             const grad = gameCtx.createLinearGradient(0, 0, 0, gameCanvas.height);
             grad.addColorStop(0, '#2E8B57'); // Sea Green
             grad.addColorStop(1, '#006400'); // Dark Green
             gameCtx.fillStyle = grad;
             gameCtx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

            // Draw Player (simple rect)
            gameCtx.fillStyle = groveGameConfig.playerColor;
            gameCtx.fillRect(grovePlayer.x, grovePlayer.y, groveGameConfig.playerWidth, groveGameConfig.playerHeight);
             // Simple hood shape
             gameCtx.beginPath();
             gameCtx.moveTo(grovePlayer.x, grovePlayer.y);
             gameCtx.lineTo(grovePlayer.x + groveGameConfig.playerWidth / 2, grovePlayer.y - 10);
             gameCtx.lineTo(grovePlayer.x + groveGameConfig.playerWidth, grovePlayer.y);
             gameCtx.closePath();
             gameCtx.fillStyle = '#556B2F'; // Dark Olive Green
             gameCtx.fill();


            // Draw Good Items (circles/leaves)
            gameCtx.fillStyle = groveGameConfig.goodItemColor;
            goodItems.forEach(item => {
                 // Simple leaf shape
                 gameCtx.beginPath();
                 gameCtx.ellipse(item.x + groveGameConfig.itemSize / 2, item.y + groveGameConfig.itemSize / 2,
                                 groveGameConfig.itemSize / 3, groveGameConfig.itemSize / 2, Math.PI / 4, 0, Math.PI * 2);
                 gameCtx.fill();
            });

            // Draw Bad Items (squares/spikes)
            gameCtx.fillStyle = groveGameConfig.badItemColor;
            badItems.forEach(item => {
                 // Simple spiky shape
                 gameCtx.beginPath();
                 gameCtx.moveTo(item.x, item.y);
                 gameCtx.lineTo(item.x + groveGameConfig.obstacleSize, item.y);
                 gameCtx.lineTo(item.x + groveGameConfig.obstacleSize / 2, item.y + groveGameConfig.obstacleSize);
                 gameCtx.closePath();
                 gameCtx.fill();
            });
        }

        function groveGameLoop() {
            if (!isGameRunning) return;
            updateGroveGame();
            drawGroveGame();
            gameLoopId = requestAnimationFrame(groveGameLoop);
        }

        function startGroveGameLoop() {
            if (isGameRunning) return;
            console.log("Starting Grove Game Loop");
            isGameRunning = true;
            resetGroveGame(); // Reset state
            document.addEventListener('keydown', handleGroveKeyDown);
            document.addEventListener('keyup', handleGroveKeyUp);
            gameLoopId = requestAnimationFrame(groveGameLoop);
            modalLoadingIndicator.classList.add('active');
            gameCanvas.style.display = 'block';
        }

        function stopGroveGameLoop() {
            if (!isGameRunning) return;
            console.log("Stopping Grove Game Loop");
            isGameRunning = false;
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
                gameLoopId = null;
            }
            document.removeEventListener('keydown', handleGroveKeyDown);
            document.removeEventListener('keyup', handleGroveKeyUp);
        }

        // ========== AD FILTER FUNCTION ==========
        function filterAds(rawText) {
            if (!rawText) return '';
            // Regex to target lines starting with --- and containing common ad keywords or patterns
            // It looks for lines starting with '---', possibly some whitespace, then keywords like 'Protect', 'Enhance', 'Try',
            // mentioning known VPNs or similar services, and ending optionally with 'Learn more' or similar phrases.
            const adPatterns = [
                /^---\s*.*?(NordVPN|Surfshark|ExpressVPN|Atlas VPN|CyberGhost|Private Internet Access).*?(\n|$)/gim,
                /^---\s*(Protect your|Enhance your|Get|Try|Secure your).*?(subscription|service|network|browsing).*?(Learn more|\.|\!?)(\n|$)/gim
                // Can add more specific patterns if needed
            ];

            let filteredText = rawText;
            adPatterns.forEach(pattern => {
                filteredText = filteredText.replace(pattern, '');
            });

            // Also remove potential empty lines left after removal
            filteredText = filteredText.replace(/^\s*$/gm, '');

            if (rawText.length !== filteredText.length) {
                console.log("Potential ad filtered from the text.");
            }
            return filteredText.trim(); // Trim final result
        }


        // ========== API FUNCTIONS ========== (Integrate Ad Filter)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Eres un asistente de investigación especializado únicamente en el tema celta '${currentTopicTitle}'. Responde preguntas de seguimiento sobre detalles, fuentes o conexiones relacionadas *con ese tema específico*.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores están experimentando mucho tráfico. Por favor, intenta de nuevo en unos segundos.`);
                 let text = await response.text(); // Get raw text

                 // *** FILTER ADS (only for main explanation, not chat or titles) ***
                 if (!isChat && config === textApiConfig) {
                     text = filterAds(text);
                 }

                 if (!text || text.trim().length < (isChat ? 10 : 300)) { // Lowered min length slightly for academic topics
                      throw new Error("La respuesta de la IA fue demasiado corta o vacía. Intenta de nuevo o con otro tema.");
                  }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
         }
        // Wrappers remain the same
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Error interno: Contexto del tema no establecido para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(celticThemes) || "mitología celta general";
            const specificPrompt = `Genera 40 temas de estudio específicos sobre ${randomTheme}`;
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 8 && line.length < 180 && !/^\s*$/.test(line) && !line.toLowerCase().includes("lista de temas") && !line.toLowerCase().includes("aquí tienes")).slice(0, 40);
                     if (titles.length < 15) throw new Error("La IA no generó suficientes temas válidos.");
                     return titles;
                 });
        }

        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 896, height: 640, nologo: true }; // Slightly different ratio
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "ancient celtic ritual in a sacred grove";
            const enhancedPrompt = `Mystical artwork depicting ancient celtic religion concept: '${safePromptText}'. Earthy tones, intricate knotwork details (subtle), atmospheric lighting (misty, dappled sunlight), style inspired by La Tène art and Book of Kells illumination. Avoid modern depictions.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, logo, watermark, signature, photograph, 3D render, cartoon, anime, modern clothing, christian symbols, bright neon colors, clear blue sky";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
         }

        // ========== Text Formatting Function ========== (Sin cambios)
        function formatExplanationText(rawText){ if(!rawText)return'';let formatted=rawText.trim();formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1');formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('−','-');return`${base}<sup>${cleanExponent}</sup>`;});formatted=formatted.replace(/\\rightarrow/g,'&rarr;');formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>');const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0);formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block;let content=block.replace(/\n/g,' ');return`<p>${content}</p>`;}).join('');return formatted;}

        // ========== MODAL FUNCTIONS ========== (Gestionando el nuevo juego)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            stopGroveGameLoop(); // Detener juego celta
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             stopGroveGameLoop(); // Detener juego celta
             modalLoadingIndicator.classList.remove('active');
             modalStoryContentArea.classList.remove('visible');
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios)
        function showFullscreenImage(imgSrc){if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden';}
        function hideFullscreenImage(){if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src='';}

        // ========== CHAT FUNCTIONS ========== (Sin cambios funcionales)
        function addChatMessage(message, sender){const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        function addChatError(message){const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        async function handleSendMessage(){const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Error IA: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}}

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title){const div=document.createElement('div');div.className='title-item';div.textContent=title;div.setAttribute('data-title',title);div.addEventListener('click',()=>handleTitleClick(title));return div;}
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» Los archivos están vacíos por ahora. Intenta generar más temas. «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
             console.log(`Displayed ${sortedTitles.length} titles.`);
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             console.log(`Appending ${newTitles.length} new titles.`);
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Successfully added ${addedCount} unique titles.`);
             filterTitles(searchInput.value); // Re-apply search filter
         }

        // *** MODIFIED: handleTitleClick to manage Celtic game & Ad Filter ***
        async function handleTitleClick(title) {
            resetModalState(); // Limpia todo, para juego anterior
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // Set chat context
            chatHistory.innerHTML = ''; // Clear chat

            // *** START LOADING & GROVE GAME ***
            modalLoadingIndicator.classList.add('active');
            startGroveGameLoop(); // Iniciar juego Celta

            try {
                // Fetch explanation (includes ad filtering inside fetchTextFromApi now)
                const explanationPromise = fetchExplanationText(title);

                // Fetch image URL
                const imageUrl = createPollinationsImageUrl(title);

                // Await explanation
                const filteredExplanationText = await explanationPromise;

                // *** STOP GAME & SHOW CONTENT ***
                stopGroveGameLoop();
                modalLoadingIndicator.classList.remove('active');
                modalStoryContentArea.classList.add('visible');
                modalStoryContentArea.classList.remove('content-hidden');

                // Process and display explanation
                const formattedExplanation = formatExplanationText(filteredExplanationText);
                modalContent.innerHTML = formattedExplanation;
                modalTextArea.scrollTop = 0;

                // Image Handling
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-tree placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Evocando imagen ancestral...</p>`;
                modalContent.appendChild(placeholderDiv);

                if (imageUrl) {
                    const imgElement = document.createElement('img');
                    imgElement.className = 'final-image';
                    imgElement.alt = `Representación artística de ${title}`;
                    imgElement.style.display = 'none';
                    imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                    imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">La visión no es clara (Error imagen).</p>`; };
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                    placeholderDiv.innerHTML = `<i class="fas fa-ban placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo generar imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                // *** STOP GAME & SHOW ERROR ***
                stopGroveGameLoop();
                modalLoadingIndicator.classList.remove('active');
                modalStoryContentArea.classList.add('visible');
                modalStoryContentArea.classList.remove('content-hidden');

                modalErrorMessage.textContent = error.message || "Error desconocido al consultar los anales.";
                modalError.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando al Oráculo...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Pide 40
                 if (newTitles && newTitles.length > 0) appendTitles(newTitles);
                 else alert("El oráculo no ofreció nuevas enseñanzas ahora.");
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error del oráculo: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Revelar 40 Enseñanzas Más';
             }
         }

         // Search Filter Function (con normalización)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !gameCanvas || !loadingScoreDisplay) {
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Los elementos sagrados de la página no se encuentran.</p>';
                 return;
             }
            // Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>