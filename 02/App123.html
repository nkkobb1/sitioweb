<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enciclopedia de Enfermedades - Historia y Actualidad</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Claras y Profesionales -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Enciclopedia Médica/Histórica --- */
        :root {
            --color-primary: #2563eb; /* Azul Estándar (Confianza, Profesionalismo) */
            --color-secondary: #10b981; /* Verde Esmeralda (Salud, Ciencia) - Uso moderado */
            --color-tertiary: #64748b; /* Gris Azulado (Neutralidad, Texto) */
            --color-background: #f8fafc; /* Blanco Hueso / Gris Muy Claro */
            --color-text: #1f2937; /* Gris Muy Oscuro (Texto Principal) */
            --color-text-muted: #4b5563; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro */
            --color-border: #e5e7eb; /* Borde Gris Claro */
            --color-error-bg: #fff1f2; /* Fondo error rosa pálido */
            --color-error-text: #be123c; /* Texto error rojo oscuro */
            --color-error-border: #fecdd3; /* Borde error rosa */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 500; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alineación a la izquierda */ font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; /* Centrado vertical */ min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item i { margin-right: 0.6rem; color: var(--color-tertiary); width: 16px; text-align: center; transition: color 0.2s ease;} /* Icono opcional */
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #eff6ff; /* Azul muy claro hover */ border-left-color: var(--color-primary); }
        .title-item:hover i { color: var(--color-primary); }

        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1d4ed8; /* Azul más oscuro */ box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; } /* Spinner blanco */

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 500; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; background-color: #f9fafb; /* Fondo claro para imagen */ }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); border: 1px dashed var(--color-border); border-radius: var(--border-radius); padding: 1rem; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(107, 114, 128, 0.2); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; /* Fondo muy claro */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95em;}
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; font-weight: 400;}
        .ai-message { background-color: #e5e7eb; /* Gris claro */ color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; }
        .chat-disclaimer { font-size: 0.8em; color: var(--color-text-muted); text-align: center; padding: 0.5rem; font-style: italic; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15); }
        #chat-send-btn { padding: 0.7rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #1d4ed8; }
        #chat-send-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 500; color: var(--color-text); font-size: 1.3rem; font-family: 'Roboto'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); box-shadow: var(--shadow-lg); background-color: white; }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-book-medical mr-3 text-blue-600"></i> <!-- Icono libro médico -->
                     Enciclopedia de Enfermedades
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">Historia y Actualidad</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Explorando la Salud Humana a Través del Tiempo</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Consulta información sobre enfermedades que han marcado la historia y las que nos afectan hoy. Selecciona una condición o busca por nombre.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar enfermedad o condición...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-notes-medical text-blue-500 mr-2"></i> <!-- Icono notas médicas -->
                 Índice de Condiciones
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando índice de enfermedades...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No se encontraron coincidencias para la búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Cargar Más Temas Relacionados
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Consultando Información...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <div class="chat-disclaimer">
                         <i class="fas fa-info-circle"></i> Esta IA ofrece información general. No sustituye el consejo médico profesional.
                     </div>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando pregunta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Haz una pregunta sobre esta condición...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Conceptual Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p><i class="fas fa-info-circle"></i> La información presentada es generada por IA con fines educativos e históricos. <strong>No constituye consejo médico.</strong></p>
              <p class="mt-1">Consulta siempre a un profesional de la salud para diagnósticos y tratamientos.</p>
              <p class="mt-2">© 2025 Enciclopedia Interactiva de Enfermedades</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Enfermedades Infecciosas Históricas (Epidemias Notables)
            "Peste Bubónica (Peste Negra)", "Peste Neumónica", "Peste Septicémica", "Viruela", "Gripe Española (1918)", "Cólera", "Tifus Epidémico", "Fiebre Amarilla", "Lepra (Enfermedad de Hansen)", "Sífilis (Contexto Histórico)", "Sudor Inglés (Histórico)", "Plaga de Justiniano", "Plaga de Atenas", "Tuberculosis (Consunción Histórica)", "Difteria (Pre-vacunación)", "Escarlatina (Histórica)",
            // Enfermedades Infecciosas Virales (Actuales/Comunes)
            "Gripe Estacional (Influenza)", "Resfriado Común (Rinovirus, Coronavirus estacionales)", "VIH/SIDA", "Hepatitis A", "Hepatitis B", "Hepatitis C", "Hepatitis D", "Hepatitis E", "Sarampión", "Paperas (Parotiditis)", "Rubéola", "Varicela (Virus Varicela-Zóster)", "Herpes Zóster (Culebrilla)", "Poliomielitis", "Rabia", "Virus del Ébola", "Virus Zika", "COVID-19 (SARS-CoV-2)", "Dengue", "Chikungunya", "Fiebre del Nilo Occidental", "Herpes Simple (Tipo 1 y 2)", "Mononucleosis Infecciosa (Virus Epstein-Barr)", "Citomegalovirus (CMV)", "Rotavirus", "Norovirus", "Virus del Papiloma Humano (VPH)", "Fiebre Hemorrágica de Crimea-Congo", "Fiebre de Lassa", "Hantavirus", "Virus Sincitial Respiratorio (VSR)",
            // Enfermedades Infecciosas Bacterianas
            "Tuberculosis (Actual)", "Neumonía Bacteriana", "Faringitis Estreptocócica", "Infecciones por Estafilococo (incl. SARM/MRSA)", "Tétanos", "Difteria", "Tos Ferina (Pertussis)", "Enfermedad de Lyme", "Gonorrea", "Clamidia", "Sífilis (Actual)", "Salmonelosis", "Infecciones por E. coli", "Meningitis Bacteriana", "Legionelosis (Enfermedad del legionario)", "Brucelosis", "Ántrax (Carbunco)", "Peste (Actualidad, focos)", "Cólera (Actualidad, brotes)", "Fiebre Tifoidea", "Botulismo", "Gangrena Gaseosa", "Leptospirosis", "Enfermedad por arañazo de gato", "Tracoma",
            // Enfermedades Infecciosas Fúngicas
            "Candidiasis (Oral, Vaginal, Sistémica)", "Tiña (Corporal, inguinal, pie de atleta)", "Aspergilosis", "Criptococosis", "Histoplasmosis", "Neumonía por Pneumocystis (PCP)", "Mucormicosis", "Esporotricosis",
            // Enfermedades Parasitarias
            "Malaria (Paludismo)", "Enfermedad de Chagas", "Leishmaniasis (Cutánea, Mucocutánea, Visceral)", "Toxoplasmosis", "Giardiasis", "Amebiasis", "Cisticercosis", "Hidatidosis", "Esquistosomiasis (Bilharziasis)", "Filariasis Linfática (Elefantiasis)", "Oncocercosis (Ceguera de los ríos)", "Triquinosis", "Escabiosis (Sarna)", "Pediculosis (Piojos)", "Dracunculiasis (Gusano de Guinea)", "Fascioliasis",
            // Enfermedades Priónicas
            "Enfermedad de Creutzfeldt-Jakob (ECJ)", "Variante de la Enfermedad de Creutzfeldt-Jakob (vECJ)", "Kuru", "Insomnio Familiar Fatal", "Síndrome de Gerstmann-Sträussler-Scheinker",
            // Enfermedades Crónicas No Transmisibles (Cardiovasculares)
            "Enfermedad Coronaria (Angina, Infarto de Miocardio)", "Accidente Cerebrovascular (Ictus)", "Insuficiencia Cardíaca", "Hipertensión Arterial", "Arritmias Cardíacas", "Enfermedad Arterial Periférica", "Cardiopatía Congénita (General)", "Miocardiopatía", "Endocarditis", "Fiebre Reumática (Cardiopatía Reumática)",
            // Enfermedades Crónicas No Transmisibles (Cáncer - Tipos Comunes)
            "Cáncer de Pulmón", "Cáncer de Mama", "Cáncer de Colon y Recto", "Cáncer de Próstata", "Cáncer de Piel (Melanoma y No Melanoma)", "Cáncer de Estómago", "Cáncer de Hígado", "Cáncer de Páncreas", "Cáncer de Vejiga", "Leucemia (Tipos generales)", "Linfoma (Hodgkin y No Hodgkin)", "Cáncer de Cuello Uterino", "Cáncer de Ovario", "Cáncer de Riñón", "Cáncer de Tiroides", "Mieloma Múltiple", "Tumores Cerebrales (Generales)",
            // Enfermedades Crónicas No Transmisibles (Metabólicas/Endocrinas)
            "Diabetes Mellitus Tipo 1", "Diabetes Mellitus Tipo 2", "Diabetes Gestacional", "Síndrome Metabólico", "Obesidad", "Hipotiroidismo", "Hipertiroidismo", "Enfermedad de Cushing", "Enfermedad de Addison", "Síndrome de Ovario Poliquístico (SOP)", "Gota", "Dislipidemia (Colesterol Alto, Triglicéridos Altos)",
            // Enfermedades Crónicas No Transmisibles (Respiratorias)
            "Asma", "Enfermedad Pulmonar Obstructiva Crónica (EPOC)", "Bronquitis Crónica", "Enfisema Pulmonar", "Fibrosis Pulmonar Idiopática", "Hipertensión Pulmonar", "Apnea del Sueño", "Neumoconiosis (Silicosis, Asbestosis)", "Sarcoidosis",
            // Enfermedades Crónicas No Transmisibles (Neurológicas/Degenerativas)
            "Enfermedad de Alzheimer", "Enfermedad de Parkinson", "Esclerosis Múltiple (EM)", "Esclerosis Lateral Amiotrófica (ELA)", "Epilepsia", "Migraña Crónica", "Neuropatía Periférica", "Demencia Vascular", "Corea de Huntington", "Distrofia Muscular (General)", "Miastenia Gravis", "Síndrome de Guillain-Barré",
            // Enfermedades Crónicas No Transmisibles (Autoinmunes)
            "Artritis Reumatoide", "Lupus Eritematoso Sistémico (LES)", "Enfermedad Celíaca", "Enfermedad de Crohn", "Colitis Ulcerosa", "Espondilitis Anquilosante", "Síndrome de Sjögren", "Esclerodermia", "Polimiositis y Dermatomiositis", "Tiroiditis de Hashimoto", "Enfermedad de Graves", "Psoriasis", "Artritis Psoriásica", "Vitíligo",
            // Enfermedades Crónicas No Transmisibles (Renales/Urológicas)
            "Enfermedad Renal Crónica (Insuficiencia Renal)", "Nefropatía Diabética", "Glomerulonefritis", "Pielonefritis Crónica", "Cálculos Renales (Litiasis Renal)", "Hiperplasia Benigna de Próstata (HBP)", "Incontinencia Urinaria", "Infección del Tracto Urinario (ITU) Recurrente",
            // Enfermedades Crónicas No Transmisibles (Óseas/Articulares)
            "Osteoartritis (Artrosis)", "Osteoporosis", "Fibromialgia", "Polimialgia Reumática", "Enfermedad de Paget del Hueso",
            // Enfermedades Genéticas Comunes/Notables
            "Fibrosis Quística", "Anemia Falciforme", "Talasemia", "Hemofilia (A y B)", "Síndrome de Down (Trisomía 21)", "Síndrome de Turner", "Síndrome de Klinefelter", "Fenilcetonuria (PKU)", "Enfermedad de Tay-Sachs", "Neurofibromatosis", "Distrofia Muscular de Duchenne", "Acondroplasia", "Síndrome de Marfan", "Síndrome X Frágil",
            // Enfermedades Nutricionales/Ambientales
            "Desnutrición Proteico-Calórica (Marasmo, Kwashiorkor)", "Anemia por Deficiencia de Hierro", "Escorbuto (Deficiencia de Vitamina C)", "Raquitismo/Osteomalacia (Deficiencia de Vitamina D)", "Pelagra (Deficiencia de Niacina)", "Beriberi (Deficiencia de Tiamina)", "Bocio Endémico (Deficiencia de Yodo)", "Intoxicación por Plomo (Saturnismo)", "Intoxicación por Mercurio", "Asbestosis", "Silicosis", "Enfermedad del Edificio Enfermo",
            // Condiciones de Salud Mental (Enfoque en descripción, no diagnóstico)
            "Trastorno Depresivo Mayor", "Trastornos de Ansiedad (Generalizado, Pánico, Fobias)", "Trastorno Bipolar", "Esquizofrenia", "Trastorno Obsesivo-Compulsivo (TOC)", "Trastorno de Estrés Postraumático (TEPT)", "Trastornos de la Conducta Alimentaria (Anorexia, Bulimia)", "Trastorno por Déficit de Atención e Hiperactividad (TDAH)", "Trastornos del Espectro Autista (TEA)",
            // Conceptos Generales de Salud y Enfermedad
            "Pandemia vs Epidemia vs Endemia", "Historia de la Vacunación", "Resistencia a los Antibióticos", "Enfermedades Zoonóticas y Origen", "Teoría Microbiana de la Enfermedad", "Historia de la Higiene y Salud Pública", "Cuarentena: Origen y Aplicación", "Enfermedades Emergentes y Reemergentes", "Carga Global de Enfermedad", "Determinantes Sociales de la Salud", "Medicina Preventiva", "Salud Materno-Infantil", "Enfermedades Raras u Huérfanas", "Terapias Génicas", "Inmunoterapia en Cáncer", "Medicina Personalizada",
        ];
        const diseaseThemes = [
            "enfermedades infecciosas", "enfermedades virales", "enfermedades bacterianas", "enfermedades parasitarias", "epidemias históricas", "pandemias", "enfermedades crónicas", "enfermedades cardiovasculares", "tipos de cáncer", "enfermedades autoinmunes", "enfermedades neurológicas", "enfermedades genéticas", "salud mental", "enfermedades respiratorias", "enfermedades metabólicas", "salud pública", "historia de la medicina", "vacunación", "resistencia antimicrobiana", "zoonosis", "enfermedades raras", "condiciones dermatológicas", "enfermedades renales", "trastornos hematológicos"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un historiador médico y epidemiólogo con acceso a una vasta base de datos. Tu tarea es proporcionar una descripción detallada, objetiva y bien estructurada de la enfermedad, condición o concepto de salud indicado. Cubre los siguientes aspectos cuando sea relevante: Etiología (causa: patógeno, genética, factor ambiental, etc.), Breve historia (descubrimiento, figuras clave, brotes importantes), Epidemiología básica (distribución, poblaciones afectadas), Síntomas principales, Diagnóstico general (métodos comunes), Tratamiento/Manejo (histórico y actual, si aplica), Pronóstico general y Complicaciones comunes, Prevención (vacunas, medidas de salud pública, estilo de vida). Utiliza un lenguaje claro, preciso y enciclopédico, evitando jerga excesiva. El objetivo es una descripción informativa de aproximadamente 1200-1300 palabras. Basa tu respuesta únicamente en la siguiente enfermedad o concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
             systemPrompt: "Actúa como un asistente informativo sobre salud. Responde preguntas de seguimiento relacionadas *específicamente* con la enfermedad o condición que se está mostrando ([CURRENT_DISEASE_PLACEHOLDER]). Proporciona información clara, concisa y basada en hechos generales. **Importante:** Siempre incluye una nota final recordando que esta información no reemplaza el consejo de un profesional de la salud calificado.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia médica. Genera exactamente 15 nombres de enfermedades, síndromes, condiciones médicas o conceptos históricos/actuales de salud pública. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        // (Identical to previous version, ensure all IDs match the HTML)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentDiseaseTitle = null; // Changed variable name

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             let systemPromptToUse = config.systemPrompt;
             if (isChat && currentDiseaseTitle) {
                 systemPromptToUse = config.systemPrompt.replace('[CURRENT_DISEASE_PLACEHOLDER]', currentDiseaseTitle);
             }
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     // *** FRIENDLY ERROR MESSAGE ***
                     throw new Error(`(Código ${response.status}) Nuestros servidores tienen mucho tráfico en este momento. Por favor, intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o selecciona otro tema.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 // *** ADD DISCLAIMER TO CHAT RESPONSE AUTOMATICALLY ***
                 if (isChat) {
                    return text + "\n\n*Recuerda: Esta información es general y no sustituye la consulta con un profesional de la salud.*";
                 }
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Verifica tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(diseaseTitle) { // Renamed parameter
            return fetchTextFromApi(diseaseTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentDiseaseTitle) throw new Error("Error interno: No se ha establecido el contexto de la enfermedad para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(diseaseThemes) || "enfermedades generales";
            const specificPrompt = `Genera 15 nombres de enfermedades, síndromes o temas de salud sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de temas.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 700, height: 500, nologo: true }; // Adjusted size slightly
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "concepto abstracto de salud y enfermedad";
             // *** IMAGE PROMPT FOR DISEASES - Conceptual/Symbolic ***
             const enhancedPrompt = `Stylized conceptual image representing '${safePromptText}'. Could be abstract microscopic view, historical medical illustration style, symbolic representation of affected system (e.g., network for nervous system), or data visualization art. Focus on conveying the *idea* or *impact*. Avoid literal gore, suffering, specific organs unless highly abstract. Use a clear, informative, or historical aesthetic.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // *** STRONG NEGATIVE PROMPT FOR DISEASES ***
             const negativePrompt = "photorealistic gore, suffering patient, open wound, surgery, realistic human organs, blood, graphic medical procedure, text, labels, chart, diagram, multiple images, collage, watermark, signature, blurry, deformed, ugly";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (Mostly unchanged, check for medical terms)
        function formatExplanationText(rawText) {
             if (!rawText) return '';
             let formatted = rawText.trim();
             // Basic Markdown and cleaning
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             // Simple list detection (lines starting with * or -) - basic conversion
             formatted = formatted.replace(/^\s*[\*\-]\s+(.*)$/gm, '<li>$1</li>');
             formatted = formatted.replace(/<\/li>\n<li>/g, '</li><li>'); // Clean up list breaks
             formatted = formatted.replace(/(<li>.*<\/li>)/gs, (match) => {
                 // Wrap consecutive list items in <ul>
                 if (!match.includes('<ul>')) { // Avoid double wrapping
                     return `<ul>${match}</ul>`;
                 }
                 return match;
             });

             // Headings
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');

             // Paragraphs (split by double newline, preserve lists/headings)
             const blocks = formatted.split(/\n\s*\n/);
             formatted = blocks.map(block => {
                 const trimmedBlock = block.trim();
                 if (!trimmedBlock) return '';
                 if (trimmedBlock.startsWith('<h') || trimmedBlock.startsWith('<ul') || trimmedBlock.startsWith('<li')) {
                     return trimmedBlock; // Keep existing HTML structure
                 }
                 // Treat remaining blocks as paragraphs, replace internal newlines with space
                 let content = trimmedBlock.replace(/\n/g, ' ');
                 return `<p>${content}</p>`;
             }).join('');

             // Final cleanup for potential empty tags or extra spaces
             formatted = formatted.replace(/<p>\s*<\/p>/g, '');
             formatted = formatted.replace(/<ul>\s*<\/ul>/g, '');

             return formatted;
         }


        // ========== MODAL FUNCTIONS ========== (Identical structure)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentDiseaseTitle = null; // Reset disease context
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Identical structure)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (Identical structure, check message formatting)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            // Format using the main text formatter for consistency (basic bold/italic)
            const formattedMessage = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/\n/g, '<br>'); // Allow line breaks from AI
            msgDiv.innerHTML = formattedMessage;
            chatHistory.appendChild(msgDiv);
            // Delay scroll slightly to allow rendering
            setTimeout(() => {
                 chatHistory.scrollTop = chatHistory.scrollHeight;
            }, 50);
        }
        function addChatError(message) { /* ... identical ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
              setTimeout(() => {
                  chatHistory.scrollTop = chatHistory.scrollHeight;
              }, 50);
        }
        async function handleSendMessage() { /* ... identical ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ========== (Mostly identical)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        // Add icon based on category (simple example)
        function getIconForDisease(title) {
            const lowerTitle = title.toLowerCase();
            if (lowerTitle.includes('virus') || lowerTitle.includes('viral') || ['gripe', 'sarampión', 'vih', 'covid', 'ébola', 'zika', 'hepatitis', 'varicela', 'herpes', 'rabia', 'polio'].some(term => lowerTitle.includes(term))) return 'fa-virus';
            if (lowerTitle.includes('bacteria') || ['peste', 'cólera', 'tifus', 'tuberculosis', 'tétanos', 'difteria', 'salmonella', 'estafilococo', 'estreptococo', 'lepra', 'sífilis', 'gonorrea', 'clamidia', 'lyme'].some(term => lowerTitle.includes(term))) return 'fa-bacteria';
            if (lowerTitle.includes('cáncer') || lowerTitle.includes('leucemia') || lowerTitle.includes('linfoma') || lowerTitle.includes('melanoma')) return 'fa-disease'; // Generic disease icon for cancer
            if (lowerTitle.includes('corazón') || lowerTitle.includes('cardíaca') || lowerTitle.includes('cardio') || lowerTitle.includes('vascular') || lowerTitle.includes('hipertensión') || lowerTitle.includes('ictus')) return 'fa-heartbeat';
            if (lowerTitle.includes('genética') || lowerTitle.includes('síndrome') || ['fibrosis', 'falciforme', 'down', 'huntington', 'hemofilia', 'duchenne'].some(term => lowerTitle.includes(term))) return 'fa-dna';
            if (lowerTitle.includes('mental') || ['depresión', 'ansiedad', 'esquizofrenia', 'bipolar', 'toc', 'tept'].some(term => lowerTitle.includes(term))) return 'fa-brain';
             if (lowerTitle.includes('historia') || lowerTitle.includes('histórico') || lowerTitle.includes('vacunación') || lowerTitle.includes('pública') ) return 'fa-history';
            return 'fa-notes-medical'; // Default medical notes
        }
        function createTitleItem(title) {
            const div=document.createElement('div');
            div.className='title-item';
            const iconClass = getIconForDisease(title); // Get appropriate icon
            div.innerHTML = `<i class="fas ${iconClass}"></i><span>${title}</span>`; // Add icon element
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }
        function displayTitles(titles) { /* ... identical structure, uses new createTitleItem ... */
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">No hay condiciones listadas.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
        }
        function appendTitles(newTitles) { /* ... identical structure ... */
            if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentDiseaseTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i> <!-- Icono genérico imagen -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando imagen conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => {
                        showFullscreenImage(imgElement.src);
                    });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al cargar imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                // *** USE FRIENDLY ERROR MESSAGE ***
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la información.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() { /* ... identical structure, uses friendly error ... */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando temas...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más temas en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar temas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Cargar Más Temas Relacionados';
             }
         }

         // *** Search Filter Function (with accent normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (Identical structure)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: No se cargaron los componentes de la interfaz.</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>