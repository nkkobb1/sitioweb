<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civilizaciones Perdidas y Teorías Ocultas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes: Una Serif estilo antiguo/robusto + Sans Serif clara -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Civilizaciones Perdidas --- */
        :root {
            --color-primary: #DAA520; /* Oro/Bronce Antiguo */
            --color-secondary: #556B2F; /* Verde Olivo Oscuro (Jungla/Exploración) */
            --color-tertiary: #4682B4; /* Azul Acero (Misterio/Agua) */
            --color-background: #F5F5DC; /* Beige (Pergamino/Arena) */
            --color-text: #3D362D; /* Marrón Oscuro (Texto Principal) */
            --color-text-muted: #8B7D6B; /* Marrón Claro (Texto Secundario) */
            --color-modal-bg: #E8E4D5; /* Fondo Modal Beige Más Oscuro */
            --color-border: #B8AE98; /* Borde Marrón Grisáceo */
            --color-locked-bg: #DCD5C3; /* Fondo bloqueado */
            --color-locked-text: #A09481; /* Texto bloqueado */
            --color-error-bg: #f8d7da; /* Fondo error rosa pálido */
            --color-error-text: #721c24; /* Texto error rojo oscuro */
            --color-error-border: #f5c6cb; /* Borde error rosa */

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 5px 10px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.15), 0 3px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 3px; /* Bordes ligeramente más rectos */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; /* Textura mapa sutil */ background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-41c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm63 52c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-57-15c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-14 43c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm68-18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-14 34c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7z' fill='%23B8AE98' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E"); }
        h1, h2, h3, h4, .logo, #generate-more-btn, #unlock-ad-button, #modal-title, #loading-text { font-family: 'Cinzel', serif; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-secondary); font-weight: 700; text-shadow: 1px 1px 1px rgba(255,255,255,0.3); }
        h2.section-title { color: var(--color-primary); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; font-size: 1.8rem; }
        .navbar { background-color: rgba(245, 245, 220, 0.88); /* Beige slightly transparent */ backdrop-filter: blur(4px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }

        /* Search Bar */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic;}
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(218, 165, 32, 0.2); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        /* Title List & Items */
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: #fff; padding: 1rem 1.2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between; min-height: 65px; font-family: 'Lato', sans-serif; font-size: 1.05rem; position: relative; overflow: hidden; border-left: 5px solid var(--color-secondary); }
        .title-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-left-color: var(--color-primary); color: var(--color-primary); background-color: #fdfdfb; }
        .title-item .title-text { flex-grow: 1; margin-right: 10px; font-weight: 700; }
        .title-item .lock-icon { color: var(--color-text-muted); font-size: 1.1rem; flex-shrink: 0; }

        /* Locked Title Items */
        .title-item.locked { background-color: var(--color-locked-bg); color: var(--color-locked-text); cursor: pointer; border-color: #C8BDAE; border-left-color: var(--color-locked-text); opacity: 0.9; }
        .title-item.locked:hover { transform: none; box-shadow: var(--shadow-sm); background-color: var(--color-locked-bg); color: var(--color-locked-text); border-left-color: var(--color-primary); }
        .title-item.locked .title-text { font-weight: 400; font-style: italic; }
        .title-item.locked .lock-icon { color: var(--color-primary); animation: pulse-lock 1.5s infinite ease-in-out; }
        @keyframes pulse-lock { 0%, 100% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.15); opacity: 1; } }

        /* Generate More Button */
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.9rem 1.8rem; border: 1px solid rgba(0,0,0,0.1); border-radius: var(--border-radius); cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-text-muted); color: var(--color-background); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        /* Story Modal (Principal) */
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(61, 54, 45, 0.93); /* Brownish Overlay */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: 1.5rem 2rem; max-width: 1000px; width: 95%; max-height: 90vh; min-height: 450px; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: rgba(184, 174, 152, 0.8); /* Border color semi-transparent */ border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }

        /* Modal Content Area (Scrollable) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; margin-bottom: 1rem; scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border); }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 8px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; font-size: 1.1rem; }
        #modal-content strong { color: var(--color-secondary); font-weight: 700; }
        #modal-content em { color: var(--color-primary); font-style: italic; font-weight: 700;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel', serif; margin-top: 2.2em; margin-bottom: 1.2em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; letter-spacing: 1px;}
        #modal-content h1 { font-size: 1.6em; color: var(--color-primary); border-bottom-width: 2px; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); border-bottom: none; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; font-style: italic; font-family: 'Lato'; text-transform: none; letter-spacing: normal; font-weight: 400;}
        /* Imagen Final */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1.5rem auto; border: 2px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; filter: sepia(20%) contrast(105%); }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); filter: sepia(0%) contrast(100%); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 2.5rem auto 1.5rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 5px solid rgba(184, 174, 152, 0.6); width: 45px; height: 45px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-tertiary);}

        /* Chat Section */
        #chat-section { border-top: 1px dashed var(--color-border); padding-top: 1.2rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; }
         #chat-section h3 { font-family: 'Cinzel'; color: var(--color-secondary); font-size: 1.2rem; text-align: center; margin-bottom: 0.8rem; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(245, 245, 220, 0.5); /* Background beige semi-transparent */ scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; font-size: 1rem; font-family: 'Lato'; color: var(--color-text); }
        .user-message { background-color: var(--color-secondary); color: white; margin-left: auto; text-align: right; border-radius: var(--border-radius) 0 var(--border-radius) var(--border-radius); }
        .ai-message { background-color: #D2B48C; /* Tan */ color: var(--color-text); margin-right: auto; text-align: left; border-radius: 0 var(--border-radius) var(--border-radius) var(--border-radius); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 2px rgba(85, 107, 47, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-secondary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #4A5C2A; /* Darker Olive */ }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7;}
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Cinzel'; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Overlay con Datos Curiosos */
        #modal-loading { text-align: center; padding: 2rem 1rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(232, 228, 213, 0.97); /* Modal BG semi-transparent */ display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #modal-loading.active { display: flex; }
        #loading-status { margin-bottom: 1.5rem; display: flex; flex-direction: column; align-items: center;}
        #loading-text { font-weight: 700; color: var(--color-primary); font-size: 1.5rem; margin-bottom: 1.8rem; }
        #frase {
            font-family: 'Lato', sans-serif;
            font-style: italic;
            font-size: 1.1rem;
            color: var(--color-secondary); /* Dark Olive for contrast */
            max-width: 85%;
            margin: 0 auto 1.8rem auto;
            min-height: 60px;
            line-height: 1.6;
            text-align: center;
            border-top: 1px dashed var(--color-border);
            border-bottom: 1px dashed var(--color-border);
            padding: 0.8rem 0.5rem;
        }
        #loading-spinner-icon { font-size: 2.8rem; color: var(--color-secondary); animation: spin 1.5s linear infinite; margin-bottom: 1.2rem; }
        #loading-final-text { font-weight: 400; color: var(--color-text-muted); font-size: 1rem; font-family: 'Lato'; font-style: italic;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(40, 35, 28, 0.96); /* Darker Brown overlay */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: white; transform: scale(1.1); }

        /* Unlock Modal (Sin countdown) */
        #unlock-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(61, 54, 45, 0.9); /* Brownish Overlay */ display: none; align-items: center; justify-content: center; z-index: 70; padding: 1rem; font-family: 'Lato', sans-serif; }
        #unlock-modal.active { display: flex; }
        .unlock-modal-content { background-color: var(--color-modal-bg); padding: 2.5rem 2rem 2rem 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); text-align: center; max-width: 500px; width: 90%; position: relative; border: 1px solid var(--color-border); }
        .unlock-modal-close-btn { position: absolute; top: 10px; right: 10px; background: transparent; border: none; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; line-height: 1; transition: color 0.2s ease; }
        .unlock-modal-close-btn:hover { color: var(--color-primary); }
        #unlock-modal h3 { font-family: 'Cinzel', serif; color: var(--color-primary); font-size: 1.7rem; margin-bottom: 1.2rem; }
        #unlock-modal p { color: var(--color-text); margin-bottom: 1.8rem; line-height: 1.7; font-size: 1.1rem; }
        #unlock-ad-button { background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.9rem 2.2rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel', serif; font-size: 1.1rem; cursor: pointer; transition: var(--transition-normal); margin-bottom: 1.5rem; display: inline-block; box-shadow: var(--shadow-md); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #unlock-ad-button:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: translateY(-2px); }
        #unlock-ad-button:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; box-shadow: none; transform: none; }
        #unlock-status { font-size: 1rem; color: var(--color-secondary); margin-top: 0.8rem; font-style: italic; font-weight: 700; min-height: 20px; }

    </style>
</head>
<body class="bg-beige-100 text-gray-800">
     <!-- Header/Navbar -->
     <nav class="navbar mb-12">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                  <h1 class="logo text-3xl sm:text-4xl">
                      <i class="fas fa-atlas mr-2 text-green-800"></i> <!-- Atlas -->
                      <i class="fas fa-question-circle mx-1 text-blue-600"></i> <!-- Pregunta -->
                      <i class="fas fa-search-location mr-3 text-yellow-600"></i> <!-- Lupa mapa -->
                      Mundos Olvidados
                 </h1>
             </div>
             <span class="text-xs text-gray-600 font-sans tracking-wider uppercase">» Enigmas de la Antigüedad «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Civilizaciones Perdidas</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light italic">Explora los mitos, leyendas y teorías sobre mundos desaparecidos y tecnologías imposibles. ¿Qué secretos aguardan ser descubiertos?</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar Atlantis, Mu, Nazca, OOPArt...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-compass text-yellow-700 mr-2"></i> <!-- Brújula -->
                 Expedientes X Antiguos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Descifrando códices olvidados...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Este misterio aún no ha sido registrado... «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Unearth More Mysteries (40)
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal (Principal) -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>
             <!-- Loading Overlay con Datos Curiosos -->
             <div id="modal-loading">
                 <div id="loading-status">
                     <p id="loading-text">Excavando Información...</p>
                     <div id="frase">Cargando dato interesante...</div>
                     <i id="loading-spinner-icon" class="fas fa-spinner"></i>
                 </div>
                 <p id="loading-final-text">Mientras desenterramos los secretos, un fragmento de conocimiento para ti.</p>
             </div>
             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content"></div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                      <h3 class="font-cinzel text-secondary text-center mb-2">Consulta al Investigador</h3>
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando textos antiguos...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta más sobre este enigma...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                     <i class="fas fa-exclamation-triangle"></i>
                     <span id="modal-error-message"></span>
                 </div>
             </div>
         </div>
     </div>

      <!-- Unlock Modal (Sin countdown) -->
      <div id="unlock-modal">
          <div class="unlock-modal-content">
              <button class="unlock-modal-close-btn" id="unlock-modal-close" aria-label="Cerrar">&times;</button>
              <h3><i class="fas fa-key mr-2 text-yellow-500"></i> Conocimiento Oculto</h3>
              <p>Ciertos saberes requieren una llave. Haz clic en "ANUNCIO" para desbloquear el acceso a este misterio.</p>
              <button id="unlock-ad-button">
                  <i class="fas fa-unlock-alt mr-2"></i> ANUNCIO (Desbloquear Saber)
              </button>
              <div id="unlock-status"></div>
              <input type="hidden" id="unlock-target-title" value="">
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Representación del Misterio Antiguo">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-800 text-gray-400 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Exploraciones sobre civilizaciones perdidas y teorías alternativas generadas por IA.</p>
              <p class="mt-1">La información combina datos arqueológicos, mitos y especulaciones. Investiga por tu cuenta.</p>
              <p class="mt-2">© 2025 Sociedad de Exploradores Digitales</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const adUrl = 'https://increasingbelieveabonnement.com/pcmu77j4?key=1f38fa224b5ecf757563a32d2d8ac126';
        const lockPercentage = 0.9; // Manteniendo alto bloqueo (90%)
        const themePrefix = 'LostCivs'; // Prefijo para este tema
        const userUnlockedKey = `unlockedTitles_${themePrefix}`;
        const initialLockStateSetFlagKey = `initialLockStateSet_${themePrefix}`;
        const initialLockedSetKey = `initialLockedSet_${themePrefix}`;
        const funFactsUrl = 'https://raw.githubusercontent.com/nkkobb1/sitioweb/main/datoscuriosos.json';
        // NEW: Fun fact interval duration
        const funFactIntervalDuration = 8000; // 8 segundos

        const predefinedTitles = [
            // Civilizaciones Míticas/Legendarias
            "Atlantis: El continente perdido según Platón", "Lemuria: El continente perdido del Pacífico", "Mu: El continente perdido de James Churchward", "Hiperbórea: La tierra más allá del Viento del Norte", "Thule: La capital mítica de Hiperbórea", "Avalon: La isla mística artúrica", "Shambhala (Shangri-La): El reino oculto del Himalaya", "El Dorado: La ciudad perdida de oro", "Paititi: La ciudad perdida inca en la Amazonía", "La Ciudad de los Césares (Ciudad Encantada de la Patagonia)", "Aztlán: El origen mítico de los Aztecas", "Ys: La ciudad bretona sumergida", "Cantre'r Gwaelod: Las tierras bajas perdidas de Gales", "Lyonesse: El reino perdido de Cornualles", "Iram de los Pilares (Ubar): La ciudad perdida de Arabia",
            // Misterios Arqueológicos Reales
            "El colapso de la Civilización Maya Clásica", "El declive de la Civilización del Valle del Indo (Harappa)", "Las Estatuas Moái de la Isla de Pascua", "Las Líneas de Nazca: Geoglifos gigantes en Perú", "Göbekli Tepe: El templo más antiguo del mundo?", "Çatalhöyük: Una ciudad neolítica sin calles", "El Mecanismo de Anticitera: ¿Una computadora antigua?", "Las Esferas de Piedra de Costa Rica", "El Monumento Yonaguni: ¿Formación natural o artificial?", "Puma Punku y sus bloques de piedra imposibles", "La Escritura Rongo Rongo de Isla de Pascua", "El Ejército de Terracota de Qin Shi Huang", "Sanxingdui: La misteriosa cultura china del bronce", "La desaparición de la Colonia de Roanoke", "El Manuscrito Voynich: Un código indescifrable", "La Batería de Bagdad: ¿Electricidad en la antigüedad?", "Las Lámparas de Dendera: ¿Bombillas egipcias?", "El Mapa de Piri Reis: ¿Costas antárticas sin hielo?", "Los Túneles de los Tayos en Ecuador",
            // Teorías y Especulaciones
            "Teoría de los Antiguos Astronautas (Ancient Aliens)", "Evidencia de tecnología avanzada en la antigüedad", "Cataclismos globales: Diluvios universales y cambios de polos", "Teorías sobre la Gran Pirámide de Giza", "OOPArts: Artefactos fuera de lugar en el tiempo", "Vimanas: ¿Naves voladoras en textos sánscritos?", "La conexión entre civilizaciones antiguas (Egipto, Sumeria, Mayas)", "Teorías sobre la Atlántida: Ubicaciones propuestas", "La Teoría del Gran Año y los ciclos cósmicos", "Conocimiento astronómico avanzado en culturas antiguas", "La hipótesis del simio acuático", "Teorías sobre el origen de la vida (Panspermia)", "La búsqueda de la Biblioteca de Alejandría", "Sociedades secretas y conocimiento antiguo (Masones, Rosacruces)", "Teorías alternativas sobre la evolución humana", "La hipótesis de Tartaria: Un imperio mundial perdido?", "La conexión entre Stonehenge y otras estructuras megalíticas", "El uso de la levitación sónica en construcciones antiguas", "La teoría de la Tierra Hueca",
            // Figuras y Textos Clave
            "Platón y sus diálogos sobre la Atlántida (Timeo y Critias)", "Helena Blavatsky y la Doctrina Secreta (Lemuria, Razas Raíz)", "James Churchward y los libros de Mu", "Ignatius Donnelly: Atlantis, el Mundo Antediluviano", "Erich von Däniken: Recuerdos del Futuro", "Zecharia Sitchin y los Anunnaki", "Graham Hancock: Las Huellas de los Dioses", "Robert Bauval y el Misterio de Orión", "Percy Fawcett y la búsqueda de la Ciudad Z", "Charles Fort y los fenómenos inexplicables", "Los Libros de Enoc y los Vigilantes", "El Popol Vuh y la creación Maya", "Los Textos Védicos y sus descripciones", "La Tabla Esmeralda de Hermes Trismegisto", "Manetón y las listas de reyes egipcios predinásticos",
            // ... (Continuar expandiendo con más detalles, lugares específicos, artefactos individuales, etc. hasta +400)
            "La Fuente de la Eterna Juventud", "Los Jardines Colgantes de Babilonia", "El Coloso de Rodas", "El Faro de Alejandría", "El Templo de Artemisa en Éfeso", "La Estatua de Zeus en Olimpia", "El Mausoleo de Halicarnaso", "Troya: ¿Mito o realidad?", "El Laberinto de Creta y el Minotauro", "La Biblioteca de Nínive", "El Oráculo de Delfos", "Los Rollos del Mar Muerto", "El Código de Hammurabi", "La Piedra Rosetta", "El Disco de Festo", "El Sudario de Turín", "El Santo Grial", "El Arca de la Alianza", "La Lanza del Destino", "La Piedra Filosofal", "Las Calaveras de Cristal", "Las Tablillas de Glozel", "El Hombre de Piltdown (Fraude)", "El Gigante de Cardiff (Fraude)", "El Triángulo de las Bermudas", "Las Luces de Phoenix", "El Incidente de Roswell", "El Área 51", "Los Círculos de Cultivo (Crop Circles)", "La Conspiración del Aterrizaje Lunar", "Reptilianos y otras teorías de conspiración", "El Proyecto Montauk", "El Experimento Filadelfia"
        ];
        const mysteryThemes = [ // Renombrado de legendThemes
            "atlantis", "lemuria", "mu", "antiguos astronautas", "ooparts", "tecnologia antigua", "civilizacion maya", "misterios egipto", "lineas nazca", "isla de pascua", "cataclismos antiguos", "shambhala", "el dorado", "manuscrito voynich", "göbekli tepe", "piramides teorias", "mapas antiguos", "tartaria", "simbolos antiguos", "conocimiento perdido"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un Investigador de Enigmas Históricos y teorías alternativas. Presenta la información sobre el tema consultado (civilización perdida, misterio arqueológico, teoría) de forma detallada y objetiva, pero incluyendo las principales especulaciones y teorías asociadas. Cita fuentes si es relevante (Platón, textos antiguos, investigadores modernos). Mantén un tono de exploración y descubrimiento. Extensión objetivo: 1200-1300 palabras. El enigma a explorar es:",
            timeoutSeconds: 180
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como asistente del Investigador de Enigmas. Responde preguntas específicas sobre el misterio o teoría recién presentado. Clarifica detalles sobre evidencia, contraargumentos, figuras clave o implicaciones de las teorías. Sé conciso y mantén el tono de investigación.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Genera una lista concisa de 40 títulos específicos sobre civilizaciones perdidas, misterios arqueológicos, OOPArts o teorías alternativas sobre la historia antigua. Devuelve *solo* la lista de ítems, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, funFactDisplay presente)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const funFactDisplay = document.getElementById('frase'); // Para datos curiosos
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        const unlockModal = document.getElementById('unlock-modal');
        const unlockModalCloseBtn = document.getElementById('unlock-modal-close');
        const unlockAdButton = document.getElementById('unlock-ad-button');
        const unlockStatusDisplay = document.getElementById('unlock-status');
        const unlockTargetTitleInput = document.getElementById('unlock-target-title');

        // ========== State Variables ==========
        let currentTopicTitle = null;
        let initialLockedTitles = loadInitialLockedSet();
        let funFactsData = null;
        let funFactInterval = null;


        // ========== LocalStorage Functions (Unlock Persistence & Initial Lock State) ==========
        // (Sin cambios)
        function getJsonFromStorage(key) { try{const s=localStorage.getItem(key); return s?JSON.parse(s):null;}catch(e){console.error(`Error reading ${key}:`,e); return null;} }
        function setJsonInStorage(key, value) { try{localStorage.setItem(key,JSON.stringify(value));}catch(e){console.error(`Error saving ${key}:`,e);} }
        function getUnlockedTitles() { const a=getJsonFromStorage(userUnlockedKey); return new Set(a||[]); }
        function saveUnlockedTitles(unlockedSet) { setJsonInStorage(userUnlockedKey, Array.from(unlockedSet)); }
        function isTitleUnlockedByUser(title) { return getUnlockedTitles().has(title); }
        function unlockTitlePermanentlyByUser(title) { if(!title)return; const u=getUnlockedTitles(); if(!u.has(title)){u.add(title);saveUnlockedTitles(u);console.log(`User unlocked: ${title}`);updateTitleItemLockStatus(title,false);} }
        function loadInitialLockedSet() { const a=getJsonFromStorage(initialLockedSetKey); return new Set(a||[]); }
        function saveInitialLockedSet(lockedSet) { setJsonInStorage(initialLockedSetKey, Array.from(lockedSet)); }
        function isInitialLockStateSet() { return localStorage.getItem(initialLockStateSetFlagKey)==='true'; }
        function setInitialLockStateFlag() { localStorage.setItem(initialLockStateSetFlagKey,'true'); }
        function isTitleInitiallyLocked(title) { return initialLockedTitles.has(title); }


        // ========== API FUNCTIONS ==========
        // (Sin cambios lógicos)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Actúa como asistente del Investigador de Enigmas. Responde preguntas específicas sobre '${currentTopicTitle}'. Clarifica detalles, evidencia, figuras clave o implicaciones. Sé conciso y mantén el tono de investigación.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Fallo en la conexión con los archivos antiguos. Servidores ocupados. Intenta de nuevo.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("El Investigador no encontró registros (respuesta vacía). Intenta de nuevo.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La consulta tardó demasiado (>${config.timeoutSeconds}s). La conexión es débil o el pasado se resiste a ser revelado. Inténtalo de nuevo.`);
                 throw new Error(error.message || "Error desconocido contactando los repositorios arcanos.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Contexto del enigma perdido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(mysteryThemes) || "misterios antiguos variados"; // Use updated themes
             const specificPrompt = `Genera 40 títulos específicos sobre ${randomTheme}`;
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 10) throw new Error("La IA no pudo desenterrar suficientes ideas.");
                     return titles.slice(0, 40);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Lost civilization or ancient mystery";
            const enhancedPrompt = `Atmospheric digital painting illustrating '${safePromptText}'. Focus on ancient ruins, mysterious landscapes, artifacts, or interpretations of lost technology/civilizations. Use an earthy or mysterious color palette (stone, sand, jungle green, deep blue, gold accents). Style: realistic concept art with a sense of wonder or mystery. No text, logos, words.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, modern elements, happy cartoon, photograph of tourist";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { if(!rawText)return'';let f=rawText.trim();f=f.replace(/\\text\{(.*?)\}/g,'$1');f=f.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');f=f.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(m,b,e)=>{const c=e.replace('−','-');return`${b}<sup>${c}</sup>`;});f=f.replace(/\\rightarrow/g,'&rarr;');f=f.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');f=f.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');f=f.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');f=f.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');f=f.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');f=f.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');f=f.replace(/\*(.*?)\*/g,'<em>$1</em>');const b=f.split(/\n\s*\n/).filter(p=>p.trim().length>0);f=b.map(blk=>{if(blk.startsWith('<h')||blk.startsWith('<p class="formula">'))return blk;let c=blk.replace(/\n/g,' ');return`<p>${c}</p>`;}).join('');return f; }

         // ========== FUN FACT FUNCTIONS ==========
         // (fetchFunFacts, displayRandomFunFact sin cambios)
         async function fetchFunFacts() { if (funFactsData) return; try { console.log("Fetching fun facts:", funFactsUrl); const response = await fetch(funFactsUrl); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); funFactsData = await response.json(); console.log("Fun facts loaded."); } catch (error) { console.error("Error fetching fun facts:", error); funFactsData = null; if (funFactDisplay) funFactDisplay.textContent = "No se pudieron cargar datos curiosos."; } }
         function displayRandomFunFact() { if (!funFactsData || !funFactDisplay) { if(funFactDisplay) funFactDisplay.textContent = "..."; return; } try { const categories = Object.keys(funFactsData); if (categories.length === 0) { funFactDisplay.textContent = "No hay datos disponibles."; return; } const randomCategory = categories[Math.floor(Math.random() * categories.length)]; const factsInCategory = funFactsData[randomCategory]; if (!factsInCategory || factsInCategory.length === 0) { funFactDisplay.textContent = `No hay datos en: ${randomCategory}`; return; } const randomFact = factsInCategory[Math.floor(Math.random() * factsInCategory.length)]; funFactDisplay.textContent = `Dato Curioso (${randomCategory}): ${randomFact}`; } catch (error) { console.error("Error displaying fun fact:", error); funFactDisplay.textContent = "Error al mostrar dato."; } }

         // *** MODIFIED: startFunFactInterval uses new duration ***
         function startFunFactInterval() {
             if (!funFactsData) { console.warn("Cannot start fun fact interval: data not loaded."); fetchFunFacts(); return; }
             stopFunFactInterval();
             // Use the new duration variable
             funFactInterval = setInterval(displayRandomFunFact, funFactIntervalDuration);
             displayRandomFunFact();
             console.log(`Fun fact interval started (every ${funFactIntervalDuration / 1000}s).`);
         }
         // (stopFunFactInterval sin cambios)
         function stopFunFactInterval() { if (funFactInterval) { clearInterval(funFactInterval); funFactInterval = null; console.log("Fun fact interval stopped."); } if (funFactDisplay) { funFactDisplay.textContent = ""; } }


        // ========== MODAL FUNCTIONS ==========
        // (showModal, hideModal, resetModalState, showUnlockModal, hideUnlockModal sin cambios lógicos)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { storyModal.classList.remove('active'); if (!imageFullscreenOverlay.classList.contains('active') && !unlockModal.classList.contains('active')) { document.body.style.overflow = ''; } modalTextArea.scrollTop = 0; stopFunFactInterval(); resetModalState(); }
        function resetModalState() { modalLoadingIndicator.classList.remove('active'); modalStoryContentArea.classList.add('content-hidden'); modalError.classList.add('content-hidden'); modalTitle.textContent = ''; modalContent.innerHTML = ''; modalErrorMessage.textContent = ''; chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; currentTopicTitle = null; hideFullscreenImage(); chatSection.classList.remove('content-hidden'); stopFunFactInterval(); }
        function showUnlockModal(titleToUnlock) { unlockTargetTitleInput.value = titleToUnlock; unlockStatusDisplay.textContent = ''; unlockAdButton.disabled = false; unlockModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideUnlockModal() { unlockModal.classList.remove('active'); if (!storyModal.classList.contains('active') && !imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; } }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { if(!imageFullscreenOverlay||!fullscreenImage)return; fullscreenImage.src=imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow='hidden'; }
        function hideFullscreenImage() { if(!imageFullscreenOverlay)return; imageFullscreenOverlay.classList.remove('active'); if(!storyModal.classList.contains('active')&&!unlockModal.classList.contains('active')){ document.body.style.overflow=''; } fullscreenImage.src=''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios lógicos)
        function addChatMessage(message, sender) { const d=document.createElement('div');d.className=`chat-message ${sender==='user'?'user-message':'ai-message'}`;message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>');d.innerHTML=message;chatHistory.appendChild(d);chatHistory.scrollTop=chatHistory.scrollHeight;}
        function addChatError(message) { const e=document.createElement('div');e.className='chat-error';e.textContent=message;chatHistory.appendChild(e);chatHistory.scrollTop=chatHistory.scrollHeight;}
        async function handleSendMessage() { const q=chatInput.value.trim();if(!q||chatSendBtn.disabled)return;addChatMessage(q,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const r=await fetchChatResponse(q);addChatMessage(r,'ai');}catch(e){console.error("Chat Error:",e);addChatError(`Error del Investigador: ${e.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}}

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }

        // (createTitleItem, updateTitleItemLockStatus, displayTitles, appendTitles sin cambios lógicos)
        function createTitleItem(title) { const div=document.createElement('div');div.className='title-item';div.setAttribute('data-title',title);const span=document.createElement('span');span.className='title-text';span.textContent=title;div.appendChild(span);const iLocked=isTitleInitiallyLocked(title);const uUnlocked=isTitleUnlockedByUser(title);const locked=iLocked&&!uUnlocked;div.setAttribute('data-locked',locked?'true':'false');div.style.cursor='pointer';if(locked){div.classList.add('locked');const icon=document.createElement('i');icon.className='fas fa-lock lock-icon';div.appendChild(icon);}else{div.classList.remove('locked');} div.addEventListener('click',()=>handleTitleClick(title,div));return div; }
        function updateTitleItemLockStatus(title, isLocked) { const item=titleListContainer.querySelector(`.title-item[data-title="${CSS.escape(title)}"]`); if(item){ item.setAttribute('data-locked',isLocked?'true':'false'); item.classList.toggle('locked',isLocked); let icon=item.querySelector('.lock-icon'); if(isLocked&&!icon){icon=document.createElement('i');icon.className='fas fa-lock lock-icon';item.appendChild(icon);} else if(!isLocked&&icon){icon.remove();}}}
        function displayTitles(titles) { if(!titleListContainer||!titlesLoading)return;if(!isInitialLockStateSet()&&titles.length>0){console.log("Setting initial lock state...");const shuf=shuffleArray([...titles]);const lockCnt=Math.floor(titles.length*lockPercentage);const initLockSet=new Set();for(let i=0;i<lockCnt;i++){initLockSet.add(shuf[i]);}saveInitialLockedSet(initLockSet);setInitialLockStateFlag();initialLockedTitles=initLockSet;console.log(`Initially locked ${initialLockedTitles.size} titles.`);}else{console.log(`Initial lock state loaded: ${initialLockedTitles.size} initially locked.`);}const sorted=titles.sort((a,b)=>a.localeCompare(b));titleListContainer.innerHTML='';titlesLoading.style.display='none';if(sorted.length===0){titleListContainer.innerHTML='<p class="text-gray-500 col-span-full text-center font-sans">» No hay mapas para estos territorios... «</p>';return;}sorted.forEach(t=>titleListContainer.appendChild(createTitleItem(t)));}
        function appendTitles(newTitles) { if(!titleListContainer||!newTitles||newTitles.length===0)return;const existing=new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(i=>i.dataset.title));let added=false;newTitles.forEach(t=>{if(!existing.has(t)){titleListContainer.appendChild(createTitleItem(t));if(!initialLockedTitles.has(t)){initialLockedTitles.add(t);added=true;}}});if(added){saveInitialLockedSet(initialLockedTitles);console.log("Added new titles to persistent initial locked set.");}filterTitles(searchInput.value);}

        // (handleTitleClick sin cambios lógicos)
        function handleTitleClick(title, titleElement) { const isLocked=titleElement.getAttribute('data-locked')==='true'; if(isLocked){console.log(`Title "${title}" locked. Show unlock modal.`);showUnlockModal(title);}else{console.log(`Title "${title}" unlocked. Load content.`);loadContentForTitle(title);}}

        // (loadContentForTitle inicia/detiene fun facts)
        async function loadContentForTitle(title) {
            resetModalState(); showModal(); currentTopicTitle = title;
            modalTitle.textContent = title;
            modalStoryContentArea.classList.add('content-hidden');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.classList.add('active');
            startFunFactInterval(); // <--- Start fun facts
            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);
                stopFunFactInterval(); // <--- Stop fun facts on success
                modalLoadingIndicator.classList.remove('active');
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;
                // Load Image
                const placeholderDiv=document.createElement('div');placeholderDiv.className='image-placeholder';placeholderDiv.innerHTML=`<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualizando el pasado...</p>`;modalContent.appendChild(placeholderDiv);
                const imgElement=document.createElement('img');imgElement.className='final-image';imgElement.alt=`Ilustración de ${title}`;imgElement.style.display='none';
                imgElement.onload=()=>{placeholderDiv.remove();imgElement.style.display='block';imgElement.addEventListener('click',()=>showFullscreenImage(imgElement.src));};
                imgElement.onerror=()=>{placeholderDiv.innerHTML=`<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`;};
                const imageUrl=createPollinationsImageUrl(title);
                if(imageUrl){imgElement.src=imageUrl;modalContent.appendChild(imgElement);}else{placeholderDiv.innerHTML=`<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar imagen.</p>`;}
            } catch (error) {
                console.error("Failed display:", error);
                stopFunFactInterval(); // <--- Stop fun facts on error
                modalLoadingIndicator.classList.remove('active');
                modalErrorMessage.textContent = error.message || "Error desconocido al desenterrar esta historia.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = ''; chatSection.classList.add('content-hidden');
            }
        }

        // (handleAdButtonClick sin cambios lógicos - desbloqueo inmediato)
        function handleAdButtonClick() {
            const titleToUnlock = unlockTargetTitleInput.value;
            if (!titleToUnlock || unlockAdButton.disabled) return;
            console.log(`Ad button clicked for title: ${titleToUnlock}`);
            window.open(adUrl, '_blank');
            unlockAdButton.disabled = true;
            unlockStatusDisplay.textContent = '¡Conocimiento Desbloqueado!';
            unlockTitlePermanentlyByUser(titleToUnlock);
            setTimeout(() => {
                 hideUnlockModal();
                 loadContentForTitle(titleToUnlock);
             }, 300);
        }

        // (handleGenerateMoreTitles sin cambios lógicos)
        async function handleGenerateMoreTitles() { if(!generateMoreBtn||!generateMoreSpinner||!generateMoreContainer)return; generateMoreBtn.disabled=true; generateMoreBtn.innerHTML='<i class="fas fa-sync-alt mr-2 animate-spin"></i> Desenterrando más...'; try{const t=await fetchGeneratedTitles(); if(t&&t.length>0){appendTitles(t);}else{alert("No se encontraron más misterios por ahora.");}}catch(e){console.error("Failed title generation:",e);alert(`Error buscando misterios: ${e.message}`);}finally{generateMoreBtn.disabled=false;generateMoreBtn.innerHTML='<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Unearth More Mysteries (40)';}}

         // (filterTitles sin cambios)
         function filterTitles(searchTerm) { const term=searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(); const items=titleListContainer.querySelectorAll('.title-item'); let count=0; items.forEach(item=>{ const text=item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""); const isVisible=text.includes(term); item.classList.toggle('hidden',!isVisible); if(isVisible)count++; }); noResultsMsg.classList.toggle('hidden',count>0); }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check essential elements
              if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !funFactDisplay || !modalLoadingIndicator || !unlockModal || !unlockModalCloseBtn || !unlockAdButton || !unlockStatusDisplay || !unlockTargetTitleInput) {
                console.error("Initialization failed: Missing essential UI elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: El mapa está incompleto. Faltan componentes.</p>';
                return;
             }

             fetchFunFacts(); // Load fun facts

             // Event Listeners
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
             unlockModalCloseBtn.addEventListener('click', hideUnlockModal);
             unlockModal.addEventListener('click', (event) => { if (event.target === unlockModal) hideUnlockModal(); });
             unlockAdButton.addEventListener('click', handleAdButtonClick);

             // Initial display
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>