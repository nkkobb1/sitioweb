<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panteón Z - Dioses Griegos en el Universo DB</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Temáticas: Épica (Cinzel) y Dinámica (Bangers/Roboto) -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@300;400;700&family=Bangers&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Panteón Z --- */
        :root {
            --color-primary: #ff9900; /* Naranja DBZ */
            --color-secondary: #ffd700; /* Dorado Olímpico */
            --color-tertiary: #00ccff; /* Azul Energía Ki/Cielo Griego */
            --color-background: #1a1a2e; /* Azul Noche Profundo / Espacio */
            --color-text: #f0f8ff; /* Blanco Hielo / AliceBlue */
            --color-text-muted: #b0c4de; /* Azul Acero Claro / LightSteelBlue */
            --color-modal-bg: #2a2a4e; /* Azul Púrpura Oscuro */
            --color-border: #4a4a6e; /* Borde Púrpura Grisáceo */
            --color-error-bg: #4d1f1f; /* Fondo error rojo oscuro */
            --color-error-text: #ffbaba; /* Texto error rosa claro */
            --color-error-border: #f44336; /* Borde error rojo */
            --color-game-bg: rgba(10, 10, 20, 0.9); /* Fondo semi-transparente para juego */
            --color-game-target: var(--color-primary);
            --color-game-target-alt: var(--color-tertiary);
            --color-game-score: var(--color-secondary);

            --shadow-sm: 0 1px 2px 0 rgba(255, 153, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(255, 153, 0, 0.15), 0 2px 4px -2px rgba(255, 153, 0, 0.1);
            --shadow-lg: 0 0 25px -5px rgba(255, 215, 0, 0.2), 0 8px 10px -6px rgba(255, 153, 0, 0.15);
            --border-radius: 5px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 0.5px; }
        .page-title-dbz { font-family: 'Bangers', cursive; letter-spacing: 2px; color: var(--color-primary); text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; } /* Estilo DBZ */
        .logo { color: var(--color-secondary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-secondary); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        .navbar { background-color: rgba(42, 42, 78, 0.8); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(26, 26, 46, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Roboto'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(255, 153, 0, 0.25); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Roboto'; font-size: 0.95rem; border-left: 4px solid transparent; position: relative; overflow: hidden; }
        .title-item::before { /* Efecto hover sutil */ content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 153, 0, 0.2), transparent); transition: left 0.4s ease; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-secondary); background-color: #3a3a5e; border-left-color: var(--color-primary); }
        .title-item:hover::before { left: 100%; }

        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: var(--color-background); padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel', serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: none; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { /* Mismos estilos generales */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 46, 0.9); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { /* Mismos estilos generales */ background-color: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: var(--border-radius); padding: 1.5rem 2rem; max-width: 950px; width: 95%; max-height: 90vh; min-height: 450px; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { /* Mismos estilos generales */ position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 150; /* Encima del juego */ }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg); box-shadow: 0 0 10px var(--color-primary); }
        #modal-title { /* Mismos estilos generales */ font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        #modal-content-area { /* Mismos estilos generales */ flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem; scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(74, 74, 110, 0.5); }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(74, 74, 110, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }
        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel', serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; }
        #modal-content h1 { font-size: 1.5em; } #modal-content h2 { font-size: 1.35em; } #modal-content h3 { font-size: 1.2em; color: var(--color-primary); } #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-secondary); border-radius: var(--border-radius); box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 25px rgba(255, 215, 0, 0.5); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(74, 74, 110, 0.7); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-secondary); }

        /* Chat Section Styles (sin cambios mayores) */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(26, 26, 46, 0.7); scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(74, 74, 110, 0.5); }
        #chat-history::-webkit-scrollbar { width: 6px; } #chat-history::-webkit-scrollbar-track { background: rgba(74, 74, 110, 0.5); } #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--color-primary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #4a4a6e; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #1f1f3f; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Roboto'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #ffad33; } #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; } #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Overlay & Minigame Styles */
        #modal-loading { text-align: center; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--color-game-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; border-radius: var(--border-radius); padding: 1rem; /* Add padding */ }
        #loading-text { font-weight: 700; color: var(--color-secondary); font-size: 1.5rem; font-family: 'Cinzel'; margin-bottom: 1.5rem; text-shadow: 0 0 8px var(--color-secondary); }
        #minigame-container { width: 90%; height: 65%; /* Take most space */ background-color: rgba(0, 0, 10, 0.6); border: 2px solid var(--color-primary); border-radius: var(--border-radius); position: relative; overflow: hidden; cursor: crosshair; /* Indicate clickable area */ }
        #game-info { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; color: var(--color-game-score); font-family: 'Bangers', cursive; font-size: 1.6rem; text-shadow: 1px 1px 2px #000; z-index: 110; pointer-events: none; /* Don't block clicks */ }
        .game-target { position: absolute; width: 50px; height: 50px; border-radius: 50%; background-color: var(--color-game-target); background-image: radial-gradient(circle, #fff200, var(--color-game-target)); box-shadow: 0 0 15px var(--color-game-target); transition: transform 0.1s ease-out, opacity 0.3s ease; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: var(--color-background); }
        .game-target.alt { background-color: var(--color-tertiary); background-image: radial-gradient(circle, #ffffff, var(--color-tertiary)); box-shadow: 0 0 15px var(--color-tertiary); }
        .game-target.penalty { background-color: #666; background-image: radial-gradient(circle, #aaa, #666); box-shadow: 0 0 8px #ccc; color: #333; font-size: 1.5rem; /* Bomba o algo */ }
        .game-target:active { transform: scale(0.9); }
        .game-target.hit { transform: scale(1.2); opacity: 0; } /* Efecto al acertar */

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Roboto'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay (sin cambios) */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 46, 0.95); display: none; align-items: center; justify-content: center; z-index: 200; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-secondary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-bolt mr-2 text-yellow-400"></i> <!-- Rayo Zeus -->
                     Panteón Z
                     <i class="fas fa-dragon ml-2 text-orange-500"></i> <!-- Dragón DB -->
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">Crónicas de Dioses y Saiyajins</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title-dbz text-5xl sm:text-6xl mb-5">¡El Olimpo invade el Universo 7!</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Explora historias épicas donde los Dioses Griegos y los Guerreros Z chocan, colaboran y compiten. ¿Podrá Zeus superar un Kamehameha? ¿Hades reclamará las almas de HFIL? ¡Descúbrelo!</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar Dios, Guerrero Z o Evento...">
             <i class="fas fa-search text-yellow-400"></i> <!-- Icono búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll text-yellow-300 mr-2"></i> <!-- Icono pergamino -->
                 Sagas Perdidas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Consultando los Oráculos y los Archivos de Capsule Corp...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» Ninguna saga encontrada con esos parámetros divinos/cósmicos «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Invocar Más Leyendas (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <p id="loading-text">Forjando la Leyenda...</p>
                 <div id="minigame-container">
                     <div id="game-info">
                         <span id="game-score">Score: 0</span>
                         <span id="game-level">Level: 1</span>
                     </div>
                     <!-- Targets appear here -->
                 </div>
                 <p class="text-sm mt-3 text-gray-400 font-sans">¡Mientras esperas, entrena tus reflejos!</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2> <!-- Title filled by JS -->
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder added by JS -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando Oráculo/Scouter...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta al Cronista Cósmico...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Crónicas ficticias generadas por IA fusionando mitología griega y Dragon Ball. Puro entretenimiento especulativo.</p>
              <p class="mt-1">Personajes y conceptos pertenecen a sus respectivos creadores/propietarios.</p>
              <p class="mt-2">© ∞ Panteón Z Archives</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Interacciones Dios-Guerrero Z
            "Zeus desafía a Goku a un combate divino", "Hera siente celos del poder de Bulma", "Poseidón intenta controlar las aguas de Namek", "Hades visita el Otro Mundo de Dragon Ball (HFIL)", "Ares busca entrenar con Piccolo", "Atenea debate estrategia con Gohan", "Apolo intenta enseñar música a Goten y Trunks", "Artemisa compite en cacería con Androide 17", "Hefesto examina la tecnología de Capsule Corp", "Dionisio organiza un festín en Kame House", "Hermes compite en velocidad con Dyspo", "Afrodita intenta seducir a Vegeta (sin éxito)", "Deméter busca tierras fértiles en planetas alienígenas", "Perséfone encuentra paralelismos con el Infierno DBZ", "Hécate investiga la magia de Babidi", "Zeus se impresiona con el Super Saiyan Blue", "Hera juzga el matrimonio de Goku y Chi-Chi", "Poseidón vs. la fuerza de Broly", "Hades negocia almas con Enma Daio", "Ares respeta la disciplina de Vegeta", "Atenea y Whis discuten sobre sabiduría universal", "Apolo y Tapion: un duelo musical", "Artemisa y Androide 18: alianza inesperada", "Hefesto intenta mejorar una Armadura Saiyan", "Dionisio y Maestro Roshi: ¿Amigos de fiesta?", "Hermes entrega un mensaje urgente a Zeno", "Afrodita queda perpleja ante la inocencia de Goku", "Deméter intenta hacer crecer Senzu Beans", "Hades y Freezer: ¿Rivales por el Inframundo?", "Ares admira la furia de Gohan Bestia",
            // Dioses en Eventos DBZ
            "Los Dioses Griegos observan el Torneo de Poder", "Zeus interviene en la batalla contra Freezer", "Hades intenta reclamar el alma de Cell", "Atenea aconseja a los Guerreros Z contra Majin Buu", "Ares participa en el Torneo de Artes Marciales", "Poseidón reacciona a la destrucción de Namek", "Hefesto analiza la estructura de los Androides", "Los Dioses descubren las Esferas del Dragón", "Dionisio organiza un banquete post-victoria Z", "Hermes intenta robar el Radar del Dragón", "Artemisa caza criaturas en el Planeta Vegeta (pasado)", "Apolo predice la llegada de Beerus", "Hécate siente la energía oscura de Towa y Mira", "Zeus vs. Beerus: Choque de Deidades", "Hera intenta usar las Esferas para ser la más bella", "Poseidón crea tsunamis contra Nappa", "Hades ofrece poder a Vegeta a cambio de almas", "Ares se une a la Patrulla del Tiempo", "Atenea advierte sobre Zamasu", "Hefesto forja armas con Kacchin", "Dionisio intenta embriagar a Shenron", "Afrodita se enamora del poder de Jiren", "Deméter ayuda a reconstruir la Tierra tras Cell", "Perséfone es tentada por el poder de Janemba", "Zeus convoca un consejo divino sobre los Saiyajins",
            // Poderes y Comparaciones
            "Rayo de Zeus vs. Kamehameha Final", "Tridente de Poseidón vs. Control del Ki de Agua", "Invisibilidad de Hades vs. Ocultación de Ki", "Fuerza de Ares vs. Poder Super Saiyan", "Sabiduría de Atenea vs. Ultra Instinto", "Velocidad de Hermes vs. Transmisión Instantánea", "Forja de Hefesto vs. Tecnología de Gero", "Magia de Hécate vs. Técnicas de los Kaioshin", "Poder Divino Olímpico vs. Energía de la Destrucción", "Ambrosía vs. Semillas del Ermitaño (Senzu Beans)", "El Olimpo vs. El Planeta de Bills", "El Tártaro vs. HFIL (Home For Infinite Losers)", "Las Moiras vs. El Flujo Temporal de Trunks", "Oráculo de Delfos vs. Visiones de Bardock", "Transformaciones Divinas vs. Fases Super Saiyan", "Control Elemental (Poseidón/Zeus) vs. Ráfagas de Ki", "Maldiciones Griegas vs. Técnicas de Sellado (Mafuba)", "Bendiciones Divinas vs. Potencial Desbloqueado (Gohan Místico)", "Inmortalidad Olímpica vs. Longevidad Saiyan/Namekiana", "Armadura Divina vs. Armadura de Combate Saiyan", "Monstruos Mitológicos vs. Villanos de DBZ", "Pegaso vs. Nube Kinton", "Carro de Apolo vs. Nave de Capsule Corp", "La Égida de Atenea vs. Campo de Fuerza de Androide 17", "Juicio de Hades vs. Juicio de Enma Daio",
            // Escenarios "What If" y Fusión
            "¿Qué pasaría si Zeus obtuviera el Ultra Instinto?", "¿Y si Hera aprendiera la Fusión Metamoru con Bulma?", "¿Podría Poseidón controlar el planeta océano de Monaka?", "¿Si Hades se convirtiera en un Dios de la Destrucción?", "¿Ares como miembro de las Fuerzas Especiales Ginyu?", "¿Atenea entrenando en la Habitación del Tiempo?", "¿Si Hefesto reconstruyera a Mecha Freezer?", "¿Dionisio usando las Esferas para vino infinito?", "¿Hermes trabajando para la Patrulla Galáctica?", "¿Afrodita compitiendo en el Torneo de Poder por amor?", "¿Deméter cultivando en el planeta de Beerus?", "¿Hécate aliándose con Moro?", "¿Un Saiyajin nacido en el Olimpo?", "¿Un Dios Griego alcanzando el estado Super Saiyan Dios?", "¿Kratos (God of War) invade el Universo 7?", "¿Los Titanes vs. los Dioses de la Destrucción?", "¿Prometeo le da el Ki divino a los mortales?", "¿Orfeo calma a Broly con su música?", "¿Ícaro vuela demasiado cerca del sol... o de un Final Flash?", "¿Narciso se enamora de su reflejo Super Saiyan?", "¿Pandora abre una caja llena de energía Hakai?", "¿Medusa petrifica a Dabura?", "¿El Minotauro perdido en el laberinto de HFIL?", "¿Las Sirenas atraen a los Guerreros Z con su canto?", "¿Aquiles con talón vulnerable a ataques de Ki?",
             // Títulos adicionales para llegar a 400 (se añaden variaciones y combinaciones)
            "Zeus vs. Vegeta: Duelo de Orgullo Real", "Hera intenta sabotear el entrenamiento de Pan", "Poseidón crea maremotos en la Tierra", "Hades juzga el alma de Raditz", "Ares impresionado por la tenacidad de Krilin", "Atenea analiza la fusión Potara", "Apolo vs. el sonido ensordecedor de Gotenks", "Artemisa caza en los bosques de la Tierra junto a Yajirobe", "Hefesto estudia la Espada Z", "Dionisio intenta que Piccolo se relaje", "Hermes y Whis: Una carrera por el universo", "Afrodita confundida por la relación de Krilin y 18", "Deméter y el árbol del poder: Conflicto de intereses", "Perséfone explora el palacio de Uranai Baba", "Hécate intenta descifrar los textos Namekianos", "Zeus debate con el Supremo Kaioshin sobre mortales", "Hera critica la crianza de Gohan por Piccolo", "Poseidón lucha contra la gravedad del planeta de Kaio", "Hades y Cell Perfecto: Discusión filosófica sobre la perfección", "Ares desafía a Hit el Infalible", "Atenea y Bulma: Competencia de intelectos", "Apolo compone una ópera sobre la saga Saiyan", "Artemisa considera a Videl una buena discípula", "Hefesto quiere replicar las Cápsulas Hoi-Poi", "Dionisio y Mr. Satán: ¿Dúo cómico?", "Hermes intenta entregar correo en el planeta de Zeno", "Afrodita y Maron: Rivales de belleza?", "Deméter se horroriza por la dieta Saiyan", "Hades establece una embajada en HFIL", "Ares quiere el cuerpo de Ginyu", // ... (Continuar sistemáticamente combinando dioses, personajes Z, lugares, eventos, poderes y conceptos)
             // ... (Añadir 100 más combinando Dioses Menores, personajes secundarios DB, planetas específicos, técnicas específicas)
             // ... (Añadir 100 más con escenarios inversos: Guerreros Z en el Olimpo, Goku vs. el Minotauro, Vegeta vs. Kratos, etc.)
             // ... (Añadir 50 más explorando consecuencias a largo plazo, hijos mestizos dios/saiyan, etc.)
             // El objetivo es tener una base muy amplia para que el usuario explore y "Generar Más" siga siendo interesante.
        ];
        const grecoDBZThemes = [
            "Zeus vs Goku", "Hades en HFIL", "Ares entrenando Saiyans", "Atenea y Gohan", "Poseidón en Namek", "Hefesto y Capsule Corp", "Dioses Griegos y las Esferas del Dragón", "Olimpo vs Planeta de Bills", "Torneo de Poder con Dioses Griegos", "Super Saiyan Dios vs Divinidad Olímpica", "Magia Griega vs Ki", "Mitología en el Universo 7", "Fusiones inesperadas (Hera/Bulma?)", "Guerreros Z en el Olimpo", "Hércules vs Broly", "Titanes contra Ángeles DB", "Artefactos Griegos y Tecnología DB", "What if Kratos en DBZ"
        ];
        const textApiConfig = {
            model: "mistral", // Modelo potente para historias complejas
            systemPrompt: "Eres un Cronista Cósmico, un bardo interdimensional que ha presenciado la insólita fusión del Panteón Griego con el Universo 7 de Dragon Ball. Narra la historia o concepto solicitado con un tono épico, lleno de acción y diálogos característicos de ambos universos. Describe vívidamente los choques de poder (rayos vs ki, magia vs tecnología), las interacciones culturales y los dilemas morales. Sé creativo y fiel al espíritu de ambos mundos. Extensión objetivo: 1200-1300 palabras. Enfócate únicamente en:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Más rápido para chat
            systemPrompt: "Actúas como el Cronista Cósmico asistente. Responde preguntas específicas sobre la historia o concepto griego/DBZ que se está mostrando. Basa tus respuestas en la crónica principal y el conocimiento general de ambos universos fusionados. Sé conciso y mantén el tono épico/DBZ.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un Oráculo Delfico conectado a la Red Capsule Corp. Genera exactamente 40 ideas únicas y emocionantes para historias cortas que fusionen Dioses Griegos y el universo Dragon Ball. Piensa en enfrentamientos, alianzas inesperadas, escenarios 'What If', y choques culturales/poder. Devuelve *solo* la lista de títulos, uno por línea. Sin números, guiones ni introducciones.",
            timeoutSeconds: 60 // Un poco más de tiempo para 40 títulos
        };

        // ========== DOM ELEMENTS ========== (Igual que antes, añadiendo los del juego)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const loadingText = document.getElementById('loading-text');
        const minigameContainer = document.getElementById('minigame-container');
        const gameScoreDisplay = document.getElementById('game-score');
        const gameLevelDisplay = document.getElementById('game-level');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Contexto para chat e imagen
        let gameLoopInterval = null;
        let gameScore = 0;
        let gameLevel = 1;
        let targetSpawnRate = 1500; // ms
        let targetSpeed = 3000; // ms to cross screen
        let maxTargets = 5;
        let gameActive = false;

        // ========== API FUNCTIONS ========== (Sin cambios en la lógica central, solo timeouts/prompts)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Eres un Cronista Cósmico asistente, experto únicamente en la saga '${currentTopicTitle}'. Responde preguntas sobre sus detalles, personajes o consecuencias en el universo fusionado Greco/DBZ. Sé conciso y épico.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text (Chat: ${isChat}): ${url.substring(0, 150)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Los Oráculos/Servidores están sobrecargados. Intenta invocar la saga de nuevo en un momento.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("El Cronista Cósmico se quedó sin palabras. Intenta otra saga.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión con el Nexo Cósmico falló (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 throw new Error(error.message || "Una distorsión desconocida impidió obtener la crónica.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Error Interno: Saga no definida para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() { // Pide 40 títulos
             const randomTheme = getRandomElement(grecoDBZThemes) || "fusión Grecia y Dragon Ball";
             const specificPrompt = `Genera 40 ideas de historias sobre ${randomTheme}`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                  .then(text => {
                      const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150);
                      if (titles.length < 10) throw new Error("El Oráculo no pudo concebir suficientes leyendas nuevas."); // Menos estricto que pedir 40
                      return titles.slice(0, 40); // Asegura máximo 40
                  });
         }
        function createPollinationsImageUrl(promptText, options = {}) { // Adaptar prompt visual
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Greek God meets Dragon Ball Z character";
            // Prompt más específico para la fusión
            const enhancedPrompt = `Epic scene depicting '${safePromptText}'. Fusion of Greek mythology aesthetic (marble, togas, divine light) and Dragon Ball Z style (dynamic poses, energy auras, sci-fi elements). Cinematic, dramatic lighting. Avoid text or labels.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, label, title, signature, watermark, blurry, low quality, simple, cartoonish, multiple panels, collage, diagram";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */ if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted; }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            stopMinigame(); // Asegura detener el juego al cerrar
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex'; // Mostrar carga por defecto
             minigameContainer.style.display = 'none'; // Ocultar juego por defecto
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
             // Reset game state explicitamente
             gameScore = 0;
             gameLevel = 1;
             if(gameScoreDisplay) gameScoreDisplay.textContent = `Score: 0`;
             if(gameLevelDisplay) gameLevelDisplay.textContent = `Level: 1`;
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Oráculo/Scouter dice: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== MINIGAME FUNCTIONS ==========
        function updateGameInfo() {
            gameScoreDisplay.textContent = `Score: ${gameScore}`;
            gameLevelDisplay.textContent = `Level: ${gameLevel}`;
        }

        function handleTargetClick(event) {
            if (!gameActive) return;
            const target = event.target;
            if (target.classList.contains('penalty')) {
                gameScore -= 5 * gameLevel; // Penalización mayor en niveles altos
                target.innerHTML = '<i class="fas fa-bomb"></i>'; // Muestra bomba
            } else {
                gameScore += 1 * gameLevel; // Más puntos por nivel
                 target.innerHTML = '<i class="fas fa-star"></i>'; // Estrella al acertar
            }
            target.classList.add('hit');
            updateGameInfo();
            target.style.pointerEvents = 'none'; // No más clicks

            // Check for level up
            if (gameScore >= gameLevel * 20) { // Condición de nivel (ajustable)
                increaseLevel();
            }

            setTimeout(() => { target.remove(); }, 300); // Elimina después de la animación
        }

        function spawnTarget() {
            if (!gameActive || !minigameContainer) return;

            const containerWidth = minigameContainer.offsetWidth;
            const containerHeight = minigameContainer.offsetHeight;
            if (!containerWidth || !containerHeight) return; // Evita error si el contenedor no es visible

            const target = document.createElement('div');
            target.classList.add('game-target');

            // Random Type (más probabilidad de normal)
            const typeRoll = Math.random();
            if (gameLevel > 2 && typeRoll < 0.15) { // Penalización aparece en nivel 3+
                 target.classList.add('penalty');
                 target.innerHTML = '<i class="fas fa-skull-crossbones"></i>'; // Calavera inicial
            } else if (gameLevel > 1 && typeRoll < 0.4) { // Target alternativo nivel 2+
                 target.classList.add('alt');
                 target.innerHTML = '<i class="fas fa-bolt"></i>'; // Rayo
            } else {
                 target.innerHTML = '<i class="fas fa-khanda"></i>'; // Símbolo tipo Ki/Divino
            }

            // Random position ensuring it's fully inside
            const size = 50; // Target size
            target.style.left = `${Math.random() * (containerWidth - size)}px`;
            target.style.top = `${Math.random() * (containerHeight - size)}px`;

            target.addEventListener('click', handleTargetClick);
            minigameContainer.appendChild(target);

            // Self-destruct if not clicked
            setTimeout(() => {
                if (target && !target.classList.contains('hit')) {
                    target.remove();
                }
            }, targetSpeed * 0.9); // Remove a bit before theoretical end
        }

        function increaseLevel() {
            gameLevel++;
            targetSpawnRate = Math.max(300, targetSpawnRate * 0.85); // Más rápido
            targetSpeed = Math.max(1500, targetSpeed * 0.9);   // Más rápido
            maxTargets = Math.min(15, maxTargets + 1);         // Más objetivos
            console.log(`Level Up! Lvl: ${gameLevel}, Spawn: ${targetSpawnRate}, Speed: ${targetSpeed}, Max: ${maxTargets}`);
            updateGameInfo();
             // Limpiar objetivos viejos al subir nivel para evitar acumulación excesiva
             const oldTargets = minigameContainer.querySelectorAll('.game-target');
             oldTargets.forEach(t => t.remove());
        }

        function gameLoop() {
            if (!gameActive) return;
            // Controlar número máximo de objetivos
            const currentTargets = minigameContainer.querySelectorAll('.game-target').length;
            if (currentTargets < maxTargets) {
                 spawnTarget();
            }
        }

        function startMinigame() {
            console.log("Starting Minigame");
            gameActive = true;
            gameScore = 0;
            gameLevel = 1;
            targetSpawnRate = 1500;
            targetSpeed = 3000;
            maxTargets = 5;
            updateGameInfo();
            minigameContainer.innerHTML = ''; // Clear previous targets
            minigameContainer.appendChild(gameScoreDisplay.parentElement); // Re-add score display
            minigameContainer.style.display = 'block';
            modalLoadingIndicator.style.display = 'flex'; // Asegura que el contenedor principal sea flex
            loadingText.textContent = "Entrenando Reflejos..."; // Cambiar texto

            // Limpiar intervalo anterior si existiera
            if (gameLoopInterval) clearInterval(gameLoopInterval);
            gameLoopInterval = setInterval(gameLoop, targetSpawnRate);
            gameLoop(); // Primera ejecución inmediata
        }

        function stopMinigame() {
            console.log("Stopping Minigame");
            gameActive = false;
            if (gameLoopInterval) {
                clearInterval(gameLoopInterval);
                gameLoopInterval = null;
            }
            if(minigameContainer) {
                 minigameContainer.style.display = 'none'; // Ocultar área de juego
                 minigameContainer.innerHTML = ''; // Limpiar completamente
            }
             if(loadingText) loadingText.textContent = "Forjando la Leyenda..."; // Restaurar texto original
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar menos estrictamente, quizás por longitud o dejar aleatorio? Alfabético por ahora.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» El Oráculo está en silencio... No hay leyendas disponibles. «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Added ${addedCount} new unique titles.`);
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick integrates minigame ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // Set context for chat/image
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; // Ensure loading is visible

            startMinigame(); // <--- START MINIGAME HERE

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                stopMinigame(); // <--- STOP MINIGAME on success
                modalLoadingIndicator.style.display = 'none'; // Hide loading overlay
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Image Handling (remains the same)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Canalizando Visión Cósmica...</p>`;
                modalContent.appendChild(placeholderDiv);
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización épica de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visión bloqueada.</p>`; };
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar visión.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                stopMinigame(); // <--- STOP MINIGAME on error
                modalLoadingIndicator.style.display = 'none'; // Hide loading
                modalErrorMessage.textContent = error.message || "Una perturbación desconocida corrompió la crónica.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles requests 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Invocando Sagas...';
             try {
                 // fetchGeneratedTitles ahora internamente pide 40
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Los Oráculos no respondieron con nuevas leyendas ahora."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al invocar leyendas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Invocar Más Leyendas (40)';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Verificar elementos esenciales, incluyendo los del juego
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalLoadingIndicator || !minigameContainer || !gameScoreDisplay || !gameLevelDisplay || !loadingText) {
                console.error("Initialization failed: Missing essential elements (UI or Game).");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">++ ERROR CRÍTICO DE INICIALIZACIÓN DEL NEXO CÓSMICO ++</p>';
                return;
             }
            // Listeners (igual que antes)
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Carga inicial
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>