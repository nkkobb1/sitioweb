<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fábulas y Parábolas - Sabiduría IA</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Using Google Fonts: Noto Serif for body, Cinzel Decorative for headings -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #8fbc8f; /* Dark Sea Green */
            --color-secondary: #d2b48c; /* Tan */
            --color-background: #f5f5dc; /* Beige */
            --color-text: #5d4037; /* Dark Brown */
            --color-text-light: #a1887f; /* Lighter Brown */
            --color-modal-bg: #fffaf0; /* Floral White */
            --color-heading: #4b5320; /* Olive Green */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.12);
            --border-radius: 10px;
            --transition-normal: all 0.3s ease;
        }

        body {
            font-family: 'Noto Serif', serif;
            background-color: var(--color-background);
            color: var(--color-text);
             /* Subtle parchment/paper texture */
             background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWDg4N3d3dtbW17e3t1dXWBgYGHh4d5eXlzc3OLi4ubm5uVlZWPj4+NjY19fX2JiYl/f39ra2uRkZGZmZlpaWmXl5dvb29xcXGTk5NnZ2c8TV1mAAAAG3RSTlNAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAvEOwtAAAFVklEQVR4XpWWB67c2BUFb3g557T/hRo9/WUMZHlgr4Bg8Z4qQg7msmfGK0yrFNrv4AqcGGYNu34cvley6zEMAchWUYPEOkO/+74/2dWpointBQuJ0eva1r6/cHklUPgAjWRwC/BGHoHklUPgAwWRwC/BGHoHkltwGaWROA3SYAkupzsFnEkQFZ6ZUClMGUoSİŞRsoAK8BbJGzAkqwmGKXTRnpBUhष्णुגן poświęca pracy twórczej i konstruktywnej pracy społecznej więcej czasu.'); /* Subtle text effect */
            line-height: 1.6;
        }

        /* Headings using Cinzel Decorative, fallbacks */
        h1, h2.decorative-heading, .logo-text {
            font-family: 'Cinzel Decorative', cursive, serif;
            color: var(--color-heading);
            letter-spacing: 0.5px;
        }
         /* Specific override for modal title */
         #modal-title {
             font-family: 'Cinzel Decorative', cursive, serif;
             color: var(--color-heading);
         }

        .navbar {
            background-color: var(--color-modal-bg); /* Light background */
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 20;
            border-bottom: 1px solid var(--color-secondary);
        }
        .navbar .logo-text {
             color: var(--color-heading); /* Use heading color for logo */
        }

        .navbar a {
            color: var(--color-text);
            font-weight: bold;
        }
        .navbar a:hover {
            color: var(--color-primary);
        }

        /* Title List Styling */
        #title-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); /* Slightly smaller min size */
            gap: 1.25rem; /* Slightly smaller gap */
        }

        .title-item {
            background-color: var(--color-modal-bg);
            padding: 1.25rem 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: var(--transition-normal);
            text-align: center;
            font-weight: 700;
            color: var(--color-text);
            border: 1px solid var(--color-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70px;
        }

        .title-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
            background-color: #fffef5; /* Slightly warmer hover */
        }

        /* Generate More Button */
        #generate-more-btn {
             grid-column: 1 / -1;
             background-color: var(--color-primary);
             color: white;
             padding: 0.7rem 1.4rem;
             border: none;
             border-radius: var(--border-radius);
             font-family: 'Noto Serif', serif;
             font-weight: bold;
             cursor: pointer;
             transition: var(--transition-normal);
             margin-top: 1.5rem;
             box-shadow: var(--shadow-sm);
        }
        #generate-more-btn:hover:not(:disabled) {
             background-color: #76a576; /* Darker Green */
             box-shadow: var(--shadow-md);
        }
         #generate-more-btn:disabled {
             background-color: #b0c4b1; /* Lighter, disabled green */
             cursor: not-allowed;
             opacity: 0.8;
         }

        /* Modal Styling */
        #story-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(93, 64, 55, 0.7); /* Brownish overlay */
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
            overflow-y: auto;
        }

        #story-modal.active {
            display: flex;
        }

        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-secondary);
            padding: 2rem;
            max-width: 750px; /* Slightly narrower */
            width: 95%;
            max-height: 90vh;
            overflow: hidden; /* Let internal elements scroll */
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }

        .modal-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--color-secondary);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--color-background);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: var(--transition-normal);
            z-index: 10;
        }
        .modal-close-btn:hover {
            background-color: var(--color-primary);
            color: white;
            transform: rotate(-90deg);
        }

        /* Content Area - Text First */
         #modal-story-content-area {
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allow this whole area to scroll if needed */
            flex-grow: 1;
         }

        #modal-content {
            line-height: 1.75; /* Slightly more spacing */
            color: var(--color-text);
            white-space: pre-wrap;
            margin-bottom: 1.5rem; /* Space before image */
            font-size: 1.05rem; /* Slightly larger text */
             /* Custom scrollbar for webkit */
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) var(--color-modal-bg);
        }
         #modal-content::-webkit-scrollbar {
             width: 8px;
         }
         #modal-content::-webkit-scrollbar-track {
             background: #edebe1; /* Lighter track */
             border-radius: 4px;
         }
         #modal-content::-webkit-scrollbar-thumb {
             background-color: var(--color-secondary); /* Tan thumb */
             border-radius: 4px;
             border: 2px solid var(--color-modal-bg);
         }
         #modal-content p:not(:last-child) {
            margin-bottom: 1em;
        }
         /* Style for the morale */
         #modal-content strong { /* Assuming morale is bold */
             display: block; /* Put morale on its own line */
             margin-top: 1.5em;
             padding-top: 1em;
             border-top: 1px dashed var(--color-secondary);
             color: var(--color-heading);
             font-style: italic;
         }


        /* Image container - now at the bottom */
        #modal-image-container {
            width: 100%;
            height: 200px; /* Slightly smaller image height */
            background-color: #e8e5d9; /* Lighter beige */
            border-radius: var(--border-radius);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--color-secondary);
            flex-shrink: 0; /* Prevent shrinking */
            margin-top: auto; /* Push to bottom if content is short */
        }
         #modal-image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Use contain to see whole image */
            display: none;
            filter: sepia(20%); /* Subtle sepia filter */
         }
         #modal-image-container .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--color-primary);
            animation: spin 1s linear infinite;
            display: none;
         }
         #modal-image-container .placeholder-icon {
             font-size: 2.5rem;
             color: var(--color-text-light);
             display: none;
         }


        /* Loading Indicator */
        #modal-loading {
            text-align: center;
            padding: 3rem 0;
        }
        .loading-spinner-modal {
            width: 55px;
            height: 55px;
            border: 5px solid var(--color-secondary);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            margin: 0 auto 1rem auto;
        }
        #modal-loading p {
            font-weight: bold;
            color: var(--color-text);
            font-size: 1.1rem;
            font-family: 'Noto Serif', serif;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error message styling */
        .error-msg {
            background-color: #fef3c7; /* Light yellow */
            color: #92400e; /* Dark yellow/brown */
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #fcd34d; /* Yellow border */
            margin-top: 1rem;
            text-align: center;
        }
         .error-msg i {
             margin-right: 0.5rem;
         }

         .content-hidden {
             display: none;
         }

    </style>
</head>
<body>
    <!-- Header/Navbar -->
    <nav class="navbar mb-8">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <!-- Using an icon that fits the theme -->
                <h1 class="logo-text text-2xl sm:text-3xl">
                    <i class="fas fa-feather-alt mr-2"></i> Fábulas y Parábolas
                </h1>
            </div>
             <div class="flex space-x-6"> <!-- Simple links, no hamburger needed now -->
                <a href="#">Inicio</a>
                <a href="#">Acerca de</a>
            </div>
             <!-- Removed Hamburger Icon -->
        </div>
    </nav>

    <!-- Main content -->
    <main class="container mx-auto px-4 pb-16">
        <!-- Hero section -->
        <section class="mb-12 text-center">
            <h2 class="decorative-heading text-4xl sm:text-5xl text-green-800 mb-4">Descubre la Sabiduría Ancestral</h2>
            <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto">Selecciona una historia. La IA te revelará una fábula o parábola con una valiosa lección.</p>
        </section>

        <!-- Title List Container -->
        <section class="mb-10">
            <h2 class="decorative-heading text-3xl sm:text-4xl mb-6 text-center">
                <i class="fas fa-book-open text-green-700 mr-2"></i>
                Historias para Reflexionar
            </h2>
            <div id="title-list">
                <!-- Titles will be inserted here by JavaScript -->
                 <p id="titles-loading" class="text-gray-600 col-span-full text-center text-lg">Buscando pergaminos...</p>
            </div>
             <!-- Button Container Below Grid -->
            <div id="generate-more-container" class="text-center mt-8">
                <button id="generate-more-btn">
                     <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                    Generar Más Títulos
                 </button>
            </div>
        </section>

    </main>

    <!-- Story Modal -->
    <div id="story-modal">
        <div class="modal-content-wrapper">
            <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

            <!-- Loading Indicator for Text -->
            <div id="modal-loading">
                <div class="loading-spinner-modal"></div>
                <p>Tejiendo la enseñanza...</p>
            </div>

            <!-- Content Area (hidden initially) -->
            <div id="modal-story-content-area" class="content-hidden">
                <h2 id="modal-title" class="text-3xl md:text-4xl font-bold mb-5 text-center"></h2>
                <!-- Text Content FIRST -->
                <div id="modal-content" class="text-lg">
                    <!-- Story text goes here -->
                </div>
                <!-- Image Container LAST -->
                <div id="modal-image-container">
                    <div class="spinner"></div>
                    <i class="fas fa-leaf placeholder-icon"></i> <!-- Themed Placeholder -->
                    <img id="modal-image" alt="Ilustración de la fábula" />
                </div>
                 <!-- Error Display Area -->
                <div id="modal-error" class="error-msg content-hidden">
                     <i class="fas fa-exclamation-circle"></i> <!-- Different Icon -->
                     <span id="modal-error-message"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-6 mt-12">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>Las fábulas y parábolas son generadas por IA y buscan inspirar reflexión.</p>
            <p class="mt-2">© 2025 Fábulas y Parábolas IA</p>
        </div>
    </footer>

    <script>
        // ========== CONFIG & DATA ==========

        // --- List of Fable/Parable Titles ---
        const predefinedTitles = [
            "El Zorro y las Uvas Ácidas", "La Liebre Orgullosa y la Tortuga Constante", "El Viento y el Sol Compiten",
            "El Pastor Mentiroso y el Lobo", "La Hormiga Trabajadora y la Cigarra Ociosa", "El León Enamorado del Pastor",
            "El Cuervo Sediento y la Jarra", "El Asno Vestido con Piel de León", "La Rana que Quería ser tan Grande como un Buey",
            "El Árbol que Daba Sombra Generosa", "La Parábola del Sembrador de Trigo", "El Buen Samaritano y el Viajero Herido",
            "La Perla Escondida de Gran Precio", "La Parábola del Hijo Pródigo y el Padre Compasivo", "La Astucia del Gato con Botas",
            "El Secreto del Arroyo Murmurador", "La Abeja que Aprendió a Compartir el Néctar", "El Búho Sabio y el Ratón Curioso",
            "La Razón por la que el Mar es Salado", "La Flor Vanidosa y el Jardinero Paciente", "El Eco que Enseñaba el Respeto",
            "El Ratón de Campo y el Ratón de Ciudad", "El Perro que Llevaba un Hueso y Vio su Reflejo", "Los Dos Amigos y el Oso Pardo",
            "El Agricultor y sus Hijos Disputadores", "El Caballo Viejo y el Lobo Hambriento", "La Leona y la Osa Discutiendo",
            "El Congreso de los Ratones y el Cascabel", "La Zorra y la Cigüeña Invitadas", "El Lobo Satisfecho y la Oveja Flaca",
            "El Pescador y el Pececillo Diminuto", "El Astrónomo Distraído que Cayó en un Pozo", "El Murciélago, el Pájaro y la Bestia Neutral",
            "La Comadreja y las Limas de Hierro", "El León Viejo y la Zorra Inteligente", "La Golondrina Previsora y los Otros Pájaros",
            "El Perro y la Campanilla del Pastor", "El Hombre, su Hijo y el Burro Cambiante", "Los Viajeros y el Plátano Protector",
            "El Ciervo Reflejado en la Fuente", "El labrador y la serpiente helada", "La zorra que nunca había visto un león",
            "El caballo y el asno cargado", "El águila, el cuervo y el pastor", "Las ranas pidiendo rey a Júpiter",
            "El perro fiel y el ladrón nocturno", "La gallina de los huevos de oro (y la avaricia)", "El avaro que enterró su tesoro",
            "El parto de los montes (grandes promesas)", "El médico ignorante", "El león y el ratón agradecido",
            "El niño que se ahogaba y el viajero", "El lobo y la grulla paciente", "El perro y el cocinero glotón",
            "La zorra y el leñador honesto", "El ciervo y la viña traicionera", "Los bueyes y el eje de la carreta",
            "La lámpara vanidosa y el viento", "El olivo y la higuera comparados", "La liebre y las ranas miedosas",
            "El lobo y el perro guardián", "El ratón y la rana tramposa", "La hormiga y la paloma agradecida",
            "El jabalí y la zorra precavida", "El caballo que perdió su libertad", "El leñador y el dios Mercurio",
            "El viajero y la fortuna burlona", "El lobo y el cordero en el arroyo", "El granjero y la cigüeña inocente",
            "La alondra y sus polluelos en el trigal", "El sol y las ranas quejumbrosas", "El pescador flautista",
            "El escorpión y la tortuga paciente", "La mona y sus dos crías", "El pavo real y la grulla modesta",
            "El oso y las abejas enfadadas", "El camello visto por primera vez", "El cuervo enfermo y su madre",
            "El delfín, la ballena y el alción", "El perro envidioso del buey", "El labrador y el árbol útil",
            "El león y los tres bueyes unidos", "El mosquito y el toro indiferente", "La liebre que se burlaba de la tortuga",
            "El pastor y las ovejas confiadas", "La zorra y el mono rey", "El águila y la flecha certera",
            "El viejo perro de caza", "El jardinero y su perro fiel", "El asno y el caballo de guerra",
            "El náufrago y el mar tranquilo", "El mercader de sal y su asno", "El lobo y el caballo astuto",
            "Los dos escarabajos compitiendo", "El hombre y la estatua de madera", "El león y el delfín aliados",
            "El joven y el ladrón hábil", "La zorra y el espino protector", "El niño ladrón y su madre",
            "El adivino y el cliente escéptico", "El lobo herido y la oveja compasiva", "El perro con carne y su sombra",
            "La comadreja y el gallo vigilante", "El león y la cabra en el precipicio", "Los árboles y el hacha",
            "El pastor y el mar tentador", "La cigarra y la hormiga (versión amable)", "El perro y el trozo de carne (otra versión)",
            "El asno, el gallo y el león hambriento", "Los dos cangrejos caminando", "El labrador y sus perros guardianes",
            "El león, la zorra y el ciervo enfermo", "El mono y los pescadores distraídos", "La víbora y la lima",
            "El pastorcillo y las ovejas perdidas", "El águila y el escarabajo vengativo", "La zorra y las uvas (insistencia)",
            "El caballo y el soldado descuidado", "El ciervo tuerto", "El niño y los dulces",
            "El lobo y la cabra en el tejado", "El jardinero y el pequeño rosal", "La zorra y la máscara teatral",
            "El murciélago y las comadrejas", "El león, el oso y la zorra", "La rana médica",
            "El cuervo y la zorra (halagos)", "El perro del hortelano", "La paloma sedienta",
            "El hombre rico y el zapatero feliz", "El burro flautista por casualidad", "El león y el jabalí sedientos",
            "El caballo y el asno (compartir carga)", "La ostra y los litigantes", "El águila y la zorra amigas",
            "El viejo león y la zorra astuta", "El labrador y la fortuna", "El mosquito y el león",
            "La liebre, el águila y el cazador", "El pastor y las cabras salvajes", "El perro que dejó la sustancia por la sombra",
            "El león, Prometeo y el elefante", "Las ocas y las grullas", "El mulo presuntuoso",
            "El lobo y el pastor", "El ciervo en la cueva del león", "Los dos gallos y el águila",
            "El cazador y el leñador", "El caballo que quería vengarse del ciervo", "El león y el pastor",
            "La zorra y el leñador", "El delfín náufrago y el mono", "El oso y los dos viajeros",
            "El perro y la ostra", "El asno y la zorra cazando", "El cangrejo y su madre",
            "El león, la vaca, la cabra y la oveja", "El lobo y el cordero", "El caballo y el ciervo",
            "La tórtola y la hormiga", "El león y la liebre", "El burro y el perro",
            "El lobo y el asno", "La zorra y el busto", "El águila y la corneja",
            "El buey y la rana", "La hormiga y la mosca", "El león y la zorra",
            "El lobo y el perro flaco", "El ratón y el león", "El asno y la perrita faldera",
            "El perro y el lobo", "El león y el mosquito", "La paloma y la hormiga",
            "El águila y los gallos", "El lobo y la oveja", "El ratón y el gato",
            "El león y el asno cazando", "El burro y su sombra", "El murciélago y la comadreja",
            "El perro, el gallo y la zorra", "La rana y el ratón", "El lobo y la cigüeña"
        ];

        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un escritor experto en fábulas y parábolas cortas (aproximadamente 150-300 palabras). Tus historias deben presentar animales o elementos personificados, tener un lenguaje claro y concluir siempre con una moraleja o enseñanza explícita y concisa al final, claramente marcada (por ejemplo, con 'Moraleja:'). Escribe una fábula o parábola completa basada únicamente en el siguiente título:",
            timeoutSeconds: 45
        };

         const titleGenerationConfig = {
             model: "mistral",
             systemPrompt: "Actúa como un generador de ideas conciso. Genera exactamente 15 ideas de títulos cortos y evocadores para fábulas o parábolas que sugieran una moraleja. Devuelve *solo* la lista de títulos, uno por línea. No incluyas números, guiones ni texto adicional.",
             prompt: "Genera 15 títulos de fábulas o parábolas",
             timeoutSeconds: 30
         };

        // ========== DOM ELEMENTS ==========
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ==========

        async function fetchTextFromApi(prompt, config) {
            const encodedPrompt = encodeURIComponent(prompt);
            const encodedSystem = encodeURIComponent(config.systemPrompt);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}): ${url}`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                throw new Error(`Error de comunicación con la API. ${error.message}`);
            }
        }

        async function fetchStoryText(title) {
            const text = await fetchTextFromApi(title, textApiConfig);
            // Validation for fable content (e.g., check for 'Moraleja:')
            if (text.trim().length < 50 || !text.includes('Moraleja:')) {
                console.warn("API returned potentially invalid fable response:", text);
                throw new Error("La IA no pudo generar una fábula adecuada con moraleja para este título.");
            }
            // Add bold formatting to the moraleja part if not already present
             return text.replace(/(Moraleja:.*)/i, '\n\n**$1**'); // Add bold markdown, CSS will handle style
        }

        async function fetchGeneratedTitles() {
            const text = await fetchTextFromApi(titleGenerationConfig.prompt, titleGenerationConfig);
            const titles = text.split('\n').map(line => line.trim()).filter(line => line.length > 3 && line.length < 80); // Filter length
            if (titles.length < 5) {
                console.warn("API returned too few titles:", titles);
                throw new Error("No se pudieron generar suficientes ideas de títulos.");
            }
            return titles.slice(0, 15);
        }

        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "fábula con animales";
            const styleKeywords = [
                "gentle storybook illustration style", "classic fable art style", "watercolor style",
                "soft colored pencil drawing", "children's book art", "woodcut print style",
                "whimsical animal characters", "nature scene illustration"
            ];
            const randomStyle = getRandomElement(styleKeywords);
            const enhancedPrompt = `${randomStyle} of ${safePromptText}, simple background, soft lighting, no text`;

            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';

            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=photorealistic, scary, dark, abstract, 3d render`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== MODAL FUNCTIONS ========== (Unchanged from previous correct version)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { if(!storyModal) return; storyModal.classList.remove('active'); document.body.style.overflow = ''; resetModalState(); }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer || !modalErrorMessage) return;
             modalLoadingIndicator.style.display = 'block';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = ''; // Use innerHTML now if we add formatting
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.style.display = 'flex';
             modalErrorMessage.textContent = '';
        }


        // ========== UI & EVENT HANDLERS ==========

        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let currentIndex = array.length, randomIndex; while (currentIndex > 0) { randomIndex = Math.floor(Math.random() * currentIndex); currentIndex--; [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]]; } return array; }

         function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            div.textContent = title;
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }

        function displayTitles(titles) {
            if (!titleListContainer || !titlesLoading) return;
            const shuffledTitles = shuffleArray([...titles]);
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-600 col-span-full text-center">No hay historias disponibles.</p>'; return; }
            shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
        }

         function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;

            try {
                const storyText = await fetchStoryText(title);

                modalLoadingIndicator.style.display = 'none';
                // Use innerHTML to render the bolded moraleja
                 // Basic sanitation (replace potential script tags) - needs robust library for production
                 const sanitizedText = storyText.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, "");
                modalContent.innerHTML = sanitizedText.replace(/\n/g, '<br/>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Render breaks and bold
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageSpinner.style.display = 'block';

                const imageUrl = createPollinationsImageUrl(title);

                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image for title:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL for title:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block';
                 }

            } catch (error) {
                console.error("Failed to display story:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                // Hide image container only if text fails, keep content area for error msg
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = ''; // Clear potentially broken content
            }
        }

         async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer || !titleListContainer) return;

             generateMoreBtn.disabled = true;
             generateMoreBtn.textContent = 'Generando...';
             generateMoreSpinner.classList.remove('hidden');

             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; // Hide button before appending
                     appendTitles(newTitles);
                      // Re-append button container at the end of the main container
                     if (titleListContainer.parentNode?.parentNode) { // Append to the parent of title-list's parent (main section)
                         titleListContainer.parentNode.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block'; // Show it again
                 } else {
                      alert("No se pudieron generar nuevas ideas de títulos.");
                 }
             } catch (error) {
                 console.error("Failed to generate more titles:", error);
                 alert(`Error al generar más títulos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreSpinner.classList.add('hidden');
                 generateMoreBtn.textContent = 'Generar Más Títulos';
             }
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) {
                 console.error("Initialization failed: Critical elements missing.");
                 document.body.innerHTML = '<p style="padding: 2rem; text-align: center; color: #5d4037;">Error crítico al cargar la página. Por favor, recargue.</p>';
                 return;
            }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>