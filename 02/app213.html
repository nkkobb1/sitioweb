<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misterios del Abismo - Criaturas de las Profundidades</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y evocadoras -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Criaturas Marinas Profundas --- */
        :root {
            --color-primary: #6fffe9; /* Cyan Bioluminiscente */
            --color-secondary: #f4f776; /* Amarillo Bioluminiscente (uso moderado) */
            --color-tertiary: #5bc0be; /* Teal Profundo */
            --color-background: #0b132b; /* Azul Abisal Muy Oscuro */
            --color-text: #edf6f9; /* Blanco Hielo */
            --color-text-muted: #a8dadc; /* Azul Pálido */
            --color-modal-bg: #1c2541; /* Azul Oscuro Ligeramente Más Claro */
            --color-border: #3a506b; /* Borde Azul Grisáceo */
            --color-error-bg: #4a0e0e; /* Fondo error rojo oscuro */
            --color-error-text: #fecaca; /* Texto error claro */
            --color-error-border: #e53e3e; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(111, 255, 233, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(111, 255, 233, 0.15), 0 2px 4px -2px rgba(111, 255, 233, 0.1);
            --shadow-lg: 0 0 25px -5px rgba(111, 255, 233, 0.2), 0 8px 10px -6px rgba(111, 255, 233, 0.15);
            --border-radius: 5px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Poppins', sans-serif; font-weight: 600; letter-spacing: 0.5px; }
        .logo, h1.page-title { font-family: 'Cinzel Decorative', cursive; font-weight: 700; } /* Fuente especial para títulos principales */
        .logo { color: var(--color-primary); text-shadow: 0 0 8px var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 5px rgba(111, 255, 233, 0.7); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 600; }
        #modal-title { color: var(--color-primary); font-weight: 600; text-shadow: 0 0 3px rgba(111, 255, 233, 0.5); }
        .navbar { background-color: rgba(11, 19, 43, 0.85); backdrop-filter: blur(6px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(28, 37, 65, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Poppins'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(111, 255, 233, 0.25); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Poppins'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-4px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #2a4160; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-tertiary)); color: var(--color-background); padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: none; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-tertiary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(11, 19, 43, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Ample height for content + chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(180deg); box-shadow: 0 0 10px var(--color-primary); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(58, 80, 107, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(58, 80, 107, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 400; } /* Emphasis with secondary color */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Poppins', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 600; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: 0 0 15px rgba(111, 255, 233, 0.2); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(58, 80, 107, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-tertiary); } /* Icono temático */

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(11, 19, 43, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(58, 80, 107, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(58, 80, 107, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95em;}
        .user-message { background-color: var(--color-tertiary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #3a506b; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #2a4160; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Poppins'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #aafff0; } /* Lighter cyan */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(11, 19, 43, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.3rem; font-family: 'Poppins'; text-shadow: 0 0 5px var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Poppins'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(11, 19, 43, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-water mr-3"></i> <!-- Icono agua -->
                     Misterios del Abismo
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Enciclopedia Abisal «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora lo Inexplorado</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Sumérgete en la base de datos de las criaturas más extrañas y fascinantes que habitan las profundidades oceánicas.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar criatura o fenómeno abisal...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-fish text-cyan-400 mr-2"></i> <!-- Icono pez -->
                 Índice Abisal
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Accediendo a los registros profundos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron especímenes con esos parámetros «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Más Profundo (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Recopilando Datos del Abismo...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Analizando consulta biológica...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este espécimen...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos y de divulgación sobre la biología marina profunda.</p>
              <p class="mt-1">La vida abisal es compleja; consulta fuentes científicas revisadas para datos definitivos.</p>
              <p class="mt-2">© 2025 Expedición Abisal Interactiva</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Peces Abisales Clásicos
            "Pez Rape Abisal (Lophiiformes)", "Pez Víbora (Chauliodus sloani)", "Pez Dragón Negro (Idiacanthus atlanticus)", "Pez Hacha (Argyropelecus)", "Pez Telescopio (Gigantura indica)", "Pez Fangtooth (Anoplogaster cornuta)", "Pez Gota / Blobfish (Psychrolutes marcidus)", "Pez Pelícano / Engullidor (Eurypharynx pelecanoides)", "Pez Golondrina Negro (Chiasmodon niger)", "Granadero / Pez Rata (Macrouridae)", "Pez Baboso de las Marianas (Pseudoliparis swirei)", "Pez Trípode (Bathypterois grallator)", "Brótula Vivípara (Ophidiidae)", "Pez Linterna (Myctophidae)", "Pez Ogro (Anoplogaster)", "Pez Hielo (Channichthyidae)", "Pez Remo (Regalecus glesne)", "Pez Diablillo Espinoso (Caulophryne jordani)", "Pez Lophiiforme de Aletas Radiales (Linophrynidae)", "Pez Diente de Daga (Anotopterus pharao)",
            // Cefalópodos de Profundidad
            "Calamar Vampiro (Vampyroteuthis infernalis)", "Pulpo Dumbo (Grimpoteuthis)", "Calamar Gigante (Architeuthis dux)", "Calamar Colosal (Mesonychoteuthis hamiltoni)", "Calamar de Cristal (Cranchiidae)", "Nautilo (Nautilus pompilius - Rango Profundo)", "Pulpo Telescópico (Amphitretus pelagicus)", "Calamar Histioteuthis (Ojo Asimétrico)", "Calamar Ram's Horn (Spirula spirula)", "Pulpo de Siete Brazos (Haliphron atlanticus)", "Calamar Promachoteuthis sulcus (Sin Pico)", "Sepia Abisal (Sepiolida)", "Pulpo Manta (Tremoctopus)", "Calamar Mariposa (Psychroteuthis glacialis)", "Calamar Joya (Lycoteuthidae)",
            // Crustáceos y Otros Artrópodos
            "Isópodo Gigante (Bathynomus giganteus)", "Cangrejo Yeti (Kiwa hirsuta)", "Anfípodos Abisales (Amphipoda)", "Copépodos de Profundidad (Copepoda)", "Camarón Esqueleto (Caprellidae)", "Cangrejo Araña Gigante Japonés (Macrocheira kaempferi - Rango Profundo)", "Langosta de las Profundidades (Nephropidae)", "Cangrejo Real Rojo (Paralithodes camtschaticus - Rango Profundo)", "Araña de Mar (Pycnogonida)", "Camarón Ciego de Fosas (Alvinocarididae)", "Ostrácodos Bioluminiscentes (Ostracoda)", "Cangrejo Decorador Abisal", "Gamba Sergestid (Sergestidae)", "Eufáusidos / Krill de Profundidad (Euphausiacea)", "Remipedia (Clase de crustáceos cavernícolas)",
            // Otros Invertebrados Notables
            "Pepino de Mar / Cerdo de Mar (Scotoplanes)", "Ofiura / Estrella Serpiente (Ophiuroidea)", "Estrella Cesta (Gorgonocephalidae)", "Corales de Aguas Frías (Lophelia pertusa)", "Corales Negros (Antipatharia)", "Corales Bambú (Isididae)", "Esponjas de Cristal (Hexactinellida)", "Ctenóforos / Medusas de Peine (Ctenophora)", "Sifonóforos Gigantes (Praya dubia, Erenna)", "Gusanos Tubícolas Gigantes (Riftia pachyptila)", "Gusano de Pompeya (Alvinella pompejana)", "Gusano Zombie / Comehuesos (Osedax)", "Anémonas de Profundidad (Actiniaria)", "Babosas de Mar Abisales (Nudibranchia)", "Pluma de Mar (Pennatulacea)", "Briozoos de Profundidad (Bryozoa)", "Foraminíferos (Organismos unicelulares con concha)", "Radiolarios (Protozoos con esqueleto silíceo)", "Xenofióforos (Protozoos gigantes)",
            // Mamíferos Marinos (Buceadores Profundos)
            "Cachalote (Physeter macrocephalus)", "Zifio de Cuvier (Ziphius cavirostris)", "Elefante Marino del Sur (Mirounga leonina)", "Ballena Piloto / Calderón (Globicephala)", "Delfín de Risso (Grampus griseus)",
            // Fenómenos y Ecosistemas Abisales
            "Bioluminiscencia en el Océano Profundo", "Quimiosíntesis como Base de Vida", "Fuentes Hidrotermales / Chimeneas Negras", "Filtraciones Frías / Cold Seeps", "Llanuras Abisales: Características", "Zona Hadal: Las Fosas Oceánicas", "Nieve Marina: Fuente de Alimento", "Capa Profunda de Dispersión Sonora (DSL)", "Adaptaciones a la Alta Presión", "Gigantismo Abisal", "Impacto de la Minería Submarina", "Ecosistemas de Caída de Ballenas (Whale Falls)", "Zonas de Mínimo Oxígeno (OMZ)", "Montes Submarinos (Seamounts) como Oasis", "Cañones Submarinos: Hábitats Complejos", "Circulación Termohalina y Océano Profundo", "Acidificación del Océano y sus Efectos Profundos", "Microplásticos en el Océano Profundo", "Sonidos Misteriosos del Abismo (Bloop, etc.)", "Exploración Robótica Submarina (ROVs, AUVs)",
            // Más Especies Específicas y Conceptos
            "Pez Víbora del Pacífico (Chauliodus macouni)", "Pez Dragón sin Escamas (Melanostomias)", "Barreleye / Pez de Cabeza Transparente (Macropinna microstoma)", "Pez Hacha Plateado Gigante (Argyropelecus gigas)", "Engullidor Negro con Estómago Expandible", "Gusano Tubícola de Tevnia", "Gusano Tubícola de Lamelibrachia", "Mejillones de Fuentes Hidrotermales (Bathymodiolus)", "Almejas de Filtraciones Frías (Calyptogena)", "Camarón Rimicaris (Fuentes Hidrotermales)", "Pulpo de Anillos Azules (Hapalochlaena - aunque más somero, icónico)", "Calamar Dána (Taningia danae - bioluminiscente)", "Medusa Casco (Periphylla periphylla)", "Medusa Atolla (Atolla wyvillei - alarma bioluminiscente)", "Tiburón Duende (Mitsukurina owstoni)", "Tiburón de Groenlandia (Somniosus microcephalus)", "Quimera / Tiburón Fantasma (Chimaeriformes)", "Pez Caracol de Fosa (Varias especies de Liparidae)", "Cefalópodo Bioluminiscente Watasenia scintillans", "Adaptaciones Oculares en la Oscuridad", "Estrategias de Camuflaje Abisal", "Mecanismos de Bioluminiscencia (Luciferina/Luciferasa)", "Simbiosis Quimiosintética", "Metabolismo Lento en el Frío Profundo", "Reproducción en Ambientes Extremos", "Larvas Pelágicas y Dispersión Profunda", "Preservación de Especímenes Abisales", "Historia de la Exploración del Océano Profundo", "El Proyecto DEEPSEA CHALLENGE (James Cameron)", "Observatorios Submarinos Cabledos", "Potencial Farmacológico de Organismos Abisales", "Criaturas Míticas Inspiradas en el Mar Profundo", "Conservación de Ecosistemas Abisales", "El Futuro de la Investigación Oceanográfica Profunda",
             // ... (Esta lista ya es bastante extensa, el botón ayudará a diversificar más)
        ];
        const deepSeaThemes = [ // Temas para generar más títulos
            "peces abisales", "cefalópodos de profundidad", "crustáceos de fosas", "invertebrados bioluminiscentes", "fuentes hidrotermales", "filtraciones frías", "zona hadal", "adaptaciones a la presión", "gigantismo abisal", "bioluminiscencia", "quimiosíntesis", "nieve marina", "mamíferos buceadores profundos", "corales de agua fría", "esponjas de cristal", "ctenóforos", "sifonóforos", "gusanos tubícolas", "ecosistemas de caída de ballenas", "exploración submarina", "mitos marinos profundos", "conservación abisal", "impacto humano en el abismo"
        ];
        const textApiConfig = { // Descripción principal
            model: "mistral",
            systemPrompt: "Eres un biólogo marino y oceanógrafo experto en ecosistemas de aguas profundas. Describe la criatura o fenómeno abisal especificado con gran detalle. Cubre: Taxonomía (si aplica), descripción física (tamaño, apariencia, características únicas), hábitat (profundidad, ubicación), dieta, comportamiento, adaptaciones conocidas (bioluminiscencia, resistencia a la presión, estrategias de alimentación), reproducción (si se conoce), estado de conservación (si aplica) y datos curiosos. Usa lenguaje científico preciso pero accesible. Objetivo: visión general completa de 1200-1300 palabras. Céntrate únicamente en el siguiente ítem:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Chat contextual
            model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúa como asistente de biología marina especializado únicamente en la criatura/fenómeno: '[CREATURE_NAME]'. Responde preguntas sobre su biología, hábitat o comportamiento basándote en información científica conocida. Sé conciso y relevante al tema específico.", // Placeholder
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // Generar más títulos
            model: "mistral",
            // *** MODIFIED PROMPT TO REQUEST 40 TITLES ***
            systemPrompt: "Eres un generador de temas fascinantes sobre el océano profundo. Crea exactamente 40 nombres únicos de criaturas abisales (comunes o científicas), fenómenos específicos de aguas profundas, o conceptos relacionados con zonas abisales/hadales. Devuelve *solo* la lista de nombres/temas, uno por línea. Sin números, introducciones ni resúmenes.",
            timeoutSeconds: 60 // Aumentar un poco el timeout por si tarda más en generar 40
        };

        // ========== DOM ELEMENTS ==========
        // (Sin cambios respecto a la versión anterior, solo verificar que todos existen)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentCreatureTitle = null; // Renombrado para claridad

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             // *** USA EL SYSTEM PROMPT DINÁMICO PARA CHAT ***
             let systemPromptToUse = config.systemPrompt;
             if (isChat && currentCreatureTitle) {
                 systemPromptToUse = chatApiConfig.systemPrompt.replace('[CREATURE_NAME]', currentCreatureTitle);
             }
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros sistemas están experimentando alta demanda en este momento. Por favor, inténtalo de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o inténtalo más tarde.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar los sistemas de IA.");
             }
        }
        // Wrappers para claridad
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentCreatureTitle) throw new Error("Error interno: No se ha establecido el contexto del espécimen para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        // *** MODIFIED fetchGeneratedTitles to handle 40 ***
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(deepSeaThemes) || "criaturas abisales generales";
             // Prompt ya está en la config para 40
             console.log("Generating 40 titles with theme:", randomTheme);
             // Usa la config actualizada que pide 40 títulos
             return fetchTextFromApi(`Genera 40 ítems sobre ${randomTheme}`, titleGenerationConfig, false)
                  .then(text => {
                      const titles = text.split('\n')
                                         .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                         .filter(line => line.length > 3 && line.length < 150);
                      if (titles.length < 10) { // Ajustar umbral si es necesario
                          throw new Error("La IA no generó suficientes ideas de exploración.");
                      }
                      // Devolver hasta 40, pero puede que la API devuelva menos
                      console.log(`Generated ${titles.length} new titles.`);
                      return titles.slice(0, 40);
                  });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "mysterious deep sea creature";
             // Prompt enfocado en el ambiente oscuro y posible bioluminiscencia
             const enhancedPrompt = `Deep sea environment photograph capturing the essence of '${safePromptText}'. Dark, atmospheric, abyssal zone, potential bioluminescence if applicable, isolated subject. Avoid text, labels. Realistic but mysterious.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "shallow water, surface, bright sunlight, coral reef, diver, submersible, text, words, labels, diagram, chart, multiple animals, cartoon, drawing, illustration, blurry, low quality, watermark, signature";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (exactamente igual que antes) ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, ' ');
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (sin cambios funcionales, solo contexto)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentCreatureTitle = null; // Reset contexto del chat
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (exactamente igual que antes) ... */
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
         }
        function hideFullscreenImage() { /* ... (exactamente igual que antes) ... */
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
         }

        // ========== CHAT FUNCTIONS ========== (sin cambios funcionales, solo contexto)
        function addChatMessage(message, sender) { /* ... (exactamente igual que antes) ... */
             const msgDiv = document.createElement('div');
             msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
             message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
             msgDiv.innerHTML = message;
             chatHistory.appendChild(msgDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        function addChatError(message) { /* ... (exactamente igual que antes) ... */
            const errorDiv = document.createElement('div');
            errorDiv.classList.add('chat-error');
            errorDiv.textContent = message;
            chatHistory.appendChild(errorDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        async function handleSendMessage() { /* ... (exactamente igual que antes, usa fetchChatResponse) ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentCreatureTitle) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
         }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { // Ordenar alfabéticamente
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» No hay registros en la base de datos abisal «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { // Añadir sin duplicados
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => {
                 if (!existingTitles.has(title)) {
                     titleListContainer.appendChild(createTitleItem(title));
                     addedCount++;
                 }
             });
             console.log(`Appended ${addedCount} new unique titles.`);
             filterTitles(searchInput.value); // Re-aplicar filtro
         }

        // *** MODIFIED: handleTitleClick (Contexto renombrado, resto igual) ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentCreatureTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-water placeholder-icon"></i> <!-- Icono temático -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando imagen del espécimen...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => { showFullscreenImage(imgElement.src); });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Fallo al visualizar.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar los datos del espécimen.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles (para 40 títulos) ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Sondeando el Abismo...';
             try {
                 // fetchGeneratedTitles ya está configurado para intentar obtener 40
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudo obtener más información de las profundidades en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al explorar más profundo: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Actualizar texto del botón para reflejar que pide 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Profundo (40)';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Ocultar si hay resultados O si la lista está vacía inicialmente
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Verificación de elementos esenciales (sin cambios)
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential DOM elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">++ FALLO CATASTRÓFICO DEL SISTEMA ++ Componentes de interfaz no encontrados ++</p>';
                return;
             }
            // Listeners (sin cambios funcionales)
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>