<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curiosidades del Baloncesto - Archivo Interactivo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Deportivas/Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Curiosidades del Baloncesto --- */
        :root {
            --color-primary: #F56600; /* Naranja Baloncesto */
            --color-secondary: #000000; /* Negro */
            --color-tertiary: #FFFFFF; /* Blanco */
            --color-background: #f8f9fa; /* Gris muy claro / Blanco */
            --color-text: #212529; /* Negro/Gris oscuro */
            --color-text-muted: #6c757d; /* Gris medio */
            --color-modal-bg: #ffffff; /* Blanco puro */
            --color-border: #dee2e6; /* Borde gris claro */
            --color-error-bg: #f8d7da; /* Fondo error rojo claro */
            --color-error-text: #721c24; /* Texto error oscuro */
            --color-error-border: #f5c6cb; /* Borde error rojo claro */

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Oswald', sans-serif; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-secondary); font-weight: 700; }
        h2.section-title { color: var(--color-primary); border-bottom: 3px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; text-transform: none; /* Título del modal normal */ }
        .navbar { background-color: var(--color-secondary); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 2px solid var(--color-primary); }
        .navbar .logo { color: var(--color-primary); }
        .navbar span { color: var(--color-tertiary); font-family: 'Poppins'; text-transform: none; letter-spacing: 0;}

        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-tertiary); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Poppins'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(245, 102, 0, 0.25); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.1rem 0.9rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Poppins'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #fff8f0; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-tertiary); padding: 0.75rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Oswald', sans-serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-transform: uppercase; }
        #generate-more-btn:hover:not(:disabled) { background-color: #d95800; /* Naranja más oscuro */ box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: var(--color-text-muted); color: #e9ecef; cursor: not-allowed; opacity: 0.8; }

        #story-modal { /* Mismos estilos generales */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(33, 37, 41, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { /* Fondo blanco */
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            border-top: 5px solid var(--color-primary);
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e9ecef; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-tertiary); transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; font-family: 'Poppins'; /* Usar Poppins para título específico */ font-weight: 600; color: var(--color-secondary);}

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) #e9ecef;
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: #e9ecef; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid #dee2e6; }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { font-style: italic; color: var(--color-secondary); }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Oswald', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 400; text-transform: uppercase; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-primary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid #e9ecef; width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f8f9fa; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: #adb5bd #f8f9fa;
        }
         #chat-history::-webkit-scrollbar { width: 6px; }
         #chat-history::-webkit-scrollbar-track { background: #f8f9fa; border-radius: var(--border-radius); }
         #chat-history::-webkit-scrollbar-thumb { background-color: #adb5bd; border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem;}
        .user-message { background-color: var(--color-primary); color: var(--color-tertiary); margin-left: auto; text-align: left; border-bottom-right-radius: 0;} /* User bubble style */
        .ai-message { background-color: #e9ecef; color: var(--color-text); margin-right: auto; text-align: left; border-bottom-left-radius: 0;} /* AI bubble style */
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: var(--color-tertiary); color: var(--color-text); border-radius: var(--border-radius); font-family: 'Poppins'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(245, 102, 0, 0.2); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-secondary); color: var(--color-tertiary); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #343a40; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { /* Adaptar colores */ text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid #e9ecef; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-secondary); font-size: 1.3rem; font-family: 'Oswald'; text-transform: uppercase; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Poppins'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { /* Adaptar color fondo */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(33, 37, 41, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { /* Adaptar colores */ position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-tertiary); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-basketball-ball mr-3 text-orange-500"></i>
                     Curiosidades del Baloncesto
                 </h1>
             </div>
             <span class="text-sm text-gray-300 font-sans tracking-normal">» El Archivo Interactivo del Basket «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-4">Descubre el Lado Oculto del Baloncesto</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora hechos sorprendentes, récords increíbles y la rica historia detrás del juego que amas.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar curiosidad, jugador, récord...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-archive text-gray-700 mr-2"></i> <!-- Icono archivo -->
                 Archivo de Datos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando la base de datos histórica...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No se encontraron datos para esa consulta.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Buscar Más Datos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Buscando datos en los archivos...</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2> <!-- Título se llena con JS -->
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder added via JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando al experto...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta curiosidad...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-800 text-gray-400 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA basada en datos históricos y récords del baloncesto.</p>
              <p class="mt-1">Los datos y récords pueden cambiar, verifica fuentes oficiales para información actualizada.</p>
              <p class="mt-2">© 2024 Archivo Interactivo del Basket</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Historia y Orígenes
            "¿Quién inventó el baloncesto y por qué?", "Las 13 reglas originales de James Naismith", "El primer partido de baloncesto de la historia", "Los 'Peach Baskets' originales", "Origen del término 'Dribble'", "Primeras ligas profesionales (NBL, BAA)", "La fusión BAA-NBL que creó la NBA", "La introducción del reloj de posesión de 24 segundos", "La creación de la línea de 3 puntos (ABA y NBA)", "El impacto de la ABA en la NBA moderna", "Historia del baloncesto femenino antes de la WNBA", "El baloncesto en los Juegos Olímpicos: Inicios", "Evolución de la pelota de baloncesto", "Primeras estrellas del baloncesto (George Mikan)", "El nacimiento de los Harlem Globetrotters", "La regla de los 3 segundos en la zona", "El desarrollo del 'Goaltending'", "La regla de los 5 segundos (saque, presión)", "Historia del Draft de la NBA", "Cómo se determinaba el 'campo atrás' originalmente",
            // Reglas Curiosas y Obsoletas
            "¿Se podía mover el balón sin botar al principio?", "La regla del 'salto entre dos' después de cada canasta", "Número de jugadores original por equipo", "Prohibición inicial del mate (NCAA)", "Reglas experimentales que no prosperaron en la NBA", "Diferencias clave entre reglas FIBA y NBA", "La regla del 'paso cero' (Zero Step)", "Infracciones poco conocidas (Interferencia ofensiva)", "El tiro libre bajo mano ('Granny Shot')", "Reglamento sobre uniformes y accesorios", "El concepto de 'Ventaja' arbitral", "¿Cuándo se introdujo el 'Foul Flagrante'?", "Reglas sobre el comportamiento antideportivo", "La 'Hack-a-Shaq' y cambios de reglas", "Tiempo muerto de 20 segundos vs. Tiempo muerto completo",
            // Récords Individuales NBA (Puntos)
            "Los 100 puntos de Wilt Chamberlain en un partido", "Más puntos en una temporada (Wilt Chamberlain)", "Máximo anotador de la historia de la NBA (LeBron James)", "Más puntos en un cuarto (Klay Thompson)", "Más puntos en una mitad (Wilt Chamberlain)", "Jugador más joven en anotar 10,000 puntos", "Jugador más viejo en anotar 40+ puntos", "Mejor promedio de puntos en una carrera (Michael Jordan)", "Más partidos consecutivos anotando (LeBron James)", "Más temporadas liderando la liga en puntos (Michael Jordan)", "Récord de puntos en un partido de Playoffs (Michael Jordan)", "Récord de puntos en unas Finales de la NBA (Elgin Baylor)", "Jugador con más partidos de 50+ puntos", "Jugador con más partidos de 60+ puntos", "Anotador más eficiente (basado en True Shooting %)",
            // Récords Individuales NBA (Otros Stats)
            "Máximo reboteador de la historia (Wilt Chamberlain)", "Más rebotes en un partido (Wilt Chamberlain)", "Máximo asistente de la historia (John Stockton)", "Más asistencias en un partido (Scott Skiles)", "Máximo ladrón de balones de la historia (John Stockton)", "Más robos en un partido (Larry Kenon/Kendall Gill)", "Máximo taponador de la historia (Hakeem Olajuwon)", "Más tapones en un partido (Elmore Smith)", "Líder histórico en triples-dobles (Russell Westbrook)", "Más triples-dobles en una temporada (Russell Westbrook)", "El 'Cuádruple-Doble': Jugadores que lo lograron", "Récord de minutos jugados en un partido", "Más tiros libres anotados/intentados (Karl Malone)", "Mejor porcentaje de tiros libres en una temporada (José Calderón)", "Más triples anotados en la historia (Stephen Curry)", "Más triples en un partido (Klay Thompson)", "Mejor porcentaje de triples en una temporada (Kyle Korver)",
            // Récords de Equipo NBA
            "Equipo con más campeonatos NBA (Celtics/Lakers)", "Equipo con más victorias en una temporada regular (Warriors 73-9)", "La racha de 33 victorias consecutivas de los Lakers (1971-72)", "Equipo con más puntos en un partido", "Equipo con menos puntos en un partido (era del reloj de posesión)", "Mayor remontada en la historia de la NBA", "Peor récord en una temporada NBA (Bobcats)", "Dinastías más largas en la NBA (Celtics '60s, Bulls '90s)", "Equipos invictos en casa en una temporada", "Partido con más prórrogas en la historia",
            // Jugadores Legendarios (Curiosidades)
            "Michael Jordan y su breve carrera en el béisbol", "Bill Russell: Más anillos que dedos", "El Skyhook 'imparable' de Kareem Abdul-Jabbar", "Magic Johnson: ¿Base o Pívot en las Finales de 1980?", "Larry Bird: El 'Trash Talker' legendario", "Wilt Chamberlain: ¿Verdad o mito sobre sus 20,000 mujeres?", "Shaquille O'Neal y los tableros rotos", "Kobe Bryant: La mentalidad 'Mamba'", "Tim Duncan: 'The Big Fundamental'", "Hakeem Olajuwon y el 'Dream Shake'", "Oscar Robertson: El rey original del Triple-Doble", "Jerry West: El logo de la NBA", "La rivalidad Magic vs Bird que salvó a la NBA", "Dennis Rodman: El excéntrico rey del rebote", "Allen Iverson: El impacto cultural y el 'crossover'", "Pete Maravich: 'Pistol Pete', el mago del balón", "George Gervin: 'The Iceman' y el 'finger roll'", "La historia de Drazen Petrovic", "Reggie Miller vs los Knicks", "Charles Barkley: El 'Gordo' que dominaba los tableros",
            // Jugadores Actuales/Recientes (Curiosidades)
            "Stephen Curry: Revolucionando el juego con el triple", "LeBron James: Longevidad y récords imposibles", "Kevin Durant: El 'francotirador' imparable", "Giannis Antetokounmpo: De vender en las calles a MVP", "Nikola Jokic: El pívot que juega como base", "Luka Doncic: El prodigio esloveno", "Victor Wembanyama: El 'unicornio' generacional", "El impacto del 'Load Management'", "Jugadores con contratos 'Supermax'", "La evolución del rol del pívot moderno", "Jugadores internacionales dominando la NBA", "La influencia de las redes sociales en los jugadores", "El fenómeno 'One-and-Done' del College a la NBA",
            // Equipos y Dinastías
            "Los 'Showtime' Lakers de los 80", "Los Celtics de los 60: La dinastía imbatible", "Los 'Bad Boys' Pistons", "Los Bulls de Jordan: Dos 'Three-peats'", "Los Lakers de Shaq y Kobe", "Los Spurs de Duncan, Parker y Ginóbili", "Los 'Heatles': LeBron, Wade y Bosh en Miami", "Los Warriors de Curry, Klay y Draymond", "La maldición deportiva de Cleveland (rota por LeBron)", "Equipos de expansión y sus dificultades iniciales", "El traslado de los Sonics a Oklahoma City", "Equipos que nunca han ganado un campeonato",
            // Baloncesto Internacional y Olímpico
            "El 'Dream Team' de Barcelona 1992", "El 'Redeem Team' de Beijing 2008", "La medalla de oro de Argentina en Atenas 2004", "El dominio histórico de Estados Unidos en Olimpiadas", "Jugadores internacionales que fueron #1 del Draft", "Historia de la Euroliga", "El Mundial FIBA: Orígenes y campeones", "Grandes potencias del baloncesto FIBA (España, Yugoslavia, etc.)", "Reglas FIBA vs NBA: Diferencias en la cancha", "El impacto global de la NBA",
            // WNBA
            "La fundación de la WNBA en 1996", "Primeras estrellas de la WNBA (Sheryl Swoopes, Cynthia Cooper)", "Diana Taurasi: La 'White Mamba'", "Sue Bird: Longevidad y liderazgo", "Breanna Stewart: Dominio y MVP's", "Candace Parker: Versatilidad y anillos", "Récords históricos de la WNBA (puntos, asistencias, etc.)", "El crecimiento y desafíos de la WNBA", "Equipos dominantes en la historia de la WNBA",
            // Baloncesto Universitario (NCAA)
            "El fenómeno 'March Madness'", "La dinastía de UCLA con John Wooden", "Rivalidades históricas (Duke vs North Carolina)", "Las mayores 'Cinderella stories' del torneo NCAA", "El primer torneo de la NCAA en 1939", "Jugadores universitarios legendarios (Lew Alcindor, Bill Walton)", "El impacto del 'One-and-Done'", "Récords del torneo de la NCAA",
            // Equipamiento y Tecnología
            "La evolución de las zapatillas de baloncesto", "El fenómeno 'Air Jordan'", "Tecnología en los balones modernos (materiales, agarre)", "Tipos de parqué y su impacto", "El uso del 'Instant Replay' en arbitraje", "Tecnología de seguimiento de jugadores (Stats avanzadas)", "Aros retráctiles y tableros de plexiglás",
            // Momentos Icónicos
            "El 'Flu Game' de Michael Jordan", "El tiro de Ray Allen en las Finales 2013", "El 'block' de LeBron a Iguodala en las Finales 2016", "El 'Memorial Day Miracle' de Sean Elliott", "El 'Shrug' de Michael Jordan", "La canasta ganadora de Magic Johnson vs Celtics (1987)", "El mate de Vince Carter sobre Frederic Weis (Olimpiadas 2000)", "El 'Malice at the Palace'", "La retirada (y regreso) de Michael Jordan", "El anuncio de HIV de Magic Johnson",
            // Cultura y Terminología
            "Origen del término 'Slam Dunk'", "Origen del 'Alley-Oop'", "Origen del 'Pick and Roll'", "La influencia del baloncesto en el hip-hop", "Películas icónicas de baloncesto ('Space Jam', 'Hoosiers')", "El lenguaje del baloncesto ('buzzer beater', 'fast break')", "Moda y baloncesto: De los shorts cortos a los baggy", "El impacto global y cultural del baloncesto", "El 'Draft Combine' y sus pruebas curiosas", "Apodos famosos de jugadores",
            // Añadir más...
             "¿Por qué los aros miden 10 pies (3.05 metros)?", "La historia detrás del número 23 de Michael Jordan", "El significado del número 6 de Bill Russell (retirado en toda la NBA)", "Jugadores que han ganado MVP, DPOY y Anillo", "Entrenadores con más victorias en la NBA (Gregg Popovich)", "Phil Jackson y el 'Triángulo Ofensivo'", "La influencia de Red Auerbach en los Celtics", "Jugadores más altos y más bajos de la historia NBA", "El jugador con el salto vertical más alto registrado", "¿Es posible anotar 1 punto en baloncesto?", "El concepto de 'Basketball IQ'", "La importancia del 'spacing' en el baloncesto moderno", "Análisis del 'Clutch Time'", "Estadísticas avanzadas (PER, Win Shares, Box Plus/Minus)", "El rol del 'sexto hombre'", "La evolución de las posiciones (Positional-less basketball)", "El mate más lejano registrado", "Tiros libres con los ojos cerrados (¿mito o realidad?)", "El jugador que fue drafteado pero nunca jugó en la NBA", "La historia de los logos de los equipos NBA", "Canciones famosas sobre baloncesto", "Videojuegos de baloncesto icónicos (NBA Jam, NBA 2K)", "Coleccionismo de tarjetas de baloncesto", "El baloncesto en silla de ruedas", "Reglas del 3x3 (baloncesto olímpico)", "Mayor diferencia de puntos en un partido NBA", "Jugador con más faltas técnicas en una temporada", "La primera mujer en jugar en una liga profesional masculina (brevemente)", "El 'Basketball Hall of Fame' en Springfield", "Curiosidades sobre la fabricación de un balón oficial", "Récords de asistencia a partidos de baloncesto"
        ];
        const basketballThemes = [
            "reglas del baloncesto", "historia de la NBA", "récords individuales NBA", "récords de equipo NBA",
            "jugadores legendarios", "estrellas actuales NBA", "equipos históricos", "dinastías NBA",
            "baloncesto internacional FIBA", "baloncesto olímpico", "WNBA", "NCAA March Madness",
            "equipamiento y tecnología del baloncesto", "momentos icónicos NBA", "cultura del baloncesto",
            "terminología del baloncesto", "James Naismith", "Michael Jordan", "LeBron James", "Wilt Chamberlain"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un historiador deportivo y enciclopedia andante del baloncesto, especializado en curiosidades, récords, y la historia profunda del juego. Explica la curiosidad o tema de baloncesto indicado de forma detallada, amena y precisa. Incluye contexto histórico, datos relevantes (números, fechas, jugadores involucrados), anécdotas si las hay, y el impacto o significado de la curiosidad en el mundo del baloncesto. Utiliza un lenguaje claro y atractivo tanto para aficionados casuales como para expertos. El objetivo es una explicación completa y bien documentada de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en la siguiente curiosidad o tema:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúa como un comentarista deportivo experto y amigable, respondiendo preguntas adicionales sobre la curiosidad de baloncesto específica que se está mostrando. Puedes dar más detalles, aclarar dudas, comparar con otras situaciones o jugadores, u ofrecer tu opinión informada. Sé conversador y mantente enfocado en la curiosidad principal.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una sección de trivia ('¿Sabías qué...?') sobre baloncesto. Genera exactamente 15 preguntas intrigantes, hechos poco conocidos o temas curiosos sobre baloncesto (NBA, FIBA, historia, reglas, jugadores, récords, etc.), adecuados para una explicación detallada. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        // ... (resto de elementos DOM igual que antes)
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            // *** USA EL SYSTEM PROMPT DINÁMICO PARA CHAT ***
            const systemPromptToUse = isChat && currentTopicTitle
                ? `Eres un comentarista deportivo experto y amigable, respondiendo preguntas adicionales sobre la curiosidad de baloncesto específica '${currentTopicTitle}'. Puedes dar más detalles, aclarar dudas, comparar con otras situaciones o jugadores, u ofrecer tu opinión informada. Sé conversador y mantente enfocado en la curiosidad principal.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, intenta en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }
        async function fetchExplanationText(topicTitle) { // Wrapper
            return fetchTextFromApi(topicTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) { // Wrapper
            if (!currentTopicTitle) throw new Error("Error interno: Contexto del chat no establecido.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() { // Wrapper
            const randomTheme = getRandomElement(basketballThemes) || "curiosidades del baloncesto";
            const specificPrompt = `Genera 15 preguntas o temas curiosos sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                .then(text => {
                    const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150); // Ajustar longitud mínima si es necesario
                    if (titles.length < 5) throw new Error("La IA no generó suficientes ideas.");
                    return titles.slice(0, 15);
                });
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Adaptado para baloncesto
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "basketball action shot";
            // Prompt enfocado en la temática
            const enhancedPrompt = `Conceptual image related to basketball curiosity: '${safePromptText}'. Focus on capturing the essence: action shot, historical moment depiction, court detail, equipment evolution, abstract representation of a record or rule. Dynamic, vibrant style. Avoid text, labels, specific modern team logos unless essential (e.g. historical context). Artistic interpretation.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, generic illustration, blurry, low quality";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (Sin cambios)
        function formatExplanationText(rawText) { /* ... (igual que antes) ... */
            if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted;
         }

        // ========== MODAL, FULLSCREEN, CHAT FUNCTIONS ========== (Sin cambios lógicos, solo check de IDs y texto)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
        }
        function showFullscreenImage(imgSrc) { /* ... (igual que antes) ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... (igual que antes) ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }
        function addChatMessage(message, sender) { /* ... (igual que antes) ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... (igual que antes) ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... (igual que antes) ... */
            const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); }
        }

        // ========== UI & EVENT HANDLERS ========== (Sin cambios lógicos)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar alfabéticamente puede ser útil para listas largas
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">No hay curiosidades disponibles.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             const addedTitles = [];
             newTitles.forEach(title => { if (!existingTitles.has(title)) { addedTitles.push(createTitleItem(title)); } });
             // Añadir ordenados al final o intercalar alfabéticamente podría ser complejo, por ahora solo añadimos al final
             addedTitles.sort((a, b) => a.dataset.title.localeCompare(b.dataset.title, 'es', { sensitivity: 'base' }))
                       .forEach(item => titleListContainer.appendChild(item));
             filterTitles(searchInput.value); // Re-aplicar filtro
         }
        async function handleTitleClick(title) { // Lógica central (sin cambios funcionales mayores)
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // SET CHAT CONTEXT
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset scroll
                console.log("Scroll set to 0 after content visible");

                // Imagen Placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando imagen...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Imagen Element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración sobre ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al cargar imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar datos."; // User-friendly msg
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                // Opcional: Ocultar chat si falla la carga principal
                // chatSection.classList.add('content-hidden');
            }
        }
        async function handleGenerateMoreTitles() { // Lógica sin cambios
             if (!generateMoreBtn) return;
             const btnIcon = generateMoreBtn.querySelector('i');
             generateMoreBtn.disabled = true;
             if(btnIcon) btnIcon.classList.remove('hidden');
             generateMoreBtn.childNodes[generateMoreBtn.childNodes.length-1].nodeValue = " Buscando..."; // Cambia texto
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más datos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar datos: ${error.message}`); // User-friendly
             } finally {
                 generateMoreBtn.disabled = false;
                if(btnIcon) btnIcon.classList.add('hidden');
                 generateMoreBtn.childNodes[generateMoreBtn.childNodes.length-1].nodeValue = " Buscar Más Datos"; // Restaura texto
             }
         }
        function filterTitles(searchTerm) { // Lógica sin cambios, pero normalizar es clave
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (Sin cambios lógicos)
        function initApp() {
             // Check essential elements
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) { console.error("Initialization failed: Missing essential elements."); document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error: Fallo al cargar componentes de la interfaz.</p>'; return; }

             // Event listeners
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Initial display
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>