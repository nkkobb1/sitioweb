<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conceptos de Química - Nivel Medio</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Limpias y Profesionales -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Química --- */
        :root {
            --color-primary: #2563eb; /* Azul Primario (Confianza, Ciencia) */
            --color-secondary: #10b981; /* Verde Esmeralda (Crecimiento, Orgánico) */
            --color-tertiary: #f59e0b; /* Ámbar/Naranja (Energía, Precaución) */
            --color-background: #f8fafc; /* Blanco Hueso / Gris Muy Claro */
            --color-text: #1f2937; /* Gris Muy Oscuro */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro */
            --color-border: #e5e7eb; /* Borde Gris Claro */
            --color-error-bg: #fef2f2; /* Fondo error rojo muy claro */
            --color-error-text: #b91c1c; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px; /* Bordes redondeados suaves */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700;}
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Align left for concepts */ font-weight: 500; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Roboto'; font-size: 0.95rem; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #eff6ff; /* Azul muy claro hover */ }
        .title-item i { margin-right: 0.6rem; color: var(--color-secondary); /* Icono verde */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1d4ed8; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Suficiente para contenido y chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e5e7eb; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; } /* Énfasis verde */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 700; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); } /* Títulos H3 verdes */
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos para fórmulas simples (manejar sub/superíndices) */
        #modal-content sub, #modal-content sup { font-size: 0.75em; line-height: 0; position: relative; vertical-align: baseline; }
        #modal-content sub { bottom: -0.25em; }
        #modal-content sup { top: -0.5em; }
        #modal-content .formula { font-family: 'Courier New', Courier, monospace; background-color: #f3f4f6; padding: 0.5em 1em; border-radius: 4px; margin: 1em 0; display: block; text-align: center; border: 1px solid var(--color-border); }

        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(209, 213, 219, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; } /* Ajustar altura si es necesario */
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; font-weight: 400;}
        .ai-message { background-color: #e5e7eb; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.3rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #1d4ed8; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { /* Loading principal */ text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 500; color: var(--color-text); font-size: 1.25rem; font-family: 'Roboto'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.95); /* Gris oscuro semi-transparente */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-modal-bg); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: white; color: var(--color-primary); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-atom mr-2 text-blue-500"></i> <!-- Icono atomo -->
                     Química Interactiva
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">Conceptos Nivel Medio</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Explora los Fundamentos de la Química</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Selecciona un concepto o utiliza el buscador para profundizar en temas clave de la química de nivel intermedio.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar concepto químico (ej: Entalpía, VSEPR)...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-600 mr-2"></i>
                 Índice de Conceptos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando conceptos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No se encontraron conceptos para tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Conceptos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Cargando explicación...</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image placeholder/image appended here by JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages -->
                         <div class="ai-message" style="font-style: italic; font-size: 0.9em; text-align: center; background-color: transparent; color: var(--color-text-muted);">Pregúntame algo sobre este concepto...</div>
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Pensando...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Escribe tu pregunta aquí...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA con fines educativos. La precisión debe ser verificada.</p>
              <p class="mt-1">Consulta siempre tus libros de texto y fuentes académicas.</p>
              <p class="mt-2">© 2025 Química Interactiva</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Atomic Structure & Periodicity (Intermediate)
            "Modelo Atómico de Bohr (Repaso y Limitaciones)", "Modelo Cuántico del Átomo (Introducción)", "Números Cuánticos (n, l, ml, ms)", "Orbitales Atómicos (s, p, d, f): Formas y Orientaciones", "Configuración Electrónica (Principio de Aufbau, Hund, Pauli)", "Configuración Electrónica de Iones", "Electrones de Valencia", "Carga Nuclear Efectiva (Zeff)", "Radio Atómico y Tendencias Periódicas", "Radio Iónico y Tendencias Periódicas", "Energía de Ionización (Primera, Segunda, etc.) y Tendencias", "Afinidad Electrónica y Tendencias Periódicas", "Electronegatividad (Escala de Pauling) y Tendencias", "Propiedades Periódicas de los Elementos (Metales, No Metales, Metaloides)", "Paramagnetismo y Diamagnetismo", "Isótopos (Recordatorio)", "Masa Atómica Promedio (Cálculo)",
            // Chemical Bonding (Intermediate)
            "Enlace Iónico (Formación, Energía Reticular - Concepto)", "Enlace Covalente (Simple, Doble, Triple)", "Estructuras de Lewis (Moléculas y Iones Poliatómicos)", "Regla del Octeto y Excepciones (Incompleto, Expandido, Radicales Libres)", "Carga Formal (Cálculo y Aplicación)", "Resonancia (Estructuras de Resonancia, Híbrido)", "Longitud y Energía de Enlace", "Polaridad de Enlace (Momento Dipolar de Enlace)", "Teoría de Repulsión de Pares de Electrones de Valencia (VSEPR)", "Geometría Electrónica vs Geometría Molecular", "Predicción de Geometrías Moleculares (Lineal, Trigonal Plana, Tetraédrica, etc.)", "Predicción de Geometrías con Pares Libres (Angular, Piramidal Trigonal, etc.)", "Geometrías de Octetos Expandidos (Bipirámide Trigonal, Octaédrica y derivados)", "Polaridad Molecular (Moléculas Polares y No Polares)", "Teoría del Enlace de Valencia (Solapamiento de Orbitales)", "Hibridación de Orbitales Atómicos (sp, sp2, sp3)", "Hibridación en Octetos Expandidos (sp3d, sp3d2)", "Enlaces Sigma (σ) y Pi (π)", "Teoría de Orbitales Moleculares (Concepto Básico - Diagramas H2, O2)", "Orden de Enlace (TOM)",
            // Stoichiometry & Reactions in Solution
            "El Mol y Número de Avogadro (Repaso)", "Masa Molar (Cálculo)", "Composición Porcentual", "Fórmula Empírica y Molecular (Determinación)", "Balanceo de Ecuaciones Químicas (Método de Tanteo)", "Cálculos Estequiométricos (Mol-Mol, Masa-Masa, Mol-Masa)", "Reactivo Limitante", "Rendimiento Teórico", "Rendimiento Real y Porcentual", "Soluciones y Concentración (Molaridad)", "Preparación de Soluciones por Dilución (M1V1 = M2V2)", "Estequiometría de Reacciones en Solución", "Electrolitos Fuertes, Débiles y No Electrolitos", "Ecuaciones Iónicas Netas", "Reacciones de Precipitación (Reglas de Solubilidad)", "Reacciones Ácido-Base (Neutralización)", "Reacciones de Óxido-Reducción (Redox) - Identificación", "Asignación de Números de Oxidación", "Balanceo de Ecuaciones Redox (Método del Ion-Electrón en medio ácido/básico)",
            // Gases
            "Teoría Cinético-Molecular de los Gases", "Presión (Unidades: atm, mmHg, kPa, bar)", "Ley de Boyle (P-V)", "Ley de Charles (V-T)", "Ley de Gay-Lussac (P-T)", "Ley Combinada de los Gases", "Ley de Avogadro (V-n)", "Ley de los Gases Ideales (PV=nRT)", "Constante de los Gases Ideales (R - Valores y Unidades)", "Cálculos con la Ley del Gas Ideal (Masa Molar, Densidad)", "Estequiometría con Gases", "Ley de Dalton de las Presiones Parciales", "Fracción Molar y Presión Parcial", "Recolección de Gases sobre Agua", "Gases Reales vs Ideales (Desviaciones, Ecuación de van der Waals - Concepto)", "Velocidad Molecular (Velocidad cuadrática media)", "Difusión y Efusión (Ley de Graham)",
            // Thermochemistry
            "Energía, Calor y Trabajo (Conceptos)", "Sistema, Entorno y Universo", "Primera Ley de la Termodinámica (ΔE = q + w)", "Funciones de Estado (Energía Interna, Entalpía)", "Entalpía (H) y Cambio de Entalpía (ΔH)", "Reacciones Exotérmicas y Endotérmicas (Signo de ΔH)", "Entalpía Estándar de Reacción (ΔH°rxn)", "Calorimetría (Calor Específico, Capacidad Calorífica)", "Calorimetría a Presión Constante (Bomba Calorimétrica - Concepto)", "Ley de Hess", "Entalpía Estándar de Formación (ΔH°f)", "Cálculo de ΔH°rxn usando ΔH°f", "Entalpía de Enlace (Estimación de ΔH°rxn)", "Espontaneidad de Procesos (Introducción)",
            // Chemical Kinetics
            "Velocidad de Reacción (Definición y Medición)", "Factores que Afectan la Velocidad (Concentración, Temperatura, Superficie, Catalizador)", "Ley de Velocidad (Experimental)", "Orden de Reacción (Cero, Primero, Segundo)", "Constante de Velocidad (k) y sus Unidades", "Determinación de la Ley de Velocidad (Método de Velocidades Iniciales)", "Leyes de Velocidad Integradas (Primer y Segundo Orden)", "Vida Media (t½) de Reacciones de Primer Orden", "Vida Media de Reacciones de Segundo Orden", "Teoría de las Colisiones", "Energía de Activación (Ea)", "Complejo Activado (Estado de Transición)", "Diagramas de Energía de Reacción", "Ecuación de Arrhenius (Relación k-T)", "Mecanismos de Reacción", "Pasos Elementales y Molecularidad", "Intermediarios de Reacción", "Paso Determinante de la Velocidad", "Catálisis (Homogénea y Heterogénea)", "Enzimas como Catalizadores Biológicos",
            // Chemical Equilibrium
            "Concepto de Equilibrio Dinámico", "Constante de Equilibrio (Kc)", "Constante de Equilibrio en Fase Gaseosa (Kp)", "Relación entre Kc y Kp", "Magnitud de la Constante de Equilibrio (Significado)", "Cociente de Reacción (Q)", "Predicción de la Dirección de la Reacción (Comparando Q y K)", "Principio de Le Châtelier", "Efecto de Cambios en Concentración sobre el Equilibrio", "Efecto de Cambios en Presión/Volumen sobre el Equilibrio (Gases)", "Efecto de Cambios en Temperatura sobre el Equilibrio (ΔH y K)", "Efecto de un Catalizador sobre el Equilibrio", "Cálculos de Equilibrio (Concentraciones en equilibrio)", "Uso de la Aproximación en Cálculos de Equilibrio",
            // Acids and Bases (Intermediate)
            "Teorías Ácido-Base (Arrhenius, Brønsted-Lowry, Lewis)", "Pares Ácido-Base Conjugados", "Anfoterismo (Agua como ejemplo)", "Autoionización del Agua (Kw)", "Escala de pH y pOH (pH + pOH = 14)", "Ácidos y Bases Fuertes (Disociación Completa)", "Ácidos Débiles (Ka) y Constante de Ionización Ácida", "Bases Débiles (Kb) y Constante de Ionización Básica", "Relación entre Ka, Kb y Kw (Para pares conjugados)", "Cálculo del pH de Soluciones de Ácidos Débiles", "Cálculo del pH de Soluciones de Bases Débiles", "Porcentaje de Ionización", "Ácidos Polipróticos (Ka1, Ka2)", "Propiedades Ácido-Base de las Sales (Hidrólisis)", "pH de Soluciones Salinas", "Efecto del Ion Común", "Soluciones Amortiguadoras (Buffers)", "Cómo Funcionan los Buffers", "Ecuación de Henderson-Hasselbalch", "Capacidad Amortiguadora", "Titulaciones Ácido-Base", "Curvas de Titulación (Fuerte-Fuerte, Débil-Fuerte, Fuerte-Débil)", "Indicadores Ácido-Base", "Ácidos y Bases de Lewis (Definición y Ejemplos)",
            // Aqueous Equilibria (Solubility)
            "Equilibrio de Solubilidad", "Producto de Solubilidad (Ksp)", "Solubilidad Molar y Ksp (Cálculos)", "Predicción de Precipitación (Comparando Qsp y Ksp)", "Efecto del Ion Común sobre la Solubilidad", "Efecto del pH sobre la Solubilidad", "Formación de Iones Complejos y Solubilidad", "Constante de Formación (Kf)", "Precipitación Fraccionada",
            // Electrochemistry
            "Reacciones Redox (Repaso: Oxidación, Reducción, Agentes)", "Balanceo Redox (Método Ion-Electrón - Repaso)", "Celdas Voltaicas (Galvánicas)", "Componentes de una Celda Voltaica (Ánodo, Cátodo, Puente Salino)", "Notación de Celdas", "Potencial Estándar de Reducción (E°)", "Tabla de Potenciales Estándar de Reducción", "Potencial Estándar de Celda (E°celda = E°cátodo - E°ánodo)", "Espontaneidad de Reacciones Redox (Relación E°celda, ΔG°, K)", "Ecuación de Nernst (Condiciones No Estándar)", "Celdas de Concentración", "Baterías (Primarias y Secundarias - Ejemplos: Plomo-Ácido, Ni-Cd, Li-ion)", "Corrosión (Oxidación del Hierro)", "Prevención de la Corrosión (Protección Catódica)", "Electrólisis", "Celdas Electrolíticas", "Electrólisis del Agua", "Electrólisis de Sales Fundidas", "Electrólisis de Soluciones Acuosas (Predicción de Productos)", "Aspectos Cuantitativos de la Electrólisis (Leyes de Faraday, Coulomb, Amperio)",
            // Introduction to Organic Chemistry
            "Características del Carbono (Tetravalencia, Catenación)", "Hidrocarburos (Alcanos, Alquenos, Alquinos)", "Nomenclatura IUPAC de Alcanos (Cadenas lineales y ramificadas)", "Isómeros Estructurales (Constitucionales)", "Cicloalcanos (Nomenclatura básica)", "Nomenclatura IUPAC de Alquenos y Alquinos", "Isomería Geométrica (Cis-Trans) en Alquenos", "Hidrocarburos Aromáticos (Benceno - Estructura y Resonancia)", "Grupos Funcionales Comunes (Alcohol, Éter, Aldehído, Cetona, Ácido Carboxílico, Éster, Amina, Amida)", "Identificación de Grupos Funcionales", "Nomenclatura Básica de Compuestos con Grupos Funcionales Simples (ej: Metanol, Etanal)", "Reacciones Orgánicas Básicas (Tipos generales: Adición, Sustitución, Eliminación - Introducción)",
            // Introduction to Nuclear Chemistry
            "Nucleones (Protones y Neutrones)", "Notación Isotópica (Repaso)", "Radiactividad (Descubrimiento)", "Tipos de Decaimiento Radiactivo (Alfa α, Beta β, Gamma γ, Positrón β+, Captura Electrónica)", "Ecuaciones Nucleares (Balanceo)", "Estabilidad Nuclear (Banda de Estabilidad, Relación n/p)", "Series de Decaimiento Radiactivo", "Vida Media (Concepto y Cálculo)", "Datación Radiactiva (Carbono-14)", "Transmutación Nuclear (Reacciones Nucleares Inducidas)", "Fisión Nuclear", "Fusión Nuclear", "Energía Nuclear (E=mc²)", "Aplicaciones de la Radioactividad (Medicina, Industria)", "Efectos Biológicos de la Radiación",
            // States of Matter & Intermolecular Forces (Intermediate)
            "Fases de la Materia y Transiciones de Fase", "Diagramas de Fase (Agua, CO2)", "Punto Triple y Punto Crítico", "Fuerzas Intermoleculares (Tipos: Iónicas, Dipolo-Dipolo, Enlace de Hidrógeno, Fuerzas de Dispersión de London)", "Relación entre Fuerzas Intermoleculares y Propiedades Físicas (Punto de Ebullición, Fusión, Viscosidad, Tensión Superficial)", "Propiedades de los Líquidos (Viscosidad, Tensión Superficial, Capilaridad)", "Sólidos Cristalinos vs Amorfos", "Tipos de Sólidos Cristalinos (Iónicos, Covalentes Reticulares, Moleculares, Metálicos)", "Estructuras Cristalinas (Cúbica simple, centrada en cuerpo, centrada en caras - Concepto)", "Enlace Metálico (Mar de Electrones)",
            // Solutions (Intermediate)
            "Proceso de Disolución ('Lo semejante disuelve a lo semejante')", "Entalpía de Solución (ΔHsoln)", "Solubilidad y Factores que la Afectan (Temperatura, Presión - Ley de Henry)", "Unidades de Concentración (Molaridad - repaso, Molalidad, Porcentaje en Masa, Fracción Molar)", "Propiedades Coligativas (Concepto)", "Disminución de la Presión de Vapor (Ley de Raoult)", "Elevación del Punto de Ebullición (ΔTb = Kb*m)", "Disminución del Punto de Congelación (ΔTf = Kf*m)", "Presión Osmótica (Π = MRT)", "Factor de van't Hoff (i) para Electrolitos", "Coloides (Tipos y Propiedades - Efecto Tyndall)",
            // Basic Spectroscopy
            "Espectro Electromagnético (Relación E, ν, λ)", "Espectroscopía (Concepto General)", "Espectroscopía UV-Vis (Absorbancia, Ley de Beer-Lambert - Concepto)", "Espectroscopía Infrarroja (IR) (Identificación de Grupos Funcionales por Vibraciones)", "Espectroscopía de Resonancia Magnética Nuclear (RMN) (Concepto básico - Entornos de Protones)",
            // Coordination Chemistry Introduction
            "Compuestos de Coordinación (Definición)", "Iones Complejos", "Ligandos (Monodentados, Polidentados - Quelatos)", "Número de Coordinación", "Geometrías Comunes de Complejos (Lineal, Tetraédrica, Cuadrada Plana, Octaédrica)", "Nomenclatura Básica de Compuestos de Coordinación", "Isomería en Compuestos de Coordinación (Geométrica cis/trans, Óptica - Introducción)",
            // Basic Lab Concepts
            "Seguridad en el Laboratorio (Reglas Esenciales)", "Material de Laboratorio Común (Identificación y Uso Básico)", "Medición Precisa de Volúmenes (Pipeta, Bureta, Matraz Aforado)", "Titulación (Procedimiento y Propósito)", "Filtración (Separación Sólido-Líquido)", "Cromatografía (Concepto básico de separación)", "Manejo de Datos Experimentales (Cifras Significativas - Repaso)",
            // Add more specific questions or comparative topics
            "Diferencia entre Entalpía y Energía Interna", "¿Cómo afecta la hibridación a la forma molecular?", "Comparación entre Celdas Voltaicas y Electrolíticas", "Relación entre ΔG, ΔH y ΔS", "¿Por qué el agua tiene un punto de ebullición alto?", "Explicar el Efecto Tyndall", "Relación entre Ksp y Solubilidad", "¿Qué es un catalizador y cómo funciona?", "¿Cómo se aplica la Ley de Hess?", "Diferencia entre isótopos e isómeros", "Importancia de la carga formal", "Aplicaciones de la Ley de Beer-Lambert",
        ];
        const chemistryThemes = [ // For generating more titles
            "estructura atómica avanzada", "teorías de enlace químico", "estequiometría y cálculos", "leyes de los gases", "termoquímica y espontaneidad", "cinética química y mecanismos", "equilibrio químico y Le Chatelier", "ácidos y bases fuertes/débiles", "buffers y titulaciones", "equilibrio de solubilidad (Ksp)", "electroquímica y celdas", "propiedades de las soluciones", "fuerzas intermoleculares", "química orgánica introductoria", "nomenclatura IUPAC", "grupos funcionales", "química nuclear básica", "espectroscopía básica", "química de coordinación", "seguridad y técnicas de laboratorio"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un profesor de química experimentado y claro, explicando conceptos de nivel medio (secundaria avanzada/introducción universitaria). Tu tarea es proporcionar una explicación detallada, precisa y pedagógica sobre el concepto químico indicado. Incluye: Definición clara, principios fundamentales, ecuaciones relevantes (usa notación simple como H2O, CO2, E=mc^2, pH = -log[H+], ΔG = ΔH - TΔS, PV=nRT; evita LaTeX complejo), ejemplos ilustrativos sencillos, importancia o aplicaciones del concepto, y posibles puntos clave o errores comunes a evitar. Utiliza un lenguaje formal pero accesible. El objetivo es una explicación completa de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Faster model for chat
            systemPrompt: "Actúa como un tutor de química asistente, enfocado *exclusivamente* en el concepto químico que se está mostrando actualmente. Responde preguntas de seguimiento para aclarar dudas sobre la definición, los ejemplos, las ecuaciones o las aplicaciones mencionadas en la explicación principal. Sé conciso, preciso y mantente estrictamente dentro del tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un libro de texto de química de nivel medio. Genera exactamente 15 nombres de conceptos específicos, preguntas clave o temas relevantes de química, adecuados para una explicación detallada. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Identical structure to previous)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentConceptTitle = null; // Context for chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentConceptTitle
                ? `Eres un tutor de química asistente, enfocado *exclusivamente* en el concepto químico llamado '${currentConceptTitle}'. Responde preguntas de seguimiento para aclarar dudas sobre la definición, los ejemplos, las ecuaciones o las aplicaciones mencionadas en la explicación principal. Sé conciso, preciso y mantente estrictamente dentro del tema actual.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    // *** USER-FRIENDLY ERROR MESSAGE ***
                    throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento. Por favor, intenta de nuevo en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular tu pregunta o selecciona otro concepto.");
                }
                console.log(`API Response received (${text.length} chars)`);
                // Basic check for non-answers
                 if (!isChat && (text.trim().length < 500 || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de proporcionar") || text.toLowerCase().includes("no tengo información"))) {
                    throw new Error("La IA no pudo generar una explicación adecuada para este concepto específico. Prueba con otro.");
                }
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                     throw new Error(`La conexión con la IA tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar los servidores de IA.");
            }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentConceptTitle) throw new Error("Error interno: Contexto del chat no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(chemistryThemes) || "conceptos generales de química";
            const specificPrompt = `Genera 15 nombres/conceptos de química de nivel medio sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes conceptos nuevos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 550, nologo: true }; // Slightly wider aspect ratio?
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "abstract chemistry concept";
            // *** PROMPT FOCUSED ON VISUAL CONCEPT, NO TEXT ***
            const enhancedPrompt = `Conceptual visualization representing the chemistry concept '${safePromptText}'. Abstract diagram, molecular structure representation, energy levels, lab setup schematic, or symbolic representation. Scientific illustration style. Avoid text, labels, letters, numbers, formulas, graphs with axis labels. Focus on clear visual communication of the core idea.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, numbers, formula, graph, chart, diagram with text, axis labels, written explanations, signature, watermark, realistic photo, person, hand";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText) {
             if (!rawText) return '';
             let formatted = rawText.trim();

             // 1. Handle simple formula notation (sub/super) BEFORE markdown bold/italic
             // Basic Subscripts (like H2O) - handles single digits mainly
             formatted = formatted.replace(/([A-Za-z])(\d+)/g, '$1<sub>$2</sub>');
             // Basic Superscripts (like [H+], E=mc^2) - simple cases
             formatted = formatted.replace(/([A-Za-z])\^?([\+\-−]|\d[\+\-−]?)/g, (match, base, charge) => `${base}<sup>${charge.replace('−','-')}</sup>`); // Simple charges
              formatted = formatted.replace(/\^(-?\d+)/g, '<sup>$1</sup>'); // General exponent like 10^-3
             formatted = formatted.replace(/E=mc\^2/gi, 'E=mc<sup>2</sup>'); // Specific common one

             // 2. Handle Markdown-like formatting
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');     // Italic

             // 3. Handle specific symbols/entities
             formatted = formatted.replace(/->/g, '&rarr;'); // Right arrow
             formatted = formatted.replace(/<->/g, '&harr;'); // Equilibrium arrow
             formatted = formatted.replace(/\\Delta/gi, 'Δ'); // Delta symbol

             // 4. Paragraph handling (Treat double line breaks as paragraph separators)
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 // Don't wrap existing headers in <p>
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 // Treat internal single line breaks as spaces within a paragraph
                 let content = block.replace(/\n/g, ' ');
                 // Simple check if it looks like an equation to maybe wrap differently (optional)
                 if (content.includes('=') && content.length < 100 && !content.includes('.')) {
                      return `<p class="formula">${content}</p>`; // Basic formula styling
                 }
                 return `<p>${content}</p>`;
             }).join('');

             return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Identical logic)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '<div class="ai-message" style="font-style: italic; font-size: 0.9em; text-align: center; background-color: transparent; color: var(--color-text-muted);">Pregúntame algo sobre este concepto...</div>'; // Reset prompt
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentConceptTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Identical logic)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (Identical logic, check error message)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message; // Directly use the friendly message from API function
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentConceptTitle) return; // Ensure context is set

            // Remove initial prompt if still there
            const initialPrompt = chatHistory.querySelector('.ai-message[style*="italic"]');
            if (initialPrompt) initialPrompt.remove();

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`${error.message}`); // Show the friendly error
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ========== (Identical logic)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) {
            const div=document.createElement('div');
            div.className='title-item';
            // Add an icon (optional, choose based on title content maybe?)
            // For now, a generic chemistry icon
            div.innerHTML = `<i class="fas fa-flask fa-fw"></i> <span>${title}</span>`;
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
         }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">No hay conceptos disponibles.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentConceptTitle = title; // SET CHAT CONTEXT
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is visible
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-atom placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando diagrama conceptual...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo cargar el diagrama.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message; // Show friendly error
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                 // Optionally hide chat section if main content fails
                 // chatSection.classList.add('content-hidden');
            }
        }
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más conceptos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar conceptos: ${error.message}`); // Show friendly error
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Conceptos';
             }
         }
        function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (Identical logic)
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: No se pudieron inicializar los componentes de la interfaz.</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>