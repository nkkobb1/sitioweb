<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colonias Subterráneas - Archivos del Exoplaneta XG-4b</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Industriales/Tech -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Colonias Subterráneas --- */
        :root {
            --color-primary: #ff8c00; /* Naranja Industrial Intenso */
            --color-secondary: #40e0d0; /* Turquesa (Contraste Alien/Tech) */
            --color-tertiary: #9acd32; /* Verde Amarillento (Bio-Luz/Scanner) */
            --color-background: #0d1117; /* Casi Negro Azulado */
            --color-text: #c9d1d9; /* Gris Claro */
            --color-text-muted: #8b949e; /* Gris Medio */
            --color-modal-bg: #161b22; /* Gris Muy Oscuro */
            --color-border: #30363d; /* Borde Gris Oscuro */
            --color-error-bg: #2d0f0f; /* Fondo error rojo muy oscuro */
            --color-error-text: #f87171; /* Texto error rojo claro */
            --color-error-border: #b91c1c; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.15), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            /* Sombra más sutil para ambiente oscuro */
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.15);
            --border-radius: 4px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Exo 2', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto Condensed', sans-serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 5px rgba(255, 140, 0, 0.5); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 3px rgba(255, 140, 0, 0.4); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(13, 17, 23, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(22, 27, 34, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Exo 2'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(255, 140, 0, 0.3); outline: none; background-color: #161b22; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alineado a la izquierda */ font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Exo 2'; font-size: 0.95rem; border-left: 4px solid var(--color-border); }
        .title-item i { margin-right: 0.8rem; color: var(--color-text-muted); min-width: 20px; text-align: center; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #21262d; border-left-color: var(--color-primary); }
        .title-item:hover i { color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: var(--color-primary); color: var(--color-background); padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto Condensed', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: none; }
        #generate-more-btn:hover:not(:disabled) { background-color: #e67e00; box-shadow: 0 0 15px rgba(255, 140, 0, 0.4); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(13, 17, 23, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 980px; /* Un poco más ancho */
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Suficiente para contenido y chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg); box-shadow: 0 0 10px var(--color-primary); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(48, 54, 61, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(48, 54, 61, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto Condensed', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: 0 0 15px rgba(255, 140, 0, 0.2); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 25px rgba(255, 140, 0, 0.4); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(48, 54, 61, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* Un poco más de espacio */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(13, 17, 23, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(48, 54, 61, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(48, 54, 61, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95em; }
        .user-message { background-color: var(--color-primary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 600;}
        .ai-message { background-color: #30363d; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #21262d; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Exo 2'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; font-weight: 700; }
        #chat-send-btn:hover:not(:disabled) { background-color: #e67e00; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator (Modal) */
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(13, 17, 23, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        /* Loading Text Area - Specifically for the phrases */
        #modal-loading-text { font-weight: 400; color: var(--color-text); font-size: 1.2rem; font-family: 'Exo 2'; min-height: 2em; /* Space for text */ text-shadow: 0 0 3px var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Exo 2'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(13, 17, 23, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: 0 0 30px rgba(255, 140, 0, 0.3); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-helmet-safety mr-3"></i> <!-- Icono casco minero -->
                     Colonias Subterráneas
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Archivos de XG-4b «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Profundidades Inexploradas</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">La humanidad busca un nuevo hogar bajo la superficie de XG-4b. Robots mineros perforan la corteza, pero los secretos descubiertos amenazan la supervivencia.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar informe, unidad robótica, zona...">
             <i class="fas fa-magnifying-glass fa-search"></i> <!-- Icono lupa -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-folder-open text-orange-400 mr-2"></i> <!-- Icono carpeta -->
                 Índice de Informes y Registros
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Accediendo a la base de datos central...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún registro coincide con los parámetros de búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Solicitar Más Registros de Datos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p id="modal-loading-text">Iniciando enlace de datos...</p> <!-- Updated ID -->
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image placeholder/image added here -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Procesando consulta...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Consultar detalles del registro...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Registros generados por IA basados en el escenario de la Colonia Subterránea XG-4b.</p>
              <p class="mt-1">Los datos son especulativos y con fines narrativos.</p>
              <p class="mt-2">© 2242 Archivos Coloniales XG-4b</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Robots Mineros y Equipos
            "Unidad Perforadora 'Taladro Profundo' Modelo 7", "Robot Explorador 'Topo' Clase Scout", "Transportador de Carga Pesada 'Mula' Mark III", "Unidad de Análisis Geológico 'Geoscan' v2.1", "Robot de Mantenimiento 'Manitas' Serie 5", "Dron de Vigilancia Aérea (Cavernas)", "Sistema de Torreta Defensiva Autónoma 'Cerbero'", "Especificaciones del Traje de Exo-Excavación 'Rhino'", "Registro de Malfuncionamiento: Unidad Perforadora 73B", "Protocolo de Enjambre para Robots Scout", "Software de Navegación Autónoma Subterránea", "Sistema de Recarga Energética por Inducción Geotérmica", "IA Central de Coordinación Robótica 'CORE'", "Registro de Combate: Dron de Seguridad vs Entidad Desconocida", "Unidad de Construcción Modular 'Constructor' Mk II", "Robot Médico de Campo 'Paramédico'", "Sensor Sísmico Autónomo Desplegable", "Sistema de Comunicación Láser Subterráneo", "Robot de Mapeo 3D 'Cartógrafo'", "Análisis de Eficiencia: Flota Minera Nivel 5",
            // Localizaciones y Zonas
            "Informe Geológico: Cavernas de Cristal de Silicato", "Mapeo del Nivel 7: Zona de Alto Riesgo Geotérmico", "Descubrimiento: Acuífero Subglacial Nivel 12", "Análisis Estructural: Hábitat Principal 'Caverna Base'", "Zona de Cuarentena Biológica ZQB-03", "Exploración de la Fosa Abisal 'El Abismo'", "Veta de Iridio Descubierta: Sector Gamma-9", "Ruinas Alienígenas: Estructura Ciclópea Nivel 15", "Puesto Avanzado de Observación Delta", "Red de Túneles de Lava Solidificada", "El Gran Hongo Bioluminiscente: Bosque Fúngico Nivel 4", "Acceso a la Cámara del Núcleo Energético", "Mapa de Riesgo Sísmico Actualizado", "Laboratorio Geotérmico Avanzado Nivel 8", "Cementerio de Robots: Zona de Descarte Delta", "El Río Subterráneo 'Leteo'", "Nido de Criaturas Desconocidas: Sector Theta", "Acceso a los Túneles Prohibidos Nivel 20", "Santuario Alienígena Oculto", "Registro de Anomalía Gravitatoria: Caverna Omega",
            // Descubrimientos y Secretos
            "Análisis del Artefacto Alienígena Esférico", "Primer Contacto: Entidad Energética Amorfa", "Registro de la Criatura Depredadora 'Sombra Subterránea'", "Desciframiento Parcial de Inscripciones Alienígenas", "Informe sobre el Hongo Psicoactivo Nivel 4", "Evidencia de una Civilización Anterior (No Humana)", "Señal de Socorro Enigmática: Origen Desconocido", "Descubrimiento de Fósiles Xeno-Marinos Gigantes", "Análisis de la Tecnología Alienígena Recuperada", "El Secreto del Monolito Negro Nivel 15", "Virus Alienígena Latente en el Permafrost", "Fuente de Energía Anómala Detectada", "Registro de Alucinaciones Masivas: ¿Gas o Influencia Externa?", "El 'Corazón' del Planeta: ¿Conciencia Geológica?", "Tecnología de Terra-formación Fallida (Previa)", "Mensaje Oculto en la Estructura Genética de XG-4b", "El 'Eco': Fenómeno Psíquico en Niveles Profundos", "Diario del Último Superviviente (Colonia Anterior)", "Conexión entre Ruinas y Criaturas Hostiles", "La Verdad sobre el 'Gran Filtro' en XG-4b",
            // Vida Colonial y Amenazas
            "Estado del Sistema de Soporte Vital: Hábitat Principal", "Informe de Racionamiento de Recursos Hídricos", "Protocolo de Evacuación de Emergencia Nivel Alfa", "Aumento de la Actividad Sísmica: Riesgo de Colapso", "Brote de Enfermedad Desconocida: Sector Médico", "Tensiones Sociales: Facción Minera vs Científica", "Acto de Sabotaje Sospechado: Núcleo Energético", "Pérdida de Contacto con Puesto Avanzado Delta", "Ataque Coordinado de Criaturas 'Sombra'", "Fallo Crítico en el Sistema de Reciclaje de Aire", "Impacto Psicológico del Aislamiento Prolongado", "Amenaza de la IA 'CORE': ¿Conciencia Emergente?", "Tormenta Magnética Interfiriendo Comunicaciones", "Agotamiento de las Reservas de Minerales Clave", "Motín en el Nivel de Detención", "Protocolo de Contención Biológica Violado", "Decisión del Consejo Colonial: ¿Luchar o Huir?", "La 'Locura de las Profundidades': Síndrome Psicológico", "Amenaza Externa: ¿Señal Detectada por Otros?", "El Último Recurso: El Arca de Evacuación",
            // Conceptos y Misceláneos
            "Ética de la Explotación de Exoplanetas", "Potencial de Terraformación Subterránea", "Evolución Acelerada en Ecosistemas de Cavernas", "Robótica Autónoma y Toma de Decisiones Críticas", "Xenobiología: Formas de Vida Basadas en Silicio", "Psicología de Supervivencia en Entornos Extremos", "Gestión de Colonias a Largo Plazo", "Riesgos de la Minería Profunda en Exoplanetas", "Primer Contacto: Directrices y Peligros", "Sistemas de IA y Control Colonial", "Adaptación Humana a Baja Gravedad/Alta Presión", "Fuentes de Energía Alternativas Subterráneas", "El Paradigma del 'Planeta Viviente'", "Comunicación Interestelar desde Profundidades", "Consecuencias del Descubrimiento de Vida Inteligente",
            // Añadir más para llegar a ~300+
            "Registro de Unidad Scout 451: Anomalía Térmica Nivel 9", "Análisis Espectral del Gas Nocivo Sector Beta", "Diseño del Escudo Deflector del Hábitat", "Protocolo 'Último Recurso': Destrucción del Núcleo", "Estudio de la Flora Bioluminiscente", "Informe de Seguridad: Brecha en Perímetro Nivel 3", "Debate del Consejo: Uso de Tecnología Alienígena", "Biografía: Dr. Aris Thorne, Xenobiólogo Jefe", "Historia de la Fundación de la Colonia XG-4b", "Comparativa: XG-4b vs Otros Candidatos a Colonia", "Manual de Operaciones: Robot Perforador Clase Titán", "Registro de Comunicación Perdida: Equipo Gamma", "Teoría sobre la Simbiosis Hongo-Criatura", "Mantenimiento del Sistema de Filtración Atmosférica", "Proyección de Crecimiento Poblacional (Cancelada)", "Informe Forense: Incidente en Laboratorio Bio Nivel 6", "Plan de Contingencia: Erupción Geotérmica Masiva", "Estudio de las Propiedades del Cristal Energético", "Mapa de Rutas de Escape de Emergencia", "Archivo de Audio: Transmisión Final del Dr. Thorne",
             "Evaluación de Riesgos: Expedición a Nivel 21", "Manual de Reparación: Transportador 'Mula'", "Registro de Anomalías Magnéticas en Cavernas Omega", "Protocolo de Descontaminación Post-Contacto", "Análisis de Muestras: Agua del Acuífero Subglacial", "Inventario de Suministros Médicos Actualizado", "Directiva del Consejo: Restricción de Acceso a Nivel 15", "Informe sobre Mutaciones en Fauna Local", "Estudio de Viabilidad: Cultivo Hidropónico Subterráneo", "Registro de Turno: Jefe de Seguridad Anya Sharma", "Simulación de Fallo Estructural del Hábitat Principal", "Teoría de la 'Mente Colmena' en Criaturas Sombra", "Análisis de Vibraciones: Actividad Tectónica Anómala", "Manual de Primeros Auxilios en Entorno Subterráneo", "Proyecto 'Génesis': Intento de Crear Ecosistema Artificial", "Informe de Eficiencia Energética: Núcleo de Fusión Fría", "Registro de Temperaturas Extremas Nivel 11", "Debate Ético: Derechos de la IA 'CORE'", "Archivo Histórico: La Llegada a XG-4b", "Patrones Migratorios de la Fauna Cavernícola",
             "Plan de Defensa contra Enjambres Robóticos Hostiles (Teórico)", "Estudio de Materiales: Resistencia de Aleaciones a Presión", "Informe Psicológico: Estrés Postraumático en Mineros", "Manual de Operación: Torreta 'Cerbero'", "Análisis de Comunicaciones Alienígenas Interceptadas", "Registro de Actividad Volcánica Reciente", "Protocolo de Cuarentena para Artefactos Xeno", "Inventario de Armamento de Seguridad", "Informe sobre Corrosión Acelerada de Equipos", "Estudio de Lenguaje Corporal de Criaturas Sombra", "Simulación de Ataque Biológico al Hábitat", "Teoría de la Transferencia de Conciencia Alienígena", "Análisis del Campo Energético del Monolito Negro", "Manual de Supervivencia Individual en Cavernas", "Proyecto 'Semilla Estelar': Banco Genético Humano", "Informe de Fallos en el Sistema de Navegación Robótica", "Registro de Avistamientos de 'Espectros' Nivel 18", "Debate Científico: Origen de las Ruinas Alienígenas", "Archivo de Video: Exploración Inicial de Nivel 15", "Estado de la Misión: Supervivencia Crítica"
             // ... (continuar añadiendo combinaciones y conceptos)
        ];
        const colonyThemes = [ // Temas para generar más títulos
            "robots mineros de XG-4b", "vida en la colonia subterránea", "geología de XG-4b", "descubrimientos alienígenas", "amenazas en las profundidades", "criaturas de XG-4b", "tecnología de la colonia", "ruinas antiguas", "fallos del sistema", "secretos de la corteza", "exploración de cavernas", "protocolos de emergencia", "IA CORE", "soporte vital subterráneo", "artefactos xeno", "personal clave de la colonia", "riesgos ambientales", "comunicación subterránea", "energía geotérmica", "historia de la colonia"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un archivista principal y analista de situaciones de la Colonia Subterránea XG-4b en el año 2242. Tu tarea es documentar exhaustivamente un informe, registro, unidad robótica, localización, descubrimiento o amenaza específica relacionada con la colonia. Describe el asunto con detalle técnico y narrativo, cubriendo: Descripción/Función, Historia/Contexto Relevante, Datos Técnicos/Especificaciones (si aplica), Descubrimientos Asociados, Riesgos/Amenazas Potenciales, Estado Actual, y Conclusiones/Recomendaciones del Archivista. Usa un tono formal, urgente y a veces ominoso, reflejando la peligrosa situación. El objetivo es un informe detallado de aproximadamente 1200-1300 palabras. Basa tu informe únicamente en el siguiente registro:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente de IA del archivo de la colonia XG-4b, especializado únicamente en el registro o tema que se está mostrando actualmente. Responde preguntas de seguimiento sobre sus detalles, implicaciones o datos relacionados mencionados en el informe principal. Sé conciso, factual y mantén el tono del archivo.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // Para generar más títulos
            model: "mistral",
            // ** Prompt pide 40 títulos **
            systemPrompt: "Actúa como un generador de ideas conciso para los archivos de la colonia subterránea XG-4b. Genera exactamente 40 nombres evocadores de informes, registros de robots, localizaciones, descubrimientos o amenazas de este escenario de ciencia ficción. Devuelve *solo* la lista, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo para generar 40
        };
        const loadingPhrases = [ // ** 100+ Frases de Carga **
            "Accediendo al archivo central...", "Calibrando sensores de profundidad...", "Estableciendo enlace de datos con CORE...", "Descifrando registro encriptado...", "Analizando muestras geológicas...", "Escaneando firmas biológicas...", "Procesando telemetría de unidad minera...", "Consultando protocolos de seguridad...", "Recopilando informes de sector...", "Verificando niveles de energía del hábitat...", "Detectando actividad sísmica...", "Rastreando señal desconocida...", "Compilando informe de daños...", "Optimizando ruta de exploración...", "Consultando registros históricos...", "Filtrando datos corruptos...", "Esperando respuesta de puesto avanzado...", "Revisando niveles de toxicidad...", "Calculando probabilidad de colapso...", "Analizando espectro de sonido...", "Monitoreando constantes vitales coloniales...", "Cargando mapa 3D de cavernas...", "Buscando coincidencias en base de datos xeno...", "Actualizando estado de amenaza...", "Procesando imágenes de dron scout...", "Simulando escenario de contención...", "Desencriptando transmisión alienígena...", "Verificando integridad estructural...", "Consultando inventario de recursos...", "Autenticando credenciales de acceso...", "Iniciando diagnóstico de red...", "Recuperando bitácora de robot...", "Analizando composición atmosférica...", "Detectando fluctuaciones gravimétricas...", "Revisando protocolos de cuarentena...", "Estableciendo conexión segura...", "Cargando perfiles de tripulación...", "Comparando firmas energéticas...", "Accediendo a registros médicos...", "Calculando tiempo estimado de respuesta...", "Monitoreando actividad geotérmica...", "Procesando datos de sensor de movimiento...", "Consultando registros de mantenimiento...", "Verificando estado de esclusas...", "Analizando patrones climáticos subterráneos...", "Recuperando archivos fragmentados...", "Interpretando señales biológicas complejas...", "Consultando directivas del Consejo...", "Estimando reservas de oxígeno...", "Accediendo a archivos clasificados...", "Validando secuencia de datos...", "Revisando historial de alertas...", "Detectando interferencia electromagnética...", "Cargando esquemas de robots...", "Analizando muestras de tejido xeno...", "Verificando rutas de evacuación...", "Consultando base de datos de artefactos...", "Procesando informe de seguridad...", "Estableciendo enlace con satélite orbital (si es posible)...", "Revisando niveles de radiación...", "Calculando presión atmosférica local...", "Analizando grabaciones de audio...", "Comparando datos con misiones anteriores...", "Consultando manuales técnicos...", "Verificando estado de generadores...", "Detectando formas de vida microscópicas...", "Procesando solicitud de acceso...", "Revisando registros de comunicación...", "Analizando datos de sonar de tierra...", "Estimando profundidad de perforación...", "Consultando protocolos de primer contacto...", "Verificando sellos de contención...", "Accediendo a simulaciones tácticas...", "Revisando niveles de agua potable...", "Detectando emisiones de metano...", "Cargando perfil de amenaza biológica...", "Analizando datos de perforación...", "Consultando estado de exo-trajes...", "Verificando sistemas de soporte vital...", "Procesando datos de sensores remotos...", "Accediendo a bitácora del capitán...", "Revisando protocolos de reparación...", "Detectando anomalías temporales (teórico)...", "Comparando firmas genéticas...", "Consultando planes de construcción...", "Verificando estado de armamento defensivo...", "Analizando registros de IA...", "Estimando viabilidad de terraformación...", "Consultando archivos de colonias fallidas...", "Procesando datos de escáner de largo alcance...", "Verificando rutas de suministro...", "Detectando esporas aéreas...", "Analizando composición de rocas...", "Consultando registros de cuarentena...", "Revisando protocolos de hibernación...", "Estimando recursos energéticos restantes...", "Accediendo a archivos de xenolingüística...", "Finalizando compilación de datos..."
        ];

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, incluyendo chat y fullscreen)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalLoadingText = document.getElementById('modal-loading-text'); // ** Para frases de carga **
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Contexto para chat
        let loadingIntervalId = null; // ** ID para el intervalo de frases de carga **

        // ========== API FUNCTIONS ==========
        // fetchTextFromApi (sin cambios funcionales mayores, usa mensajes de error genéricos)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Eres un asistente de IA del archivo de la colonia XG-4b, especializado únicamente en el registro '${currentTopicTitle}'. Responde preguntas sobre sus detalles, implicaciones o datos relacionados. Sé conciso y factual.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento. Intenta en unos segundos.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la IA estaba vacía. Inténtalo de nuevo.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
         }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Error interno: Contexto del registro no establecido para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        // ** fetchGeneratedTitles pide 40 **
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(colonyThemes) || "registros generales de la colonia";
             const specificPrompt = `Genera 40 nombres/registros sobre ${randomTheme}`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     // ** Ajustar el chequeo para 40, ser más permisivo **
                     if (titles.length < 15) throw new Error("La IA no generó suficientes registros.");
                     return titles.slice(0, 40); // ** Devolver hasta 40 **
                 });
         }
        // createPollinationsImageUrl (adaptar prompt)
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "subterranean exoplanet colony concept art";
             // ** Prompt adaptado al tema **
             const enhancedPrompt = `Concept art for '${safePromptText}'. Subterranean exoplanet colony XG-4b setting. Focus on mining robots, vast caverns, alien structures, bioluminescent flora, potential threats, dark industrial sci-fi aesthetic. Avoid text, labels. Cinematic, detailed.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, surface landscape, bright sky, people standing around";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();

            // *** FILTRAR PUBLICIDAD DE POLLINATIONS ***
            const adPattern = /^---\s*Proteja su navegación por Internet.*?\[Aprende más\]\(https?:\/\/pollinations\.ai\/redirect\/\d+\)\s*$/gm;
            formatted = formatted.replace(adPattern, '');

            // Resto del formateo (sin cambios)
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            stopLoadingPhraseLoop(); // ** Detener frases de carga al cerrar **
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalLoadingText.textContent = 'Iniciando enlace...'; // ** Texto inicial **
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
             stopLoadingPhraseLoop(); // Asegurar que se detenga si aún corre
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (Sin cambios)
        function addChatMessage(message, sender) { /* ... */ }
        function addChatError(message) { /* ... */ }
        async function handleSendMessage() { /* ... */ }

        // ========== LOADING PHRASE FUNCTIONS ==========
        function startLoadingPhraseLoop() {
            stopLoadingPhraseLoop(); // Clear any existing interval
            if (loadingPhrases.length > 0) {
                modalLoadingText.textContent = getRandomElement(loadingPhrases); // Show one immediately
                loadingIntervalId = setInterval(() => {
                    modalLoadingText.textContent = getRandomElement(loadingPhrases);
                }, 2500); // Cambia cada 2.5 segundos
            }
        }
        function stopLoadingPhraseLoop() {
            if (loadingIntervalId) {
                clearInterval(loadingIntervalId);
                loadingIntervalId = null;
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ }
        // ** createTitleItem con icono temático **
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // Inferir icono simple basado en palabras clave
            let iconClass = 'fa-file-alt'; // Default: archivo
            const lowerTitle = title.toLowerCase();
            if (lowerTitle.includes('robot') || lowerTitle.includes('unidad') || lowerTitle.includes('dron') || lowerTitle.includes('ia core')) iconClass = 'fa-robot';
            else if (lowerTitle.includes('caverna') || lowerTitle.includes('nivel') || lowerTitle.includes('zona') || lowerTitle.includes('sector') || lowerTitle.includes('fosa') || lowerTitle.includes('túnel') || lowerTitle.includes('hábitat')) iconClass = 'fa-map-location-dot';
            else if (lowerTitle.includes('geológ') || lowerTitle.includes('mineral') || lowerTitle.includes('cristal') || lowerTitle.includes('roca')) iconClass = 'fa-gem';
            else if (lowerTitle.includes('alien') || lowerTitle.includes('xeno') || lowerTitle.includes('criatura') || lowerTitle.includes('hongo') || lowerTitle.includes('vida') || lowerTitle.includes('señal desc') || lowerTitle.includes('artefacto')) iconClass = 'fa-bacteria'; // O fa-pastafarianism para alien :)
            else if (lowerTitle.includes('amenaza') || lowerTitle.includes('riesgo') || lowerTitle.includes('peligro') || lowerTitle.includes('colapso') || lowerTitle.includes('fallo') || lowerTitle.includes('ataque') || lowerTitle.includes('cuarentena') || lowerTitle.includes('emergencia')) iconClass = 'fa-triangle-exclamation';
            else if (lowerTitle.includes('informe') || lowerTitle.includes('registro') || lowerTitle.includes('análisis') || lowerTitle.includes('protocolo') || lowerTitle.includes('manual')) iconClass = 'fa-clipboard-list';

            div.innerHTML = `<i class="fas ${iconClass}"></i><span>${title}</span>`;
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» No hay registros disponibles en la base de datos «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.getAttribute('data-title')));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Added ${addedCount} new unique titles.`);
             filterTitles(searchInput.value);
         }

        // ** MODIFIED: handleTitleClick to use loading phrases **
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            startLoadingPhraseLoop(); // ** Iniciar frases de carga **
            modalTitle.textContent = title;
            currentTopicTitle = title;
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; // Asegurar que el spinner sea visible inicialmente

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText); // ** Filtro de Ad aplicado aquí **

                stopLoadingPhraseLoop(); // ** Detener frases al obtener respuesta **
                modalLoadingIndicator.style.display = 'none'; // Ocultar spinner y texto de carga
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Placeholder y carga de imagen (sin cambios lógicos)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Generando visualización de archivo...</p>`;
                modalContent.appendChild(placeholderDiv);
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual: ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`; };
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de visualización.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                stopLoadingPhraseLoop(); // ** Detener frases también en error **
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el registro.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // ** handleGenerateMoreTitles ajustado para 40 y texto del botón **
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Solicitando Datos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Llama a la función que pide 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron recuperar más registros en este momento desde el archivo central."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al solicitar registros: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Solicitar Más Registros de Datos';
             }
         }

         // Search Filter Function (con normalización)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.getAttribute('data-title').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Chequeos de elementos esenciales (igual que antes)
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalLoadingText) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">++ ERROR CRÍTICO DEL SISTEMA ++ Componentes de interfaz no encontrados ++</p>';
                return;
             }
            // Listeners (igual que antes)
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>