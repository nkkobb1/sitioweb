<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telar de Narrativas Imposibles</title> <!-- Nuevo título -->

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Raleway:wght@400;500;600&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
    <!-- Añadida Lora para el texto de la historia -->

    <style>
      :root {
        --bg-gradient-start: #0f0c29;
        --bg-gradient-mid: #302b63;
        --bg-gradient-end: #24243e;
        --text-primary: #f0f0f5;
        --text-secondary: #b0a8e0;
        --accent-color: #00f7ff;
        --accent-hover: #7afffd;
        --magenta-glow: #ff00e6;
        --error-color: #ff8787;
        --card-bg: rgba(30, 30, 50, 0.75); /* Un poco más opaco */
        --card-border: rgba(0, 247, 255, 0.35);
        --input-bg: rgba(0, 0, 0, 0.25);
        --input-border-focus: var(--accent-color);
        --image-bg: rgba(0, 0, 0, 0.4);
        --text-area-bg-active: rgba(0, 0, 0, 0.35); /* Fondo sutil para texto */
        --shadow-color: rgba(0, 247, 255, 0.4);
        --button-shadow: rgba(0, 0, 0, 0.5);
      }

      *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: 'Raleway', sans-serif;
        background: linear-gradient(-45deg, var(--bg-gradient-start), var(--bg-gradient-mid), var(--bg-gradient-end), var(--bg-gradient-mid));
        background-size: 400% 400%; background-attachment: fixed;
        animation: gradientBG 18s ease infinite;
        color: var(--text-primary); display: flex; justify-content: center;
        align-items: center; min-height: 100vh; padding: 25px; overflow-x: hidden;
      }

       @keyframes gradientBG { /* Sin cambios */
        0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; }
      }
       body::before { /* Sin cambios */
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(ellipse at 30% 70%, rgba(0, 247, 255, 0.1) 0%, rgba(0,0,0,0) 60%),
                    radial-gradient(ellipse at 70% 30%, rgba(255, 0, 230, 0.12) 0%, rgba(0,0,0,0) 55%),
                    radial-gradient(ellipse at 50% 50%, rgba(176, 168, 224, 0.08) 0%, rgba(0,0,0,0) 65%);
        opacity: 0.8; pointer-events: none;
        animation: nebulaDrift 35s infinite linear alternate;
        mix-blend-mode: screen;
      }
       @keyframes nebulaDrift { /* Sin cambios */
         from { transform: translate(-5%, -5%) scale(1); opacity: 0.6; }
         to { transform: translate(5%, 5%) scale(1.1); opacity: 1; }
      }

      .container {
        background-color: var(--card-bg);
        backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
        padding: 45px 55px; border-radius: 30px; /* Más redondeado */
        border: 1.5px solid var(--card-border);
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.55), 0 0 35px var(--shadow-color) inset;
        text-align: center; max-width: 800px; /* Un poco más ancho */
        width: 95%; position: relative; z-index: 1;
        animation: fadeInContainer 1.2s cubic-bezier(0.25, 1, 0.5, 1) forwards; /* Animación más suave */
        overflow: hidden;
      }
       @keyframes fadeInContainer {
          from { opacity: 0; transform: scale(0.92) translateY(20px); }
          to { opacity: 1; transform: scale(1) translateY(0); }
       }

      h1 {
        font-family: 'Orbitron', sans-serif; color: var(--accent-color);
        margin-bottom: 18px; font-size: 2.8em; font-weight: 700;
        text-shadow: 0 0 12px var(--shadow-color), 0 0 25px var(--shadow-color), 0 0 4px #fff;
        letter-spacing: 1.8px;
      }

      .subtitle {
          color: var(--text-secondary); margin-bottom: 35px;
          font-size: 1.2em; line-height: 1.7; max-width: 90%;
          margin-left: auto; margin-right: auto; font-weight: 300;
      }

      .input-area { margin-bottom: 35px; display: flex; justify-content: center; }

      #userInput {
          font-family: 'Raleway', sans-serif; font-size: 1.1em;
          padding: 14px 20px; /* Un poco más alto */
          border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.2);
          background-color: var(--input-bg); color: var(--text-primary);
          width: 75%; max-width: 450px; outline: none;
          transition: border-color 0.3s ease, box-shadow 0.3s ease;
          text-align: center;
      }
      #userInput::placeholder {
          color: rgba(176, 168, 224, 0.6); font-style: italic; font-weight: 400;
      }
       #userInput:focus {
          border-color: var(--input-border-focus);
          box-shadow: 0 0 18px rgba(0, 247, 255, 0.35);
       }

      .result-area {
        margin: 35px 0; padding: 30px; /* Más padding interno */
        background-color: rgba(0,0,0, 0.25); border-radius: 18px; /* Más redondeado */
        border: 1px solid rgba(255, 255, 255, 0.1);
        min-height: 350px; /* Aumentar altura mínima */
        display: flex; flex-direction: column; align-items: center;
        gap: 30px; /* Más espacio entre imagen y texto */
        transition: background-color 0.6s ease;
      }
      .result-area.text-visible {
          background-color: var(--text-area-bg-active); /* Sutil cambio de fondo */
      }


      .image-container {
          width: 100%; max-width: 360px; /* Ajustar si es necesario */
          aspect-ratio: 16 / 10; /* Proporción más panorámica */
          background-color: var(--image-bg); border-radius: 14px;
          position: relative; overflow: hidden;
          display: flex; justify-content: center; align-items: center;
          border: 1px solid rgba(0, 247, 255, 0.15); opacity: 0;
          transform: scale(0.9);
          transition: opacity 0.9s ease-out, transform 0.9s ease-out;
      }
       .image-container.visible { opacity: 1; transform: scale(1); }

      #storyImage {
          display: block; width: 100%; height: 100%; object-fit: cover;
          border-radius: 14px; opacity: 0;
          transition: opacity 0.7s ease-in 0.3s;
      }
       #storyImage.loaded { opacity: 1; }

      .image-loader { /* Sin cambios */
        position: absolute; width: 50px; height: 50px;
        border: 4px solid rgba(0, 247, 255, 0.2);
        border-top-color: var(--accent-color); border-radius: 50%;
        animation: spin 1.2s linear infinite; z-index: 5; opacity: 1;
        transition: opacity 0.3s ease;
      }
      .image-loader.hidden { opacity: 0; }


      #storyStartText {
        font-family: 'Lora', serif; /* Fuente Serif para la historia */
        font-size: 1.25em; /* Ligeramente más grande */
        font-weight: 400;
        color: var(--text-primary);
        line-height: 1.9; /* Más interlineado */
        opacity: 0;
        transform: translateY(15px); /* Inicia un poco más abajo */
        transition: opacity 1s ease-out 0.2s, transform 1s ease-out 0.2s; /* Transición más lenta/suave */
        max-width: 98%; /* Casi todo el ancho */
        text-align: left;
        text-shadow: 1px 1px 4px rgba(0,0,0,0.7);
        white-space: pre-wrap; /* <<< IMPORTANTE: Respeta saltos de línea >>> */
        padding: 10px; /* Padding interno para el texto */
      }
      #storyStartText.visible { opacity: 1; transform: translateY(0); }

      .controls { margin-top: 35px; }

      #generateButton {
        font-family: 'Orbitron', sans-serif;
        background: linear-gradient(145deg, var(--accent-color), #00b8c4);
        color: var(--bg-gradient-start); padding: 19px 42px; /* Ligeramente más grande */
        border: none; border-radius: 50px; cursor: pointer; font-size: 1.25em;
        font-weight: 700; letter-spacing: 1.6px;
        transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: 0 7px 22px var(--button-shadow), 0 0 12px var(--accent-color) inset;
        position: relative; overflow: hidden; outline: none; text-transform: uppercase;
      }
       #generateButton:hover:not(:disabled) { /* Sin cambios */
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 10px 30px var(--shadow-color), 0 0 15px var(--accent-hover) inset;
        background: linear-gradient(145deg, var(--accent-hover), #00dceb);
      }
       #generateButton:active:not(:disabled) { /* Sin cambios */
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 4px 15px var(--shadow-color), 0 0 8px var(--accent-hover) inset;
       }
       #generateButton:disabled { /* Sin cambios */
        cursor: not-allowed; background: linear-gradient(145deg, #666, #444);
        opacity: 0.5; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transform: none;
      }

      .button-content { /* Sin cambios */
        position: relative; display: inline-block; transition: opacity 0.3s ease;
      }
       .loading-indicator { /* Sin cambios */
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 28px; height: 28px; border: 4px solid rgba(26, 26, 46, 0.4);
        border-top-color: var(--bg-gradient-start); border-radius: 50%;
        animation: spin 1s linear infinite; opacity: 0; transition: opacity 0.3s ease;
      }
       #generateButton.loading .button-content { opacity: 0; }
       #generateButton.loading .loading-indicator { opacity: 1; }

      @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

      .error-message { /* Sin cambios */
        color: var(--error-color); margin-top: 30px; font-weight: 500;
        min-height: 1.5em; opacity: 0; transition: opacity 0.5s ease;
        font-size: 1.15em; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      }
       .error-message.visible { opacity: 1; }

      /* Responsive Adjustments */
       @media (max-width: 850px) {
            .container { padding: 40px 30px; max-width: 90%; }
            h1 { font-size: 2.4em; }
            .subtitle { font-size: 1.1em; }
            #userInput { width: 85%; font-size: 1em; }
            .result-area { padding: 25px; min-height: 300px; gap: 25px;}
            .image-container { max-width: 320px; }
            #storyStartText { font-size: 1.1em; line-height: 1.8; }
            #generateButton { padding: 17px 35px; font-size: 1.1em; }
       }
        @media (max-width: 550px) {
            body { padding: 15px; }
            .container { padding: 30px 20px; }
            h1 { font-size: 2em; }
            .subtitle { font-size: 1em; }
             #userInput { width: 95%; font-size: 0.95em; padding: 12px 15px; }
            .result-area { padding: 20px; gap: 20px;}
            .image-container { max-width: 280px; aspect-ratio: 1 / 1; } /* Volver a cuadrado en móvil */
            #storyStartText { font-size: 1em; line-height: 1.7;}
            #generateButton { padding: 15px 30px; font-size: 1em; }
        }
    </style>
</head>
<body>

  <div class="container">
    <h1>Telar de Narrativas Imposibles</h1>
    <p class="subtitle">Teje tu idea en el tapiz cósmico. Pulsa el botón y observa cómo se despliega una historia visual y textual desde más allá del velo.</p>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Idea semilla: Nebulosa de caramelo, tiempo líquido...">
    </div>

    <div class="result-area" id="resultArea">
      <div class="image-container" id="imageContainer">
          <div class="image-loader" id="imageLoader"></div>
          <img id="storyImage" src="" alt="Visualización narrativa" >
      </div>
      <!-- Cambiado a DIV para más flexibilidad futura, pero P funciona igual con pre-wrap -->
      <div id="storyStartText"></div>
    </div>

    <div class="controls">
       <button id="generateButton">
           <span class="button-content">Tejer la Trama</span> <!-- Nuevo texto botón -->
           <span class="loading-indicator"></span>
       </button>
    </div>

    <div id="errorMessage" class="error-message"></div>
  </div>

  <script type="module">
    const generateButton = document.getElementById('generateButton');
    const storyStartText = document.getElementById('storyStartText');
    const errorMessage = document.getElementById('errorMessage');
    const imageContainer = document.getElementById('imageContainer');
    const storyImage = document.getElementById('storyImage');
    const imageLoader = document.getElementById('imageLoader');
    const userInput = document.getElementById('userInput');
    const resultArea = document.getElementById('resultArea'); // Referencia al contenedor

    const POLLINATIONS_TEXT_URL_BASE = "https://text.pollinations.ai/";
    const POLLINATIONS_IMAGE_URL_BASE = "https://image.pollinations.ai/prompt/";

    // --- Elementos para Aleatoriedad (sin cambios) ---
    const randomObjects = ["tetera cuántica", "reloj de arena cósmico", "calcetín perdido interdimensional", "planeta hecho de queso", "agujero negro cantante", "biblioteca flotante", "robot melancólico", "hongo parlante", "escultura de niebla", "oráculo de bolsillo", "autobús espacial oxidado"];
    const randomAdjectives = ["iridiscente", "geométrico", "paradójico", "pegajoso", "filosófico", "eufórico", "silencioso", "fractal", "olvidado", "resonante", "translúcido"];
    const randomPlaces = ["un café en el borde del universo", "una ciudad construida en un sueño", "el interior de un átomo", "un desierto de espejos", "una jungla de neón", "el archivo de los futuros perdidos", "la autopista de la antimateria", "un océano de tinta", "la trastienda de la realidad"];

    const pickRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];

    // --- Helper para limpiar texto (sin cambios) ---
    function cleanApiResponse(text) {
        let cleaned = text.trim();
        cleaned = cleaned.replace(/^Here's.*?:\s*/i, '');
        cleaned = cleaned.replace(/^Okay,.*?:\s*/i, '');
        cleaned = cleaned.replace(/^Sure,.*?:\s*/i, '');
        cleaned = cleaned.replace(/^Alright,.*?:\s*/i, '');
        cleaned = cleaned.replace(/^"/, '').replace(/"$/, '');
        cleaned = cleaned.replace(/^\s*[-\*]\s*/, '');
        cleaned = cleaned.replace(/^\s*[0-9]+\.\s*/, '');
        // Reemplazar múltiples saltos de línea por un máximo de dos (para párrafos)
        cleaned = cleaned.replace(/\n\s*\n\s*\n+/g, '\n\n');
        return cleaned.trim();
    }

    // --- Función principal ---
    if (generateButton && storyStartText && errorMessage && imageContainer && storyImage && imageLoader && userInput && resultArea) {
        generateButton.addEventListener('click', async () => {
            // 1. Estado inicial y limpieza
            generateButton.disabled = true;
            generateButton.classList.add('loading');
            storyStartText.textContent = '';
            storyStartText.classList.remove('visible');
            resultArea.classList.remove('text-visible'); // Quitar clase de fondo
            errorMessage.textContent = '';
            errorMessage.classList.remove('visible');
            imageContainer.classList.remove('visible');
            storyImage.src = '';
            storyImage.classList.remove('loaded');
            imageLoader.classList.remove('hidden');

            const userIdea = userInput.value.trim();
            let generatedText = '';

            // --- Iniciar generación de Imagen (sin cambios) ---
            imageLoader.classList.remove('hidden');
            imageContainer.classList.add('visible');
            let imagePromptKeywords = `surreal cosmic dreamscape illustration, ${userIdea || pickRandom(randomObjects)}, ${pickRandom(randomAdjectives)}, vibrant colors, cinematic lighting, highly detailed digital painting, artstation trending`;
            const encodedImagePrompt = encodeURIComponent(imagePromptKeywords);
            const imageUrl = `${POLLINATIONS_IMAGE_URL_BASE}${encodedImagePrompt}?width=640&height=400&seed=${Date.now()}&nologo=true`; // Ajustar tamaño si se cambió aspect-ratio
            console.log("Requesting Image URL:", imageUrl);

            storyImage.onload = () => { /* Sin cambios */
                console.log("Image loaded successfully.");
                storyImage.classList.add('loaded'); imageLoader.classList.add('hidden');
            };
            storyImage.onerror = () => { /* Sin cambios */
                console.error("Failed to load image.");
                if (!errorMessage.textContent) { errorMessage.textContent = "Fallo en la visualización. La narrativa persiste."; errorMessage.classList.add('visible'); }
                imageLoader.classList.add('hidden');
            };
            storyImage.src = imageUrl; // Inicia carga

            // --- Iniciar generación de Texto (Prompt modificado) ---
            try {
                const randomElement = pickRandom(randomObjects);
                const randomAdj = pickRandom(randomAdjectives);
                const randomPlace = pickRandom(randomPlaces);

                // <<< PROMPT MODIFICADO PARA LONGITUD Y FORMATO >>>
                let textPrompt = `Escribe el inicio de una historia extraña, absurda y cósmica, de aproximadamente 80 a 120 palabras, dividida en 2 o 3 párrafos cortos. Usa saltos de línea (un solo \\n) para separar frases si es natural, y un doble salto de línea (\\n\\n) para separar los párrafos. Debe incluir algo sobre un "${randomElement}" que es ${randomAdj}. Menciona de alguna forma "${randomPlace}".`;
                if (userIdea) {
                    textPrompt += ` También incorpora sutilmente la idea de "${userIdea}".`;
                }
                textPrompt += ` Sé directo, evocador y céntrate en la narrativa, sin introducciones ni explicaciones.`;

                const encodedTextPrompt = encodeURIComponent(textPrompt);
                const textRequestUrl = POLLINATIONS_TEXT_URL_BASE + encodedTextPrompt;

                console.log("Requesting Text URL:", textRequestUrl);
                const textResponse = await fetch(textRequestUrl);
                if (!textResponse.ok) {
                    throw new Error(`Error ${textResponse.status} del telar textual.`);
                }
                const rawText = await textResponse.text();
                if (!rawText) {
                    throw new Error("El silencio reina en el éter narrativo.");
                }
                generatedText = cleanApiResponse(rawText);
                console.log("Generated Text:\n", generatedText); // Mostrar en consola con saltos

                // Mostrar Texto, HABILITAR BOTÓN y añadir clase a resultArea
                storyStartText.textContent = generatedText; // textContent respeta \n con pre-wrap
                void storyStartText.offsetWidth; // Force reflow
                storyStartText.classList.add('visible');
                resultArea.classList.add('text-visible'); // Añadir clase para efecto de fondo

                generateButton.disabled = false;
                generateButton.classList.remove('loading');

            } catch (error) {
                console.error('Fallo en el tejido narrativo:', error);
                let friendlyError = 'Hilos cósmicos enredados. No se pudo generar la historia.';
                if (error instanceof Error) { friendlyError = error.message; }
                errorMessage.textContent = friendlyError;
                errorMessage.classList.add('visible');

                // Asegurar rehabilitación botón y limpieza UI en error
                generateButton.disabled = false;
                generateButton.classList.remove('loading');
                imageLoader.classList.add('hidden');
                imageContainer.classList.remove('visible');
                resultArea.classList.remove('text-visible');
            }
        });
    } else { /* Error inicialización sin cambios */
         console.error("Error fatal: Elementos esenciales del DOM no encontrados.");
         document.body.innerHTML = '<h1 style="color: red; text-align: center; margin-top: 50px;">Error Crítico: La interfaz no pudo inicializarse.</h1>';
    }
  </script>

</body>
</html>