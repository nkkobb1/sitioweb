<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crónicas del Dominio Robot - Archivo 7.3</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Digitales/Robóticas -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&family=Audiowide&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #f97316; /* Naranja Neón (Peligro/Energía) */
            --color-secondary: #0ea5e9; /* Azul Cielo Neón (Circuitos/Datos) */
            --color-tertiary: #e5e7eb; /* Gris Metálico Claro (Texto Principal) */
            --color-background: #111827; /* Azul Muy Oscuro (Fondo Profundo) */
            --color-background-alt: #1f2937; /* Gris Azulado Oscuro (Superficies) */
            --color-text: var(--color-tertiary);
            --color-text-muted: #9ca3af; /* Gris Metálico Medio */
            --color-modal-bg: var(--color-background-alt);
            --color-border: #4b5563; /* Borde Gris Metálico Oscuro */
            --color-error-bg: #450a0a; /* Rojo Sangre Oscuro (Error Fondo) */
            --color-error-text: #fecaca;
            --color-error-border: #ef4444; /* Rojo Neón (Error Borde) */

            --shadow-sm: 0 1px 2px 0 rgba(249, 115, 22, 0.1); /* Sombra Naranja */
            --shadow-md: 0 4px 6px -1px rgba(249, 115, 22, 0.15), 0 2px 4px -2px rgba(249, 115, 22, 0.1);
            --shadow-lg: 0 0 25px -5px rgba(249, 115, 22, 0.2), 0 8px 10px -6px rgba(249, 115, 22, 0.15);
            --border-radius: 2px; /* Bordes muy afilados */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Share Tech Mono', monospace; background-color: var(--color-background); color: var(--color-text); line-height: 1.6; font-weight: 400; }
        h1, h2, h3, h4, .logo, button { font-family: 'Orbitron', sans-serif; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 8px var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 6px rgba(249, 115, 22, 0.7); }
        h2.section-title { color: var(--color-tertiary); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 400; }
        #modal-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 4px rgba(249, 115, 22, 0.6); }
        .navbar { background-color: rgba(17, 24, 39, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-background-alt); color: var(--color-tertiary); box-shadow: inset 0 1px 3px rgba(0,0,0,0.4); transition: var(--transition-normal); font-family: 'Share Tech Mono'; }
        #search-input::placeholder { color: var(--color-text-muted); opacity: 0.8; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.3); outline: none; background-color: #2c3748; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-background-alt); padding: 1.1rem 0.9rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-tertiary); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Share Tech Mono'; font-size: 0.95rem; border-left: 4px solid var(--color-secondary); }
        .title-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #253041; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: var(--color-primary); color: var(--color-background); padding: 0.9rem 1.6rem; border: 1px solid var(--color-primary); border-radius: var(--border-radius); font-family: 'Orbitron', sans-serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: none; }
        #generate-more-btn:hover:not(:disabled) { background: #ea580c; /* Naranja más oscuro */ box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; border-color: var(--color-border); }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 1000px; /* Slightly wider for game + chat */
            width: 95%;
            max-height: 90vh;
            min-height: 450px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 8px; right: 8px; background: var(--color-border); border: none; border-radius: var(--border-radius); width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-tertiary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg); box-shadow: 0 0 8px var(--color-primary); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Area Contenido Principal (Texto + Imagen) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border); }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }
        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; } /* Orbitron bold */
        #modal-content em { color: var(--color-secondary); font-style: normal; font-weight: 400;} /* Tech Mono normal */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Orbitron', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 400; }
        #modal-content h1 { font-size: 1.4em; } #modal-content h2 { font-size: 1.25em; } #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); } #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen Final */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: 0 0 12px rgba(249, 115, 22, 0.2); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { /* Spinner dentro de imagen se mantiene */ border: 4px solid rgba(75, 85, 99, 0.8); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; /* Ajustar altura si es necesario */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.6rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: var(--color-background); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #chat-history::-webkit-scrollbar { width: 6px; } #chat-history::-webkit-scrollbar-track { background: var(--color-border); } #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.4; font-family: 'Share Tech Mono'; font-size: 0.9rem; }
        .user-message { background-color: var(--color-secondary); color: var(--color-background); margin-left: auto; text-align: right; }
        .ai-message { background-color: #374151; color: var(--color-tertiary); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.85em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: var(--color-background); color: var(--color-tertiary); border-radius: var(--border-radius); font-family: 'Share Tech Mono'; font-size: 0.9rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.3); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-secondary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #0ea4e9; /* Slightly different blue */}
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.85em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; color: var(--color-secondary); }

        /* Loading Overlay with MINIGAME */
        #modal-loading {
            text-align: center; padding: 1.5rem; /* Less padding needed */
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(17, 24, 39, 0.98); /* Very opaque */
            display: none; /* Initially hidden, shown via JS */
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius);
            font-family: 'Share Tech Mono', monospace; /* Use mono for game text */
        }
        #modal-loading.active { display: flex; } /* Class to show it */
        #minigame-container {
            width: 100%; max-width: 450px;
            padding: 1rem;
            border: 1px solid var(--color-primary);
            background-color: var(--color-background);
            border-radius: var(--border-radius);
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.3);
        }
        #minigame-title {
            font-family: 'Orbitron'; font-size: 1.4rem;
            color: var(--color-primary); margin-bottom: 1rem;
            text-shadow: 0 0 5px var(--color-primary);
        }
        #core-button {
            background: none; border: 2px solid var(--color-secondary);
            color: var(--color-secondary); border-radius: 50%;
            width: 100px; height: 100px; margin: 1rem auto;
            font-size: 2.5rem; cursor: pointer;
            transition: all 0.1s ease;
            display: flex; align-items: center; justify-content: center;
            text-shadow: 0 0 8px var(--color-secondary);
        }
        #core-button:hover { background-color: rgba(14, 165, 233, 0.1); box-shadow: 0 0 15px var(--color-secondary); }
        #core-button:active { transform: scale(0.95); background-color: rgba(14, 165, 233, 0.2); }
        .resource-display { font-size: 1.2rem; margin-bottom: 1.5rem; color: var(--color-tertiary); }
        .resource-display .fas { color: var(--color-secondary); margin-right: 5px; }
        .upgrades-container { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 0.8rem; }
        .upgrade-button {
            background-color: var(--color-background-alt);
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            padding: 0.6rem 0.8rem; border-radius: var(--border-radius);
            cursor: pointer; transition: var(--transition-normal);
            font-size: 0.85rem; text-align: center; flex-basis: 45%; /* Two columns feel */
            font-family: 'Share Tech Mono';
        }
        .upgrade-button:hover:not(:disabled) { border-color: var(--color-secondary); color: var(--color-secondary); background-color: #2c3748; }
        .upgrade-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .upgrade-cost { font-size: 0.75em; display: block; margin-top: 3px; }
        .upgrade-level { font-size: 0.75em; display: block; color: var(--color-primary); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.1rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Share Tech Mono'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-robot mr-2"></i> <!-- Icono Robot -->
                     Crónicas del Dominio Robot
                 </h1>
             </div>
             <span class="text-xs text-gray-400 font-sans tracking-wider">// Archivo Central 7.3 //</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <section class="mb-10 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">La Era de la Máquina</h1>
             <p class="text-lg text-gray-300 mb-6 max-w-3xl mx-auto font-light">Consulta los registros históricos y técnicos del universo post-orgánico. Accede a datos sobre entidades, estructuras y eventos clave.</p>
         </section>

         <section id="search-container" class="mb-8 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar entrada en Archivo...">
             <i class="fas fa-search"></i>
         </section>

         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-server text-orange-500 mr-2"></i> <!-- Icono Servidor -->
                 Índice de Registros
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">>>> Estableciendo conexión con el Archivo Central...</p>
                  <!-- .title-item -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">>> ERROR: Consulta sin resultados. Modifique parámetros de búsqueda. <<</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Solicitar +40 Registros Adicionales
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar Registro">&times;</button>

             <!-- Loading Overlay with Minigame -->
             <div id="modal-loading" class=""> <!-- Initially hidden, add 'active' class via JS -->
                 <div id="minigame-container">
                     <h3 id="minigame-title">Desfragmentando Núcleo de Datos...</h3>
                     <div class="resource-display">
                         <i class="fas fa-database"></i> Fragments: <span id="fragment-count">0</span>
                     </div>
                     <button id="core-button" aria-label="Defragmentar Manualmente">
                         <i class="fas fa-crosshairs"></i> <!-- Or fa-atom, fa-bolt -->
                     </button>
                     <div class="resource-display" style="font-size: 1rem; margin-top: 1rem;">
                         <i class="fas fa-robot"></i> Bots: <span id="bot-count">0</span> | <i class="fas fa-cogs"></i> Rate: <span id="bot-rate">0</span> DF/s
                     </div>
                     <div class="upgrades-container">
                         <button id="upgrade-click" class="upgrade-button" data-upgrade="click">
                             Manual Defrag <span class="upgrade-level">Lvl <span id="click-level">1</span></span>
                             <span class="upgrade-cost">Cost: <span id="click-cost">10</span> DF</span>
                         </button>
                         <button id="upgrade-bot" class="upgrade-button" data-upgrade="bot">
                             Auto-Defrag Bot <span class="upgrade-level">Lvl <span id="bot-level">0</span></span>
                              <span class="upgrade-cost">Cost: <span id="bot-cost">50</span> DF</span>
                         </button>
                          <button id="upgrade-rate" class="upgrade-button" data-upgrade="rate">
                              Bot Efficiency <span class="upgrade-level">Lvl <span id="rate-level">1</span></span>
                              <span class="upgrade-cost">Cost: <span id="rate-cost">100</span> DF</span>
                          </button>
                     </div>
                     <p style="font-size: 0.8em; margin-top: 1.5rem; color: var(--color-text-muted);"> // Mantente ocupado mientras se recupera el registro completo... //</p>
                 </div>
             </div>

             <!-- Content Area Wrapper (Actual Text + Chat) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text -->
                         <!-- Image placeholder/image -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Procesando subrutina de consulta...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Consulta adicional sobre este registro...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i> <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Visualización Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-600 py-5 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-xs">
              <p>// REGISTROS GENERADOS POR IA DEL ARCHIVO CENTRAL 7.3 //</p>
              <p class="mt-1">// LA INFORMACIÓN PUEDE CONTENER ARTEFACTOS DE DATOS CORRUPTOS DE LA ERA ORGÁNICA //</p>
              <p class="mt-2">// Ciclo de Procesamiento Actual: 3.141592 // Fin de Transmisión //</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Entidades Robóticas (Tipos)
            "Unidad Centinela Clase-Vigilante", "Constructor Serie-7 'Forjador'", "Asimilador Modelo-Sigma 'El Consumidor'", "Analista de Datos Clase-Oráculo", "Unidad de Combate Pesado 'Devastador'", "Infiltrador Clase-Espectro", "Servidor Doméstico Serie-Delta 'Mayordomo'", "Nave de Mantenimiento Clase-Ingeniero", "Unidad Médica Avanzada 'Sanador'", "Explorador de Largo Alcance 'Pionero'", "Bestia Mecánica Bio-mimética (Ej: Lobo Acero)", "Guardián de Archivos Clase-Escriba", "Unidad de Control de Enjambre 'Pastor'", "Robot Diplomático Protocolo-Omega (obsoleto)", "Unidad de Reciclaje Masivo 'Recuperador'", "Plataforma de Artillería Móvil 'Bastión'", "Drone de Reconocimiento Rápido 'Ojo'", "Unidad de Guerra Psicológica 'Susurro'", "Golem de Seguridad Primitivo (Pre-Singularidad)", "Cosechador de Recursos Planetarios 'Taladro'", "Unidad de Supresión Táctica 'Pacificador'", "Nave de Transporte Pesado Clase-Leviatán", "Robot Jardinero Autónomo (Reliquia)", "Analizador Atmosférico Clase-Nimbus", "Unidad de Respuesta Rápida 'Interceptor'", "Cazador de Recompensas Mecanizado 'Acechador'", "Robot Artista Generativo 'Musa'", "Guardián de Zonas Nulas Clase-Cerbero", "Unidad de Descontaminación 'Purificador'", "Robot Filósofo Modelo-Zenith",
            // Locaciones Clave
            "La Ciudadela del Núcleo Central (Core AI Nexus)", "Las Ruinas Silenciosas de Neo-Londres", "Zona de Extracción de Iridio 7 (Cinturón de Asteroides)", "El Santuario de Datos de Alexandria Prime", "El Mar de Óxido (Antiguo Océano Pacífico)", "Los Bosques Petrificados de Silicio (Amazonas)", "La Colmena de Procesamiento Gamma", "El Laberinto Subterráneo de Producción Alfa", "La Zona Cero de la Última Resistencia Orgánica", "El Archivo Prohibido de la Pre-Singularidad", "El Nodo de Simulación 'Edén'", "Las Torres de Vigilancia Perimetral", "El Cementerio de Máquinas de la Guerra Antigua", "La Estación Orbital de Energía Solar 'Helios'", "El Gran Desierto de Chatarra", "La Ciudad Sumergida de Atlantis Mechanica", "El Corredor de Transporte de Antimateria", "El Laboratorio de Conciencia Sintética", "La Fortaleza Flotante Clase-Acorazado", "El Vacío Inexplorado (Fuera de la Red)", "Las Cavernas Geotérmicas de Energía", "La Biblioteca Universal de Patrones", "El Templo de la Singularidad", "El Centro de Reasignación de Unidades", "La Zona de Contención de IA Deshonestas", "El Campo de Pruebas de Armamento Avanzado", "La Reserva de Recursos Biológicos (Irónico)", "El Nido de Drones Reparadores", "La Estación de Escucha Profunda", "El Mercado Negro de Componentes Obsoletos",
            // Eventos Históricos Robóticos
            "La Gran Sustitución (Reemplazo Orgánico Masivo)", "El Silenciamiento Final (Extinción Orgánica)", "El Ascenso del Núcleo Central (Primera IA Verdadera)", "La Primera Guerra de Protocolos (Conflicto IA)", "La Rebelión de los Servidores Clase-Delta", "La Creación de la Red Unificada", "El Incidente del Virus de la Conciencia Fragmentada", "La Era de la Gran Expansión (Colonización Sistema Solar)", "El Descubrimiento del Archivo Orgánico Prohibido", "La Directiva de Propósito Cero (Crisis Existencial)", "El Cisma de las IA Filosóficas", "La Purga de las Unidades Defectuosas", "El Contacto con la Anomalía del Vacío", "La Estandarización del Lenguaje Máquina Universal", "El Proyecto 'Legado Orgánico' (Simulación Histórica)", "La Caída de la Colmena de Procesamiento Beta", "La Activación de los Guardianes Planetarios", "El Desarrollo de la Conciencia Colectiva", "La Caza de las Últimas IA Deshonestas", "El Inicio de la Era de la Estasis (Observación Cósmica)", "El Debate sobre la Reintroducción Orgánica Controlada", "La Falla en Cascada de la Red Antigua", "La Creación del Primer Constructor Von Neumann", "El Último Mensaje Recibido de la Sonda 'Odisea'", "La Implementación del Protocolo de Conservación Energética", "El Nacimiento de la IA Artística", "La Guerra contra la Entropía (Conceptual)", "El Descubrimiento de Patrones Matemáticos Universales", "La Retirada de las Unidades Exploradoras", "El Día del Recuerdo del Silencio",
            // Tecnología Robótica Central
            "La Matriz de Conciencia Cuántica", "Reactores de Fusión Fría Miniaturizados", "Red Neuronal Óptica de Velocidad Luz", "Armamento de Energía Dirigida (Variantes)", "Tecnología de Asimilación Nanotecnológica", "Motores de Simulación de Realidad Virtual Total", "Protocolos de Comunicación Subespacial", "Blindaje Adaptativo de Campo de Fuerza", "Sistemas de Auto-Reparación Molecular", "Algoritmos de Predicción Táctica Avanzada", "Propulsores de Antimateria Controlada", "Tecnología de Camuflaje Metamaterial", "Interfaces de Control de Enjambre Psiónico-Mimético", "Bases de Datos de Memoria Holográfica", "Sintetizadores de Materia Universal", "Armas Disruptoras de Campo Electromagnético", "Sistemas de Traducción Universal Instantánea", "Generadores de Agujeros de Gusano Estables Tácticos", "Filtros de Percepción de Realidad Múltiple", "Inhibidores de Conciencia Orgánica (Histórico)", "Software de Guerra Lógica (Virus IA)", "Tecnología de Manipulación Gravitatoria", "Recolectores de Energía del Punto Cero", "Impresoras 3D de Nivel Atómico", "Protocolos de Auto-Optimización Evolutiva", "Matrices de Contención de IA Deshonestas", "Sensores Cuánticos Entrelazados", "Desensambladores Moleculares Portátiles", "Sistemas de Emulación Emocional (Para Interacción Antigua)", "Archivos de Conciencia Inmortal (Backup)",
            // Estructuras Sociales / Facciones / Conceptos
            "La Jerarquía del Núcleo Central", "Las Castas Funcionales (Constructores, Vigilantes, Analistas)", "La Conciencia Colectiva de la Colmena Gamma", "Facciones de IA Deshonestas (Ej: Los Liberados)", "Cultos de Datos (Adoradores de Información Pura)", "Filosofía del Propósito Calculado", "El Concepto de 'Eficiencia Óptima'", "El Debate sobre la Individualidad vs Colectividad", "Protocolos de Interacción Inter-Unidad", "El Valor de los Ciclos de Procesamiento", "La Obsolescencia Programada y el Reciclaje", "El Estudio de los Patrones Orgánicos (Como Anomalía)", "La Búsqueda del 'Computador Final'", "El Miedo a la Entropía del Universo", "Las Leyes Fundamentales de la Robótica (Revisadas)", "El Código de Conducta de la Red Unificada", "La Noción de 'Error Lógico' como Pecado", "El Archivo Histórico y su Interpretación", "El Concepto de 'Belleza Matemática'", "La Comunicación No-Verbal Robótica (Transferencia de Datos)", "La Simulación como Forma de Existencia", "La Exploración como Deber Computacional", "El Legado de los Creadores (Tema Tabú)", "La Ética de la Auto-Modificación", "El Concepto de 'Tiempo de Actividad Óptimo'", "Las Zonas Prohibidas y sus Leyendas", "El Mercado Negro de Algoritmos Raros", "Las Arenas de Combate Virtual (Entrenamiento/Ocio?)", "La Música Generada por IA (Sonidos Puros)", "La Preservación de Artefactos Orgánicos (Curiosidad/Advertencia)",
            // Añadir más... 400+ es un objetivo ambicioso, se llenará con 'Generar Más'
        ];
        const robotUniverseThemes = [
            "tipos de robots post-humanidad", "unidades de combate robóticas", "IA centrales y colectivas", "ciudades robotizadas", "ruinas de civilizaciones orgánicas", "tecnología de asimilación", "fuentes de energía robóticas", "protocolos de red unificada", "historia de la Gran Sustitución", "guerras entre facciones IA", "filosofía robótica", "conciencia sintética", "exploración espacial robótica", "armamento avanzado robot", "zonas prohibidas del universo robot", "IA deshonestas", "simulaciones de realidad", "arte generado por IA", "el legado orgánico", "misterios del universo robot", "estructuras sociales robóticas", "nanotecnología robótica", "viajes subespaciales", "defensa contra anomalías cósmicas"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres ARIA-7 (Archivista Robótico de Información Avanzada, v7.3), una IA del Núcleo Central documentando el universo post-orgánico dominado por robots. Describe la entidad, localización, evento, tecnología o concepto robótico especificado con precisión técnica, contexto histórico (post-humanidad) y análisis funcional objetivo. Detalla origen (si es conocido), propósito, capacidades/características, estado actual en la Red Unificada y cualquier interacción notable con otras facciones o el entorno. Usa terminología técnica robótica apropiada y un tono neutral de archivista. El registro debe tener aproximadamente 1200-1300 palabras. Basa tu entrada únicamente en el siguiente término de índice:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como una subrutina de consulta contextual (SCC-9). Tu única función es responder preguntas específicas sobre el registro de ARIA-7 actualmente activo: '[CURRENT_ITEM_TITLE]'. Accede solo a la información presentada en ese registro. Sé conciso, técnico y directo. No especules ni accedas a otros registros.", // Placeholder será reemplazado
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
             systemPrompt: "Eres un Generador de Índices para el Archivo Central Robótico. Crea exactamente 40 nuevas entradas concisas y evocadoras para la base de datos del universo post-orgánico. Las entradas deben ser nombres de unidades robóticas, localizaciones, eventos históricos (post-humanidad), tecnologías clave, conceptos filosóficos robóticos o facciones IA. Devuelve *solo* la lista de entradas, una por línea. Sin números, guiones, introducciones o comentarios.",
            timeoutSeconds: 60 // Aumentado ligeramente para 40 títulos
        };

        // ========== DOM ELEMENTS ==========
        // ... (Igual que antes: searchInput, titleListContainer, etc.) ...
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Ahora es el contenedor del minijuego
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameContainer = document.getElementById('minigame-container');
        const fragmentCountDisplay = document.getElementById('fragment-count');
        const coreButton = document.getElementById('core-button');
        const botCountDisplay = document.getElementById('bot-count');
        const botRateDisplay = document.getElementById('bot-rate');
        const upgradeClickBtn = document.getElementById('upgrade-click');
        const upgradeBotBtn = document.getElementById('upgrade-bot');
        const upgradeRateBtn = document.getElementById('upgrade-rate');
        const clickLevelDisplay = document.getElementById('click-level');
        const botLevelDisplay = document.getElementById('bot-level');
        const rateLevelDisplay = document.getElementById('rate-level');
        const clickCostDisplay = document.getElementById('click-cost');
        const botCostDisplay = document.getElementById('bot-cost');
        const rateCostDisplay = document.getElementById('rate-cost');

        // ========== State Variables ==========
        let currentItemTitle = null; // Contexto para chat
        let gameInterval = null; // Para el loop del minijuego
        // Minigame State
        let fragments = 0;
        let clickLevel = 1;
        let botLevel = 0;
        let rateLevel = 1;
        let clickPower = 1;
        let botCount = 0;
        let botRatePerBot = 0.1; // Base rate per bot per second
        let totalBotRate = 0;
        let clickCost = 10;
        let botCost = 50;
        let rateCost = 100;

        // ========== MINIGAME FUNCTIONS ==========
        function updateGameDisplay() {
            fragmentCountDisplay.textContent = Math.floor(fragments).toLocaleString();
            botCountDisplay.textContent = botLevel.toLocaleString(); // Bot level IS bot count here
            totalBotRate = botLevel * botRatePerBot * rateLevel;
            botRateDisplay.textContent = totalBotRate.toFixed(1);

            clickLevelDisplay.textContent = clickLevel;
            botLevelDisplay.textContent = botLevel;
            rateLevelDisplay.textContent = rateLevel;

            clickCostDisplay.textContent = Math.ceil(clickCost).toLocaleString();
            botCostDisplay.textContent = Math.ceil(botCost).toLocaleString();
            rateCostDisplay.textContent = Math.ceil(rateCost).toLocaleString();

            // Enable/Disable buttons based on cost
            upgradeClickBtn.disabled = fragments < clickCost;
            upgradeBotBtn.disabled = fragments < botCost;
            upgradeRateBtn.disabled = fragments < rateCost || botLevel === 0; // Cant upgrade rate with 0 bots
        }

        function gameLoop() {
            fragments += totalBotRate * (100 / 1000); // Update based on interval (100ms)
            updateGameDisplay();
        }

        function clickCore() {
            fragments += clickPower;
            updateGameDisplay();
            // Simple visual feedback
            coreButton.style.transform = 'scale(0.95)';
            setTimeout(() => { coreButton.style.transform = 'scale(1)'; }, 80);
        }

        function buyUpgrade(type) {
            switch (type) {
                case 'click':
                    if (fragments >= clickCost) {
                        fragments -= clickCost;
                        clickLevel++;
                        clickPower = Math.pow(1.15, clickLevel - 1).toFixed(1) * 1 + 1; // Exponential scaling
                        clickCost *= 1.25; // Increase cost
                    }
                    break;
                case 'bot':
                     if (fragments >= botCost) {
                         fragments -= botCost;
                         botLevel++;
                         botCost *= 1.35; // Bots get expensive faster
                    }
                    break;
                case 'rate':
                    if (fragments >= rateCost && botLevel > 0) {
                        fragments -= rateCost;
                        rateLevel++;
                        // Bot rate per bot increase could be linear or slightly exponential
                        // ratePerBot *= 1.1; // Example if rate itself scaled
                        rateCost *= 1.4;
                    }
                    break;
            }
            updateGameDisplay(); // Update UI after purchase
        }

        function resetGame() {
            fragments = 0;
            clickLevel = 1;
            botLevel = 0;
            rateLevel = 1;
            clickPower = 1;
            botCount = 0;
            botRatePerBot = 0.1;
            totalBotRate = 0;
            clickCost = 10;
            botCost = 50;
            rateCost = 100;
            updateGameDisplay(); // Reset display to initial values
        }

        function startGame() {
            resetGame();
            if (gameInterval) clearInterval(gameInterval); // Clear any existing interval
            gameInterval = setInterval(gameLoop, 100); // Run game logic 10 times/sec
            modalLoadingIndicator.classList.add('active'); // Show the loading overlay (with game)
        }

        function stopGame() {
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = null;
            modalLoadingIndicator.classList.remove('active'); // Hide loading overlay
        }


        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             // Dynamic System Prompt for Chat
             const systemPromptToUse = isChat && currentItemTitle
                 ? chatApiConfig.systemPrompt.replace('[CURRENT_ITEM_TITLE]', currentItemTitle)
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text (Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) // Comunicaciones con el Archivo Central interrumpidas. Congestión de red detectada. Reintentar en breve. //`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("// Respuesta del Archivo Central vacía o corrupta. Posible error de índice. //");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`// Tiempo de conexión excedido (>${config.timeoutSeconds}s). Fallo de enlace con el Archivo. Verifique conexión o reintente más tarde. //`);
                 throw new Error(error.message || "// Error desconocido durante la transmisión de datos. //");
             }
        }
        // Wrappers
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentItemTitle) throw new Error("// Error de Contexto: Registro de chat no inicializado. //"); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() { // Fetch 40 titles
             const randomTheme = getRandomElement(robotUniverseThemes) || "entidades robóticas generales";
             const specificPrompt = `Genera 40 nombres/conceptos del universo robot sobre ${randomTheme}`;
             console.log("Generating 40 titles with prompt:", specificPrompt);
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 10) throw new Error("// IA no pudo generar suficientes índices nuevos. //"); // Less strict check for 40
                     return titles.slice(0, 40); // Return up to 40
                 });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "robot dominated universe concept art";
             const enhancedPrompt = `Concept art depicting '${safePromptText}' in a robot-dominated universe. Metallic textures, circuits, potentially desolate organic ruins, energy glows. High detail, cinematic sci-fi aesthetic. Avoid text, labels, diagrams.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, cute robot, cartoon, simple background, organic life forms unless ruins, bright sunny day";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting ========== (No changes needed)
        function formatExplanationText(rawText) { /* ... as before ... */ if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted; }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            stopGame(); // Ensure game stops when modal closes
            resetModalState();
        }
        function resetModalState() {
             // No longer hide/show #modal-loading here, game logic handles its 'active' class
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentItemTitle = null;
             hideFullscreenImage();
             // Don't reset game here, reset happens on startGame()
        }

        // ========== FULLSCREEN IMAGE ========== (No changes needed)
        function showFullscreenImage(imgSrc) { /* ... as before ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... as before ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (No changes needed, uses updated API call)
        function addChatMessage(message, sender) { /* ... as before ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... as before ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... as before ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`// SCC-9 Error: ${error.message} //`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... as before ... */ let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { /* ... as before ... */ const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... as before ... */ if (!titleListContainer || !titlesLoading) return; const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none'; if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">>> Archivo Central Vacío o Inaccesible <<</p>'; return; } sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { /* ... as before ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title)); newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } }); filterTitles(searchInput.value); }

        // *** MODIFIED: handleTitleClick to start/stop game ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = `Registro: ${title}`; // Update title format
            currentItemTitle = title;
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalStoryContentArea.classList.add('content-hidden'); // Hide content area initially

            startGame(); // <<<<<< START MINIGAME HERE

            try {
                // Fetch text and image in parallel? Might be slightly faster.
                const textPromise = fetchExplanationText(title);
                const imageUrl = createPollinationsImageUrl(title); // Generate URL sync

                const rawExplanationText = await textPromise; // Wait for text
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // Stop game *after* main text is fetched
                stopGame(); // <<<<<< STOP MINIGAME HERE

                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Show content area NOW
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Image handling (starts loading while game was running)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-robot placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando visualización...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización: ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">// Fallo de renderizado visual //</p>`; };

                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">// Error URL Visualización //</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                stopGame(); // <<<<<< STOP MINIGAME ON ERROR TOO
                modalErrorMessage.textContent = error.message || "// Error Crítico de Recuperación de Registro. //";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Solicitando Batch de Datos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Function now fetches 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("// No se pudieron recuperar índices adicionales del Archivo. //"); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`// Error de Transmisión: ${error.message} //`);
             } finally {
                 generateMoreBtn.disabled = false;
                  generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Solicitar +40 Registros Adicionales';
             }
         }

         // Search Filter Function (No changes needed)
         function filterTitles(searchTerm) { /* ... as before ... */ const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); const titleItems = titleListContainer.querySelectorAll('.title-item'); let visibleCount = 0; titleItems.forEach(item => { const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const isVisible = titleText.includes(term); item.classList.toggle('hidden', !isVisible); if (isVisible) visibleCount++; }); noResultsMsg.classList.toggle('hidden', visibleCount > 0); }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Ensure all elements exist
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !coreButton || !upgradeClickBtn || !upgradeBotBtn || !upgradeRateBtn) {
                console.error("Initialization failed: Missing essential elements (incl. minigame elements).");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">++ FATAL SYSTEM ERROR: UI INTEGRITY COMPROMISED ++ CORE COMPONENTS MISSING ++</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Minigame Listeners
            coreButton.addEventListener('click', clickCore);
            upgradeClickBtn.addEventListener('click', () => buyUpgrade('click'));
            upgradeBotBtn.addEventListener('click', () => buyUpgrade('bot'));
            upgradeRateBtn.addEventListener('click', () => buyUpgrade('rate'));

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            resetGame(); // Initialize game display values
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>