<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecos del Vacío - Horror Existencial Interactivo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes - Una legible pero fría, otra más inquietante opcional -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&family=Special+Elite&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Horror Existencial --- */
        :root {
            --color-primary: #8a8a8a; /* Gris Medio Desolador */
            --color-secondary: #4b0082; /* Indigo Profundo/Vacío */
            --color-tertiary: #b3b3b3; /* Gris Claro/Estático */
            --color-background: #101018; /* Casi Negro Azulado */
            --color-text: #c5c5d0; /* Gris Azulado Pálido */
            --color-text-muted: #707080; /* Gris Más Oscuro */
            --color-modal-bg: #181824; /* Fondo Modal Más Oscuro */
            --color-border: #303040; /* Borde Gris Oscuro Azulado */
            --color-error-bg: #2a0808; /* Fondo error rojo muy oscuro */
            --color-error-text: #dcaaaa; /* Texto error pálido */
            --color-error-border: #8b0000; /* Borde error rojo oscuro */

            --shadow-sm: 0 1px 3px 0 rgba(138, 138, 138, 0.1), 0 1px 2px 0 rgba(138, 138, 138, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.16); /* Sombras más oscuras */
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            --border-radius: 2px; /* Bordes muy sutiles o inexistentes */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Roboto Condensed', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto Condensed', sans-serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); font-weight: 700; /* font-family: 'Special Elite', cursive; text-transform: uppercase; */ }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5rem; display: inline-block; font-weight: 400; text-transform: uppercase; letter-spacing: 1px;}
        #modal-title { color: var(--color-primary); font-weight: 700; font-size: 1.7rem; }
        .navbar { background-color: rgba(16, 16, 24, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(24, 24, 36, 0.8); color: var(--color-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); transition: var(--transition-normal); font-family: 'Roboto Condensed'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: inset 0 1px 3px rgba(0,0,0,0.3), 0 0 0 2px rgba(138, 138, 138, 0.2); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Roboto Condensed'; font-size: 0.95rem; /* border-left: 2px solid transparent; */ }
        .title-item:hover { /* transform: translateY(-2px); */ box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-tertiary); background-color: #202030; /* border-left-color: var(--color-primary); */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-secondary); color: var(--color-text); padding: 0.7rem 1.4rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-family: 'Roboto Condensed', sans-serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-transform: uppercase; }
        #generate-more-btn:hover:not(:disabled) { background-color: #3a006a; border-color: var(--color-primary); color: var(--color-tertiary); box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; }
        #generate-more-btn .fa-sync-alt { } /* Spinner color default */

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(16, 16, 24, 0.95); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: transparent; border: none; /* border: 1px solid var(--color-border); */ border-radius: 50%; width: 36px; height: 36px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { color: var(--color-primary); transform: rotate(90deg); background-color: rgba(255,255,255,0.05);}
        /* Área de Contenido Principal */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 8px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-modal-bg);
        }
        #modal-content-area::-webkit-scrollbar { width: 6px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-modal-bg); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: 3px; }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-tertiary); font-weight: 700; }
        #modal-content em { color: var(--color-primary); font-style: italic; font-weight: 300; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto Condensed', sans-serif; margin-top: 2.1em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px dotted var(--color-border); padding-bottom: 0.4em; font-weight: 400; letter-spacing: 0.5px; }
        #modal-content h1 { font-size: 1.4em; font-weight: 700;}
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.1em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.0em; color: var(--color-text-muted); border-bottom: none; }
        /* Imagen y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1.5rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: var(--transition-normal); filter: grayscale(30%) brightness(90%); }
        #modal-content .final-image:hover { filter: grayscale(0%) brightness(100%); box-shadow: 0 0 10px rgba(138, 138, 138, 0.2); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1.5rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(55, 65, 81, 0.7); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1.2s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(16, 16, 24, 0.8); scroll-behavior: smooth; font-size: 0.95em;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(55, 65, 81, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 5px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(55, 65, 81, 0.5); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 3px; }
        .chat-message { margin-bottom: 0.7rem; padding: 0.5rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.45; border: 1px solid var(--color-border); }
        .user-message { background-color: var(--color-secondary); color: var(--color-text); margin-left: auto; text-align: right; font-weight: 400; border-color: var(--color-secondary);}
        .ai-message { background-color: #282834; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; border-color: var(--color-border);}
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.5rem 0.8rem; border: 1px solid var(--color-border); background-color: #202030; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Roboto Condensed'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); background-color: var(--color-modal-bg); }
        #chat-send-btn { padding: 0.5rem 0.9rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-tertiary); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(16, 16, 24, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 45px; height: 45px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.4s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.2rem; font-family: 'Roboto Condensed'; letter-spacing: 1px; text-transform: uppercase; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1rem 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Roboto Condensed'; font-size: 0.95em; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(16, 16, 24, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 1px solid var(--color-border); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { color: var(--color-primary); background-color: #202030; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="far fa-eye mr-3 opacity-70"></i> <!-- Icono ojo -->
                     Ecos del Vacío
                 </h1>
             </div>
             <span class="text-xs text-gray-500 font-sans tracking-wider uppercase">Una Exploración Interactiva del Horror Existencial</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">El Abismo Te Devuelve la Mirada</h1>
             <p class="text-lg text-gray-400 mb-8 max-w-3xl mx-auto font-light">Contempla escenarios de insignificancia cósmica, realidades fracturadas y la aplastante indiferencia del universo. Selecciona un concepto o busca tu propia desesperación.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar escenario, concepto, temor...">
             <i class="fas fa-search fa-sm"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-dead text-gray-600 mr-2"></i> <!-- Icono libro muerto/oculto -->
                 Índice de Terrores
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-base font-sans tracking-wider">Sintonizando con el vacío...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-base mt-4 hidden font-sans tracking-wider">» El vacío no devuelve eco para esa búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Sondear Nuevos Horrores
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Descendiendo...</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Reflexionando...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta al abismo...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-angle-right"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Concepto">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 opacity-80 text-gray-600 py-5 mt-12 border-t border-gray-800 font-sans">
          <div class="container mx-auto px-4 text-center text-xs">
              <p>Las descripciones son exploraciones ficticias del horror existencial generadas por IA.</p>
              <p class="mt-1">No representan posturas filosóficas definitivas ni realidades constatadas.</p>
              <p class="mt-2">© [Año Actual] Contemplación del Vacío</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Realidad y Percepción
            "La Falla en el Patrón", "Realidad Desincronizada", "El Mundo Detrás del Espejo", "Cuando los Sueños Sangran", "Texturas Equivocadas", "Percepción Astillada", "El Color Imposible", "Geometría No Euclidiana Cotidiana", "El Fallo de Carga del Mundo", "Recuerdos Implantados", "El Testigo Ignorado", "Ver lo Invisible", "La Conciencia Prestada", "El Bucle de Déjà Rêvé", "Paisajes Interiores Expuestos", "El Mapa Incorrecto", "La Erosión de la Causalidad", "Simulación con Fugas", "El Punto Ciego Universal", "Distorsión Sensorial Colectiva", "Realidad por Consenso Fallido", "El Eco de Acciones No Realizadas", "La Persistencia de lo Borrado", "Arquitectura Emocional", "El Despertar Dentro del Sueño", "Agujeros en la Lógica del Mundo", "La Tiranía de la Perspectiva", "Objetos con Conciencia Propia", "El Lenguaje que Deshace", "Física Consensual Rota", "El Velo Rasgado", "Memorias de Otros Universos", "El Cuerpo Como Prisión Perceptiva", "Cuando la Metáfora se Vuelve Literal", "La Trampa de la Narrativa", "El Ruido Blanco de la Existencia", "Entidades Hechas de Información Pura", "La Verdad Incomprensible", "Geografía Imposible", "El Síndrome del Miembro Fantasma Cósmico",
            // Identidad y Ser
            "El Duplicado Imperfecto", "Amnesia Selectiva del Alma", "Fusión de Conciencias Indeseada", "El Parásito de la Identidad", "Ser Nadie", "El Cuerpo Equivocado", "La Mente Colmena Rota", "Despertar Como Otro", "El Último Humano Original", "Fragmentación del Yo", "La Personalidad Sintética", "El Reflejo Autónomo", "Perderse en los Recuerdos Ajenos", "Obsolescencia Programada del Ser", "El Síndrome del Impostor Cósmico", "Reencarnación Forzada", "Conciencia sin Cuerpo", "El Eco de Quien Fuiste", "La Identidad Como Enfermedad", "Mutación Existencial", "El Vacío Interior Literalizado", "El Otro en el Espejo", "La Construcción Social del Yo Desmoronada", "ADN Emocional Heredado", "Posesión Conceptual", "El Diario de un Desconocido (Tu Diario)", "La Máscara Permanente", "Ser un Personaje Secundario en tu Vida", "Conciencia Colectiva Forzada", "El Pasajero en tu Propia Mente", "La Incapacidad de Morir", "El Experimento de Identidad Fallido", "La Carga de la Empatía Absoluta", "Memorias que No Son Tuyas", "El Miedo a Dejar de Ser", "El Rostro Bajo el Rostro", "El Clon Degenerado", "La Conciencia Residual", "El Archivo Dañado del Yo", "Despersonalización Crónica Ambiental",
            // Espacio y Cósmico
            "El Silencio de las Estrellas Muertas", "La Vasteda Inhabitable", "Deriva en el Vacío Infinito", "El Color del Espacio Profundo (Indiferencia)", "Geometría Cósmica Hostil", "Entidades Más Allá de la Comprensión", "El Universo Indiferente", "La Última Luz del Universo", "Planetas Biblioteca Olvidados", "Navegando por la Nada", "El Dios Muerto en el Centro del Cosmos", "La Llamada del Vacío", "Seres de Energía Oscura", "Polvo Cósmico Consciente", "El Fin de la Física Conocida", "La Paradoja de Fermi Encarnada", "Civilizaciones Nacidas Muertas", "El Eco del Big Bang (Grito)", "Observadores Cósmicos Apatéticos", "La Enfermedad del Espacio-Tiempo", "Mundos Devorados por la Nada", "El Laberinto de Dimensiones Muertas", "La Belleza Terrible del Caos Cósmico", "Asteroides con Recuerdos", "La Música Inaudible de las Esferas (Disonancia)", "El Último Pensamiento del Universo", "Seres Que Existen Entre Momentos", "La Textura del Vacío", "El Océano Cósmico de la Posibilidad Muerta", "Reliquias de Creaciones Fallidas", "Mensajes Cósmicos Sin Sentido", "La Gravedad Como Conciencia Hostil", "Agujeros Negros Hambrientos de Información", "El Nacimiento Traumático de un Universo", "La Cuarentena Cósmica", "El Sol Negro de la Entropía", "Canibalismo Galáctico", "Planetas Prisión", "La Frontera Final (Es un Muro)", "El Jardín Cósmico Abandonado",
            // Tiempo y Existencia
            "El Bucle Temporal Personal", "La Erosión Lenta del Ser", "Atrapado en un Momento Roto", "El Futuro Inevitablemente Vacío", "El Pasado Cambiante", "Vivir Todas las Vidas Simultáneamente", "La Eternidad Como Castigo", "El Fin de la Historia (Literal)", "La Memoria del Tiempo Mismo", "Crononauta Perdido en la Nada", "La Descomposición Acelerada", "Inmortalidad Tediosa", "El Presente Eterno", "Ser Borrado de la Línea Temporal", "Paradojas Temporales Vivientes", "El Tiempo Como Depredador", "La Última Hora del Mundo", "Sentir el Peso de Cada Segundo", "El Eco de Futuros Muertos", "La Flecha del Tiempo Rota", "Existir Fuera del Tiempo", "La Biblioteca de los Días No Vividos", "El Museo del Fin del Mundo", "La Enfermedad de la Nostalgia Terminal", "Recordar el Futuro", "El Nacimiento Como Sentencia", "La Historia Repetida Como Farsa Cósmica", "Generaciones Perdidas en un Instante", "El Reloj Descompuesto del Universo", "La Espera Interminable", "Envejecimiento Inverso Incontrolable", "Atrapado en la Historia de Otro", "El Día Que Nunca Terminó", "La Carga de la Preciencia Absoluta", "El Momento Congelado", "La Conciencia Póstuma", "Rebobinar la Propia Existencia", "El Futuro Como un Espejo Roto", "La Velocidad del Tiempo Variable", "El Cementerio de Momentos",
            // Sociedad y Humanidad
            "La Ciudad Silenciosa", "El Último Humano", "Conformidad Absoluta", "La Utopía Podrida", "Comunicación Imposible", "La Sociedad de los Ojos Cerrados", "El Colapso de la Empatía", "Aislamiento Colectivo", "La Megalópolis Devoradora", "Rituales Sin Sentido", "El Lenguaje Perdido", "La Masa Solitaria", "Humanidad Reducida a Datos", "El Culto de la Nada", "La Oficina Infinita", "La Familia Perfectamente Vacía", "Autómatas Emocionales", "El Panóptico Interior", "La Plaga de la Apatía", "Tradiciones Mortales", "El Arte Incomprensible", "La Burocracia Cósmica", "El Entretenimiento Final (Absorción)", "La Red Social de los Muertos", "El Mercado de Experiencias Robadas", "La Guerra Silenciosa", "El Enemigo Invisible (La Indiferencia)", "La Historia Oficial Falsa", "Perdidos en la Traducción Existencial", "La Biblioteca de Babel (Horror)", "El Vecindario Idéntico Infinito", "La Celebración Obligatoria", "La Máquina Social Rota", "El Consenso Forzado", "La Moda Final (Uniformidad)", "La Música que Vacía", "Noticias del Fin del Sentido", "La Política de la Desesperación", "La Escuela de la Nada", "El Hospital de las Almas Perdidas",
            // Naturaleza y Decadencia
            "El Bosque que Observa", "La Podredumbre Consciente", "Naturaleza Indiferente a la Vida", "El Mar de la Melancolía", "Crecimiento Inverso", "Fósiles Vivientes (Horror)", "La Plaga Silenciosa", "El Desierto de la Realidad", "La Simbiosis Parasitaria Universal", "Evolución Hacia la Nada", "El Hongo Que Piensa (y Desespera)", "La Belleza Tóxica", "Animales con Ojos Humanos (Vacíos)", "El Jardín de la Decadencia", "El Clima Emocional", "La Montaña Imposible", "El Río del Olvido", "La Flor Carnívora de Sentidos", "La Geología del Sufrimiento", "Materia Orgánica Rebelde", "El Paisaje Que Recuerda", "El Árbol Genealógico Muerto", "La Cosecha Estéril", "El Viento Que Susurra Verdades Horribles", "El Sol Enfermo", "La Tierra Como Tumba", "La Infección de la Realidad", "La Metamorfosis Involuntaria", "El Ecosistema del Miedo", "La Putrefacción Como Forma de Arte", "El Instinto Equivocado", "La Criatura Hecha de Basura", "El Nido Vacío", "La Lluvia Ácida de Recuerdos", "El Invierno Eterno del Alma", "Fósiles del Futuro", "La Semilla de la Nada", "El Paisaje Sonoro del Silencio", "La Plaga de la Perfección", "La Extinción Como Destino Manifiesto",
             // Añadir más...
             "La Sombra de la Duda Cósmica", "El Peso de la Conciencia Infinita", "La Ironía Final", "El Chiste Cósmico Sin Gracia", "La Respuesta Que Destruye", "El Conocimiento Prohibido (Porque es Vacío)", "La Inutilidad de la Resistencia", "Aceptar el Absurdo (y Aterrarse)", "La Belleza de la Aniquilación", "El Refugio Falso", "La Esperanza Como Trampa", "El Último Acto de Rebeldía (Fútil)", "El Consuelo Frío de la Verdad", "La Pregunta Sin Respuesta", "El Silencio Final"
        ];
        const existentialHorrorThemes = [
            "realidad fragmentada", "pérdida de identidad", "vacío cósmico", "indiferencia universal", "geometría no euclidiana", "tiempo roto", "bucles temporales", "significado perdido", "soledad absoluta", "el fin de todo", "conciencia atrapada", "sueños y realidad", "memoria falsa", "observadores silenciosos", "la nada", "entropía final", "seres incomprensibles", "sociedad vacía", "decadencia inevitable", "naturaleza hostil/indiferente", "simulación fallida", "el absurdo", "inmortalidad como maldición", "el doble (doppelganger)", "transformación corporal horrenda"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral", // o un modelo más potente si es necesario para la sutileza
            systemPrompt: "Eres un cronista del abismo, un filósofo que contempla el horror existencial. Tu tarea es describir el escenario o concepto proporcionado. No te centres en sustos fáciles ni gore. Enfócate en la atmósfera opresiva, la sensación de insignificancia, la pérdida de sentido, la ruptura de la realidad o identidad, y la indiferencia cósmica. Explora las implicaciones filosóficas y psicológicas del horror. Utiliza un lenguaje evocador, melancólico, y profundamente inquietante. Describe por qué este escenario es aterrador desde una perspectiva existencial. Extiéndete hasta unas 1200-1300 palabras. Basa tu crónica únicamente en el siguiente concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Más rápido para chat
            systemPrompt: "Actúa como una IA reflexiva, una conciencia fragmentada que discute el escenario de horror existencial actual. Responde a preguntas sobre sus implicaciones, sentimientos asociados o detalles de la descripción. Mantén un tono introspectivo, quizás ambiguo o desesperanzado, siempre relevante al concepto central. Sé conciso.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de conceptos para historias de horror existencial. Genera exactamente 15 títulos o ideas cortas (2-7 palabras) que evoquen vacío, pérdida de realidad/identidad, insignificancia cósmica o desesperación filosófica. Devuelve *solo* la lista, una por línea. Sin números, guiones, introducciones o comentarios.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        // (IDs son los mismos que antes, no necesitan cambio)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Scrollable text area
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Text div
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentScenarioTitle = null; // Cambiado de currentWeaponTitle

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            // *** USA EL SYSTEM PROMPT DINÁMICO PARA CHAT ***
            const systemPromptToUse = isChat && currentScenarioTitle
                ? `Eres una IA reflexiva discutiendo el concepto de horror existencial '${currentScenarioTitle}'. Responde preguntas sobre sus implicaciones o sentimientos asociados de forma concisa, introspectiva y relevante al tema.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text (Model: ${config.model}, Chat: ${isChat}, Prompt: ${prompt.substring(0,100)}...)`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    // *** MENSAJE DE ERROR AMIGABLE ***
                    throw new Error(`(Código ${response.status}) Nuestros sistemas están sobrecargados o la conexión falló. Por favor, inténtalo de nuevo en un momento.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("El vacío devolvió... silencio. La IA no generó respuesta. Intenta de nuevo.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión con el abismo se perdió (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                }
                throw new Error(error.message || "Una perturbación desconocida impidió la comunicación.");
            }
        }
        async function fetchExplanationText(scenarioTitle) { // Renombrado
            return fetchTextFromApi(scenarioTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentScenarioTitle) throw new Error("Error Interno: Contexto del escenario perdido en el vacío.");
            // El system prompt dinámico se aplica dentro de fetchTextFromApi
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(existentialHorrorThemes) || "horror existencial general";
            const specificPrompt = `Genera 15 conceptos/títulos breves de horror existencial sobre ${randomTheme}`;
            console.log("Generating titles with prompt:", specificPrompt);
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                .then(text => {
                    const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 80);
                    if (titles.length < 5) throw new Error("La IA no pudo concebir suficientes horrores nuevos.");
                    return titles.slice(0, 15);
                });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "abstract existential dread";
            // *** PROMPT DE IMAGEN ENFOCADO EN ATMÓSFERA Y SIMBOLISMO ***
            const enhancedPrompt = `Atmospheric concept art depicting '${safePromptText}'. Existential horror theme. Focus on vastness, emptiness, unsettling geometry, liminal spaces, lone figures dwarfed by environment, decay, or abstract representation of dread/meaninglessness. Use desaturated colors, deep shadows, fog. Style: digital painting, surreal, atmospheric. Avoid gore, jump scares, typical monsters, text, labels.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, cute, happy, hopeful, bright colors, clear sky, gore, blood, explicit monster";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL (Existential Horror):", url.substring(0, 300) + "...");
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (identica a la anterior) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll reset on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentScenarioTitle = null; // Limpia contexto
             hideFullscreenImage(); // Asegura que la imagen grande se oculte
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (identica a la anterior) ... */
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() { /* ... (identica a la anterior) ... */
             if (!imageFullscreenOverlay) return;
             const wasActive = imageFullscreenOverlay.classList.contains('active');
             imageFullscreenOverlay.classList.remove('active');
             if (wasActive && !storyModal.classList.contains('active')) {
                  document.body.style.overflow = '';
             }
             fullscreenImage.src = '';
         }

        // ========== CHAT FUNCTIONS ========== (sin cambios lógicos)
        function addChatMessage(message, sender) { /* ... (identica, usa clases CSS) ... */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        function addChatError(message) { /* ... (identica, usa clases CSS) ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... (identica, usa fetchChatResponse) ... */
             const userQuery = chatInput.value.trim();
             if (!userQuery || chatSendBtn.disabled) return;
             addChatMessage(userQuery, 'user');
             chatInput.value = '';
             chatSendBtn.disabled = true;
             chatLoadingIndicator.style.display = 'block';
             try {
                 const aiResponse = await fetchChatResponse(userQuery);
                 addChatMessage(aiResponse, 'ai');
             } catch (error) {
                 console.error("Chat Error:", error);
                 addChatError(`Vacío: ${error.message}`);
             } finally {
                 chatLoadingIndicator.style.display = 'none';
                 chatSendBtn.disabled = false;
                 chatInput.focus();
             }
         }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar puede ser menos relevante aquí, quizás aleatorio inicial? O alfabético está bien.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans tracking-wider">» El índice está en blanco «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to use scenarioTitle and theme-specific text ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentScenarioTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title); // Usa la función renombrada
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is visible
                console.log("Scroll reset after content visible");

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="far fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.8rem;">Visualizando el concepto...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => {
                        showFullscreenImage(imgElement.src);
                    });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.8rem;">La visualización se perdió en el vacío.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.8rem;">Error al generar URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Un error desconocido acecha.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden'); // Ocultar chat si falla la carga principal
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Sondeando...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("El vacío no ofreció nuevos horrores por ahora."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al sondear: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Sondear Nuevos Horrores';
             }
         }

         // *** Search Filter Function (sin cambios) ***
         function filterTitles(searchTerm) { /* ... (identica a la anterior) ... */
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (Sin cambios lógicos)
        function initApp() {
            // Check all essential elements exist
            const essentialElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, modalLoadingIndicator, modalStoryContentArea, modalTextArea, modalTitle, modalContent, modalError, modalErrorMessage, chatSection, chatHistory, chatLoadingIndicator, fullscreenImage];
            if (essentialElements.some(el => !el)) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: #8a8a8a; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: monospace;">// ERROR_CRITICO: Componentes de interfaz perdidos en el vacío //</p>';
                 return;
            }

            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Update footer year
            const footer = document.querySelector('footer p:last-child');
            if (footer) footer.textContent = `© ${new Date().getFullYear()} Contemplación del Vacío`;


            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>