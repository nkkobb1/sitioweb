<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civilizaciones de la Historia: Un Viaje Interactivo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes: Cinzel para títulos grandes, Merriweather/Lato para el resto -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Civilizaciones --- */
        :root {
            --color-primary: #8b4513; /* Marrón Silla de Montar (Tierra, Madera) */
            --color-secondary: #b8860b; /* DarkGoldenrod (Oro Antiguo, Valor) */
            --color-background: #f5f5dc; /* Beige (Pergamino, Arena) */
            --color-text: #4a3728; /* Marrón Oscuro (Tinta Sepia) */
            --color-text-muted: #8f7a66; /* Marrón Grisáceo */
            --color-modal-bg: #fff8dc; /* Cornsilk (Pergamino Claro) */
            --color-border: #d2b48c; /* Tan (Piedra Clara, Borde Pergamino) */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.1);
            --shadow-md: 0 3px 5px -1px rgb(0 0 0 / 0.12), 0 2px 3px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 8px 12px -3px rgb(0 0 0 / 0.15), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 5px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; }
        /* Títulos principales con fuente temática */
        h1.logo, h1.page-title { font-family: 'Cinzel', serif; font-weight: 700; color: var(--color-primary); letter-spacing: 1px; }
        h2.section-title, #modal-title { font-family: 'Merriweather', serif; font-weight: 700; }
        h2.section-title { color: var(--color-primary); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        #modal-title { color: var(--color-primary); }
        .navbar { background-color: rgba(245, 245, 220, 0.85); /* Fondo navbar semi-transparente beige */ backdrop-filter: blur(4px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }

        /* --- Search Input Styling --- */
        #search-container { margin-bottom: 2rem; position: relative; }
        #search-input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.5rem;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-normal);
            background-color: var(--color-modal-bg); /* Fondo claro para input */
            color: var(--color-text);
        }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.2);
        }
        #search-container .fa-search {
            position: absolute;
            left: 0.9rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-muted);
            pointer-events: none;
        }

        /* --- Title List Styling --- */
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Lato', sans-serif; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #fdf5e6; /* Old Lace hover */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-background); padding: 0.75rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #654321; /* Darker Brown */ box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #a08c79; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(74, 55, 40, 0.88); /* Overlay Marrón Oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 2rem 2.5rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 350px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--color-border);
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #eaddca; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.5rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: var(--color-border); color: #000; }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1.5rem; line-height: 1.3; }
        #modal-content { /* Scrollable content area */
            line-height: 1.8;
            color: var(--color-text);
            white-space: normal;
            overflow-y: auto;
            padding: 0 15px 1.5rem 15px;
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content::-webkit-scrollbar { width: 9px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: bold; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: #a0522d; } /* Sienna (complementary brown) */
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* --- Image within Content Styling --- */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2rem auto 1rem auto; border: 2px solid var(--color-border); /* Borde más grueso */ border-radius: var(--border-radius); box-shadow: var(--shadow-md); padding: 4px; background-color: var(--color-background); /* Simula un marco */ }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(74, 55, 40, 0.1); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 248, 220, 0.97); /* Cornsilk bg */ display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.2rem; font-family: 'Lato'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fff0f0; color: #a02c2c; padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #f5c6cb; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
        #no-results-message { text-align: center; color: var(--color-text-muted); padding: 2rem; grid-column: 1 / -1; font-style: italic; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-4 flex justify-center items-center">
             <div class="flex items-center text-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-landmark mr-3 text-yellow-700"></i> <!-- Icono monumento -->
                     Civilizaciones de la Historia
                     <i class="fas fa-scroll ml-3 text-green-800"></i> <!-- Icono pergamino -->
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-10 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Un Viaje a Través del Tiempo</h1>
             <p class="text-xl text-gray-700 mb-6 max-w-3xl mx-auto">Explora los grandes imperios, culturas y sociedades que moldearon nuestro mundo. Busca una civilización o selecciona una de la lista para descubrir sus secretos.</p>
             <!-- Search Input -->
             <div id="search-container" class="max-w-2xl mx-auto">
                 <i class="fas fa-search"></i>
                 <input type="text" id="search-input" placeholder="Buscar civilización, imperio, cultura...">
             </div>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-hourglass-half text-blue-800 mr-2"></i> <!-- Icono reloj arena -->
                 Anales de la Humanidad
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Desenterrando archivos...</p>
                  <!-- No results message will be injected here by JS -->
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Invocar Más Civilizaciones
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Consultando los anales...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - Image appended here -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                     <!-- Image and placeholder will be appended here by JS -->
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-600 py-6 mt-12 border-t border-gray-300">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Descripciones generadas por IA con fines educativos e informativos sobre la historia de las civilizaciones.</p>
              <p class="mt-1">La historia es compleja; consulte fuentes académicas para estudios profundos.</p>
              <p class="mt-2">© 2025 Archivos Históricos Digitales</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
             // MESOPOTAMIA & LEVANTE
            "Civilización Sumeria (Mesopotamia)", "Imperio Acadio (Mesopotamia)", "Imperio Babilónico (Antiguo y Neobabilónico)", "Imperio Asirio (Antiguo, Medio y Neoasirio)", "Civilización Hitita (Anatolia)", "Civilización Fenicia (Levante)", "Reino de Israel y Judá (Antiguo)", "Civilización Elamita (Mesopotamia/Irán)", "Civilización Hurrita (Mesopotamia/Siria)", "Reino de Mitanni (Mesopotamia/Siria)", "Reino de Urartu (Armenia/Anatolia)", "Civilización Amorrea (Mesopotamia/Siria)", "Civilización Cananea (Levante)", "Filisteos (Levante)", "Reino de Ebla (Siria)", "Mari (Ciudad-Estado Siria)", "Ugarit (Ciudad-Estado Siria)",
            // EGIPTO ANTIGUO
            "Periodo Predinástico de Egipto", "Periodo Arcaico de Egipto (Dinastías I-II)", "Reino Antiguo de Egipto (Pirámides)", "Primer Periodo Intermedio de Egipto", "Reino Medio de Egipto", "Segundo Periodo Intermedio de Egipto (Hicsos)", "Reino Nuevo de Egipto (Imperio Egipcio)", "Tercer Periodo Intermedio de Egipto", "Periodo Tardío de Egipto (Baja Época)", "Periodo Helenístico de Egipto (Ptolemaico)", "Egipto Romano (Provincia Romana)", "Reino de Kush (Nubia)", "Reino de Meroe (Nubia)",
            // GRECIA ANTIGUA
            "Civilización Minoica (Creta)", "Civilización Micénica (Grecia Continental)", "Edad Oscura Griega", "Periodo Arcaico Griego (Polis)", "Atenas Clásica (Democracia)", "Esparta Clásica (Militarismo)", "Liga de Delos", "Liga del Peloponeso", "Guerras Médicas (Grecia vs. Persia)", "Guerra del Peloponeso (Atenas vs. Esparta)", "Macedonia (Reino de Filipo II y Alejandro Magno)", "Imperio de Alejandro Magno", "Periodo Helenístico (Tras Alejandro)", "Reino Seléucida (Helenístico)", "Reino Ptolemaico (Helenístico - Egipto)", "Reino Antigónida (Helenístico - Macedonia)", "Reino de Pérgamo (Helenístico)", "Reino Grecorbactriano (Asia Central)", "Reino Indogriego (India/Pakistán)",
            // ROMA ANTIGUA
            "Civilización Etrusca (Italia)", "Monarquía Romana", "República Romana", "Guerras Púnicas (Roma vs. Cartago)", "Imperio Romano (Principado)", "Imperio Romano (Dominado)", "Imperio Romano de Occidente (Caída)", "Imperio Romano de Oriente (Bizantino)", "Civilización Cartaginesa (Norte de África)",
            // PERSIA ANTIGUA Y MEDIO ORIENTE
            "Imperio Medo (Irán)", "Imperio Aqueménida (Persia)", "Imperio Parto (Persia)", "Imperio Sasánida (Persia)", "Reino de Lidia (Anatolia)", "Reino de Frigia (Anatolia)", "Reino Nabateo (Petra)", "Reino de Palmira (Siria)",
            // ASIA CENTRAL Y ESTEPAS
            "Civilización del Oxus (BMAC - Asia Central)", "Cultura Andrónovo (Estepa Euroasiática)", "Escitas (Estepa Euroasiática)", "Sármatas (Estepa Euroasiática)", "Imperio Xiongnu (Mongolia/China)", "Imperio Kushán (Asia Central/India)", "Imperio Heftalita (Hunos Blancos)", "Imperio Göktürk (Primer y Segundo)", "Imperio Uigur (Mongolia/China)", "Jázaros (Europa Oriental/Asia Central)", "Imperio Huno (Atila)", "Imperio Mongol (Gengis Kan)", "Horda de Oro (Mongol)", "Ilkanato (Mongol - Persia)", "Dinastía Yuan (Mongol - China)", "Kanato de Chagatai (Mongol)", "Imperio Timúrida (Tamerlán)",
            // INDIA ANTIGUA Y MEDIEVAL
            "Civilización del Valle del Indo (Harappa)", "Periodo Védico (India)", "Imperio Maurya (Ashoka)", "Imperio Gupta (Edad de Oro India)", "Imperio Shunga (India)", "Reino Satavahana (India)", "Imperio Pala (India Oriental)", "Imperio Pratihara (India del Norte)", "Dinastía Chola (Sur de India/Sudeste Asiático)", "Imperio Vijayanagara (Sur de India)", "Sultanato de Delhi (India)", "Imperio Mogol (India)",
            // CHINA ANTIGUA Y MEDIEVAL
            "Cultura Yangshao (Neolítico Chino)", "Cultura Longshan (Neolítico Chino)", "Dinastía Xia (Legendaria/Temprana)", "Dinastía Shang (Edad de Bronce China)", "Dinastía Zhou (Occidental y Oriental)", "Periodo de Primaveras y Otoños (China)", "Periodo de los Reinos Combatientes (China)", "Dinastía Qin (Primer Emperador)", "Dinastía Han (Occidental y Oriental)", "Periodo de los Tres Reinos (China)", "Dinastía Jin (China)", "Dinastías Meridionales y Septentrionales (China)", "Dinastía Sui (Reunificación)", "Dinastía Tang (Edad de Oro China)", "Periodo de las Cinco Dinastías y Diez Reinos (China)", "Dinastía Song (Norte y Sur)", "Dinastía Liao (Kitán)", "Dinastía Jin (Jurchen)", "Dinastía Xia Occidental (Tangut)", "Dinastía Yuan (Mongol)", "Dinastía Ming (China)", "Dinastía Qing (Manchú)",
            // JAPÓN Y COREA
            "Periodo Jōmon (Japón Prehistórico)", "Periodo Yayoi (Japón)", "Periodo Kofun (Japón)", "Periodo Asuka (Japón)", "Periodo Nara (Japón)", "Periodo Heian (Japón)", "Shogunato Kamakura (Japón)", "Shogunato Ashikaga (Muromachi - Japón)", "Periodo Sengoku (Estados en Guerra - Japón)", "Shogunato Tokugawa (Edo - Japón)", "Gojoseon (Corea Antigua)", "Periodo de los Tres Reinos de Corea (Goguryeo, Baekje, Silla)", "Silla Unificada (Corea)", "Balhae (Norte de Corea/Manchuria)", "Dinastía Goryeo (Corea)", "Dinastía Joseon (Corea)",
            // SUDESTE ASIÁTICO
            "Cultura Dong Son (Vietnam - Tambores de bronce)", "Reino de Funan (Camboya/Vietnam)", "Reino de Chenla (Camboya)", "Imperio Jemer (Angkor Wat - Camboya)", "Reino de Champa (Vietnam)", "Reino de Srivijaya (Indonesia/Malasia)", "Dinastía Sailendra (Java - Borobudur)", "Reino de Medang (Mataram - Java)", "Reino de Singhasari (Java)", "Imperio Majapahit (Indonesia)", "Reino de Ayutthaya (Tailandia)", "Reino de Sukhothai (Tailandia)", "Reinos Malayos Tempranos (Península Malaya)", "Reino de Pagan (Birmania)",
            // AMÉRICA PRECOLOMBINA (MESOAMÉRICA)
            "Civilización Olmeca (México)", "Civilización Zapoteca (Monte Albán - México)", "Civilización Teotihuacana (México)", "Civilización Maya Clásica (México/Guatemala/Belice/Honduras)", "Civilización Tolteca (Tula - México)", "Imperio Azteca (Triple Alianza - México)", "Civilización Mixteca (Oaxaca - México)", "Civilización Totonaca (El Tajín - México)", "Cultura de Occidente de México (Tumbas de Tiro)", "Purépechas (Tarascos - Michoacán)",
            // AMÉRICA PRECOLOMBINA (ANDES)
            "Civilización Caral-Supe (Norte Chico - Perú)", "Cultura Chavín (Perú)", "Cultura Paracas (Perú)", "Cultura Nazca (Líneas de Nazca - Perú)", "Cultura Moche (Mochica - Perú)", "Estado Wari (Huari - Perú)", "Estado Tiahuanaco (Tiwanaku - Bolivia/Perú)", "Reino Chimú (Chan Chan - Perú)", "Imperio Inca (Tawantinsuyu - Andes)", "Cultura Chachapoyas (Kuélap - Perú)", "Cultura Valdivia (Ecuador)", "Cultura San Agustín (Colombia)", "Cultura Tierradentro (Colombia)", "Muiscas (Confederación Muisca - Colombia)", "Taironas (Ciudad Perdida - Colombia)",
            // AMÉRICA PRECOLOMBINA (NORTEAMÉRICA)
            "Cultura Clovis (Paleoamericanos)", "Cultura Folsom (Paleoamericanos)", "Tradición Arcaica (Norteamérica)", "Culturas Adena y Hopewell (Constructores de Montículos - Este USA)", "Cultura Misisippiana (Cahokia - Constructores de Montículos)", "Cultura Anasazi (Ancestral Puebloans - Sudoeste USA)", "Cultura Hohokam (Sudoeste USA)", "Cultura Mogollon (Sudoeste USA)", "Culturas de la Costa Noroeste del Pacífico (Tótems)", "Culturas de las Grandes Llanuras (Pre-Caballo)", "Culturas Árticas (Inuit, Yupik, Aleut)",
            // ÁFRICA SUBSAHARIANA (MÁS ALLÁ DE KUSH/EGIPTO)
            "Cultura Nok (Nigeria - Terracotas)", "Reino de Aksum (Etiopía/Eritrea)", "Imperio de Ghana (África Occidental)", "Imperio de Malí (Mansa Musa - África Occidental)", "Imperio Songhai (África Occidental)", "Reinos Hausa (Nigeria/Níger)", "Imperio de Benín (Nigeria - Bronces)", "Reino de Oyo (Yoruba - Nigeria)", "Imperio Kanem-Bornu (Chad/Nigeria)", "Reino del Congo (África Central)", "Reino de Luba (África Central)", "Reino de Lunda (África Central)", "Gran Zimbabue (África Austral)", "Reino de Mutapa (Zimbabue/Mozambique)", "Reinos Suajili (Costa de África Oriental)", "Imperio Etíope (Salomónico)",
            // EUROPA MEDIEVAL Y RENACENTISTA
            "Reinos Anglosajones (Inglaterra)", "Reino Franco (Merovingios, Carolingios)", "Imperio Carolingio (Carlomagno)", "Francia Occidental y Oriental (Post-Carolingio)", "Reino de Inglaterra (Normandos, Plantagenet, Lancaster, York, Tudor)", "Reino de Escocia", "Reino de Francia (Capetos, Valois, Borbones)", "Sacro Imperio Romano Germánico", "Reinos Visigodos (Hispania/Galia)", "Reino Ostrogodo (Italia)", "Reino Vándalo (Norte de África)", "Reino Lombardo (Italia)", "Rus de Kiev (Europa Oriental)", "Principado de Moscú / Zarato Ruso", "Reino de Polonia (Piast, Jagiellon)", "Gran Ducado de Lituania", "Mancomunidad Polaco-Lituana", "Reino de Hungría", "Reinos de Bohemia", "Reino de Bulgaria (Primer y Segundo Imperio)", "Imperio Serbio", "Estado Monástico de los Caballeros Teutónicos", "República de Venecia", "República de Génova", "Estados Pontificios", "Reino de Sicilia (Normando)", "Reinos de León, Castilla, Aragón, Portugal (Reconquista)", "Imperio Español (Habsburgo, Borbones)", "Imperio Portugués", "Monarquía Habsburgo (Austria)", "Reino de Dinamarca, Noruega, Suecia (Unión de Kalmar)", "Imperio Sueco",
            // CIVILIZACIONES ISLÁMICAS
            "Califato Rashidun (Primeros Califas)", "Califato Omeya (Damasco, Córdoba)", "Califato Abasí (Bagdad)", "Emirato/Califato de Córdoba (Al-Ándalus)", "Reinos de Taifas (Al-Ándalus)", "Imperio Almorávide (Norte de África/Al-Ándalus)", "Imperio Almohade (Norte de África/Al-Ándalus)", "Sultanato Mameluco (Egipto/Siria)", "Califato Fatimí (Norte de África/Egipto)", "Imperio Selyúcida (Turco - Medio Oriente)", "Sultanato de Rum (Selyúcida - Anatolia)", "Imperio Otomano (Turco)", "Imperio Safávida (Persia - Chiita)", "Dinastías Bereberes (Ziríes, Hammadíes)", "Kanato de Crimea (Tártaro)",
            // ERA MODERNA Y CONCEPTOS
            "Imperio Británico", "Imperio Colonial Francés", "Imperio Neerlandés", "Imperio Ruso", "Imperio Austrohúngaro", "Imperio Alemán (Segundo Reich)", "Imperio del Japón (Meiji en adelante)", "Estados Unidos (Como civilización/poder)", "Unión Soviética (URSS)", "La Ilustración (Movimiento intelectual)", "La Revolución Industrial", "Civilización Occidental (Concepto)", "El Renacimiento Europeo", "La Reforma Protestante", "La Contrarreforma", "La Era de los Descubrimientos", "El Mercantilismo", "El Colonialismo", "El Imperialismo", "La Globalización", "El Mundo Islámico (Concepto cultural/religioso)", "Civilización China (Continuidad y cambios)", "Civilización India (Continuidad y cambios)", "Civilización Mesoamericana (Legado)", "Civilización Andina (Legado)", "La Diáspora Africana", "Culturas Indígenas Contemporáneas", "La Sociedad de la Información / Era Digital"
        ];
        const historyThemes = [ // Temas para generar más títulos
            "civilizaciones de Mesopotamia", "imperios del Antiguo Egipto", "polis de la Antigua Grecia", "la República y el Imperio Romano", "dinastías de China", "imperios precolombinos de los Andes", "culturas de Mesoamérica", "reinos del África subsahariana", "imperios de la India", "civilizaciones de la Edad del Bronce", "imperios de la Edad del Hierro", "califatos islámicos", "reinos de la Europa Medieval", "imperios de las estepas asiáticas", "civilizaciones del Sudeste Asiático", "imperios coloniales europeos", "culturas nómadas históricas", "civilizaciones fluviales", "ciudades-estado históricas", "imperios marítimos", "periodos de transición histórica (Colapso Bronce, Edad Oscura)", "conceptos clave (Feudalismo, Renacimiento, Ilustración)", "legado de civilizaciones antiguas", "constructores de grandes monumentos", "rutas comerciales históricas (Seda, Transahariana)"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un erudito historiador y antropólogo. Tu tarea es describir y analizar civilizaciones, imperios o culturas significativas de la historia mundial de forma rigurosa, detallada y accesible para estudiantes y entusiastas de la historia. Describe su ubicación geográfica y temporal, origen, organización social y política, economía, religión y cosmovisión, tecnología, arte y arquitectura notables, principales logros, interacciones con otras culturas, causas de su declive o transformación (si aplica) y su legado duradero. Utiliza un lenguaje claro y académico. El objetivo es un resumen enciclopédico de aproximadamente 1200-1300 palabras. Basa tu descripción únicamente en la siguiente civilización, imperio o cultura:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia de historia universal. Genera exactamente 15 nombres de civilizaciones, imperios, culturas o períodos históricos clave, adecuados para ser descritos en detalle. Devuelve *solo* la lista de nombres, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (sin cambios funcionales)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        let noResultsMessageElement = null;

        // ========== API FUNCTIONS ========== (sin cambios funcionales)
        async function fetchTextFromApi(prompt, config) { /* ... */
            const encodedPrompt = encodeURIComponent(prompt);
            const encodedSystem = encodeURIComponent(config.systemPrompt);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo.`);
                throw new Error(`Error de comunicación con la API: ${error.message}`);
            }
        }
        async function fetchExplanationText(conceptTitle) { /* ... */
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de")) {
                   throw new Error("La IA no pudo generar una descripción adecuada o suficientemente detallada para esta civilización.");
               }
             return text;
        }
        async function fetchGeneratedTitles() { /* ... */
            const randomTheme = getRandomElement(historyThemes) || "civilizaciones importantes de la historia";
            const specificPrompt = `Genera 15 nombres de civilizaciones, imperios o culturas sobre ${randomTheme}`;
            console.log("Generating titles with prompt:", specificPrompt);
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
            const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 100);
            if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas.");
            return titles.slice(0, 15);
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a CIVILIZACIONES
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText.split('(')[0].trim() : "ancient civilization concept"; // Extract main name
            // Prompt ENFOCADO en atmósfera, arte, arquitectura, paisaje
            const enhancedPrompt = `Artistic representation evoking the spirit and essence of the '${safePromptText}'. Focus on characteristic art style, architecture, iconic landmarks, or symbolic landscape. Atmospheric lighting, historical feel. Avoid text, maps, or modern elements. Oil painting or detailed illustration style.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, map, diagram, chart, UI, interface, signature, watermark, multiple panels, collage, screenshot, photograph, modern clothing, modern technology, cartoon, simple drawing";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios funcionales)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h')) return block;
                 let content = block.replace(/\n/g, '<br>');
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (sin cambios funcionales)
        function showModal() { /* ... */ if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { /* ... */
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() { /* ... */
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (sin cambios funcionales, excepto textos)
        function getRandomElement(arr) { /* ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... */
            if (!titleListContainer || !titlesLoading) return;
            const shuffledTitles = shuffleArray([...titles]);
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (shuffledTitles.length === 0) {
                showNoResultsMessage("No hay civilizaciones iniciales disponibles en los archivos.");
                return;
            }
            shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
            filterTitles();
         }
        function appendTitles(newTitles) { /* ... */
            if (!titleListContainer || !newTitles || newTitles.length === 0) return;
            const searchTerm = searchInput.value.toLowerCase().trim();
            newTitles.forEach(title => {
                const item = createTitleItem(title);
                if (searchTerm === '' || title.toLowerCase().includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
                titleListContainer.appendChild(item);
            });
            checkIfAnyResultsVisible();
        }
        function filterTitles() { /* ... */
            if (!searchInput || !titleListContainer) return;
            const searchTerm = searchInput.value.toLowerCase().trim();
            const titleItems = titleListContainer.querySelectorAll('.title-item');
            let visibleCount = 0;
            titleItems.forEach(item => {
                const title = item.textContent.toLowerCase();
                if (title.includes(searchTerm)) {
                    item.style.display = 'flex';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            updateNoResultsMessage(visibleCount);
        }
        function updateNoResultsMessage(visibleCount) { /* ... */
             if (!titleListContainer) return;
             if (noResultsMessageElement) {
                 noResultsMessageElement.remove();
                 noResultsMessageElement = null;
             }
             if (visibleCount === 0 && titleListContainer.children.length > 0 && titlesLoading.style.display === 'none') {
                 showNoResultsMessage(`No se encontraron registros para "${searchInput.value}"`);
             }
        }
        function showNoResultsMessage(message) { /* ... */
             if (noResultsMessageElement || !titleListContainer) return;
             noResultsMessageElement = document.createElement('p');
             noResultsMessageElement.id = 'no-results-message';
             noResultsMessageElement.textContent = message;
             titleListContainer.appendChild(noResultsMessageElement);
        }
        function checkIfAnyResultsVisible() { /* ... */
             const visibleItems = titleListContainer.querySelectorAll('.title-item[style*="display: flex"], .title-item:not([style*="display: none"])');
             updateNoResultsMessage(visibleItems.length);
         }
        async function handleTitleClick(title) { /* ... (Image logic remains the same) ... */
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalContent.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-palette placeholder-icon"></i> <!-- Themed icon -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Recreando visión artística...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación artística de ${title.split('(')[0].trim()}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">No se pudo recrear la imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Error al generar URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
            }
        }
        async function handleGenerateMoreTitles() { /* ... (Text changes only) ... */
             if (!generateMoreBtn || !generateMoreContainer) return;
             const spinner = generateMoreBtn.querySelector('i');
             generateMoreBtn.disabled = true;
             if(spinner) spinner.classList.remove('hidden');
             generateMoreBtn.childNodes[generateMoreBtn.childNodes.length - 1].nodeValue = " Consultando archivos...";

             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se encontraron más registros en los archivos."); }
             } catch (error) { console.error("Failed title generation:", error); alert(`Error al consultar archivos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 if(spinner) spinner.classList.add('hidden');
                 generateMoreBtn.childNodes[generateMoreBtn.childNodes.length - 1].nodeValue = " Invocar Más Civilizaciones";
                 checkIfAnyResultsVisible();
             }
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput) { console.error("Init fail."); document.body.innerHTML = '<p style="color: #8b0000; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Catastrófico: ¡Los archivos de la historia están corruptos!</p>'; return; } // Thematic error
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            searchInput.addEventListener('input', filterTitles);
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>