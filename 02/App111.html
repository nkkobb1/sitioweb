<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía de Primeros Auxilios - Nivel Medio</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Primeros Auxilios --- */
        :root {
            --color-primary: #0d6efd; /* Azul confiable */
            --color-secondary: #dc3545; /* Rojo alerta (usar con moderación) */
            --color-success: #198754; /* Verde éxito/seguridad */
            --color-background: #f8f9fa; /* Gris muy claro/Blanco roto */
            --color-text: #212529; /* Negro suave */
            --color-text-muted: #6c757d; /* Gris medio */
            --color-modal-bg: #ffffff; /* Blanco limpio */
            --color-border: #dee2e6; /* Gris claro para bordes */
            --shadow-sm: 0 .125rem .25rem rgba(0,0,0,.075);
            --shadow-md: 0 .5rem 1rem rgba(0,0,0,.15);
            --shadow-lg: 0 1rem 3rem rgba(0,0,0,.175);
            --border-radius: 0.375rem; /* Bootstrap default */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto Slab', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.5rem; display: inline-block; }
        #modal-title { color: var(--color-primary); }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }

        /* --- Search Input Styling --- */
        #search-container { margin-bottom: 2rem; position: relative; }
        #search-input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.7rem; /* More padding for icon */
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-normal);
        }
        #search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); /* Bootstrap focus shadow */
        }
        #search-container .fa-search {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-muted);
            pointer-events: none;
        }

        /* --- Title List Styling --- */
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1rem 1.25rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Align text left for readability */ font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Lato', sans-serif; }
        .title-item i { margin-right: 0.75rem; color: var(--color-primary); width: 20px; text-align: center;} /* Icon styling */
        .title-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #eef5ff; }
        /* Add icons based on keywords? Maybe too complex, stick to generic */

        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-success); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #157347; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.7; }
        #generate-more-btn .fa-sync-alt { color: white; }

        /* --- Modal Styling --- */
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(33, 37, 41, 0.8); /* Dark overlay */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem; /* Slightly less padding */
            max-width: 900px; /* Standard width */
            width: 95%;
            max-height: 90vh;
            min-height: 350px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            border: 1px solid #adb5bd;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 50%; width: 38px; height: 38px; font-size: 1.6rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; line-height: 1; }
        .modal-close-btn:hover { background-color: #e9ecef; color: #000; }
        #modal-title { font-size: 1.75rem; text-align: center; margin-bottom: 1.25rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }
        #modal-content { /* Scrollable content area */
            line-height: 1.75;
            color: var(--color-text);
            white-space: normal;
            overflow-y: auto;
            padding: 0 10px 1.5rem 10px; /* Padding bottom for image space */
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content::-webkit-scrollbar { width: 10px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.2em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { font-style: italic; color: #495057; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto Slab', serif; margin-top: 1.8em; margin-bottom: 0.8em; color: var(--color-primary); border-bottom: 1px solid #ced4da; padding-bottom: 0.3em; font-weight: bold; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: #0a58ca; } /* Darker blue */
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; }
        /* --- Styling for Warnings/Notes --- */
        #modal-content .warning, #modal-content .important {
             padding: 1rem 1.25rem;
             margin: 1.5em 0;
             border-left-width: 5px;
             border-left-style: solid;
             border-radius: var(--border-radius);
         }
        #modal-content .warning {
             background-color: #fff3cd;
             border-color: #ffc107; /* Yellow */
             color: #664d03;
         }
        #modal-content .important {
             background-color: #cfe2ff;
             border-color: var(--color-primary); /* Blue */
             color: #052c65;
         }
         #modal-content .warning strong, #modal-content .important strong {
             color: inherit; /* Use the text color of the box */
         }
         #modal-content .warning i, #modal-content .important i {
              margin-right: 0.6rem;
         }

        /* --- Image within Content Styling --- */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); background-color: #e9ecef; } /* Added subtle bg */
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* --- Loading & Error Styling --- */
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #ced4da; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.1rem; font-family: 'Lato'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #f8d7da; color: #842029; padding: 1rem 1.25rem; border-radius: var(--border-radius); border: 1px solid #f5c2c7; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
        #no-results-message { text-align: center; color: var(--color-text-muted); padding: 2rem; grid-column: 1 / -1; font-style: italic; } /* Message for no search results */

        /* --- Disclaimer Styling --- */
        .disclaimer {
            background-color: #fff3cd; color: #664d03; border: 1px solid #ffc107;
            padding: 1rem; margin-top: 1rem; margin-bottom: 2rem; text-align: center; font-size: 0.9em; border-radius: var(--border-radius);
        }
        .disclaimer strong { color: #856404;}
        .footer-disclaimer { font-size: 0.85em; color: var(--color-text-muted); }

    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-3 flex justify-center items-center">
             <div class="flex items-center text-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-first-aid mr-3 text-red-600"></i> <!-- Icono Primeros Auxilios -->
                     Guía de Primeros Auxilios
                     <i class="fas fa-book-medical ml-3 text-blue-600"></i> <!-- Icono Libro Médico -->
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-10 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Técnicas y Procedimientos Esenciales</h1>
             <p class="text-lg text-gray-700 mb-5 max-w-3xl mx-auto">Encuentra información clara sobre cómo actuar en diversas situaciones de emergencia. Busca una técnica o selecciona de la lista.</p>
             <!-- Disclaimer -->
            <div class="disclaimer max-w-3xl mx-auto">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <strong>IMPORTANTE:</strong> Esta guía es solo para fines informativos y educativos. <strong>NO reemplaza la formación certificada en primeros auxilios ni el consejo médico profesional.</strong> En caso de emergencia real, llama siempre a los servicios de emergencia locales (ej. 123 en Colombia, 911 en USA/Canada, 112 en Europa).
            </div>
             <!-- Search Input -->
             <div id="search-container" class="max-w-2xl mx-auto">
                 <i class="fas fa-search"></i>
                 <input type="text" id="search-input" placeholder="Buscar técnica (ej: RCP, hemorragia, quemadura...)">
             </div>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-medkit text-blue-600 mr-2"></i> <!-- Icono Botiquín -->
                 Técnicas y Condiciones
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Cargando técnicas...</p>
                  <!-- No results message will be injected here by JS -->
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Cargar Más Técnicas
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Cargando información...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - Image appended here -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                     <!-- Image and placeholder will be appended here by JS -->
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-circle"></i> <!-- Changed icon -->
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-700 py-6 mt-12 border-t border-gray-300">
          <div class="container mx-auto px-4 text-center">
              <p class="footer-disclaimer mb-2">
                  <i class="fas fa-info-circle mr-1"></i>
                  Recordatorio: La información aquí presentada es educativa y no sustituye la capacitación formal ni el consejo médico profesional.
              </p>
              <p class="text-sm">Actúa siempre con seguridad y busca ayuda experta cuando sea necesario.</p>
              <p class="mt-2 text-sm">© 2025 Guía de Primeros Auxilios</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Principios Fundamentales y Evaluación
            "Evaluación Primaria: Enfoque DRSABCD / ABCDE", "Evaluación Secundaria: SAMPLE / Examen Céfalo-Caudal", "Seguridad en la Escena: Evaluación de Peligros", "Activación del Sistema de Emergencias Médicas (SEM)", "Consentimiento en Primeros Auxilios (Implícito y Explícito)", "Prevención de Infecciones: Uso de Guantes y Barreras", "Manejo Básico de la Vía Aérea: Apertura Manual", "Reconocimiento de Signos Vitales Básicos (Pulso, Respiración)", "Posición Lateral de Seguridad (PLS)", "Contenido Esencial de un Botiquín de Nivel Medio", "Registro de Incidentes y Documentación Básica", "Principios Éticos en Primeros Auxilios", "Limitaciones del Primer Respondiente", "Trabajo en Equipo en Primeros Auxilios", "Comunicación Efectiva con la Víctima y Testigos",
            // RCP y Obstrucción de Vía Aérea
            "RCP (Reanimación Cardiopulmonar) en Adultos: Solo Compresiones", "RCP (Reanimación Cardiopulmonar) en Adultos: Compresiones y Ventilaciones", "RCP (Reanimación Cardiopulmonar) en Niños (1 a Pubertad)", "RCP (Reanimación Cardiopulmonar) en Lactantes (Menores de 1 año)", "Uso del Desfibrilador Externo Automático (DEA/AED)", "Manejo de Obstrucción de Vía Aérea (Atragantamiento) en Adulto Consciente", "Manejo de Obstrucción de Vía Aérea (Atragantamiento) en Adulto Inconsciente", "Manejo de Obstrucción de Vía Aérea (Atragantamiento) en Niño Consciente", "Manejo de Obstrucción de Vía Aérea (Atragantamiento) en Niño Inconsciente", "Manejo de Obstrucción de Vía Aérea (Atragantamiento) en Lactante Consciente", "Manejo de Obstrucción de Vía Aérea (Atragantamiento) en Lactante Inconsciente", "Obstrucción Parcial vs. Completa de Vía Aérea", "Consideraciones Especiales en RCP (Embarazo, Obesidad)", "Ventilación Boca a Boca / Boca a Mascarilla", "Identificación de Parada Cardiorrespiratoria",
            // Hemorragias y Shock
            "Control de Hemorragia Externa Grave: Presión Directa", "Control de Hemorragia Externa Grave: Elevación (si aplica)", "Control de Hemorragia Externa Grave: Presión Indirecta (Puntos de Presión)", "Uso de Vendaje Compresivo para Hemorragias", "Aplicación de Torniquete (Cuándo y Cómo - Nivel Informativo)", "Uso de Agentes Hemostáticos (Polvos, Vendas - Nivel Informativo)", "Reconocimiento y Manejo Inicial del Shock Hipovolémico", "Reconocimiento y Manejo Inicial del Shock Anafiláctico", "Reconocimiento y Manejo Inicial del Shock Séptico (Sospecha)", "Reconocimiento y Manejo Inicial del Shock Cardiogénico (Sospecha)", "Reconocimiento y Manejo Inicial del Shock Neurogénico (Sospecha)", "Hemorragia Interna: Signos y Síntomas", "Manejo Inicial de Sospecha de Hemorragia Interna", "Hemorragia Nasal (Epistaxis): Manejo", "Hemorragia en Oído o Nariz tras Traumatismo Craneal",
            // Heridas y Quemaduras
            "Limpieza y Cuidado de Heridas Menores (Abrasiones, Cortes)", "Manejo de Laceraciones", "Manejo de Heridas Punzantes", "Manejo de Avulsiones", "Manejo de Amputaciones Traumáticas (Cuidado del Miembro)", "Manejo de Heridas Abdominales (Evisceración)", "Manejo de Heridas Torácicas Abiertas (Neumotórax Abierto - Sello)", "Cuidado de Ampollas (Intactas vs. Rotas)", "Extracción de Astillas y Cuerpos Extraños Superficiales", "Clasificación de Quemaduras (Primer, Segundo, Tercer Grado)", "Manejo de Quemaduras Térmicas Menores", "Manejo de Quemaduras Térmicas Graves (Extensas, Profundas)", "Enfriamiento de Quemaduras: Técnicas Correctas", "Manejo de Quemaduras Químicas (Piel y Ojos)", "Manejo de Quemaduras Eléctricas (Seguridad y Cuidados)", "Manejo de Quemaduras Solares Graves", "Infección de Heridas: Signos y Prevención", "Tétanos: Importancia de la Vacunación", "Uso de Apósitos Estériles y No Estériles", "Técnicas de Vendaje Circular y Espiral", "Técnicas de Vendaje en Ocho (Articulaciones)", "Aplicación de Cabestrillo (Brazo, Clavícula)", "Vendaje de Cabeza",
            // Lesiones Musculoesqueléticas
            "Reconocimiento de Fracturas (Abiertas y Cerradas)", "Inmovilización de Sospecha de Fractura en Extremidad Superior", "Inmovilización de Sospecha de Fractura en Extremidad Inferior", "Manejo de Fracturas Abiertas (Control de Hemorragia y Cubierta)", "Reconocimiento de Luxaciones (Dislocaciones)", "Manejo Inicial de Luxaciones (No reducir, inmovilizar)", "Reconocimiento de Esguinces y Distensiones", "Aplicación del Método RICE/PRICE (Reposo, Hielo, Compresión, Elevación)", "Uso de Vendaje Compresivo para Esguinces", "Inmovilización de Dedos (Férulas Digitales Improvisadas)", "Manejo de Calambres Musculares", "Lesiones por Esfuerzo Repetitivo (Tendinitis - Reconocimiento)", "Síndrome Compartimental: Sospecha y Actuación",
            // Lesiones en Cabeza, Cuello y Columna
            "Reconocimiento de Conmoción Cerebral", "Manejo Inicial de Conmoción Cerebral (Reposo, Observación)", "Signos de Alarma tras Traumatismo Craneal", "Manejo de Heridas en Cuero Cabelludo", "Sospecha de Fractura de Cráneo: Signos", "Lesiones Oculares: Cuerpo Extraño Superficial", "Lesiones Oculares: Penetración de Objeto", "Lesiones Oculares: Contusión (Golpe)", "Lesiones Oculares: Quemadura Química", "Lesiones Oculares: Cómo irrigar el ojo", "Lesiones Oculares: Vendaje Ocular", "Manejo de Dientes Avulsionados (Reimplantación/Transporte)", "Manejo de Fractura Mandibular (Sospecha)", "Mecanismos de Lesión Sugerentes de Lesión Espinal", "Reconocimiento de Posible Lesión Espinal", "Inmovilización Manual de Cabeza y Cuello", "Uso Collarín Cervical (Cuándo y Cómo - Nivel Informativo/Asistencia)", "Movilización en Bloque (Log-Roll) con Ayuda", "Retirada Segura de Casco (Motocicleta, Deportivo - Cuándo Intentar)",
            // Emergencias Médicas Comunes
            "Reconocimiento de Dolor Torácico Sugerente de Infarto", "Actuación Inicial ante Sospecha de Infarto (Reposo, AAS si indicado)", "Reconocimiento de Accidente Cerebrovascular (ACV/Stroke) - Escala FAST/BEFAST", "Actuación Inicial ante Sospecha de ACV", "Manejo de Desmayo (Síncope): Causas Comunes y Recuperación", "Manejo de Convulsiones (Durante y Después)", "Tipos Comunes de Convulsiones (Tónico-clónica, Ausencia)", "Convulsiones Febriles en Niños: Manejo", "Reconocimiento de Hipoglucemia en Diabéticos", "Manejo de Hipoglucemia Consciente (Administración de Azúcar)", "Manejo de Hipoglucemia Inconsciente", "Reconocimiento de Hiperglucemia en Diabéticos", "Reconocimiento de Reacción Alérgica Leve", "Reconocimiento de Anafilaxia (Reacción Alérgica Grave)", "Uso de Autoinyector de Adrenalina (EpiPen, etc.)", "Manejo de Ataque de Asma", "Uso Correcto de Inhaladores de Rescate", "Manejo de Hiperventilación", "Reconocimiento de Dificultad Respiratoria Aguda (Causas Comunes)", "Manejo de Dolor Abdominal Agudo (Apendicitis, etc. - Sospecha)", "Manejo de Náuseas y Vómitos Persistentes", "Manejo de Diarrea y Deshidratación",
            // Intoxicaciones, Mordeduras y Picaduras
            "Principios Generales ante Intoxicaciones", "Intoxicación por Ingestión: Qué Hacer y Qué No Hacer", "Intoxicación por Inhalación (Monóxido de Carbono, etc.)", "Intoxicación por Contacto Cutáneo", "Intoxicación por Inyección (Drogas)", "Importancia de Contactar al Centro de Toxicología", "Manejo de Abuso de Alcohol Agudo", "Manejo de Sobredosis de Opioides (Reconocimiento, Naloxona si disponible)", "Mordeduras de Animales (Perros, Gatos): Limpieza y Riesgo de Rabia", "Mordeduras Humanas: Riesgos", "Picaduras de Insectos (Abejas, Avispas, Hormigas): Reacciones Locales", "Extracción Segura de Aguijón", "Picaduras de Arañas (Viuda Negra, Reclusa Parda - Reconocimiento Regional)", "Picaduras de Escorpión (Alacrán): Manejo General", "Mordeduras de Serpientes Venenosas (Reconocimiento General y Principios)", "Técnica de Inmovilización por Presión (Mordeduras de Serpiente Específicas)", "Picaduras de Medusas y Organismos Marinos", "Garrapatas: Extracción Segura y Riesgo de Enfermedades",
            // Emergencias Ambientales
            "Reconocimiento y Manejo de Agotamiento por Calor", "Reconocimiento y Manejo de Golpe de Calor", "Prevención de Enfermedades por Calor", "Reconocimiento y Manejo de Hipotermia", "Técnicas de Recalentamiento Pasivo y Activo Externo", "Reconocimiento y Manejo de Congelación (Frostbite)", "Prevención de Lesiones por Frío", "Mal de Montaña Agudo (MMA): Reconocimiento y Descenso", "Edema Pulmonar de Altitud (EPA): Reconocimiento", "Edema Cerebral de Altitud (ECA): Reconocimiento", "Ahogamiento y Casi Ahogamiento: Seguridad del Rescatador", "Extracción Segura del Agua (Si es posible)", "Manejo Inicial del Casi Ahogado (RCP si necesario)", "Lesiones por Rayos: Seguridad y Manejo", "Hipotermia por Inmersión en Agua Fría",
            // Situaciones Especiales y Psicológico
            "Primeros Auxilios Pediátricos: Diferencias Clave (Lactantes y Niños)", "Manejo de Fiebre Alta en Niños", "Obstrucción Nasal en Lactantes", "Primeros Auxilios para Personas Mayores: Consideraciones", "Adaptación de Técnicas para Personas con Discapacidad", "Primeros Auxilios en Entornos Deportivos: Lesiones Comunes", "Primeros Auxilios en el Lugar de Trabajo: Riesgos Específicos", "Primeros Auxilios en Zonas Remotas o Rurales: Desafíos", "Primeros Auxilios Psicológicos (PAP): Principios Básicos", "Cómo Ofrecer Apoyo Emocional Inicial", "Manejo del Estrés Agudo en Víctimas y Respondedores", "Reconocimiento de Ataque de Pánico", "Comunicación con Personas en Crisis", "Triaje Básico en Incidentes con Múltiples Víctimas (START - Nivel Informativo)", "Consideraciones Legales Básicas (Buen Samaritano)",
            // Técnicas Adicionales
            "Medición de Temperatura Corporal (Métodos)", "Medición de Frecuencia Cardíaca (Pulso Radial, Carotídeo)", "Medición de Frecuencia Respiratoria", "Evaluación del Estado de Conciencia (Escala AVDI/AVPU)", "Evaluación de Pupilas (Tamaño, Reactividad)", "Evaluación del Llenado Capilar", "Uso de Manta Térmica", "Transporte de Heridos: Arrastres y Cargas Simples (Uno y Dos Rescatadores)", "Uso de Tabla Espinal Corta y Larga (Asistencia)", "Preparación para la Llegada del SEM", "Transferencia de Información al Personal Médico",
            // Conceptos y Prevención
            "Cadena de Supervivencia (IAM, ACV, Parada Cardíaca)", "Importancia de la Prevención de Accidentes Domésticos", "Prevención de Accidentes de Tráfico", "Seguridad en Actividades al Aire Libre", "Reconocimiento Temprano de Enfermedades Graves", "Promoción de Estilos de Vida Saludables", "El Rol del Primer Respondiente en la Comunidad", "Actualización Continua en Primeros Auxilios", "¿Cuándo NO intervenir en Primeros Auxilios?", "Manejo de Fluidos Corporales: Precauciones Universales"
        ];
        const firstAidThemes = [ // Temas para generar más títulos
            "evaluación del paciente", "RCP y DEA", "manejo de vía aérea", "control de hemorragias", "manejo del shock",
            "cuidado de heridas comunes", "manejo de quemaduras", "inmovilización de fracturas", "manejo de esguinces y luxaciones",
            "lesiones de cabeza y columna", "emergencias médicas (infarto, ACV)", "manejo de convulsiones", "emergencias diabéticas",
            "reacciones alérgicas y anafilaxia", "manejo de asma", "intoxicaciones y envenenamientos", "mordeduras y picaduras",
            "emergencias por calor", "emergencias por frío", "ahogamiento", "primeros auxilios pediátricos",
            "primeros auxilios psicológicos", "vendajes y férulas", "botiquín de primeros auxilios", "prevención de lesiones"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un instructor experimentado de primeros auxilios o un paramédico. Tu tarea es explicar una técnica específica de primeros auxilios, el manejo de una condición o un principio fundamental, dirigido a personas con conocimientos básicos o intermedios (ej. brigadistas, público interesado). Describe claramente: 1. Reconocimiento (signos y síntomas clave). 2. Pasos de actuación inmediatos y ordenados. 3. Puntos críticos o 'qué no hacer'. 4. Cuándo es esencial llamar a emergencias (ej. 123, 911, 112). 5. Justificación básica de las acciones. Usa un lenguaje preciso, claro y directo, evitando jerga médica excesiva. Estructura la información lógicamente (quizás con subtítulos #, ##). El objetivo es un texto detallado y práctico de 1200-1300 palabras. **Incluye siempre un descargo de responsabilidad indicando que la información es educativa y no reemplaza la formación certificada ni el consejo médico profesional.** Basa tu explicación únicamente en el siguiente tema:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un desarrollador de currículos de primeros auxilios. Genera exactamente 15 títulos específicos de técnicas, condiciones o escenarios adecuados para un curso de nivel medio. Deben ser claros y orientados a la acción. Devuelve *solo* la lista de títulos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios funcionales)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        let noResultsMessageElement = null;

        // ========== API FUNCTIONS ========== (Sin cambios funcionales)
        async function fetchTextFromApi(prompt, config) { /* ... */
            const encodedPrompt = encodeURIComponent(prompt);
            const encodedSystem = encodeURIComponent(config.systemPrompt);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo.`);
                throw new Error(`Error de comunicación con la API: ${error.message}`);
            }
         }
        async function fetchExplanationText(conceptTitle) { /* ... */
            const text = await fetchTextFromApi(conceptTitle, textApiConfig);
             if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de") || !text.toLowerCase().includes("llamar a emergencia")) { // Added check for emergency call mention
                  throw new Error("La IA no pudo generar una explicación adecuada, suficientemente detallada o segura para este tema.");
              }
             // Basic check for disclaimer presence (adjust keywords as needed)
             if (!text.toLowerCase().includes("no reemplaza") && !text.toLowerCase().includes("sustituye") && !text.toLowerCase().includes("formación certificada") && !text.toLowerCase().includes("consejo médico")) {
                 console.warn("Generated text might be missing a safety disclaimer.");
                 // Optionally append a standard disclaimer here if needed, but ideally the API includes it.
             }
            return text;
        }
        async function fetchGeneratedTitles() { /* ... */
            const randomTheme = getRandomElement(firstAidThemes) || "técnicas esenciales de primeros auxilios";
            const specificPrompt = `Genera 15 títulos específicos sobre ${randomTheme}`;
            console.log("Generating titles with prompt:", specificPrompt);
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
            const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 120);
            if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de técnicas.");
            return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a PRIMEROS AUXILIOS
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "first aid concept";
            // Prompt ENFOCADO en concepto, seguridad, ayuda. Evitar gore.
            const enhancedPrompt = `Abstract or symbolic image representing the first aid concept: '${safePromptText}'. Style: Clean, clear, minimalist. Use symbols like cross, helping hands, heartbeat line, shield. Colors: blue, white, green, red accents. Avoid realistic injuries or blood.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, gore, blood, graphic injury, specific medical tools, realistic people, suffering, messy, cluttered, photograph, diagram, chart";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText) {
             if (!rawText) return '';
             let formatted = rawText.trim();

             // Handle markdown-like lists (simple conversion)
             formatted = formatted.replace(/^\s*[-*+]\s+(.*)$/gm, '<li>$1</li>');
             formatted = formatted.replace(/<\/li>\n<li>/g, '</li><li>'); // Close gaps between list items
             formatted = formatted.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>'); // Wrap consecutive LIs in UL
             // Make sure ULs don't merge accidentally if separated by non-list text
             formatted = formatted.replace(/<\/ul>\s*<ul>/g, '</ul>\n<ul>');

             // Headers
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');

             // Bold and Italic
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

             // Specific formatting for warnings/notes (if API uses keywords)
             formatted = formatted.replace(/^(?:ADVERTENCIA|WARNING|ATENCIÓN|CAUTION):?\s*(.*)$/gmi, '<p class="warning"><i class="fas fa-exclamation-triangle"></i><strong>Advertencia:</strong> $1</p>');
             formatted = formatted.replace(/^(?:IMPORTANTE|IMPORTANT|NOTA|NOTE):?\s*(.*)$/gmi, '<p class="important"><i class="fas fa-info-circle"></i><strong>Importante:</strong> $1</p>');

             // Paragraphs (split by double newline, handle existing tags)
             const blocks = formatted.split(/\n\s*\n/);
             formatted = blocks.map(block => {
                 const trimmedBlock = block.trim();
                 if (trimmedBlock.length === 0) return '';
                 // Keep existing html tags (headers, lists, warning/important paragraphs)
                 if (trimmedBlock.startsWith('<h') || trimmedBlock.startsWith('<ul') || trimmedBlock.startsWith('<p class="warning') || trimmedBlock.startsWith('<p class="important')) {
                     return trimmedBlock;
                 }
                 // Wrap other blocks in <p>, converting single newlines to <br>
                 let content = trimmedBlock.replace(/\n/g, '<br>');
                 return `<p>${content}</p>`;
             }).filter(block => block.length > 0).join(''); // Filter out empty blocks

             return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Sin cambios funcionales)
        function showModal() { /* ... */ if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { /* ... */
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
         }
        function resetModalState() { /* ... */
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = ''; // Clears text and appended image/placeholder
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { /* ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }

        // Modified createTitleItem to potentially add icons later if needed
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // Add a generic icon for now
            const icon = document.createElement('i');
            icon.className = 'fas fa-medkit'; // Default icon
            // You could add logic here to change icon based on title keywords
            // if (title.toLowerCase().includes('rcp') || title.toLowerCase().includes('corazón')) icon.className = 'fas fa-heartbeat';
            // else if (title.toLowerCase().includes('hemorragia') || title.toLowerCase().includes('sangre')) icon.className = 'fas fa-tint'; // droplet icon
            // ... etc. Keeping it simple for now.
            div.appendChild(icon);

            const textSpan = document.createElement('span');
            textSpan.textContent = title;
            div.appendChild(textSpan);

            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
         }

        function displayTitles(titles) { /* ... */
            if (!titleListContainer || !titlesLoading) return;
            const shuffledTitles = shuffleArray([...titles]);
            titleListContainer.innerHTML = ''; // Clear previous, including "no results"
            titlesLoading.style.display = 'none';
            if (shuffledTitles.length === 0) {
                showNoResultsMessage("No hay técnicas iniciales disponibles.");
                return;
            }
            shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
            filterTitles(); // Apply current search filter immediately
         }
        function appendTitles(newTitles) { /* ... */
            if (!titleListContainer || !newTitles || newTitles.length === 0) return;
            const searchTerm = searchInput.value.toLowerCase().trim();
            newTitles.forEach(title => {
                const item = createTitleItem(title);
                if (searchTerm === '' || title.toLowerCase().includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
                titleListContainer.appendChild(item);
            });
            checkIfAnyResultsVisible();
        }

        // --- Search Filter Functionality --- (Sin cambios funcionales)
        function filterTitles() { /* ... */
             if (!searchInput || !titleListContainer) return;
             const searchTerm = searchInput.value.toLowerCase().trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;

             titleItems.forEach(item => {
                 const title = item.getAttribute('data-title').toLowerCase(); // Search on the full title data
                 if (title.includes(searchTerm)) {
                     item.style.display = 'flex';
                     visibleCount++;
                 } else {
                     item.style.display = 'none';
                 }
             });
             updateNoResultsMessage(visibleCount);
         }
        function updateNoResultsMessage(visibleCount) { /* ... */
              if (!titleListContainer) return;
              if (noResultsMessageElement) {
                  noResultsMessageElement.remove();
                  noResultsMessageElement = null;
              }
              if (visibleCount === 0 && titleListContainer.children.length > 0 && !titlesLoading.style.display || titlesLoading.style.display === 'none') {
                  showNoResultsMessage(`No se encontraron técnicas para "${searchInput.value}"`);
              }
         }
        function showNoResultsMessage(message) { /* ... */
             if (noResultsMessageElement || !titleListContainer) return;
             noResultsMessageElement = document.createElement('p');
             noResultsMessageElement.id = 'no-results-message';
             noResultsMessageElement.textContent = message;
             titleListContainer.appendChild(noResultsMessageElement);
         }
        function checkIfAnyResultsVisible() { /* ... */
             const visibleItems = titleListContainer.querySelectorAll('.title-item[style*="display: flex"], .title-item:not([style*="display: none"])');
             updateNoResultsMessage(visibleItems.length);
         }

        // *** handleTitleClick: Image logic same, scroll reset confirmed ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // 1. Fetch and format text
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // 2. Stop loading indicator, display text FIRST
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                 // 3. RESET SCROLL after text content is in and visible
                modalContent.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // 4. Prepare and append image placeholder WITHIN #modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando ilustración conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // 5. Create and append the actual image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración conceptual para ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-image-slash placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">No se pudo cargar la ilustración.</p>
                    `;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">Error al generar URL de ilustración.</p>
                    `;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}. Recuerda que esta es una guía informativa, no reemplaza la atención médica profesional.`; // Add context to error
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = ''; // Clear partial content
            }
        }

        // --- handleGenerateMoreTitles: Sin cambios funcionales ---
        async function handleGenerateMoreTitles() { /* ... */
             if (!generateMoreBtn || !generateMoreContainer) return;
             const spinner = generateMoreBtn.querySelector('i');
             generateMoreBtn.disabled = true;
             if(spinner) spinner.classList.remove('hidden');
             generateMoreBtn.childNodes[generateMoreBtn.childNodes.length - 1].nodeValue = " Cargando...";

             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block';
                 } else {
                     alert("No se pudieron cargar más técnicas en este momento.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al cargar técnicas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 if(spinner) spinner.classList.add('hidden');
                 generateMoreBtn.childNodes[generateMoreBtn.childNodes.length - 1].nodeValue = " Cargar Más Técnicas";
                 checkIfAnyResultsVisible();
             }
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput) { console.error("Init fail."); document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: No se pudo inicializar la guía de primeros auxilios.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            searchInput.addEventListener('input', filterTitles);
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>