<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fábulas Modernas - Cuentos con Moraleja</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes estilo Cuento/Legible -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Fábulas Modernas --- */
        :root {
            --color-primary: #4a7c59; /* Verde Bosque Suave */
            --color-secondary: #daa520; /* Oro Viejo/Mostaza */
            --color-tertiary: #a0522d; /* Siena/Marrón Rojizo */
            --color-background: #fdf6e3; /* Pergamino/Beige Claro */
            --color-text: #5c4033; /* Marrón Oscuro/Sepia */
            --color-text-muted: #8b7d6b; /* Marrón Grisáceo */
            --color-modal-bg: #fffaf0; /* Blanco Floral/Marfil */
            --color-border: #d2b48c; /* Tan/Marrón Claro */
            --color-error-bg: #fdf2f2; /* Fondo error rosa muy pálido */
            --color-error-text: #a0522d; /* Texto error marrón */
            --color-error-border: #e5a1a1; /* Borde error rosa-marrón */

            --shadow-sm: 0 1px 2px 0 rgba(92, 64, 51, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(92, 64, 51, 0.15), 0 2px 4px -2px rgba(92, 64, 51, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(92, 64, 51, 0.2), 0 4px 6px -4px rgba(92, 64, 51, 0.15);
            --border-radius: 5px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400; }
        h1, h2, h3, h4, .logo, .button-font { font-family: 'Quicksand', sans-serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(253, 246, 227, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Quicksand'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(74, 124, 89, 0.2); outline: none; background-color: #ffffff; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 500; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Quicksand'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-primary); background-color: #f5f2e9; border-left-color: var(--color-secondary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-background); padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Quicksand', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #3a6b48; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background: var(--color-text-muted); color: var(--color-background); cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(92, 64, 51, 0.85); /* Overlay Sepia */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-tertiary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px; /* For chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-tertiary); color: var(--color-background); transform: rotate(90deg); }
        #modal-title { font-size: 1.7rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.4; font-family: 'Quicksand', sans-serif; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 8px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid var(--color-modal-bg); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Quicksand', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px dotted var(--color-border); padding-bottom: 0.5em; font-weight: 700; letter-spacing: 0.5px; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.1em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(210, 180, 140, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px dashed var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 230px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(253, 246, 227, 0.6); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; font-size: 0.95em; }
        .user-message { background-color: var(--color-secondary); color: var(--color-background); margin-left: auto; text-align: left; /* Keep left align for readability */ font-family: 'Quicksand', sans-serif; font-weight: 500; }
        .ai-message { background-color: #eaddcc; color: var(--color-text); margin-right: auto; text-align: left; font-family: 'Merriweather', serif; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.3rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #ffffff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Quicksand'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #3a6b48; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(253, 246, 227, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 500; color: var(--color-text); font-size: 1.2rem; font-family: 'Quicksand'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.1rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Quicksand'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-tertiary); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(92, 64, 51, 0.95); /* Overlay Sepia más oscuro */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-secondary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-tertiary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-book-open mr-3 text-green-700"></i> <!-- Icono libro -->
                     Fábulas Modernas
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wide">~ Cuentos con Moraleja para Hoy ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Historias para Reflexionar</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-serif">Explora fábulas que conectan la fantasía con los desafíos de nuestro tiempo. Elige una historia o busca un tema.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar por palabra clave (ej: tecnología, envidia, bosque)...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-feather-alt text-yellow-600 mr-2"></i> <!-- Icono pluma -->
                 Índice de Fábulas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Abriendo el libro de fábulas...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">~ No encontramos fábulas con esas palabras ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn" class="button-font">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Nuevas Historias
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Tejiendo la historia...</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2> <!-- Título dentro del area scrolleable -->
                     <div id="modal-content">
                         <!-- Fable text (HTML) goes here -->
                         <!-- Image and placeholder appended here -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Reflexionando...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre la fábula (moraleja, personajes...)" class="font-sans">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Ilustración Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Fábulas generadas por IA, inspiradas en dilemas modernos y elementos fantásticos.</p>
              <p class="mt-1">Las moralejas son interpretaciones; reflexiona y encuentra tu propio significado.</p>
              <p class="mt-2">© 2025 El Fabulista Digital</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Tecnología y Sociedad
            "El Golem que Juzgaba por Likes", "El Espejo Mágico que Mostraba 'Fake News'", "Los Pixies Adictos al Scroll Infinito", "El Dragón que Acumulaba Criptomonedas", "La Ninfa del Río Contaminado por Datos", "El Smartphone que Susurraba Secretos", "El Bosque Encantado con Wi-Fi Débil", "Los Gremlins que Enredaban los Cables de Carga", "El Unicornio que Perdió su Magia por Compararse Online", "La Inteligencia Artificial que Soñaba con Ser Ética", "El Pueblo donde las Sombras Robaban la Privacidad", "La Sirena Atrapada en Redes Sociales", "El Centauro que Hacía Entregas por App", "Los Duendes del Phishing", "El Fénix Agotado por el Burnout Digital", "El Mago que Automatizó Demasiado su Vida", "La Ciudad Flotante y la Brecha Digital", "El Oráculo que Solo Daba Respuestas Virales", "Los Auriculares que Aislaban del Mundo Real", "El Gigante Dormido por el Contenido Pasivo", "La Alfombra Voladora Atascada en el Tráfico de Datos", "El Troll de Internet que Vivía Bajo un Puente Real", "Los Gnomos Mineros de 'Me Gustas'", "La App de Citas Mágicas con Errores", "El Reloj de Arena que Medía el Tiempo de Pantalla",
            // Medio Ambiente y Naturaleza
            "El Último Árbol Parlante del Bosque Deforestado", "La Tortuga Milenaria y la Isla de Plástico", "Los Espíritus del Aire Ahogados por el Smog", "El Oso Polar que Buscaba Hielo en Verano", "Los Topos que Cavaban en Tierra Yerma", "El Río que Lloraba Lágrimas Ácidas", "Las Abejas que Olvidaron Cómo Polinizar", "El Grifo Guardián de un Vertedero", "Los Elementales de Agua Luchando contra la Sequía", "El Bosque Silencioso por la Extinción", "La Montaña que Encogía por la Minería", "Las Náyades del Océano Caliente", "El Viento que Llevaba Semillas de Plástico", "Los Corales que Perdieron su Color y su Voz", "El Hongo que Se Alimentaba de Contaminación", "La Flor que Florecía de Noche por la Polución Lumínica", "Los Pájaros que Imitaban Ringtones", "El Ciclo del Agua Roto por el Cambio Climático", "Los Animales del Bosque Adaptándose a la Basura Humana", "La Semilla Mágica que No Podía Crecer en Suelo Contaminado",
            // Sociedad y Comportamiento Humano
            "La Gárgola Solitaria en la Ciudad Ruidosa", "El Mercader de Sueños Irrealizables", "La Liebre que Corría la 'Carrera de la Rata'", "El Basilisco que Petrificaba con la Mirada del Juicio", "Los Sátiros de la Fiesta Eterna y el Vacío", "El Minotauro Perdido en el Laberinto del Consumismo", "La Medusa que Temía Mostrar su Verdadero Rostro", "El Eco que Solo Repetía Mentiras", "Los Vecinos que Construyeron Muros Invisibles", "La Quimera Hecha de Expectativas Ajenas", "El Flautista que Encantaba con Promesas Vacías", "La Torre de Marfil del Conocimiento Inútil", "El Jinete Sin Cabeza Buscando Dirección en la Vida", "Los Cíclopes con Visión de Túnel", "La Fuente de la Eterna Juventud (y la Insatisfacción)", "El Ogro Gentrificador", "Los Kelpies que Ahogaban en Deudas", "La Esfinge con Adivinanzas sobre la Identidad", "El Kraken de la Burocracia", "Los Selkies que Cambiaron su Piel por Conformidad",
            // Psicología y Crecimiento Personal
            "El Caballero con Armadura Oxidada por la Procrastinación", "El Mapa del Tesoro Hacia la Autoestima", "La Poción Mágica para Aceptar el Cambio", "El Fantasma Atrapado en el Pasado", "El Jardín Secreto de la Resiliencia", "El Fénix que Aprendió a Renacer de las Cenizas del Fracaso", "La Brújula Interior que Apuntaba al Propósito", "El Monstruo Bajo la Cama (Llamado Ansiedad)", "El Espejo que Reflejaba Fortalezas Ocultas", "El Laberinto de las Decisiones Difíciles", "La Lámpara Maravillosa (de la Gratitud)", "El Puente Colgante sobre el Miedo", "Las Botas de Siete Leguas (para Salir de la Zona de Confort)", "El Orco que Aprendió a Gestionar su Ira", "La Varita Rota (y Cómo Arreglarla con Paciencia)", "El Hilo Invisible de la Empatía", "La Capa de Invisibilidad (que Ocultaba la Vulnerabilidad)", "El Libro de Hechizos para la Comunicación Asertiva", "El Unicornio que Abrazó su Imperfección", "El Tesoro al Final del Arcoíris (Era el Viaje)",
            // Otros Conceptos
            "El Gato con Botas y el Emprendimiento", "La Bella Durmiente y la Cultura de la Prisa", "Cenicienta en la Era del Fast Fashion", "Los Tres Cerditos y la Vivienda Sostenible", "Pulgarcito Perdido en Google Maps", "Hansel y Gretel y los Peligros de los 'Influencers'", "El Lobo Feroz Víctima de la Deforestación", "Ricitos de Oro y la Paradoja de la Elección", "El Patito Feo y el Body Positivity", "La Cigarra y la Hormiga en Tiempos de Precariedad Laboral",
            // Continuar generando ideas...
        ];
        const fableThemes = [ // Para generar más títulos
            "tecnología y redes sociales", "medio ambiente y cambio climático", "consumismo y materialismo", "salud mental y bienestar", "desigualdad social", "búsqueda de identidad", "comunicación y relaciones", "ética en la era digital", "trabajo y 'burnout'", "adaptación al cambio", "información y 'fake news'", "soledad en la multitud", "sostenibilidad y ecología", "presión social y conformidad", "inteligencia artificial y humanidad", "animales fantásticos en la ciudad", "magia y vida cotidiana", "criaturas mitológicas con problemas modernos"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un cuentacuentos moderno y sabio. Tu especialidad es crear fábulas cortas (aproximadamente 1200-1300 palabras) que mezclan elementos fantásticos (animales que hablan, magia, criaturas míticas, etc.) con problemas y dilemas contemporáneos (tecnología, sociedad, medio ambiente, psicología). Cada fábula debe tener una moraleja clara y relevante para el mundo actual. Basa tu fábula únicamente en el siguiente título o idea:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
             systemPrompt: "Actúa como un analista literario perspicaz especializado únicamente en la fábula que se está mostrando. Responde preguntas sobre sus personajes, simbolismo, moraleja, estructura narrativa o elementos fantásticos en relación a su mensaje contemporáneo. Sé reflexivo y mantente enfocado en la historia actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para fábulas modernas. Genera exactamente 15 títulos o conceptos breves para fábulas que combinen elementos fantásticos con problemáticas actuales (tecnología, sociedad, ecología, psicología, etc.). Devuelve *solo* la lista de ideas, una por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Scrollable area
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Text container
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentFableTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentFableTitle
                 ? `Eres un analista literario perspicaz especializado únicamente en la fábula titulada '${currentFableTitle}'. Responde preguntas sobre sus personajes, simbolismo, moraleja, estructura narrativa o elementos fantásticos en relación a su mensaje contemporáneo. Sé reflexivo y mantente enfocado en la historia actual.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     // *** MENSAJE DE ERROR AMIGABLE ***
                     throw new Error(`(Código ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, como una encrucijada llena de carruajes. Por favor, intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta del cuentacuentos llegó vacía, quizás se quedó pensando... Intenta de nuevo.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con el mundo de las fábulas tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o espera a que la niebla se disipe.`);
                 }
                 throw new Error(error.message || "Una voluta de humo inesperada impidió contactar al cuentacuentos.");
             }
        }
        async function fetchFableText(title) {
             return fetchTextFromApi(title, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
             if (!currentFableTitle) throw new Error("Error interno: No se sabe sobre qué fábula preguntar.");
             return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(fableThemes) || "fábulas modernas";
             const specificPrompt = `Genera 15 títulos o ideas para fábulas sobre ${randomTheme}`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 8 && line.length < 150); // Slightly longer minimum length
                     if (titles.length < 5) throw new Error("El pozo de las ideas parece seco por ahora.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 700, height: 550, nologo: true }; // Adjusted size slightly
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "modern fable illustration";
             // Prompt for storybook style
             const enhancedPrompt = `Storybook illustration, whimsical or slightly melancholic style, depicting the essence of the modern fable '${safePromptText}'. Focus on character interaction or symbolic scene. Avoid text. Soft lighting, perhaps slightly painterly, watercolor, or colored pencil effect.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "photorealistic, photograph, 3D render, text, words, labels, diagram, chart, interface, logo, watermark, signature, multiple images, collage, hyperrealistic, detailed human faces, blurry, noisy";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (copiar la función exacta de la versión anterior) ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, ' '); // Reemplaza saltos internos con espacio
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Sin cambios estructurales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentFableTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (copiar función) ... */
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() { /* ... (copiar función) ... */
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (Sin cambios estructurales)
        function addChatMessage(message, sender) { /* ... (copiar función) ... */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... (copiar función) ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... (copiar función) ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error del Analista: ${error.message}`); // Mensaje temático
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Optional: Sort thematically or keep random/API order? Let's sort alphabetically for now.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">~ El libro parece vacío por ahora ~</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title; // Set title in the modal header
            currentFableTitle = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawFableText = await fetchFableText(title);
                const formattedFable = formatExplanationText(rawFableText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedFable; // Add fable text first
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is potentially visible
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder WITHIN modalContent (at the end)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-palette placeholder-icon"></i> <!-- Icono paleta/arte -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Pintando la ilustración...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración para ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Illustration loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading illustration for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-signature placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">El ilustrador se tomó un descanso.</p>`; // Thematic error
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append image to the text content div
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Tinta derramada al crear URL.</p>`;
                }

            } catch (error) {
                console.error("Failed fable display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Ocurrió un error al contar la fábula.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando inspiración...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Parece que las musas no respondieron esta vez."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error buscando historias: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                  generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Nuevas Historias'; // Reset button text
             }
         }

         // Search Filter Function (Includes accent normalization)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check essential elements
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalTextArea) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #a0522d; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: Quicksand;">~ El libro mágico no pudo abrirse correctamente. Faltan páginas esenciales. ~</p>';
                return;
             }
            // Event listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>