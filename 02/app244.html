<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senderos del Jainismo - Relatos y Sabiduría</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Serenas y Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Jainismo --- */
        :root {
            --color-primary: #FF9933; /* Azafrán */
            --color-secondary: #FFFFFF; /* Blanco Pureza */
            --color-tertiary: #138808; /* Verde Naturaleza/Vida */
            --color-background: #fdfaf6; /* Blanco Roto / Crema muy claro */
            --color-text: #4d4d4d; /* Gris Oscuro Suave */
            --color-text-muted: #8c8c8c; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro para Modal */
            --color-border: #e0e0e0; /* Borde Gris Claro */
            --color-error-bg: #fff5f5; /* Fondo error rosa muy pálido */
            --color-error-text: #c53030; /* Texto error rojo oscuro */
            --color-error-border: #fc8181; /* Borde error rojo claro */
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.07), 0 1px 2px 0 rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            --border-radius: 4px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-secondary); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(255, 153, 51, 0.2); outline: none; background-color: var(--color-secondary); }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-secondary); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #fffaf0; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-secondary); padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { background-color: #e68a00; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: #f0e0d0; color: var(--color-text-muted); cursor: not-allowed; opacity: 0.8; box-shadow: none; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(77, 77, 77, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem 2rem; max-width: 950px; width: 95%; max-height: 90vh; min-height: 450px; /* Mínimo para contenido */ overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #eee; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-secondary); transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área Contenido Principal (Texto + Imagen + Chat) */
        #modal-story-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; }
        /* Área Scrollable (Texto + Imagen) */
        #modal-content-area { flex-grow: 1; min-height: 0; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) #f0f0f0;
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: #f0f0f0; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid #e0e0e0; }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.5em; } #modal-content h2 { font-size: 1.35em; } #modal-content h3 { font-size: 1.2em; color: var(--color-tertiary); } #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        /* Imagen y Placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid #e0e0e0; width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9f9f9; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) #f0f0f0;
        }
        #chat-history::-webkit-scrollbar { width: 6px; } #chat-history::-webkit-scrollbar-track { background: #f0f0f0; } #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-tertiary); color: var(--color-secondary); margin-left: auto; text-align: left; } /* Changed text-align */
        .ai-message { background-color: #eee; color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: var(--color-secondary); color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: var(--color-secondary); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #e68a00; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; } #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Overlay with Minigame */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(253, 250, 246, 0.98); /* Fondo crema casi opaco */
            display: none; /* Oculto por defecto, se muestra con JS */
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius);
            padding: 2rem; text-align: center;
        }
        #modal-loading.active { display: flex; } /* Clase para mostrar */
        #loading-message { font-family: 'Merriweather', serif; font-size: 1.5rem; color: var(--color-primary); margin-bottom: 1.5rem; }
        /* Minigame Area */
        #minigame-area {
            width: 100%; max-width: 500px; height: 250px; /* Ajusta según necesidad */
            background-color: rgba(255, 255, 255, 0.7); border: 1px solid var(--color-border);
            border-radius: var(--border-radius); position: relative; overflow: hidden;
            margin-top: 1rem; cursor: pointer;
            box-shadow: var(--shadow-sm);
        }
        .game-element {
            position: absolute; font-size: 1.8rem; /* Tamaño iconos */
            cursor: pointer; transition: transform 0.1s ease-out, opacity 0.3s ease-in-out;
            user-select: none; padding: 5px; border-radius: 50%; background: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        .game-element:hover { transform: scale(1.15); }
        .game-element.positive { color: var(--color-tertiary); } /* Verde para bueno */
        .game-element.obstacle { color: #ff6b6b; } /* Rojo/Rosa para malo (opcional) */
        .points-feedback { /* Animación de puntos */
            position: absolute; font-size: 1rem; font-weight: bold; color: var(--color-primary);
            animation: floatUp 0.8s ease-out forwards;
            pointer-events: none;
        }
        @keyframes floatUp {
            from { transform: translateY(0); opacity: 1; }
            to   { transform: translateY(-30px); opacity: 0; }
        }
        #minigame-stats { margin-top: 1.2rem; font-family: 'Lato'; font-size: 1.1rem; color: var(--color-text); }
        #minigame-stats span { font-weight: bold; color: var(--color-primary); margin-left: 5px; }
        #minigame-instructions { font-size: 0.9rem; color: var(--color-text-muted); margin-top: 0.5rem;}

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(253, 250, 246, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-secondary); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-om mr-3 text-orange-500"></i> <!-- Icono Om -->
                     Senderos del Jainismo
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">Relatos y Sabiduría Interactiva</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora la Filosofía Jaina</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Sumérgete en historias ancestrales, comprende profundos conceptos y descubre la senda de la no violencia y el desapego.</p>
         </section>

         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar relato, concepto, Tirthankara...">
             <i class="fas fa-search"></i>
         </section>

         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-green-700 mr-2"></i> <!-- Icono libro -->
                 Índice de Conocimiento
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando escrituras y relatos...</p>
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron entradas para tu búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Enseñanzas (40)
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <p id="loading-message">Procesando sabiduría ancestral...</p>
                 <!-- Minigame Area -->
                 <div id="minigame-area">
                     <!-- Game elements will be added here by JS -->
                 </div>
                 <div id="minigame-stats">
                     Virtud: <span id="minigame-score">0</span> | Nivel de Comprensión: <span id="minigame-level">1</span>
                 </div>
                  <p id="minigame-instructions">Haz clic en los símbolos positivos para avanzar.</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content"></div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al sabio...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta enseñanza...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Contenido generado por IA con fines educativos e ilustrativos sobre el Jainismo.</p>
              <p class="mt-1">Para estudios profundos, consulta fuentes académicas y escrituras originales.</p>
              <p class="mt-2">© 2025 Sabiduría Jaina Interactiva</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Tirthankaras Principales
            "Vida y Enseñanzas de Mahavira (Vardhamana)", "Parshvanatha: El 23º Tirthankara", "Rishabhanatha (Adinatha): El Primer Tirthankara", "Neminatha: El 22º Tirthankara", "Shantinatha: El 16º Tirthankara", "Mallinatha: La única Tirthankara mujer (según Svetambara)", "Suparshvanatha: El 7º Tirthankara", "Chandraprabha: El 8º Tirthankara", "Ajitanatha: El 2º Tirthankara", "Sambhavanatha: El 3º Tirthankara", "Abhinandananatha: El 4º Tirthankara", "Sumatinatha: El 5º Tirthankara", "Padmaprabha: El 6º Tirthankara", "Pushpadanta (Suvidhinatha): El 9º Tirthankara", "Shitalanatha: El 10º Tirthankara", "Shreyansanatha: El 11º Tirthankara", "Vasupujya: El 12º Tirthankara", "Vimalanatha: El 13º Tirthankara", "Anantanatha: El 14º Tirthankara", "Dharmanatha: El 15º Tirthankara", "Kunthunatha: El 17º Tirthankara", "Aranatha: El 18º Tirthankara", "Munisuvrata: El 20º Tirthankara", "Naminatha: El 21º Tirthankara", "El concepto de los 24 Tirthankaras", "Simbolismo asociado a cada Tirthankara", "El ciclo infinito de Tirthankaras",
            // Conceptos Fundamentales (Doctrina)
            "Ahimsa: El principio de No Violencia", "Anekantavada: La doctrina de las Múltiples Perspectivas", "Aparigraha: El principio de No Posesión / Desapego", "Satya: El principio de Veracidad", "Asteya (Achaurya): El principio de No Robar", "Brahmacharya: Castidad / Control de los Sentidos", "Karma en el Jainismo: Causa y Efecto", "Tipos de Karma (Ghati y Aghati)", "Lesya: Las coloraciones del alma", "Moksha (Nirvana): La Liberación Final", "Samsara: El Ciclo de Nacimiento y Muerte", "Jiva: El concepto de Alma / Ser Viviente", "Ajiva: El concepto de No-Alma / Materia", "Gunasthanas: Las 14 Etapas del Desarrollo Espiritual", "Samyak Darshana: Recta Percepción / Fe", "Samyak Jnana: Recto Conocimiento", "Samyak Charitra: Recta Conducta", "Los Tres Joyas (Triratna) del Jainismo", "El concepto de Dios en el Jainismo", "Cosmología Jaina: Lokapurusha (El Universo)", "Tiempo (Kala) en el Jainismo: Utsarpini y Avasarpini", "Dravya: Las seis sustancias eternas", "Syadvada: La Lógica Condicional", "Nayavada: La Teoría de los Puntos de Vista Parciales", "Pudgala: La Materia", "Dharma y Adharma (Sustancias de Movimiento y Reposo)", "Akasha: El Espacio",
            // Prácticas y Rituales
            "Sallekhana (Santhara): El Ayuno Ritual hasta la Muerte", "Pratikramana: Ritual de Arrepentimiento y Confesión", "Meditación (Samayika, Preksha Dhyana)", "Ayuno (Upavasa) en el Jainismo: Tipos y Significados", "Paryushana Parva: El Festival más importante", "Mahavir Jayanti: Celebración del nacimiento de Mahavira", "Diwali en el Jainismo: Celebración de la liberación de Mahavira", "Peregrinación a Lugares Sagrados (Tirtha)", "Puja: Adoración de Imágenes", "Cinco Votos Principales (Mahavratas) para Monjes/Monjas", "Doce Votos Menores (Anuvratas) para Laicos", "La vida Monástica (Monjes y Monjas Jainistas)", "Reglas de Alimentación Jaina (Vegetarianismo estricto, evitar raíces)", "El uso del Muhapatti (Tela en la boca)", "El uso de la escobilla (Rajoharan / Ogho)", "Restricciones Nocturnas (No comer de noche)", "Filtrar el Agua", "Ahimsa en la vida diaria", "Caridad (Dana) en el Jainismo", "Estudio de las Escrituras (Swadhyaya)",
            // Escrituras y Textos
            "Los Agamas: Las Escrituras Sagradas", "Angas y Upangas", "Prakirnakas y Mulasutras", "Diferencias entre Cánones Svetambara y Digambara", "Tattvartha Sutra de Umaswati", "Samayasara de Kundakunda", "Pravachanasara de Kundakunda", "Ratnakaranda shravakachara de Samantabhadra", "Comentarios sobre los Agamas", "Literatura Jaina en Prakrit, Sánscrito y lenguas regionales", "Historias y Parábolas de las Escrituras Jainas", "Kalpa Sutra", "Acharanga Sutra", "Sutrakritanga Sutra", "Uttaradhyayana Sutra",
            // Sectas y Tradiciones
            "Svetambara: La Secta Vestida de Blanco", "Digambara: La Secta Desnuda ('Vestida de Cielo')", "Diferencias doctrinales y prácticas entre Svetambara y Digambara", "Sub-sectas Svetambara (Murtipujaka, Sthanakavasi, Terapanthi)", "Sub-sectas Digambara (Bispanthi, Terapanthi, Taranapanthi, Kanji Swami Panth)", "Historia de la Escisión", "Figuras importantes de cada tradición",
            // Historia y Figuras
            "Orígenes Pre-Mahavira del Jainismo", "Contexto Histórico de Mahavira (Siglo VI a.C.)", "Expansión del Jainismo en la India Antigua", "Patrocinio Real (Chandragupta Maurya, Kharavela)", "Jainismo en el Sur de la India", "Jainismo Medieval", "Acharya Kundakunda", "Acharya Umaswati", "Acharya Hemachandra", "Acharya Bhadrabahu", "Sthulabhadra", "La diáspora Jaina", "Jainismo en la era moderna", "Contribuciones Jainas al Arte y la Arquitectura India", "Contribuciones Jainas a la Lógica y Filosofía", "Jainismo y Ciencia", "Movimientos de Reforma en el Jainismo", "Figuras Jainas contemporáneas",
            // Lugares Sagrados y Arquitectura
            "Shatrunjaya Hills (Palitana): Ciudad de Templos", "Monte Abu (Dilwara Temples): Arquitectura Exquisita", "Shravanabelagola: La Estatua Colosal de Gomateshwara (Bahubali)", "Ranakpur: El Templo Chaturmukha", "Sammed Shikharji (Parasnath Hills): Lugar de Nirvana de Tirthankaras", "Mahavirji Temple (Rajasthan)", "Ellora Caves (Cuevas Jainas)", "Khandagiri y Udayagiri Caves (Orissa)", "Templos Jainas en Khajuraho", "Pawaiji (Bihar)", "Vaishali: Lugar de Nacimiento de Mahavira", "Kundalpur (Bihar/Madhya Pradesh)", "Características de la Arquitectura de Templos Jainas", "Manastambha: Pilares Honoríficos", "Simbolismo en el Arte Jaina",
            // Jainismo y Sociedad
            "Ética Jaina en los Negocios", "Jainismo y Ecología / Medio Ambiente", "El concepto Jaina de Bienestar Animal", "Jainismo y Educación", "Contribuciones Sociales de la Comunidad Jaina", "Organizaciones Jainas Internacionales", "Diálogo Interreligioso", "Desafíos del Jainismo en el Mundo Moderno", "Percepción del Jainismo fuera de la India",
            // Relatos y Parábolas Famosas
            "La Historia del Elefante y los Ciegos (Anekantavada)", "La Parábola de la Cuerda y la Serpiente (Percepción)", "La Historia del Rey Shrenika y Mahavira", "Relatos de la vida anterior de Mahavira", "La historia de Chandanbala", "La historia de Bahubali (Gomateshwara)", "Leyendas sobre la conversión de Chandragupta Maurya", "Cuentos Jatakas adaptados en el Jainismo", "Historias sobre la compasión de los Tirthankaras", "Parábolas sobre el Karma y sus consecuencias", "Relatos de monjes y monjas ejemplares", "La historia de Sulasā y las pruebas de fe", "El mercader y las cinco joyas", "El rey y el asceta", "La parábola del árbol de los deseos",
            // Símbolos
            "El Símbolo Jaina Unificado (Pratik)", "El Significado de la Mano con la Rueda (Ahimsa)", "La Esvástica Jaina (Símbolo de Suparshvanatha / Bienestar)", "El Om Jaina", "El Loto (Padma)", "Los Ashtamangala (Ocho Símbolos Auspiciosos)", "Colores en el Jainismo",
            // Añadir más conceptos, preguntas, comparaciones...
            "Comparación entre Jainismo y Budismo", "Comparación entre Jainismo e Hinduismo", "Influencia del Jainismo en Mahatma Gandhi", "El rol de la mujer en el Jainismo", "La visión Jaina del universo y la vida extraterrestre", "¿Qué significa ser un laico Jaina?", "Desafíos de practicar Ahimsa en la vida moderna", "¿Cómo explica el Jainismo el sufrimiento?", "El camino hacia la liberación paso a paso", "¿Es el Jainismo una religión atea?", "Interpretaciones modernas de Anekantavada", "El vegetarianismo Jaina y la salud", "¿Qué pasa después de la muerte según el Jainismo?", "La importancia del perdón (Kshamavani)"
        ];
        const jainismThemes = [
            "historias de Tirthankaras", "conceptos filosóficos jainas", "principios éticos del Jainismo", "Ahimsa", "Anekantavada", "Aparigraha", "Karma y reencarnación jaina", "Moksha", "prácticas y rituales jainas", "ayuno jaina", "meditación jaina", "escrituras Agamas", "sectas Svetambara y Digambara", "lugares sagrados jainas", "arte y arquitectura jaina", "parábolas jainas", "Jainismo y no violencia", "figuras históricas jainas", "cosmología jaina", "vida monástica jaina", "símbolos jainas"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un erudito respetuoso y conocedor profundo de la filosofía, historia y relatos del Jainismo. Tu tarea es narrar o explicar el tema Jaina indicado (sea una historia, concepto, figura, lugar o práctica) de manera clara, precisa, atractiva y respetuosa. Si es una historia, cuéntala vívidamente. Si es un concepto, explícalo con analogías si es posible. Mantén un tono sereno y objetivo. Proporciona contexto histórico o filosófico relevante. El objetivo es una exposición detallada de aproximadamente 1200-1300 palabras. Basa tu respuesta únicamente en el siguiente tema del Jainismo:",
            timeoutSeconds: 150 // Mantenemos el timeout, el juego cubre la espera
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente versado en Jainismo, enfocado únicamente en el tema específico que se está mostrando. Responde preguntas de seguimiento sobre esta enseñanza, historia o concepto. Sé claro, conciso y mantén un tono respetuoso y educativo.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // *** Prompt para generar 40 títulos ***
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia sobre Jainismo. Genera exactamente 40 nombres de historias, conceptos filosóficos, figuras importantes, lugares sagrados o prácticas relevantes del Jainismo, adecuados para una descripción detallada. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo para generar más títulos
        };

        // ========== DOM ELEMENTS ==========
        // (Iguales que antes, más los del minijuego)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Contenedor del juego
        const modalStoryContentArea = document.getElementById('modal-story-content-area'); // Wrapper contenido real
        const modalTextArea = document.getElementById('modal-content-area'); // Área texto/imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameArea = document.getElementById('minigame-area');
        const minigameScoreDisplay = document.getElementById('minigame-score');
        const minigameLevelDisplay = document.getElementById('minigame-level');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Para chat context
        // Minigame State
        let gameActive = false;
        let gameScore = 0;
        let gameLevel = 1;
        let gameIntervalId = null;
        let elementsOnScreen = [];
        const levelThresholds = [0, 100, 300, 600, 1000, 1500, 2200, 3000, 4000, 5500]; // Puntos para cada nivel
        const gameElementTypes = [ // Símbolos y puntos que dan
            { icon: 'fas fa-hand-paper', points: 5, type: 'positive' }, // Ahimsa
            { icon: 'fas fa-om', points: 3, type: 'positive' },         // Om
            { icon: 'fas fa-dove', points: 4, type: 'positive' },       // Paz / Compasión
            { icon: 'fas fa-book-open', points: 2, type: 'positive' }, // Conocimiento/Satya
            { icon: 'fas fa-seedling', points: 3, type: 'positive' }, // Vida/Naturaleza
            { icon: 'fas fa-lock-open', points: 4, type: 'positive' }, // Asteya (No robar)
            { icon: 'fas fa-box-open', points: 5, type: 'positive' },  // Aparigraha (No posesión)
            { icon: 'fas fa-meditation', points: 6, type: 'positive'} // Meditación (si está disponible en FA) - si no, usar otro como 'fas fa-spa'
        ];
        const baseSpawnInterval = 1200; // ms
        const elementLifetime = 4000; // ms

        // ========== API FUNCTIONS ==========
        // fetchTextFromApi, fetchExplanationText, fetchChatResponse (sin cambios, usan mensajes amigables)
         async function fetchTextFromApi(prompt, config, isChat = false) {
              const encodedPrompt = encodeURIComponent(prompt);
              const systemPromptToUse = isChat && currentStoryTitle
                  ? `Eres un asistente experto en Jainismo, enfocado únicamente en el tema '${currentStoryTitle}'. Responde preguntas sobre él de forma clara, concisa y respetuosa.`
                  : config.systemPrompt;
              const encodedSystem = encodeURIComponent(systemPromptToUse);
              const params = new URLSearchParams({ model: config.model, system: encodedSystem });
              if (config.seed && !isChat) params.append('seed', config.seed);
              const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
              console.log(`Fetching text (Chat: ${isChat}): ${url.substring(0, 150)}...`);
              const controller = new AbortController();
              const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
              try {
                  const response = await fetch(url, { signal: controller.signal });
                  clearTimeout(timeoutId);
                  if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores pueden estar ocupados. Por favor, inténtalo de nuevo en unos momentos.`);
                  const text = await response.text();
                  if (!text || text.trim().length === 0) throw new Error("La respuesta de la IA llegó vacía. Intenta reformular.");
                  console.log(`API Response OK (${text.length} chars)`);
                  return text;
              } catch (error) {
                  clearTimeout(timeoutId);
                  console.error("API Fetch Error:", error);
                  if (error.name === 'AbortError') throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                  throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
              }
         }
         async function fetchExplanationText(conceptTitle) {
             return fetchTextFromApi(conceptTitle, textApiConfig, false);
         }
         async function fetchChatResponse(userQuery) {
             if (!currentStoryTitle) throw new Error("Error interno: Falta contexto para el chat.");
             return fetchTextFromApi(userQuery, chatApiConfig, true);
         }
         async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(jainismThemes) || "conceptos generales del Jainismo";
             // *** Pide 40 títulos ***
             const specificPrompt = `Genera 40 ítems (historias, conceptos, figuras, lugares, prácticas) sobre ${randomTheme}`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                  .then(text => {
                      const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 4 && line.length < 150);
                      // *** Espera al menos unas 20-30 para ser útil ***
                      if (titles.length < 20) throw new Error("La IA no generó suficientes enseñanzas nuevas.");
                      return titles.slice(0, 40); // Devuelve hasta 40
                  });
         }
         function createPollinationsImageUrl(promptText, options = {}) {
              const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
              const settings = { ...defaults, ...options };
              const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Jainism philosophy concept art";
              // Prompt adaptado a Jainismo: simbólico, sereno, evitar representaciones directas si es sensible.
              const enhancedPrompt = `Symbolic and serene artwork inspired by the Jain concept or story of '${safePromptText}'. Focus on elements like nature (lotus, trees), light, abstract patterns, Jain symbols (Ahimsa hand, Om). Use calm colors (white, saffron, green, earth tones). Avoid direct depiction of human figures unless essential. Peaceful atmosphere.`;
              const escapedPrompt = encodeURIComponent(enhancedPrompt);
              if (!escapedPrompt) return '';
              const negativePrompt = "photorealistic, photograph, human faces closeup, text, words, labels, diagram, chart, violent, dark, cluttered, chaotic, watermark, signature";
              const escapedNegative = encodeURIComponent(negativePrompt);
              let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
              if (settings.nologo) url += '&nologo=true';
              console.log("Image URL:", url);
              return url;
          }

        // ========== Text Formatting ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */ if(!rawText)return'';let formatted=rawText.trim();formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1');formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('−','-');return`${base}<sup>${cleanExponent}</sup>`;});formatted=formatted.replace(/\\rightarrow/g,'&rarr;');formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>');const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0);formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block;let content=block.replace(/\n/g,' ');return`<p>${content}</p>`;}).join('');return formatted;}

        // ========== MINIGAME FUNCTIONS ==========
        function startGame() {
            if (!minigameArea || gameActive) return;
            console.log("Starting Minigame");
            gameActive = true;
            gameScore = 0;
            gameLevel = 1;
            elementsOnScreen = [];
            minigameArea.innerHTML = ''; // Clear previous elements
            updateGameStats();
            // Start game loop
            const spawnInterval = Math.max(200, baseSpawnInterval - (gameLevel * 50)); // Faster spawn at higher levels
            gameIntervalId = setInterval(spawnGameElement, spawnInterval);
        }
        function stopGame() {
            if (!gameActive) return;
            console.log("Stopping Minigame");
            gameActive = false;
            clearInterval(gameIntervalId);
            gameIntervalId = null;
            // Remove any remaining elements
            elementsOnScreen.forEach(elData => elData.element.remove());
            elementsOnScreen = [];
        }
        function spawnGameElement() {
            if (!gameActive || !minigameArea) return;
            const type = getRandomElement(gameElementTypes);
            const element = document.createElement('i');
            element.className = `${type.icon} game-element ${type.type}`; // Usar clases FA y nuestras clases
            element.style.left = `${Math.random() * (minigameArea.offsetWidth - 30)}px`; // -30 para que no se salga del borde
            element.style.top = `${Math.random() * (minigameArea.offsetHeight - 30)}px`;

            const elementData = { element, type, id: Date.now() + Math.random() };
            elementsOnScreen.push(elementData);

            element.onclick = (event) => handleElementClick(event, elementData);

            minigameArea.appendChild(element);

            // Auto-remove after lifetime
            setTimeout(() => {
                if (gameActive && element.parentNode) {
                    element.style.opacity = '0'; // Fade out
                    setTimeout(() => element.remove(), 300); // Remove after fade
                    elementsOnScreen = elementsOnScreen.filter(el => el.id !== elementData.id);
                } else if (element.parentNode){
                     element.remove(); // Remove immediately if game stopped
                }
            }, elementLifetime);
        }
        function handleElementClick(event, elementData) {
            if (!gameActive) return;
            event.stopPropagation(); // Prevent clicks bubbling up if needed

            const points = elementData.type.points;
            gameScore += points;

            // Show points feedback animation
            const feedback = document.createElement('div');
            feedback.className = 'points-feedback';
            feedback.textContent = `+${points}`;
            feedback.style.left = `${event.clientX - minigameArea.getBoundingClientRect().left}px`;
            feedback.style.top = `${event.clientY - minigameArea.getBoundingClientRect().top - 15}px`; // Start slightly above click
            minigameArea.appendChild(feedback);
            setTimeout(() => feedback.remove(), 800); // Remove after animation

            // Remove clicked element
            elementData.element.remove();
            elementsOnScreen = elementsOnScreen.filter(el => el.id !== elementData.id);

            checkLevelUp();
            updateGameStats();
        }
        function checkLevelUp() {
            const nextLevel = gameLevel + 1;
            if (nextLevel < levelThresholds.length && gameScore >= levelThresholds[nextLevel]) {
                gameLevel = nextLevel;
                console.log("Level Up!", gameLevel);
                // Potentially adjust game speed/difficulty here if desired
                clearInterval(gameIntervalId); // Clear old interval
                const spawnInterval = Math.max(200, baseSpawnInterval - (gameLevel * 50));
                gameIntervalId = setInterval(spawnGameElement, spawnInterval); // Start new interval
            }
        }
        function updateGameStats() {
            if(minigameScoreDisplay) minigameScoreDisplay.textContent = gameScore;
            if(minigameLevelDisplay) minigameLevelDisplay.textContent = gameLevel;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            stopGame(); // Ensure game stops when modal hides
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             // Don't show loading indicator immediately, handleTitleClick will show it
             modalLoadingIndicator.classList.remove('active');
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null;
             hideFullscreenImage();
             // Reset game state variables just in case
             gameScore = 0;
             gameLevel = 1;
             gameActive = false;
             if(gameIntervalId) clearInterval(gameIntervalId);
             gameIntervalId = null;
             elementsOnScreen = [];
        }

        // ========== Fullscreen Image Functions ========== (sin cambios)
        function showFullscreenImage(imgSrc) { if(!imageFullscreenOverlay||!fullscreenImage)return; fullscreenImage.src=imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow='hidden'; }
        function hideFullscreenImage() { if(!imageFullscreenOverlay)return; imageFullscreenOverlay.classList.remove('active'); if(!storyModal.classList.contains('active')){document.body.style.overflow='';} fullscreenImage.src=''; }

        // ========== Chat Functions ========== (sin cambios)
        function addChatMessage(message,sender){const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        function addChatError(message){const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        async function handleSendMessage(){const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Error IA: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}}

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
            if (!titleListContainer || !titlesLoading) return;
            const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay enseñanzas disponibles «</p>'; return; }
            sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
        }
        function appendTitles(newTitles) {
            if (!titleListContainer || !newTitles || newTitles.length === 0) return;
            const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
            newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
            filterTitles(searchInput.value); // Re-apply filter
        }

        // *** MODIFIED: handleTitleClick to run game during load ***
        async function handleTitleClick(title) {
            resetModalState(); // Limpia todo, incluido el juego anterior
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // Set chat context

            // Show loading overlay and START THE MINIGAME
            modalLoadingIndicator.classList.add('active');
            modalStoryContentArea.classList.add('content-hidden'); // Oculta área de contenido real
            startGame(); // Inicia el minijuego

            try {
                // Fetch text and image URL in parallel
                const textPromise = fetchExplanationText(title);
                const imageUrl = createPollinationsImageUrl(title); // Generate URL immediately

                // Wait for the text to arrive
                const rawExplanationText = await textPromise;

                // STOP THE GAME once text is ready
                stopGame();
                modalLoadingIndicator.classList.remove('active'); // Oculta loading/juego

                // Process and display content
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalContent.innerHTML = formattedExplanation; // Poner texto

                modalStoryContentArea.classList.remove('content-hidden'); // Mostrar área de contenido
                modalTextArea.scrollTop = 0; // Reset scroll DESPUÉS de que sea visible
                console.log("Scroll reset after content visible");

                // Prepare image placeholder and load image (as before)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando ilustración...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración sobre ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Ilustración no disponible.</p>`;
                };

                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                    placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                stopGame(); // Ensure game stops on error too
                modalLoadingIndicator.classList.remove('active'); // Oculta loading/juego
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la enseñanza.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Mostrar área para ver error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más sabiduría...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Ya pide 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron encontrar más enseñanzas en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar enseñanzas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // *** Botón dice (40) ***
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Enseñanzas (40)';
             }
         }

        // Search Filter Function (con normalización)
        function filterTitles(searchTerm) {
            const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
            const titleItems = titleListContainer.querySelectorAll('.title-item');
            let visibleCount = 0;
            titleItems.forEach(item => {
                const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const isVisible = titleText.includes(term);
                item.classList.toggle('hidden', !isVisible);
                if (isVisible) visibleCount++;
            });
            noResultsMsg.classList.toggle('hidden', visibleCount > 0);
        }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check all essential elements including minigame displays
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameArea || !minigameScoreDisplay || !minigameLevelDisplay || !modalLoadingIndicator) {
                console.error("Initialization failed: Missing essential UI elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Faltan componentes de la interfaz. No se puede iniciar la aplicación.</p>';
                return;
             }
            // Standard Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial Display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            modalLoadingIndicator.classList.remove('active'); // Ensure loading is hidden initially
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>