<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crónicas de Dolor y Venganza</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Dramáticas/Serias -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Dolor y Venganza --- */
        :root {
            --color-primary: #8b0000; /* Rojo Oscuro (Sangre, Ira) */
            --color-secondary: #a9a9a9; /* Gris Oscuro (Sombras, Ceniza) */
            --color-tertiary: #daa520; /* Dorado Pálido (Riqueza Perdida, Destino) - Uso moderado */
            --color-background: #1a1a1a; /* Casi Negro (Oscuridad, Misterio) */
            --color-text: #dcdcdc; /* Gris Muy Claro (Lectura sobre fondo oscuro) */
            --color-text-muted: #808080; /* Gris Medio */
            --color-modal-bg: #2b2b2b; /* Gris Carbón */
            --color-border: #444444; /* Borde Gris Oscuro */
            --color-error-bg: #4b0000; /* Fondo error rojo muy oscuro */
            --color-error-text: #f5c6cb; /* Texto error rosa pálido */
            --color-error-border: #dc2626; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.6), 0 4px 6px -4px rgba(0, 0, 0, 0.5);
            --border-radius: 4px;
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Cormorant Garamond', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); text-shadow: 1px 1px 3px rgba(139, 0, 0, 0.6); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 600; }
        #modal-title { color: var(--color-primary); font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .navbar { background-color: rgba(26, 26, 26, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(43, 43, 43, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; border-left: 4px solid transparent; position: relative; overflow: hidden;}
        .title-item::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(139, 0, 0, 0.2), transparent); transition: left 0.6s ease; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #333; border-left-color: var(--color-primary); }
        .title-item:hover::before { left: 100%; }
        #generate-more-btn { grid-column: 1 / -1; background: var(--color-primary); color: var(--color-text); padding: 0.9rem 1.8rem; border: 1px solid #6a0000; border-radius: var(--border-radius); font-family: 'Cormorant Garamond', serif; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; letter-spacing: 1px; text-shadow: 1px 1px 2px #000; }
        #generate-more-btn:hover:not(:disabled) { background-color: #a00000; border-color: #8b0000; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; text-shadow: none; border-color: #333; }
        #generate-more-btn .fa-sync-alt { color: var(--color-text); }

        #story-modal { /* Estilos generales iguales */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { /* Ligeramente más anchos si es necesario */ background-color: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: 1.5rem 2rem; max-width: 1000px; width: 95%; max-height: 90vh; min-height: 450px; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; border-top: 5px solid var(--color-primary); }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); box-shadow: 0 0 8px var(--color-primary); }
        #modal-title { font-size: 2.1rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) #444;
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: #444; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid #2b2b2b; }

        #modal-content { padding: 0 5px; font-size: 1.05rem; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cormorant Garamond', serif; margin-top: 2.4em; margin-bottom: 1.2em; color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 600; }
        #modal-content h1 { font-size: 1.6em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 3rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; filter: grayscale(30%); }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 15px rgba(139, 0, 0, 0.4); filter: grayscale(0%); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 3rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(68, 68, 68, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; /* Ajustar altura chat */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.6rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(26, 26, 26, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) #444;
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: #444; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.55; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: var(--color-text); margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #444; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #333; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); background-color: #444; }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: var(--color-text); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #a00000; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Modal Loading con Minijuego */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(43, 43, 43, 0.98); /* Fondo semi-transparente */
            display: none; /* Inicialmente oculto */
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius); padding: 2rem;
            color: var(--color-text); text-align: center;
        }
        #modal-loading.active { display: flex; } /* Clase para mostrarlo */
        #loading-message { font-family: 'Cormorant Garamond', serif; font-size: 1.6rem; margin-bottom: 1.5rem; text-shadow: 1px 1px 2px #000; }
        /* Estilos Minijuego */
        #minigame-area {
            width: 90%; max-width: 350px; height: 200px;
            background-color: rgba(26, 26, 26, 0.7); border: 1px solid var(--color-border);
            position: relative; cursor: crosshair; margin-bottom: 1rem;
            border-radius: var(--border-radius); overflow: hidden;
        }
        #minigame-target {
            width: 40px; height: 40px;
            background-color: var(--color-primary);
            border-radius: 50%; /* Círculo */
            position: absolute;
            cursor: pointer;
            transition: all 0.1s ease-out; /* Transición suave al mover */
            box-shadow: 0 0 10px rgba(139, 0, 0, 0.7);
            display: none; /* Oculto al inicio */
        }
        #minigame-target.active { display: block; } /* Visible cuando está activo */
        #minigame-score { font-family: 'Lato', sans-serif; font-size: 1.1rem; margin-top: 1rem; }
        #minigame-score span { font-weight: 700; color: var(--color-primary); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay (sin cambios funcionales, solo estéticos) */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-book-dead mr-3"></i> <!-- Icono libro muerto/antiguo -->
                     Crónicas de Venganza
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">~ Ecos de Dolor y Retribución ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Donde el Agravio Clama Justicia</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Explora relatos de almas atormentadas, pactos oscuros y la ineludible senda de la venganza. Cada historia, una herida abierta; cada final, una cuenta saldada... o perpetuada.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar por traición, pérdida, injusticia...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll text-gray-400 mr-2"></i> <!-- Icono pergamino -->
                 Archivo de Agravios
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Desenterrando los relatos olvidados...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">~ Ningún eco responde a esa búsqueda ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Invocar Más Historias (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator con Minijuego -->
             <div id="modal-loading">
                 <p id="loading-message">Forjando la narrativa...</p>
                 <div id="minigame-area">
                     <div id="minigame-target"></div>
                 </div>
                 <div id="minigame-score">Puntuación: <span>0</span></div>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Escuchando los susurros...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre los detalles oscuros...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-black text-gray-600 py-6 mt-12 border-t border-gray-800 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Estas crónicas son obras de ficción generadas por IA, explorando las profundidades del dolor y la venganza.</p>
              <p class="mt-1">Cualquier parecido con eventos reales es pura coincidencia sombría.</p>
              <p class="mt-2">© Cronista Anónimo</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Traición Amorosa
            "El Corazón Roto del Marqués", "La Venganza de la Novia Fantasma", "El Amante Traicionado y el Veneno Lento", "Cuando el Amor se Convierte en Cenizas", "El Secreto Oscuro Bajo el Lecho Nupcial", "La Daga Escondida en el Ramo de Rosas", "El Juramento Roto y la Maldición Eterna", "La Dama Escarlata y su Venganza Fría", "El Espejo que Reflejaba la Infidelidad", "El Jardín Marchito del Amor Perdido", "El Precio de una Caricia Prohibida", "La Canción de Cuna del Engaño", "El Collar Maldito de la Amante", "El Último Baile del Corazón Engañado", "La Sombra del Tercero en Discordia",
            // Traición Familiar / Amistad
            "El Heredero Despojado y el Pacto de Sangre", "La Sonrisa del Hermano Traidor", "El Amigo que Robó un Destino", "La Cicatriz Invisible de la Confianza Rota", "El Legado Envenenado", "La Caída de la Casa Noble por Envidia", "El Juramento Olvidado entre Hermanos de Armas", "El Secreto Familiar que Desató la Furia", "La Máscara de Amistad que Ocultaba Odio", "El Precio de la Lealtad Familiar Quebrada", "Cuando la Sangre Clama Venganza", "El Círculo Roto de la Confianza", "El Refugio que se Volvió Prisión", "La Traición Susurrada en Confidencia", "El Oro que Compró la Deslealtad",
            // Injusticia y Falsa Acusación
            "El Inocente en la Mazmorra del Olvido", "La Venganza del Condenado sin Pruebas", "Cuando la Justicia Ciega Favorece al Culpable", "El Exilio Injusto y el Regreso Sombrío", "La Balanza Rota de la Ley", "El Testimonio Falso que Arruinó una Vida", "El Juicio Arreglado y la Furia Silenciosa", "La Marca del Criminal Inocente", "Años Perdidos, Odio Ganado", "El Sistema que Protege al Poderoso", "La Caza del Verdadero Culpable", "El Grito Silenciado de la Inocencia", "La Conspiración para Ocultar la Verdad", "El Juez Corrupto y su Hora Final", "La Evidencia Fabricada",
            // Pérdida y Duelo Convertido en Odio
            "La Venganza por la Muerte del Ser Amado", "El Legado Robado y la Retribución", "La Cuna Vacía y el Corazón Lleno de Odio", "El Guardián Caído y el Juramento de Venganza", "El Incendio que Consumió Todo Menos el Rencor", "La Ruina Inmerecida y el Desquite", "El Último Suspiro que Encendió la Llama", "El Objeto Perdido que Guiaba la Venganza", "El Eco de la Risa Apagada", "La Deshonra que Exige Sangre", "El Robo de la Identidad y la Recuperación Violenta", "El Hogar Destruido, el Espíritu Vengador", "La Promesa Incumplida al Moribundo", "El Tesoro Perdido, la Vida Cobrada", "El Silencio Tras la Tragedia",
            // Humillación y Abuso
            "La Venganza del Sirviente Humillado", "El Secreto Vergonzoso Revelado", "Años de Abuso, un Instante de Venganza", "La Cicatriz del Desprecio", "El Poder Usado para Oprimir", "El Regreso del Marginado", "La Risa Burlona que se Apagó", "El Esclavo que se Convirtió en Verdugo", "El Juego Cruel y su Final Sangriento", "La Deuda de Humillación Cobrada con Intereses", "El Espejo Roto de la Dignidad", "El Susurro del Escarnio", "La Fortaleza Construida sobre la Debilidad Ajena", "El Desquite del Débil Hecho Fuerte", "La Caída del Tirano",
            // Venganza Sobrenatural / Maldiciones
            "El Fantasma Vengador de la Mansión Olvidada", "La Maldición del Objeto Robado", "El Pacto con la Oscuridad por Poder Vengativo", "El Retorno desde la Tumba para Saldar Cuentas", "La Muñeca que Susurraba Venganzas", "La Sombra que Acechaba al Culpable", "El Ritual Prohibido para la Justicia Sobrenatural", "La Entidad Convocada por el Dolor", "El Linaje Maldito por un Crimen Antiguo", "La Venganza Escrita en Runas de Sangre", "El Espectro Atado a su Asesino", "El Necromante y su Ejército de Agraviados", "La Justicia del Más Allá", "El Amuleto que Protegía y Vengaba", "El Demonio Guardián de una Promesa Rota",
            // Venganza Histórica / Colectiva
            "La Rebelión de los Oprimidos", "La Venganza del Pueblo contra el Tirano", "La Conspiración Silenciosa de los Esclavos", "El Legado de Odio entre Familias Rivales", "La Guerra Secreta por una Antigua Afrenta", "La Secta Vengadora de una Fe Perseguida", "El Último Descendiente y la Deuda de Sangre Ancestral", "La Memoria Colectiva del Agravio", "El Gremio Secreto de los Despojados", "La Caída del Imperio por Traiciones Internas", "La Cicatriz Histórica que Supura Odio", "El Pueblo Olvidado que Regresa", "La Justicia Tardia de Generaciones", "La Venganza Forjada en el Exilio", "El Mapa que Llevaba a la Caída del Enemigo",
            // Venganza Fría y Calculada
            "El Plan Maestro Tejido Durante Años", "La Paciencia del Cazador Vengador", "La Trampa Perfecta para el Enemigo Confiado", "La Venganza Servida en Plato Frío", "El Ajedrecista del Odio", "La Caída Lenta y Metódica del Adversario", "La Falsa Amistad como Arma Definitiva", "El Veneno Administrado Gota a Gota", "La Ruina Financiera Orquestada", "El Engaño Sutil con Consecuencias Fatales", "La Manipulación Psicológica como Venganza", "El Secreto Revelado en el Momento Oportuno", "La Red de Mentiras que Atrapa al Culpable", "El Legado Destruido por Dentro", "La Sonrisa Helada de la Victoria Póstuma",
             // Continuará con más categorías y títulos... El botón 'Generar Más' añadirá variedad.
             "El Eco en el Pozo de los Lamentos", "La Carta Jamás Enviada", "El Retrato que Cobró Vida para Vengar", "La Melodía Prohibida que Traía la Locura", "El Reloj Detenido en la Hora del Crimen", "La Venganza del Bufón Triste", "El Laberinto Mental del Atormentado", "La Isla de los Olvidados y su Ley Secreta", "El Último Deseo del Moribundo: Venganza", "La Máscara que Lloraba Sangre", "El Puente Donde se Selló el Pacto Infernal", "La Biblioteca de las Almas Agraviadas", "El Oráculo que Predijo la Caída", "La Fiera Despertada por el Dolor", "El Vino Envenenado en la Copa de la Celebración", "El Juicio de las Sombras", "La Armadura Maldita del Caballero Traidor", "El Bosque que No Perdonaba", "La Deuda Impagable del Alma", "El Titiritero que Movía los Hilos del Destino",
             "La Justicia Poética del Destino", "El Ladrón de Recuerdos", "El Fuego Purificador de la Venganza", "El Silencio Cómplice", "La Verdad Oculta en la Mentira Perfecta", "El Regalo Envenenado", "La Tormenta Interior Desatada", "El Peregrino de la Venganza", "La Ciudadela de los Rencores", "El Código Secreto de los Vengadores", "La Flor que Florecía sobre la Tumba del Enemigo", "El Eco de un Grito en la Noche", "La Senda Marcada por Lágrimas de Sangre", "El Reflejo Distorsionado del Pasado", "El Legado de un Corazón Roto", "El Fantasma del Teatro Abandonado", "La Venganza del Alquimista Loco", "El Mapa Tatuado en la Piel del Traidor", "La Canción del Marinero Ahogado", "El Secreto Guardado por el Golem de Arcilla", "La Feria de las Pesadillas Cumplidas", "El Relicario que Contenía un Alma Vengativa", "La Profecía del Último Día del Tirano", "El Golem de Hielo y la Venganza Glacial", "La Conspiración de los Espejos Rotos", "El Libro de los Agravios No Olvidados", "La Criatura del Pantano Nacida del Rencor", "El Autómata Programado para Matar", "La Venganza susurrada por el Viento", "El Jardín Petrificado de las Víctimas", "El Baile Macabro de los Condenados", "La Deuda Kármica Pagada con Sangre", "El Manto de Invisibilidad del Asesino Sigiloso", "La Fortaleza Inexpugnable de la Tristeza", "El Eco de Pasos en el Pasillo Vacío", "La Maldición Gitana sobre el Linaje Infiel", "El Retorno del Guerrero Dado por Muerto", "La Venganza Esculpida en Piedra", "El Poema Inacabado del Poeta Traicionado", "La Sinfonía de la Destrucción", "El Laberinto de Setos y Secretos Mortales", "La Venganza de la Naturaleza Profanada", "El Último Banquete del Usurpador", "La Justicia Ciega de la Dama del Velo", "El Faro que Guiaba Hacia la Muerte", "La Colección de Lágrimas Embotelladas", "El Gato Negro que Anunciaba la Desgracia", "La Venganza Oculta en una Obra de Arte", "El Pacto Roto con los Antiguos Dioses",
             // ... (continuar añadiendo hasta acercarse a 400 o más)
        ];
        const vengeanceThemes = [ // Para generar más títulos
            "traición amorosa", "venganza familiar", "amistad rota", "falsa acusación", "justicia fallida", "pérdida irreparable", "duelo y odio", "humillación pública", "abuso de poder", "venganza sobrenatural", "fantasmas vengadores", "maldiciones ancestrales", "pactos oscuros", "venganza histórica", "rebelión popular", "enemistades legendarias", "venganza calculada", "planes a largo plazo", "infiltración y engaño", "venganza poética", "justicia kármica", "secretos revelados", "el regreso del agraviado", "la caída del tirano", "venganza desde la tumba", "objetos malditos", "lugares embrujados por el rencor", "la venganza del artista", "el científico loco vengador", "venganza corporativa", "la venganza del débil", "el último acto de desafío", "la cicatriz que nunca cierra"
        ];
        const textApiConfig = { // Descripción de la historia
            model: "mistral",
            systemPrompt: "Eres un Cronista de lo Oscuro, un narrador experto en tejer historias de profundo dolor y retorcida venganza. Relata la historia sugerida por el título con una atmósfera densa, explorando las motivaciones nacidas del agravio, el descenso a la oscuridad del protagonista (o antagonista) y las consecuencias, a menudo trágicas, de la búsqueda de retribución. Utiliza un lenguaje evocador, rico en metáforas sombrías y detalles psicológicos. No temas explorar la ambigüedad moral. La narrativa debe ser inmersiva y tener aproximadamente 1200-1300 palabras. Basa tu crónica únicamente en la siguiente semilla de historia:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Chat sobre la historia
            model: "mistral-tiny",
            systemPrompt: "Actúa como un eco de la historia que se está contando, un conocedor de sus detalles más oscuros. Responde preguntas sobre los personajes, sus motivaciones ocultas, los giros de la trama o el simbolismo presente en la narrativa actual. Mantén el tono sombrío y enigmático de la crónica. Sé conciso y relevante al relato específico.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // Generar más títulos
            model: "mistral",
            // *** ACTUALIZADO PARA PEDIR 40 ***
            systemPrompt: "Actúa como una musa oscura. Genera exactamente 40 títulos evocadores para historias centradas en el dolor, la traición, la injusticia y la venganza. Busca originalidad y profundidad emocional. Devuelve *solo* la lista de títulos, uno por línea. Sin números, guiones, introducciones ni comentarios.",
            timeoutSeconds: 60 // Aumentar ligeramente por pedir más títulos
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, pero verificar nombres si se cambian)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Ahora contiene el juego
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements (igual)
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements (igual)
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameArea = document.getElementById('minigame-area');
        const minigameTarget = document.getElementById('minigame-target');
        const minigameScoreDisplay = document.getElementById('minigame-score').querySelector('span');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Contexto para chat
        let minigameInterval = null;
        let minigameTimeout = null;
        let minigameScore = 0;
        let isGameRunning = false;

        // ========== MINIGAME FUNCTIONS ==========
        function updateScore(newScore) {
            minigameScore = newScore;
            minigameScoreDisplay.textContent = minigameScore;
        }

        function moveTarget() {
            if (!isGameRunning || !minigameArea || !minigameTarget) return;

            const areaRect = minigameArea.getBoundingClientRect();
            const targetSize = minigameTarget.offsetWidth; // Asume width=height

            // Calcula posición aleatoria dentro del área, asegurando que el target quepa entero
            const maxX = areaRect.width - targetSize;
            const maxY = areaRect.height - targetSize;

            const randomX = Math.max(0, Math.floor(Math.random() * maxX));
            const randomY = Math.max(0, Math.floor(Math.random() * maxY));

            minigameTarget.style.left = `${randomX}px`;
            minigameTarget.style.top = `${randomY}px`;
            minigameTarget.classList.add('active'); // Asegura que sea visible

            // Reinicia el timeout para moverlo de nuevo si no se clickea
            clearTimeout(minigameTimeout);
            minigameTimeout = setTimeout(moveTarget, 1200 + Math.random() * 800); // Mover cada 1.2-2 segundos
        }

        function targetClicked() {
            if (!isGameRunning) return;
            updateScore(minigameScore + 1);
            minigameTarget.classList.remove('active'); // Ocultar brevemente al acertar
            clearTimeout(minigameTimeout); // Limpiar timeout anterior
            // Mover inmediatamente a nueva posición tras acierto
            setTimeout(() => {
                 if (isGameRunning) moveTarget(); // Mover solo si el juego sigue activo
            }, 150); // Pequeña pausa antes de reaparecer
        }

        function startGame() {
            if (isGameRunning || !modalLoadingIndicator || !minigameTarget) return;
            console.log("Starting minigame...");
            isGameRunning = true;
            updateScore(0); // Reset score
            modalLoadingIndicator.classList.add('active'); // Muestra toda el área de carga
            minigameTarget.addEventListener('click', targetClicked);
            moveTarget(); // Coloca el primer target
        }

        function stopGame() {
            if (!isGameRunning) return;
            console.log("Stopping minigame.");
            isGameRunning = false;
            clearTimeout(minigameTimeout);
            clearInterval(minigameInterval); // Asegurar que no haya intervalos perdidos
            if (minigameTarget) {
                 minigameTarget.removeEventListener('click', targetClicked);
                 minigameTarget.classList.remove('active'); // Ocultar target
            }
            // No ocultar modalLoadingIndicator aquí, se hará cuando el contenido esté listo o falle
        }


        // ========== API FUNCTIONS ========== (Ajuste en fetchGeneratedTitles)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `Eres un eco de la historia llamada '${currentStoryTitle}'. Responde preguntas sobre sus personajes, motivaciones ocultas, giros o simbolismo. Mantén el tono sombrío y enigmático. Sé conciso y relevante al relato.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text (${config.model}, Chat: ${isChat}): ${url.substring(0, 150)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, intenta en unos segundos.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la IA llegó vacía. Intenta de nuevo.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(title) { return fetchTextFromApi(title, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentStoryTitle) throw new Error("Contexto de historia perdido para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() { // *** ACTUALIZADO PARA 40 ***
            const randomTheme = getRandomElement(vengeanceThemes) || "historias de venganza";
            const specificPrompt = `Genera 40 títulos evocadores sobre ${randomTheme}`;
            console.log("Generating 40 titles with prompt:", specificPrompt);
            // Usa la config actualizada que pide 40 títulos
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     // Ajustar la validación si esperamos más títulos
                     if (titles.length < 20) throw new Error("La IA no generó suficientes ideas de historias (se esperaban ~40).");
                     return titles.slice(0, 40); // Asegura que no devuelve más de 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "dark vengeance story concept art";
             // Prompt para arte oscuro, simbólico, atmosférico
             const enhancedPrompt = `Dark, atmospheric, symbolic artwork representing the story concept '${safePromptText}'. Focus on emotion (pain, anger, sorrow, determination), symbolism (broken objects, shadows, storms, blood motifs subtly used), and mood. Gothic, noir, or fantasy art style. Avoid literal depictions, faces unless essential, text, labels.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, photorealistic, happy, bright, cheerful, cartoonish, simple background";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (identical to previous versions) ... */
            if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Integración minijuego)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            stopGame(); // Asegura que el juego se detenga al cerrar
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             // No mostrar loading indicator aún, startGame lo hará
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null;
             hideFullscreenImage();
             // El indicador de carga/juego se maneja por separado
             if(modalLoadingIndicator) modalLoadingIndicator.classList.remove('active');
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (identical) ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... (identical) ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... (identical) ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... (identical) ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... (identical) ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ========== (Integración minijuego)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... (identical styling logic) ... */ if (!titleListContainer || !titlesLoading) return; const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none'; if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">~ El archivo está vacío ~</p>'; return; } sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { /* ... (identical logic) ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title)); newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } }); filterTitles(searchInput.value); }

        // *** MODIFIED: handleTitleClick to start/stop minigame ***
        async function handleTitleClick(title) {
            resetModalState(); // Limpia estado anterior
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // Contexto chat
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');

            startGame(); // *** INICIA EL MINIJUEGO AQUÍ ***

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                stopGame(); // *** DETIENE EL JUEGO ANTES DE MOSTRAR CONTENIDO ***
                modalLoadingIndicator.classList.remove('active'); // Oculta pantalla de carga/juego

                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Muestra contenido+chat

                modalTextArea.scrollTop = 0; // Resetea scroll del texto
                console.log("Scroll set to 0 after content visible");

                // Añadir imagen (lógica idéntica a la anterior)
                const placeholderDiv = document.createElement('div'); /*...*/ placeholderDiv.className = 'image-placeholder'; placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Revelando la visión...</p>`; modalContent.appendChild(placeholderDiv);
                const imgElement = document.createElement('img'); /*...*/ imgElement.className = 'final-image'; imgElement.alt = `Visualización de ${title}`; imgElement.style.display = 'none';
                imgElement.onload = () => { console.log("Image loaded."); placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { console.error("Err img:", title); placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visión fallida.</p>`; };
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { console.error("No img URL:", title); placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                stopGame(); // *** ASEGURA DETENER JUEGO EN ERROR ***
                modalLoadingIndicator.classList.remove('active'); // Oculta carga/juego
                modalErrorMessage.textContent = error.message || "Una sombra impidió cargar la historia.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles requests 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Conjurando relatos...';
             try {
                 // fetchGeneratedTitles ya pide 40
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Las sombras no respondieron con nuevas historias."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al invocar historias: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Texto actualizado para reflejar 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Invocar Más Historias (40)';
             }
         }

         // *** Search Filter Function (sin cambios funcionales) ***
         function filterTitles(searchTerm) { /* ... (identical logic, maybe update placeholder text) ... */ const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); const titleItems = titleListContainer.querySelectorAll('.title-item'); let visibleCount = 0; titleItems.forEach(item => { const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const isVisible = titleText.includes(term); item.classList.toggle('hidden', !isVisible); if (isVisible) visibleCount++; }); noResultsMsg.classList.toggle('hidden', visibleCount > 0); }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Verificar todos los elementos necesarios, incluyendo los del minijuego
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalLoadingIndicator || !minigameArea || !minigameTarget || !minigameScoreDisplay) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">++ ERROR CRÍTICO ++ Faltan componentes de la interfaz ++</p>';
                return;
             }
            // Listeners existentes
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Carga inicial
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            modalLoadingIndicator.classList.remove('active'); // Asegura que no se muestre al inicio
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>