<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cultiva Hábitos Positivos - Guía Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y amigables -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Hábitos Positivos --- */
        :root {
            --color-primary: #22c55e; /* Verde Vibrante (Crecimiento) */
            --color-secondary: #3b82f6; /* Azul Suave (Calma) */
            --color-tertiary: #facc15; /* Amarillo Sol (Energía) */
            --color-background: #f8fafc; /* Blanco Hueso / Muy Claro */
            --color-text: #334155; /* Gris Oscuro Azulado (Legible) */
            --color-text-muted: #64748b; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro para Modal */
            --color-border: #e2e8f0; /* Borde Gris Claro */
            --color-error-bg: #fff1f2; /* Fondo error rosa pálido */
            --color-error-text: #be123c; /* Texto error rojo oscuro */
            --color-error-border: #fecdd3; /* Borde error rosa */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 8px; /* Bordes más redondeados y amigables */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Poppins', sans-serif; font-weight: 600; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 600; }
        #modal-title { color: var(--color-secondary); font-weight: 600; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: white; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Nunito'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Nunito'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-border); color: var(--color-primary); background-color: #f0fdf4; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { background-color: #16a34a; box-shadow: var(--shadow-md); transform: translateY(-1px); }
        #generate-more-btn:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(51, 65, 85, 0.85); /* Overlay gris azulado */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e2e8f0; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Poppins', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 600; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; font-weight: 400;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(156, 163, 175, 0.3); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; /* Fondo muy claro */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; box-shadow: var(--shadow-sm); }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; /* Mejor para lectura */ font-weight: 400; border-bottom-right-radius: 0;}
        .ai-message { background-color: var(--color-modal-bg); color: var(--color-text); border: 1px solid var(--color-border); margin-right: auto; text-align: left; font-weight: 400; border-bottom-left-radius: 0; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem;}
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Nunito'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-secondary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #2563eb; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(248, 250, 252, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid #e2e8f0; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.3rem; font-family: 'Poppins'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Nunito'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(248, 250, 252, 0.95); /* Fondo claro */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 1px solid var(--color-border); box-shadow: var(--shadow-lg); border-radius: var(--border-radius); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); box-shadow: var(--shadow-sm); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-seedling mr-3 text-green-500"></i> <!-- Icono planta creciendo -->
                     Cultiva Hábitos
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Tu Guía Interactiva para el Bienestar «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Construye una Vida Mejor, Hábito a Hábito</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora el poder de las pequeñas acciones diarias. Descubre, aprende e integra hábitos positivos para tu mente, cuerpo y espíritu.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar un hábito (ej: meditar, leer, ejercicio...)">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-spa text-blue-500 mr-2"></i> <!-- Icono bienestar/spa -->
                 Catálogo de Hábitos Positivos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando biblioteca de hábitos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No encontramos hábitos que coincidan con tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Inspirarme con Más Hábitos (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Explorando el hábito...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <h3 class="text-lg font-semibold mb-2 text-center text-gray-700 font-poppins">¿Preguntas sobre este hábito? ¡Chatea!</h3>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Pensando en tu consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Ej: ¿Cómo empiezo?, ¿Beneficios?...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-circle"></i> <!-- Icono diferente -->
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Conceptual del Hábito">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA basada en principios de psicología positiva y formación de hábitos.</p>
              <p class="mt-1">Consulta siempre a un profesional para asesoramiento personalizado.</p>
              <p class="mt-2">© 2025 Cultiva Hábitos</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Salud Física
            "Beber Suficiente Agua Diariamente", "Caminata Diaria de 30 Minutos", "Ejercicio de Fuerza 2-3 Veces por Semana", "Estiramientos Matutinos", "Yoga Suave Semanal", "Preparar Comidas Saludables en Casa (Meal Prep)", "Elegir Snacks Saludables (Frutas, Nueces)", "Reducir el Consumo de Azúcares Añadidos", "Limitar Alimentos Procesados", "Dormir 7-9 Horas Cada Noche", "Establecer un Horario de Sueño Regular", "Rutina Relajante Antes de Dormir", "Evitar Pantallas Antes de Acostarse", "Cepillarse los Dientes Después de Cada Comida", "Usar Hilo Dental Diariamente", "Chequeos Médicos Regulares", "Tomar Descansos Activos en el Trabajo", "Subir Escaleras en Lugar de Ascensor", "Practicar Deporte Recreativo", "Hidratar la Piel Diariamente", "Protegerse del Sol", "Cocinar con Ingredientes Frescos", "Comer Despacio y Masticar Bien", "Escuchar las Señales de Hambre y Saciedad del Cuerpo", "Limitar el Consumo de Alcohol", "No Fumar", "Lavarse las Manos Frecuentemente", "Mantener una Buena Postura", "Ejercicio Cardiovascular Moderado (Correr, Nadar, Bici)", "Pilates para Fortalecer el Core",
            // Salud Mental y Emocional
            "Meditación Mindfulness Diaria (5-10 min)", "Respiración Profunda para Calmarse", "Llevar un Diario de Gratitud", "Escribir Tres Cosas Buenas del Día", "Practicar la Autocompasión", "Identificar y Nombrar Emociones", "Establecer Límites Saludables", "Decir 'No' Cuando Sea Necesario", "Tiempo a Solas para Reflexionar", "Desconexión Digital Programada", "Limitar el Consumo de Noticias Negativas", "Escuchar Música Relajante o Inspiradora", "Pasar Tiempo en la Naturaleza", "Practicar un Hobby Creativo (Pintar, Escribir, Música)", "Aprender Algo Nuevo Cada Semana/Mes", "Leer Libros Regularmente (Ficción o No Ficción)", "Resolver Puzzles o Juegos Mentales", "Practicar el Pensamiento Positivo Realista", "Reencuadrar Pensamientos Negativos", "Celebrar Pequeñas Victorias", "Perdonar (a uno mismo y a otros)", "Manejo del Estrés (Identificar desencadenantes)", "Técnicas de Relajación Muscular Progresiva", "Visualización Positiva", "Buscar Ayuda Profesional Cuando Sea Necesario (Terapia)", "Practicar la Escucha Activa", "Expresar Emociones de Forma Asertiva", "Cultivar el Sentido del Humor", "Risa Diaria", "Mindful Walking (Caminata Consciente)",
            // Productividad y Metas
            "Planificar el Día la Noche Anterior", "Establecer 1-3 Prioridades Diarias", "Técnica Pomodoro (Trabajo Enfocado + Descansos)", "Bloquear Tiempo para Tareas Importantes", "Eliminar Distracciones Durante el Trabajo Enfocado", "Organizar el Espacio de Trabajo", "Revisión Semanal de Metas y Progreso", "Dividir Grandes Tareas en Pasos Pequeños", "Establecer Metas SMART (Específicas, Medibles, Alcanzables, Relevantes, Temporales)", "Aprender a Delegar Tareas", "Decir 'No' a Compromisos No Esenciales", "Utilizar Herramientas de Productividad (Apps, Listas)", "Limpiar la Bandeja de Entrada Regularmente", "Tomar Descansos Cortos y Frecuentes", "Empezar el Día con la Tarea Más Importante (Eat the Frog)", "Aprendizaje Continuo en tu Campo Profesional", "Buscar Feedback Constructivo", "Automatizar Tareas Repetitivas", "Establecer Horarios de Trabajo Definidos", "Desactivar Notificaciones No Esenciales", "Leer Artículos o Blogs de tu Industria", "Hacer Networking Estratégico", "Reflexionar Sobre la Productividad al Final del Día", "Celebrar Hitos y Logros", "Aprender una Nueva Habilidad (Idioma, Programación, etc.)", "Método GTD (Getting Things Done)", "Batching (Agrupar tareas similares)", "Organizar Archivos Digitales", "Limpiar el Escritorio al Final del Día", "Preparar la Ropa/Materiales la Noche Anterior",
            // Relaciones y Social
            "Llamar o Escribir a un Amigo/Familiar Regularmente", "Practicar la Escucha Activa en Conversaciones", "Mostrar Aprecio Genuino a los Demás", "Ofrecer Ayuda Desinteresadamente", "Pasar Tiempo de Calidad con Seres Queridos", "Establecer Límites Claros en Relaciones", "Comunicar Necesidades y Sentimientos Abiertamente", "Resolver Conflictos de Forma Constructiva", "Practicar la Empatía (Ponerse en el lugar del otro)", "Ser Voluntario en la Comunidad", "Unirse a Grupos con Intereses Similares", "Sonreír a Desconocidos", "Recordar Nombres de Personas", "Hacer Preguntas Abiertas para Conocer Mejor a Otros", "Evitar Chismes y Críticas Negativas", "Celebrar los Éxitos de los Demás", "Ofrecer Apoyo en Momentos Difíciles", "Pedir Disculpas Sinceramente", "Expresar Gratitud a las Personas en tu Vida", "Tener Citas Regulares (si aplica)", "Jugar Juegos de Mesa o Actividades en Grupo", "Organizar Reuniones Sociales Pequeñas", "Participar en Eventos Comunitarios", "Ser un Buen Vecino", "Mentoría (Ser mentor o buscar uno)", "Compartir Conocimientos o Habilidades", "Mostrar Interés Genuino en los demás", "Respetar las Diferencias y Opiniones", "Establecer Contacto Visual Durante Conversaciones", "Dar Abrazos (consentidos)",
            // Crecimiento Personal y Finanzas
            "Leer Libros de Desarrollo Personal", "Reflexión Diaria o Semanal (Journaling)", "Identificar Valores Personales Fundamentales", "Vivir de Acuerdo a tus Valores", "Definir tu Propósito o Misión Personal", "Salir de la Zona de Confort Regularmente", "Aceptar Nuevos Desafíos", "Aprender de los Errores y Fracasos", "Practicar la Paciencia", "Cultivar la Curiosidad", "Viajar o Explorar Nuevos Lugares (si es posible)", "Asistir a Talleres o Seminarios", "Establecer un Presupuesto Mensual", "Rastrear Gastos Diarios/Semanales", "Ahorrar un Porcentaje Fijo de los Ingresos", "Establecer Metas Financieras Claras", "Reducir Deudas Innecesarias", "Invertir para el Futuro (educarse primero)", "Comparar Precios Antes de Comprar", "Evitar Compras Impulsivas (Regla de 24h)", "Planificar Comidas para Ahorrar Dinero", "Buscar Formas de Ingresos Adicionales (si es necesario)", "Revisar Estados Financieros Regularmente", "Aprender sobre Finanzas Personales", "Donar a Causas Importantes (si es posible)", "Practicar el Consumo Consciente", "Reparar Cosas en Lugar de Reemplazar", "Buscar Ofertas y Descuentos", "Negociar Salarios o Tarifas", "Tener un Fondo de Emergencia",
            // Entorno y Simplicidad
            "Ordenar y Despejar un Área Pequeña Cada Día (5 min)", "Regla 'Uno Entra, Uno Sale' (Decluttering)", "Digitalizar Documentos Importantes", "Donar o Vender Cosas que No Usas", "Simplificar el Armario", "Crear Zonas Libres de Desorden en Casa", "Limpiar Regularmente el Hogar", "Reducir el Consumo de Plástico de un Solo Uso", "Reciclar Correctamente", "Compostar Residuos Orgánicos", "Ahorrar Agua en Casa", "Ahorrar Energía (apagar luces, desconectar aparatos)", "Usar Transporte Sostenible (caminar, bici, transporte público)", "Comprar Productos Locales y de Temporada", "Llevar Bolsas Reutilizables", "Reducir el Desperdicio de Alimentos", "Crear un Pequeño Jardín o Plantas de Interior", "Pasar Tiempo Consciente en la Naturaleza", "Simplificar Compromisos Sociales", "Reducir Notificaciones del Móvil", "Establecer 'Días sin Compras'", "Practicar el Minimalismo Digital", "Limpiar Archivos del Ordenador/Móvil", "Crear un Entorno de Trabajo Inspirador", "Tener un Lugar para Cada Cosa", "Hacer la Cama Cada Mañana", "Lavar los Platos Después de Comer", "Mantener el Coche Limpio y Ordenado", "Simplificar Rutinas Diarias", "Disfrutar de Placeres Simples",
            // Meta-Hábitos
            "Revisar y Ajustar Hábitos Semanalmente", "Seguimiento de Hábitos (Habit Tracker)", "Establecer Señales Claras para Hábitos", "Diseñar Recompensas Saludables para Hábitos", "Empezar con Hábitos Muy Pequeños (Micro-hábitos)", "Encontrar un Compañero de Hábitos (Accountability Partner)", "Celebrar la Consistencia, No Solo la Perfección", "Ser Flexible y Adaptar Hábitos si es Necesario", "Aprender sobre Ciencia de Hábitos", "Visualizar el Éxito con los Hábitos", "Identificar Obstáculos Potenciales y Planificar Soluciones", "Unir un Hábito Nuevo a Uno Existente (Habit Stacking)", "Preparar el Entorno para Facilitar Hábitos", "Recordar el 'Por Qué' Detrás de Cada Hábito", "Ser Paciente con el Progreso"
            // Lista inicial muy extensa. 'Generar Más' puede añadir variaciones o nichos.
        ];
        const positiveHabitThemes = [
            "salud física", "ejercicio", "nutrición saludable", "sueño reparador", "higiene personal", "bienestar mental", "mindfulness y meditación", "manejo del estrés", "inteligencia emocional", "gratitud", "autocompasión", "productividad", "gestión del tiempo", "establecimiento de metas", "enfoque y concentración", "organización", "aprendizaje continuo", "desarrollo de habilidades", "relaciones sociales", "comunicación efectiva", "empatía", "conexiones significativas", "vida familiar", "crecimiento personal", "lectura", "reflexión y journaling", "valores y propósito", "finanzas personales", "ahorro e inversión", "presupuesto", "minimalismo", "organización del hogar", "sostenibilidad", "ecología", "hábitos matutinos", "rutinas nocturnas", "creatividad", "hobbies", "manejo de la tecnología", "desconexión digital"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un experto en psicología positiva, neurociencia y formación de hábitos. Tu propósito es explicar de forma clara, motivadora y práctica el hábito positivo indicado. Describe: Qué es exactamente el hábito, por qué es beneficioso (respaldo científico o lógico simple), cómo empezar a implementarlo (pasos pequeños y concretos), consejos para mantener la consistencia, posibles obstáculos y cómo superarlos, y cómo este hábito se conecta con un bienestar general. Usa un lenguaje accesible, inspirador y alentador. El objetivo es una guía completa de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente hábito positivo:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúa como un coach de hábitos amigable y motivador. Estás especializado únicamente en el hábito que se está discutiendo actualmente. Responde preguntas de seguimiento sobre cómo empezar, superar dificultades, beneficios específicos o dar ánimo relacionado con ese hábito en particular. Sé conciso, práctico y positivo.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // *** MODIFICADO PARA PEDIR 40 ***
            systemPrompt: "Actúa como un generador de ideas conciso y variado para una guía de bienestar. Genera exactamente 40 hábitos positivos específicos y accionables, cubriendo diversas áreas de la vida (salud, mente, productividad, relaciones, etc.). Devuelve *solo* la lista de hábitos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentado ligeramente por si acaso para 40 items
        };

        // ========== DOM ELEMENTS (Sin cambios estructurales) ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentHabitTitle = null; // Contexto del chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentHabitTitle
                 ? `Actúa como un coach de hábitos amigable y motivador. Estás especializado únicamente en el hábito '${currentHabitTitle}'. Responde preguntas de seguimiento sobre cómo empezar, superar dificultades, beneficios específicos o dar ánimo relacionado con ese hábito en particular. Sé conciso, práctico y positivo.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores están experimentando mucho tráfico en este momento. Por favor, intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o inténtalo más tarde.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(habitTitle) {
            return fetchTextFromApi(habitTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentHabitTitle) throw new Error("Error interno: No se ha establecido el contexto del hábito para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        // *** MODIFICADO PARA 40 TÍTULOS ***
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(positiveHabitThemes) || "bienestar general";
            const specificPrompt = `Genera 40 hábitos positivos específicos y accionables sobre ${randomTheme}`;
            console.log("Generating 40 titles with prompt:", specificPrompt);
            // Usa la función genérica fetchTextFromApi
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n')
                                      .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                      .filter(line => line.length > 5 && line.length < 150);
                     // Ajustar el umbral de error si es necesario
                     if (titles.length < 20) { // Si genera menos de la mitad, considera error
                          throw new Error("La IA no generó suficientes ideas de hábitos esta vez.");
                      }
                     return titles.slice(0, 40); // Asegura que no devuelva más de 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "positive habit concept";
             // Prompt enfocado en lo conceptual/simbólico/positivo
             const enhancedPrompt = `Symbolic and conceptual representation of the positive habit '${safePromptText}'. Focus on feelings of growth, well-being, calm, energy, or accomplishment. Use soft natural colors, abstract elements, light motifs. Avoid literal depictions, text, labels. Uplifting and minimalist aesthetic.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph of person unless specified, cluttered, dark, negative emotions, complex background";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function (sin cambios) ==========
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             // Correcciones básicas (si es necesario, aunque menos probable en este tema)
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             // Párrafos
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h')) return block;
                 let content = block.replace(/\n/g, ' '); // Reemplaza saltos internos con espacio
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
          }

        // ========== MODAL FUNCTIONS (sin cambios estructurales) ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentHabitTitle = null; // Limpia contexto
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS (sin cambios) ==========
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS (sin cambios estructurales) ==========
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentHabitTitle) return; // Verifica contexto
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Coach IA: ${error.message}`); // Mensaje adaptado
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Opcional: Ordenar alfabéticamente o por categoría si se implementa
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">No hay hábitos disponibles en este momento.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => {
                 if (!existingTitles.has(title)) {
                     titleListContainer.appendChild(createTitleItem(title));
                     addedCount++;
                 }
             });
             console.log(`Added ${addedCount} new unique titles.`);
             filterTitles(searchInput.value); // Re-apply filter
         }

        // MODIFIED: handleTitleClick (contexto y listener de imagen sin cambios funcionales)
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentHabitTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Placeholder de imagen
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-lightbulb placeholder-icon"></i> <!-- Icono idea/inspiración -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Creando visualización inspiradora...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Elemento imagen
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image placeholder-icon" style="opacity: 0.5;"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo cargar la imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la información del hábito.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles FOR 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando inspiración...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetching 40 now
                 if (newTitles && newTitles.length > 0) {
                     appendTitles(newTitles);
                     // Optional: Notify user about how many were added
                     // alert(`Se añadieron ${newTitles.length} nuevas ideas de hábitos.`);
                 } else {
                     alert("No pudimos encontrar más ideas de hábitos en este momento. ¡Intenta más tarde!");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar inspiración: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Update button text to reflect 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Inspirarme con Más Hábitos (40)';
             }
         }

         // Search Filter Function (con normalización)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check for essential elements
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential UI elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡Ups! Algo falló al cargar la página. Faltan componentes esenciales.</p>';
                return;
             }
            // Add Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial Display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
             // Update button text initially to reflect 40
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Inspirarme con Más Hábitos (40)';
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>