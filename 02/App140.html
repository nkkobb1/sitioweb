<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conceptos Avanzados de Economía - Enciclopedia Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Profesionales/Académicas -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Merriweather+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Economía Avanzada --- */
        :root {
            --color-primary: #1e40af; /* Azul Oscuro Profesional */
            --color-secondary: #0d9488; /* Teal/Verde Azulado (Énfasis) */
            --color-tertiary: #ca8a04; /* Oro/Mostaza Apagado (Uso Moderado) */
            --color-background: #f8fafc; /* Blanco Hueso / Gris muy claro (Light Mode) */
            --color-text: #1f2937; /* Gris Muy Oscuro (Texto Principal) */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro (Modal) */
            --color-border: #e5e7eb; /* Borde Gris Claro */
            --color-error-bg: #fef2f2; /* Fondo error rojo muy claro */
            --color-error-text: #991b1b; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.2s ease-in-out;
        }

        /* Opcional: Dark Mode Base (descomentar para activar)
        :root {
            --color-primary: #60a5fa; /* Azul Claro */
            --color-secondary: #2dd4bf; /* Teal Claro */
            --color-tertiary: #facc15; /* Amarillo Oro */
            --color-background: #111827; /* Gris Muy Oscuro */
            --color-text: #e5e7eb; /* Gris Muy Claro */
            --color-text-muted: #9ca3af;
            --color-modal-bg: #1f2937; /* Gris Oscuro */
            --color-border: #374151;
            --color-error-bg: #3f1212;
            --color-error-text: #fecaca;
            --color-error-border: #dc2626;
        }
        */

        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather Sans', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alineación izquierda para conceptos largos */ font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: flex-start; min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #eff6ff; /* Azul muy claro hover */ }
        /* Icono opcional en title-item */
        .title-item::before { content: "\f080"; /* Icono de gráfico */ font-family: "Font Awesome 6 Free"; font-weight: 900; margin-right: 0.8rem; color: var(--color-secondary); opacity: 0.6; transition: opacity 0.2s ease; }
        .title-item:hover::before { opacity: 1; }

        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Merriweather Sans', sans-serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1d4ed8; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px; /* Para acomodar chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.5rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-modal-bg); transform: scale(1.1); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-size: 1.05rem; /* Ligeramente más grande para lectura */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather Sans', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        #modal-content .formula { background-color: #f3f4f6; border: 1px solid var(--color-border); padding: 1em; border-radius: var(--border-radius); margin: 1.5em 0; font-family: monospace; overflow-x: auto; }

        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; background-color: #f9fafb; } /* Fondo claro por si la imagen es transparente */
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; } /* Icono: fa-chart-line, fa-brain, fa-balance-scale */

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; /* Fondo ligeramente distinto */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem;}
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; } /* Alineación izq. aunque sea user */
        .ai-message { background-color: #e5e7eb; color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.3rem;}
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(30, 64, 175, 0.15); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-secondary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #0f766e; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #e5e7eb; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.2rem; font-family: 'Merriweather Sans'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.95); /* Fondo oscuro para overlay */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); box-shadow: var(--shadow-lg); background-color: white; /* Asegura fondo blanco para la imagen */}
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: #dc2626; color: white; } /* Rojo para cerrar */
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-chart-pie mr-3 text-blue-600"></i> <!-- Icono gráfico circular -->
                     Economía Avanzada
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">» Enciclopedia Interactiva «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Explorando Conceptos Económicos</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Navega por modelos, teorías y herramientas del análisis económico avanzado. Selecciona un concepto o utiliza el buscador.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar concepto económico...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-600 mr-2"></i> <!-- Icono libro abierto -->
                 Índice de Conceptos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando índice de conceptos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron conceptos para los términos de búsqueda. «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Sugerir Más Conceptos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Cargando explicación...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <h4 class="text-sm font-semibold text-gray-600 mb-2 text-center border-b pb-1">Consulta al Asistente sobre este Concepto</h4>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Pensando...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Escribe tu pregunta aquí...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Conceptual Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA con fines educativos y de referencia sobre conceptos económicos.</p>
              <p class="mt-1">Verifica siempre la información con fuentes académicas especializadas.</p>
              <p class="mt-2">© 2025 Enciclopedia Económica Interactiva</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Microeconomía Avanzada
            "Teoría de la Utilidad Esperada (von Neumann-Morgenstern)", "Aversión al Riesgo: Medidas (Arrow-Pratt)", "Equivalente Cierto y Prima de Riesgo", "Selección Adversa (Modelo de Akerlof - Limones)", "Riesgo Moral (Moral Hazard)", "Señalización (Signaling - Modelo de Spence)", "Screening en Mercados con Información Asimétrica", "Teoremas Fundamentales de la Economía del Bienestar", "Función de Bienestar Social (Bergson-Samuelson)", "Teorema de Imposibilidad de Arrow", "Teorema de Gibbard-Satterthwaite", "Externalidades: Teorema de Coase", "Impuestos Pigouvianos", "Mercados de Permisos de Emisión", "Bienes Públicos: Condición de Samuelson", "Mecanismo de Clarke-Groves (Revelación de Preferencias)", "Tragedia de los Comunes", "Teoría de Juegos: Equilibrio de Nash", "Equilibrio Perfecto en Subjuegos (SPE)", "Equilibrio Bayesiano Perfecto (PBE)", "Juegos Repetidos: Teorema Folk", "Juegos de Señalización (Aplicaciones)", "Subastas: Teorema de Equivalencia de Ingresos", "Subasta de Segundo Precio (Vickrey)", "Subasta Inglesa y Holandesa", "Maldición del Ganador (Winner's Curse)", "Diseño de Mecanismos (Mechanism Design)", "Teoría del Contrato: Contratos Completos e Incompletos", "Riesgo Moral en Relaciones Principal-Agente", "Selección Adversa en Mercados de Seguros", "Teoría de la Agencia", "Economía del Comportamiento: Prospect Theory (Kahneman-Tversky)", "Anclaje y Ajuste (Anchoring)", "Sesgo de Disponibilidad (Availability Bias)", "Sesgo de Confirmación", "Aversión a la Pérdida", "Descuento Hiperbólico", "Economía Experimental: Métodos y Hallazgos", "Neuroeconomía: Bases Neurales de la Decisión", "Preferencias Sociales: Altruismo, Reciprocidad, Equidad", "Modelos de Aprendizaje en Juegos", "Equilibrio General Computable (CGE)", "Modelo de Equilibrio General Arrow-Debreu", "Existencia y Unicidad del Equilibrio General", "Estabilidad del Equilibrio General (Proceso Tâtonnement)", "Ley de Walras", "Economía de Redes (Network Economics)",

            // Macroeconomía Avanzada
            "Modelo IS-LM-BP (Mundell-Fleming)", "Modelo de Ciclos Económicos Reales (RBC - Real Business Cycle)", "Crítica de Lucas", "Nuevos Modelos Keynesianos (New Keynesian Models)", "Rigideces Nominales y Reales", "Curva de Phillips Novo-Keynesiana (NKPC)", "Modelos DSGE (Dynamic Stochastic General Equilibrium)", "Métodos de Calibración y Estimación de DSGE", "Modelo de Generaciones Traslapadas (OLG - Overlapping Generations)", "Equivalencia Ricardiana", "Sostenibilidad de la Deuda Pública", "Modelo de Crecimiento de Solow (con progreso técnico)", "Modelo de Crecimiento Endógeno (AK, Romer, Aghion-Howitt)", "Convergencia Económica (Beta y Sigma)", "Teoría del Capital Humano y Crecimiento", "Regla de Taylor (Política Monetaria)", "Credibilidad y Problema de Inconsistencia Temporal (Kydland-Prescott)", "Inflación Óptima", "Flexibilización Cuantitativa (Quantitative Easing - QE)", "Forward Guidance", "Zero Lower Bound (ZLB) en Política Monetaria", "Unión Monetaria Óptima", "Crisis Cambiarias (Modelos de 1ª, 2ª y 3ª Generación)", "Sudden Stops (Paradas Súbitas de Flujos de Capital)", "Pecado Original (Original Sin) en Finanzas Internacionales", "Paradoja de Feldstein-Horioka", "Modelo de Obstfeld-Rogoff (New Open Economy Macroeconomics)", "Determinación del Tipo de Cambio (Enfoques Monetario, Portfolio Balance)", "Teoría de la Paridad del Poder Adquisitivo (PPP) - Versiones Avanzadas", "Efecto Balassa-Samuelson", "Modelos de Búsqueda y Emparejamiento (Search and Matching - Mercado Laboral)", "Curva de Beveridge", "Histéresis en el Desempleo",

            // Econometría Avanzada
            "Método Generalizado de los Momentos (GMM)", "Estimador de Máxima Verosimilitud (MLE)", "Variables Instrumentales (IV): Identificación y Estimación (2SLS)", "Instrumentos Débiles", "Prueba de Hausman", "Modelos de Datos de Panel: Efectos Fijos y Aleatorios", "Estimador 'First Differences' (FD)", "Modelos Dinámicos de Datos de Panel", "Modelos Logit y Probit", "Modelo Tobit (Variables Censuradas)", "Modelos de Selección Muestral (Heckman)", "Análisis de Duración (Survival Analysis)", "Regresión Discontinua (Regression Discontinuity Design - RDD)", "Diferencias en Diferencias (Difference-in-Differences - DiD)", "Control Sintético (Synthetic Control Method)", "Propensity Score Matching (PSM)", "Series de Tiempo: Procesos Estacionarios y No Estacionarios", "Raíces Unitarias (Pruebas Dickey-Fuller, Phillips-Perron)", "Cointegración (Test de Engle-Granger, Johansen)", "Modelos Autorregresivos (AR, MA, ARMA, ARIMA)", "Modelos de Vectores Autorregresivos (VAR)", "Funciones Impulso-Respuesta (IRF)", "Descomposición de Varianza (FEVD)", "Modelos de Corrección de Errores Vectorial (VECM)", "Modelos ARCH y GARCH (Volatilidad Condicional)", "Econometría Bayesiana: Teorema de Bayes, MCMC", "Bootstrap (Métodos de Remuestreo)", "Machine Learning en Econometría (Lasso, Ridge, Random Forest)", "Análisis Causal con Machine Learning",

            // Finanzas Avanzadas
            "Modelo de Valoración de Activos de Capital (CAPM) - Supuestos y Limitaciones", "Teoría de Valoración por Arbitraje (APT)", "Modelo de Tres Factores de Fama-French", "Modelo de Cinco Factores de Fama-French", "Consumption CAPM (CCAPM)", "Beta Condicional y Riesgo Sistemático Variable", "Modelo de Black-Scholes-Merton (Valoración de Opciones)", "Griegas (Delta, Gamma, Vega, Theta, Rho)", "Valoración de Opciones Exóticas (Barrera, Asiáticas, Lookback)", "Modelos Binomiales de Valoración de Opciones", "Estructura Temporal de Tipos de Interés (Modelos Vasicek, CIR, HJM)", "Valor en Riesgo (VaR) y Conditional VaR (CVaR)", "Modelos de Default de Crédito (Merton, KMV)", "Teoremas de Modigliani-Miller (Estructura de Capital, Dividendos)", "Teoría de la Agencia en Finanzas Corporativas", "Gobierno Corporativo", "Fusiones y Adquisiciones (M&A): Valoración y Estrategia", "Behavioral Finance: Exceso de Confianza, Comportamiento Gregario", "Anomalías del Mercado (Momentum, Value Premium)", "Límites del Arbitraje", "Microestructura de Mercado: Spread Bid-Ask, Impacto de Precio", "Trading de Alta Frecuencia (HFT)", "Finanzas Internacionales: Paridad Cubierta y Descubierta de Tipos de Interés",

            // Comercio Internacional Avanzado
            "Modelo Heckscher-Ohlin-Samuelson (HOS)", "Teorema de Stolper-Samuelson", "Teorema de Rybczynski", "Paradoja de Leontief", "Modelo Ricardiano con Múltiples Bienes (Dornbusch-Fischer-Samuelson)", "Nueva Teoría del Comercio (Krugman - Competencia Monopolística)", "Efecto 'Home Market'", "Modelo de Melitz (Heterogeneidad Empresarial)", "Modelo Gravitatorio del Comercio", "Fragmentación Internacional de la Producción (Offshoring)", "Cadenas Globales de Valor", "Efectos de la Integración Económica (Unión Aduanera, Mercado Común)", "Análisis de Política Comercial (Aranceles, Cuotas, Subsidios) - Bienestar", "Argumento de la Industria Naciente", "Dumping y Medidas Antidumping",

            // Economía Pública Avanzada
            "Teoría de la Imposición Óptima (Optimal Taxation)", "Regla de Ramsey", "Impuesto Óptimo sobre la Renta (Mirrlees)", "Incidencia Impositiva en Equilibrio General", "Distorsión Fiscal y Exceso de Gravamen (Deadweight Loss)", "Teoría de la Elección Pública (Public Choice)", "Teorema del Votante Mediano", "Búsqueda de Rentas (Rent-Seeking)", "Ciclo Político-Económico (Political Business Cycle)", "Modelos de Leviatán (Brennan-Buchanan)", "Federalismo Fiscal", "Teorema de la Descentralización de Oates", "Competencia Fiscal entre Jurisdicciones", "Provisión Óptima de Bienes Públicos Locales (Modelo de Tiebout)",

            // Otros Campos Avanzados
            "Economía Laboral: Modelos de Búsqueda y Salarios de Eficiencia", "Teoría del Capital Humano (Becker, Mincer)", "Discriminación en el Mercado Laboral (Modelos de Becker, Arrow)", "Organización Industrial: Modelo de Cournot y Bertrand (Extensiones)", "Colusión Tácita y Explícita", "Diferenciación de Producto (Hotelling, Salop)", "Barreras de Entrada", "Regulación de Monopolios Naturales", "Economía del Desarrollo: Trampas de Pobreza", "El Rol de las Instituciones en el Desarrollo (Acemoglu-Robinson)", "Evaluación de Impacto: Ensayos Controlados Aleatorios (RCTs)", "Microfinanzas: Impacto y Sostenibilidad", "Economía de la Salud: Selección Adversa y Riesgo Moral en Seguros", "Demanda Derivada de Servicios Médicos", "Evaluación Económica de Tecnologías Sanitarias", "Economía Ambiental: Valoración de Bienes Ambientales (Métodos)", "Desarrollo Sostenible", "Economía de los Recursos Naturales (Regla de Hotelling)", "Economía Urbana: Modelos de Localización (Alonso-Muth-Mills)", "Aglomeración Económica", "Economía de la Educación: Rendimientos de la Educación", "Señalización vs Capital Humano", "Economía Política: Modelos de Conflicto", "Corrupción y Crecimiento Económico", "Historia del Pensamiento Económico: Escuelas (Austriaca, Institucionalista)", "Contribuciones Clave de Economistas (Keynes, Friedman, Hayek, etc.)", "Economía de la Complejidad", "Modelos Basados en Agentes (ABM)"
        ];
        const advancedEconThemes = [ // Para generar más títulos
            "teoría microeconómica avanzada", "modelos macroeconómicos dinámicos", "econometría de series de tiempo", "econometría de datos de panel", "inferencia causal", "finanzas corporativas avanzadas", "valoración de activos", "derivados financieros", "economía internacional", "teoría del comercio", "finanzas internacionales", "economía pública", "imposición óptima", "elección pública", "economía del comportamiento", "teoría de juegos aplicada", "diseño de mecanismos", "economía laboral avanzada", "organización industrial", "regulación económica", "economía del desarrollo", "instituciones económicas", "economía ambiental", "economía de la salud", "economía urbana", "historia del pensamiento económico"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un profesor universitario experto en teoría económica avanzada. Explica el siguiente concepto económico de forma rigurosa, clara y detallada. Incluye: 1) Definición precisa. 2) Supuestos clave del modelo/teoría. 3) Descripción conceptual del mecanismo o modelo principal (simplificando matemáticas si es necesario, pero mencionando los elementos centrales). 4) Implicaciones y predicciones principales. 5) Relevancia empírica (breve mención de evidencia o aplicaciones). 6) Críticas, limitaciones o extensiones comunes. 7) Conexiones con otros campos de la economía. Utiliza un lenguaje académico y objetivo. El objetivo es una explicación completa de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúa como un Asistente de Cátedra (TA) de Economía, especializado únicamente en el concepto económico que se está mostrando actualmente. Responde preguntas específicas sobre detalles, supuestos, implicaciones, o aspectos relacionados mencionados en la explicación principal de este concepto. Sé conciso, preciso y mantente estrictamente enfocado en el concepto actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un glosario de economía avanzada. Genera exactamente 15 nombres de conceptos, modelos, teoremas o herramientas analíticas específicas de la economía avanzada. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Scrollable area
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Text div
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentConceptTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentConceptTitle
                 ? `Actúa como un Asistente de Cátedra (TA) de Economía, especializado únicamente en el concepto económico llamado '${currentConceptTitle}'. Responde preguntas específicas sobre detalles, supuestos, implicaciones, o aspectos relacionados mencionados en la explicación principal de este concepto. Sé conciso, preciso y mantente estrictamente enfocado en el concepto actual.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     // ** MENSAJE AMIGABLE **
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, por favor intente en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o inténtalo más tarde.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     // ** MENSAJE AMIGABLE **
                     throw new Error(`La solicitud tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar los servidores de IA.");
             }
         }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentConceptTitle) throw new Error("Error interno: No se ha establecido el contexto económico para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(advancedEconThemes) || "teoría económica avanzada";
             const specificPrompt = `Genera 15 conceptos específicos sobre ${randomTheme}`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("No se pudieron generar suficientes conceptos nuevos.");
                     return titles.slice(0, 15);
                 });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 700, height: 500, nologo: true }; // Ajustar tamaño si es necesario
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "abstract economic concept";
             // ** PROMPT AJUSTADO PARA ECONOMÍA ABSTRACTA **
             const enhancedPrompt = `Abstract conceptual visualization representing the economic concept '${safePromptText}'. Use motifs like stylized graphs, network diagrams, balancing scales, flow charts, interconnected nodes, or abstract data patterns. Color palette: professional deep blues, greys, with teal or muted gold accents. Avoid literal text, numbers, currency symbols, realistic people, simplistic bar charts. Clean, sophisticated, academic aesthetic.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, numbers, formula, equation, writing, labels, caption, realistic person, photograph, simple chart, currency symbol, dollar sign, euro sign, money pile, comic style, watermark, signature";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (Igual que antes)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−])\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); // Usa la clase formula
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Igual que antes)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentConceptTitle = null; // Limpia contexto
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Igual que antes)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (Igual que antes)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`); // Muestra error amigable
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ========== (Igual que antes, adaptando textos)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar alfabéticamente para conceptos
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay conceptos disponibles.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             const uniqueNewTitles = [];
             newTitles.forEach(title => { if (!existingTitles.has(title)) { uniqueNewTitles.push(title); titleListContainer.appendChild(createTitleItem(title)); } });
             // Re-aplicar filtro si hay nuevos títulos y existe un término de búsqueda
             if (uniqueNewTitles.length > 0 && searchInput.value.trim()) {
                 filterTitles(searchInput.value);
             }
         }
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentConceptTitle = title; // Establece contexto para chat
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';
            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0; // Reset scroll
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-chart-line placeholder-icon"></i> <!-- Icono placeholder temático -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { console.error("Could not create image URL for:", title); placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message; // Muestra error amigable
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden'); // Oculta chat si falla carga principal
            }
        }
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando sugerencias...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más conceptos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar conceptos: ${error.message}`); // Muestra error amigable
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Sugerir Más Conceptos';
             }
         }
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (Igual que antes)
        function initApp() {
            const essentialElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, modalTextArea];
            if (essentialElements.some(el => !el)) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Fallo al cargar componentes de la interfaz.</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>