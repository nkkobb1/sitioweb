<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gran Enciclopedia Pirata - One Piece</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes temáticas (Ejemplo: Luckiest Guy para títulos, Lato para cuerpo) -->
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para One Piece --- */
        :root {
            --color-primary: #0077cc; /* Azul Marino Intenso */
            --color-secondary: #ffc107; /* Dorado Tesoro */
            --color-background: #e0f7fa; /* Azul Cielo Muy Claro / Espuma de Mar */
            --color-text: #263238; /* Gris Oscuro/Negro Suave */
            --color-text-muted: #546e7a; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco para Modal */
            --color-border: #b0bec5; /* Borde Gris Claro */
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.15), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.6; }
        /* Usar fuente temática para el logo/título principal */
        h1.logo, h1.page-title { font-family: 'Luckiest Guy', cursive; font-weight: normal; color: var(--color-primary); letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        h2.section-title { font-family: 'Lato', sans-serif; font-weight: 700; font-size: 1.8rem; } /* Lato Bold para subtítulos */
        #modal-title { font-family: 'Lato', sans-serif; font-weight: 700; color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-secondary); padding-bottom: 0.6rem; display: inline-block; }
        .navbar { background-color: rgba(255, 255, 255, 0.85); backdrop-filter: blur(6px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-primary); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Lato', sans-serif; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: #ffffff; background-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-secondary); color: #333; /* Texto oscuro sobre dorado */ padding: 0.8rem 1.6rem; border: none; border-radius: 30px; /* Botón más redondeado */ font-family: 'Lato', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { background-color: #ffb300; box-shadow: var(--shadow-md); transform: scale(1.03); }
        #generate-more-btn:disabled { background-color: #bdbdbd; color: var(--color-text-muted); cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: #333; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 50, 100, 0.85); /* Overlay azul oscuro semi-transparente */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 2rem 2.5rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 350px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: #e0e0e0; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; line-height: 1; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(180deg); }
        #modal-title { font-size: 2.1rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }
        #modal-content {
            line-height: 1.7;
            color: var(--color-text);
            white-space: normal;
            overflow-y: auto;
            padding: 0 10px 1.5rem 10px;
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) #eeeeee;
        }
        #modal-content::-webkit-scrollbar { width: 10px; }
        #modal-content::-webkit-scrollbar-track { background: #eeeeee; border-radius: var(--border-radius); }
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid #eeeeee; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: #00558b; font-style: italic; font-weight: bold; } /* Énfasis azul oscuro */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Lato', sans-serif; font-weight: 700; margin-top: 2.0em; margin-bottom: 1.0em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; color: #00558b; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-text); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 119, 204, 0.2); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.7rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3.5rem; color: var(--color-border); }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 70px; height: 70px; border: 7px solid #b3e5fc; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-primary); font-size: 1.4rem; font-family: 'Lato'; text-shadow: 1px 1px 1px rgba(255,255,255,0.5); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #ffcdd2; color: #c62828; padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #ef9a9a; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex justify-center items-center">
             <div class="flex items-center text-center">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-skull-crossbones mr-3 text-gray-700"></i> <!-- Jolly Roger -->
                     Gran Enciclopedia Pirata
                     <i class="fas fa-anchor ml-3 text-gray-700"></i> <!-- Ancla -->
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">¡El Gran Tesoro del Conocimiento!</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto">Navega por las historias, habilidades y secretos de los personajes más legendarios de One Piece. ¡Elige un nombre para empezar la aventura!</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-600 mr-2"></i> <!-- Libro abierto -->
                 Personajes y Leyendas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Consultando los Poneglyphs...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Desplegar Más Recompensas
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Analizando personaje...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - La imagen se añadirá aquí al final -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Analysis text (HTML) goes here -->
                     <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-600 py-6 mt-12 border-t border-gray-300">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Análisis generados por IA basados en el vasto mundo de One Piece creado por Eiichiro Oda. ¡Para fans, por fans!</p>
              <p class="mt-1">Este sitio no es oficial y tiene fines puramente informativos y de entretenimiento.</p>
              <p class="mt-2">© 2025 Gran Enciclopedia Pirata</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Tripulación del Sombrero de Paja (Mugiwaras)
            "Monkey D. Luffy", "Roronoa Zoro", "Nami", "Usopp", "Vinsmoke Sanji", "Tony Tony Chopper", "Nico Robin", "Franky (Cutty Flam)", "Brook", "Jinbei", "Going Merry (Barco)", "Thousand Sunny (Barco)",

            // Yonko (Emperadores del Mar) - Actuales y Anteriores
            "Shanks", "Marshall D. Teach (Barbanegra)", "Buggy el Payaso (Nuevo Yonko)", "Monkey D. Luffy (Nuevo Yonko)", "Kaido (Antiguo Yonko)", "Charlotte Linlin (Big Mom) (Antigua Yonko)", "Edward Newgate (Barbablanca) (Antiguo Yonko)", "Gol D. Roger (Rey de los Piratas)",

            // Tripulación de Roger
            "Silvers Rayleigh", "Scopper Gaban", "Crocus", "Shanks (como aprendiz)", "Buggy (como aprendiz)", "Douglas Bullet (Película Stampede)",

            // Tripulación de Barbablanca
            "Marco 'el Fénix'", "Portgas D. Ace", "Jozu 'Diamante'", "Thatch", "Vista 'Espada Florida'", "Izou", "Namur", "Rakuyo", "Fossa", "Haruta", "Blenheim", "Curiel", "Kingdew", "Atmos", "Speed Jiru", "Whitey Bay", "Little Oars Jr.",

            // Tripulación de Shanks (Pelirrojos)
            "Benn Beckman", "Lucky Roux", "Yasopp", "Limejuice", "Bonk Punch", "Monster", "Building Snake", "Hongo", "Howling Gab", "Rockstar",

            // Tripulación de Barbanegra
            "Shiryu de la Lluvia", "Jesus Burgess", "Van Augur", "Lafitte", "Doc Q", "Stronger (Caballo)", "Avalo Pizarro 'el Rey Corrupto'", "Catarina Devon 'la Cazadora de la Luna Creciente'", "Sanjuan Wolf 'el Acorazado Colosal'", "Vasco Shot 'el Gran Bebedor'", "Kuzan (Aokiji) (Aliado?)",

            // Tripulación de Kaido (Piratas Bestia)
            "King 'la Conflagración'", "Queen 'la Plaga'", "Jack 'la Sequía'", // Calamidades
            "Who's-Who", "Sasaki", "Black Maria", "Ulti", "Page One", "X Drake (SWORD infiltrado)", // Tobiroppo
            "Basil Hawkins (Aliado forzado)", "Scratchmen Apoo (Aliado)", "Sheepshead", "Ginrummy", "Holdem", "Speed", "Dobon", "Bao Huang", "Numbers (Inbi, Fuga, Zanki, Jaki, Goki, Rokki, Nangi, Hatcha, Juki)",

            // Tripulación de Big Mom
            "Charlotte Katakuri", "Charlotte Smoothie", "Charlotte Cracker", // Comandantes Dulces
            "Charlotte Perospero", "Charlotte Compote", "Charlotte Daifuku", "Charlotte Oven", "Charlotte Amande", "Charlotte Opera", "Charlotte Mont-d'Or", "Charlotte Galette", "Charlotte Brûlée", "Charlotte Pudding", "Charlotte Flampe", "Pekoms", "Baron Tamago", "Bobbin 'el Arreglador'", "Streusen (Cocinero)", "Zeus (Nube)", "Prometheus (Sol)", "Napoleon (Sombrero/Espada)",

            // La Peor Generación (Supernovas)
            "Eustass 'Captain' Kid", "Trafalgar D. Water Law", "Basil Hawkins", "Scratchmen Apoo", "X Drake", "Killer 'el Soldado Masacre'", "Jewelry Bonney", "Capone 'Gang' Bege", "Urouge 'el Monje Loco'",

            // Shichibukai (Señores de la Guerra del Mar) - Actuales/Anteriores/Nuevos conceptos
            "Dracule Mihawk", "Donquixote Doflamingo", "Boa Hancock", "Bartholomew Kuma", "Gecko Moria", "Sir Crocodile", "Jinbei (anterior)", "Marshall D. Teach (anterior)", "Trafalgar D. Water Law (anterior)", "Buggy (anterior)", "Edward Weevil", "Cross Guild (Organización)",

            // Marina (Marines)
            // Alto Mando
            "Sakazuki (Akainu) (Almirante de Flota)", "Kuzan (Aokiji) (Ex-Almirante)", "Borsalino (Kizaru) (Almirante)", "Issho (Fujitora) (Almirante)", "Aramaki (Ryokugyu) (Almirante)", "Sengoku (Ex-Almirante de Flota)", "Monkey D. Garp (Vicealmirante, Héroe)", "Tsuru (Vicealmirante, 'Gran Estratega')",
            // Vicealmirantes Notables
            "Smoker", "Momonga", "Onigumo", "Doberman", "Strawberry", "Yamakaji", "John Giant", "Lacroix", "Ronse", "Bastille", "Maynard", "Vergo (Infiltrado)", "Stainless", "Mozambia", "Cancer", "Comil", "Doll",
            // Otros Marines Relevantes
            "Coby", "Helmeppo", "Tashigi", "Hina 'la Jaula Negra'", "Sentomaru", "Fullbody", "Jango", "Nezumi", "Pudding Pudding", "Brandnew", "Momousagi (Gion)", "Chaton (Tokikake)", "Kong (Comandante en Jefe del Gobierno Mundial)",
            // SWORD (Unidad secreta)
            "X Drake (Capitán)", "Coby (Miembro)", "Helmeppo (Miembro)", "Prince Grus", "Kujaku", "Hibari",

            // Gobierno Mundial y Cipher Pol
            "Los Cinco Ancianos (Gorosei)", "Imu", // Figuras Supremas
            "Rob Lucci", "Kaku", "Stussy", "Jabra (Ex-CP9)", "Blueno (Ex-CP9)", "Kalifa (Ex-CP9)", "Fukurou (Ex-CP9)", "Kumadori (Ex-CP9)", "Spandam (Ex-Director CP9)", "Spandine (Padre de Spandam, Ex-CP5)", "Guernica (CP0)", "Maha (CP0)", "Joseph (CP0)", "Gismonda (CP0)", "Otros Agentes CP0 sin nombre",
            // Nobles Mundiales (Tenryuubito / Dragones Celestiales)
            "Saint Charlos", "Saint Rosward", "Saint Shalria", "Saint Mjosgard (Exiliado/Aliado)", "Saint Donquixote Homing (Padre Doflamingo, Ex)", "Saint Figarland Garling",

            // Ejército Revolucionario
            "Monkey D. Dragon", "Sabo", "Emporio Ivankov", "Bartholomew Kuma (Ex-miembro/Esclavo)", "Koala", "Hack", "Morley", "Belo Betty", "Lindbergh", "Karasu", "Inazuma",

            // Reino de Arabasta
            "Nefertari Vivi", "Karoo (Pato)", "Nefertari Cobra (Rey)", "Igaram", "Pell 'el Halcón'", "Chaka 'el Chacal'", "Kohza", "Toto",

            // Skypiea
            "Gan Fall", "Pierre (Ave)", "Conis", "Pagaya", "Wiper 'el Berserker'", "Kamakiri", "Braham", "Genbo", "Raki", "Aisa", "Enel (Dios auto-proclamado)", "Gedatsu", "Shura", "Satori", "Ohm", "Yama", "Nola (Serpiente Gigante)", "Mont Blanc Noland (Explorador)", "Calgara (Guerrero Shandia)",

            // Water 7 y Enies Lobby
            "Iceburg", "Paulie", "Lulu", "Tilestone", "Peepley Lulu", "Kokoro", "Chimney", "Gonbe (Conejo)", "Yokozuna (Rana Sumo)", "Franky Family (Zambai, Mozu, Kiwi, Sodom, Gomorrah)", "Tom (Carpintero)", "Cutty Flam (Joven Franky)",

            // Thriller Bark
            "Gecko Moria", "Dr. Hogback", "Absalom", "Perona", "Ryuma (Zombie Samurái)", "Oars (Zombie Gigante)", "Lola (Capitana Pirata)", "Hildon (Zombie)", "Victoria Cindry (Zombie)",

            // Archipiélago Sabaody
            "Silvers Rayleigh", "Shakuyaku (Shakky)", "Duval (Handsome)", "Motobaro (Bisonte)", "Hatchan (Hachi)", "Camie (Sirena)", "Pappag (Estrella de Mar)", "Disco", "Peterman",

            // Impel Down
            "Magellan (Alcaide)", "Hannyabal (Vicealcaide)", "Domino (Subalcaide)", "Sadi-chan (Guardia Jefe)", "Saldeath (Comandante Blue Gorillas)", "Minotaurus", "Minorhinoceros", "Minokoala", "Minozebra", // Guardias Bestia
            "Bentham (Bon Clay / Mr. 2)", "Galdino (Mr. 3)", "Daz Bonez (Mr. 1)",

            // Marineford
            "Personajes clave ya listados (Barbablanca, Ace, Akainu, Aokiji, Kizaru, Sengoku, Garp, Marco, Jozu, Crocodile, Buggy, Jinbei, Ivankov, etc.)",

            // Isla Gyojin (Fishman Island)
            "Shirahoshi (Princesa Sirena / Poseidon)", "Rey Neptune", "Reina Otohime", "Fukaboshi", "Ryuboshi", "Manboshi", "Ministro de la Derecha", "Ministro de la Izquierda", "Madam Shyarly", "Hody Jones", "Vander Decken IX", "Dosun", "Zeo", "Daruma", "Ikaros Much", "Fisher Tiger", "Arlong (en contexto de Isla Gyojin)", "Jinbei (en contexto de Isla Gyojin)",

            // Punk Hazard
            "Caesar Clown", "Monet", "Vergo", "Trafalgar Law (en Punk Hazard)", "Smoker (en Punk Hazard)", "Tashigi (en Punk Hazard)", "Kin'emon", "Momonosuke", "Brownbeard", "Mocha", "Sind", "Los Niños Gigantes", "Dragón Artificial de Vegapunk",

            // Dressrosa
            "Rebecca", "Kyros", "Viola (Violet)", "Rey Riku Doldo III", "Tank Lepanto", "Elizabello II", "Dagama", "Donquixote Doflamingo", // Familia Donquixote
            "Trebol", "Diamante", "Pica", "Sugar", "Gladius", "Lao G", "Senor Pink", "Machvise", "Dellinger", "Baby 5", "Buffalo", "Jora", "Monet (en Dressrosa)", "Vergo (en Dressrosa)",
            "Leo (Tontatta)", "Mansherry (Princesa Tontatta)", "Wicca", "Kabu", "Bian", "Gambia", "Bartolomeo", "Cavendish", "Hakuba", "Sai", "Boo", "Don Chinjao", "Ideo", "Blue Gilly", "Abdullah", "Jeet", "Hajrudin", "Orlumbus", "Suleiman",

            // Zou
            "Inuarashi", "Nekomamushi", "Wanda", "Carrot", "Pedro", "Shishilian", "Bariete", "Yomo", "Zunesha (Elefante)", "Jack (en Zou)",

            // Whole Cake Island
            "Charlotte Pudding", "Vinsmoke Judge", "Vinsmoke Reiju", "Vinsmoke Ichiji", "Vinsmoke Niji", "Vinsmoke Yonji", "Capone Bege", "Chiffon", "Pez", "Vito", "Gotti", "Jinbei (en WCI)", "Pedro (en WCI)", "Carrot (en WCI)", "Zeus (en WCI)",

            // Wano Kuni / País de Wano
            "Kozuki Oden", "Kozuki Momonosuke", "Kozuki Hiyori (Komurasaki)", "Kozuki Toki", "Kozuki Sukiyaki", "Kin'emon", "Kanjuro Kurozumi", "Raizo de la Niebla", "Kikunojo (O-Kiku)", "Ashura Doji (Shutenmaru)", "Denjiro (Kyoshiro)", "Kawamatsu el Kappa", "Inuarashi (Sulong)", "Nekomamushi (Sulong)", "Izo (Wano)", // Nueve Vainas Rojas
            "Yamato", "Shinobu", "Tama", "Tenguyama Hitetsu", "Hyogoro de la Flor", "O-Tsuru", "Shimotsuki Yasuie (Tonoyasu)", "Kurozumi Orochi", "Kurozumi Higurashi", "Fukurokuju", "Onimaru (Gyukimaru)", "Uzuki Tempura", "Shimotsuki Ushimaru", "Shimotsuki Kozaburo", "Ryuma (Samurái Legendario)",

            // Egghead
            "Dr. Vegapunk (Stella y Satélites: Shaka, Lilith, Edison, Pythagoras, Atlas, York)", "Sentomaru (Egghead)", "Jewelry Bonney (Egghead)", "Rob Lucci (CP0 en Egghead)", "Kaku (CP0 en Egghead)", "Stussy (CP0/Clon en Egghead)", "Kizaru (Egghead)", "Saint Jaygarcia Saturn (Gorosei en Egghead)",

            // Personajes de Arcos Anteriores / Menores Relevantes
            "Zeff", "Patty", "Carne", "Nojiko", "Genzo", "Bellemere", "Kaya", "Merry (Mayordomo)", "Kuina", "Koshiro", "Johnny", "Yosaku", "Gaimon", "Laboon", "Dr. Kureha", "Dalton", "Wapol", "Chess", "Marimo", "Kuromarimo", "Robson (Hipopótamo)", "Foxy 'el Zorro Plateado'", "Porche", "Hamburg", "Itomimizu", "Chuchun", "Mont Blanc Cricket", "Masira", "Shoujou", "Bellamy 'la Hiena'", "Sarquiss", "Tonjit", "Shelly (Caballo)",

            // Conceptos Clave Relacionados a Personajes/Habilidades
            "Haki del Rey (Haoshoku Haki)", "Haki de Armadura (Busoshoku Haki)", "Haki de Observación (Kenbunshoku Haki)", "Despertar de las Frutas del Diablo (Awakening)", "Frutas Zoan Mitológicas", "Frutas Zoan Ancestrales", "Frutas Logia", "Frutas Paramecia", "Smile (Frutas Artificiales)", "Rokushiki (Seis Poderes)", "Fishman Karate", "Mink Electr", "Forma Sulong (Minks)", "Voz de Todas las Cosas", "Will of D. (Voluntad de D.)", "Road Poneglyphs", "Armas Ancestrales (Pluton, Poseidon, Uranus)", "Nika (Dios del Sol)", "Lunarian Race", "Seraphim (Pacifistas Nuevos)", "Tecnología de Vegapunk", "Germa 66 (Tecnología Vinsmoke)"
        ];
        const onePieceThemes = [ // Para botón "Generar Más"
            "miembros de la Peor Generación", "comandantes de Yonko", "usuarios de Haki del Rey",
            "Marines de alto rango", "personajes de Wano Kuni", "usuarios de Frutas Logia",
            "miembros de la tripulación de Roger", "Shichibukai", "miembros del Ejército Revolucionario",
            "personajes de arcos anteriores (East Blue, Arabasta)", "villanos principales de sagas",
            "aliados clave de los Mugiwaras", "usuarios de Frutas Zoan Mitológicas", "miembros de CP9/CP0",
            "personajes de Skypiea", "personajes de la Isla Gyojin", "la Familia Vinsmoke", "los Nueve Vainas Rojas",
            "leyendas del pasado (Oden, Roger, Rocks)", "gigantes de Elbaf", "habitantes de Zou (Minks)"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un experto enciclopédico y fanático acérrimo de One Piece. Tu tarea es analizar en profundidad a un personaje específico (o concepto relevante) del universo One Piece. Describe su historia, personalidad, habilidades (Fruta del Diablo, Haki, estilo de lucha), relaciones clave, objetivos, momentos más impactantes y su rol general en la trama. Sé detallado, apasionado y preciso, como si escribieras para la mayor base de datos de One Piece. Cubre la mayor parte de su historia conocida hasta donde sea relevante para el personaje. El objetivo es un análisis completo de aproximadamente 1200-1300 palabras. Basa tu análisis únicamente en el siguiente personaje o concepto:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia de One Piece. Genera exactamente 15 nombres de personajes de One Piece (principales, secundarios, villanos, aliados) o conceptos clave directamente relacionados con personajes (como tipos específicos de Haki o Frutas famosas). Devuelve *solo* la lista de nombres/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) { /* ... Sin cambios ... */
            const encodedPrompt = encodeURIComponent(prompt);
            const encodedSystem = encodeURIComponent(config.systemPrompt);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intenta de nuevo.`);
                throw new Error(`Error de comunicación con la API: ${error.message}`);
            }
        }
        async function fetchExplanationText(conceptTitle) { /* ... Sin cambios ... */
            const text = await fetchTextFromApi(conceptTitle, textApiConfig);
             if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de")) {
                  throw new Error("La IA no pudo generar un análisis adecuado o suficientemente detallado para este personaje/concepto.");
              }
            return text;
        }
        async function fetchGeneratedTitles() { /* ... Sin cambios ... */
            const randomTheme = getRandomElement(onePieceThemes) || "personajes importantes de One Piece";
            const specificPrompt = `Genera 15 nombres de personajes de One Piece o conceptos clave sobre ${randomTheme}`;
            console.log("Generating titles with prompt:", specificPrompt);
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
            const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 2 && line.length < 150); // Min length 3 chars
            if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de títulos.");
            return titles.slice(0, 15);
        }
        function createPollinationsImageUrl(characterName, options = {}) { // Prompt adaptado a ONE PIECE
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safeCharacterName = typeof characterName === 'string' && characterName.trim() !== '' ? characterName : "Luffy One Piece";
            // Prompt ENFOCADO en el personaje, estilo anime, sin texto.
            const enhancedPrompt = `Dynamic anime style portrait or action scene of the One Piece character '${safeCharacterName}'. Capture their iconic look, personality, and maybe hint at their abilities (e.g., Luffy stretching, Zoro with swords, Nami with Clima-Tact). Avoid text, logos, or UI elements. Cinematic lighting, vibrant colors typical of One Piece anime style.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            // NEGATIVE PROMPT: Evitar texto, logos, baja calidad, anatomía incorrecta.
            const negativePrompt = "text, words, letters, title, logo, signature, watermark, ui elements, buttons, menu, multiple characters unless specified, simple background, boring pose, low quality, blurry, bad anatomy, deformed, multiple limbs, extra fingers, text bubbles, manga panel lines, frame, border";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, '<br>'); // Keep <br> for single line breaks within paragraphs
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Sin cambios estructurales)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { /* ... Sin cambios ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... Sin cambios ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... Sin cambios ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... Sin cambios ... */
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]);
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay personajes listados.</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... Sin cambios ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        // *** MODIFIED: handleTitleClick to append image inside #modal-content ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // 1. Fetch and format text
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // 2. Stop loading indicator, display text FIRST
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                // 3. *** RESET SCROLL *** after text content is in and visible
                modalContent.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // 4. Prepare and append image placeholder/spinner WITHIN #modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando imagen del personaje...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // 5. Create and append the actual image element (starts loading)
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Imagen de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-eye-slash placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">No se pudo cargar la imagen.</p>
                    `;
                };

                // Get URL and set src AFTER attaching handlers
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">Error al generar URL de imagen.</p>
                    `;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
            }
        }

        async function handleGenerateMoreTitles() { /* ... Adaptado a One Piece ... */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando tesoros...'; // Thematic text
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; // Hide button container
                     appendTitles(newTitles); // Add new titles
                     // Re-append the button container AFTER the new titles
                     if (titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block'; // Show button container again
                 } else {
                     alert("No se encontraron más recompensas en este momento."); // Thematic text
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar recompensas: ${error.message}`); // Thematic text
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Desplegar Más Recompensas'; // Thematic text
             }
         }


        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Initialization failed!"); document.body.innerHTML = '<p style="color: red; font-size: 2em; text-align: center; padding-top: 5em;">¡Error Catastrófico! No se pudo cargar la enciclopedia. ¡Llamen a los Marines!</p>'; return; } // Thematic error
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); }); // Close clicking outside modal
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>