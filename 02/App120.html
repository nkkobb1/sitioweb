<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psicología Oscura - Exploración Conceptual</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Serias/Analíticas -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Psicología Oscura --- */
        :root {
            --color-primary: #8b5cf6; /* Púrpura Suave */
            --color-secondary: #4f46e5; /* Índigo */
            --color-tertiary: #ec4899; /* Rosa (uso muy moderado) */
            --color-background: #1f2937; /* Gris Azulado Muy Oscuro */
            --color-text: #d1d5db; /* Gris Claro */
            --color-text-muted: #9ca3af; /* Gris Medio */
            --color-modal-bg: #374151; /* Gris Azulado Oscuro */
            --color-border: #4b5563; /* Borde Gris */
            --color-error-bg: #450a0a; /* Rojo muy oscuro */
            --color-error-text: #fecaca; /* Texto error claro */
            --color-error-border: #ef4444; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.25), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        /* Usar Merriweather para el contenido principal del modal */
        #modal-content { font-family: 'Merriweather', serif; }
        h1, h2, h3, h4, .logo { font-family: 'Lato', sans-serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-text); font-weight: 700; }
        h2.section-title { color: var(--color-primary); border-bottom: 2px solid var(--color-border); padding-bottom: 0.6rem; display: inline-block; font-weight: 400; text-transform: uppercase; letter-spacing: 1px; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(31, 41, 55, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3); outline: none; background-color: #4b5563; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alineación izquierda */ font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: start; /* Alineación contenido */ min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; border-left: 4px solid var(--color-border); }
        .title-item i { margin-right: 0.8rem; color: var(--color-primary); opacity: 0.7; width: 1.2em; text-align: center;} /* Icono alineado */
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-border); border-left-color: var(--color-primary); color: #ffffff; background-color: #4b5563; }
        .title-item:hover i { opacity: 1; }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: #ffffff; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: var(--color-secondary); box-shadow: var(--shadow-lg); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: #ffffff; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.92); backdrop-filter: blur(3px); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; color: #ffffff; /* Título más brillante */ }

        /* Área de Contenido Principal */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(75, 85, 99, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(75, 85, 99, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; } /* Más espacio entre párrafos */
        #modal-content strong { color: var(--color-primary); font-weight: 700; font-family: 'Lato'; /* Usar Lato para resaltar */ }
        #modal-content em { color: #a78bfa; /* Púrpura más claro para énfasis */ font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Lato', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; letter-spacing: 0.5px; }
        #modal-content h1 { font-size: 1.5em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: #a78bfa; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; font-weight: 400;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; filter: grayscale(30%) contrast(110%); /* Efecto sutil */ }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); filter: grayscale(0%) contrast(100%); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); border: 1px dashed var(--color-border); border-radius: var(--border-radius); padding: 1rem; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(75, 85, 99, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; opacity: 0.6; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(31, 41, 55, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(75, 85, 99, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(75, 85, 99, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-family: 'Lato'; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: #ffffff; margin-left: auto; text-align: left; font-weight: 400;} /* User msg a la izq para variar */
        .ai-message { background-color: #4b5563; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #1f2937; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); background-color: var(--color-background); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: #ffffff; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-secondary); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(31, 41, 55, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.3rem; font-family: 'Lato'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.97); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); box-shadow: var(--shadow-lg); filter: grayscale(0) contrast(100%); /* Sin filtro en fullscreen */ }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-brain mr-3 text-purple-400"></i> <!-- Icono cerebro -->
                     Psique Sombra
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Exploración Conceptual «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Psicología Oscura</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Un análisis conceptual de las tácticas de influencia, manipulación y los aspectos menos comprendidos de la mente humana.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar concepto (ej: Gaslighting, Sesgo...)">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-purple-400 mr-2"></i> <!-- Icono libro -->
                 Índice de Conceptos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Cargando conceptos psicológicos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron conceptos coincidentes «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Más Conceptos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Analizando concepto...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este concepto...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Conceptual Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-800 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos y de análisis conceptual sobre psicología.</p>
              <p class="mt-1">Este contenido no constituye asesoramiento psicológico profesional ni promueve conductas perjudiciales. Busca ayuda profesional si la necesitas.</p>
              <p class="mt-2">© 2025 Exploración Psique Sombra</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Técnicas de Manipulación Directa
            "Gaslighting: Definición y Ejemplos", "Proyección Psicológica como Táctica", "Culpar a la Víctima (Victim Blaming)", "Triangulación Narcisista", "Refuerzo Intermitente", "Condicionamiento Operante en la Manipulación", "Tratamiento Silencioso (Silent Treatment)", "Love Bombing (Bombardeo de Amor)", "Siembra de Dudas (Undermining)", "Desviación y Evasión (Deflection & Evasion)", "Minimización de Sentimientos", "Mentira Patológica", "Manipulación Emocional Directa", "Amenazas Veladas", "Intimidación Sutil", "Aislamiento Social Progresivo", "Control Coercitivo", "Uso de Información Confidencial", "Falsa Vulnerabilidad", "Generación de Deuda Emocional", "Sabotaje Encubierto", "Promesas Rotas Sistemáticamente", "Humillación Pública o Privada", "Comparaciones Odiosas", "Creación de Dependencia",
            // Tríada y Tétrada Oscura
            "Narcisismo: Rasgos Centrales", "Maquiavelismo: Estrategia y Engaño", "Psicopatía: Falta de Empatía y Remordimiento", "Sadismo Cotidiano (Everyday Sadism)", "La Tríada Oscura en Relaciones", "La Tríada Oscura en el Trabajo", "Diferencias entre Narcisismo y Psicopatía", "Manipulación Característica del Maquiavélico", "Identificación de Rasgos de la Tríada Oscura", "Impacto de la Tríada Oscura en Víctimas", "Vulnerabilidades Explotadas por la Tríada Oscura", "Sadismo Verbal", "Sadismo Vicario", "La Tétrada Oscura: Incluyendo el Sadismo", "Orígenes y Desarrollo de Rasgos Oscuros",
            // Sesgos Cognitivos (Explotables)
            "Sesgo de Confirmación: Cómo se Explota", "Efecto Dunning-Kruger en la Manipulación", "Falacia del Costo Hundido (Sunk Cost Fallacy)", "Sesgo de Anclaje en Negociaciones", "Sesgo de Disponibilidad: Manipular la Percepción", "Efecto Halo y su Uso Persuasivo", "Sesgo de Autoridad: Obediencia Ciega", "Pensamiento de Grupo (Groupthink)", "Sesgo de Negatividad: Explotar el Miedo", "Efecto Forer (Efecto Barnum)", "Ilusión de Control", "Sesgo Endogrupal (In-group Bias)", "Error Fundamental de Atribución", "Sesgo Retrospectivo (Hindsight Bias)", "Heurística del Afecto",
            // Técnicas de Persuasión (Potencialmente Oscuras)
            "Técnica del Pie en la Puerta (Foot-in-the-Door)", "Técnica de la Puerta en la Cara (Door-in-the-Face)", "Principio de Escasez", "Principio de Reciprocidad (Manipulativa)", "Prueba Social (Social Proof) Engañosa", "Principio de Simpatía (Likeability) Fabricada", "Principio de Autoridad Falsa o Exagerada", "Compromiso y Coherencia Forzados", "Persuasión Emocional vs. Racional", "Uso de Eufemismos y Disfemismos", "Encuadre (Framing) Manipulativo", "Técnica de 'Bola Baja' (Low-Balling)", "Técnica de 'Eso no es todo' (That's-Not-All)", "Apelación al Miedo (Fear Appeal)", "Uso de Lenguaje Cargado Emocionalmente",
            // Conceptos Relacionados
            "Ingeniería Social: Principios Psicológicos", "Phishing y Vishing: Psicología Detrás", "Pretexting: Crear una Falsa Realidad", "Microagresiones", "Agresión Pasiva", "Codependencia", "Síndrome de Estocolmo", "Disociación Cognitiva Inducida", "Lavado de Cerebro: Mitos y Realidad", "Influencia de Sectas", "Psicología de la Estafa (Scamming)", "El Poder de la Sugestión", "Hipnosis Ericksoniana (Uso Manipulativo)", "Programación Neurolingüística (PNL): Controversias", "Comunicación No Verbal Engañosa",
            // Trastornos y Rasgos (Enfoque en Comportamiento)
            "Trastorno de Personalidad Antisocial (Comportamientos)", "Trastorno de Personalidad Narcisista (Comportamientos)", "Trastorno Límite de la Personalidad (Manipulación asociada)", "Trastorno Histriónico de la Personalidad (Búsqueda de atención)", "Paranoia y Desconfianza Explotables", "Vulnerabilidad de la Baja Autoestima", "Dependencia Emocional", "Necesidad de Aprobación Excesiva", "Miedo al Abandono", "Impulsividad como Vulnerabilidad",
            // Defensa y Conciencia
            "Reconocer Banderas Rojas (Red Flags) en Relaciones", "Establecer Límites Saludables", "Desarrollo de la Asertividad", "Fortalecer la Inteligencia Emocional", "Detectar Incongruencias (Verbal/No Verbal)", "Confiar en la Intuición", "Técnica de la 'Piedra Gris' (Gray Rock)", "Documentar Interacciones Manipuladoras", "Buscar Apoyo Social", "Desarrollar el Pensamiento Crítico", "Entender los Propios Sesgos Cognitivos", "Practicar el Mindfulness", "Terapia Psicológica como Defensa", "Educación sobre Tácticas de Manipulación", "Validación Emocional Propia",
             // Ética y Consecuencias
             "Impacto Psicológico de la Manipulación a Largo Plazo", "Consecuencias Legales de la Coerción", "Ética en la Persuasión y la Influencia", "Responsabilidad Personal y Manipulación", "El Espectro de la Influencia: Positiva vs. Negativa", "Daño Moral y Manipulación", "Reparación del Daño Psicológico", "Cultura y Normalización de la Manipulación",
             // Conceptos Avanzados/Teóricos
             "Teoría del Intercambio Social en la Manipulación", "Teoría de la Autodeterminación (Vulnerabilidades)", "Modelo Transteórico del Cambio (Aplicado a la coerción)", "Teoría del Apego y Patrones Manipulativos", "Resonancia Límbica y Contagio Emocional", "Neuronas Espejo y Empatía (Ausencia)", "Neurobiología del Engaño", "Psicopatía Exitosa vs. Criminal",
             // Ampliando...
             "Manipulación Financiera", "Chantaje Emocional", "Hoovering Narcisista", "Gaslighting Médico", "Gaslighting Laboral", "Mobbing (Acoso Psicológico Laboral)", "Ciberacoso y Tácticas Psicológicas", "Grooming Online", "Manipulación en Redes Sociales", "Fake News y Psicología de la Desinformación", "Propaganda y Persuasión Política", "Publicidad Engañosa y Principios Psicológicos", "Técnicas de Interrogatorio Coercitivas", "Falsas Memorias Inducidas", "Efecto Lucifer (Experimento de la Cárcel de Stanford)", "Experimento de Milgram sobre Obediencia", "Disonancia Cognitiva: Reducción Manipulativa", "Teoría de la Inoculación (Resistencia a la Persuasión)", "La 'Ventana de Overton' y Normalización", "Doblepensar (Doublethink)", "Neolengua (Newspeak) y Control del Pensamiento", "Psicología Inversa", "El Efecto Pigmalión Negativo (Gólem)", "Profecía Autocumplida Inducida", "Invalidación Crónica", "Parentificación", "Alienación Parental", "Abuso Encubierto", "Reflejo (Mirroring) Manipulativo", "Idealización y Devaluación", "Descarte Narcisista", "Campaña de Difamación (Smear Campaign)", "Monos Voladores (Flying Monkeys)", "La Niebla (FOG: Fear, Obligation, Guilt)", "Luz de Gas Colectiva", "Control del Entorno", "Privación del Sueño como Táctica", "Sobrecarga de Información", "Rituales y Control Grupal", "Adoctrinamiento", "Falacias Lógicas Comunes en Manipulación", "Ad Hominem", "Hombre de Paja (Straw Man)", "Apelación a la Emoción (Pathos) Excesiva", "Generalización Apresurada", "Pendiente Resbaladiza (Slippery Slope)", "Falso Dilema", "Cortina de Humo (Red Herring)", "Non Sequitur", "Comprender la Motivación del Manipulador", "Vacío Emocional y Narcisismo", "Búsqueda de Poder y Control", "Inseguridad Profunda", "Miedo a la Intimidad", "Envidia Patológica", "Resiliencia Psicológica Post-Abuso", "Crecimiento Postraumático", "Reconstrucción de la Identidad", "Perdón vs. Olvido", "Justicia Restaurativa vs. Retributiva", "Prevalencia de Rasgos Oscuros en la Sociedad", "Detección Temprana en Niños/Adolescentes", "Programas de Prevención del Acoso", "Alfabetización Emocional"
            // ... Continuar expandiendo con variaciones y sub-temas
        ];
        const darkPsychologyThemes = [ // Temas para generar más títulos
            "técnicas de manipulación", "tríada oscura", "narcisismo", "maquiavelismo", "psicopatía", "sesgos cognitivos", "persuasión coercitiva", "ingeniería social", "defensa contra manipulación", "límites personales", "inteligencia emocional", "gaslighting", "love bombing", "chantaje emocional", "abuso psicológico", "relaciones tóxicas", "sectas", "estafas psicológicas", "ética de la influencia", "reconocimiento de banderas rojas"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un psicólogo experto y escritor analítico especializado en los aspectos más oscuros del comportamiento humano, la influencia y la manipulación. Tu tarea es describir el concepto psicológico indicado de forma OBJETIVA, NEUTRA y DETALLADA. Explica sus mecanismos subyacentes, proporciona ejemplos claros (hipotéticos o generales, nunca gráficos), discute su posible impacto en individuos y relaciones, y crucialmente, menciona formas de RECONOCIMIENTO y ESTRATEGIAS DE AFRONTAMIENTO o DEFENSA. NO DEBES promover, justificar ni glorificar estas conductas. El enfoque es la comprensión y la prevención. Utiliza terminología psicológica precisa pero hazla accesible. El objetivo es un análisis exhaustivo y ético de aproximadamente 1200-1300 palabras. Basa tu análisis únicamente en el siguiente concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúas como un asistente de IA enfocado en psicología, especializado únicamente en el concepto que se está mostrando actualmente. Responde preguntas de seguimiento sobre los detalles, mecanismos, ejemplos o formas de reconocimiento de ESTE concepto específico, basándote en la descripción principal. Sé conciso, objetivo y mantén un tono ético y neutral. No des consejos personales ni diagnósticos.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia de psicología. Genera exactamente 15 términos, conceptos o preguntas específicas relacionadas con la psicología oscura, la manipulación, la persuasión y la defensa psicológica. Asegúrate de que los términos sean claros y adecuados para una explicación detallada. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        // ... (Sin cambios respecto a la versión anterior, excepto quizás nombres de variables si se desea)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Área scrollable
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');


        // ========== State Variables ==========
        let currentTopicTitle = null; // Renombrado para claridad

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             // *** USA EL SYSTEM PROMPT DINÁMICO PARA CHAT ***
             const systemPromptToUse = isChat && currentTopicTitle // Usa la variable renombrada
                 ? `Actúas como un asistente de IA enfocado en psicología, especializado únicamente en el concepto '${currentTopicTitle}'. Responde preguntas de seguimiento sobre los detalles, mecanismos, ejemplos o formas de reconocimiento de ESTE concepto específico, basándote en la descripción principal. Sé conciso, objetivo y mantén un tono ético y neutral. No des consejos personales ni diagnósticos.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             // Seed no suele ser útil en chat conversacional
             if (config.seed && !isChat && Math.random() < 0.5) { // Añadir seed a veces para variar descripciones
                params.append('seed', config.seed + Math.floor(Math.random() * 1000));
             }
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, por favor intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 // Validación básica de contenido (evitar respuestas vacías o claramente erróneas)
                 if (!text || text.trim().length < 50 || text.toLowerCase().includes("no puedo procesar esta solicitud") || text.toLowerCase().includes("i cannot fulfill this request")) {
                     console.warn("Respuesta de API posiblemente inválida o muy corta:", text);
                     throw new Error("La IA devolvió una respuesta inesperada o insuficiente. Intenta de nuevo.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 }
                 // Propaga el error (ya debería ser amigable)
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(conceptTitle) {
            // Potencialmente añadir un seed aleatorio aquí si se quiere variabilidad
            const config = {...textApiConfig, seed: Math.floor(Math.random() * 100000)};
            return fetchTextFromApi(conceptTitle, config, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentTopicTitle) throw new Error("Error interno: No se ha establecido el contexto del concepto para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true); // true indica que es chat
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(darkPsychologyThemes) || "psicología oscura general";
            const specificPrompt = `Genera 15 términos o preguntas sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n')
                                        .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                        .filter(line => line.length > 5 && line.length < 150 && !line.toLowerCase().includes("generar más")); // Filtrar líneas vacías/cortas/irrelevantes
                     if (titles.length < 5) throw new Error("La IA no generó suficientes conceptos válidos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "concepto psicológico abstracto";
             // *** PROMPT DE IMAGEN CUIDADOSO Y ABSTRACTO ***
             const enhancedPrompt = `Abstract, symbolic, conceptual art representing the psychological concept of '${safePromptText}'. Use metaphors like masks, shadows, labyrinths, distorted reflections, tangled threads, fragmented minds. Dark, atmospheric, thought-provoking mood. Avoid literal depictions of people, actions, or harm. Focus on symbolism and abstraction.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // *** NEGATIVE PROMPT REFORZADO ***
             const negativePrompt = "text, words, labels, letters, diagram, chart, realistic human figures, faces, violence, suffering, blood, gore, weapons, direct depiction of abuse or harm, happy people, clear instructions, photograph, simple illustration";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (Sin cambios, parece robusta)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            // Regex para convertir ####, ###, ##, # a <h4>, <h3>, <h2>, <h1>
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            // Regex para **bold** -> <strong>
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Regex para *italic* -> <em>
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             // Regex para listas (simplificado, asume '*' o '-' al inicio de línea)
             formatted = formatted.replace(/^\s*[\*\-]\s+(.*)$/gm, '<li>$1</li>');
             // Envolver bloques de <li> en <ul> (simple heurística)
             formatted = formatted.replace(/^(<li>.*<\/li>\s*)+/gm, (match) => `<ul>\n${match}</ul>\n`);
             // Eliminar <br> dentro de <li> si los párrafos anteriores las pusieron
             formatted = formatted.replace(/<li>(.*?)<br\s*\/?>/g, '<li>$1</li>');

            // Convertir párrafos separados por doble salto de línea en <p>
            // PERO ignorar si están dentro de <ul> ya
            const blocks = formatted.split(/\n\s*\n/);
            formatted = blocks.map(block => {
                let trimmedBlock = block.trim();
                if (!trimmedBlock) return '';
                // Si ya es un encabezado, lista o <p>, dejarlo como está
                if (trimmedBlock.startsWith('<h') || trimmedBlock.startsWith('<ul') || trimmedBlock.startsWith('<p>')) return trimmedBlock;
                // Si es solo texto, envolver en <p> y reemplazar saltos internos con espacio
                let content = trimmedBlock.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('\n'); // Usar \n como separador temporal, se eliminará con la unión final

             // Limpieza final de saltos de línea redundantes entre elementos
             formatted = formatted.replace(/\n+/g, '\n').replace(/<\/ul>\n<p>/g, '</ul><p>').replace(/<\/h[1-4]>\n<p>/g, '</h$1><p>'); // Compactar un poco

            return formatted.replace(/\n/g, ''); // Eliminar saltos de línea restantes
         }

        // ========== MODAL FUNCTIONS ========== (Sin cambios lógicos)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null; // Resetear contexto
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios lógicos)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (Sin cambios lógicos)
        function addChatMessage(message, sender) { /* ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentTopicTitle) return; // Asegura contexto
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); }
            finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // Añadir un icono genérico
            const icon = document.createElement('i');
            icon.className = 'fas fa-user-secret fa-fw'; // Icono de incógnito/secreto
            div.appendChild(icon);
            const textSpan = document.createElement('span');
            textSpan.textContent = title;
            div.appendChild(textSpan);
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' })); // Orden alfabético sensible al español
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» No hay conceptos disponibles en la base de datos «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             // Filtrar duplicados antes de añadir
             const uniqueNewTitles = newTitles.filter(title => !existingTitles.has(title));
             uniqueNewTitles.forEach(title => { titleListContainer.appendChild(createTitleItem(title)); });
             filterTitles(searchInput.value); // Re-aplicar filtro
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState(); // Resetea todo, incluyendo currentTopicTitle
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // *** ESTABLECE EL CONTEXTO PARA EL CHAT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset scroll
                console.log("Scroll set to 0 after content visible");

                // Placeholder de imagen
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-palette placeholder-icon"></i> <!-- Icono paleta/abstracto -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando imagen conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Añadir placeholder al final del texto

                // Cargar imagen
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); // Listener para expandir
                };
                imgElement.onerror = () => {
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar visualización.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Añadir img al final del contenido
                } else {
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo crear URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el concepto."; // Usar error amigable
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Mostrar área de error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando Más Conceptos...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más conceptos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar conceptos: ${error.message}`); // Error amigable
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Conceptos';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Ocultar si hay resultados o si la lista está vacía
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // ... (Verificar todos los elementos necesarios, incluyendo chat y fullscreen)
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalContent || !modalTextArea) {
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: #ef4444; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Fallo al inicializar componentes de la interfaz.</p>';
                 return;
            }
            // Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>