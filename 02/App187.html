<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grimorio Gótico - Enciclopedia Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Góticas/Serifadas y Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Horror Gótico --- */
        :root {
            --color-primary: #6a0dad; /* Púrpura Oscuro (Misterio, Realeza Decadente) */
            --color-secondary: #8B0000; /* Carmesí / Rojo Sangre (Peligro, Pasión Oscura) */
            --color-tertiary: #b8860b; /* Oro Viejo / Bronce (Riqueza Decadente, Ocultismo) - Uso sutil */
            --color-background: #121212; /* Casi Negro / Gris Muy Oscuro (Profundidad, Sombra) */
            --color-text: #e0e0e0; /* Blanco Hueso / Gris Muy Claro (Contraste legible) */
            --color-text-muted: #888888; /* Gris Medio (Texto secundario) */
            --color-modal-bg: #1f1f1f; /* Gris Oscuro ligeramente más claro */
            --color-border: #444444; /* Borde Gris Oscuro */
            --color-error-bg: #2b0000; /* Fondo error rojo muy oscuro */
            --color-error-text: #f5caca; /* Texto error pálido */
            --color-error-border: #8B0000; /* Borde error carmesí */

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 5px 10px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(106, 13, 173, 0.2); /* Sombra con tinte púrpura */
            --border-radius: 2px; /* Bordes más afilados, casi rectos */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; /* Background pattern opcional */ /* background-image: url('data:image/svg+xml,%3Csvg width="10" height="10" viewBox="0 0 10 10" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M-1 1l2-2 M0 10l10-10 M9 11l2-2" stroke="%232a2a2a" stroke-width=".5"/%3E%3C/svg%3E'); */ }
        h1, h2, h3, h4, .logo { font-family: 'EB Garamond', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px rgba(106, 13, 173, 0.7); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 1px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; font-style: italic; }
        #modal-title { color: var(--color-primary); font-weight: 700; font-size: 2rem; text-shadow: 0 0 5px rgba(106, 13, 173, 0.5); }
        .navbar { background-color: rgba(18, 18, 18, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(31, 31, 31, 0.8); color: var(--color-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.4); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: inset 0 1px 3px rgba(0,0,0,0.4), 0 0 8px rgba(106, 13, 173, 0.4); outline: none; background-color: #1f1f1f; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.1rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alineación izquierda */ font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); border-left: 4px solid var(--color-border); /* Borde izquierdo */ display: flex; align-items: center; min-height: 60px; font-family: 'Lato'; font-size: 0.95rem; }
        .title-item:hover { transform: translateX(5px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #2a2a2a; border-left-color: var(--color-primary); }
        /* Botón de Generar Más Eliminado */

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(18, 18, 18, 0.95); /* Overlay muy oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: var(--color-text); transform: rotate(90deg); box-shadow: 0 0 8px var(--color-secondary); }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(68, 68, 68, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(68, 68, 68, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'EB Garamond', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 700; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; font-style: italic;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.8rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: 0 0 18px rgba(0, 0, 0, 0.6); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; filter: saturate(0.9) brightness(0.9); /* Slightly desaturated/darker */ }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 25px rgba(106, 13, 173, 0.3); filter: saturate(1) brightness(1); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.8rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(68, 68, 68, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles (Similar to previous, adapted colors) */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(18, 18, 18, 0.7); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(68, 68, 68, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(68, 68, 68, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--color-tertiary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400; opacity: 0.9;}
        .ai-message { background-color: #333333; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #2a2a2a; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-text); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #8a2be2; /* Lighter purple hover */ }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(18, 18, 18, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.4rem; font-family: 'EB Garamond', serif; font-style: italic; text-shadow: 0 0 5px var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay (Adapted colors) */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(18, 18, 18, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); box-shadow: var(--shadow-lg); filter: brightness(1); /* Full brightness when fullscreen */ }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-text); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-book-dead mr-3 text-purple-400"></i> <!-- Icono Grimorio -->
                     Grimorio Gótico
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">~ Fantasía y Horror ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Ecos de lo Decadente</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Desentraña los secretos velados por la noche eterna. Consulta las páginas prohibidas sobre criaturas, lugares y maldiciones que moran en las sombras.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar en las crónicas oscuras...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll text-yellow-700 mr-2"></i> <!-- Icono Pergamino -->
                 Índice de Sombras
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Desempolvando los archivos prohibidos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">~ Ningún registro encontrado en los anales ~</p>
             <!-- Contenedor del botón "Generar Más" Eliminado -->
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Consultando los Ecos...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Descifrando susurros...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Interroga a las sombras...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-black text-gray-600 py-6 mt-12 border-t border-gray-800 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Conocimiento arcano generado por IA, inspirado en la fantasía y el horror gótico.</p>
              <p class="mt-1">Las entidades y lugares descritos pertenecen al reino de la ficción melancólica.</p>
              <p class="mt-2">© El Último Anochecer - Grimorio Gótico</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Criaturas Vampíricas
            "Vampiro Ancestro (Primigenio)", "Nosferatu (Aspecto Grotesco)", "Strigoi (Folklore Rumano)", "Vampiro Aristócrata Decadente", "Dhampir (Nacido de Vampiro y Mortal)", "Vrykolakas (No Muerto Griego)", "Súcubo/Íncubo Sanguinario", "Bestia Vampírica (Forma Animal)", "Vampiro Psíquico (Drenador de Esencia)", "Engendro Vampírico (Sirviente Menor)", "La Reina Carmesí", "El Señor de la Cripta Olvidada", "Vampiro Renegado (Rechaza su Naturaleza)", "Culto de Sangre Vampírico", "Cazador de Vampiros Caído (Convertido)",
            // Entidades Espectrales y Etéreas
            "Fantasma Llorón (Banshee)", "Espectro Vengativo", "Poltergeist Violento", "Wraith (Drenador de Vida)", "Sombra Viviente", "Aparición Nebulosa", "Fantasma Encadenado (Atado a un Lugar)", "Eco Psíquico (Recuerdo Atormentado)", "El Barquero Espectral", "Legión de Almas Perdidas", "Fantasma Infantil Juguetón (Malicioso)", "Doppelgänger Espectral", "Guardia Fantasmal de Tumbas", "El Coro Invisible", "La Dama Blanca del Torreón",
            // Licántropos y Cambiaformas
            "Hombre Lobo Clásico (Maldición Lunar)", "Loup-Garou (Folklore Francés)", "Cambiaformas Ancestral (Múltiples Formas)", "Berserker Licántropo", "Piel Andante (Skinwalker)", "Hombre Murciélago Gigante", "Mujer Gato Siniestra", "El Ritual de la Luna de Sangre", "La Manada Salvaje", "Licántropo Alfa Dominante", "Maldición de la Licantropía", "Cazador de Licántropos", "Hombre Rata de las Cloacas", "Cambiaformas Involuntario", "Simbionte Licantrópico",
            // No Muertos y Constructos
            "Zombie Lento (Clásico)", "Ghoul Necrófago", "Esqueleto Guerrero Reanimado", "Liche (Mago No Muerto)", "Momia Vengativa", "Revenant (Retornado por Venganza)", "Golem de Carne Cosida (Frankenstein)", "Gargola Viviente de Piedra", "Homúnculo Alquímico Imperfecto", "Sirviente Zombificado", "El Ejército de los Huesos", "El Maestro de Marionetas No Muertas", "Autómata Embrujado", "Caballero de la Muerte", "Plaga Zombi",
            // Horrores Sobrenaturales y Abominaciones
            "Abominación Tentacular (Lovecraftiana)", "Cultista Degenerado", "Ángel Caído Corrupto", "Demonio Menor Invocado", "Engendro del Vacío", "Horror Corporal Informe", "Planta Carnívora Sobrenatural", "Enjambre Consciente (Insectos/Ratas)", "La Cosa Sin Nombre", "El Habitante del Espejo", "Poseído por Entidad Demoníaca", "Familia Endogámica Mutante", "El Titiritero Cósmico (Indirecto)", "Parásito Sobrenatural", "El Dios Olvidado Despertando",
            // Lugares Embrujados y Malditos
            "Castillo Gótico en Ruinas", "Mansión Victoriana Decadente", "Cementerio Olvidado y Profanado", "Asilo Mental Abandonado", "Páramo Nebuloso Eterno", "Bosque Embrujado y Retorcido", "Catacumbas Laberínticas", "Monasterio Desconsagrado", "Pueblo Fantasma Aislado", "Biblioteca Prohibida y Polvorienta", "Teatro de Ópera Maldito", "Faro Solitario en la Tormenta", "Isla Prisión Tenebrosa", "Sanatorio Tuberculoso en la Montaña", "El Cruce de Caminos del Diablo",
            // Personajes y Arquetipos Góticos
            "El Último Noble de un Linaje Maldito", "La Heroína Virgen y Perseguida", "El Científico Loco Obsesionado", "El Cazador de Monstruos Cínico", "El Erudito Ocultista Recluido", "El Artista Torturado por Visiones", "El Clérigo que Perdió la Fe", "El Mayordomo Siniestro y Leal", "La Femme Fatale Vampírica", "El Niño Fantasma Solitario", "El Inquisidor Implacable", "El Músico Melancólico y Maldito", "La Gobernanta Misteriosa", "El Sepulturero Conocedor de Secretos", "El Bufón Loco y Profético",
            // Artefactos y Objetos Malditos
            "Grimorio Encuadernado en Piel Humana", "Espejo que Refleja el Alma Oscura", "Daga Ritual Empapada en Sangre", "Amuleto que Susurra Secretos Prohibidos", "Retrato que Envejece por su Dueño", "Caja de Música con Melodía Enloquecedora", "Reliquia Sagrada Corrompida", "Muñeca de Porcelana Poseída", "Llave Maestra de Hueso", "El Corazón Embalsamado del Amante", "Anillo de Nigromancia", "Lámpara que Revela Espectros", "Máscara Funeraria Viviente", "Pluma que Escribe con Sangre", "Contrato Infernal Enrollado",
            // Conceptos y Temas Góticos
            "La Melancolía del Inmortal", "La Belleza en la Decadencia (Sublime)", "El Horror de lo Desconocido (Uncanny)", "La Maldición Familiar Hereditaria", "El Amor Prohibido y Trágico", "La Desintegración de la Cordura", "El Peso Ineludible del Pasado", "La Culpa y la Expiación Eterna", "Secretos Familiares Oscuros", "La Tiranía de la Arquitectura Opresiva", "La Lucha contra la Propia Monstruosidad", "Aislamiento y Soledad Extrema", "La Muerte como Liberación Ambivalente", "El Pacto Faustiano", "La Atmósfera Opresiva y Claustrofóbica",
            // Eventos y Rituales Siniestros
            "El Baile de Máscaras de Medianoche", "La Cacería Salvaje Espectral", "El Ritual de Invocación Prohibido", "La Noche de la Niebla Eterna", "La Procesión de los Penitentes Fantasmales", "La Consagración de Sangre Lunar", "El Despertar del Horror Ancestral", "La Creación del Golem", "La Plaga de Sombras Devoradora", "El Juicio de los Condenados", "La Boda Negra (Pacto Oscuro)", "El Festín Caníbal Secreto", "La Apertura del Portal Infernal", "La Misa Negra en Ruinas", "El Último Suspiro del Mundo",
            // Elementos Adicionales de Fusión Fantástica
            "Magia de Sangre y Sacrificio", "Nigromancia y Reanimación", "Alquimia Oscura y Transmutación Prohibida", "Escuelas de Hechicería Decadentes", "Razas Antiguas Caídas (Elfos Oscuros, etc.)", "Dimensiones de Pesadilla Colindantes", "Artefactos Mágicos Corruptos", "Bestias Mágicas Retorcidas", "Profecías Apocalípticas Olvidadas", "Órdenes Secretas de Ocultistas", "Linajes con Sangre Sobrenatural", "La Influencia de Dioses Oscuros Olvidados", "Portales a Reinos de Sombras", "La Corrupción de la Naturaleza (Bosques Malditos)", "Ciudades Secretas Bajo Tierra",
             // (Continuar expandiendo estas categorías)
             "Gárgola Guardiana Animada", "Espectro del Pantano", "Horror Cósmico Gótico", "Mansión Flotante Espectral", "El Laberinto de Espejos del Alma", "Autómata de Relojería Maldito", "El Coleccionista de Almas", "La Doncella de Hierro Viviente", "El Libro de los Lamentos", "Candado Hecho de Dientes", "Elixir de Vida Eterna (Corruptor)", "Mapa Tatuado en Piel Desollada", "La Decadencia de la Nobleza", "El Terror Psicológico", "La Transgresión de Límites Naturales", "Canibalismo Ritual", "Vampirismo Energético", "Posesión Demoníaca Gradual", "El Doppelgänger Perfecto", "Secta Adoradora de la Decadencia", "Árbol Genealógico Maldito", "Retrato Familiar Embrujado", "Violín Hecho de Huesos", "Fragmento de un Alma Atrapada", "La Niebla que Roba Recuerdos", "El Castillo que Cambia de Forma", "La Ciudad Sumergida de los Ahogados", "El Carnaval de las Pesadillas Errante", "Poeta Maldito por la Musa Oscura", "La Estatua que Llora Sangre", "El Guardián Silencioso de la Cripta", "Reloj de Arena que Mide la Cordura", "Tinta Invisible Revelada por la Luna", "El Juego de Ajedrez contra la Muerte", "La Búsqueda del Perdón Eterno", "El Legado del Alquimista Loco", "La Sombra que Imita a su Dueño", "El Eco de un Grito Eterno", "La Balada del Ahorcado Vengativo", "El Monstruo Creado por el Miedo Colectivo", "La Infección que Transforma en Horror", "El Culto del Ojo que Todo lo Ve (Corrupto)", "La Biblioteca Infinita de Almas Perdidas"

        ];
        // Themes (puede ser útil para prompts internos si se reintroduce generación, o para IA)
        const gothicHorrorThemes = [
            "criaturas góticas", "vampiros", "fantasmas y espectros", "hombres lobo", "no muertos", "lugares embrujados", "castillos góticos", "mansiones decadentes", "cementerios", "artefactos malditos", "grimorios", "personajes góticos", "arquetipos del horror", "maldiciones familiares", "locura y decadencia", "atmósfera opresiva", "horror psicológico", "fantasía oscura", "magia prohibida", "nigromancia", "alquimia oscura", "cultos siniestros", "el sublime terrorífico", "amor trágico gótico"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un erudito recluido, un cronista especializado en la fantasía oscura y el horror gótico. Tu estilo es evocador, melancólico y ligeramente ominoso. Describe la entidad, lugar, objeto o concepto gótico proporcionado, fusionando elementos sobrenaturales con ambientes decadentes. Detalla su posible origen (lore), apariencia o manifestación, habilidades o peligros asociados, debilidades (si existen), el ambiente que evoca (misterio, melancolía, terror), y su rol o simbolismo dentro de un mundo de fantasía gótica oscura. Usa un lenguaje rico y atmosférico. El objetivo es una crónica detallada de aproximadamente 1200-1300 palabras. Basa tu crónica únicamente en la siguiente entrada del grimorio:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat, system prompt se sobreescribe
            model: "mistral-tiny",
            systemPrompt: "Actúa como el Guardián del Grimorio, un ser antiguo y conocedor de secretos oscuros. Responde preguntas sobre la entrada específica que se está consultando actualmente. Tu tono es críptico, erudito y ligeramente distante. Responde de forma concisa y siempre en el contexto del horror gótico.",
            timeoutSeconds: 45
        };
        // Configuración de Generación de Títulos Eliminada

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        // Elementos de "Generar Más" Eliminados
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Área de texto y imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Eres el Guardián del Grimorio. Responde preguntas concisas y crípticas sobre '${currentTopicTitle}', manteniendo un tono de horror gótico y erudición oscura.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Las sombras interfieren... Nuestros servidores parecen tener mucho tráfico en este momento. Inténtalo de nuevo en unos instantes.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("El eco de la respuesta se ha perdido en el vacío. Intenta preguntar de otra forma.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con el más allá se demoró demasiado (>${config.timeoutSeconds}s). Revisa tu vínculo o inténtalo cuando la luna cambie.`);
                 }
                 throw new Error(error.message || "Un horror desconocido impidió la comunicación con el oráculo.");
             }
        }
        async function fetchExplanationText(topicTitle) { return fetchTextFromApi(topicTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) {
            if (!currentTopicTitle) throw new Error("Error Interno: El contexto de la entrada actual se ha desvanecido.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        // Función fetchGeneratedTitles Eliminada
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "gothic horror fantasy scene";
             // Prompt ENFOCADO en arte gótico, oscuro, atmosférico.
             const enhancedPrompt = `Dark fantasy gothic horror art depicting '${safePromptText}'. Atmosphere of decay, melancholy, mystery. Style reminiscent of Caspar David Friedrich, Goya's Black Paintings, Zdzisław Beksiński mood. Chiaroscuro lighting, fog, rain, moonlight, crumbling architecture. Avoid bright colors. No text, labels.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, writing, letters, titles, captions, diagrams, charts, modern elements, bright colors, happy, cheerful, cartoon, anime, photorealistic, photograph, signature, watermark, UI";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (sin cambios significativos)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null; // Reset chat context
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios significativos)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`El Guardián susurra: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        // Funciones getRandomElement y shuffleArray no son necesarias sin "Generar Más"
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', {sensitivity: 'base'})); // Ordenar alfabéticamente
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">~ El grimorio parece vacío... por ahora ~</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        // Función appendTitles Eliminada

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-eye placeholder-icon text-gray-600"></i> <!-- Icono Ojo -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Evocando una visión...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visión de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-low-vision placeholder-icon text-gray-600"></i><p style="font-size:0.8em;margin-top:0.5rem;">La visión se desvanece.</p>`;
                };
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon text-red-700"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al crear la visión.</p>`;
                }
            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Un terror sin nombre impidió cargar la entrada.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }
        // Función handleGenerateMoreTitles Eliminada

        function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Verificación de elementos clave (sin el botón de generar más)
            if (!titleListContainer || !storyModal || !modalCloseBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #8B0000; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: EB Garamond;">++ CORRUPCIÓN CATASTRÓFICA ++ Faltan Componentes del Grimorio ++</p>';
                return;
             }
            // Listeners existentes
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Carga inicial de títulos (la única carga ahora)
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>