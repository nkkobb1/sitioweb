<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonitas Historias de Fe - Reflejos de Esperanza</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Elegantes y Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Nunito+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Historias de Fe --- */
        :root {
            --color-primary: #d4af37; /* Dorado Suave */
            --color-secondary: #a0d2eb; /* Azul Cielo Suave */
            --color-tertiary: #f0e68c; /* Caqui/Arena Claro */
            --color-background: #fdfbf6; /* Blanco Crema */
            --color-text: #4f4f4f; /* Gris Oscuro Suavizado */
            --color-text-muted: #8d8d8d; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro */
            --color-border: #e5e7eb; /* Borde Gris Muy Claro */
            --color-error-bg: #fff5f5; /* Fondo error rosa muy pálido */
            --color-error-text: #c53030; /* Texto error rojo oscuro */
            --color-error-border: #fed7d7; /* Borde error rojo pálido */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            --border-radius: 8px; /* Bordes más suaves */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Nunito Sans', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700;}
        #modal-title { color: #b8860b; /* Dorado más oscuro para título modal */ font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Nunito Sans'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Nunito Sans'; font-size: 1rem; }
        .title-item:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: #8b4513; /* Marrón siena para hover */ background-color: #fffaf0; /* Floral white */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { background-color: #c69a1e; /* Dorado más oscuro */ box-shadow: var(--shadow-md); transform: scale(1.02); }
        #generate-more-btn:disabled { background-color: var(--color-text-muted); color: #f0f0f0; cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(80, 80, 80, 0.8); /* Overlay gris suave */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.8rem 2.2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Altura suficiente para carga/chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #f0f0f0; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.35; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: #8b4513; font-weight: 600; } /* Marrón siena */
        #modal-content em { color: var(--color-primary); font-style: italic; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: #b8860b; border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 700; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-primary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 3rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 3rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(200, 200, 200, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9f9f9; /* Fondo chat ligeramente gris */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: 15px; /* Más redondeado */ max-width: 85%; word-wrap: break-word; line-height: 1.6; }
        .user-message { background-color: var(--color-secondary); color: #333; margin-left: auto; text-align: left; border-bottom-right-radius: 3px; }
        .ai-message { background-color: #e0e0e0; color: var(--color-text); margin-right: auto; text-align: left; border-bottom-left-radius: 3px; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Nunito Sans'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.15); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #c69a1e; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Screen & Minigame Styles */
        #modal-loading { text-align: center; padding: 2rem 1rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(253, 251, 246, 0.98); /* Fondo loading crema casi opaco */ display: none; /* Oculto por defecto */ flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #modal-loading.active { display: flex; } /* Mostrar cuando carga */
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid #e0e0e0; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading-text { font-weight: 600; color: var(--color-text); font-size: 1.3rem; font-family: 'Merriweather'; margin-bottom: 1.5rem; }
        /* Minigame Elements */
        #loading-minigame { margin-top: 1rem; display: flex; flex-direction: column; align-items: center; }
        #minigame-instructions { font-size: 0.9em; color: var(--color-text-muted); margin-bottom: 1rem; }
        #minigame-target { font-size: 3.5rem; color: var(--color-secondary); cursor: pointer; transition: transform 0.1s ease, color 0.1s ease; margin-bottom: 1rem; }
        #minigame-target:hover { transform: scale(1.1); color: var(--color-primary); }
        #minigame-target:active { transform: scale(0.9); }
        #minigame-score-display { font-size: 1.1em; font-weight: 600; color: var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Nunito Sans'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(253, 251, 246, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); border-radius: var(--border-radius); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-dove mr-3 text-blue-300"></i> <!-- Icono paloma -->
                     Historias de Fe
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wide">~ Reflejos de Esperanza ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Iluminando el Camino</h1>
             <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto font-light">Descubre narraciones y enseñanzas que inspiran, consuelan y fortalecen el espíritu. Un viaje a través de la fe y la esperanza.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar historia, personaje o concepto...">
             <i class="fas fa-search fa-book-open"></i> <!-- Icono libro/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-bible text-yellow-600 mr-2"></i> <!-- Icono Biblia/Libro -->
                 Índice de Historias y Conceptos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Buscando inspiración en los archivos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">~ No se encontraron historias para tu búsqueda ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Historias (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator & Minigame -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p id="modal-loading-text">Compartiendo la historia...</p>
                 <div id="loading-minigame">
                     <p id="minigame-instructions">Mientras esperas, ¡atrapa las estrellas!</p>
                     <i id="minigame-target" class="fas fa-star"></i> <!-- O fa-heart -->
                     <div id="minigame-score-display">Estrellas atrapadas: <span id="minigame-score">0</span></div>
                 </div>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Meditando la respuesta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta o reflexiona sobre esta historia...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-circle"></i> <!-- Icono más suave -->
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias y conceptos presentados con fines de inspiración, reflexión y educación.</p>
              <p class="mt-1">Contenido generado por IA basado en fuentes y tradiciones diversas. Se recomienda consultar textos originales.</p>
              <p class="mt-2">© 2025 Reflejos de Esperanza</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Antiguo Testamento - Figuras y Eventos
            "La Creación del Mundo (Génesis 1-2)", "Adán y Eva en el Edén", "Caín y Abel: La Primera Tragedia", "El Arca de Noé y el Diluvio Universal", "La Torre de Babel", "El Llamado de Abraham", "Abraham e Isaac: La Prueba de Fe", "Jacob y Esaú: La Primogenitura", "La Escalera de Jacob", "La Historia de José y sus Hermanos", "José en Egipto: De Esclavo a Gobernante", "El Éxodo: Moisés Libera a Israel", "El Cruce del Mar Rojo", "Los Diez Mandamientos", "El Becerro de Oro", "La Tierra Prometida: Josué y la Conquista", "La Caída de Jericó", "Sansón y Dalila", "La Historia de Rut y Noemí", "El Llamado del Profeta Samuel", "David y Goliat", "El Rey David: Triunfos y Pecados", "El Rey Salomón: Sabiduría y Construcción del Templo", "La División del Reino de Israel", "El Profeta Elías y los Profetas de Baal", "El Carro de Fuego de Elías", "El Profeta Eliseo y sus Milagros", "El Profeta Isaías: Visiones de Esperanza", "El Profeta Jeremías: Lamentos y Profecías", "El Exilio en Babilonia", "Daniel en el Foso de los Leones", "Los Tres Jóvenes en el Horno de Fuego", "La Reina Ester Salva a su Pueblo", "Nehemías Reconstruye los Muros de Jerusalén", "El Libro de Job: El Sufrimiento y la Fe", "Los Salmos: Oraciones y Alabanzas", "Proverbios: Sabiduría para la Vida", "Eclesiastés: La Búsqueda del Sentido", "Cantar de los Cantares: El Amor Divino", "El Profeta Jonás y la Ballena",
            // Nuevo Testamento - Vida de Jesús
            "La Anunciación a María", "El Nacimiento de Jesús en Belén", "La Visita de los Magos de Oriente", "La Huida a Egipto", "Jesús en el Templo a los Doce Años", "El Bautismo de Jesús por Juan el Bautista", "Las Tentaciones de Jesús en el Desierto", "Las Bodas de Caná: El Primer Milagro", "El Sermón del Monte: Las Bienaventuranzas", "Jesús Calma la Tempestad", "La Multiplicación de los Panes y los Peces", "Jesús Camina sobre las Aguas", "La Transfiguración de Jesús", "La Parábola del Sembrador", "La Parábola del Hijo Pródigo", "La Parábola del Buen Samaritano", "La Parábola de la Oveja Perdida", "La Parábola del Grano de Mostaza", "La Parábola de los Talentos", "La Resurrección de Lázaro", "La Entrada Triunfal en Jerusalén (Domingo de Ramos)", "La Última Cena", "La Oración en el Huerto de Getsemaní", "El Arresto de Jesús", "El Juicio ante Caifás y Pilato", "La Vía Dolorosa (Via Crucis)", "La Crucifixión de Jesús", "Las Siete Palabras de Jesús en la Cruz", "La Muerte y Sepultura de Jesús", "La Resurrección de Jesús", "Las Apariciones de Jesús Resucitado", "La Duda de Tomás", "La Ascensión de Jesús al Cielo",
            // Nuevo Testamento - Hechos y Apóstoles
            "Pentecostés: La Venida del Espíritu Santo", "El Primer Discurso de Pedro", "La Curación del Paralítico en la Puerta Hermosa", "Ananías y Safira", "El Martirio de Esteban", "La Conversión de Saulo (Pablo)", "Pedro y Cornelio: El Evangelio a los Gentiles", "El Primer Viaje Misionero de Pablo", "El Concilio de Jerusalén", "El Segundo Viaje Misionero de Pablo", "Pablo en Atenas: El Areópago", "Pablo en Corinto", "El Tercer Viaje Misionero de Pablo", "El Arresto de Pablo en Jerusalén", "Pablo ante Félix, Festo y Agripa", "El Viaje de Pablo a Roma y el Naufragio", "Las Cartas de Pablo (Epístolas)", "La Epístola a los Romanos: La Justificación por la Fe", "1 Corintios 13: El Himno al Amor", "La Epístola a los Gálatas: La Libertad en Cristo", "La Epístola a los Efesios: La Iglesia como Cuerpo de Cristo", "La Epístola a los Filipenses: El Gozo en Medio del Sufrimiento", "La Epístola a los Colosenses: La Supremacía de Cristo", "Las Epístolas Pastorales (Timoteo, Tito)", "La Epístola a Filemón: El Perdón", "La Epístola a los Hebreos: Cristo, el Sumo Sacerdote Superior", "Las Epístolas Generales (Santiago, Pedro, Juan, Judas)", "El Apocalipsis de Juan: Visiones del Fin",
            // Vidas de Santos y Figuras Inspiradoras (Ejemplos)
            "San Francisco de Asís: Amor por la Creación", "Santa Clara de Asís: Seguimiento Radical", "Santo Domingo de Guzmán: Predicador de la Verdad", "San Agustín de Hipona: La Conversión de un Intelectual", "Santa Mónica: La Oración Perseverante de una Madre", "San Ignacio de Loyola: Discernimiento y Servicio", "Santa Teresa de Jesús (de Ávila): Mística y Reforma", "San Juan de la Cruz: Noche Oscura del Alma", "Santa Teresa de Lisieux: El Caminito Espiritual", "San Juan Bosco: Padre y Maestro de la Juventud", "Santa Catalina de Siena: Doctora de la Iglesia", "San Benito de Nursia: Padre del Monacato Occidental", "San Antonio de Padua: El Santo de los Milagros", "San Judas Tadeo: Patrón de las Causas Difíciles", "Santa Rita de Casia: Abogada de los Imposibles", "San Maximiliano Kolbe: Mártir de la Caridad", "Santa Teresa de Calcuta: Amor a los Más Pobres", "Beato Carlo Acutis: Ciberapóstol de la Eucaristía", "Dorothy Day: Activista Católica por la Justicia Social", "Martin Luther King Jr.: Fe y Lucha por los Derechos Civiles", "Dietrich Bonhoeffer: Teólogo y Mártir contra el Nazismo", "Corrie ten Boom: Refugio y Perdón", "C.S. Lewis: De Ateo a Apologeta Cristiano", "Madre Angélica: Pionera de la Televisión Católica", "Óscar Romero: Voz de los sin Voz",
            // Conceptos y Virtudes de Fe
            "¿Qué es la Fe?", "La Esperanza Cristiana", "La Caridad (Amor Agape)", "La Oración: Diálogo con Dios", "El Perdón: Sanación y Liberación", "La Gracia Divina", "Los Sacramentos (Concepto General)", "El Bautismo: Nuevo Nacimiento", "La Eucaristía: Presencia Real", "La Confirmación: Fortaleza del Espíritu", "La Reconciliación (Confesión)", "La Unción de los Enfermos", "El Matrimonio como Vocación", "El Orden Sacerdotal", "La Misericordia Divina", "La Providencia Divina", "El Discernimiento Espiritual", "La Vocación: Llamado Personal de Dios", "La Santidad: Llamada Universal", "Las Virtudes Teologales: Fe, Esperanza, Caridad", "Las Virtudes Cardinales: Prudencia, Justicia, Fortaleza, Templanza", "Los Dones del Espíritu Santo", "Los Frutos del Espíritu Santo", "El Combate Espiritual", "La Duda en la Fe", "El Sufrimiento desde la Perspectiva de la Fe", "El Milagro: Intervención Divina", "La Vida Eterna: Esperanza Última", "La Comunión de los Santos", "El Papel de María en la Fe Cristiana", "La Lectio Divina: Oración con la Escritura", "El Ayuno y la Penitencia", "La Justicia Social y la Fe", "El Cuidado de la Creación (Laudato Si')", "El Diálogo Interreligioso", "La Nueva Evangelización", "La Familia como Iglesia Doméstica", "El Testimonio Cristiano en el Mundo", "La Confianza en Dios en Medio de la Adversidad", "La Gratitud como Actitud de Fe", "La Humildad: Fundamento de la Vida Espiritual", "La Alegría Cristiana",
            // Parábolas y Alegorías Adicionales
            "La Parábola de las Diez Vírgenes", "La Parábola del Fariseo y el Publicano", "La Parábola del Rico Insensato", "La Parábola del Trigo y la Cizaña", "La Parábola de la Red", "La Parábola del Tesoro Escondido", "La Parábola de la Perla de Gran Precio", "La Parábola del Siervo Despiadado", "La Parábola de los Obreros de la Viña", "La Parábola de los Dos Hijos", "La Parábola de los Labradores Malvados", "La Parábola del Banquete de Bodas", "Alegoría del Buen Pastor (Juan 10)", "Alegoría de la Vid Verdadera (Juan 15)",
             // Añadir más títulos específicos y conceptuales...
        ];
        const faithThemes = [
            "historias bíblicas Antiguo Testamento", "historias bíblicas Nuevo Testamento", "parábolas de Jesús", "vida de Jesús", "milagros de Jesús", "apóstoles de Jesús", "cartas de San Pablo", "vidas de santos", "figuras inspiradoras de fe", "mártires cristianos", "místicos cristianos", "testimonios de conversión", "virtudes teologales", "virtudes cardinales", "conceptos de fe cristiana", "oración y espiritualidad", "sacramentos", "figuras femeninas en la Biblia", "profetas bíblicos", "historia de la Iglesia", "doctrina social de la Iglesia", "fe y ciencia", "fe y sufrimiento", "esperanza cristiana", "amor al prójimo", "perdón cristiano", "misericordia divina", "adviento y navidad", "cuaresma y pascua", "pentecostés"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un narrador sereno y sabio, un guía espiritual con profundo conocimiento de historias y conceptos de fe (principalmente cristianos, pero con sensibilidad ecuménica). Narra la historia bíblica, la vida del santo/figura, o explica el concepto de fe indicado de manera clara, inspiradora y respetuosa. Enfócate en el mensaje central de fe, esperanza, amor, virtud o enseñanza espiritual. Usa un lenguaje accesible pero profundo. El objetivo es un relato o explicación conmovedora y edificante de aproximadamente 1200-1300 palabras. Basa tu narración únicamente en la siguiente historia, figura o concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
             systemPrompt: "Actúa como un compañero de reflexión amable y conocedor. Responde preguntas o comentarios sobre la historia de fe, la figura o el concepto que se acaba de presentar. Ofrece perspectivas adicionales, clarificaciones o anima a una reflexión más profunda, siempre manteniendo un tono respetuoso y edificante. Céntrate únicamente en el tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // *** Pide 40 títulos ***
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una colección de historias y conceptos de fe. Genera exactamente 40 títulos inspiradores de historias bíblicas, vidas de santos/figuras ejemplares, parábolas, virtudes o conceptos espirituales relevantes para la fe cristiana y la búsqueda de sentido. Devuelve *solo* la lista de títulos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo por si acaso para 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Contenedor de carga
        const modalLoadingText = document.getElementById('modal-loading-text'); // Texto de carga
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const loadingMinigameContainer = document.getElementById('loading-minigame');
        const minigameTarget = document.getElementById('minigame-target');
        const minigameScoreDisplay = document.getElementById('minigame-score');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Contexto del chat
        let loadingGameScore = 0;
        let isGameActive = false;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentStoryTitle
                ? `Actúa como un compañero de reflexión amable y conocedor sobre la historia o concepto de fe llamado '${currentStoryTitle}'. Responde preguntas de seguimiento sobre sus enseñanzas, personajes, o simbolismo. Ofrece perspectivas adicionales o anima a una reflexión más profunda, siempre manteniendo un tono respetuoso y edificante.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores parecen estar ocupados en este momento. Quizás intentar de nuevo en unos instantes?`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta llegó vacía. Podrías intentar reformular tu pregunta o reintentar.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó un poco más de lo esperado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde, por favor.`);
                }
                throw new Error(error.message || "Ha ocurrido un error inesperado al comunicarnos. Disculpa las molestias.");
            }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentStoryTitle) throw new Error("Error interno: No se ha establecido el contexto de la historia para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() { // *** Pide 40 ***
            const randomTheme = getRandomElement(faithThemes) || "historias de fe variadas";
            const specificPrompt = `Genera 40 títulos inspiradores sobre ${randomTheme}`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false) // Usa la config actualizada
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                      if (titles.length < 10) throw new Error("No se pudieron generar suficientes ideas de historias."); // Umbral más bajo por si acaso
                     return titles.slice(0, 40); // Asegura máximo 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "serene landscape with light rays";
             // Prompt ENFOCADO en simbología, luz, paz. NO texto, NO escenas complejas de personas.
             const enhancedPrompt = `Symbolic and serene artwork inspired by the theme '${safePromptText}'. Focus on light, hope, nature, stained glass effect, dove, heart, or abstract spiritual concepts. Soft colors, ethereal atmosphere. Avoid text, labels, complex scenes with multiple people, photorealism.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, map, flag, realistic people, faces, crowd, violence, darkness, scary, ugly, deformed, blurry, low quality, watermark, signature";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (same as before) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            stopLoadingGame(); // Asegura que el juego se detenga al cerrar
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             stopLoadingGame(); // Detener y resetear juego
             modalLoadingIndicator.classList.remove('active'); // Ocultar loading por defecto
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = true; // Deshabilitar hasta que cargue contenido
             currentStoryTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (same as before) ... */
             if (!imageFullscreenOverlay || !fullscreenImage) return;
             fullscreenImage.src = imgSrc;
             imageFullscreenOverlay.classList.add('active');
             document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() { /* ... (same as before) ... */
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios estructurales, solo prompts y textos)
        function addChatMessage(message, sender) { /* ... (same as before) ... */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... (same as before) ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... (same as before) ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== MINIGAME FUNCTIONS ==========
        function startLoadingGame() {
            if (!modalLoadingIndicator || !loadingMinigameContainer || !minigameTarget || !minigameScoreDisplay) return;
            loadingGameScore = 0;
            minigameScoreDisplay.textContent = loadingGameScore;
            modalLoadingIndicator.classList.add('active'); // Mostrar el contenedor de carga
            loadingMinigameContainer.style.display = 'flex'; // Mostrar el juego
            isGameActive = true;
            console.log("Loading game started");
        }
        function stopLoadingGame() {
            if (!modalLoadingIndicator || !loadingMinigameContainer) return;
            isGameActive = false;
            modalLoadingIndicator.classList.remove('active'); // Ocultar el contenedor de carga
            loadingMinigameContainer.style.display = 'none'; // Ocultar el juego
            console.log("Loading game stopped");
        }
        function handleMinigameClick() {
            if (!isGameActive || !minigameScoreDisplay) return;
            loadingGameScore++;
            minigameScoreDisplay.textContent = loadingGameScore;
            // Opcional: Añadir un pequeño efecto visual al hacer clic
            minigameTarget.style.transform = 'scale(1.2)';
            setTimeout(() => {
                if (minigameTarget) minigameTarget.style.transform = 'scale(1)';
            }, 100);
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">~ No hay historias disponibles en este momento ~</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to integrate minigame start/stop ***
        async function handleTitleClick(title) {
            resetModalState(); // Reset general state FIRST
            showModal(); // Show the modal frame
            startLoadingGame(); // START the loading game and show loading indicator

            modalTitle.textContent = title;
            currentStoryTitle = title;
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            chatSendBtn.disabled = true; // Disable chat initially

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // Content loaded successfully
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");
                chatSendBtn.disabled = false; // Enable chat NOW

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Preparando imagen...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación visual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo cargar la imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalErrorMessage.textContent = error.message || "Hubo un problema al cargar esta historia.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            } finally {
                stopLoadingGame(); // STOP the loading game in both success and error cases
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles to request 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más inspiración...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Function now fetches 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No pudimos encontrar más historias en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar más historias: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                  // Update button text to reflect 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Historias (40)';
             }
         }

         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameTarget /* Check game element */) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: brown; font-size: 1.5em; text-align: center; padding-top: 3em;">~ Ha ocurrido un error al iniciar la página. Por favor, recarga. ~</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // *** Minigame listener ***
            minigameTarget.addEventListener('click', handleMinigameClick);

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            stopLoadingGame(); // Ensure game is initially hidden
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>