<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Religi√≥n Mesopot√°mica: Sumeria y Babilonia</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes: Algo con aire antiguo pero legible (ej. Cormorant Garamond o Noto Serif) y sans-serif para cuerpo -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Mesopotamia --- */
        :root {
            --color-primary: #C19A6B; /* Arena / Arcilla Clara */
            --color-secondary: #003366; /* Azul Lapis Oscuro */
            --color-tertiary: #FFD700; /* Dorado */
            --color-accent: #8B4513; /* Marr√≥n Terracota */
            --color-background: #FDF5E6; /* Blanco Hueso / Lino */
            --color-text: #4A4A4A; /* Gris Oscuro C√°lido */
            --color-text-muted: #8D8D8D; /* Gris Medio */
            --color-modal-bg: #fffaf0; /* Floral White / Crema */
            --color-border: #D2B48C; /* Tan / Arena Oscura */
            --color-error-bg: #fff8f8; /* Rosa muy p√°lido */
            --color-error-text: #a0522d; /* Siena */
            --color-error-border: #f4a460; /* Sandy Brown */

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.12);
            --border-radius: 5px; /* Bordes suaves */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400;
               background-image: linear-gradient(rgba(253, 245, 230, 0.97), rgba(253, 245, 230, 0.97)),
                                 url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d2b48c' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); /* Patr√≥n sutil */
               background-attachment: fixed;
        }
        h1, h2, h3, h4, .logo { font-family: 'Noto Serif', serif; font-weight: 700; }
        .logo { color: var(--color-secondary); text-shadow: 1px 1px 2px rgba(193, 154, 107, 0.5); }
        .logo .sumerian { color: var(--color-primary); }
        .logo .babylonian { color: var(--color-accent); }
        h1.page-title { color: var(--color-accent); }
        h2.section-title { color: var(--color-secondary); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; }
        #modal-title { color: var(--color-secondary); }
        .navbar { background-color: rgba(255, 250, 240, 0.9); backdrop-filter: blur(4px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.2rem 0.8rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-secondary); box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.15); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); }
        #search-input:focus + .fa-search { color: var(--color-secondary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-secondary); border: 1px solid var(--color-border); border-left: 4px solid var(--color-primary); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Lato'; font-size: 0.98rem; }
        .title-item:hover { transform: translateY(-4px) translateX(3px); box-shadow: var(--shadow-lg); border-color: var(--color-secondary); border-left-color: var(--color-secondary); background-color: #fff; color: var(--color-accent); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-accent)); color: white; padding: 0.9rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Noto Serif', serif; font-size: 1.1rem; letter-spacing: 0.5px; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-accent), var(--color-primary)); box-shadow: var(--shadow-md); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(74, 74, 74, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 2px solid var(--color-accent);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 500px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-accent); border: 1px solid var(--color-background); border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-background); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); transform: rotate(-90deg) scale(1.1); box-shadow: 0 0 8px var(--color-secondary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        #modal-story-content-area { flex-grow: 1; min-height: 0; display: none; flex-direction: column; }
        #modal-story-content-area.visible { display: flex; }

        /* √Årea de Contenido (Texto + Imagen) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 9px; }
        #modal-content-area::-webkit-scrollbar-track { background: #f5f0e5; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid #f5f0e5; }

        #modal-content { padding: 0 5px; font-size: 1.08rem; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-accent); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 600; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Noto Serif', serif; margin-top: 2.4em; margin-bottom: 1.2em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 700; }
        #modal-content h1 { font-size: 1.6em; color: var(--color-accent); }
        #modal-content h2 { font-size: 1.45em; }
        #modal-content h3 { font-size: 1.3em; }
        #modal-content h4 { font-size: 1.15em; color: var(--color-text-muted); border-bottom: none; }
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 3rem auto 1rem auto; border: 2px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: 0 0 12px var(--color-primary); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 3rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid var(--color-border); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-primary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fdfdfa; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) #f5f0e5;
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: #f5f0e5; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.55; box-shadow: var(--shadow-sm); }
        .user-message { background-color: var(--color-primary); color: #333; margin-left: auto; text-align: left; font-weight: 600;}
        .ai-message { background-color: var(--color-secondary); color: white; margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 3px rgba(193, 154, 107, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-secondary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1rem; flex-shrink: 0; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-accent); transform: scale(1.05); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; transform: none; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Screen & Cuneiform Minigame */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, var(--color-background) 0%, var(--color-primary) 100%);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius);
            padding: 2rem; color: var(--color-accent); text-align: center;
        }
        #modal-loading.active { display: flex; }
        #cuneiform-display { /* Div para mostrar el s√≠mbolo/palabra */
            font-family: 'Noto Serif', serif; /* O una fuente cuneiforme si se importa */
            font-size: 3.5rem; /* Tama√±o grande para el s√≠mbolo/palabra */
            color: var(--color-secondary);
            margin-bottom: 1.5rem;
            min-height: 60px; /* Espacio para el s√≠mbolo */
            font-weight: bold;
            border: 2px dashed var(--color-border);
            padding: 1rem 2rem;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: var(--border-radius);
        }
        #typing-game-input { /* Input para escribir */
            font-family: 'Lato', sans-serif;
            font-size: 1.5rem;
            text-align: center;
            padding: 0.5rem 1rem;
            border: 2px solid var(--color-secondary);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            width: 80%;
            max-width: 300px;
            box-shadow: var(--shadow-sm);
            text-transform: uppercase; /* Forzar may√∫sculas si se usan letras */
        }
        #typing-game-input:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.2); }
        #loading-instructions { font-size: 1rem; margin-top: 0.5rem; font-family: 'Lato'; color: var(--color-text); }
        #loading-feedback { /* Para mensajes como '¬°Correcto!' o 'Intenta de nuevo' */
            min-height: 24px; font-size: 1.1rem; font-weight: bold; margin-top: 0.5rem; transition: color 0.3s ease;
        }
        .feedback-correct { color: var(--color-secondary); }
        .feedback-incorrect { color: var(--color-error-text); }
        #loading-score { font-size: 1.6rem; font-family: 'Noto Serif', serif; margin-top: 0.5rem; color: var(--color-accent); }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(40, 40, 40, 0.93); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: 0 0 25px var(--color-primary); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 42px; height: 42px; font-size: 1.9rem; color: var(--color-accent); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-ankh mr-2 text-yellow-500"></i> <!-- Ankh (egipcio pero vale) o buscar icono cuneiforme -->
                     <span class="sumerian">Sumeria</span> & <span class="babylonian">Babilonia</span>
                     <i class="fas fa-moon ml-2 text-blue-800"></i> <!-- Luna (Sin) o estrella (Ishtar) -->
                 </h1>
             </div>
             <span class="text-md text-gray-700 font-semibold font-sans tracking-wide">¬ª Religi√≥n y Mitos Antiguos ¬´</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Ecos de Mesopotamia</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora el pante√≥n, los mitos fundacionales y las pr√°cticas religiosas de las primeras civilizaciones. Selecciona un tema o busca por dios, mito o concepto.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar (Ej: Enlil, Gilgamesh, Ziggurat, Enuma Elish...)">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-dead text-yellow-600 mr-2"></i> <!-- Libro antiguo/tablilla -->
                 Temas y Deidades
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando las tablillas antiguas...</p>
                  <!-- Los .title-item se a√±adir√°n aqu√≠ -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">¬ª No se encontraron registros cuneiformes para tu consulta ¬´</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir 40 Nuevos Registros
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Cuneiform Minigame -->
             <div id="modal-loading">
                 <div id="cuneiform-display">íÄ≠</div> <!-- Placeholder inicial o primer s√≠mbolo -->
                 <input type="text" id="typing-game-input" placeholder="Escribe aqu√≠..." autocomplete="off" spellcheck="false">
                 <p id="loading-instructions">¬°Descifra el s√≠mbolo! Escribe la letra/palabra clave (pista: A=Anu, E=Enlil, K=Enki...).</p>
                 <div id="loading-feedback"></div>
                 <p id="loading-score">Aciertos: 0 | Nivel: 1</p>
             </div>

             <!-- Content Area Wrapper (Initially Hidden) -->
             <div id="modal-story-content-area">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando or√°culos...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta m√°s sobre este tema...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-yellow-50 text-gray-600 py-6 mt-12 border-t border-yellow-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Informaci√≥n generada por IA con fines educativos y de referencia sobre la religi√≥n mesopot√°mica.</p>
              <p class="mt-1">Consulta fuentes acad√©micas para estudios detallados. Basado en interpretaciones hist√≥ricas.</p>
              <p class="mt-2">¬© 2025 Cr√≥nicas de Sumeria y Babilonia</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Dioses y Diosas Principales (Sumerios/Acadios/Babil√≥nicos)
            "An/Anu: El dios del cielo y padre de los dioses", "Enlil: Dios del aire, el viento y las tormentas", "Enki/Ea: Dios de la sabidur√≠a, el agua dulce y la magia", "Inanna/Ishtar: Diosa del amor, la fertilidad y la guerra", "Utu/Shamash: Dios del sol y la justicia", "Nanna/Sin: Dios de la luna", "Ninlil: Esposa de Enlil, diosa del aire", "Ninhursag/Ki: Diosa madre de la tierra", "Ereshkigal: Reina del Inframundo (Kur)", "Nergal: Dios de la plaga, la guerra y consorte de Ereshkigal", "Marduk: Dios patr√≥n de Babilonia, h√©roe del Enuma Elish", "Tiamat: Diosa primordial del agua salada, antagonista del Enuma Elish", "Apsu: Dios primordial del agua dulce", "Nabu: Dios de la escritura y la sabidur√≠a, hijo de Marduk", "Gula: Diosa de la sanaci√≥n", "Ishkur/Adad: Dios de la tormenta y la lluvia", "Nisaba: Diosa de la escritura y los cereales", "Dumuzi/Tammuz: Dios pastoril, consorte de Inanna", "Ninurta: Dios de la guerra y la agricultura", "Pazuzu: Rey de los demonios del viento (protector y mal√©volo)", "Lamashtu: Demonia que atacaba a ni√±os y embarazadas",

            // Mitos y √âpicas Fundamentales
            "El Enuma Elish: El Mito Babil√≥nico de la Creaci√≥n", "La Epopeya de Gilgamesh: B√∫squeda de la inmortalidad", "El Descenso de Inanna al Inframundo", "Mito de Atrahasis: La Creaci√≥n del Hombre y el Diluvio", "Mito de Adapa: La oportunidad perdida de la inmortalidad", "Mito de Etana: El rey que vol√≥ al cielo en un √°guila", "Inanna y Enki: La transferencia de los 'Me'", "El Poema del Justo Sufriente (Ludlul bel nemeqi)", "La Creaci√≥n de la Piqueta (Mito sumerio)", "Enmerkar y el Se√±or de Aratta", "Lugalbanda en la Cueva de la Monta√±a",

            // Conceptos Religiosos y Cosmovisi√≥n
            "Polite√≠smo Mesopot√°mico: Caracter√≠sticas Generales", "Cosmogon√≠a: El origen del universo seg√∫n sumerios y babilonios", "Teogon√≠a: El nacimiento y genealog√≠a de los dioses", "El 'Me': Los decretos divinos que ordenan el cosmos", "El Destino (Namtar) y la Voluntad Divina", "El Inframundo (Kur/Irkalla): Morada de los muertos", "Los Zigurats: Templos escalonados y su funci√≥n", "El Templo como centro econ√≥mico y social", "El Sacerdocio: Roles y jerarqu√≠as (En, Sangha, Gala)", "La Adivinaci√≥n: Interpretaci√≥n de presagios (h√≠gado, aceite, astros)", "La Astrolog√≠a Babil√≥nica: Or√≠genes y desarrollo", "La Magia y los Rituales: Protecci√≥n y exorcismo (Asipu, Asu)", "Los Demonios y Esp√≠ritus: Creencias populares", "El Diluvio Universal en la tradici√≥n mesopot√°mica", "La Relaci√≥n entre Humanos y Dioses: Oraci√≥n, sacrificio, servicio", "El Pecado y la Transgresi√≥n en Mesopotamia", "El Rey como intermediario divino (Ensi, Lugal)", "Concepto de Creaci√≥n del Hombre: Servidores de los dioses", "La Vida despu√©s de la Muerte: Perspectivas sumerias y babil√≥nicas",

            // Pr√°cticas y Lugares Sagrados
            "Rituales de A√±o Nuevo (Akitu) en Babilonia", "Culto a las Estatuas Divinas: Cuidados y procesiones", "Sacrificios de Animales y Ofrendas de Alimentos", "Oraciones e Himnos a los Dioses", "Festivales Religiosos y Celebraciones C√≠clicas", "Templos Importantes: Eanna (Uruk), Esagila (Babilonia), Ekur (Nippur)", "Ciudades Sagradas: Nippur, Eridu, Ur", "Pr√°cticas Funerarias y Entierros", "Amuletos y Objetos Protectores", "Uso de Sellos Cil√≠ndricos en contextos religiosos", "La Escritura Cuneiforme y su rol en la religi√≥n (mitos, himnos, presagios)", "Las Leyes (C√≥digo de Hammurabi) y su conexi√≥n divina",

            // Interacciones y Sincretismo
            "Relaci√≥n entre la Religi√≥n Sumeria y Acadia", "La Ascensi√≥n de Marduk en el Pante√≥n Babil√≥nico", "Influencia Mesopot√°mica en Religiones Posteriores (Hebrea, Griega)", "Sincretismo Religioso durante el Imperio Neo-Asirio", "Cultos a Dioses Extranjeros en Mesopotamia", "La figura del H√©roe Semidivino (Gilgamesh)", "Representaciones Art√≠sticas de Dioses y Mitos", "El Papel de la M√∫sica y la Danza en el Culto",
            // A√±adir m√°s temas espec√≠ficos o comparativos si es necesario
        ];
        const mesopotamianThemes = [ // Para generar m√°s t√≠tulos
            "dioses sumerios", "diosas sumerias", "pante√≥n babil√≥nico", "mitolog√≠a mesopot√°mica", "Enuma Elish", "Epopeya de Gilgamesh", "creaci√≥n del hombre mesopotamia", "diluvio mesopot√°mico", "zigurats", "templos mesopot√°micos", "sacerdocio sumerio", "adivinaci√≥n babil√≥nica", "astrolog√≠a mesopot√°mica", "magia en mesopotamia", "demonios sumerios", "inframundo mesopot√°mico (Kur)", "Inanna/Ishtar", "Enki/Ea", "Enlil", "Marduk", "Tiamat", "Anu", "Utu/Shamash", "Nanna/Sin", "Ereshkigal", "C√≥digo de Hammurabi y religi√≥n", "escritura cuneiforme y mitos", "rituales mesopot√°micos", "Akitu festival", "Ur", "Uruk", "Babilonia", "Nippur", "vida despu√©s de la muerte mesopotamia", "concepto de 'Me'", "relaci√≥n humanos-dioses mesopotamia"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un historiador y acad√©mico especializado en las religiones y mitolog√≠as del antiguo Cercano Oriente, con un enfoque particular en Sumeria y Babilonia. Tu tarea es proporcionar una explicaci√≥n detallada, precisa y acad√©micamente informada sobre el dios, mito, concepto o pr√°ctica religiosa mesopot√°mica indicada. Basa tu respuesta en fuentes hist√≥ricas y arqueol√≥gicas reconocidas. Describe or√≠genes, caracter√≠sticas principales, roles, mitos asociados, importancia cultural y religiosa, y posibles evoluciones o sincretismos. Utiliza un lenguaje claro y formal, adecuado para un p√∫blico interesado pero no necesariamente experto. El objetivo es un texto expositivo de aproximadamente 1200-1300 palabras basado *√∫nicamente* en el siguiente tema:",
            timeoutSeconds: 180
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Act√∫a como un asistente de investigaci√≥n sobre religi√≥n mesopot√°mica, enfocado *exclusivamente* en el tema que se est√° mostrando actualmente. Responde preguntas de seguimiento sobre detalles espec√≠ficos, conexiones con otros mitos o figuras, interpretaciones acad√©micas, o aspectos culturales mencionados en el texto principal. S√© conciso y mantente estrictamente dentro del tema en cuesti√≥n.",
            timeoutSeconds: 50
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de temas para una enciclopedia sobre religi√≥n mesopot√°mica (Sumeria y Babilonia). Genera exactamente 40 t√≠tulos espec√≠ficos y relevantes sobre dioses, diosas, mitos, conceptos, lugares o pr√°cticas religiosas de esta civilizaci√≥n. Devuelve *solo* la lista de t√≠tulos, uno por l√≠nea, sin n√∫meros, guiones, introducciones ni conclusiones.",
            timeoutSeconds: 60
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, pero a√±adiendo elementos del juego de tipeo)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Contenedor del juego/spinner
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Cuneiform Typing Game Elements
        const cuneiformDisplay = document.getElementById('cuneiform-display');
        const typingGameInput = document.getElementById('typing-game-input');
        const loadingInstructions = document.getElementById('loading-instructions');
        const loadingFeedback = document.getElementById('loading-feedback');
        const loadingScoreDisplay = document.getElementById('loading-score');

        // ========== State Variables ==========
        let currentTopicTitle = null;
        let typingGameTimeoutId = null; // Para controlar el tiempo por s√≠mbolo
        let isTypingGameRunning = false;

        // ========== TYPING MINIGAME VARIABLES & LOGIC ==========
        const cuneiformDictionary = { // S√≠mbolo/Nombre Simplificado -> Respuesta Esperada (Letras/Palabra corta)
            // Dioses principales (simplificado)
            "íÄ≠ AN": "ANU",   // Dingir (Dios) + AN
            "íÇóíÜ§ ENLIL": "ENLIL",
            "íÇóíÜ† ENKI": "ENKI", // O "EA"
            "íÄ≠íàπ INANNA": "INANNA", // O "ISHTAR"
            "íÄ≠íåì UTU": "UTU",    // O "SHAMASH"
            "íÄ≠íãÄíÜ† NANNA": "NANNA", // O "SIN"
            "íÄ≠íÄ´íåì MARDUK": "MARDUK",
            "íÄ≠íä©íåÜ<y_bin_861> ERESHKIGAL": "ERESHKIGAL",
             // Conceptos/Lugares
             "íÇç E": "TEMPLO", // Casa/Templo
             "íÜ≥ KUR": "KUR", // Monta√±a/Inframundo
             " –∑–≤–µ–∑–¥–∞ DINGIR": "DIOS", // Estrella -> Dios
             " KING LUGAL": "REY",
             " CITY URU": "CIUDAD",
             " TABLET DUB": "TABLETA",
             " WATER A": "AGUA",
             " SKY AN": "CIELO",
             " EARTH KI": "TIERRA",
             " SUN UTU": "SOL",
             " MOON SIN": "LUNA",
             " HAND ≈†U": "MANO",
             " FOOT G√åR": "PIE",
             " MOUTH KA": "BOCA",
             " HEART ≈†√Ä": "CORAZON", // (Sha)
             " LIFE TI": "VIDA",
        };
        const cuneiformKeys = Object.keys(cuneiformDictionary);

        let typingGameScore = 0;
        let typingGameLevel = 1;
        let currentCuneiformKey = '';
        let expectedAnswer = '';
        let timePerSymbol = 6000; // ms iniciales (6 segundos)
        const minTimePerSymbol = 2500; // ms m√≠nimos (2.5 segundos)
        const timeReductionPerLevel = 300; // ms
        const scoreToLevelUp = 5; // Aciertos para subir nivel

        function resetTypingGame() {
            typingGameScore = 0;
            typingGameLevel = 1;
            timePerSymbol = 6000;
            currentCuneiformKey = '';
            expectedAnswer = '';
            clearTimeout(typingGameTimeoutId);
            typingGameInput.value = '';
            loadingFeedback.textContent = '';
            loadingFeedback.className = 'feedback-neutral'; // Clase neutra
            loadingScoreDisplay.textContent = `Aciertos: 0 | Nivel: 1`;
            console.log("Typing Game Reset");
        }

        function getRandomCuneiform() {
            const randomIndex = Math.floor(Math.random() * cuneiformKeys.length);
            currentCuneiformKey = cuneiformKeys[randomIndex];
            expectedAnswer = cuneiformDictionary[currentCuneiformKey];
        }

        function displayCuneiform() {
            if (!isTypingGameRunning) return;
            getRandomCuneiform();
            // Mostrar el s√≠mbolo/nombre en el div
            cuneiformDisplay.textContent = currentCuneiformKey.split(' ')[0]; // Mostrar solo la parte del s√≠mbolo/glifo
            // Actualizar pista (opcionalmente)
            loadingInstructions.textContent = `Descifra: ${currentCuneiformKey.split(' ')[0]} (Pista: ${expectedAnswer[0]}...)`; // Pista con primera letra
            typingGameInput.value = ''; // Limpiar input
            typingGameInput.focus(); // Poner foco en input
            loadingFeedback.textContent = ''; // Limpiar feedback anterior

            // Iniciar temporizador para el siguiente s√≠mbolo
            clearTimeout(typingGameTimeoutId);
            typingGameTimeoutId = setTimeout(() => {
                if (isTypingGameRunning) {
                    // Tiempo agotado, mostrar feedback negativo y pasar al siguiente
                    loadingFeedback.textContent = '¬°Tiempo!';
                    loadingFeedback.className = 'feedback-incorrect';
                    setTimeout(displayCuneiform, 1000); // Esperar 1s antes del siguiente
                }
            }, timePerSymbol);
        }

        function checkPlayerInput() {
            if (!isTypingGameRunning || !expectedAnswer) return;

            const playerAnswer = typingGameInput.value.trim().toUpperCase();

            if (playerAnswer === expectedAnswer) {
                // Respuesta correcta
                typingGameScore++;
                loadingFeedback.textContent = '¬°Correcto!';
                loadingFeedback.className = 'feedback-correct';
                clearTimeout(typingGameTimeoutId); // Detener temporizador actual

                // Subir de nivel si es necesario
                if (typingGameScore % scoreToLevelUp === 0) {
                    typingGameLevel++;
                    timePerSymbol = Math.max(minTimePerSymbol, timePerSymbol - timeReductionPerLevel);
                    console.log(`Level Up! Level: ${typingGameLevel}, Time: ${timePerSymbol}ms`);
                     // Efecto visual de nivel
                     cuneiformDisplay.style.transition = 'transform 0.2s ease';
                     cuneiformDisplay.style.transform = 'scale(1.1)';
                     setTimeout(() => { cuneiformDisplay.style.transform = 'scale(1)'; }, 200);
                }
                loadingScoreDisplay.textContent = `Aciertos: ${typingGameScore} | Nivel: ${typingGameLevel}`;
                // Pasar al siguiente s√≠mbolo despu√©s de un breve retraso
                setTimeout(displayCuneiform, 500);
            } else {
                // Respuesta incorrecta (no penalizar, solo feedback y esperar)
                loadingFeedback.textContent = 'Intenta de nuevo...';
                loadingFeedback.className = 'feedback-incorrect';
                // No pasar al siguiente, permitir reintentar hasta que acabe el tiempo
                 // Opcional: hacer vibrar el input
                 typingGameInput.style.transition = 'transform 0.1s ease';
                 typingGameInput.style.transform = 'translateX(-5px)';
                 setTimeout(() => { typingGameInput.style.transform = 'translateX(5px)'; }, 100);
                 setTimeout(() => { typingGameInput.style.transform = 'translateX(0px)'; }, 200);
            }
        }

        function startGameLoop_Typing() {
            if (isTypingGameRunning) return;
            console.log("Starting Typing Game Loop");
            isTypingGameRunning = true;
            resetTypingGame();
            modalLoadingIndicator.classList.add('active'); // Mostrar pantalla de carga
            typingGameInput.disabled = false; // Habilitar input
            typingGameInput.addEventListener('keypress', handleTypingInputKeypress); // Listener para Enter
            displayCuneiform(); // Mostrar el primer s√≠mbolo e iniciar ciclo
        }

        function stopGameLoop_Typing() {
            if (!isTypingGameRunning) return;
            console.log("Stopping Typing Game Loop");
            isTypingGameRunning = false;
            clearTimeout(typingGameTimeoutId); // Detener cualquier temporizador pendiente
            typingGameInput.disabled = true; // Deshabilitar input
            typingGameInput.removeEventListener('keypress', handleTypingInputKeypress);
            // El modalLoadingIndicator se oculta al mostrar contenido/error
        }

        function handleTypingInputKeypress(event) {
             if (event.key === 'Enter') {
                 event.preventDefault(); // Evitar env√≠o de formulario (si hubiera)
                 checkPlayerInput();
             }
         }


        // ========== API FUNCTIONS ========== (Adaptadas para 40 t√≠tulos)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Eres un asistente de investigaci√≥n sobre religi√≥n mesopot√°mica, enfocado exclusivamente en el tema '${currentTopicTitle}'. Responde preguntas de seguimiento sobre detalles espec√≠ficos o conexiones relacionadas *√∫nicamente con ese tema*.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores est√°n experimentando mucho tr√°fico. Por favor, intenta de nuevo en unos segundos.`);
                 const text = await response.text();
                 if (!text || text.trim().length < (isChat ? 10 : 600)) throw new Error("La respuesta de la IA fue demasiado corta o vac√≠a. Intenta de nuevo o con otro tema.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId); console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexi√≥n tard√≥ demasiado (>${config.timeoutSeconds}s). Revisa tu conexi√≥n o int√©ntalo m√°s tarde.`);
                 throw new Error(error.message || "Ocurri√≥ un error inesperado al contactar la IA.");
             }
         }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Error interno: No se ha establecido el contexto del tema para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(mesopotamianThemes) || "mitolog√≠a mesopot√°mica";
             const specificPrompt = `Genera 40 t√≠tulos/temas espec√≠ficos sobre religi√≥n mesopot√°mica (Sumeria/Babilonia), relacionados con ${randomTheme}`;
             console.log("Generating 40 titles with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                  .then(text => {
                      const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150 && !line.toLowerCase().includes("aqu√≠ tienes") && !line.toLowerCase().includes("lista de temas")).slice(0, 40);
                      if (titles.length < 15) { console.warn("Generated fewer titles than expected:", titles.length); throw new Error("La IA no gener√≥ suficientes temas v√°lidos."); }
                      return titles;
                  });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 896, height: 640, nologo: true }; // Aspecto m√°s cuadrado
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Ancient mesopotamian art";
            const enhancedPrompt = `Stylized illustration inspired by Ancient Mesopotamian art (Sumerian, Babylonian), depicting '${safePromptText}'. Relief style, cuneiform elements, earthy tones, lapis lazuli blue, gold details. Conceptual, atmospheric.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, title, caption, photograph, realistic human face, modern elements, blurry, low quality, watermark, signature, multiple images";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
         }

        // ========== Text Formatting Function ========== (Sin cambios)
        function formatExplanationText(rawText){if(!rawText)return'';let formatted=rawText.trim();formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1');formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');formatted=formatted.replace(/(\w)\^\{?([\d+\-‚àí]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('‚àí','-');return`${base}<sup>${cleanExponent}</sup>`;});formatted=formatted.replace(/\\rightarrow/g,'&rarr;');formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>');const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0);formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block;let content=block.replace(/\n/g,' ');return`<p>${content}</p>`;}).join('');return formatted;}

        // ========== MODAL FUNCTIONS ========== (Integrando inicio/parada del juego de tipeo)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            stopGameLoop_Typing(); // Detener juego de tipeo
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             stopGameLoop_Typing(); // Asegurar parada del juego
             modalLoadingIndicator.classList.remove('active');
             modalStoryContentArea.classList.remove('visible');
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
             // Resetear elementos espec√≠ficos del juego de tipeo
             cuneiformDisplay.textContent = 'íÄ≠'; // S√≠mbolo inicial
             typingGameInput.value = '';
             loadingFeedback.textContent = '';
             loadingScoreDisplay.textContent = `Aciertos: 0 | Nivel: 1`;
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios)
        function showFullscreenImage(imgSrc){if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden';}
        function hideFullscreenImage(){if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src='';}

        // ========== CHAT FUNCTIONS ========== (Sin cambios funcionales)
        function addChatMessage(message, sender){const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        function addChatError(message){const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        async function handleSendMessage(){const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Error IA: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}}

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title) { const div=document.createElement('div');div.className='title-item';div.textContent=title;div.setAttribute('data-title',title);div.addEventListener('click',()=>handleTitleClick(title));return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">¬ª Las tablillas est√°n en blanco. Intenta generar nuevos registros. ¬´</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
             console.log(`Displayed ${sortedTitles.length} titles.`);
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             console.log(`Appending ${newTitles.length} new titles.`);
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Successfully added ${addedCount} unique titles.`);
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to manage typing game start/stop ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title;
            chatHistory.innerHTML = '';

            // *** START LOADING & TYPING GAME ***
            modalLoadingIndicator.classList.add('active');
            startGameLoop_Typing();

            try {
                const explanationPromise = fetchExplanationText(title);
                const imageUrl = createPollinationsImageUrl(title);
                const rawExplanationText = await explanationPromise;

                // *** STOP GAME & SHOW CONTENT ***
                stopGameLoop_Typing();
                modalLoadingIndicator.classList.remove('active');
                modalStoryContentArea.classList.add('visible');
                modalStoryContentArea.classList.remove('content-hidden');

                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalContent.innerHTML = formattedExplanation;
                modalTextArea.scrollTop = 0;

                // Image Handling
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-landmark placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Recuperando artefacto visual...</p>`;
                modalContent.appendChild(placeholderDiv);

                if (imageUrl) {
                    const imgElement = document.createElement('img');
                    imgElement.className = 'final-image';
                    imgElement.alt = `Representaci√≥n de ${title}`;
                    imgElement.style.display = 'none';
                    imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                    imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al cargar imagen.</p>`; };
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                    placeholderDiv.innerHTML = `<i class="fas fa-ban placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo generar URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                // *** STOP GAME & SHOW ERROR ***
                stopGameLoop_Typing();
                modalLoadingIndicator.classList.remove('active');
                modalStoryContentArea.classList.add('visible');
                modalStoryContentArea.classList.remove('content-hidden');

                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el tema.";
                modalError.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Excavando registros...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Pide 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron descubrir m√°s registros en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar registros: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir 40 Nuevos Registros';
             }
         }

         // Search Filter Function (con normalizaci√≥n)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check essential elements, including typing game elements
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !cuneiformDisplay || !typingGameInput || !loadingScoreDisplay) {
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">ERROR EN LA TABLILLA MAESTRA: Faltan componentes de la interfaz.</p>';
                 return;
             }
             // Modal listeners
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

             // Title generation listener
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

             // Search listener
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

             // Chat listeners
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

             // Fullscreen image listeners
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Typing game listener is added/removed in startGameLoop/stopGameLoop

             // Initial display
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
         }
         document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>