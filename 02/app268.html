<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecos del Chamanismo Siberiano - Guía Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes evocadoras pero legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Chamanismo Siberiano --- */
        :root {
            --color-primary: #8B4513; /* Marrón Madera/Tierra (SaddleBrown) */
            --color-secondary: #2E8B57; /* Verde Bosque (SeaGreen) */
            --color-tertiary: #ADD8E6; /* Azul Hielo Claro (LightBlue - para espíritus/nieve) */
            --color-accent: #FFD700; /* Dorado Suave (Gold - para énfasis místico) */
            --color-background: #F5F5DC; /* Beige Claro (Beige - fondo tipo pergamino) */
            --color-background-dark: #2F4F4F; /* Gris Pizarra Oscuro (DarkSlateGray - para elementos oscuros/noche) */
            --color-text: #36454F; /* Gris Oscuro Casi Negro (Charcoal) */
            --color-text-muted: #696969; /* Gris Medio (DimGray) */
            --color-modal-bg: #FFF8DC; /* Blanco Maíz (Cornsilk - fondo modal más cálido) */
            --color-border: #A0522D; /* Marrón Siena (Sienna - borde) */
            --color-error-bg: #fde8e8; /* Fondo error rosa muy claro */
            --color-error-text: #912c2c; /* Texto error rojo oscuro */
            --color-error-border: #e18c8c; /* Borde error rosa */

            --shadow-sm: 0 2px 4px rgba(47, 79, 79, 0.1);
            --shadow-md: 0 5px 10px rgba(47, 79, 79, 0.15);
            --shadow-lg: 0 10px 20px rgba(47, 79, 79, 0.2), 0 3px 6px rgba(47, 79, 79, 0.1);
            --border-radius: 5px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Open Sans', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d2b48c' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); /* Textura sutil */ }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700;}
        #modal-title { color: var(--color-secondary); font-weight: 700; }
        .navbar { background-color: rgba(245, 245, 220, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Buscador */
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(255, 248, 220, 0.9); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Open Sans'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-secondary); box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.2); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-secondary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Open Sans'; font-size: 0.95rem; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-secondary); background-color: #f0fff0; /* Verde muy pálido hover */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-background); padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 1.8rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #a0522d; /* Sienna */ box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: var(--color-text-muted); color: #ccc; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(47, 79, 79, 0.9); /* Overlay pizarra oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 2px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px; width: 95%; max-height: 90vh; min-height: 400px;
            overflow: hidden; position: relative; box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-background); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); transform: rotate(90deg); box-shadow: 0 0 8px var(--color-secondary); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área Contenido Principal (Texto + Imagen + Chat) */
        #modal-story-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; /* El scroll está en el área de texto */ }

        /* Área de Texto + Imagen (Scrollable) */
        #modal-content-area { flex-grow: 1; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-modal-bg);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(210, 180, 140, 0.3); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }
        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700;}
        #modal-content h1 { font-size: 1.4em; } #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(160, 82, 45, 0.2); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary); } /* Icono temático */

        /* Chat Section */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: auto; /* Empuja al fondo */ flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; background-color: rgba(245, 245, 220, 0.5); /* Fondo sutil beige */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(255, 255, 255, 0.6); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(210, 180, 140, 0.3);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(210, 180, 140, 0.3); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95em; }
        .user-message { background-color: var(--color-secondary); color: #fff; margin-left: auto; text-align: right; }
        .ai-message { background-color: #eaddcc; color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Open Sans'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-secondary); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* --- Loading Modal con Minijuego --- */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(47, 79, 79, 0.98); /* Fondo oscuro para el juego */
            display: none; /* Se muestra vía JS */
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius); padding: 2rem;
            color: var(--color-tertiary); /* Texto claro */
        }
        #modal-loading.active { display: flex; } /* Clase para mostrarlo */
        #loading-message { font-family: 'Merriweather', serif; font-size: 1.4rem; margin-bottom: 1.5rem; text-shadow: 0 0 5px var(--color-tertiary); }
        #minigame-canvas {
            width: 90%; height: 60%; /* Ajusta según sea necesario */
            max-width: 600px; max-height: 400px;
            background-color: rgba(0, 0, 0, 0.3); /* Fondo semitransparente para el juego */
            border: 1px solid var(--color-tertiary);
            border-radius: var(--border-radius);
            position: relative; /* Para posicionar los espíritus */
            overflow: hidden; /* Evita que los espíritus se salgan */
            cursor: crosshair; /* Cursor para el juego */
            margin-bottom: 1rem;
        }
        .spirit {
            position: absolute;
            width: 30px; height: 30px;
            border-radius: 50%;
            cursor: pointer;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease;
            opacity: 0; /* Empiezan invisibles */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        .spirit.good {
            background-color: rgba(173, 216, 230, 0.7); /* Azul claro */
            box-shadow: 0 0 15px 5px rgba(173, 216, 230, 0.5);
             /* Podrías usar SVGs o iconos aquí */
             /* background-image: url('path/to/good-spirit.svg'); */
        }
        .spirit.bad {
            background-color: rgba(105, 105, 105, 0.7); /* Gris oscuro */
            box-shadow: 0 0 15px 5px rgba(50, 50, 50, 0.5);
            width: 25px; height: 25px; /* Ligeramente más pequeños */
            border-radius: 3px; /* Forma diferente */
             /* background-image: url('path/to/bad-spirit.svg'); */
        }
        .spirit.visible { opacity: 1; transform: scale(1); }
        .spirit.clicked { transform: scale(1.5); opacity: 0; } /* Efecto al hacer clic */
        .spirit.missed { /* Podría tener un efecto diferente si se evita */ }

        #minigame-info { display: flex; justify-content: space-between; width: 90%; max-width: 600px; font-size: 1.1rem; font-family: 'Open Sans'; font-weight: 600;}
        #minigame-score { color: var(--color-accent); }
        #minigame-level { color: var(--color-tertiary); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Open Sans'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(47, 79, 79, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-border); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-feather-alt mr-3 text-green-700"></i> <!-- Icono Pluma/Tambor -->
                     Ecos del Chamanismo Siberiano
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Guía Interactiva de Sabiduría Ancestral «</span>
         </div>
     </nav>

     <!-- Main -->
     <main class="container mx-auto px-4 pb-16">
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora los Mundos Espirituales</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Sumérgete en las prácticas, creencias y cosmología del chamanismo tradicional de Siberia. Selecciona un concepto o busca un tema.</p>
         </section>

         <!-- Search -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar concepto, espíritu, ritual...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Titles -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-dead text-brown-700 mr-2"></i> <!-- Icono Libro Antiguo -->
                 Compendio Chamánico
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los anales ancestrales...</p>
                  <!-- .title-item -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún eco responde a tu llamada «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Buscar Más Sabiduría (40)
                  </button>
             </div>
         </section>
     </main>

     <!-- Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- *** Loading Indicator con Minijuego *** -->
             <div id="modal-loading">
                 <p id="loading-message">Consultando a los espíritus...</p>
                 <div id="minigame-canvas">
                     <!-- Los espíritus aparecerán aquí -->
                 </div>
                 <div id="minigame-info">
                     <span id="minigame-level">Nivel: 1</span>
                     <span id="minigame-score">Puntos: 0</span>
                 </div>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Texto e Imagen -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Escuchando el eco...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este concepto...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos y de referencia sobre el Chamanismo Siberiano.</p>
              <p class="mt-1">Las prácticas y creencias pueden variar enormemente. Consulta fuentes académicas para estudios profundos.</p>
              <p class="mt-2">© 2025 Ecos Ancestrales</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Conceptos Fundamentales
            "Cosmología Chamánica Siberiana", "El Árbol del Mundo (Axis Mundi)", "Los Tres Mundos (Superior, Medio, Inferior)", "El Viaje Chamánico (Éxtasis)", "Animismo en Siberia", "El concepto de 'Alma' (múltiples almas)", "Espíritus Ancestrales", "Espíritus de la Naturaleza (Dueños del Lugar)", "Animales de Poder (Guías Espirituales)", "Tótem y Clan", "El Rol del Chamán en la Comunidad", "Iniciación Chamánica (Llamada, Enfermedad Iniciática)", "Linajes Chamánicos", "Chamanismo Hereditario vs. por Vocación", "Poder Chamánico ('kūt', 'süŋ')", "Tabúes y Reglas Chamánicas", "Sueños y Visiones en el Chamanismo",
            // Tipos de Chamanes y Roles
            "Chamán Blanco (Al Mundo Superior)", "Chamán Negro (Al Mundo Inferior)", "Chamán Gris (Ambos Mundos)", "Chamán Sanador", "Chamán Adivino", "Chamán Psicopompo (Guía de Almas)", "Chamán Guerrero Espiritual", "Chamán Poeta/Cantor", "Diferencias entre Chamanes Hombres y Mujeres", "El 'Chamán Débil' y el 'Chamán Fuerte'", "Chamanes especialistas (del clima, de la caza)", "El 'Udagan' (Chamana femenina en algunas culturas)", "El 'Böö' (Chamán Buryat)", "El 'Oyuun' (Chamán Sakha/Yakut)", "El 'Samaan' (Chamán Evenk)",
            // Prácticas y Rituales
            "Ritual de Sanación Chamánica", "Recuperación del Alma Perdida", "Extracción de Intrusiones Espirituales", "Adivinación Chamánica (Escapulomancia, etc.)", "Ritual de Comunicación con Espíritus", "Ceremonias de Protección (Comunidad, Individuo)", "Rituales de Caza y Pesca", "Rituales Funerarios Chamánicos", "Acompañamiento del Alma al Otro Mundo", "Rituales de Purificación", "Ceremonias de Ofrenda a los Espíritus", "El Canto Chamánico ('Algysh', 'Dyyryn')", "La Danza Chamánica", "Uso del Tambor Chamánico", "El Trance Inducido por Tambor", "Uso de Sonajas y Campanas", "Plantas Sagradas en el Chamanismo Siberiano (limitado, ej. Amanita)", "Sacrificios Animales (Contexto Histórico)", "Creación de Amuletos y Objetos de Poder", "Rituales Estacionales (Solsticios, Equinoccios)",
            // Herramientas y Parafernalia
            "El Tambor Chamánico (Construcción, Simbolismo)", "Tipos de Tambores (Buryat, Yakut, Evenk)", "La Baqueta del Tambor", "El Traje Chamánico (Significado, Componentes)", "La Máscara Chamánica", "El Tocado o Corona Chamánica", "Espejos Chamánicos ('Toli', 'Küzüngü')", "Bastones Chamánicos", "Amuletos Protectores ('Ongon')", "Representaciones de Espíritus Ayudantes", "Figuras Antropomorfas y Zoomorfas", "Uso de Metales y Piedras", "Cintas y Colgantes del Traje", "Simbolismo de los Colores", "El 'Árbol' o Poste Ritual",
            // Espíritus y Entidades
            "Espíritus Ayudantes del Chamán", "Espíritus Ancestrales Protectores", "Espíritus Dueños de Lugares (Montañas, Ríos, Bosques)", "Espíritus Animales Guía (Oso, Lobo, Ciervo, Águila...)", "Espíritus del Mundo Superior (Deidades Celestes)", "Espíritus del Mundo Inferior (Entidades Subterráneas)", "Espíritus Malignos o Causantes de Enfermedad", "El 'Onon' (espíritu del fuego)", "Ülgen (Deidad creadora altaica/turca)", "Erlik Khan (Señor del Inframundo altaico/turco)", "Ajyy (Espíritus creadores Yakut)", "Abaasy (Espíritus malignos Yakut)", "Bugady Musun (Dueña de los animales Evenk)", "Tengri (Dios del Cielo túrquico/mongol)", "Umay (Diosa madre túrquica)",
            // Culturas Específicas (Ejemplos)
            "Chamanismo Buryat", "Chamanismo Sakha (Yakut)", "Chamanismo Evenk", "Chamanismo Tuvano", "Chamanismo Nganasan", "Chamanismo Ket", "Chamanismo Selkup", "Chamanismo Khanty y Mansi", "Chamanismo Nanai", "Chamanismo Ulchi", "Chamanismo Nivkh", "Chamanismo Chukchi", "Chamanismo Koryak", "Chamanismo Itelmen", "Variaciones Regionales del Chamanismo",
            // Historia y Modernidad
            "Orígenes del Chamanismo Siberiano", "Evidencia Arqueológica (Petroglifos)", "Influencias del Budismo Tibetano (Buryatia, Tuva)", "Influencias del Cristianismo Ortodoxo Ruso", "Supresión del Chamanismo en la Era Soviética", "Renacimiento del Chamanismo Post-Soviético", "Neochamanismo y Apropiación Cultural", "Desafíos del Chamanismo en el Mundo Moderno", "Sincretismo Religioso", "Chamanismo Urbano", "Impacto del Cambio Climático en Prácticas Tradicionales", "Turismo Chamánico", "Preservación de la Tradición Oral", "Investigadores Clave del Chamanismo Siberiano (Shirokogoroff, Eliade, etc.)", "El Chamanismo Siberiano en la Cultura Popular",
            // Simbolismo y Arte
            "Simbolismo del Tambor Chamánico", "Iconografía del Traje Chamánico", "Representaciones del Árbol del Mundo", "Simbolismo Animal (Oso, Lobo, Ciervo, Aves)", "Simbolismo de los Colores", "Arte Rupestre Chamánico", "Tallas en Madera y Hueso", "Diseños de Amuletos", "Simbolismo de los Sueños Chamánicos", "Metáforas del Viaje Espiritual", "El Lenguaje Secreto de los Chamanes", "Música Chamánica: Ritmo y Melodía", "Poesía Épica y Cantos Rituales", "Máscaras: Ocultación y Transformación", "Simbolismo del Espejo Chamánico"
             //... lista inicial extensa, cercana a 400 si se expanden variantes
        ];
        const siberianShamanismThemes = [
            "cosmología chamánica siberiana", "espíritus siberianos", "rituales chamánicos", "herramientas del chamán",
            "chamanismo Evenk", "chamanismo Buryat", "chamanismo Sakha (Yakut)", "chamanismo Tuvano", "animales de poder",
            "viaje chamánico", "sanación chamánica", "adivinación siberiana", "Árbol del Mundo", "Mundo Inferior siberiano",
            "espíritus ancestrales", "chamanismo y naturaleza", "supresión soviética del chamanismo", "renacimiento chamánico",
            "tambor chamánico", "traje del chamán", "iniciación chamánica", "mitología siberiana"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un/a antropólogo/a cultural y etnógrafo/a experto/a en las tradiciones espirituales indígenas de Siberia, con profundo conocimiento del chamanismo en sus diversas formas regionales. Describe el concepto, práctica, entidad o elemento cultural del chamanismo siberiano indicado. Proporciona contexto histórico y cultural, explica el simbolismo, detalla las prácticas asociadas (si aplica), menciona variaciones regionales significativas (ej. entre Buryats, Sakha, Evenks, etc.), y discute su relevancia pasada y presente. Usa un lenguaje académico pero accesible, respetuoso y neutral. El objetivo es una descripción detallada de aproximadamente 1200-1300 palabras. Basa tu descripción únicamente en el siguiente término o concepto:",
            timeoutSeconds: 180 // Aumentado ligeramente por la posible complejidad
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente IA especializado únicamente en el concepto de chamanismo siberiano que se está mostrando. Responde preguntas de seguimiento sobre sus características, prácticas, simbolismo o contexto cultural específico. Sé conciso, respetuoso y relevante al tema actual.",
            timeoutSeconds: 50
        };
        const titleGenerationConfig = { // Pide 40 títulos
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia sobre chamanismo siberiano. Genera exactamente 40 nombres de conceptos, prácticas, espíritus, herramientas, roles chamánicos o aspectos culturales relacionados con el chamanismo tradicional de Siberia. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentado por pedir más títulos
        };

        // ========== DOM ELEMENTS ==========
        // ... (igual que antes: searchInput, titleListContainer, etc.)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Contenedor del minijuego ahora
        const modalStoryContentArea = document.getElementById('modal-story-content-area'); // Wrapper contenido principal
        const modalTextArea = document.getElementById('modal-content-area'); // Área de texto scrollable
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div para texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameCanvas = document.getElementById('minigame-canvas');
        const minigameScoreDisplay = document.getElementById('minigame-score');
        const minigameLevelDisplay = document.getElementById('minigame-level');
        const loadingMessage = document.getElementById('loading-message');

        // ========== State Variables ==========
        let currentShamanicConcept = null; // Contexto del chat
        // Minigame State
        let gameRunning = false;
        let gameScore = 0;
        let gameLevel = 1;
        let spiritSpawnIntervalId = null;
        let levelUpIntervalId = null;
        const baseSpawnRate = 1500; // ms
        const baseSpiritLifetime = 3000; // ms
        const levelScoreThreshold = 50; // Puntos para subir de nivel

        // ========== API FUNCTIONS ==========
        // fetchTextFromApi, fetchExplanationText, fetchChatResponse, fetchGeneratedTitles, createPollinationsImageUrl
        // (Mismas funciones que antes, pero fetchGeneratedTitles usará la config que pide 40)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentShamanicConcept
                 ? `Eres un asistente IA especializado únicamente en el concepto de chamanismo siberiano llamado '${currentShamanicConcept}'. Responde preguntas de seguimiento sobre sus características, prácticas, simbolismo o contexto cultural específico. Sé conciso, respetuoso y relevante al tema actual.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, o la conexión falló. Por favor, intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Puede que el concepto sea muy específico o haya un problema temporal.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La consulta a los espíritus tardó demasiado (>${config.timeoutSeconds}s). La conexión puede ser lenta o los servidores están ocupados. Intenta más tarde.`);
                 }
                 throw new Error(error.message || "Un eco inesperado interrumpió la consulta. Ocurrió un error desconocido.");
             }
        }
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentShamanicConcept) throw new Error("Error interno: No se ha sintonizado con el espíritu del concepto actual.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() { // Pide 40
            const randomTheme = getRandomElement(siberianShamanismThemes) || "chamanismo siberiano general";
            const specificPrompt = `Genera 40 ítems (conceptos, espíritus, rituales, etc.) sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     // Esperamos más títulos ahora
                     if (titles.length < 15) throw new Error("La IA no generó suficientes conceptos nuevos.");
                     return titles.slice(0, 40); // Devuelve hasta 40
                 });
        }
         function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Siberian shamanism concept art";
             const enhancedPrompt = `Mystical, atmospheric artwork representing the concept of '${safePromptText}' in Siberian shamanism. Focus on symbolism, nature (taiga, tundra, aurora), spirits (animal, ancestor), ritual elements (drum, costume). Painterly or ethereal style. Avoid text, labels, diagrams, photorealism.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, photograph, realistic human face, modern objects";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (igual que antes) ... */
             if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            stopMinigame(); // Asegurarse de que el juego se detenga al cerrar
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.classList.remove('active'); // Ocultar loading/juego
             modalStoryContentArea.classList.add('content-hidden'); // Ocultar contenido principal
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = ''; chatInput.value = '';
             chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false;
             currentShamanicConcept = null;
             hideFullscreenImage();
             resetMinigameState(); // Resetear estado del juego
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (igual que antes) ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... (igual que antes) ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... (igual que antes) ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... (igual que antes) ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... (igual que antes) ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== MINIGAME FUNCTIONS ==========
        function resetMinigameState() {
            gameScore = 0;
            gameLevel = 1;
            updateScoreDisplay();
            updateLevelDisplay();
            minigameCanvas.innerHTML = ''; // Limpiar espíritus viejos
        }

        function startGameLoop() {
            if (gameRunning) return;
            gameRunning = true;
            resetMinigameState();
            modalLoadingIndicator.classList.add('active'); // Mostrar pantalla de carga/juego
            loadingMessage.textContent = "Consultando a los espíritus... (Juega mientras esperas!)";

            // Intervalo para generar espíritus
            const spawnRate = Math.max(200, baseSpawnRate / gameLevel); // Más rápido cada nivel
            spiritSpawnIntervalId = setInterval(spawnSpirit, spawnRate);

            // Intervalo para subir de nivel (basado en tiempo o score)
            levelUpIntervalId = setInterval(() => {
                if (gameScore >= gameLevel * levelScoreThreshold) {
                    advanceLevel();
                }
            }, 5000); // Revisa cada 5 segundos si se puede subir nivel

            console.log("Minigame started - Level:", gameLevel, "Spawn Rate:", spawnRate);
        }

        function stopMinigame() {
            if (!gameRunning) return;
            gameRunning = false;
            clearInterval(spiritSpawnIntervalId);
            clearInterval(levelUpIntervalId);
            spiritSpawnIntervalId = null;
            levelUpIntervalId = null;
            minigameCanvas.innerHTML = ''; // Limpiar espíritus restantes
            modalLoadingIndicator.classList.remove('active'); // Ocultar pantalla de carga/juego
            console.log("Minigame stopped. Final Score:", gameScore, "Final Level:", gameLevel);
        }

        function spawnSpirit() {
            if (!gameRunning || !minigameCanvas) return;

            const spirit = document.createElement('div');
            spirit.classList.add('spirit');

            const isGood = Math.random() < (0.85 - gameLevel * 0.05); // Menos prob. de buenos a mayor nivel
            spirit.classList.add(isGood ? 'good' : 'bad');

            // Posición aleatoria dentro del canvas
            const canvasRect = minigameCanvas.getBoundingClientRect();
            const spiritSize = isGood ? 30 : 25; // Coincidir con CSS
            const x = Math.random() * (canvasRect.width - spiritSize);
            const y = Math.random() * (canvasRect.height - spiritSize);
            spirit.style.left = `${x}px`;
            spirit.style.top = `${y}px`;

            spirit.addEventListener('click', handleSpiritClick);

            minigameCanvas.appendChild(spirit);

            // Hacer visible después de un pequeño delay para efecto fade-in
            setTimeout(() => {
                spirit.classList.add('visible');
            }, 50);

            // Eliminar espíritu después de un tiempo si no se hace clic
            const lifetime = Math.max(500, baseSpiritLifetime - (gameLevel * 200));
            setTimeout(() => {
                if (spirit.parentNode) { // Si todavía existe
                    spirit.classList.remove('visible'); // Fade out
                    setTimeout(() => { // Eliminar del DOM después del fade
                         if (spirit.parentNode) spirit.remove();
                    }, 500); // Tiempo del fade-out transition
                }
            }, lifetime);
        }

        function handleSpiritClick(event) {
            if (!gameRunning) return;
            const spirit = event.target;

            // Prevenir doble clic rápido
            spirit.removeEventListener('click', handleSpiritClick);

            if (spirit.classList.contains('good')) {
                gameScore += 10 * gameLevel; // Más puntos en niveles altos
                spirit.classList.add('clicked'); // Efecto visual
                // Podría añadirse un sonido aquí
            } else {
                gameScore = Math.max(0, gameScore - (20 * gameLevel)); // Penalización mayor
                // Podría haber un efecto visual negativo o sonido
                 spirit.style.backgroundColor = 'rgba(255, 0, 0, 0.7)'; // Flash rojo
                 spirit.style.boxShadow = '0 0 15px 5px rgba(200, 0, 0, 0.5)';
                 setTimeout(() => spirit.classList.add('clicked'), 100); // Quitar después del flash
            }

            updateScoreDisplay();

             // Eliminar después de la animación de clic
             setTimeout(() => {
                 if (spirit.parentNode) spirit.remove();
             }, 500); // Tiempo de la animación 'clicked'
        }

        function updateScoreDisplay() {
            minigameScoreDisplay.textContent = `Puntos: ${gameScore}`;
        }
        function updateLevelDisplay() {
             minigameLevelDisplay.textContent = `Nivel: ${gameLevel}`;
        }

        function advanceLevel() {
            gameLevel++;
            updateLevelDisplay();
            console.log("Level Up!", gameLevel);
            // Ajustar dificultad reiniciando el intervalo de spawn con nueva tasa
            clearInterval(spiritSpawnIntervalId);
            const newSpawnRate = Math.max(150, baseSpawnRate / gameLevel); // Mínimo 150ms
            spiritSpawnIntervalId = setInterval(spawnSpirit, newSpawnRate);
            console.log("New Spawn Rate:", newSpawnRate);
            // Opcional: Añadir breve indicación visual de subida de nivel
        }


        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» El vacío responde al silencio «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Added ${addedCount} new titles.`);
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to integrate MINIGAME ***
        async function handleTitleClick(title) {
            resetModalState(); // Reset general state
            showModal();
            modalTitle.textContent = title;
            currentShamanicConcept = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalStoryContentArea.classList.add('content-hidden'); // Ocultar contenido principal

            // *** START MINIGAME ***
            startGameLoop();

            try {
                // Fetch data WHILE game is running
                const rawExplanationText = await fetchExplanationText(title);

                // *** STOP MINIGAME *** (antes de mostrar contenido)
                stopMinigame();

                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalContent.innerHTML = formattedExplanation; // Add text
                modalStoryContentArea.classList.remove('content-hidden'); // Show content area

                modalTextArea.scrollTop = 0; // Reset scroll
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder (igual que antes)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-om placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Canalizando visión...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Create image element (igual que antes)
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visión bloqueada.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al canalizar visión.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                // *** STOP MINIGAME if error occurs during fetch ***
                stopMinigame();
                modalErrorMessage.textContent = error.message || "Un espíritu errante interrumpió la conexión.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() { // Pide 40
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando ecos profundos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetching 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Los espíritus no revelaron más secretos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar sabiduría: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Buscar Más Sabiduría (40)';
             }
         }

         // Search Filter Function (sin cambios)
         function filterTitles(searchTerm) { /* ... (igual que antes) ... */ const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); const titleItems = titleListContainer.querySelectorAll('.title-item'); let visibleCount = 0; titleItems.forEach(item => { const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const isVisible = titleText.includes(term); item.classList.toggle('hidden', !isVisible); if (isVisible) visibleCount++; }); noResultsMsg.classList.toggle('hidden', visibleCount > 0); }

        // ========== INITIALIZATION ==========
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameCanvas) {
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error crítico: El portal a los mundos espirituales no se pudo abrir (Faltan componentes UI).</p>';
                 return;
             }
             // Listeners (Modal, GenerateMore, Search, Chat, Fullscreen)
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Initial Display
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
             // Asegurarse que el loading/juego esté oculto inicialmente
             modalLoadingIndicator.classList.remove('active');
         }
         document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>