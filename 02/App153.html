<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mejores Animes de la Historia - Guía Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes: Una llamativa para títulos, una legible para cuerpo -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Anime Guide --- */
        :root {
            --color-primary: #3b82f6; /* Azul Vibrante */
            --color-secondary: #ec4899; /* Rosa/Magenta Vibrante */
            --color-tertiary: #f59e0b; /* Naranja/Amarillo Vibrante */
            --color-background: #1f2937; /* Gris Azulado Oscuro */
            --color-text: #e5e7eb; /* Gris Muy Claro */
            --color-text-muted: #9ca3af; /* Gris Medio */
            --color-modal-bg: #111827; /* Azul Casi Negro (Modal) */
            --color-border: #4b5563; /* Borde Gris Medio Oscuro */
            --color-error-bg: #450a0a; /* Fondo error rojo muy oscuro */
            --color-error-text: #fecaca; /* Texto error claro */
            --color-error-border: #ef4444; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.15), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.15);
            --border-radius: 6px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Poppins', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); text-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 600;}
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(31, 41, 55, 0.85); backdrop-filter: blur(8px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(17, 24, 39, 0.9); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Poppins'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-secondary); background-color: #374151; border-left-color: var(--color-secondary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; text-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.92); /* Overlay oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 1000px; /* Un poco más ancho para anime */
            width: 96%;
            max-height: 92vh;
            min-height: 450px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: white; transform: rotate(90deg); box-shadow: 0 0 8px var(--color-secondary); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; color: var(--color-primary); }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(75, 85, 99, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(75, 85, 99, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 600; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Poppins', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 600; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.1em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.0em; color: var(--color-text-muted); border-bottom: none; font-weight: 400;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(75, 85, 99, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* Más espacio para chat */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.6rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(31, 41, 55, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(75, 85, 99, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(75, 85, 99, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; } /* User blue */
        .ai-message { background-color: #4b5563; color: var(--color-text); margin-right: auto; text-align: left; } /* AI gray */
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.4rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #374151; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); background-color: var(--color-modal-bg); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #2563eb; } /* Darker blue hover */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(17, 24, 39, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.3rem; font-family: 'Poppins'; text-shadow: 0 0 4px var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); border-radius: 4px; }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-modal-bg); transform: scale(1.1); box-shadow: 0 0 8px var(--color-primary); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-star mr-2 text-yellow-400"></i> <!-- Icono estrella -->
                     Animes Legendarios
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">~ Guía Interactiva Definitiva ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora Obras Maestras del Anime</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Sumérgete en las historias, personajes y legados de los animes más aclamados e influyentes de todos los tiempos.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar anime (Título)...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-film text-blue-400 mr-2"></i> <!-- Icono film -->
                 Catálogo de Leyendas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Cargando archivo histórico de anime...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">~ No se encontraron animes con ese criterio ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Clásicos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Cargando Información...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder added here via JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Pensando...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregúntame más sobre este anime...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Anime">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-800 text-gray-400 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Análisis y datos generados por IA basados en información pública sobre anime. Con fines de entretenimiento y referencia.</p>
              <p class="mt-1">Las opiniones sobre "mejores" son subjetivas. ¡Disfruta explorando!</p>
              <p class="mt-2">© 2025 Guía Anime Legendarios</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Shonen Clásicos y Modernos
            "Dragon Ball Z", "Naruto", "Naruto Shippuden", "One Piece", "Bleach", "Fullmetal Alchemist: Brotherhood", "Hunter x Hunter (2011)", "Attack on Titan (Shingeki no Kyojin)", "Demon Slayer: Kimetsu no Yaiba", "Jujutsu Kaisen", "My Hero Academia (Boku no Hero Academia)", "Fairy Tail", "Yu Yu Hakusho", "Rurouni Kenshin", "Inuyasha", "Death Note", "Code Geass: Lelouch of the Rebellion", "Code Geass R2", "JoJo's Bizarre Adventure (Stardust Crusaders)", "JoJo's Bizarre Adventure (Diamond is Unbreakable)", "JoJo's Bizarre Adventure (Golden Wind)", "Gintama", "Haikyuu!!", "Kuroko's Basketball (Kuroko no Basket)", "Slam Dunk", "Hajime no Ippo", "Assassination Classroom (Ansatsu Kyoushitsu)", "The Promised Neverland (Yakusoku no Neverland) - Season 1", "Dr. Stone", "Black Clover", "One Punch Man", "Mob Psycho 100", "Vinland Saga", "Chainsaw Man", "Spy x Family",
            // Seinen
            "Berserk (1997)", "Monster", "Vinland Saga", "Psycho-Pass", "Ghost in the Shell: Stand Alone Complex", "Ghost in the Shell (1995 Movie)", "Akira (Movie)", "Cowboy Bebop", "Samurai Champloo", "Trigun (1998)", "Hellsing Ultimate", "Black Lagoon", "Mushishi", "Parasyte -the maxim- (Kiseijuu: Sei no Kakuritsu)", "Erased (Boku dake ga Inai Machi)", "Made in Abyss", "Golden Kamuy", "Kingdom", "March Comes in Like a Lion (3-gatsu no Lion)", "Showa Genroku Rakugo Shinju", "Rainbow: Nisha Rokubou no Shichinin", "Claymore", "Texhnolyze", "Ergo Proxy", "Serial Experiments Lain", "Perfect Blue (Movie)", "Paprika (Movie)", "Tokyo Ghoul (Season 1)", "Ajin: Demi-Human", "Dororo (2019)", "Dorohedoro", "Great Pretender", "Odd Taxi",
            // Shojo y Josei
            "Fruits Basket (2019)", "Ouran High School Host Club", "Maid Sama! (Kaichou wa Maid-sama!)", "Sailor Moon", "Cardcaptor Sakura", "Revolutionary Girl Utena", "Nana", "Paradise Kiss", "Honey and Clover (Hachimitsu to Clover)", "Chihayafuru", "Nodame Cantabile", "Skip Beat!", "Princess Tutu", "Kimi ni Todoke", "Lovely Complex", "Toradora!", "Your Lie in April (Shigatsu wa Kimi no Uso)", "Clannad", "Clannad: After Story", "Anohana: The Flower We Saw That Day", "A Silent Voice (Koe no Katachi) (Movie)", "Violet Evergarden", "Ancient Magus' Bride (Mahoutsukai no Yome)", "Yona of the Dawn (Akatsuki no Yona)", "Kamisama Kiss (Kamisama Hajimemashita)", "Snow White with the Red Hair (Akagami no Shirayuki-hime)", "Orange", "Blue Spring Ride (Ao Haru Ride)", "Wotakoi: Love is Hard for Otaku", "Given",
            // Mecha
            "Neon Genesis Evangelion", "The End of Evangelion (Movie)", "Mobile Suit Gundam (Original 0079)", "Mobile Suit Gundam: The Origin", "Mobile Suit Zeta Gundam", "Mobile Suit Gundam Wing", "Mobile Suit Gundam: Iron-Blooded Orphans", "Mobile Suit Gundam SEED", "Mobile Suit Gundam 00", "Tengen Toppa Gurren Lagann", "Code Geass: Lelouch of the Rebellion", "Macross Frontier", "Macross Plus (OVA)", "Super Dimension Fortress Macross", "Eureka Seven", "Full Metal Panic!", "Full Metal Panic? Fumoffu", "The Vision of Escaflowne", "Gunbuster (Top wo Nerae!) (OVA)", "Diebuster (Top wo Nerae! 2) (OVA)", "Getter Robo Armageddon (OVA)", "Shin Getter Robo vs Neo Getter Robo (OVA)", "Mazinger Z: Infinity (Movie)", "Gargantia on the Verdurous Planet", "Aldnoah.Zero", "Knights of Sidonia (Sidonia no Kishi)", "86 EIGHTY-SIX", "SSSS.Gridman", "SSSS.Dynazenon",
            // Fantasy e Isekai
            "Fullmetal Alchemist: Brotherhood", "Attack on Titan", "Made in Abyss", "Mushishi", "Natsume's Book of Friends (Natsume Yuujinchou)", "Spice and Wolf (Ookami to Koushinryou)", "Re:ZERO -Starting Life in Another World-", "Konosuba: God's Blessing on This Wonderful World!", "That Time I Got Reincarnated as a Slime (Tensei shitara Slime Datta Ken)", "Overlord", "No Game No Life", "Log Horizon", "The Rising of the Shield Hero (Tate no Yuusha no Nariagari)", "Mushoku Tensei: Jobless Reincarnation", "Grimgar: Ashes and Illusions (Hai to Gensou no Grimgar)", "Saga of Tanya the Evil (Youjo Senki)", "GATE", "Ascendance of a Bookworm (Honzuki no Gekokujou)", "Howl's Moving Castle (Movie)", "Spirited Away (Sen to Chihiro no Kamikakushi) (Movie)", "Princess Mononoke (Mononoke Hime) (Movie)", "My Neighbor Totoro (Tonari no Totoro) (Movie)", "Castle in the Sky (Laputa) (Movie)", "Nausicaä of the Valley of the Wind (Movie)", "Record of Lodoss War (OVA)", "Slayers", "Magi: The Labyrinth of Magic", "Ranking of Kings (Ousama Ranking)", "Frieren: Beyond Journey's End (Sousou no Frieren)",
            // Sci-Fi
            "Cowboy Bebop", "Ghost in the Shell: Stand Alone Complex", "Psycho-Pass", "Steins;Gate", "Neon Genesis Evangelion", "Akira (Movie)", "Serial Experiments Lain", "Ergo Proxy", "Planetes", "Legend of the Galactic Heroes (Ginga Eiyuu Densetsu) (OVA)", "Space Battleship Yamato 2199 (Uchuu Senkan Yamato 2199)", "Outlaw Star", "From the New World (Shinsekai yori)", "ID: Invaded", "Vivy: Fluorite Eye's Song", "Deca-Dence", "Astra Lost in Space (Kanata no Astra)", " Knights of Sidonia", "Texhnolyze", "Patlabor: The Movie", "Patlabor 2: The Movie", "Redline (Movie)", "Memories (Movie)", "Time of Eve (Eve no Jikan)",
            // Slice of Life / Comedy / Drama
            "Clannad: After Story", "March Comes in Like a Lion", "Mushishi", "Natsume's Book of Friends", "Barakamon", "Silver Spoon (Gin no Saji)", "Non Non Biyori", "K-On!", "Lucky Star", "The Melancholy of Haruhi Suzumiya", "Nichijou", "Daily Lives of High School Boys (Danshi Koukousei no Nichijou)", "Azumanga Daioh", "Aria The Animation/Natural/Origination", "Hyouka", "Sound! Euphonium (Hibike! Euphonium)", "Shirobako", "Keep Your Hands Off Eizouken! (Eizouken ni wa Te wo Dasu na!)", "Bocchi the Rock!", "Usagi Drop", "Sweetness & Lightning (Amaama to Inazuma)", "Poco's Udon World", "Flying Witch", "Tanaka-kun is Always Listless", "Haven't You Heard? I'm Sakamoto (Sakamoto desu ga?)", "Aggretsuko", "Welcome to the N.H.K.",
             // Horror / Thriller / Mystery
             "Monster", "Death Note", "The Promised Neverland (S1)", "Parasyte -the maxim-", "Higurashi: When They Cry (Higurashi no Naku Koro ni)", "Shinsekai yori (From the New World)", "Shiki", "Another", "Perfect Blue (Movie)", "Hell Girl (Jigoku Shoujo)", "Mononoke (Ayakashi - Samurai Horror Tales spin-off)", "Devilman Crybaby", "Happy Sugar Life", "School-Live! (Gakkougurashi!)", "Future Diary (Mirai Nikki)", "Deadman Wonderland", "Elfen Lied", "Gantz", "Corpse Party: Tortured Souls (OVA)",
            // Romance Focado
            "Your Name (Kimi no Na wa) (Movie)", "Weathering with You (Tenki no Ko) (Movie)", "5 Centimeters per Second (Byousoku 5 Centimeter) (Movie)", "The Garden of Words (Kotonoha no Niwa) (Movie)", "My Dress-Up Darling (Sono Bisque Doll wa Koi wo Suru)", "Horimiya", "Kaguya-sama: Love Is War", "Rascal Does Not Dream of Bunny Girl Senpai (Seishun Buta Yarou)", "Tsuki ga Kirei", "Bloom Into You (Yagate Kimi ni Naru)", "Given", "Fruits Basket (2019)", "Toradora!", "Golden Time", "Plastic Memories", "Recovery of an MMO Junkie (Net-juu no Susume)", "Mysterious Girlfriend X (Nazo no Kanojo X)",
            // Sports
            "Haikyuu!!", "Slam Dunk", "Kuroko's Basketball", "Hajime no Ippo", "Ashita no Joe", "Ping Pong The Animation", "Run with the Wind (Kaze ga Tsuyoku Fuiteiru)", "Yuri!!! on Ice", "Free! - Iwatobi Swim Club", "Ace of Diamond (Diamond no Ace)", "Major", "Cross Game", "Chihayafuru", "Initial D First Stage", "Megalo Box", "SK8 the Infinity", "Blue Lock", "Eyeshield 21", "Captain Tsubasa (Original)", "Big Windup! (Oofuri)",
            // Extra Movies & OVAs notables
            "Grave of the Fireflies (Hotaru no Haka)", "Wolf Children (Ookami Kodomo no Ame to Yuki)", "The Girl Who Leapt Through Time (Toki wo Kakeru Shoujo)", "Millennium Actress (Sennen Joyuu)", "Tokyo Godfathers", "Sword of the Stranger (Stranger: Mukou Hadan)", "Jin-Roh: The Wolf Brigade", "FLCL (Fooly Cooly) (OVA)", "Interstella 5555: The 5tory of the 5ecret 5tar 5ystem", "Tekkonkinkreet", "Mind Game", "Royal Space Force: The Wings of Honnêamise", "Angel's Egg (Tenshi no Tamago)", "Belle (Ryuu to Sobakasu no Hime)"
            // ~400+ Titles, should be exhaustive enough!
        ];
        const animeThemes = [ // For generating more titles
            "critically acclaimed anime series", "influential shonen anime", "classic mecha anime", "best anime movies of all time", "highly rated seinen anime", "popular romance anime", "must-watch slice of life anime", "iconic fantasy anime", "groundbreaking sci-fi anime", "Studio Ghibli masterpieces", "best sports anime", "underrated anime gems", "anime from the 90s", "anime from the 2000s", "modern anime classics", "best isekai anime", "psychological thriller anime", "unique comedy anime", "anime with amazing animation", "anime with great soundtracks", "historical anime settings", "supernatural anime series", "mystery anime recommendations", "anime based on light novels", "anime based on manga"
        ];
        const textApiConfig = { // For main description
            model: "mistral",
            systemPrompt: "Eres un crítico de anime experimentado y un historiador del medio. Tu tarea es proporcionar un análisis detallado y perspicaz del anime (serie, película u OVA) indicado. Incluye: una sinopsis concisa (evitando spoilers mayores), análisis de temas clave y mensajes, descripción de personajes principales y su desarrollo, comentarios sobre el estilo de animación, arte y dirección, la importancia de la banda sonora y el diseño de sonido, su impacto cultural y legado, el (los) género(s) principal(es) y audiencia objetivo, y una conclusión sobre por qué es considerado uno de los 'mejores' o más significativos animes. Usa un lenguaje articulado y atractivo. El objetivo es un análisis completo de aproximadamente 1200-1300 palabras. Céntrate exclusivamente en el siguiente título:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Base config for chat
            model: "mistral-tiny", // Faster model for chat
            systemPrompt: "Actúas como un asistente experto únicamente en el anime '[ANIME_TITLE]'. Responde preguntas de seguimiento sobre su trama (sin spoilers mayores a menos que se pidan), personajes, temas, producción, recepción o curiosidades. Sé conciso, preciso y mantente estrictamente enfocado en este anime específico.", // Placeholder, will be replaced dynamically
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de recomendaciones de anime. Genera exactamente 15 títulos diversos de anime (series, películas, OVAs) que sean bien conocidos, aclamados por la crítica o influyentes en diversos géneros y épocas. Devuelve *solo* la lista de títulos, uno por línea. Sin números, guiones, introducciones o comentarios.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Scrollable area for text+image
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div for text HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentAnimeTitle = null; // Context for chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            let systemPromptToUse = config.systemPrompt;

            if (isChat && currentAnimeTitle) {
                // Replace placeholder in chat config's system prompt
                systemPromptToUse = chatApiConfig.systemPrompt.replace('[ANIME_TITLE]', currentAnimeTitle);
            }
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            // Seed is less useful/predictable for chat, maybe omit?
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}... Context: ${isChat ? currentAnimeTitle : 'Main Description/Title Gen'}`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    // Friendly error message
                    throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento. Por favor, inténtalo de nuevo en unos segundos.`);
                }
                const text = await response.text();
                 // Add check for empty or refusal responses
                if (!text || text.trim().length === 0 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("unable to provide")) {
                    throw new Error("La IA no pudo generar una respuesta adecuada para esta solicitud. Intenta de nuevo o con otro título.");
                 }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión con la IA tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                }
                // Propagate the error message (could be the friendly one from above or a new one)
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }
        // Wrappers for clarity
        async function fetchExplanationText(animeTitle) {
            return fetchTextFromApi(animeTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentAnimeTitle) throw new Error("Error Interno: No se ha establecido el contexto del anime para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true); // Pass true for isChat
        }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(animeThemes);
             const specificPrompt = `Genera 15 títulos de anime basados en el tema: ${randomTheme}`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n')
                                        .map(line => line.replace(/^[-\d.\s*]+/, '').trim()) // Clean start of line
                                        .filter(line => line.length > 3 && line.length < 150); // Basic validation
                     if (titles.length < 5) throw new Error("La IA no generó suficientes títulos de anime.");
                     return titles.slice(0, 15); // Return max 15
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "iconic anime scene";
             // Enhanced prompt for anime visuals
             const enhancedPrompt = `Conceptual artwork inspired by the anime '${safePromptText}'. Focus on atmosphere, iconic imagery or symbols, key characters (stylized anime art style, not photorealistic), or memorable landscapes/settings. Evocative, artistic interpretation. Cinematic lighting. Avoid text, logos, UI elements.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Stronger negative prompt against text/realism
             const negativePrompt = "text, words, letters, logo, title, caption, label, watermark, signature, realistic photograph, real person, 3D render, UI, menu, button, multiple panels, collage, simple background, blurry, deformed, ugly";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (Re-using the previous robust version)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            // Basic Markdown and common AI formatting quirks
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => `${base}<sup>${exponent.replace('−', '-')}</sup>`);
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); // Less likely in anime, but keep just in case
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Paragraph handling: Treat blocks separated by double newlines as paragraphs
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                // Don't wrap existing html tags (like headings) in <p>
                if (block.match(/^\s*<[hH][1-6]>.*<\/[hH][1-6]>\s*$/) || block.match(/^\s*<p class="formula">.*<\/p>\s*$/)) {
                    return block;
                }
                // Replace single newlines within a block with spaces for better flow, unless it's a list item
                if (block.match(/^\s*[-\*+]\s+/)) { // Basic list detection
                     return block.replace(/\n/g, '<br>'); // Keep line breaks in lists
                } else {
                    let content = block.replace(/\n/g, ' '); // Join lines with spaces in standard paragraphs
                     return `<p>${content}</p>`;
                }
            }).join('');

            // Optional: Basic unordered list conversion
            formatted = formatted.replace(/^\s*[-\*+]\s+(.*$)/gm, '<li>$1</li>'); // Convert lines starting with -, *, + to <li>
            formatted = formatted.replace(/(\s*<li>.*<\/li>\s*)+/g, (match) => `<ul>${match}</ul>`); // Wrap consecutive <li> in <ul>

            return formatted;
         }


        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0; // Reset scroll of the text/image area
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentAnimeTitle = null; // Clear chat context
             // Hide fullscreen image if it was open
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ==========
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Ensure scroll lock
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            // Only restore scroll if the main modal is ALSO closed
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            // Basic Markdown formatting for chat
            let formattedMessage = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formattedMessage = formattedMessage.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = formattedMessage; // Use innerHTML for formatting
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Auto-scroll
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = `⚠️ ${message}`; // Add warning icon
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentAnimeTitle) return;

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                // Display the potentially friendly error message from the API function
                addChatError(error.message || "Error al obtener respuesta de la IA.");
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Sort alphabetically for consistency
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = ''; // Clear previous/loading
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">~ No hay animes en el catálogo actualmente ~</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => {
                 if (!existingTitles.has(title)) {
                     titleListContainer.appendChild(createTitleItem(title));
                     addedCount++;
                 }
             });
             console.log(`Added ${addedCount} new unique titles.`);
             // Re-apply current search filter to new items
             filterTitles(searchInput.value);
         }

        async function handleTitleClick(title) {
            resetModalState(); // Resets everything including chat context and fullscreen
            showModal();
            modalTitle.textContent = title;
            currentAnimeTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = ''; // Clear chat for the new anime
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // 1. Fetch and display text content
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none'; // Hide loading AFTER text is ready
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Show main area

                // 2. IMPORTANT: Reset scroll AFTER content is rendered and visible
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // 3. Prepare and add image placeholder (inside modalContent)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando arte conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Add placeholder at the end of text

                // 4. Create image element and start loading
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image'; // For styling and click listener
                imgElement.alt = `Arte conceptual de ${title}`;
                imgElement.style.display = 'none'; // Hide until loaded

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove(); // Remove placeholder
                    imgElement.style.display = 'block'; // Show image
                    // Add click listener for fullscreen view
                    imgElement.addEventListener('click', () => {
                        showFullscreenImage(imgElement.src);
                    });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al cargar la imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append the image element itself
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo generar URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                // Use the potentially friendly error message from fetch function
                modalErrorMessage.textContent = `Error al cargar: ${error.message || "Error desconocido."}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display the error msg
                modalContent.innerHTML = ''; // Clear any partial content
                chatSection.classList.add('content-hidden'); // Hide chat if the main content failed
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más joyas...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     appendTitles(newTitles);
                 } else {
                     // More specific feedback if possible
                     alert("No se encontraron más títulos recomendados en este momento.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 // Use the friendly error message if available
                 alert(`Error al buscar títulos: ${error.message || "Fallo en la comunicación con la IA."}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Clásicos';
             }
         }

         // Search Filter Function (with normalization for accents)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;

             titleItems.forEach(item => {
                 // Normalize item title as well for comparison
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) {
                     visibleCount++;
                 }
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Show if no results OR no items initially
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check for all critical elements
            const requiredElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, modalTextArea, modalContent, modalLoadingIndicator, modalError];
            if (requiredElements.some(el => !el)) {
                 console.error("Initialization failed: Missing one or more essential DOM elements.");
                 document.body.innerHTML = '<p style="color: #f87171; font-size: 1.5em; text-align: center; padding: 3em; font-family: sans-serif;">Error Crítico: La interfaz no pudo cargarse correctamente. Faltan componentes esenciales.</p>';
                 return;
             }

            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); }); // Optional: Prevent Enter submit feel
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Load initial titles
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden'); // Start hidden
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>