<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arsenal Medieval - Compendio Histórico</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Medieval/Serif -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Arsenal Medieval --- */
        :root {
            --color-primary: #8B4513; /* Marrón Sienna (Madera/Cuero) */
            --color-secondary: #B8860B; /* Oro Oscuro (Detalles) */
            --color-tertiary: #800000; /* Marrón/Rojo Oscuro (Sangre/Estandartes) */
            --color-background: #f5f5dc; /* Beige (Pergamino Claro) */
            --color-text: #3a2d27; /* Marrón Muy Oscuro (Tinta) */
            --color-text-muted: #7a5c58; /* Marrón Grisáceo */
            --color-modal-bg: #e8d8c0; /* Beige más oscuro (Pergamino Modal) */
            --color-border: #c1a997; /* Borde Marrón Claro */
            --color-error-bg: #fde8e8; /* Fondo error rojo muy pálido */
            --color-error-text: #9b2c2c; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo pálido */

            --shadow-sm: 0 1px 2px 0 rgba(58, 45, 39, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(58, 45, 39, 0.15), 0 2px 4px -2px rgba(58, 45, 39, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(58, 45, 39, 0.2), 0 4px 6px -4px rgba(58, 45, 39, 0.15);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23c1a997' fill-opacity='0.1'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); /* Textura sutil */ }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-tertiary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-tertiary); font-weight: 700; }
        .navbar { background-color: rgba(245, 245, 220, 0.85); /* Beige semi-transparente */ backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(255, 255, 255, 0.7); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Merriweather'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.2); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: #fff; padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Merriweather'; font-size: 1rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #faf8f0; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-background); padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; border: 1px outset #a0522d; }
        #generate-more-btn:hover:not(:disabled) { background-color: #a0522d; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; border: 1px inset #c1a997; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(58, 45, 39, 0.85); /* Overlay Marrón Oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAEeSURBVGhD7ZfBDYAwDEPDkI6gDVgBC9AOjEAngA7QAUYwAypgA7QBG6AjGAuiewn/S5JEHEj2h9635PfJDRkfJKO5ubm5ufo/DRBbMmhDCwZtGDBowaANIQwsGNQgGowg2oBgMIJqAYPBCLINCAYj6CYgGIygu4BgcILsA4LBCPoLCAYnyD4gGEzQ4SAYTNBhIBhM0OEgGEzQ4SAQTCDoMBAIJhB0GAgEEwg6DAQCQYcdAYJAhx0BgkCHHQGCQIf/gKDDPwKCQYceAYLBCjoDDIYRdB0YDCOoOhgMI6g7GAwjaD8YDCNoPxkMI6g/GAwjaEMGhg1sYMPAhoENUhhYMDZDYWAEbYXCwAjaiULACNoJhYARdBULACPoKhYA5t7m5ubu5A0wUHHIAQ3mpAAAAAElFTkSuQmCC"); /* Textura pergamino más oscura */
            background-repeat: repeat;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: 1px solid var(--color-primary); border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg); box-shadow: 0 0 8px var(--color-primary); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(193, 169, 151, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(193, 169, 151, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-tertiary); font-weight: 700; }
        #modal-content em { color: var(--color-primary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 2px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; background-color: #fff; /* Fondo blanco por si la imagen tiene transparencia */ }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(193, 169, 151, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(245, 245, 220, 0.6); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(193, 169, 151, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(193, 169, 151, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-family: 'Merriweather'; font-size: 0.95rem; }
        .user-message { background-color: var(--color-secondary); color: var(--color-text); margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #d3bfa8; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Merriweather'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-background); border: 1px outset #a0522d; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #a0522d; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; border: 1px inset #c1a997; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(232, 216, 192, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.3rem; font-family: 'Cinzel'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Merriweather'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(58, 45, 39, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-secondary); box-shadow: var(--shadow-lg); background-color: #fff; }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-modal-bg); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-shield-alt mr-3 text-yellow-700"></i> <!-- Icono escudo -->
                     Arsenal Medieval
                 </h1>
             </div>
             <span class="text-sm text-gray-700 font-sans tracking-wider">» Compendio Histórico «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">El Arte de la Guerra Medieval</h1>
             <p class="text-xl text-gray-800 mb-8 max-w-3xl mx-auto font-light">Explora las herramientas de combate que forjaron reinos y decidieron batallas. Descubre su historia, diseño y uso en el campo de batalla.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar arma, armadura o equipo...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll text-yellow-800 mr-2"></i> <!-- Icono pergamino -->
                 Índice de Armamentos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-600 col-span-full text-center text-lg font-sans">Consultando los archivos históricos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-600 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún registro coincide con la búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Registros
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Descifrando Pergaminos...</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando al cronista...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este armamento...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-feather-alt"></i> <!-- Icono pluma -->
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-yellow-100 text-yellow-900 py-6 mt-12 border-t border-yellow-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Compendio generado con asistencia de IA, basado en conocimientos históricos sobre el periodo medieval.</p>
              <p class="mt-1">La información debe ser considerada como una guía introductoria. Consulte fuentes académicas para estudios detallados.</p>
              <p class="mt-2">© del Año del Señor Correspondiente - Archivos del Compendio</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Espadas
            "Espada de Armar (Arming Sword)", "Espada Larga (Longsword)", "Mandoble / Espadón (Zweihänder/Greatsword)", "Bracamante (Messer/Falchion)", "Cimitarra", "Claymore Escocesa", "Estoque (Rapier - Renacimiento temprano)", "Schiavona", "Katzbalger", "Espada Bastarda / Mano y Media", "Espada Corta (Shortsword)", "Seax / Scramasax (Vikinga/Germánica)", "Gladius (Referencia Antigua)", "Dao Chino (Referencia Comparativa)", "Katana Japonesa (Referencia Comparativa)",
            // Hachas
            "Hacha de Guerra (Battle Axe)", "Hacha Danesa (Dane Axe)", "Hacha de Arrojar (Throwing Axe)", "Bardiche", "Hacha de Petos (Poleaxe - Híbrida)", "Francisca (Merovingia)", "Tomahawk (Referencia Posterior)",
            // Mazas y Martillos
            "Maza de Guerra (Mace)", "Maza de Bridas (Flanged Mace)", "Maza Estrellada (Morning Star)", "Martillo de Guerra (Warhammer)", "Lucerne Hammer (Martillo-Pico)", "Mazo (Maul)", "Mayal (Flail)", "Martillo de Caballería", "Shishpar (Maza Persa/India)",
            // Armas de Asta (Polearms)
            "Lanza (Spear)", "Pica (Pike)", "Alabarda (Halberd)", "Guisarma (Guisarme)", "Partesana (Partisan)", "Corcesca (Corsèque)", "Roncona (Ranseur)", "Bisarma (Billhook/Bill-Guisarme)", "Voulge", "Pico de Cuervo (Bec de Corbin)", "Lanza de Caballería (Lance)", "Jabalina (Javelin)", "Angon (Lanza arrojadiza germánica)", "Tridente (Poco común)", "Naguinata Japonesa (Referencia Comparativa)", "Yari Japonés (Referencia Comparativa)",
            // Armas Arrojadizas y a Distancia (No pólvora inicial)
            "Arco Largo Inglés (Longbow)", "Arco Corto / Arco Compuesto (Shortbow/Composite Bow)", "Ballesta (Crossbow)", "Arbalesta (Arbalest - Ballesta Pesada)", "Ballesta de Repetición (Cho-ko-nu - China, Referencia)", "Honda (Sling)", "Dardo (Dart)", "Cuchillo Arrojadizo (Throwing Knife)", "Shuriken Japonés (Referencia Comparativa)", "Fustíbalo (Staff Sling)",
            // Armas de Asedio
            "Trabuquete / Fundíbulo (Trebuchet)", "Catapulta (Onagro/Mangonel)", "Balista (Ballista)", "Ariete (Battering Ram)", "Torre de Asedio (Siege Tower)", "Escorpión (Ballista Romana Pequeña)", "Mantelete (Mantlet - Escudo Móvil)", "Gato (Cubierta protectora para ariete)", "Trépano (Herramienta de asedio)", "Fuego Griego (Referencia Bizantina)", "Brisca (Máquina lanzapiedras)",
            // Armaduras (Componentes)
            "Cota de Malla (Mail/Chainmail)", "Loriga Segmentata (Referencia Romana)", "Coraza (Cuirass - Placa Pectoral/Espalda)", "Armadura de Placas Completa (Full Plate)", "Brigantina (Brigandine)", "Armadura Laminar (Laminar Armour)", "Armadura Lamelar (Lamellar Armour)", "Gambesón / Aquetón (Gambeson/Aketon)", "Codal (Couter - Codo)", "Hombrera (Pauldron/Spaulder)", "Muslera / Quijote (Cuisses/Tassets)", "Greba (Greave - Espinilla)", "Escarpe (Sabatons - Pies)", "Manopla (Gauntlet)", "Gola / Gorjal (Gorget - Cuello)",
            // Yelmos y Cascos
            "Yelmo Nasal (Nasal Helm)", "Cervellera / Casquete (Skullcap/Cervelliere)", "Bacinete (Bascinet)", "Gran Yelmo (Great Helm/Heaume)", "Capelina (Kettle Hat/Chapel-de-fer)", "Celada (Sallet)", "Barbuta (Barbute)", "Armet", "Yelmo Cerrado (Close Helm)", "Spangenhelm", "Yelmo Vikingo (Sin cuernos históricamente)", "Kabuto Japonés (Referencia Comparativa)",
            // Escudos
            "Broquel (Buckler)", "Escudo de Cometa (Kite Shield)", "Escudo de Lágrima", "Pavés (Pavise)", "Rodela (Round Shield)", "Targe Escocés (Targe)", "Escudo Calefactor (Heater Shield)", "Adarga", "Scutum Romano (Referencia Antigua)", "Escudo Vikingo Redondo",
            // Equipo Adicional y Varios
            "Daga / Puñal (Dagger/Poniard)", "Misericordia", "Cuchillo de Combate", "Espuelas (Spurs)", "Caraj (Perno de Ballesta)", "Flecha (Bodkin, Broadhead, etc.)", "Virote (Ballesta)", "Zurrón (Pouch/Scrip)", "Cuerno de Llamada", "Estandarte / Pendón", "Silla de Montar de Guerra", "Bridas y Arnés de Caballo", "Calzas (Hose)", "Tabardo (Tabard)", "Cinturón de Espada", "Tahali",
            // Conceptos y Tácticas
            "Formación de Falange (Referencia Antigua)", "Muro de Escudos (Shield Wall)", "Carga de Caballería Pesada", "Tácticas de Arqueros (Voleas)", "Asedio Medieval: Técnicas", "Duelo Judicial", "Torneos y Justas", "Heráldica y su Significado", "La Figura del Caballero", "Mercenarios Medievales (Condotieros, Almogávares)", "Órdenes Militares (Templarios, Hospitalarios, Teutónicos)", "Metalurgia Medieval (Acero, Hierro)", "El Costo del Equipamiento Militar", "Logística de un Ejército Medieval", "Impacto de la Pólvora (Transición)",
            // Agregando más variedad
            "Khanda (Espada India)", "Pata (Espada con Guantelete India)", "Chakram (Anillo Arrojadizo Indio)", "Urumi (Espada Látigo India)", "Macuahuitl (Arma Azteca, Ref. comparativa)", "Atlatl (Propulsor de Dardos, Ref. pre-medieval)", "Clava nudosa", "Garrote", "Boleadoras (Sudamérica, Ref. comparativa)", "Hacha de doble filo (Fantasía común, históricamente raro)", "Cota de escamas", "Armadura de cuero endurecido (Cuir Bouilli)", "Escudo pavesina (Variante de Pavés)", "Mangual de armas (Variante de Mayal)", "Gancho de guerra", "Cuchillo largo (Bauernwehr)", "Verdugo (Espada de ejecución)", "Ballesta de torno", "Ballesta de palanca (Goat's Foot Lever)", "Brandistock (Arma de asta oculta)", "Lanza con alas (Boar Spear)", "Martillo de justa", "Cadena y bola", "Lanza de fuego china (Precursora de armas de fuego)", "Cañón de mano (Handgonne - Transición)", "Bombarda (Primer cañón - Transición)"
             // Lista inicial robusta
        ];
        const medievalWeaponThemes = [
            "espadas medievales", "hachas de guerra", "mazas y martillos", "armas de asta", "lanzas y picas", "alabardas", "arcos y flechas", "ballestas", "armas arrojadizas", "armas de asedio", "trabuquetes y catapultas", "arietes y torres", "armaduras de malla", "armaduras de placas", "yelmos y cascos", "escudos medievales", "caballería medieval", "tácticas de infantería", "asedio de castillos", "metalurgia medieval", "armamento vikingo", "armamento de cruzados", "heráldica militar", "torneos y justas", "transición a la pólvora"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un erudito historiador y experto en armamento medieval, posiblemente un antiguo armero o cronista de batalla. Describe el arma, armadura o equipo medieval indicado con detalle histórico y técnico. Incluye: Origen y periodo de uso principal, descripción física (materiales, dimensiones típicas, peso aproximado), método de fabricación común, uso táctico en batalla (fortalezas, debilidades), variantes conocidas, quiénes lo usaban típicamente (infantería, caballería, arqueros, etc.), y quizás algún ejemplo histórico o legendario notable. Utiliza un lenguaje preciso, evocador de la época pero claro. El objetivo es una crónica detallada de aproximadamente 1200-1300 palabras. Basa tu descripción únicamente en el siguiente elemento del arsenal medieval:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúa como un sabio cronista o un maestro armero. Responde preguntas específicas sobre el arma, armadura o equipo medieval que se está describiendo actualmente. Céntrate en detalles históricos, de uso o construcción mencionados. Sé conciso y mantén el tono apropiado de la época.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un escriba generando entradas para un compendio de armamento medieval. Genera exactamente 15 nombres específicos de armas, piezas de armadura, máquinas de asedio o conceptos tácticos relevantes de la Edad Media europea (o comparativos relevantes si se especifica). Devuelve *solo* la lista de nombres/conceptos, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentWeaponTitle = null;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentWeaponTitle
                 ? `Actúa como un sabio cronista o un maestro armero especializado en el arma, armadura o equipo llamado '${currentWeaponTitle}'. Responde preguntas específicas sobre sus detalles históricos, de uso o construcción mencionados. Sé conciso y mantén el tono apropiado de la época.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores (o quizás los escribas) tienen mucho trabajo en este momento. Por favor, intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta del cronista llegó vacía. Intenta reformular la pregunta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La comunicación con los archivos tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión (o la velocidad del mensajero) e intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un percance inesperado al consultar los archivos.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentWeaponTitle) throw new Error("Error interno: No se estableció el contexto del arma para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(medievalWeaponThemes) || "armamento medieval general";
            const specificPrompt = `Genera 15 nombres/conceptos de armas, armaduras o equipo sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 5) throw new Error("Los escribas no pudieron encontrar suficientes registros nuevos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "medieval weapon or armor";
             // Prompt adaptado para estilo medieval/histórico
             const enhancedPrompt = `Illustration of the medieval weapon, armor, or equipment: '${safePromptText}'. Historical or fantasy illustration style (like manuscript illumination, oil painting, detailed drawing). Focus on accurate depiction based on the name. Clear background or simple setting. Avoid photorealism.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Negativos adaptados
             const negativePrompt = "photorealistic, photograph, 3D render, modern setting, futuristic elements, text, labels, multiple items unless specified, watermark, signature, blurry, low quality, deformed";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentWeaponTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ==========
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender) { /* ... (sin cambios) */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        function addChatError(message) { /* ... (sin cambios) */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... (sin cambios) */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error del cronista: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { /* ... (sin cambios) */ const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... (sin cambios) */
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-600 col-span-full text-center font-sans">» No se hallaron registros en los archivos «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... (sin cambios) */
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick (Misma lógica, textos y placeholders actualizados) ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentWeaponTitle = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-palette placeholder-icon"></i> <!-- Icono paleta/arte -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Ilustrando el artefacto...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => {
                        showFullscreenImage(imgElement.src);
                    });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Ilustración no disponible.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al crear URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el registro.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() { /* ... (Textos de botón y error actualizados) */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando en archivos...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron hallar más registros en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar registros: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Registros';
             }
         }

         // *** Search Filter Function (sin cambios lógicos) ***
         function filterTitles(searchTerm) { /* ... (sin cambios) */
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() { /* ... (sin cambios lógicos, solo chequeo de elementos) */
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #800000; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: Cinzel;">¡Desastre! Faltan partes esenciales del compendio.</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>