<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metaficción Desplegada - Laboratorio Narrativo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Literarias/Claras -->
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Metaficción --- */
        :root {
            --color-primary: #8B4513; /* Marrón Sienna (Tinta/Cuero) */
            --color-secondary: #4682B4; /* Azul Acero (Reflexión) */
            --color-tertiary: #B8860B; /* DarkGoldenrod (Detalle/Énfasis) */
            --color-background: #fdf6e3; /* Crema/Pergamino Claro */
            --color-text: #333333; /* Gris Muy Oscuro (Tinta) */
            --color-text-muted: #6c757d; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Nítido */
            --color-border: #dcdcdc; /* Gris Claro (Líneas) */
            --color-error-bg: #fff0f1; /* Fondo error rosa pálido */
            --color-error-text: #a02040; /* Texto error rojo oscuro */
            --color-error-border: #f5c6cb; /* Borde error rosa */

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Lora', serif; font-weight: 600; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 600; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 600; }
        #modal-title { color: var(--color-secondary); font-weight: 600; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-secondary); box-shadow: 0 0 0 3px rgba(70, 130, 180, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-secondary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; }
        .title-item i { margin-right: 0.7rem; color: var(--color-primary); min-width: 15px; text-align: center; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-secondary); background-color: #f0f8ff; /* AliceBlue */ }
        .title-item:hover i { color: var(--color-secondary); }

        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #a0522d; /* Sienna darker */ box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background: #cdcdcd; color: #888888; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(51, 51, 51, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Allow space for chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #eee; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.3rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-family: 'Lato', sans-serif; font-size: 1.05rem; } /* Legibilidad */
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Lora', serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid #eee; padding-bottom: 0.4em; font-weight: 600; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; }
        #modal-content .formula { /* Placeholder for code/formula-like blocks if needed */ font-family: monospace; background-color: #f0f0f0; padding: 0.5em; border-radius: 3px; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; font-family: 'Lato'; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9f9f9; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) #eee;
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: #eee; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-secondary); color: white; margin-left: auto; text-align: left; }
        .ai-message { background-color: #e9ecef; color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 2px rgba(70, 130, 180, 0.15); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #a0522d; }
        #chat-send-btn:disabled { background-color: #cccccc; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-primary); font-size: 1.3rem; font-family: 'Lora'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(50, 50, 50, 0.92); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid white; box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: #333; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-book-open mr-3"></i> <!-- Icono libro -->
                     Metaficción Desplegada
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wide">» Laboratorio Narrativo «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Explorando los Límites de la Historia</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre cómo la narrativa se mira a sí misma. Analiza técnicas, conceptos y efectos de la metaficción.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar concepto, técnica o término...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-quote-left text-brown-600 mr-2"></i> <!-- Icono comillas -->
                 Índice de Conceptos Metaficcionales
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando archivo de conceptos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún concepto encontrado en los archivos «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Solicitar Nuevos Hilos Narrativos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Analizando Concepto...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <h4 class="text-sm font-semibold text-gray-600 mb-2 text-center">Conversar sobre "<span id="chat-context-title">Concepto</span>"</h4>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando pregunta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Haz una pregunta sobre este concepto...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Conceptual Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Análisis generados por IA como herramienta de exploración de la teoría narrativa y la metaficción.</p>
              <p class="mt-1">Consulta fuentes académicas para estudios críticos detallados.</p>
              <p class="mt-2">© 2024 Laboratorio Narrativo Interactivo</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Conceptos Fundamentales
            "¿Qué es la Metaficción?", "Definición de Autoconciencia Narrativa", "Ruptura de la Cuarta Pared", "El Pacto Ficcional y su Ruptura", "Diegesis y Extradiegesis", "Niveles Narrativos (Intradiegético, Metadiegético)", "La Ilusión de Realidad en Ficción", "Ficcionalidad y Verosimilitud", "Distinción entre Autor Real, Autor Implícito y Narrador", "El Lector Implícito y el Lector Real",
            // Técnicas Metaficcionales Comunes
            "Dirección Directa al Lector", "Comentarios del Narrador sobre la Narración", "Personajes Conscientes de ser Ficticios", "El Autor como Personaje en la Obra", "Inclusión del Proceso de Escritura en el Texto", "Uso de Notas a Pie de Página Metaficcionales", "Manuscrito Encontrado (Técnica)", "Historia Dentro de Otra Historia (Mise en Abyme)", "Intertextualidad Explícita (Referencias a otras obras)", "Parodia de Géneros o Estilos", "Pastiche como Homenaje o Crítica", "Listas, Índices o Apéndices Ficticios", "Tipografía y Diseño como Elemento Metaficcional", "Finales Abiertos o Múltiples Comentados", "Prólogos y Epílogos Metaficcionales", "Capítulos Comentados por el Narrador", "Juegos con el Tiempo Narrativo (Analepsis/Prolepsis comentadas)", "Uso de Paréntesis Reflexivos", "Interrupción de la Trama por el Narrador", "Exposición de las Convenciones Narrativas",
            // Tipos Específicos de Metaficción
            "Metaficción Historiográfica", "Metaficción y Ciencia Ficción", "Metaficción en la Literatura Infantil y Juvenil", "Metaficción en el Cómic y Novela Gráfica", "Metaficción en el Cine", "Metaficción en el Teatro", "Metaficción en Videojuegos", "Autoficción como Forma de Metaficción", "Metaficción Lúdica vs. Crítica", "Metaficción Explícita vs. Implícita",
            // Figuras y Conceptos Relacionados
            "El Narrador No Fiable (Unreliable Narrator)", "Metalepsis (Transgresión de Niveles Narrativos)", "Mise en Abyme (Estructura en Abismo)", "Intertextualidad (Diálogo entre Textos)", "Paratexto (Prólogos, Notas, etc.)", "Hipertexto y Narrativa No Lineal", "Fragmentación Narrativa", "Ironía Dramática y Metaficción", "Alegoría de la Escritura/Lectura", "El Papel del Azar Comentado en la Trama",
            // Efectos y Funciones
            "Función Crítica de la Metaficción", "Función Lúdica y Humorística", "Cuestionamiento de la Realidad y la Ficción", "Énfasis en la Artificialidad del Arte", "Involucración Intelectual del Lector", "Distanciamiento Emocional (Efecto Brechtiano)", "Exploración de la Naturaleza del Lenguaje", "Reflexión sobre el Proceso Creativo", "Comentario Social o Político a través de la Forma", "Renovación de Formas Narrativas Tradicionales",
            // Historia y Teóricos
            "Precursores de la Metaficción (Cervantes, Sterne)", "Metaficción en el Modernismo", "Auge de la Metaficción en el Postmodernismo", "Teóricos Clave (Linda Hutcheon, Patricia Waugh)", "Robert Scholes y el 'Fabulismo'", "La Metaficción en la Literatura Latinoamericana (Borges, Cortázar)", "La Metaficción en la Literatura Norteamericana (Barth, Pynchon)", "La Metaficción en Europa (Calvino, Perec)", "Tendencias Actuales en Metaficción", "Relación entre Metaficción y Deconstrucción",
            // Preguntas Analíticas (Ejemplos)
            "¿Cómo identificar la metaficción en un texto?", "Analizando la función de un narrador autoconsciente", "El impacto de la ruptura de la cuarta pared en la inmersión", "¿Qué diferencia a la parodia del pastiche?", "Interpretando la Mise en Abyme", "Consecuencias de la Metalepsis narrativa", "El rol de la intertextualidad en la construcción de significado", "Metaficción y la representación de la historia", "¿Puede la metaficción ser realista?", "La relación entre el autor empírico y su representación ficcional", "Debates críticos sobre la metaficción", "Límites de la autoconciencia narrativa", "¿Cómo afecta la metaficción a la empatía del lector?", "La metaficción como comentario sobre la lectura", "Uso de la metaficción para subvertir expectativas",
             // Variaciones y Combinaciones
            "Narrador Homodiegético Autoconsciente", "Narrador Heterodiegético Intrusivo", "Personaje que lee la novela en la que aparece", "Diálogos entre el autor y sus personajes", "Crítica literaria insertada en la ficción", "Juegos temporales y niveles narrativos", "Parodia de la propia obra del autor", "Metaficción y estructura circular", "La biblioteca como espacio metaficcional", "El espejo como símbolo metaficcional",
            // Más Técnicas Específicas
            "Uso de 'Estimado Lector'", "Confesiones del narrador sobre sus limitaciones", "Discusión sobre opciones narrativas descartadas", "Personajes que se rebelan contra su destino ficcional", "Referencias al soporte físico del libro", "El índice como parte de la ficción", "Glosarios inventados comentados", "Mapas ficticios que se discuten", "Cartas o diarios encontrados y comentados", "Sueños dentro de sueños con comentarios",
            // Conceptos Avanzados/Filosóficos
            "Solipsismo y Metaficción", "Realidad Virtual y Niveles Narrativos", "Teoría de Mundos Posibles y Ficción", "La 'Muerte del Autor' (Barthes) y Metaficción", "El Lenguaje como Protagonista", "Construcción de la Identidad en la Metaficción", "Metaficción y Trauma Narrativo", "El Silencio y lo Indecible en Metaficción", "Ética de la Representación Metaficcional", "Metaficción y el Antropoceno",
             // ... (Continuar expandiendo con más ejemplos, cruces, preguntas y detalles)
            // El objetivo es tener una base muy rica para la exploración
             "El concepto de 'Superficie Narrativa'", "Metaficción Ontológica vs. Epistemológica", "La figura del 'Trickster' como narrador", "Metaficción y lo Gótico", "Metaficción y el Absurdo", "Uso de lenguajes inventados con reflexión", "Gráficos y diagramas como metaficción visual", "El 'Libro Infinito' como tropo", "Narrativas que se auto-borran", "Finales que reescriben el inicio", "Metaficción en la Poesía", "Canciones con letras metaficcionales", "Performance y Metaficción", "Publicidad que rompe la cuarta pared", "El 'Universo Compartido' como forma de metaficción implícita",
             "Análisis de 'Si una noche de invierno un viajero'", "Análisis de 'Niebla' de Unamuno", "Análisis de 'La vida y opiniones del caballero Tristram Shandy'", "Análisis de 'El nombre de la rosa' (elementos metaficcionales)", "Análisis de 'La casa de hojas'", "Análisis de 'El Quijote' como protometaficción", "Análisis de 'Seis personajes en busca de autor'", "Análisis de 'Deadpool' (cine/cómic)", "Análisis de 'Sophie's World'", "Análisis de 'The Stanley Parable' (videojuego)",
             "La autoconciencia en la inteligencia artificial narrativa", "Generación procedural de historias metaficcionales", "Simulaciones dentro de simulaciones", "El personaje consciente de la interfaz de usuario", "Narradores IA que comentan su código", "Metaficción y Realidad Aumentada", "Cruces entre Metaficción y Transmedia", "El 'Glitch' como recurso metaficcional", "Narrativas generadas por el lector comentadas", "El futuro de la metaficción interactiva"
             // ... (Se puede seguir detallando mucho más)
        ];
        const metafictionThemes = [
            "conceptos de metaficción", "ruptura de la cuarta pared", "narradores no fiables", "autoconciencia narrativa", "historias dentro de historias", "mise en abyme", "metalepsis", "intertextualidad", "parodia y pastiche", "autor implícito", "lector implícito", "niveles narrativos", "metaficción historiográfica", "metaficción en cine", "metaficción en videojuegos", "teoría narrativa postmoderna", "Linda Hutcheon", "Patricia Waugh", "Italo Calvino", "Jorge Luis Borges", "Laurence Sterne", "Miguel de Cervantes"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un académico experto en teoría literaria y narratología, especializado en metaficción. Tu tarea es explicar de forma clara, rigurosa y detallada el concepto, técnica o término de metaficción indicado. Define el concepto, explica sus características principales, cómo funciona en una narrativa, qué efectos busca generar en el lector (intelectuales, emocionales, críticos), y menciona brevemente su importancia o ejemplos teóricos clave (sin necesidad de analizar obras específicas a fondo). Utiliza un lenguaje académico pero accesible. El objetivo es una explicación completa de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente concepto o término:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Modelo más rápido para chat
            systemPrompt: "Actúa como un asistente de seminario sobre teoría narrativa. Responde preguntas específicas sobre el concepto metaficcional actualmente en discusión. Proporciona aclaraciones, ejemplos hipotéticos simples o relaciona el concepto con otros términos narrativos si se pregunta. Sé conciso y mantente estrictamente enfocado en el concepto presentado.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de temas para un simposio sobre narrativa. Genera exactamente 15 conceptos, técnicas, preguntas analíticas o términos relacionados con la metaficción y la teoría narrativa contemporánea. Devuelve *solo* la lista, un ítem por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que la versión anterior, pero obteniendo el nuevo #chat-context-title)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const chatContextTitle = document.getElementById('chat-context-title'); // Para mostrar el tema del chat
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentMetafictionConcept = null; // Renombrado para claridad

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentMetafictionConcept
                 ? `Eres un asistente de seminario sobre teoría narrativa. Responde preguntas específicas sobre el concepto metaficcional llamado '${currentMetafictionConcept}'. Proporciona aclaraciones, ejemplos hipotéticos simples o relaciona el concepto con otros términos narrativos si se pregunta. Sé conciso y mantente estrictamente enfocado en este concepto.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, intenta en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o inténtalo más tarde.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La solicitud tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado contactando a la IA.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentMetafictionConcept) throw new Error("Error interno: Contexto del concepto no establecido para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(metafictionThemes) || "metaficción general";
            const specificPrompt = `Genera 15 conceptos, técnicas o preguntas sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "abstract concept of metafiction";
             // Prompt ENFOCADO en lo abstracto/conceptual
             const enhancedPrompt = `Abstract conceptual art representing the idea of '${safePromptText}'. Focus on themes like self-reference, narrative layers, breaking frames, awareness, textuality, deconstruction. Use symbolic imagery, literary motifs (books, ink, mirrors, mazes), abstract shapes. Avoid literal scenes, characters, text, diagrams. Evocative, thought-provoking.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, letters, labels, titles, captions, charts, graphs, diagrams, realistic photograph, person, people, character, specific scene from a book, simple illustration, logo, watermark, signature";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (Sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            // Basic Markdown/formatting corrections
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); // Remove \text{} potentially used by math modes wrongly
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); // Subscripts like H_2O
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); // Superscripts like E=mc^2
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); // Right arrow
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); // Display math (less likely here, but safe)
            formatted = formatted.replace(/\\\(\s*(.*?)\s*\\\)/g, '<span class="formula-inline">$1</span>'); // Inline math (less likely)
            // Headers
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); // H4
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); // H3
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); // H2
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');   // H1
            // Emphasis
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            formatted = formatted.replace(/__(.*?)__/g, '<strong>$1</strong>'); // Bold (alternative)
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');     // Italic
            formatted = formatted.replace(/_(.*?)_/g, '<em>$1</em>');     // Italic (alternative)
            // Lists (basic unordered) - Improve if needed
            formatted = formatted.replace(/^\s*[-*+]\s+(.*)$/gm, '<li>$1</li>');
            formatted = formatted.replace(/(<li>.*<\/li>\s*)+/g, '<ul>$&</ul>'); // Wrap consecutive LIs in UL

            // Paragraphs (handle double line breaks)
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                // If it's already an HTML block (like a list or header), leave it.
                if (block.match(/^\s*<(ul|ol|li|h[1-6]|p|blockquote|pre)/)) {
                    return block;
                }
                // Otherwise, wrap in <p>, replacing single newlines with spaces (or <br> if desired)
                let content = block.replace(/\n/g, ' '); // Replace single newlines with space
                return `<p>${content}</p>`;
            }).join('');

            // Basic blockquote handling
            formatted = formatted.replace(/^>\s+(.*)$/gm, '<blockquote><p>$1</p></blockquote>');
            // Combine adjacent blockquotes (simple version)
             formatted = formatted.replace(/<\/blockquote>\s*<blockquote>/g, '');


            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentMetafictionConcept = null; // Clear context
             chatContextTitle.textContent = 'Concepto'; // Reset chat title placeholder
             // Reset Fullscreen Image
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (Sin cambios funcionales, solo contexto)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            // Basic Markdown (bold/italic) - Keep simple for chat
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { const errDiv=document.createElement('div'); errDiv.classList.add('chat-error'); errDiv.textContent=message; chatHistory.appendChild(errDiv); chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentMetafictionConcept) return; // Check context too

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        // --- Create Title Item with Icon ---
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // Simple heuristic for icons based on keywords
            let iconClass = 'fa-comment-dots'; // Default
            const lowerTitle = title.toLowerCase();
            if (lowerTitle.includes('narrador') || lowerTitle.includes('autor')) iconClass = 'fa-user-edit';
            else if (lowerTitle.includes('lector')) iconClass = 'fa-book-reader';
            else if (lowerTitle.includes('historia') || lowerTitle.includes('trama') || lowerTitle.includes('narrativa')) iconClass = 'fa-stream';
            else if (lowerTitle.includes('cuarta pared') || lowerTitle.includes('metalepsis') || lowerTitle.includes('nivel')) iconClass = 'fa-layer-group';
            else if (lowerTitle.includes('intertextualidad') || lowerTitle.includes('parodia') || lowerTitle.includes('pastiche') || lowerTitle.includes('referencia')) iconClass = 'fa-link';
            else if (lowerTitle.includes('definición') || lowerTitle.includes('concepto') || lowerTitle.includes('¿qué es')) iconClass = 'fa-info-circle';
            else if (lowerTitle.includes('técnica') || lowerTitle.includes('uso') || lowerTitle.includes('cómo')) iconClass = 'fa-cogs';
            else if (lowerTitle.includes('efecto') || lowerTitle.includes('función') || lowerTitle.includes('impacto')) iconClass = 'fa-lightbulb';
            else if (lowerTitle.includes('ejemplo') || lowerTitle.includes('análisis')) iconClass = 'fa-search-plus';
            else if (lowerTitle.includes('cine') || lowerTitle.includes('teatro') || lowerTitle.includes('videojuego')) iconClass = 'fa-film'; // General media

            div.innerHTML = `<i class="fas ${iconClass} fa-fw"></i><span>${title}</span>`; // Use span for text
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Sort alphabetically for consistency
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = ''; // Clear previous/loading
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay conceptos en el archivo «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState(); // Includes clearing chat context and fullscreen img
            showModal();
            modalTitle.textContent = title;
            currentMetafictionConcept = title; // *** SET CHAT CONTEXT ***
            chatContextTitle.textContent = title; // Update chat section title
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Show text + chat

                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is visible
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder WITHIN modalContent
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Generando imagen conceptual...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => { console.error("Img load error:", title); placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al cargar imagen.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { console.error("URL creation failed:", title); placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el concepto.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden'); // Hide chat on main error
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando hilos...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar nuevos hilos narrativos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar hilos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Solicitar Nuevos Hilos Narrativos';
             }
         }

         // *** Search Filter Function (with accent normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !chatContextTitle) {
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: #8B4513; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: Lora, serif;">Error Crítico: Faltan componentes esenciales de la interfaz.</p>';
                 return;
             }
             // Event Listeners
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Initial Load
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>