<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realismo Brutal - La Condición Humana sin Filtros</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes directas, legibles, sin adornos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Realismo Brutal --- */
        :root {
            --color-primary: #4b5563; /* Gris Medio Oscuro */
            --color-secondary: #9ca3af; /* Gris Claro */
            --color-tertiary: #ef4444; /* Rojo Sangre (acento MUY puntual) */
            --color-background: #f3f4f6; /* Gris Muy Claro / Blanco Hueso */
            --color-text: #1f2937; /* Gris Muy Oscuro / Casi Negro */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco puro (contraste duro) */
            --color-border: #d1d5db; /* Borde Gris Claro */
            --color-error-bg: #fef2f2; /* Fondo error rojo muy claro */
            --color-error-text: #991b1b; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 2px; /* Bordes casi rectos */
            --transition-normal: all 0.15s ease-in-out;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto Condensed', sans-serif; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; }
        .logo { color: var(--color-text); }
        h1.page-title { color: var(--color-text); font-weight: 700; border-bottom: 3px solid var(--color-text); display: inline-block; padding-bottom: 0.2rem; }
        h2.section-title { color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 0.8rem; font-weight: 700; text-align: left;}
        #modal-title { color: var(--color-text); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .navbar { background-color: var(--color-background); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Inter'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(75, 85, 99, 0.2); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1rem 0.8rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 60px; font-family: 'Inter'; font-size: 0.95rem; line-height: 1.4; }
        .title-item:hover { background-color: #f9fafb; border-color: var(--color-primary); color: var(--color-text); transform: none; /* Sin efectos 'bonitos' */ box-shadow: var(--shadow-md); }
        .title-item::before { content: ''; display: inline-block; width: 4px; height: 1.5em; background-color: var(--color-border); margin-right: 0.8rem; transition: background-color 0.15s ease; flex-shrink: 0; }
        .title-item:hover::before { background-color: var(--color-primary); }

        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-background); padding: 0.7rem 1.4rem; border: 1px solid var(--color-primary); border-radius: var(--border-radius); font-family: 'Roboto Condensed', sans-serif; font-weight: 700; text-transform: uppercase; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; }
        #generate-more-btn:hover:not(:disabled) { background-color: var(--color-text); border-color: var(--color-text); }
        #generate-more-btn:disabled { background-color: var(--color-border); color: var(--color-text-muted); border-color: var(--color-border); cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-text);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 8px; right: 8px; background: var(--color-border); border: 1px solid var(--color-text); border-radius: var(--border-radius); width: 35px; height: 35px; font-size: 1.5rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-text); color: var(--color-modal-bg); }
        #modal-title { font-size: 1.6rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 8px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 6px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: 0; }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: 0; border: none; }

        #modal-content { padding: 0 5px; font-size: 0.98rem; } /* Texto ligeramente más pequeño, denso */
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-text); font-weight: 600; } /* Menos énfasis en strong */
        #modal-content em { color: var(--color-text); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto Condensed', sans-serif; text-transform: uppercase; margin-top: 2.4em; margin-bottom: 1em; color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 700; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.3em; }
        #modal-content h2 { font-size: 1.2em; }
        #modal-content h3 { font-size: 1.1em; }
        #modal-content h4 { font-size: 1.0em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 90%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: none; cursor: pointer; transition: opacity 0.2s ease; filter: grayscale(80%); /* Imagen menos saturada */}
        #modal-content .final-image:hover { opacity: 0.9; filter: grayscale(50%);}
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); border: 1px dashed var(--color-border); padding: 1rem; }
        #modal-content .image-placeholder .spinner { border: 3px solid var(--color-border); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1.2s linear infinite; margin-bottom: 0.7rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: var(--color-background); scroll-behavior: smooth; font-size: 0.9rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 5px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 90%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--color-secondary); color: var(--color-text); margin-left: auto; text-align: left; font-weight: 400;}
        .ai-message { background-color: #e5e7eb; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; border: 1px solid var(--color-border); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.85em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Inter'; font-size: 0.9rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 1px var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-text); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 4px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.1rem; font-family: 'Roboto Condensed'; text-transform: uppercase; letter-spacing: 1px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Inter'; font-size: 0.95rem; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 1rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 1px solid var(--color-border); box-shadow: var(--shadow-md); filter: grayscale(80%); /* Mantener filtro en fullscreen */}
        #fullscreen-close-btn { position: absolute; top: 15px; right: 15px; background: var(--color-modal-bg); border: 1px solid var(--color-text); border-radius: var(--border-radius); width: 38px; height: 38px; font-size: 1.6rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-text); color: var(--color-modal-bg); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="far fa-eye mr-2"></i> <!-- Icono ojo observador -->
                     REALISMO BRUTAL
                 </h1>
             </div>
             <span class="text-xs text-gray-600 font-sans tracking-wider">LA CONDICIÓN HUMANA SIN FILTROS</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-10 text-left border-b border-gray-300 pb-6">
             <h1 class="page-title text-4xl sm:text-5xl mb-3">Exploraciones Crudas</h1>
             <p class="text-lg text-gray-700 mb-6 max-w-3xl font-light">Retratos sin tapujos de la existencia cotidiana. La verdad incómoda, la lucha diaria, la belleza áspera de lo real.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-8 max-w-xl">
             <input type="text" id="search-input" placeholder="Buscar situación, personaje, concepto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6">
                 Fragmentos de Realidad
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-base font-sans italic">Cargando fragmentos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-base mt-4 hidden font-sans italic">» Ningún fragmento coincide con la búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Observar Más Fragmentos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Analizando fragmento...</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder appended here -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Preguntar sobre este fragmento...">
                         <button id="chat-send-btn" aria-label="Enviar Pregunta">
                             <i class="fas fa-angle-right"></i> <!-- Icono simple de enviar -->
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-circle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-600 py-5 mt-12 border-t border-gray-300 font-sans">
          <div class="container mx-auto px-4 text-center text-xs">
              <p>Observaciones generadas por IA, inspiradas en el realismo brutal. Ficción destinada a la reflexión.</p>
              <p class="mt-1">Cualquier parecido con personas o eventos reales es incidental o interpretativo.</p>
              <p class="mt-2">© [Año Actual] - Archivo de Realidad Cruda</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Luchas Económicas / Laborales
            "El Desahucio Inminente", "Trabajo Precario, Sueldo Mínimo", "La Deuda que Ahoga", "Desempleo Crónico", "Turno de Noche en la Fábrica", "La Oficina Gris y Monótona", "Buscar Trabajo a los 50", "El Comerciante Arruinado", "Vivir al Día", "La Cola del Paro", "Recortes de Personal", "El Peso del Autónomo", "Competencia Laboral Desleal", "Jubilación Insuficiente", "Explotación en el Campo", "El Sueño Roto del Emprendedor", "Trabajar Enfermo", "La Carga de Múltiples Empleos", "El Fin de Mes Eterno", "Contrato Basura", "Negociar el Salario", "El Miedo al Despido", "La Presión por Producir", "Accidente Laboral", "Burocracia para Cobrar el Subsidio", "Sin Papeles, Sin Derechos", "Comedor Social", "El Trueque como Subsistencia", "Vender las Pertenencias", "La Sombra del Embargo",
            // Relaciones (Crudas)
            "La Indiferencia Conyugal", "Infidelidad Descubierta", "Divorcio Conflictivo", "La Soledad en Pareja", "Amor No Correspondido (Obsesivo)", "Familia Disfuncional", "El Rencor entre Hermanos", "Padres Ausentes", "Madre Soltera Agotada", "Hijos Problemáticos", "Cuidar a Padres Ancianos (Resentimiento)", "Amistad Rota por Dinero", "La Traición del Mejor Amigo", "El Silencio Incómodo", "Discusión Violenta", "Manipulación Emocional", "Dependencia Afectiva", "Secretos Familiares", "El Peso de las Expectativas Familiares", "La Rutina que Mata la Pasión", "Celos Patológicos", "Incomprensión Generacional", "Criar Hijos en la Pobreza", "El Estigma del Divorciado", "Volver a Casa de los Padres", "La Carga de Ser el Fuerte", "Amor Tóxico", "Perdonar lo Imperdonable", "El Vacío Tras la Pérdida", "La Fachada de la Familia Feliz",
            // Problemas Sociales / Sistémicos
            "Vivir en un Barrio Marginal", "Gentrificación y Desplazamiento", "Racismo Cotidiano", "Homofobia Interiorizada", "Machismo Estructural", "Burocracia Kafkiana", "Sistema Sanitario Colapsado", "Lista de Espera Médica Interminable", "La Cárcel por Dentro", "Salir de Prisión y No Tener Nada", "Adicción a las Drogas (Sin Glamour)", "Alcoholismo Oculto", "Ludopatía y Ruina", "La Indiferencia de los Vecinos", "Corrupción a Pequeña Escala", "La Trampa de las Ayudas Sociales", "Sistema Educativo Deficiente", "Abandono Escolar", "Contaminación Ignorada", "Infravivienda", "Soledad en la Gran Ciudad", "El Anonimato Urbano", "Prostitución Forzada", "Trata de Personas (La Víctima)", "La Crueldad en Redes Sociales", "Noticias Falsas y sus Consecuencias", "Desigualdad Social Evidente", "Indigencia Visible", "Sistema Judicial Lento e Injusto", "Violencia Doméstica Silenciada",
            // Estados Psicológicos / Existenciales
            "Ansiedad Paralizante", "Depresión Profunda (Sin Causa Aparente)", "Ataque de Pánico en Público", "Estrés Postraumático (Consecuencias Diarias)", "Insomnio Crónico", "Apatía Generalizada", "Cinismo como Defensa", "Miedo al Futuro", "Sentimiento de Vacío Existencial", "La Crisis de la Mediana Edad (Real)", "Obsesión Compulsiva", "Paranoia y Desconfianza", "El Peso de la Culpa", "Memoria Selectiva (Para Sobrevivir)", "Disociación de la Realidad", "Pensamientos Suicidas Pasivos", "La Lucha Contra la Propia Mente", "Vergüenza y Autoestima Baja", "Envidia Corrosiva", "Arrepentimiento Tardío", "Pérdida de Identidad", "El Síndrome del Impostor", "La Carga del Secreto", "Neurosis Cotidiana", "Trastorno Alimenticio (La Realidad)", "Aislamiento Voluntario", "Fobia Social", "Sentirse un Fraude", "La Banalidad del Mal Cotidiano", "Perder la Fe (En Todo)",
            // Cuerpo, Enfermedad, Mortalidad
            "Enfermedad Crónica Degenerativa", "El Diagnóstico Terminal", "Dolor Físico Constante", "Envejecimiento y Deterioro", "La Menopausia (Real)", "La Andropausia (Real)", "Accidente y Secuelas Físicas", "Cuidar a un Enfermo Terminal", "La Muerte de un Ser Querido (El Duelo Crudo)", "El Miedo a la Muerte Propia", "Obesidad y Problemas de Salud", "Anorexia (La Lucha Diaria)", "El Cuerpo que Traiciona", "La Pérdida de Facultades", "Visita al Hospital (La Espera)", "Tratamiento Médico Agresivo", "La Cicatriz Visible", "El Olor a Desinfectante", "Rehabilitación Física Lenta", "Dependencia Física de Otros", "La Confrontación con la Propia Mortalidad", "Decadencia Física Prematura", "El Tabú de la Vejez", "Problemas Dentales Ignorados", "La Vergüenza del Propio Cuerpo", "Incontinencia", "Perder la Vista/Oído", "El Hospital como Segundo Hogar", "Cuidados Paliativos", "La Autopsia (Desde Fuera)",
            // Ambientes / Situaciones
            "Viaje en Transporte Público Hora Punta", "Atasco Infinito", "Piso Compartido Caótico", "La Sala de Espera del Médico", "Comida Rápida Solitaria", "Supermercado Día de Cobro", "La Oficina de Empleo", "El Bar de Siempre (Decadente)", "Paisaje Urbano Degradado", "Edificio Abandonado", "Parque Descuidado", "La Playa en Invierno (Gris)", "Pueblo Olvidado", "Carretera Secundaria Solitaria", "Institución Mental (Rutina)", "Residencia de Ancianos (Olor y Sonido)", "Comisaría de Policía (La Espera)", "Juzgado de Guardia", "Lavandería Automática Nocturna", "Gimnasio Barato y Sudoroso", "Chatarrería", "Vertedero Cercano", "Matadero (El Olor)", "Mercado Callejero (El Caos)", "Vecindario Ruidoso", "Apagón Eléctrico", "Inundación en el Sótano", "Plaga de Insectos", "Perro Callejero Enfermo", "Basura Acumulada",
             // Títulos adicionales generados aleatoriamente (para ejemplo):
             "El olor a lejía en la escalera", "La mancha en la pared que nadie limpia", "El ruido del vecino de arriba", "Esperar el autobús bajo la lluvia", "La comida recalentada por tercera vez", "Pagar las facturas a última hora", "La conversación forzada en el ascensor", "Mirar fotos antiguas con nostalgia amarga", "El último cigarrillo del paquete", "La ropa tendida en el balcón pequeño", "Coleccionar objetos inútiles", "El reflejo en un escaparate sucio", "Perder las llaves otra vez", "La televisión como única compañía", "El goteo constante del grifo", "Mentiras piadosas que se enquistan", "El polvo acumulado en los muebles", "La llamada que nunca llega", "Vigilar el móvil compulsivamente", "La rutina del domingo por la tarde", "Hacer la compra con lo justo", "El espejo del baño empañado", "Las canas que aparecen de golpe", "El silencio después de colgar", "Buscar monedas en los bolsillos", "La grieta en el techo", "El tic nervioso incontrolable", "Caminar sin rumbo fijo por la ciudad", "La visita incómoda al familiar enfermo", "El libro a medias desde hace meses"
            // (...) Se necesitarían muchos más para 400, el botón "Generar Más" es clave aquí.
        ];
        const realismThemes = [
            "la lucha económica diaria", "relaciones familiares tensas", "la soledad urbana", "problemas de adicción", "la precariedad laboral", "la enfermedad y el cuerpo", "la burocracia aplastante", "la desilusión vital", "el envejecimiento sin filtros", "conflictos vecinales", "la rutina alienante", "la salud mental ignorada", "secretos y mentiras cotidianas", "la violencia invisible", "el peso del pasado", "la dificultad de la comunicación", "entornos urbanos degradados", "la búsqueda de sentido en lo mundano", "la fragilidad humana", "pequeñas miserias diarias"
        ];
        const textApiConfig = { // Descripción principal
            model: "mistral",
            systemPrompt: "Actúa como un observador implacable de la condición humana, adscrito al realismo brutal. Describe la situación, personaje o concepto indicado ([TITULO]) con una mirada directa, cruda y sin concesiones. Enfócate en los detalles sensoriales ásperos (olores, texturas, sonidos desagradables o monótonos), las emociones reprimidas o contradictorias, las motivaciones grises, las consecuencias prácticas y psicológicas, la ausencia de soluciones fáciles o heroísmo. Evita el sentimentalismo, la moralización explícita, el lenguaje embellecedor o poético. Usa un tono directo, objetivo, casi forense o documental. Profundiza en la banalidad o la crudeza del momento. Extensión: 1200-1300 palabras. El foco único es:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Chat
            model: "mistral-tiny",
             systemPrompt: "Eres un interlocutor directo y analítico, centrado en el realismo brutal. Responde preguntas sobre '[TITULO]' manteniendo la perspectiva cruda y sin adornos de la descripción principal. Céntrate en los hechos observables, las implicaciones lógicas, las contradicciones humanas. Evita respuestas optimistas, evasivas o moralizantes. Sé conciso y pertinente al fragmento discutido.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Genera 15 títulos o conceptos concisos para escenas o retratos de realismo brutal. Enfócate en la condición humana sin filtros: luchas diarias, relaciones complejas, entornos urbanos/rurales crudos, estados psicológicos difíciles, la banalidad de la existencia. Usa lenguaje directo, evocador pero no sentimental. Uno por línea.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Renombrado para claridad temática

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Eres un interlocutor directo y analítico, centrado en el realismo brutal. Responde preguntas sobre '${currentTopicTitle}' manteniendo la perspectiva cruda y sin adornos de la descripción principal. Céntrate en los hechos observables, las implicaciones lógicas, las contradicciones humanas. Evita respuestas optimistas, evasivas o moralizantes. Sé conciso y pertinente al fragmento discutido.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                      throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento. Por favor, intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o selecciona otro fragmento.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(topicTitle) {
            return fetchTextFromApi(topicTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentTopicTitle) throw new Error("Error interno: Contexto del fragmento no establecido para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(realismThemes) || "la condición humana general";
            const specificPrompt = `Genera 15 títulos o conceptos concisos sobre ${randomTheme} desde la perspectiva del realismo brutal.`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes fragmentos nuevos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 533, /* Ratio más foto */ nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "escena cotidiana cruda";
            // Prompt enfocado en B&W, documental, crudo
            const enhancedPrompt = `Black and white, gritty realistic photograph capturing the essence of '${safePromptText}'. Documentary style, high contrast or muted tones, focus on texture, unposed subjects, harsh reality, mundane details, decaying environment. Avoid color, staging, romanticism, filters, beauty.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "color, vibrant, beautiful, aesthetic, clean, minimalist, illustration, drawing, painting, CGI, 3D render, romantic, happy, smiling people, posed, staged, soft focus, blurry, text, words, label";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios funcionales)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                // Para realismo brutal, mantener saltos de línea internos puede ser estilísticamente apropiado a veces.
                // Podríamos decidir si convertirlos a <br> o espacios. Probemos con espacios por defecto.
                let content = block.replace(/\n/g, ' '); // Reemplaza saltos internos con espacio
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (sin cambios funcionales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios funcionales)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios funcionales)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ========== (sin cambios funcionales, textos adaptados)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        // function shuffleArray(array) { ... } // No parece usarse, se puede quitar si no es necesario
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Para realismo brutal, quizás el orden alfabético no es tan relevante como el orden "natural" o aleatorio.
             // Mantengamos el orden alfabético por consistencia y facilidad de búsqueda por ahora.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans italic">» No hay fragmentos disponibles «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Reaplicar filtro
         }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // Set context for chat
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;

                // Add image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="far fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando instantánea...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Create and load image
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Instantánea visual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    placeholderDiv.innerHTML = `<i class="fas fa-ban placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Instantánea no disponible.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el fragmento.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se encontraron más fragmentos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar fragmentos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Observar Más Fragmentos';
             }
         }

         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check essential elements
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #991b1b; font-size: 1.2em; text-align: center; padding: 3em; font-family: monospace;">ERROR CRÍTICO: FALLO AL CARGAR COMPONENTES DE INTERFAZ.</p>';
                return;
             }
            // Add listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
             // Actualizar año en footer
             const currentYear = new Date().getFullYear();
             const footerYearElement = document.querySelector('footer p:last-child');
             if (footerYearElement) {
                 footerYearElement.textContent = `© ${currentYear} - Archivo de Realidad Cruda`;
             }

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>