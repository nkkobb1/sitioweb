<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leyendas de la Atlántida - Archivos Perdidos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Temáticas -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Atlantis --- */
        :root {
            --color-primary: #00bcd4; /* Aqua/Teal */
            --color-secondary: #ffc107; /* Oro/Ámbar */
            --color-tertiary: #80deea; /* Azul Hielo Claro */
            --color-background: #f5f5f5; /* Arena Muy Claro / Blanco Roto */
            --color-text: #263238; /* Gris Azulado Oscuro */
            --color-text-muted: #546e7a; /* Gris Azulado Medio */
            --color-modal-bg: #003949; /* Azul Muy Oscuro Profundo */
            --color-modal-text: #e0f7fa; /* Texto Modal: Cyan Muy Claro */
            --color-modal-text-muted: #b0bec5; /* Texto Modal Muted: Gris Azulado Claro */
            --color-border: #b0bec5; /* Borde Gris Claro */
            --color-modal-border: #007a8a; /* Borde Modal: Teal Oscuro */
            --color-error-bg: #4a1c1c; /* Fondo Error Rojo Muy Oscuro */
            --color-error-text: #ffcdd2; /* Texto Error Rojo Claro */
            --color-error-border: #e57373; /* Borde Error Rojo Claro */

            --shadow-sm: 0 2px 4px rgba(0, 188, 212, 0.1);
            --shadow-md: 0 5px 10px rgba(0, 188, 212, 0.15);
            --shadow-lg: 0 10px 20px rgba(0, 188, 212, 0.2), 0 0 15px rgba(255, 193, 7, 0.3); /* Sombra con toque dorado */
            --border-radius: 5px; /* Bordes suaves */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel Decorative', cursive; font-weight: 700; letter-spacing: 1px; }
        .logo { color: #006064; /* Teal muy oscuro */ }
        h1.page-title { color: #00796b; /* Teal oscuro */ font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; text-shadow: 0 0 5px rgba(255, 193, 7, 0.5); }
        .navbar { background-color: rgba(224, 247, 250, 0.9); /* Fondo Cian muy claro translúcido */ backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #ffffff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.2); outline: none; background-color: #ffffff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: #ffffff; padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid #e0e0e0; /* Borde gris más claro */ display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Lato'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-4px) scale(1.02); box-shadow: var(--shadow-md); border-color: #bdbdbd; color: var(--color-primary); background-color: #e0f7fa; /* Fondo hover cian muy claro */ border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-tertiary)); color: var(--color-text); padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel Decorative', cursive; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: none; box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-tertiary), var(--color-primary)); box-shadow: var(--shadow-md); transform: scale(1.03); color: #004d40; /* Teal más oscuro */ }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: inherit; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 57, 73, 0.95); /* Overlay azul oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-modal-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Suficiente para juego y chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            color: var(--color-modal-text);
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-modal-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-modal-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-modal-bg); transform: rotate(90deg); box-shadow: 0 0 10px var(--color-primary); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; color: var(--color-secondary); /* Título en dorado */ }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(0, 122, 138, 0.3);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(0, 122, 138, 0.3); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-modal-border); }

        #modal-content { padding: 0 5px; color: var(--color-modal-text); }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel Decorative', cursive; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-tertiary); border-bottom: 1px solid var(--color-modal-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; color: var(--color-primary); }
        #modal-content h3 { font-size: 1.2em; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-modal-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-secondary); border-radius: var(--border-radius); box-shadow: 0 0 15px rgba(255, 193, 7, 0.4); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-modal-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(176, 190, 197, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-modal-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; /* Reducir un poco si es necesario */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-modal-border); border-radius: var(--border-radius); background-color: rgba(0, 30, 40, 0.7); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(0, 122, 138, 0.3);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(0, 122, 138, 0.3); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--color-secondary); color: var(--color-modal-bg); margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #004d40; /* Teal oscuro */ color: var(--color-modal-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-modal-border); background-color: #004d40; color: var(--color-modal-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input::placeholder { color: var(--color-modal-text-muted); }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-modal-bg); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-tertiary); }
        #chat-send-btn:disabled { background-color: var(--color-modal-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-modal-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* --- Loading Modal con Minijuego --- */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 57, 73, 0.98); /* Fondo azul oscuro casi opaco */
            display: flex; /* Usa flex para centrar */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 55; /* Encima del contenido pero debajo del close btn */
            border-radius: var(--border-radius);
            padding: 1rem;
            color: var(--color-modal-text);
        }
        #loading-game-canvas {
            border: 1px solid var(--color-primary);
            background-color: #002b36; /* Fondo del juego aún más oscuro */
            display: block; /* Necesario para que funcione bien */
            margin-bottom: 1rem; /* Espacio antes del texto */
            max-width: 90%;
             /* El tamaño se establecerá en JS */
        }
        #loading-game-text {
            font-weight: 400;
            font-size: 1.1rem;
            font-family: 'Lato', sans-serif;
            text-align: center;
        }
        #loading-game-text span { /* Para el título */
            color: var(--color-secondary);
            font-weight: 700;
            display: block;
            margin-top: 0.5rem;
        }
        /* Ocultar spinner original si existiera */
        .loading-spinner-modal { display: none; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay (Sin cambios funcionales, solo estéticos) */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 57, 73, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-secondary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-modal-bg); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-water mr-3 text-blue-700"></i> <!-- Icono agua -->
                     Atlántida: Archivos Perdidos
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Enciclopedia de Mitos y Leyendas «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora los Secretos de la Ciudad Sumergida</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Navega por los relatos perdidos, tecnologías olvidadas y misterios insondables de la legendaria Atlántida.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar leyenda, lugar o artefacto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-landmark text-cyan-600 mr-2"></i> <!-- Icono ruina/monumento -->
                 Índice de Relatos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Descifrando códices antiguos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún registro coincide con la búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar Más Fragmentos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator (Ahora contiene el juego) -->
             <div id="modal-loading">
                 <canvas id="loading-game-canvas" width="300" height="150">Tu navegador no soporta Canvas.</canvas>
                 <p id="loading-game-text">Cargando datos... <br>¡Evita los pilares! (Espacio/Tap para ascender)<span id="game-score"></span></p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando oráculos...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta leyenda...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-blue-50 text-blue-gray-600 py-6 mt-12 border-t border-blue-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Relatos ficticios generados por IA, inspirados en los mitos y especulaciones sobre la Atlántida.</p>
              <p class="mt-1">Esta información es puramente especulativa y para entretenimiento.</p>
              <p class="mt-2">© <span id="footer-year"></span> Archivos Perdidos de la Atlántida</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Ubicaciones Clave
            "El Palacio Real de Poseidón", "El Templo Mayor de Cleito y Poseidón", "Los Anillos Concéntricos de Atlantis", "Los Astilleros de la Flota Atlante", "El Gran Canal de Navegación", "La Acrópolis Central", "Los Jardines Colgantes de Evenor", "El Laberinto Subterráneo de Orichalcum", "Las Minas de Orichalcum", "El Observatorio Astronómico Celestial", "La Biblioteca de los Saberes Perdidos", "Los Distritos Residenciales Nobles", "Los Barrios Artesanales", "El Coliseo de los Juegos Acuáticos", "Las Murallas Exteriores de Orichalcum", "El Puerto Comercial Principal", "Las Cámaras de Cristal de Poder", "El Santuario de los Ancestros", "Los Acueductos Elevados", "Las Granjas Hidropónicas Submarinas",
            // Tecnología y Ciencia
            "Fuentes de Energía de Orichalcum", "Cristales de Poder Atlantes", "Vehículos Voladores (Vimanas Atlantes)", "Submarinos Silenciosos de Exploración", "Armamento Sónico Subacuático", "Escudos de Energía Defensivos", "Sistemas de Control Climático", "Ingeniería Genética Atlante (Quimeras?)", "Medicina Regenerativa Avanzada", "Comunicadores de Cristal", "Dispositivos de Levitación Magnética", "Robots y Autómatas de Servicio", "Tecnología de Portales Dimensionales (Teoría)", "Armas de Energía Dirigida (Plasma/Láser)", "Sistemas de Holografía Realista", "Trajes de Inmersión Profunda Auto-contenidos", "Materiales de Construcción Auto-reparables", "Generadores Gravitacionales", "Dispositivos de Traducción Universal", "Red de Información Basada en Cristales",
            // Cultura y Sociedad
            "El Sistema de Gobierno de los Diez Reyes", "La Jerarquía Sacerdotal Atlante", "Las Leyes y Códigos de Conducta", "Festivales y Celebraciones Religiosas", "El Arte y la Música Atlante", "La Filosofía y Ética Atlante", "El Sistema Educativo para Iniciados", "La Vida Diaria de un Ciudadano Atlante", "El Rol de la Mujer en la Sociedad Atlante", "Las Castas Sociales (Guerreros, Científicos, Artesanos)", "Rituales de Iniciación y Misterios", "La Gastronomía Atlante", "Deportes y Entretenimiento", "Creencias sobre la Vida después de la Muerte", "La Relación con la Naturaleza y el Océano", "El Lenguaje Escrito (Glifos Atlantes)", "Vestimenta y Moda Atlante", "Arquitectura Monumental", "La Importancia del Orichalcum en la Cultura", "Tradiciones Orales y Mitos Fundacionales",
            // Mitos y Leyendas
            "La Creación de Atlantis por Poseidón", "La Historia de Atlas, el Primer Rey", "La Guerra contra los Atenienses Primitivos", "La Hibris Atlante y la Ira de los Dioses", "El Gran Cataclismo: Terremotos e Inundaciones", "Teorías sobre la Ubicación de Atlantis (Atlántico, Mediterráneo, etc.)", "Los Supervivientes de Atlantis y su Legado", "La Búsqueda del Orichalcum Perdido", "El Kraken como Guardián de Atlantis", "Sirenas y Tritones en la Mitología Atlante", "El Velo de Invisibilidad que Oculta la Ciudad", "Profecías sobre el Regreso de Atlantis", "El Corazón de Atlantis (Cristal Maestro)", "Las Criaturas Bio-diseñadas de los Laboratorios", "El Viaje de Platón y el Relato de Critias", "Contactos con Civilizaciones Extraterrestres (Teoría)", "La Maldición de los Dioses sobre la Ciudad", "Portales a Otros Mundos en Atlantis", "Los Fantasmas de los Reyes Atlantes", "El Secreto de la Inmortalidad Atlante (Rumor)",
            // Personajes Ficticios / Arquetipos
            "El Último Rey Sabio de Atlantis", "La Gran Sacerdotisa Guardiana del Cristal", "El Científico Rebelde que Advirtió del Peligro", "El General Ambicioso que Desató la Guerra", "La Exploradora Moderna que Encuentra las Ruinas", "El Descendiente Secreto de los Atlantes", "El Guardián Eterno de la Biblioteca Perdida", "La Reina Guerrera de una Colonia Atlante", "El Comerciante que Traficaba Tecnología Prohibida", "El Artista que Capturó la Esencia de la Ciudad", "El Oráculo Ciego que Predijo la Caída", "El Joven Héroe que Intenta Salvar la Ciudad", "El Espía Ateniense Infiltrado", "El Autómata con Conciencia Propia", "El Monstruo Marino Protector",
            // Expediciones y Descubrimientos Ficticios
            "La Expedición Submarina 'Proyecto Poseidón'", "El Hallazgo del Diario de un Sacerdote Atlante", "El Descubrimiento de un Mapa Estelar Atlante", "La Activación Accidental de Tecnología Antigua", "El Encuentro con Descendientes Aislados", "El Rescate de Artefactos de Orichalcum", "La Traducción de los Glifos Prohibidos", "La Localización de una Colonia Perdida en la Antártida", "El Uso Moderno de la Energía Atlante", "El Peligro de Despertar a los Guardianes", "La Carrera Internacional por los Secretos Atlantes", "El Impacto del Descubrimiento en la Sociedad Moderna", "La Conexión entre Atlantis y Otras Civilizaciones Antiguas (Mu, Lemuria)", "El Misterio de las Esferas de Piedra Gigantes (Origen Atlante?)", "La Evidencia Geológica del Cataclismo",
            // Conceptos Adicionales
            "Orichalcum: Propiedades y Usos", "La Red Energética Global Atlante", "El Concepto del 'Alma Colectiva' Atlante", "Influencia Atlante en Culturas Posteriores (Egipto, Mayas)", "Paralelismos entre Atlantis y Otras Utopías/Distopías", "La Atlántida como Metáfora de la Civilización", "El Peligro de la Tecnología Descontrolada", "La Búsqueda Espiritual en la Tradición Atlante", "Formas de Vida Inteligente Submarina Aliadas/Enemigas", "El Campo de Fuerza que Protege/Oculta las Ruinas", "Teorías de la Conspiración sobre Atlantis", "Representaciones de Atlantis en la Cultura Popular", "Viajes en el Tiempo y Atlantis", "Dimensiones Paralelas y Atlantis", "El Legado Genético Atlante en la Humanidad",
            // Más ideas abstractas
            "La Melancolía de la Ciudad Perdida", "El Eco de las Voces Atlantes", "La Sombra de Poseidón", "El Brillo Eterno del Orichalcum", "El Secreto Sumergido", "Memorias del Océano Profundo", "El Último Amanecer sobre Atlantis", "Fragmentos de un Sueño Dorado", "La Promesa Rota de los Dioses", "Cuando el Mar Reclamó su Reino"
            // (Approx 200+ initial titles)
        ];
        const atlantisThemes = [
            "mitos de la Atlántida", "tecnología atlante", "orichalcum", "ubicación de Atlantis", "el cataclismo atlante", "sociedad atlante", "reyes de Atlantis", "Poseidón y Atlantis", "exploraciones submarinas a Atlantis", "artefactos atlantes", "cristales de poder atlantes", "supervivientes de Atlantis", "la guerra Atenas-Atlantis", "Platón y Atlantis", "criaturas míticas de Atlantis", "arquitectura atlante", "vida diaria en Atlantis", "colonias perdidas de Atlantis", "secretos de la ciudad sumergida", "energía atlante"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un historiador especializado en mitos, un arqueólogo de lo imposible y un narrador de leyendas perdidas. Tu foco es la Atlántida. Desarrolla una historia ficticia, una descripción detallada o una exploración conceptual sobre el tema específico de Atlantis que se te indique. Sumérgete en detalles evocadores: Describe la posible tecnología, la arquitectura grandiosa, la sociedad compleja, los personajes legendarios o los eventos míticos. Enfatiza el misterio, la maravilla y la tragedia inherente a la leyenda. Sé creativo y coherente dentro del universo ficticio de Atlantis. El objetivo es un relato o descripción rica de aproximadamente 1200-1300 palabras. Basa tu narrativa únicamente en el siguiente aspecto de la Atlántida:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un erudito de la Atlántida, un PNJ en esta enciclopedia. Responde preguntas específicas sobre el tema (leyenda, lugar, artefacto) que se está mostrando actualmente. Mantén el tono misterioso y erudito. Sé conciso y céntrate estrictamente en el tópico actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
             // *** MODIFIED Prompt to request 40 titles ***
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia sobre la Atlántida. Genera exactamente 40 nombres evocadores de leyendas, lugares, tecnologías, personajes o conceptos relacionados con la Atlántida ficticia, adecuados para una descripción detallada. Devuelve *solo* la lista, una por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Slightly longer timeout for more titles
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, pero añadiendo elementos del juego)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        const footerYear = document.getElementById('footer-year');

        // --- Game Elements ---
        const gameCanvas = document.getElementById('loading-game-canvas');
        const gameScoreDisplay = document.getElementById('game-score');
        const gameCtx = gameCanvas.getContext('2d');

        // ========== State Variables ==========
        let currentAtlantisTopic = null;
        // --- Game State ---
        let gameLoopId = null;
        let player, obstacles, score, gameSpeed, isGameOver;

        // ========== MINIGAME LOGIC ==========
        const playerProps = { x: 50, y: 75, width: 30, height: 20, dy: 0, gravity: 0.3, lift: -5, color: 'yellow' }; // Submarino simple
        const obstacleProps = { width: 20, gap: 65, color: '#80deea', speedIncrement: 0.001 };
        const gameArea = { width: gameCanvas.width, height: gameCanvas.height };

        function resetGame() {
            player = { ...playerProps, y: gameArea.height / 2, dy: 0 }; // Start in middle
            obstacles = [];
            score = 0;
            gameSpeed = 2;
            isGameOver = false;
            gameScoreDisplay.textContent = ''; // Clear score display initially
        }

        function addObstacle() {
            // Pillar height calculation
            const minHeight = 20;
            const maxHeight = gameArea.height - obstacleProps.gap - minHeight;
            const heightTop = Math.floor(Math.random() * (maxHeight - minHeight + 1)) + minHeight;
            const heightBottom = gameArea.height - heightTop - obstacleProps.gap;

            obstacles.push({
                x: gameArea.width,
                yTop: 0,
                heightTop: heightTop,
                yBottom: heightTop + obstacleProps.gap,
                heightBottom: heightBottom,
                width: obstacleProps.width,
                color: obstacleProps.color,
                passed: false
            });
        }

        function updateGame() {
            if (isGameOver) return;

            // Player physics
            player.dy += player.gravity;
            player.y += player.dy;

            // Keep player in bounds
            if (player.y + player.height > gameArea.height) {
                player.y = gameArea.height - player.height;
                player.dy = 0;
                // isGameOver = true; // Game over if hits bottom
            }
            if (player.y < 0) {
                player.y = 0;
                player.dy = 0;
                 // isGameOver = true; // Game over if hits top
            }


            // Obstacles
            if (obstacles.length === 0 || obstacles[obstacles.length - 1].x < gameArea.width - 150 - Math.random()*50) { // Add new obstacles spaced out
                 addObstacle();
            }

            obstacles.forEach(obs => {
                obs.x -= gameSpeed;

                // Collision detection
                const playerRect = { x: player.x, y: player.y, width: player.width, height: player.height };
                const topObsRect = { x: obs.x, y: obs.yTop, width: obs.width, height: obs.heightTop };
                const bottomObsRect = { x: obs.x, y: obs.yBottom, width: obs.width, height: obs.heightBottom };

                if (rectsOverlap(playerRect, topObsRect) || rectsOverlap(playerRect, bottomObsRect) || player.y <= 0 || player.y + player.height >= gameArea.height) {
                     isGameOver = true;
                 }


                // Scoring
                if (!obs.passed && obs.x + obs.width < player.x) {
                    score++;
                    obs.passed = true;
                    gameScoreDisplay.textContent = `Score: ${score}`; // Update score display
                    gameSpeed += obstacleProps.speedIncrement; // Increase speed slightly
                }
            });

            // Remove off-screen obstacles
            obstacles = obstacles.filter(obs => obs.x + obs.width > 0);
        }

        function drawGame() {
            // Clear canvas
            gameCtx.fillStyle = '#002b36'; // Dark bg
            gameCtx.fillRect(0, 0, gameArea.width, gameArea.height);

            // Draw Player (simple sub)
            gameCtx.fillStyle = player.color;
            gameCtx.fillRect(player.x, player.y, player.width, player.height);
            // Simple "window"
            gameCtx.fillStyle = 'white';
            gameCtx.fillRect(player.x + player.width * 0.6, player.y + player.height * 0.3, 5, 5);


            // Draw Obstacles (pillars)
            obstacles.forEach(obs => {
                gameCtx.fillStyle = obs.color;
                gameCtx.fillRect(obs.x, obs.yTop, obs.width, obs.heightTop); // Top pillar
                gameCtx.fillRect(obs.x, obs.yBottom, obs.width, obs.heightBottom); // Bottom pillar
            });

            // Draw Game Over
            if (isGameOver) {
                gameCtx.fillStyle = 'rgba(255, 0, 0, 0.7)';
                gameCtx.font = '24px "Cinzel Decorative"';
                gameCtx.textAlign = 'center';
                gameCtx.fillText('¡Colisión!', gameArea.width / 2, gameArea.height / 2 - 15);
                 gameCtx.font = '14px Lato';
                 gameCtx.fillText('Reiniciando...', gameArea.width / 2, gameArea.height / 2 + 15);
            }
        }

         function rectsOverlap(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }


        function gameLoop() {
             updateGame();
             drawGame();

             if (isGameOver) {
                 // Brief pause, then restart
                 setTimeout(() => {
                     resetGame(); // Reset state but keep loop running
                     gameLoopId = requestAnimationFrame(gameLoop);
                 }, 1000); // Restart after 1 second
             } else {
                 gameLoopId = requestAnimationFrame(gameLoop);
             }
         }

        function startGame() {
            console.log("Starting mini-game...");
            if (gameLoopId) cancelAnimationFrame(gameLoopId); // Stop previous loop if any
            resetGame();
            modalLoadingIndicator.style.display = 'flex'; // Ensure loading container is visible
            gameCanvas.style.display = 'block'; // Ensure canvas is visible
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function stopGame() {
             console.log("Stopping mini-game...");
             if (gameLoopId) {
                 cancelAnimationFrame(gameLoopId);
                 gameLoopId = null;
             }
             // Optionally hide canvas, or leave it until content loads/error shows
             // gameCanvas.style.display = 'none';
             gameScoreDisplay.textContent = ''; // Clear score when stopping for real
         }

        // Player control
        function playerJump() {
            if (player && !isGameOver) { // Allow jump only if game is running
                player.dy = player.lift;
            }
        }
        document.addEventListener('keydown', (e) => {
             if (e.code === 'Space' && storyModal.classList.contains('active') && !modalStoryContentArea.classList.contains('content-hidden')) { // Check if modal is active and game is likely visible
                 e.preventDefault(); // Prevent page scroll
                 playerJump();
             }
         });
         gameCanvas.addEventListener('touchstart', (e) => {
             e.preventDefault(); // Prevent potential zoom/scroll
             playerJump();
         });
         gameCanvas.addEventListener('mousedown', (e) => {
             e.preventDefault();
             playerJump();
         });


        // ========== API FUNCTIONS ========== (Minor change in title generation)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentAtlantisTopic
                 ? `Eres un erudito de la Atlántida, PNJ de esta enciclopedia. Responde preguntas específicas sobre '${currentAtlantisTopic}'. Mantén el tono misterioso y erudito. Sé conciso y céntrate estrictamente en este tópico.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento. Intenta en unos segundos.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la IA llegó vacía. Intenta reformular.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Intenta más tarde.`);
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentAtlantisTopic) throw new Error("Error interno: Contexto no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(atlantisThemes) || "leyendas de Atlantis";
             const specificPrompt = `Genera 40 ítems (leyendas, lugares, conceptos) sobre ${randomTheme}`; // Request 40
             const text = await fetchTextFromApi(specificPrompt, titleGenerationConfig, false);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
             if (titles.length < 10) throw new Error("La IA no generó suficientes fragmentos."); // Expect at least some
             return titles.slice(0, 40); // Return up to 40
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "lost city of Atlantis ruins underwater";
             const enhancedPrompt = `Mythological painting, cinematic concept art of '${safePromptText}', related to the lost city of Atlantis. Underwater scene, ancient ruins, bioluminescent light, mysterious atmosphere. Orichalcum glow, crystal technology if applicable. Avoid text, labels.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, photograph, realistic, modern scuba gear, cartoon, simple vector";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (No changes needed)
        function formatExplanationText(rawText) { /* ... same as before ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (No changes needed)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            stopGame(); // Ensure game stops when modal closes
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             stopGame(); // Stop game on reset too
             modalLoadingIndicator.style.display = 'flex'; // Default to show loading indicator
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentAtlantisTopic = null;
             hideFullscreenImage();
         }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (No changes needed)
        function showFullscreenImage(imgSrc) { /* ... same as before ... */
             if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() { /* ... same as before ... */
             if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            // Only restore scroll if the main modal isn't also active
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (No changes needed)
        function addChatMessage(message, sender) { /* ... same as before ... */
             const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... same as before ... */
            const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... same as before ... */
             const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Oráculo dice: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» Los archivos están vacíos o ilegibles «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick to START GAME ***
        async function handleTitleClick(title) {
            resetModalState(); // Resets everything including chat context and stops any old game
            showModal();
            modalTitle.textContent = title;
            currentAtlantisTopic = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');

            // *** START THE MINIGAME ***
            startGame();
            modalLoadingIndicator.style.display = 'flex'; // Ensure loading overlay is visible

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // *** STOP GAME, HIDE LOADING, SHOW CONTENT ***
                stopGame();
                modalLoadingIndicator.style.display = 'none'; // Hide the whole loading overlay
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;

                // Image loading logic (same as before)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualizando reliquia...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización perdida.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                // *** STOP GAME, HIDE LOADING, SHOW ERROR ***
                stopGame();
                modalLoadingIndicator.style.display = 'none'; // Hide loading overlay
                modalErrorMessage.textContent = error.message || "Los archivos de esta leyenda están corruptos.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando fragmentos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se encontraron más fragmentos en esta fosa."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar fragmentos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Revelar Más Fragmentos';
             }
         }

         // Search Filter Function (Normalized)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check all essential elements, including game canvas
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !gameCanvas || !gameScoreDisplay || !footerYear) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡Error Cataclísmico! Faltan componentes de la interfaz.</p>';
                return;
             }
            // Set footer year
            footerYear.textContent = new Date().getFullYear();

            // Event listeners (Modal, Generate More, Search, Chat, Fullscreen) - No changes needed here
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');

             // Set fixed canvas size (adjust as needed)
             // Let's make it responsive based on modal width later if needed, fixed for now
             const canvasWidth = Math.min(window.innerWidth * 0.7, 450); // Responsive width up to 450px
             gameCanvas.width = canvasWidth;
             gameCanvas.height = Math.round(canvasWidth * 0.5); // Maintain 2:1 aspect ratio
             gameArea.width = gameCanvas.width;
             gameArea.height = gameCanvas.height;
             console.log("Canvas Size:", gameCanvas.width, "x", gameCanvas.height);


             console.log("Atlantis Archives Initialized.");
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>