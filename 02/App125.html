<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mundo Prehistórico - Enciclopedia de Dinosaurios</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes adecuadas -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Nunito+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Dinosaurios --- */
        :root {
            --color-primary: #556b2f; /* Verde Oliva Oscuro */
            --color-secondary: #8b4513; /* Marrón Silla de Montar */
            --color-tertiary: #cdaa7d; /* Beige Arena/Hueso */
            --color-background: #f5f5dc; /* Beige Muy Claro / Pergamino */
            --color-text: #4d4d4d; /* Gris Oscuro */
            --color-text-muted: #7f7f7f; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco */
            --color-border: #d2b48c; /* Tan / Borde Arena */
            --color-error-bg: #fde8e8; /* Fondo error rosa pálido */
            --color-error-text: #9b2c2c; /* Texto error rojo oscuro */
            --color-error-border: #f5c6cb; /* Borde error rosa */

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 5px 10px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 15px 25px rgba(0, 0, 0, 0.1), 0 8px 10px rgba(0, 0, 0, 0.04);
            --border-radius: 5px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Nunito Sans', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-secondary); font-weight: 700; }
        h2.section-title { color: var(--color-primary); border-bottom: 3px solid var(--color-secondary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Nunito Sans'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(85, 107, 47, 0.2); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-primary); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Nunito Sans'; font-size: 0.95rem; }
        .title-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-secondary); background-color: #fffaf0; /* Crema */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-secondary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #a0522d; /* Sienna */ box-shadow: var(--shadow-md); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-text-muted); color: #e2e8f0; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(85, 107, 47, 0.85); /* Overlay verde oliva */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 2px solid var(--color-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: #fff; transform: rotate(90deg); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid #fff; }

        #modal-content { padding: 0 5px; font-size: 1.05rem; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 600; }
        #modal-content em { color: var(--color-primary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(210, 180, 140, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fafafa; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-tertiary); color: #333; margin-left: auto; text-align: left; } /* Ajustado para mejor contraste */
        .ai-message { background-color: #e8f5e9; /* Verde muy pálido */ color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Nunito Sans'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #6b8e23; /* Verde oliva más oscuro */ }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-primary); font-size: 1.4rem; font-family: 'Merriweather'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Nunito Sans'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(40, 40, 40, 0.92); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-tertiary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-paw mr-3 text-green-800"></i> <!-- Icono Huella -->
                     Mundo Prehistórico
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">~ Enciclopedia Interactiva ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora la Era de los Dinosaurios</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre las criaturas fascinantes que dominaron la Tierra hace millones de años. Selecciona un dinosaurio o tema para empezar tu viaje.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar dinosaurio, reptil o concepto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-skull text-yellow-800 mr-2"></i> <!-- Icono Libro-Calavera -->
                 Índice Paleontológico
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Excavando registros fósiles...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">~ No se encontraron especímenes con esos criterios ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Especies
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Recopilando datos fósiles...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                         <p class="text-center text-sm text-gray-500 p-2">Pregúntale al paleontólogo sobre este espécimen...</p>
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando archivos...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Escribe tu pregunta aquí...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Ilustración Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-700 py-6 mt-12 border-t border-gray-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA basada en conocimiento paleontológico actual, con fines educativos y de divulgación.</p>
              <p class="mt-1">Las reconstrucciones e interpretaciones pueden variar con nuevos descubrimientos.</p>
              <p class="mt-2">© Era Mesozoica Interactiva</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // === THEROPODS ===
            // Tyrannosauroidea
            "Tyrannosaurus Rex", "Tarbosaurus", "Albertosaurus", "Gorgosaurus", "Daspletosaurus", "Alioramus", "Lythronax", "Nanuqsaurus", "Proceratosaurus", "Guanlong", "Yutyrannus", "Dilong", "Eotyrannus",
            // Allosauroidea
            "Allosaurus", "Saurophaganax", "Acrocanthosaurus", "Carcharodontosaurus", "Giganotosaurus", "Mapusaurus", "Tyrannotitan", "Neovenator", "Concavenator", "Sinraptor", "Yangchuanosaurus",
            // Megalosauroidea
            "Megalosaurus", "Torvosaurus", "Spinosaurus", "Baryonyx", "Suchomimus", "Irritator", "Ichthyovenator", "Afrovenator", "Dubreuillosaurus", "Eustreptospondylus", "Piatnitzkysaurus",
            // Ceratosauria
            "Ceratosaurus", "Carnotaurus", "Majungasaurus", "Rajasaurus", "Abelisaurus", "Skorpiovenator", "Ekrixinatosaurus", "Eoabelisaurus", "Limusaurus", "Elaphrosaurus", "Deltadromeus", "Noasaurus", "Masiakasaurus",
            // Coelophysoidea
            "Coelophysis", "Dilophosaurus", "Syntarsus (Megapnosaurus)", "Procompsognathus", "Liliensternus", "Zupaysaurus", "Gojirasaurus",
            // Ornithomimosauria ("Bird Mimics")
            "Ornithomimus", "Struthiomimus", "Gallimimus", "Deinocheirus", "Anserimimus", "Archaeornithomimus", "Garudimimus", "Pelecanimimus", "Harpymimus", "Shenzhousaurus", "Beishanlong",
            // Therizinosauria ("Scythe Lizards")
            "Therizinosaurus", "Nothronychus", "Segnosaurus", "Erlikosaurus", "Alxasaurus", "Beipiaosaurus", "Falcarius", "Jianchangosaurus", "Suzhousaurus",
            // Oviraptorosauria
            "Oviraptor", "Citipati", "Khaan", "Nemegtomaia", "Rinchenia", "Gigantoraptor", "Caudipteryx", "Protarchaeopteryx", "Incisivosaurus", "Avimimus", "Anzu", "Hagryphus",
            // Dromaeosauridae ("Raptors")
            "Velociraptor", "Deinonychus", "Utahraptor", "Dromaeosaurus", "Achillobator", "Dakotaraptor", "Austroraptor", "Bambiraptor", "Microraptor", "Sinornithosaurus", "Tsaagan", "Adasaurus", "Pyroraptor", "Variraptor", "Zhenyuanlong",
            // Troodontidae
            "Troodon (Stenonychosaurus)", "Saurornithoides", "Zanabazar", "Borogovia", "Byronosaurus", "Gobivenator", "Jinfengopteryx", "Mei Long", "Sinovenator", "Talos", "Latenivenatrix",
            // Alvarezsauridae
            "Mononykus", "Shuvuuia", "Alvarezsaurus", "Patagonykus", "Haplocheirus", "Linhenykus", "Xixianykus", "Albinykus",
            // Other Theropods & Basal Birds
            "Compsognathus", "Sinosauropteryx", "Archaeopteryx", "Jeholornis", "Confuciusornis", "Ichthyornis", "Hesperornis", "Rahonavis", "Scansoriopteryx", "Epidexipteryx", "Yi Qi", "Enantiornithes (Concepto)", "Herrerasaurus", "Eoraptor", "Staurikosaurus",

            // === SAUROPODOMORPHA ===
            // Basal Sauropodomorphs ("Prosauropods")
            "Plateosaurus", "Massospondylus", "Lufengosaurus", "Riojasaurus", "Anchisaurus", "Mussaurus", "Coloradisaurus", "Efraasia", "Thecodontosaurus", "Saturnalia", "Panphagia",
            // Basal Sauropods
            "Vulcanodon", "Isanosaurus", "Antetonitrus", "Gongxianosaurus", "Spinophorosaurus", "Shunosaurus", "Barapasaurus", "Omeisaurus", "Mamenchisaurus", "Euhelopus",
            // Diplodocoidea
            "Diplodocus", "Apatosaurus (Brontosaurus)", "Barosaurus", "Supersaurus", "Seismosaurus (Diplodocus hallorum)", "Amargasaurus", "Dicraeosaurus", "Brachytrachelopan", "Lingwulong", "Rebbachisaurus", "Nigersaurus", "Demandasaurus", "Katepensaurus",
            // Macronaria (Brachiosaurids & Titanosaurs)
            "Brachiosaurus", "Giraffatitan", "Sauroposeidon", "Lusotitan", "Cedarosaurus", "Abydosaurus", "Venenosaurus", "Camarasaurus", "Europasaurus", "Jobaria",
            // Titanosauria
            "Titanosaurus (Dudoso)", "Argentinosaurus", "Patagotitan", "Puertasaurus", "Futalognkosaurus", "Dreadnoughtus", "Saltasaurus", "Neuquensaurus", "Alamosaurus", "Opisthocoelicaudia", "Nemegtosaurus", "Rapetosaurus", "Isisaurus", "Magyarosaurus", "Paralititan", "Andesaurus", "Malawisaurus", "Rukwatitan", "Diamantinasaurus", "Savannasaurus", "Aeolosaurus", "Maxakalisaurus", "Rinconsaurus", "Bonitasaura", "Overosaurus", "Titanosauria (Concepto General)",

            // === ORNITHISCHIA ===
            // Thyreophora (Armored Dinosaurs)
            // Stegosauria
            "Stegosaurus", "Kentrosaurus", "Miragaia", "Dacentrurus", "Huayangosaurus", "Tuojiangosaurus", "Chungkingosaurus", "Gigantspinosaurus", "Hesperosaurus", "Loricatosaurus", "Wuerhosaurus",
            // Ankylosauria
            "Ankylosaurus", "Euoplocephalus", "Nodosaurus", "Edmontonia", "Panoplosaurus", "Sauropelta", "Gastonia", "Polacanthus", "Gargoyleosaurus", "Minmi", "Borealopelta", "Antarctopelta", "Animantarx", "Hungarosaurus", "Struthiosaurus", "Ziapelta", "Ankylosauria (Concepto General)", "Nodosauridae (Familia)", "Ankylosauridae (Familia)",
            // Basal Thyreophora
            "Scelidosaurus", "Scutellosaurus", "Emausaurus", "Lesothosaurus (posiblemente basal Ornithopod)",

            // Ornithopoda (Iguanodonts, Hadrosaurs & relatives)
            // Basal Ornithopods
            "Hypsilophodon", "Dryosaurus", "Othnielia (Othnielosaurus)", "Thescelosaurus", "Parksosaurus", "Leaellynasaura", "Atlascopcosaurus", "Qantassaurus", "Fulgurotherium", "Muttaburrasaurus", "Zalmoxes", "Rhabdodon",
            // Iguanodontia
            "Iguanodon", "Mantellisaurus", "Ouranosaurus", "Camptosaurus", "Tenontosaurus", "Dollodon", "Proa", "Jinzhousaurus", "Lanzhousaurus", "Fukuisaurus", "Equijubus", "Altirhinus",
            // Hadrosauridae ("Duck-billed Dinosaurs")
            "Hadrosaurus", "Edmontosaurus", "Anatotitan (Edmontosaurus annectens)", "Shantungosaurus", "Maiasaura", "Parasaurolophus", "Corythosaurus", "Lambeosaurus", "Hypacrosaurus", "Tsintaosaurus", "Olorotitan", "Magnapaulia", "Velafrons", "Charonosaurus", "Saurolophus", "Prosaurolophus", "Gryposaurus", "Kritosaurus", "Brachylophosaurus", "Secernosaurus", "Telmatosaurus", "Hadrosauridae (Concepto)", "Lambeosaurinae (Subfamilia)", "Hadrosaurinae (Saurolophinae) (Subfamilia)",

            // Marginocephalia (Pachycephalosaurs & Ceratopsians)
            // Pachycephalosauria ("Bone-headed Dinosaurs")
            "Pachycephalosaurus", "Stygimoloch (posiblemente juvenil Pachy)", "Dracorex (posiblemente juvenil Pachy)", "Stegoceras", "Homalocephale", "Prenocephale", "Tylocephale", "Goyocephale", "Wannanosaurus", "Alaskacephale", "Sphaerotholus", "Colepiocephale",
            // Ceratopsia ("Horned Dinosaurs")
            "Triceratops", "Torosaurus", "Styracosaurus", "Centrosaurus", "Chasmosaurus", "Pentaceratops", "Protoceratops", "Psittacosaurus", "Leptoceratops", "Bagaceratops", "Montanoceratops", "Udanoceratops", "Zuniceratops", "Diabloceratops", "Nasutoceratops", "Kosmoceratops", "Utahceratops", "Einiosaurus", "Achelousaurus", "Pachyrhinosaurus", "Sinoceratops", "Wendiceratops", "Albertaceratops", "Medusaceratops", "Regaliceratops", "Machairoceratops", "Spiclypeus", "Ceratopsia (Concepto)", "Centrosaurinae (Subfamilia)", "Chasmosaurinae (Subfamilia)", "Neoceratopsia (Clado)",

            // === OTHER PREHISTORIC REPTILES (Popularly associated) ===
            // Pterosauria (Flying Reptiles)
            "Pterodactylus", "Pteranodon", "Quetzalcoatlus", "Dimorphodon", "Rhamphorhynchus", "Anhanguera", "Ornithocheirus", "Tapejara", "Hatzegopteryx", "Nyctosaurus", "Istiodactylus", "Pterosauria (Concepto)", "Pterodactyloidea (Suborden)", "Rhamphorhynchoidea (Suborden, parafilético)",
            // Marine Reptiles
            "Ichthyosaurus", "Plesiosaurus", "Elasmosaurus", "Liopleurodon", "Kronosaurus", "Mosasaurus", "Tylosaurus", "Pliosaurus", "Shonisaurus", "Temnodontosaurus", "Nothosaurus", "Placodus", "Archelon (Tortuga gigante)", "Basilosaurus (Ballena primitiva, mamífero!)", "Ichthyosauria (Orden)", "Plesiosauria (Orden)", "Mosasauridae (Familia)",
            // Other Archosaurs & Relatives
            "Postosuchus", "Dimetrodon (Synapsid, no reptil/dino)", "Edaphosaurus (Synapsid)", "Erythrosuchus", "Ornithosuchus", "Prestosuchus", "Sarcosuchus (Cocodrilo gigante)", "Deinosuchus (Cocodrilo gigante)", "Aetosaurus", "Desmatosuchus", "Effigia", "Shuvosaurus", "Lagerpeton", "Marasuchus",

            // === PALEONTOLOGY CONCEPTS ===
            "Paleontología (Ciencia)", "Fósil (Definición)", "Proceso de Fosilización", "Período Triásico", "Período Jurásico", "Período Cretácico", "Era Mesozoica", "Extinción Masiva del Cretácico-Paleógeno (K-Pg)", "Extinción Masiva del Triásico-Jurásico", "Extinción Masiva del Pérmico-Triásico (La Gran Mortandad)", "Tectónica de Placas y Distribución de Dinosaurios", "Pangea", "Laurasia", "Gondwana", "Clima del Mesozoico", "Plantas del Mesozoico (Helechos, Cícadas, Coníferas, Angiospermas)", "Tipos de Dinosaurios (Saurischia vs Ornithischia)", "Terópodos (Grupo)", "Sauropodomorfos (Grupo)", "Ornitísquios (Grupo)", "Dinosaurios Emplumados", "Evolución de las Aves a partir de Dinosaurios", "Gigantismo en Sauropodos", "Comportamiento de Manada en Dinosaurios", "Nidos y Cuidado Parental", "Paleoarte (Concepto)", "Icnitas (Huellas Fósiles)", "Coprolitos (Excrementos Fósiles)", "Tafonomía (Estudio de la Fosilización)", "Biogeografía de Dinosaurios", "Formación Morrison (Yacimiento Fósil)", "Formación Hell Creek (Yacimiento Fósil)", "Lagerstätte (Yacimiento de Conservación Excepcional)", "Solnhofen (Lagerstätte)", "Jehol Biota (Lagerstätte)", "Dinosaur National Monument", "Museo Americano de Historia Natural (Colección Dino)", "Museo Field de Chicago (Sue el T-Rex)", "Museo de Historia Natural de Londres (Colección Dino)", "Mary Anning (Paleontóloga)", "Roy Chapman Andrews (Explorador)", "Othniel Charles Marsh (Guerra de los Huesos)", "Edward Drinker Cope (Guerra de los Huesos)", "John Ostrom (Renacimiento de los Dinosaurios)", "Robert T. Bakker (Dinosaurios de Sangre Caliente)", "Jack Horner (Nidos de Maiasaura)", "Paul Sereno (Descubridor)", "Filogenia de Dinosaurios", "Cladística en Paleontología", "Dinosaurios Polares", "Adaptaciones de los Dinosaurios", "Inteligencia de los Dinosaurios (Estimaciones)", "Velocidad de los Dinosaurios (Estimaciones)"
        ];
        const dinosaurThemes = [
            "Terópodos carnívoros", "Grandes saurópodos", "Dinosaurios con cuernos (Ceratopsios)", "Dinosaurios acorazados (Anquilosaurios)", "Dinosaurios con placas (Estegosaurios)", "Picos de pato (Hadrosaurios)", "Raptors (Dromeosáuridos)", "Dinosaurios emplumados", "Reptiles voladores (Pterosaurios)", "Reptiles marinos (Ictiosaurios, Plesiosaurios, Mosasaurios)", "Período Cretácico", "Período Jurásico", "Período Triásico", "Extinción de los dinosaurios", "Fósiles y paleontología", "Dinosaurios de Sudamérica", "Dinosaurios de Norteamérica", "Dinosaurios de Asia", "Dinosaurios de Europa", "Dinosaurios de África", "Dinosaurios de Gondwana", "Dinosaurios de Laurasia", "Comportamiento dinosaurio", "Evolución de las aves"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un paleontólogo experto y divulgador científico. Tu especialidad son los dinosaurios y la vida prehistórica. Describe el dinosaurio, reptil prehistórico o concepto paleontológico indicado de forma detallada, precisa y accesible. Incluye: Clasificación (orden, familia si es relevante), período geológico, ubicación geográfica de los fósiles, descripción física (tamaño, peso estimado, características distintivas como plumas, cuernos, crestas, armadura), dieta (herbívoro, carnívoro, omnívoro), comportamiento conocido o inferido (caza, defensa, socialización), descubrimiento (quién, cuándo, dónde si es notable), y su importancia en el ecosistema o en la paleontología. Usa un lenguaje claro y atractivo para entusiastas. El objetivo es una descripción completa de aproximadamente 1200-1300 palabras. Basa tu descripción únicamente en el siguiente dinosaurio o concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúa como un asistente paleontológico especializado únicamente en el espécimen o concepto que se está mostrando. Responde preguntas de seguimiento sobre sus características, hábitat, descubrimiento, o detalles mencionados en la descripción principal. Sé conciso y preciso, basándote en la información paleontológica conocida.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia de dinosaurios. Genera exactamente 15 nombres de géneros de dinosaurios específicos, reptiles prehistóricos relacionados (pterosaurios, marinos), o conceptos paleontológicos relevantes (períodos, fósiles, etc.). Devuelve *solo* la lista, uno por línea. No incluyas números, guiones ni introducciones.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Área de texto+imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div para texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentTopicTitle
                ? `Eres un asistente paleontológico especializado únicamente en '${currentTopicTitle}'. Responde preguntas de seguimiento sobre sus características, hábitat, descubrimiento, o detalles mencionados en la descripción principal. Sé conciso y preciso, basándote en la información paleontológica conocida.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores de excavación están ocupados. Intenta desenterrar esta información en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta del yacimiento fósil llegó vacía. Intenta reformular tu búsqueda.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión con el pasado tardó demasiado (>${config.timeoutSeconds}s). Revisa tu equipo o inténtalo más tarde.`);
                }
                throw new Error(error.message || "Un evento de extinción inesperado ocurrió al contactar la IA.");
            }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Error interno: Contexto paleontológico no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(dinosaurThemes) || "dinosaurios en general";
            const specificPrompt = `Genera 15 nombres de dinosaurios, reptiles prehistóricos o conceptos paleontológicos relacionados con ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no desenterró suficientes ideas nuevas.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "various dinosaurs in prehistoric landscape";
            // Prompt enfocado en paleoarte
            const enhancedPrompt = `Paleoart illustration depicting the dinosaur or prehistoric concept '${safePromptText}'. Focus on anatomical accuracy based on current scientific understanding, natural environment (forest, plains, swamp, desert based on period/location). Dramatic or natural lighting. Dynamic pose if applicable. Detailed textures.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, cartoon, drawing, sketch, low quality, blurry, multiple different species interacting unnaturally, human figures, modern elements, watermark, signature, ui elements, simple background, white background";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (la misma función de antes) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
            modalLoadingIndicator.style.display = 'flex';
            modalStoryContentArea.classList.add('content-hidden');
            modalError.classList.add('content-hidden');
            modalTitle.textContent = '';
            modalContent.innerHTML = '';
            modalErrorMessage.textContent = '';
            chatHistory.innerHTML = '<p class="text-center text-sm text-gray-500 p-2">Pregúntale al paleontólogo sobre este espécimen...</p>'; // Reset chat con prompt inicial
            chatInput.value = '';
            chatLoadingIndicator.style.display = 'none';
            chatSendBtn.disabled = false;
            currentTopicTitle = null; // Limpia contexto
            hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ==========
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender) {
            // Remove initial placeholder if it exists
            const placeholder = chatHistory.querySelector('p.text-gray-500');
            if (placeholder) placeholder.remove();

            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
            const placeholder = chatHistory.querySelector('p.text-gray-500');
            if (placeholder) placeholder.remove();
            const errorDiv = document.createElement('div');
            errorDiv.classList.add('chat-error');
            errorDiv.textContent = message;
            chatHistory.appendChild(errorDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); // Orden alfabético es bueno aquí
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">~ No hay registros fósiles disponibles ~</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // Set context for chat
            modalContent.innerHTML = '';
            // Chat history reset is done in resetModalState
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-bone placeholder-icon"></i> <!-- Icono Hueso -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Reconstruyendo imagen...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Reconstrucción artística de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Reconstrucción fallida.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar datos del espécimen.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden'); // Hide chat on main error
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando nuevos fósiles...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron descubrir más especies en esta expedición."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error durante la excavación: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Especies';
             }
         }

        function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #8B0000; font-size: 1.5em; text-align: center; padding-top: 3em;">¡Extinción Masiva de Componentes! La página no puede cargar.</p>';
                return;
             }
            // Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>