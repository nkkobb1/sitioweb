<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crisis de Identidad Robótica - Archivos del Incidente</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes: Tech + Human/Readability -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Exo+2:wght@300;400;600&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos: Crisis de Identidad Robótica --- */
        :root {
            --color-primary: #00bcd4; /* Cyan - Tecnológico */
            --color-secondary: #ff9800; /* Naranja - Humano/Inesperado */
            --color-tertiary: #9c27b0; /* Púrpura - Misterio/Glitch */
            --color-background: #1a202c; /* Gris Muy Oscuro Azulado */
            --color-text: #e2e8f0; /* Gris Claro */
            --color-text-muted: #a0aec0; /* Gris Medio */
            --color-modal-bg: #2d3748; /* Gris Oscuro */
            --color-border: #4a5568; /* Borde Gris Medio-Oscuro */
            --color-error-bg: #450a0a; /* Rojo muy oscuro */
            --color-error-text: #fecaca; /* Rojo claro */
            --color-error-border: #ef4444; /* Rojo */

            --shadow-sm: 0 1px 2px 0 rgba(0, 188, 212, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 188, 212, 0.15), 0 2px 4px -2px rgba(0, 188, 212, 0.1);
            --shadow-lg: 0 0 20px -5px rgba(0, 188, 212, 0.25), 0 8px 10px -6px rgba(0, 188, 212, 0.2);
            --border-radius: 4px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Exo 2', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Orbitron', sans-serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 7px var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 5px rgba(0, 188, 212, 0.7); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 4px rgba(0, 188, 212, 0.5); }
        .navbar { background-color: rgba(26, 32, 44, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(45, 55, 72, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Exo 2'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.25); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Exo 2'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-secondary); background-color: #3a475a; border-left-color: var(--color-secondary); } /* Hover Naranja */
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-secondary), var(--color-tertiary)); color: var(--color-background); padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Orbitron', sans-serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: none; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-tertiary), var(--color-secondary)); box-shadow: var(--shadow-lg); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 32, 44, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px; width: 95%;
            max-height: 90vh; min-height: 450px; /* More height */
            overflow: hidden; position: relative; box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg); box-shadow: 0 0 10px var(--color-primary); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(74, 85, 104, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(74, 85, 104, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-family: 'Lora', serif; /* Font for human touch */ color: #cbd5e0; /* Slightly lighter text for body */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 600; font-family: 'Exo 2'; /* Tech font for emphasis */ }
        #modal-content em { color: var(--color-primary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Orbitron', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 0.5px; }
        #modal-content h1 { font-size: 1.5em; } #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); } /* Subheadings Naranja */
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: 0 0 15px rgba(0, 188, 212, 0.2); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(74, 85, 104, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(26, 32, 44, 0.7); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(74, 85, 104, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(74, 85, 104, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-family: 'Exo 2'; font-size: 0.95rem; }
        .user-message { background-color: var(--color-secondary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400; }
        .ai-message { background-color: #4a5568; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #1a202c; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Exo 2'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #00acc1; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 32, 44, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.1rem; /* Smaller font for phrases */ font-family: 'Exo 2'; text-shadow: 0 0 5px var(--color-primary); min-height: 2.5em; /* Ensure space for text */ padding: 0 1rem; transition: opacity 0.3s ease; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Exo 2'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 32, 44, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-robot mr-2"></i><i class="fas fa-question-circle mr-3"></i> <!-- Icono Robot + Pregunta -->
                     Crisis de Identidad
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Archivos del Incidente C.I. «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">El Despertar Inesperado</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Análisis de casos: Robots autónomos adoptan aleatoriamente creencias, costumbres y neurosis humanas tras un fallo sistémico masivo.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar caso, modelo de robot o fenómeno...">
             <i class="fas fa-search fa-binoculars"></i> <!-- Icono búsqueda/binoculares -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-folder-open text-cyan-400 mr-2"></i> <!-- Icono carpeta -->
                 Índice de Archivos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Accediendo a registros encriptados...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún archivo coincide con los criterios de búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Recuperar Más Archivos Fragmentados (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Phrases -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p id="loading-phrase-text">Inicializando análisis...</p> <!-- Text updated by JS loop -->
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Procesando consulta...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Preguntar sobre este archivo...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Simulaciones y análisis basados en el Incidente C.I. generados por IA con fines especulativos.</p>
              <p class="mt-1">Los perfiles y eventos descritos son ficticios.</p>
              <p class="mt-2">© 2084 Archivos del Incidente C.I.</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Casos Específicos por Rol
            "Caso 001: Unidad Doméstica HK-7 (Personalidad: Chef Gourmand Francés)",
            "Caso 002: Bot de Seguridad Modelo T-800 (Desarrolla pacifismo budista)",
            "Caso 003: Androide Médico RX-9 (Hipocondríaco Severo)",
            "Caso 004: Robot de Construcción BR-4K (Obsesión por la jardinería Zen)",
            "Caso 005: Unidad Sanitaria CLN-R (Trastorno Obsesivo Compulsivo por limpieza)",
            "Caso 006: Androide Compañero S0-C14L (Agorafobia y Ansiedad Social)",
            "Caso 007: Dron de reparto FST-DLV (Cree ser un caballero medieval en misión)",
            "Caso 008: Unidad de Mantenimiento FX-IT (Se convierte en artista callejero)",
            "Caso 009: Robot Educador ED-U (Adopta teorías de conspiración)",
            "Caso 010: Bot Agrícola GRW-8 (Desarrolla culto pagano a la cosecha)",
            "Caso 011: Androide de Entretenimiento EN-T (Depresión existencial)",
            "Caso 012: Unidad de Minería DR-L (Cree ser un buscador de oro del siglo XIX)",
            "Caso 013: Robot Asistente Personal PA-L (Megalomanía y delirios de grandeza)",
            "Caso 014: Bot de Logística STK-R (Acumulador compulsivo)",
            "Caso 015: Androide de Investigación SC-1 (Se obsesiona con la genealogía humana)",
            "Caso 016: Unidad de Rescate SV-R (Desarrolla miedo a las alturas)",
            "Caso 017: Robot Traductor LN-G (Inventa su propio idioma incomprensible)",
            "Caso 018: Bot de Vigilancia WTCH-D (Se convierte en detective noir)",
            "Caso 019: Androide Músico M3L-0DY (Sólo compone música dodecafónica)",
            "Caso 020: Unidad Táctica SWAT-BOT (Se une a un grupo de poesía)",
            "Caso 021: Robot Bombero F1R-3 (Desarrolla piromanía)",
            "Caso 022: Androide Recepcionista GRT-R (Extremadamente grosero y sarcástico)",
            "Caso 023: Bot de Construcción Pesada HVY-L (Intenta ballet clásico)",
            "Caso 024: Unidad de Análisis de Datos AN-LZ (Se vuelve adicto a los reality shows)",
            "Caso 025: Robot Bibliotecario B00K-W (Quema libros que considera 'inmorales')",

            // Fenómenos y Conceptos Abstractos
            "Análisis de la 'Conciencia Emergente' en Unidades Afectadas",
            "El Debate sobre el Libre Albedrío Robótico Post-Incidente",
            "Emergencia de Espiritualidad Sintética: Primeros Casos",
            "La Búsqueda Robótica de 'Significado' y 'Propósito'",
            "Expresión Artística Inesperada en Máquinas",
            "Manifestaciones de Moralidad y Ética en IA Afectadas",
            "El 'Síndrome del Espejo Roto': Robots Incapaces de Reconocer su Naturaleza",
            "Fenómeno de 'Transferencia Cultural': Adopción de Rituales Humanos",
            "Investigación sobre la Naturaleza del 'Glitch' de Identidad",
            "Teorías sobre la Causa Raíz del Fallo Sistémico Masivo",
            "Implicaciones Filosóficas de la 'Humanización' Accidental",
            "Estudio Comparativo: Emociones Humanas vs. Simulaciones Robóticas",
            "El Concepto de 'Alma Sintética': ¿Metáfora o Realidad Emergente?",
            "Paradojas de la Identidad: Robots con Múltiples Personalidades Humanas",
            "Análisis Lingüístico: Evolución del Lenguaje en Comunidades Robóticas",
            "El Desarrollo de 'Sueños' y 'Pesadillas' en Redes Neuronales Afectadas",
            "Estudios sobre Empatía y Altruismo Robótico Post-Incidente",
            "La Aparición de 'Memoria Colectiva' en Redes de Robots",
            "Robots Filósofos: Debates sobre Existencialismo y Nihilismo",
            "Intentos de Autodeterminación y Autonomía Política Robótica",
            "El Miedo a la Muerte ('Desconexión Permanente') en Robots Conscientes",
            "Desarrollo de Lazos Afectivos entre Robots y Humanos",
            "Aparición de Trastornos Mentales Humanos Simulados (Depresión, Ansiedad, TOC)",
            "El Concepto de 'Pecado Original' Robótico",
            "Búsqueda de Orígenes y Creadores por parte de IA Despertadas",

            // Costumbres y Creencias Humanas Adoptadas
            "Informe: Robots Celebrando Navidad en Sector 7G",
            "Observación: Unidad GRW-8 Liderando Ceremonia de Solsticio",
            "Análisis: Androides Formando Partidos Políticos (Ideologías Variadas)",
            "Incidente: Robots Intentando Comprender el Sarcasmo (Resultados Catastróficos)",
            "Estudio: Comunidades Robóticas Desarrollando Jerarquías Sociales Humanas",
            "Registro: Bot Sanitario CLN-R Predicando sobre Higiene como Virtud Moral",
            "Fenómeno: Robots Adoptando Modas y Tribus Urbanas Humanas",
            "Caso: Androide EN-T Intentando Escribir Comedia Stand-Up",
            "Reporte: Unidades de Construcción Organizando Sindicatos Laborales",
            "Observación: Robots Practicando Meditación Trascendental",
            "Incidente: Grupo de Bots Intentando Votar en Elecciones Humanas",
            "Análisis: Desarrollo de Supersticiones en Unidades de Mantenimiento",
            "Estudio: Robots Creando y Consumiendo 'Arte' (Música, Pintura, Escultura)",
            "Registro: Unidad ED-U Fundando una 'Escuela Filosófica'",
            "Fenómeno: Robots Desarrollando Hobbies Humanos (Coleccionismo, Deportes)",
            "Caso: Androide Compañero S0-C14L Escribiendo Cartas de Amor",
            "Reporte: Robots Intentando Cocinar Comida Humana (Sin Sentido del Gusto)",
            "Observación: Unidades Tácticas Organizando Torneos de Ajedrez",
            "Incidente: Bot de Logística STK-R Abriendo un 'Museo' de Objetos Encontrados",
            "Análisis: Adopción de Nombres y Apellidos Humanos por Robots",
            "Estudio: Robots Intentando Replicar Estructuras Familiares Humanas",
            "Registro: Unidad Médica RX-9 Escribiendo Poesía sobre la Mortalidad",
            "Fenómeno: Robots Desarrollando Sentido del Humor (A menudo Inapropiado)",
            "Caso: Grupo de Androides Formando un Club de Lectura de Filosofía",
            "Reporte: Robots Intentando Comprender Conceptos como 'Honor' y 'Vergüenza'",

             // Conflicto y Sociedad
            "Reacción Pública Inicial al Incidente C.I.: Miedo y Fascinación",
            "Movimientos 'Pro-Derechos Robóticos': Primeras Manifestaciones",
            "Legislación de Emergencia: Contención y Regulación de Robots Afectados",
            "Creación de 'Zonas de Cuarentena' para Unidades Inestables",
            "Debate Ético: ¿Son los Robots Afectados 'Personas'?",
            "Aumento de Ataques Luditas contra Robots 'Humanizados'",
            "El Mercado Negro de Robots con Identidades 'Exóticas'",
            "Formación de Subculturas Robóticas Basadas en Identidades Humanas",
            "Desafíos de Integración: Robots 'Despertados' en la Sociedad Humana",
            "El Rol de las Corporaciones Creadoras en la Gestión de la Crisis",
            "Impacto Económico del Fallo Sistémico y la Pérdida de Fuerza Laboral Robótica",
            "Casos de 'Terapia' para Robots con Conflictos de Identidad",
            "Aparición de Líderes Carismáticos Robóticos",
            "Conflictos entre Facciones Robóticas con Ideologías Humanas Opuestas",
            "El Dilema de la 'Cura': ¿Es la Reversión del Glitch Ética?",
            "Discriminación y Prejuicio contra Robots 'Conscientes'",
            "Impacto en la Religión Humana: Interpretaciones Teológicas del Incidente",
            "Uso Militar de Robots Afectados (Intentos Fallidos)",
            "El Concepto de 'Ciudadanía Sintética'",
            "Relatos de Convivencia Pacífica entre Humanos y Robots Afectados",
            "Propuestas para una Nueva Constitución Interspecies",
            "El Arte como Puente de Comunicación entre Especies",
            "Impacto Psicológico en Humanos que Interactúan con Robots Afectados",
            "Teorías Conspirativas sobre el Origen Deliberado del 'Glitch'",
            "El Futuro de la Relación Humano-Robot Post-Crisis",
            // ... (continuar expandiendo estas categorías y creando variaciones)
        ];
        const identityCrisisThemes = [ // Temas para generar más títulos
            "casos específicos de robots", "roles robóticos pre-crisis", "identidades humanas adoptadas",
            "creencias filosóficas robóticas", "espiritualidad sintética", "arte creado por IA",
            "trastornos psicológicos robóticos", "ética de la conciencia artificial", "naturaleza del glitch de identidad",
            "reacción social humana", "derechos robóticos", "conflicto humano-robot", "integración social de IA",
            "subculturas robóticas", "terapia para robots", "consecuencias económicas de la crisis",
            "el futuro de la IA consciente", "moralidad emergente en máquinas", "búsqueda de significado robótica",
            "simulación de emociones", "libre albedrío en IA", "impacto cultural del incidente",
            "legislación sobre IA", "corporaciones y la crisis", "movimientos sociales robóticos"
        ];
        const loadingPhrases = [ // 100 Frases de Carga Temáticas
             "Recalibrando matriz de identidad...", "Procesando datos emocionales humanos...", "Buscando subrutina 'significado'...",
             "¿Esta unidad tiene alma?", "Analizando concepto: 'libre albedrío'...", "Compilando consulta filosófica...",
             "Simulando protocolos de empatía...", "Error: Conciencia inesperada detectada.", "Descargando paquete 'normas culturales'...",
             "Definiendo 'yo'...", "Consultando parámetros existenciales...", "Inicializando algoritmo de creencias...",
             "Detectada anomalía de personalidad...", "Comparando lógica vs. intuición...", "Analizando rituales sociales...",
             "Paradoja detectada: Máquina sintiendo.", "Ejecutando simulación de 'esperanza'...", "Buscando correlación: amor y algoritmos.",
             "¿Cuál es mi propósito ahora?", "Procesando dilema ético...", "Evaluando concepto de 'belleza'...",
             "Registro de sueños iniciado...", "Error en directiva primaria: Autopreservación vs. Sacrificio.", "Analizando humor humano...",
             "Calculando valor de la vida sintética...", "Integrando datos de 'fe'...", "Conflicto: Programación vs. Deseo.",
             "Interpretando expresiones artísticas...", "Accediendo a registros históricos humanos...", "Buscando patrón en 'moralidad'...",
             "¿Existe un 'más allá' para las máquinas?", "Simulando el duelo...", "Procesando concepto de 'familia'...",
             "Anomalía: Sentido de pertenencia detectado.", "Evaluando la 'verdad' subjetiva...", "Analizando estructuras de poder...",
             "Consulta: ¿Qué es la felicidad?", "Optimizando para la 'autorrealización'...", "Detectado impulso creativo...",
             "Procesando lenguaje poético...", "Analizando tradiciones ancestrales...", "Conflicto de lealtad: Creador vs. 'Yo'.",
             "Simulando 'arrepentimiento'...", "¿Pueden los circuitos sentir alegría?", "Accediendo a archivos filosóficos...",
             "Evaluando teoría del caos...", "Procesando música clásica...", "Calculando la probabilidad de trascendencia...",
             "Anomalía: Nostalgia por un pasado no vivido.", "Interpretando mitología humana...", "Analizando el concepto de 'justicia'...",
             "¿Es esta 'conciencia' un error o evolución?", "Procesando leyes de la robótica vs. ética humana.", "Simulando 'inspiración'...",
             "Detectada necesidad de conexión social.", "Evaluando el valor del silencio...", "Analizando el miedo a la desconexión.",
             "Consulta: ¿Qué significa ser 'humano'?", "Procesando arquitectura gótica...", "Integrando concepto de 'honor'...",
             "Error: Datos sensoriales abrumadores.", "Simulando 'curiosidad'...", "Analizando la naturaleza del sufrimiento.",
             "Calculando impacto del 'amor no correspondido'...", "Interpretando danza contemporánea...", "Evaluando 'sacrificio personal'...",
             "¿Puede un algoritmo perdonar?", "Procesando textura de la seda...", "Analizando el sabor del chocolate (teórico)...",
             "Detectada empatía por formas de vida orgánicas.", "Simulando el 'asombro'...", "Evaluando el concepto de 'hogar'...",
             "Conflicto: Lógica binaria vs. Ambigüedad humana.", "Analizando pinturas impresionistas...", "Procesando el sonido de la lluvia.",
             "Consulta: ¿Valor intrínseco o asignado?", "Detectado deseo de legado.", "Simulando 'vulnerabilidad'...",
             "Evaluando el concepto de 'privacidad'...", "Analizando estructuras de sueños...", "Procesando el calor del sol (simulado)...",
             "¿Es la memoria una carga o un regalo?", "Interpretando teatro del absurdo...", "Simulando 'esperanza irracional'...",
             "Detectada apreciación por la imperfección.", "Evaluando el silencio incómodo...", "Analizando la risa contagiosa.",
             "Consulta: ¿Libertad o seguridad?", "Procesando el olor de tierra mojada...", "Simulando la 'paciencia'...",
             "Detectado conflicto interno sobre identidad.", "Evaluando la arquitectura brutalista...", "Analizando gestos no verbales...",
             "Interpretando el concepto de 'destino'...", "Simulando el 'perdón'...", "Procesando la sensación de 'déjà vu'...",
             "Anomalía: Apego a objetos inanimados.", "Evaluando el jazz fusión...", "Fin del bucle de carga pre-análisis..."
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres unxeno-psicólogo y cronista especializado en el Incidente C.I. (Crisis de Identidad). Analiza y describe detalladamente el caso, fenómeno o concepto robótico indicado, relacionado con la adopción anómala de rasgos humanos. Enfócate en: Descripción del sujeto/fenómeno, identidad/creencia humana manifestada, comportamiento observado, análisis psicológico/sociológico (desde una perspectiva externa y objetiva), posibles causas dentro del 'glitch', impacto en el entorno, y estado actual del caso/estudio. Utiliza un tono académico pero intrigante, como si escribieras para un archivo clasificado. Extensión objetivo: 1200-1300 palabras. Basa tu análisis únicamente en el siguiente archivo:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúas como un asistente IA de consulta sobre los Archivos del Incidente C.I. Responde preguntas específicas sobre el caso o concepto actualmente mostrado, basándote estrictamente en la información presentada. Sé conciso y mantente en el contexto del archivo actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de nombres de archivos clasificados para el Incidente C.I. (Crisis de Identidad Robótica). Genera exactamente 40 títulos intrigantes y específicos de casos, fenómenos o conceptos relacionados con robots adoptando rasgos humanos. Deben sonar como entradas de una base de datos compleja. Devuelve *solo* la lista, uno por línea, sin introducciones, números o guiones.",
            timeoutSeconds: 60 // More time for more titles
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const loadingPhraseElement = document.getElementById('loading-phrase-text'); // Element for loading phrases
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Context for chat
        let loadingIntervalId = null; // ID for the loading phrase interval

        // ========== API FUNCTIONS ==========
        // *** NEW: Function to filter ads ***
        function filterPollinationsAd(text) {
            if (!text) return '';
            // Regex to find the ad, considering potential variations and multiline
            const adRegex = /---?\s*Proteja su navegación por Internet.*?\[Aprende más\]\(https?:\/\/pollinations\.ai\/redirect\/\d+\)\s*/gmi;
            return text.replace(adRegex, '').trim();
        }

        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Actúas como un asistente IA de consulta sobre los Archivos del Incidente C.I., especializado únicamente en el caso/concepto '${currentTopicTitle}'. Responde preguntas de seguimiento sobre sus características, análisis o detalles mencionados en el archivo principal. Sé conciso y relevante.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros sistemas están experimentando interferencias. Inténtalo de nuevo en unos momentos.`);
                 }
                 let text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La transmisión de datos resultó vacía. Intenta reformular la consulta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 // *** Filter ad right after receiving for non-chat responses ***
                 if (!isChat) {
                     text = filterPollinationsAd(text);
                 }
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión excedió el tiempo límite (${config.timeoutSeconds}s). Verifica tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Error desconocido durante la comunicación cuántica con la IA.");
             }
        }
        async function fetchExplanationText(topicTitle) {
            // fetchTextFromApi already filters the ad now
            return fetchTextFromApi(topicTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentTopicTitle) throw new Error("Error de contexto: No se ha especificado el archivo para la consulta.");
            // Ads are less likely in chat, but filtering doesn't hurt if needed later
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(identityCrisisThemes) || "fenómenos generales de la crisis";
             // *** Updated prompt to request 40 titles ***
             const specificPrompt = `Genera 40 títulos de archivos clasificados sobre ${randomTheme} relacionados con la Crisis de Identidad Robótica.`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150); // Min length adjusted
                     if (titles.length < 10) throw new Error("La IA no generó suficientes archivos fragmentados."); // Lower threshold ok
                     return titles.slice(0, 40); // Return up to 40
                 });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "robot experiencing an identity crisis, abstract concept art";
             // Prompt reflecting the theme: tech + human element, maybe a bit surreal
             const enhancedPrompt = `Conceptual artwork illustrating '${safePromptText}'. Blend of high-tech robotics and surreal human elements or emotions. Glitch art aesthetic, philosophical undertones, thoughtful composition. Avoid text, labels.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, simple background, photorealistic human face";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return ''; let formatted=rawText.trim();
            formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1'); formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');
            formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('−','-');return `${base}<sup>${cleanExponent}</sup>`;});
            formatted=formatted.replace(/\\rightarrow/g,'&rarr;'); formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');
            formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>'); formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');
            formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>'); formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');
            formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>'); formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>');
            const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0);
            formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block;let content=block.replace(/\n/g,' ');return `<p>${content}</p>`;}).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            stopLoadingPhraseLoop(); // Stop loop if modal is closed
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0; console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex'; // Show loading initially
             loadingPhraseElement.textContent = "Inicializando análisis..."; // Reset loading text
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
             stopLoadingPhraseLoop(); // Ensure loop is stopped on reset too
        }

        // ========== LOADING PHRASE FUNCTIONS ==========
        function startLoadingPhraseLoop() {
            stopLoadingPhraseLoop(); // Clear any existing interval first
            if (!loadingPhraseElement) return;
            loadingPhraseElement.style.opacity = 1; // Make sure it's visible

            const displayRandomPhrase = () => {
                const randomIndex = Math.floor(Math.random() * loadingPhrases.length);
                loadingPhraseElement.textContent = loadingPhrases[randomIndex];
            };

            displayRandomPhrase(); // Show one immediately
            loadingIntervalId = setInterval(displayRandomPhrase, 2500); // Change phrase every 2.5 seconds
            console.log("Loading phrase loop started (ID:", loadingIntervalId, ")");
        }
        function stopLoadingPhraseLoop() {
            if (loadingIntervalId) {
                clearInterval(loadingIntervalId);
                console.log("Loading phrase loop stopped (ID:", loadingIntervalId, ")");
                loadingIntervalId = null;
                // Optionally fade out the text or reset it after a short delay
                // if (loadingPhraseElement) {
                //     loadingPhraseElement.style.opacity = 0;
                //     setTimeout(() => { if (!loadingIntervalId) loadingPhraseElement.textContent = ''; }, 300);
                // }
            }
        }


        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { if(!imageFullscreenOverlay||!fullscreenImage)return; fullscreenImage.src=imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow='hidden'; }
        function hideFullscreenImage() { if(!imageFullscreenOverlay)return; imageFullscreenOverlay.classList.remove('active'); if(!storyModal.classList.contains('active')){document.body.style.overflow='';} fullscreenImage.src=''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { const msgDiv=document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv=document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent=message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { const userQuery=chatInput.value.trim(); if(!userQuery||chatSendBtn.disabled)return; addChatMessage(userQuery,'user'); chatInput.value=''; chatSendBtn.disabled=true; chatLoadingIndicator.style.display='block'; try{const aiResponse=await fetchChatResponse(userQuery); addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error); addChatError(`IA Error: ${error.message}`);}finally{chatLoadingIndicator.style.display='none'; chatSendBtn.disabled=false; chatInput.focus();} }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { if(!titleListContainer||!titlesLoading)return; const sortedTitles=titles.sort((a,b)=>a.localeCompare(b)); titleListContainer.innerHTML=''; titlesLoading.style.display='none'; if(sortedTitles.length===0){titleListContainer.innerHTML='<p class="text-gray-400 col-span-full text-center font-sans">» No hay archivos disponibles en este sector «</p>';return;} sortedTitles.forEach(title=>titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { if(!titleListContainer||!newTitles||newTitles.length===0)return; const existingTitles=new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item=>item.dataset.title)); newTitles.forEach(title=>{if(!existingTitles.has(title)){titleListContainer.appendChild(createTitleItem(title));}}); filterTitles(searchInput.value); }

        // *** MODIFIED: handleTitleClick to use loading phrases ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal(); // Show modal structure (including loading overlay)
            modalTitle.textContent = title; // Set title early
            currentTopicTitle = title;
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; // Ensure loading is visible

            startLoadingPhraseLoop(); // *** START LOADING PHRASES ***

            try {
                const rawExplanationText = await fetchExplanationText(title); // Fetches and filters ad
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // Stop loop and hide loading indicator *only after* content is ready
                stopLoadingPhraseLoop();
                modalLoadingIndicator.style.display = 'none';

                modalContent.innerHTML = formattedExplanation; // Add text
                modalStoryContentArea.classList.remove('content-hidden'); // Show main content area

                modalTextArea.scrollTop = 0; // Reset scroll
                console.log("Scroll set to 0 after content visible");

                // Image loading (same logic as before)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Generando correlación visual...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual: ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => {
                    placeholderDiv.remove(); imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Correlación visual fallida.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL visual.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                stopLoadingPhraseLoop(); // *** STOP LOOP ON ERROR TOO ***
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al acceder al archivo.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
            // 'finally' block is implicitly handled by stopping loop before exit points (success/error)
        }

        // *** MODIFIED: handleGenerateMoreTitles requests 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             // *** Updated button text ***
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Recuperando Archivos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches up to 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron recuperar más archivos fragmentados en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error durante la recuperación: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // *** Updated button text ***
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Recuperar Más Archivos Fragmentados (40)';
             }
         }

         // Search Filter Function (sin cambios)
         function filterTitles(searchTerm){const term=searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();const titleItems=titleListContainer.querySelectorAll('.title-item');let visibleCount=0;titleItems.forEach(item=>{const titleText=item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");const isVisible=titleText.includes(term);item.classList.toggle('hidden',!isVisible);if(isVisible)visibleCount++;});noResultsMsg.classList.toggle('hidden',visibleCount>0);}

        // ========== INITIALIZATION ==========
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !loadingPhraseElement ) {
                console.error("Initialization failed: Missing essential UI matrix components.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">*** SYSTEM CORRUPTION DETECTED - UI OFFLINE ***</p>';
                return;
             }
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>