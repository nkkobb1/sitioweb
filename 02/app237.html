<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crónicas de DB: Historias Ocultas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Estilo DB / Manga -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Dragon Ball Universe --- */
        :root {
            --color-primary: #F39C12; /* Naranja (Gi Goku) */
            --color-secondary: #3498DB; /* Azul (Gi Goku/Cielo) */
            --color-tertiary: #F1C40F; /* Amarillo (Super Saiyan/Ki) */
            --color-background: #f4f6f8; /* Blanco Hueso / Gris muy claro (Nubes) */
            --color-text: #2c3e50; /* Azul Oscuro/Gris Pizarra */
            --color-text-muted: #7f8c8d; /* Gris Nube */
            --color-modal-bg: #ffffff; /* Blanco Puro */
            --color-border: #bdc3c7; /* Borde Gris Claro */
            --color-error-bg: #fdecea; /* Fondo error rojo muy claro */
            --color-error-text: #c0392b; /* Texto error rojo oscuro */
            --color-error-border: #e74c3c; /* Borde error rojo */

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
            --border-radius: 5px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        /* Fuente Bangers para títulos y logo */
        h1, h2, h3, h4, .logo, #modal-title, .section-title, #generate-more-btn { font-family: 'Bangers', cursive; letter-spacing: 1.5px; font-weight: 400; /* Bangers ya es bold */ }
        .logo { color: var(--color-primary); -webkit-text-stroke: 1px #a05a08; /* Contorno ligero */ text-shadow: 2px 2px 3px rgba(0,0,0,0.2); }
        h1.page-title { color: var(--color-secondary); -webkit-text-stroke: 1px #206391; text-shadow: 1px 1px 2px rgba(0,0,0,0.15); }
        h2.section-title { color: var(--color-primary); border-bottom: 3px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        #modal-title { color: var(--color-secondary); }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.2rem 0.8rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #ffffff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Poppins'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.25); outline: none; background-color: #ffffff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Poppins'; font-size: 0.95rem; border-left: 4px solid var(--color-border); }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-secondary); background-color: #eaf4fc; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-tertiary)); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); font-size: 1.3rem; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-tertiary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-text-muted); color: #e0e0e0; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; text-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; /* Asegurar visibilidad */ }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(52, 73, 94, 0.85); /* Overlay azulado */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 2px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Más altura para chat y posible juego */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); box-shadow: 0 0 8px var(--color-primary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.2; }

        /* Área de Contenido Principal */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) #e0e0e0;
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: #e0e0e0; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid #c0c0c0; }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Poppins', sans-serif; /* Usar Poppins para subtítulos dentro del texto */ letter-spacing: normal; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 600; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid #e0e0e0; width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.7rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f8f9fa; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) #e0e0e0;
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: #e0e0e0; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 1rem; border-radius: 15px; /* Estilo burbuja */ max-width: 80%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-secondary); color: white; margin-left: auto; border-bottom-right-radius: 3px; }
        .ai-message { background-color: #e9ecef; color: var(--color-text); margin-right: auto; border-bottom-left-radius: 3px; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Poppins'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(243, 156, 18, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #d35400; } /* Naranja más oscuro */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator & Minigame Styles */
        #modal-loading { text-align: center; padding: 2rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #loading-message { font-weight: 600; color: var(--color-text); font-size: 1.3rem; font-family: 'Poppins'; margin-bottom: 1.5rem; }
        /* Minigame Elements */
        #minigame-area { display: flex; flex-direction: column; align-items: center; margin-top: 1rem; }
        #minigame-instructions { font-size: 0.95rem; color: var(--color-text-muted); margin-bottom: 1rem; font-family: 'Poppins'; }
        #minigame-target { /* Estilo de la esfera del dragón */ width: 80px; height: 80px; background-color: var(--color-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; border: 3px solid #c0392b; /* Rojo oscuro DB */ box-shadow: inset 0 0 15px rgba(0,0,0,0.3), 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.1s ease, box-shadow 0.1s ease; }
        #minigame-target::before { /* Brillo */ content: ''; position: absolute; top: 10%; left: 20%; width: 25%; height: 25%; background: rgba(255, 255, 255, 0.6); border-radius: 50%; transform: rotate(45deg); }
        #minigame-target .star { /* Estrella interna */ font-size: 2rem; color: #c0392b; /* Rojo oscuro */ text-shadow: 0 0 3px rgba(255,255,255,0.5); }
        #minigame-target.clicked { transform: scale(0.95); box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 2px 4px rgba(0,0,0,0.1); }
        #minigame-score-display { margin-top: 1.5rem; font-size: 1.5rem; font-weight: 600; color: var(--color-secondary); font-family: 'Poppins'; }
        #minigame-score-display span { font-weight: bold; color: var(--color-primary); }
        /* Ocultar spinner por defecto, mostrar juego */
        .loading-spinner-modal { display: none; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Poppins'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(44, 62, 80, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: var(--shadow-lg); border-radius: var(--border-radius); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-4xl sm:text-5xl flex items-center">
                     <i class="fas fa-dragon mr-3 text-red-600" style="-webkit-text-stroke: 1px black;"></i> <!-- Icono dragón -->
                     Crónicas DB
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wide">Historias Ocultas del Universo</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-4">Vidas Comunes, Universo Extraordinario</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora historias no contadas de granjeros, científicos de Capsule Corp., habitantes de ciudades y más, viviendo sus vidas mientras épicas batallas sacuden el universo Dragon Ball.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar por personaje, lugar o situación...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-secondary mr-2"></i> <!-- Icono libro -->
                 Selecciona una Historia
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Buscando historias en los archivos de Capsule Corp...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">Parece que no hay historias con esas palabras clave. ¡Intenta otra búsqueda!</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     ¡Buscar Más Historias!
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator & Minigame -->
             <div id="modal-loading">
                 <p id="loading-message">Recopilando datos de la historia...</p>
                 <!-- Minigame Area -->
                 <div id="minigame-area">
                     <p id="minigame-instructions">¡Carga Ki mientras esperas! Haz clic en la esfera:</p>
                     <div id="minigame-target" role="button" tabindex="0" aria-label="Cargar Ki">
                         <i class="fas fa-star star"></i> <!-- Estrella dentro de la esfera -->
                     </div>
                     <div id="minigame-score-display">Ki Acumulado: <span id="minigame-score">0</span></div>
                 </div>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando la Enciclopedia Galáctica...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta más sobre esta historia...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada de la Historia">
      </div>

      <!-- Footer -->
      <footer class="bg-blue-100 text-gray-700 py-6 mt-12 border-t border-blue-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias generadas por IA inspiradas en el universo Dragon Ball de Akira Toriyama.</p>
              <p class="mt-1">Estos relatos son ficticios y exploran la vida de personajes no canónicos.</p>
              <p class="mt-2">© 2025 Crónicas DB</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Vida en Ciudades Conocidas
            "Un día normal trabajando en Capsule Corp. West City",
            "El dueño de un puesto de comida durante el Torneo Mundial de Artes Marciales en Papaya Island",
            "Un estudiante de secundaria en Satan City durante la saga de Cell",
            "Un policía de West City lidiando con daños colaterales de una pelea",
            "Un reportero intentando cubrir la aparición de un 'guerrero dorado'",
            "Un taxista de hovercar en Central City",
            "Vivir en Ginger Town antes de la llegada de los Androides",
            "Un músico callejero en West City",
            "Un niño que encuentra una Cápsula Hoi-Poi perdida",
            "Un guía turístico en la zona donde aterrizó Raditz",
            "Ser vecino de Bulma en West City",
            "Un bibliotecario en una ciudad tranquila durante la paz post-Buu",
            "Un artista intentando vender cuadros en Satan City",
            "El gerente de un hotel de lujo en West City",
            "Un empleado de mantenimiento del estadio del Torneo Mundial",

            // Vida Rural y Trabajos Comunes
            "Un granjero cuyo cultivo es destruido por una onda de ki perdida",
            "Un pescador en los mares del sur de la Tierra",
            "Un leñador en los bosques cercanos a la Montaña Paoz",
            "Un minero en las montañas rocosas",
            "Un criador de dinosaurios en las llanuras",
            "Un recolector de hierbas medicinales cerca de la Torre Karin",
            "Un pastor de ovejas en una región montañosa",
            "Un constructor reparando edificios después de un ataque Saiyan",
            "Un artesano que hace réplicas de artefactos antiguos",
            "Un comerciante viajando entre pueblos remotos",
            "El cuidador de un faro en una costa aislada",
            "Un apicultor cuyas abejas son perturbadas por un entrenamiento cercano",
            "Un alfarero en un pueblo tranquilo",
            "Un maestro de escuela rural",
            "Un posadero en una ruta comercial poco transitada",

            // Interacciones con lo Extraño (DB Style)
            "Un habitante de un pueblo de hombres-animales",
            "Alguien que accidentalmente prueba agua ultra sagrada (y sobrevive)",
            "Un arqueólogo que encuentra ruinas de una civilización antigua destruida",
            "Un astrónomo aficionado que detecta naves espaciales extrañas",
            "Una persona que se hace amiga de un dinosaurio amigable",
            "Un científico de bajo nivel en el laboratorio del Dr. Gero (antes de volverse loco)",
            "Encontrar una Esfera del Dragón y no saber qué es",
            "Un explorador perdido en el Bosque del Terror",
            "Alguien que intenta aprender a volar (sin éxito)",
            "Un guardia de seguridad en el Palacio de Kamisama (antes de Dende)",
            "Un chef intentando cocinar ingredientes extraños del universo DB",
            "Un mecánico que repara vehículos de Capsule Corp.",
            "Un periodista investigando leyendas sobre el Maestro Roshi",
            "Un ermitaño que vive cerca de una zona de entrenamiento de los Guerreros Z",
            "Una persona que adopta una mascota que resulta ser un pequeño monstruo alienígena",

            // Durante Eventos Clave (Perspectiva Común)
            "Un ciudadano de East City durante el ataque de Nappa y Vegeta",
            "Un espectador en las gradas durante el combate Goku vs. Piccolo Jr.",
            "Un superviviente del ataque del Rey Piccolo a Central City",
            "Un voluntario ayudando en la reconstrucción después de la batalla contra Cell",
            "Alguien escondido en un refugio mientras Majin Buu destruye ciudades",
            "Un piloto de avión que ve una pelea a alta velocidad en el cielo",
            "Un soldado del ejército del Rey tratando de detener a Goku niño",
            "Un científico observando los niveles de energía durante la llegada de Freezer a la Tierra",
            "Un habitante de Namek (no guerrero) antes de la llegada de Freezer",
            "Un Kaio del Norte observando la Tierra desde el otro mundo",
            "Un participante eliminado temprano en el Torneo Mundial de Artes Marciales",
            "Un miembro del público reaccionando a la fusión de Goten y Trunks",
            "Un granjero viendo la luna llena y temiendo al 'mono gigante'",
            "Un empleado de Capsule Corp durante el desarrollo de la nave para Namek",
            "Un espectador de TV viendo las noticias sobre Mr. Satan 'derrotando' a Cell",

            // Historias Personales y Emocionales
            "Un estudiante de artes marciales en un dojo menor inspirado por Goku",
            "Alguien que perdió su hogar por una batalla y debe reconstruir su vida",
            "Un padre tratando de explicar los eventos extraños a sus hijos",
            "Una persona que decide entrenar después de ser salvada por un Guerrero Z",
            "Un anciano recordando los tiempos 'más simples' antes de los alienígenas",
            "Un joven que sueña con viajar al espacio como los héroes",
            "Alguien que intenta ganar Zeni para comprar tecnología de Capsule Corp.",
            "Una pareja cuya boda es interrumpida por una explosión lejana",
            "Un inventor tratando de competir con Capsule Corp.",
            "Alguien que busca las Esferas del Dragón por un deseo humilde (curar a un familiar)",
            "Un escéptico que no cree en los 'super guerreros' hasta que ve uno",
            "Un niño coleccionando figuras de acción de los héroes del Torneo Mundial",
            "Una persona tratando de mantener la calma durante un ataque de pánico masivo",
            "Un científico estudiando los efectos residuales de Ki en el ambiente",
            "Alguien que escribe un diario sobre los eventos increíbles que suceden",

             // Más Ideas Variadas
             "Un guardia en la Prisión Galáctica (antes de Moro)",
             "Un cocinero en el Torneo del Poder (para los dioses)",
             "Un namekiano agricultor en Nuevo Namek",
             "Un ayudante de Pilaf antes de conocer a Goku",
             "Un miembro de la Patrulla Roja de bajo rango",
             "Un habitante del Planeta Vegeta (antes de su destrucción)",
             "Un sirviente en el palacio del Rey Vegeta",
             "Un técnico de mantenimiento de Scouters en el ejército de Freezer",
             "Un Yadratsiano común enseñando técnicas básicas",
             "Un habitante del planeta Metamoru",
             "Un miembro de la audiencia en el torneo entre Universo 6 y 7",
             "Un Kaioshin aprendiz observando universos",
             "Un dios de la destrucción antes de Beerus (en otro universo)",
             "Un ángel asistente en entrenamiento",
             "Un trabajador en la fábrica de Senzu Beans de Karin",
             "Un monje en el templo de Orin",
             "Un empleado del parque de diversiones visitado por Vegeta y Trunks",
             "Un contrabandista de tecnología espacial de bajo nivel",
             "Un historiador intentando documentar la verdad tras Mr. Satan",
             "Un fanático de las artes marciales que idolatra a Krilin",
             "Un habitante de un planeta pacífico visitado brevemente por los Saiyans",
             "Un mecánico de naves espaciales en un puerto espacial remoto",
             "Un granjero que encuentra un cráter de aterrizaje de una Attack Ball",
             "Un testigo del primer deseo concedido por Porunga en Namek",
             "Un empleado de la tienda de ropa donde Vegeta compró ropa terrestre",
             "Un chef que intenta recrear la comida que Goku devora",
             "Un niño que juega a ser los Guerreros Z con sus amigos",
             "Un vendedor de seguros lidiando con reclamaciones por 'ataques alienígenas'",
             "Un psicólogo tratando de ayudar a la gente con estrés post-traumático por batallas",
             "Un actor interpretando a un Guerrero Z en una película de bajo presupuesto",
             // Continuar expandiendo con más situaciones, lugares y roles...
        ];
        const dragonBallThemes = [
            "vida en West City", "trabajadores de Capsule Corp", "granjeros del universo DB", "espectadores del Torneo Mundial", "supervivientes de ataques (Saiyan, Cell, Buu)", "gente común usando tecnología Capsule", "habitantes de pueblos remotos", "hombres-animales", "interacción con dinosaurios", "estudiantes de artes marciales menores", "reporteros cubriendo eventos DB", "científicos de bajo nivel", "encontrar artefactos DB", "vida durante la paz", "vida en Satan City", "reconstrucción post-batalla", "el ejército del Rey", "la Patrulla Roja (perspectiva baja)", "habitantes de otros planetas (Namek, Yardrat)", "vida cotidiana con Ki visible", "reacciones a Mr. Satan", "comercio interplanetario menor", "arqueología en ruinas DB"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un talentoso narrador de historias del universo Dragon Ball. Tu especialidad son las vidas de la gente común, los personajes secundarios olvidados que viven en este mundo extraordinario. Narra una historia corta (aproximadamente 1200-1300 palabras) basada en el siguiente personaje o situación. Enfócate en sus pensamientos, sentimientos y experiencias cotidianas, mostrando cómo el loco mundo de Dragon Ball (con sus héroes, villanos, tecnología y eventos extraños) impacta en su vida normal. Captura el tono a veces humorístico, a veces dramático, pero siempre lleno de acción latente del universo DB. Basa tu historia únicamente en esta premisa:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
             systemPrompt: "Actúas como un experto en el universo Dragon Ball y un conocedor de la historia específica que se acaba de contar. Responde preguntas sobre los detalles de esa historia, el personaje, su entorno, o cómo se relaciona con eventos conocidos del canon DB (si aplica). Sé preciso y mantente enfocado en la historia actual y el universo DB.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // *** PROMPT ACTUALIZADO PARA 40 TÍTULOS ***
            systemPrompt: "Actúa como un generador de ideas conciso para historias del universo Dragon Ball. Genera exactamente 40 ideas únicas y evocadoras para historias cortas centradas en *personas comunes y corrientes* (NO los Guerreros Z principales) que viven en el universo Dragon Ball. Piensa en diferentes profesiones, lugares, épocas y cómo los eventos mayores afectan a la gente normal. Devuelve *solo* la lista de ideas, una por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentar un poco por si necesita más tiempo para 40
        };

        // ========== DOM ELEMENTS ==========
        // ... (Igual que antes: searchInput, titleListContainer, etc.) ...
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const loadingMessage = document.getElementById('loading-message');
        const minigameArea = document.getElementById('minigame-area');
        const minigameTarget = document.getElementById('minigame-target');
        const minigameScoreDisplay = document.getElementById('minigame-score');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Contexto para el chat
        let minigameScore = 0;
        let isMinigameActive = false;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             // Usar prompt de sistema dinámico para chat
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `Eres un experto en Dragon Ball y en la historia sobre '${currentStoryTitle}'. Responde preguntas sobre esta historia, sus personajes, o el universo DB relacionado. Sé conciso y relevante.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) ¡Oh no! Parece que los servidores de Capsule Corp. están sobrecargados. Intenta de nuevo en un momento.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La IA no pudo generar la historia o respuesta. ¡Intenta con otra idea!");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con la Red Ribbon falló (timeout >${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Un error inesperado ocurrió mientras se contactaba a Kamisama (la IA).");
             }
        }
        async function fetchExplanationText(conceptTitle) {
             return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
             if (!currentStoryTitle) throw new Error("Error interno: No se estableció el contexto de la historia para el chat.");
             return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(dragonBallThemes) || "vida común en Dragon Ball";
             const specificPrompt = `Genera 40 ideas de historias sobre ${randomTheme}`;
             // Usa la función genérica fetchTextFromApi con la config actualizada
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150);
                     // *** ESPERAR 40 TÍTULOS ***
                     if (titles.length < 20) { // Ser un poco flexible, pero esperar un buen número
                         console.warn(`Se esperaban 40 títulos, pero solo se generaron ${titles.length}`);
                         if (titles.length === 0) throw new Error("La IA no generó ninguna idea nueva.");
                     }
                     return titles.slice(0, 40); // Devolver hasta 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "a common person in the Dragon Ball universe";
            // Prompt adaptado a DB
            const enhancedPrompt = `Slice of life scene featuring ordinary people based on the story '${safePromptText}'. Akira Toriyama inspired art style, anime aesthetic, dynamic composition. Focus on the character(s) and their environment (city, countryside, Capsule Corp tech). Avoid showing main Z-Fighters prominently unless the story demands it. No text, labels.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, realistic photograph, 3D render, blurry, low quality, multiple panels";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (identical to previous version) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MINIGAME FUNCTIONS ==========
        function resetMinigame() {
            minigameScore = 0;
            isMinigameActive = false;
            if (minigameScoreDisplay) minigameScoreDisplay.textContent = minigameScore;
            if (minigameTarget) {
                minigameTarget.removeEventListener('click', handleMinigameClick);
                minigameTarget.classList.remove('clicked'); // Reset visual state
            }
            if (minigameArea) minigameArea.style.display = 'none'; // Ocultar por defecto
             if (loadingMessage) loadingMessage.style.display = 'block'; // Mostrar mensaje normal
        }
        function startMinigame() {
            resetMinigame(); // Ensure clean state
            isMinigameActive = true;
            if (minigameArea) minigameArea.style.display = 'flex'; // Mostrar juego
             if (loadingMessage) loadingMessage.style.display = 'none'; // Ocultar mensaje normal
            if (minigameTarget) {
                 minigameTarget.addEventListener('click', handleMinigameClick);
             }
            console.log("Minigame started");
        }
        function stopMinigame() {
            isMinigameActive = false;
            if (minigameTarget) {
                 minigameTarget.removeEventListener('click', handleMinigameClick);
                 minigameTarget.classList.remove('clicked');
             }
            // No ocultar inmediatamente, la transición a contenido lo hará
            console.log("Minigame stopped. Final Ki:", minigameScore);
        }
        function handleMinigameClick() {
            if (!isMinigameActive || !minigameTarget) return;
            minigameScore++;
            if (minigameScoreDisplay) minigameScoreDisplay.textContent = minigameScore;

            // Feedback visual
            minigameTarget.classList.add('clicked');
            setTimeout(() => {
                if (minigameTarget) minigameTarget.classList.remove('clicked');
            }, 100); // Duración del efecto 'clicked'
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            resetModalState(); // Llama a resetMinigame internamente
        }
        function resetModalState() {
             resetMinigame(); // Resetea el minijuego primero
             modalLoadingIndicator.style.display = 'flex'; // Mostrar área de carga (que ahora contiene el juego)
             modalStoryContentArea.classList.add('content-hidden'); // Ocultar contenido principal
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error Enciclopedia: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">¡Parece que Shen Long no encontró historias ahora!</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Added ${addedCount} new titles.`);
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to manage minigame lifecycle ***
        async function handleTitleClick(title) {
            resetModalState(); // Resets everything, including minigame state
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title;
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; // Show loading area
            startMinigame(); // <<< START MINIGAME HERE

            try {
                // Fetch text while minigame is active
                const rawExplanationText = await fetchExplanationText(title);
                stopMinigame(); // <<< STOP MINIGAME BEFORE PROCESSING/SHOWING
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none'; // Hide loading/game area
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Show content

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Image Handling (same as before)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-cloud placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.7rem;">Buscando imagen en el Otro Mundo...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración de: ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se encontró la imagen.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                stopMinigame(); // <<< STOP MINIGAME ON ERROR TOO
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la historia.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando con el Radar del Dragón...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Should fetch 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("¡Parece que el radar no encontró más historias ahora!"); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error buscando historias: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> ¡Buscar Más Historias!';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Add minigame elements to check
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameArea || !minigameTarget || !minigameScoreDisplay) {
                console.error("Initialization failed: Missing essential elements (incl. minigame).");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡Alerta! ¡El Scouter está dañado! Faltan componentes UI.</p>';
                return;
             }
            // Standard listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Ensure minigame is initially hidden within the loading screen structure
             resetMinigame(); // Called here to set initial hidden state correctly

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>