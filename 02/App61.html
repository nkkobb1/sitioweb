<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glosario de Derecho Constitucional</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;0,700;1,400&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #1e3a8a; /* Dark Blue */
            --color-secondary: #9ca3af; /* Cool Gray */
            --color-background: #f9fafb; /* Off-white */
            --color-text: #1f2937; /* Dark Gray */
            --color-text-muted: #6b7280; /* Medium Gray */
            --color-modal-bg: #ffffff;
            --color-border: #d1d5db; /* Light Gray */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Source Sans Pro', sans-serif; background-color: var(--color-background); color: var(--color-text); }
        h1, h2, h3, h4, .logo { font-family: 'Lora', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 60px; }
        .title-item i { color: var(--color-primary); margin-right: 0.75rem; width: 20px; text-align: center; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); }
        .title-item:hover i { color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Source Sans Pro', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1e40af; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem; max-width: 900px; width: 95%; max-height: 90vh; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e5e7eb; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.4rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #d1d5db; color: var(--color-text); }
        #modal-title { color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; font-size: 1.6rem; }
        #modal-content { line-height: 1.75; color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 15px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content::-webkit-scrollbar { width: 8px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: #4b5563; font-style: italic; } /* Muted italic */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Lora', serif; margin-top: 1.8em; margin-bottom: 0.8em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.3em; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.2em; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-secondary); font-weight: 600; border-bottom: none; }
        #modal-content .formula { /* Keep for potential rare cases */ text-align: center; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 1.1em; padding: 0.8em; margin: 1.2em 0; border: 1px solid var(--color-border); background-color: #f9fafb; border-radius: var(--border-radius); overflow-x: auto; white-space: nowrap; }
        #modal-content .formula sub, #modal-content .formula sup { font-size: 0.8em; line-height: 0; position: relative; vertical-align: baseline; }
        #modal-content .formula sub { top: 0.5em; }
        #modal-content .formula sup { top: -0.5em; }
        #modal-image-container { width: 100%; height: 250px; background-color: #e5e7eb; border-radius: var(--border-radius); overflow: hidden; display: none; /* Start hidden */ align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; margin-top: 1rem; }
        #modal-image-container.visible { display: flex; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 3rem; color: var(--color-border); display: none; }
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: var(--border-radius); border: 1px solid #fecaca; margin-top: 1rem; text-align: center; flex-shrink: 0; }
        .error-msg i { margin-right: 0.5rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
    <!-- Header/Navbar -->
    <nav class="navbar mb-10">
        <div class="container mx-auto px-4 py-4 flex justify-center items-center">
            <div class="flex items-center">
                <h1 class="logo text-2xl sm:text-3xl">
                    <i class="fas fa-landmark mr-3"></i> Glosario de Derecho Constitucional
                </h1>
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <main class="container mx-auto px-4 pb-16">
        <!-- Hero section -->
        <section class="mb-12 text-center">
            <h1 class="page-title text-4xl sm:text-5xl mb-4">Entendiendo la Ley Fundamental</h1>
            <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Explora conceptos clave del Derecho Constitucional con explicaciones claras generadas por IA.</p>
        </section>

        <!-- Title List Container -->
        <section class="mb-10">
            <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                <i class="fas fa-book-open text-blue-700 mr-2"></i>
                Términos a Explorar
            </h2>
            <div id="title-list">
                 <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Consultando fuentes...</p>
            </div>
            <div id="generate-more-container" class="text-center mt-8">
                <button id="generate-more-btn">
                     <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                    Generar Más Términos
                 </button>
            </div>
        </section>

    </main>

    <!-- Explanation Modal -->
    <div id="story-modal">
        <div class="modal-content-wrapper">
            <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

            <!-- Loading Indicator -->
            <div id="modal-loading">
                <div class="loading-spinner-modal"></div>
                <p>Elaborando definición...</p>
            </div>

            <!-- Content Area -->
            <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                <!-- Text Content (Scrollable) -->
                <div id="modal-content" class="text-base md:text-lg">
                    <!-- Explanation text (HTML) goes here -->
                </div>
                 <!-- Image Container (Initially Hidden) -->
                <div id="modal-image-container">
                    <div class="spinner"></div>
                    <i class="fas fa-balance-scale placeholder-icon"></i> <!-- Placeholder icon -->
                    <img id="modal-image" alt="Visualización abstracta del concepto legal" />
                </div>
                 <!-- Error Display Area -->
                <div id="modal-error" class="error-msg content-hidden">
                     <i class="fas fa-exclamation-triangle"></i>
                     <span id="modal-error-message"></span>
                 </div>
            </div>
         </div>
     </div>

     <!-- Footer -->
     <footer class="bg-gray-100 text-gray-600 py-5 mt-12 border-t border-gray-200">
         <div class="container mx-auto px-4 text-center text-sm">
             <p>Explicaciones generadas por IA con fines educativos e informativos. El Derecho es complejo, consulte siempre fuentes expertas y profesionales.</p>
             <p class="mt-1">© 2025 Glosario Constitucional IA</p>
         </div>
     </footer>


    <script>
        // ========== CONFIG & DATA ==========
        // --- NOTE: 400 is a very large list to maintain here. ---
        // --- This is a substantial sample (~150). Add more as needed. ---
        const predefinedTitles = [
            "Constitución (Concepto)", "Poder Constituyente", "Poder Constituido", "Supremacía Constitucional", "Rigidez Constitucional", "Flexibilidad Constitucional", "Estado de Derecho", "Separación de Poderes", "Sistema Presidencialista", "Sistema Parlamentario", "Sistema Semipresidencialista", "Control de Constitucionalidad", "Control Difuso", "Control Concentrado", "Acción de Inconstitucionalidad", "Amparo (o Recurso de Protección)", "Habeas Corpus", "Habeas Data", "Omisión Legislativa", "Derechos Fundamentales (Concepto)", "Derechos Humanos", "Derechos Civiles", "Derechos Políticos", "Derechos Sociales, Económicos y Culturales (DESC)", "Derechos de Primera Generación", "Derechos de Segunda Generación", "Derechos de Tercera Generación (Solidaridad)", "Principio Pro Homine (Pro Persona)", "Dignidad Humana", "Derecho a la Vida", "Libertad de Expresión", "Libertad de Prensa", "Libertad de Reunión", "Libertad de Asociación", "Libertad Religiosa y de Culto", "Laicidad del Estado", "Derecho a la Igualdad", "No Discriminación", "Acciones Afirmativas (Discriminación Positiva)", "Derecho a la Propiedad", "Función Social de la Propiedad", "Expropiación", "Debido Proceso Legal", "Derecho a la Defensa", "Presunción de Inocencia", "Irretroactividad de la Ley Penal", "Ne Bis In Idem (Non Bis In Idem)", "Derecho a la Intimidad (Privacidad)", "Inviolabilidad del Domicilio", "Secreto de las Comunicaciones", "Derecho al Voto (Sufragio Activo)", "Derecho a ser Elegido (Sufragio Pasivo)", "Ciudadanía", "Nacionalidad", "Soberanía Popular", "Democracia Directa", "Democracia Representativa", "Referéndum", "Plebiscito", "Iniciativa Legislativa Popular", "Revocatoria del Mandato", "Poder Legislativo (Congreso, Parlamento)", "Bicameralismo", "Unicameralismo", "Proceso Legislativo (Formación de Leyes)", "Veto Presidencial", "Inmunidad Parlamentaria", "Poder Ejecutivo (Gobierno)", "Jefe de Estado", "Jefe de Gobierno", "Ministerios (Secretarías)", "Administración Pública", "Potestad Reglamentaria", "Estado de Excepción (Sitio, Emergencia)", "Poder Judicial (Jurisdicción)", "Independencia Judicial", "Tribunal Supremo (Corte Suprema)", "Tribunal Constitucional (Corte Constitucional)", "Consejo de la Judicatura (Magistratura)", "Ministerio Público (Fiscalía)", "Defensoría del Pueblo (Ombudsman)", "Federalismo", "Estado Federal", "Estado Unitario", "Estado Regional (Autonómico)", "Distribución de Competencias", "Municipio (Ayuntamiento)", "Autonomía Local", "Reforma Constitucional", "Mutación Constitucional", "Bloque de Constitucionalidad", "Tratados Internacionales de Derechos Humanos", "Control de Convencionalidad", "Interpretación Constitucional", "Métodos de Interpretación Constitucional", "Preámbulo de la Constitución", "Norma Fundamental (Grundnorm - Kelsen)", "Constitucionalismo", "Neoconstitucionalismo", "Garantías Constitucionales", "Justicia Constitucional", "Activismo Judicial", "Autocontención Judicial (Self-Restraint)", "Cosa Juzgada Constitucional", "Sentencias Interpretativas", "Sentencias Aditivas", "Estado Social de Derecho", "Principio de Legalidad", "Reserva de Ley", "Tipicidad", "Libertad Personal", "Derecho a la Salud", "Derecho a la Educación", "Derecho al Trabajo", "Libertad Sindical", "Derecho a la Seguridad Social", "Derecho a un Medio Ambiente Sano", "Derechos de los Pueblos Indígenas", "Jurisdicción Indígena", "Pluralismo Jurídico", "Derechos del Niño", "Derechos de la Mujer", "Igualdad de Género", "Matrimonio Igualitario", "Libre Desarrollo de la Personalidad", "Objeción de Conciencia", "Derecho de Petición", "Acceso a la Información Pública", "Transparencia Gubernamental", "Responsabilidad del Estado", "Control Político (Parlamentario)", "Moción de Censura", "Interpelación Parlamentaria", "Juicio Político (Impeachment)", "Financiación de Partidos Políticos", "Sistemas Electorales", "Representación Proporcional", "Sistema Mayoritario", "Umbral Electoral", "Ordenamiento Jurídico", "Jerarquía Normativa", "Costumbre Constitucional", "Principios Constitucionales", "Valores Constitucionales", "Fuerza Normativa de la Constitución", "Parte Dogmática de la Constitución", "Parte Orgánica de la Constitución", "Secularización", "Objeción de Conciencia"
        ];
        // --- Themes for generating new titles ---
        const lawThemes = [
            "derechos fundamentales", "garantías constitucionales", "control de constitucionalidad", "organización del poder", "formas de estado", "formas de gobierno", "democracia y participación", "historia del constitucionalismo", "interpretación constitucional", "derechos sociales", "relaciones internacionales y constitución", "justicia constitucional", "principios constitucionales", "reforma y mutación constitucional", "federalismo y descentralización", "derechos de grupos específicos", "estado de excepción", "poder legislativo", "poder ejecutivo", "poder judicial"
        ];
        // --- API Configuration ---
        const textApiConfig = {
            model: "mistral", // Or another powerful model if available
            systemPrompt: "Eres un catedrático experto en Derecho Constitucional. Tu tarea es definir y explicar un término o concepto jurídico-constitucional específico de forma exhaustiva, clara y precisa, como si fuera una entrada de un glosario académico avanzado pero accesible para estudiantes de derecho o interesados. Debes: 1) Definir el término concisamente. 2) Explicar su origen y evolución si es relevante. 3) Detallar su contenido, alcance y límites. 4) Mencionar su importancia dentro del sistema constitucional. 5) Incluir ejemplos o referencias a casos relevantes (si aplica, de forma genérica o hipotética si no se pide un país). 6) Relacionarlo con otros conceptos constitucionales clave. 7) Utilizar un lenguaje formal y técnico pero explicando la terminología compleja. La extensión debe ser aproximadamente de 1200 a 1300 palabras. Estructura el texto con párrafos claros y subtítulos (usando markdown #, ##, ###, ####) para facilitar la lectura. Basa tu explicación únicamente en el siguiente término o concepto:",
            timeoutSeconds: 150 // Increased timeout for longer text
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un glosario. Genera exactamente 15 términos o conceptos clave de Derecho Constitucional, adecuados para ser explicados detalladamente. Devuelve *solo* la lista de términos/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40 // Slightly more time if needed
        };

        // ========== DOM ELEMENTS ========== (sin cambios)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // --- Variable to hold the current scroll listener ---
        let currentScrollHandler = null;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) {
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`); // Log truncated URL
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 // Basic check for very short or refusal responses
                 if (text.trim().length < 500 && (text.toLowerCase().includes("no puedo") || text.toLowerCase().includes("cannot fulfill"))) {
                     console.warn("API response seems too short or is a refusal.");
                     throw new Error("La IA no pudo generar una explicación adecuada (respuesta demasiado corta o rechazo).");
                 }
                 console.log(`Received text length: ${text.length}`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo o con otro término.`);
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
             }
         }
        async function fetchExplanationText(conceptTitle) {
             // Add specific instructions if needed, or rely on the system prompt
             const promptForApi = conceptTitle; // Use the title directly as the concept
             const text = await fetchTextFromApi(promptForApi, textApiConfig);
             return text;
         }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(lawThemes) || "conceptos constitucionales generales";
             const specificPrompt = `Genera 15 términos o conceptos clave sobre ${randomTheme} en Derecho Constitucional`;
             console.log("Generating concepts with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n')
                .map(line => line.replace(/^[-\d.\s*]+/, '').replace(/\.$/, '').trim()) // Remove list markers and trailing dots
                .filter(line => line.length > 4 && line.length < 150); // Filter reasonably sized titles
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de términos.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "constitutional law concept";
             // More abstract prompt for law
             const enhancedPrompt = `Abstract visualization representing the legal or constitutional concept of '${safePromptText}', symbolic, minimalist, using metaphors of balance, structure, rights, or governance, conceptual art`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Stronger negative prompt against literal interpretations
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, paragraphs, book pages, legal documents, codes, articles, sections, laws, court scene, courtroom, judge, gavel, lawyers, people, person, flag, national symbols, specific building, government building, constitution document, signature, realistic photo, drawing of people, illustration of court";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Scroll reset logic verified)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll when closing
            console.log("Scroll set to 0 on hideModal");
            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
                console.log("Scroll listener removed on hideModal.");
            }
            resetModalState(); // Reset other visual elements
        }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.classList.remove('visible');
             modalImageContainer.style.display = 'none';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // Add an icon for visual flair
            const icon = document.createElement('i');
            icon.className = 'fas fa-gavel fa-fw'; // Gavel icon
            div.appendChild(icon);
            const textSpan = document.createElement('span');
            textSpan.textContent = title;
            div.appendChild(textSpan);
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]);
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay términos disponibles.</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        /**
         * Handles clicking a title: shows modal, loads explanation, resets scroll,
         * and sets up conditional image loading.
         */
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalImageContainer.style.display = 'none';
            modalImageContainer.classList.remove('visible');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
            }

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;

                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.scrollTop = 0; // <<<--- RESET SCROLL HERE
                console.log("Scroll set to 0 after content visible");

                modalImageSpinner.style.display = 'block';
                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL:", title);
                     modalImageSpinner.style.display = 'none';
                     modalImagePlaceholder.style.display = 'block';
                 }

                const scrollBuffer = 20; // Generous buffer
                currentScrollHandler = () => {
                    const isScrolledToBottom = (modalContent.scrollTop + modalContent.clientHeight) >= (modalContent.scrollHeight - scrollBuffer);
                    const contentFits = modalContent.scrollHeight <= modalContent.clientHeight;

                    if (contentFits || isScrolledToBottom) {
                        if (!modalImageContainer.classList.contains('visible')) {
                             console.log(`Image shown. Reason: ${contentFits ? 'Content fits' : 'Scroll end'}`);
                             modalImageContainer.classList.add('visible');
                             modalImageContainer.style.display = 'flex';
                        }
                         // Optionally remove listener once image is shown
                         // modalContent.removeEventListener('scroll', currentScrollHandler);
                         // currentScrollHandler = null;
                         // console.log("Scroll listener removed after showing image.");
                    } else {
                         // If user scrolls back up, hide the image again (optional)
                         // if (modalImageContainer.classList.contains('visible')) {
                         //    console.log("Scrolled up, hiding image.");
                         //    modalImageContainer.classList.remove('visible');
                         //     modalImageContainer.style.display = 'none';
                         // }
                    }
                };
                modalContent.addEventListener('scroll', currentScrollHandler);
                console.log("Scroll listener added.");
                // Initial check shortly after rendering
                setTimeout(() => {
                    if(modalContent.scrollHeight <= modalContent.clientHeight && !modalImageContainer.classList.contains('visible')) {
                        console.log("Initial check: Content fits, showing image.");
                        modalImageContainer.classList.add('visible');
                        modalImageContainer.style.display = 'flex';
                        // Optionally remove listener if shown initially
                        // modalContent.removeEventListener('scroll', currentScrollHandler);
                        // currentScrollHandler = null;
                    }
                }, 200);


            } catch (error) {
                console.error("Failed to display explanation:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error al cargar definición: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = '';
                 if (currentScrollHandler) {
                    modalContent.removeEventListener('scroll', currentScrollHandler);
                    currentScrollHandler = null;
                 }
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se pudieron generar nuevos términos en este momento."); }
             } catch (error) { console.error("Failed title generation:", error); alert(`Error al generar términos: ${error.message}`);
             } finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Términos'; }
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p>Error crítico al inicializar.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            // Start with the predefined list
            if(predefinedTitles && predefinedTitles.length > 0) {
                displayTitles(predefinedTitles);
            } else {
                // Optionally fetch initial titles if predefined list is empty
                 handleGenerateMoreTitles();
                 titlesLoading.textContent = "Generando términos iniciales...";
                 generateMoreContainer.style.display = 'none'; // Hide button while initial fetch runs
            }
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>