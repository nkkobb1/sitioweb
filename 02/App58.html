<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glosario de Derecho Civil</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #1d4ed8; /* Azul más oscuro/profesional */
            --color-secondary: #7e22ce; /* Púrpura */
            --color-background: #f9fafb;
            --color-text: #1f2937;
            --color-text-muted: #6b7280;
            --color-modal-bg: #ffffff;
            --color-border: #d1d5db; /* Borde ligeramente más oscuro */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); }
        h1, h2, h3, h4, .logo { font-family: 'Quicksand', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1e40af; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem; max-width: 900px; /* Slightly wider for longer text */ width: 95%; max-height: 90vh; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e5e7eb; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.4rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #d1d5db; color: var(--color-text); }
        #modal-title { color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; font-size: 1.5rem; /* Slightly larger title */ }
        #modal-content { line-height: 1.75; /* Slightly more spacing for legal text */ color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 10px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content::-webkit-scrollbar { width: 8px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Quicksand', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.2em; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-secondary); }
        #modal-content .formula { /* Keep formula style for potential rare cases */ text-align: center; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 1.1em; padding: 0.8em; margin: 1.2em 0; border: 1px solid var(--color-border); background-color: #f9fafb; border-radius: var(--border-radius); overflow-x: auto; white-space: nowrap; }
        #modal-content .formula sub, #modal-content .formula sup { font-size: 0.8em; line-height: 0; position: relative; vertical-align: baseline; }
        #modal-content .formula sub { top: 0.5em; }
        #modal-content .formula sup { top: -0.5em; }
        #modal-image-container { width: 100%; height: 220px; background-color: #f3f4f6; border-radius: var(--border-radius); overflow: hidden; display: none; /* Start hidden */ align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; margin-top: 1rem; }
        #modal-image-container.visible { display: flex; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 2.5rem; color: var(--color-border); display: none; }
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: var(--border-radius); border: 1px solid #fecaca; margin-top: 1rem; text-align: center; flex-shrink: 0; }
        .error-msg i { margin-right: 0.5rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
    <!-- Header/Navbar -->
    <nav class="navbar mb-8">
        <div class="container mx-auto px-4 py-3 flex justify-center items-center">
            <div class="flex items-center">
                <h1 class="logo text-2xl sm:text-3xl">
                    <i class="fas fa-gavel mr-2"></i> Glosario de Derecho Civil
                </h1>
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <main class="container mx-auto px-4 pb-16">
        <!-- Hero section -->
        <section class="mb-12 text-center">
            <h1 class="page-title text-4xl sm:text-5xl mb-4">Entendiendo el Derecho Civil</h1>
            <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Definiciones claras y explicaciones detalladas de términos fundamentales del Derecho Civil, generadas por IA.</p>
        </section>

        <!-- Title List Container -->
        <section class="mb-10">
            <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                <i class="fas fa-balance-scale text-purple-500 mr-2"></i>
                Términos a Explorar
            </h2>
            <div id="title-list">
                 <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Consultando códigos...</p>
            </div>
            <div id="generate-more-container" class="text-center mt-8">
                <button id="generate-more-btn">
                     <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                    Generar Más Términos
                 </button>
            </div>
        </section>

    </main>

    <!-- Explanation Modal -->
    <div id="story-modal">
        <div class="modal-content-wrapper">
            <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

            <!-- Loading Indicator -->
            <div id="modal-loading">
                <div class="loading-spinner-modal"></div>
                <p>Elaborando definición...</p>
            </div>

            <!-- Content Area -->
            <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                <!-- Text Content (Scrollable) -->
                <div id="modal-content" class="text-base md:text-lg">
                    <!-- Explanation text (HTML) goes here -->
                </div>
                 <!-- Image Container (Initially Hidden) -->
                <div id="modal-image-container">
                    <div class="spinner"></div>
                    <i class="fas fa-landmark placeholder-icon"></i> <!-- Placeholder icon -->
                    <img id="modal-image" alt="Visualización abstracta del concepto legal" />
                </div>
                 <!-- Error Display Area -->
                <div id="modal-error" class="error-msg content-hidden">
                     <i class="fas fa-exclamation-triangle"></i>
                     <span id="modal-error-message"></span>
                </div>
            </div>
         </div>
     </div>

     <!-- Footer -->
     <footer class="bg-gray-100 text-gray-600 py-5 mt-12 border-t border-gray-200">
         <div class="container mx-auto px-4 text-center text-sm">
             <p>Contenido generado por IA con fines educativos e informativos. No sustituye el asesoramiento legal profesional.</p>
             <p class="mt-1">© 2025 Glosario de Derecho Civil</p>
         </div>
     </footer>


    <script>
        // ========== CONFIG & DATA ==========
        // --- IMPORTANTE: Ampliar esta lista manualmente hasta ~400 términos ---
        // --- Se incluye una muestra representativa (~200) para funcionalidad ---
        const predefinedTitles = [
            "¿Qué es el Derecho Civil?", "Fuentes del Derecho Civil", "La Ley como Fuente Principal", "La Costumbre Jurídica", "La Jurisprudencia", "Principios Generales del Derecho", "Persona Física (Natural)", "Nacimiento y Extinción de la Personalidad", "Capacidad Jurídica", "Capacidad de Obrar", "Mayoría de Edad", "Minoría de Edad", "Incapacitación Judicial", "Tutela y Curatela", "Emancipación", "Domicilio Real y Legal", "Ausencia y Declaración de Fallecimiento", "Derechos de la Personalidad (Honor, Intimidad, Imagen)", "Estado Civil", "Registro Civil", "Persona Jurídica", "Tipos de Personas Jurídicas (Asociaciones, Fundaciones, Sociedades)", "Atributos de la Persona Jurídica", "Objeto del Derecho: Los Bienes", "Clasificación de los Bienes (Muebles/Inmuebles)", "Bienes Fungibles y No Fungibles", "Bienes Consumibles y No Consumibles", "Bienes Divisibles e Indivisibles", "Bienes Públicos y Privados", "Frutos y Productos", "Patrimonio", "Hecho Jurídico", "Acto Jurídico", "Clasificación de los Actos Jurídicos", "Elementos Esenciales del Acto Jurídico (Consentimiento, Objeto, Causa, Forma)", "Vicios del Consentimiento (Error, Dolo, Violencia, Intimidación)", "Nulidad Absoluta y Relativa del Acto Jurídico", "Anulabilidad", "Simulación del Acto Jurídico", "Representación Legal y Voluntaria", "Obligaciones: Concepto y Elementos", "Fuentes de las Obligaciones (Ley, Contratos, Cuasicontratos, Delitos, Cuasidelitos)", "Clasificación de las Obligaciones (Dar, Hacer, No Hacer)", "Obligaciones Civiles y Naturales", "Obligaciones Puras, Condicionales y a Plazo", "Obligaciones Alternativas y Facultativas", "Obligaciones Mancomunadas y Solidarias", "Obligaciones Divisibles e Indivisibles", "Obligaciones con Cláusula Penal", "Extinción de las Obligaciones", "El Pago o Cumplimiento", "Pago por Consignación", "Compensación", "Condonación o Remisión de la Deuda", "Confusión de Derechos", "Novación", "Pérdida de la Cosa Debida", "Prescripción Extintiva", "Incumplimiento de las Obligaciones", "Mora del Deudor", "Culpa y Dolo en el Incumplimiento", "Caso Fortuito y Fuerza Mayor", "Responsabilidad Civil Contractual", "Indemnización de Daños y Perjuicios (Daño Emergente, Lucro Cesante)", "Cláusula 'Rebus Sic Stantibus'", "Contratos: Concepto y Principios", "Autonomía de la Voluntad", "Elementos Esenciales del Contrato (Consentimiento, Objeto, Causa)", "Formación del Contrato (Oferta y Aceptación)", "Contratos Preparatorios (Promesa)", "Clasificación de los Contratos (Unilaterales/Bilaterales, Onerosos/Gratuitos, etc.)", "Interpretación de los Contratos", "Ineficacia de los Contratos (Nulidad, Anulabilidad, Rescisión)", "Contrato de Compraventa", "Obligaciones del Vendedor y Comprador", "Saneamiento por Evicción y Vicios Ocultos", "Contrato de Permuta", "Contrato de Donación", "Contrato de Arrendamiento (Cosas, Servicios, Obras)", "Contrato de Sociedad Civil", "Contrato de Mandato", "Contrato de Préstamo (Comodato y Mutuo)", "Contrato de Depósito", "Contrato de Fianza", "Cuasicontratos (Gestión de Negocios Ajenos, Cobro de lo Indebido)", "Responsabilidad Civil Extracontractual (Aquiliana)", "Elementos de la Responsabilidad Extracontractual (Acción/Omisión, Daño, Culpa/Negligencia, Relación Causal)", "Responsabilidad por Hecho Propio", "Responsabilidad por Hecho Ajeno (Padres, Tutores, Empresarios)", "Responsabilidad por Daños Causados por Animales", "Responsabilidad por Daños Causados por Cosas", "Responsabilidad Objetiva (Sin Culpa)", "El Daño: Patrimonial y Moral", "Derechos Reales: Poder sobre las Cosas", "Clasificación de los Derechos Reales", "Posesión: Concepto y Clases", "Efectos de la Posesión", "Protección Posesoria (Interdictos)", "Propiedad: Concepto y Caracteres", "Modos de Adquirir la Propiedad (Ocupación, Ley, Donación, Sucesión, Usucapión, Accesión)", "La Ocupación", "La Accesión", "La Usucapión o Prescripción Adquisitiva", "Límites y Limitaciones del Dominio", "La Copropiedad o Condominio", "Propiedad Horizontal", "Derechos Reales Limitados", "Usufructo: Uso y Disfrute", "Derechos y Obligaciones del Usufructuario", "Uso y Habitación", "Servidumbres: Concepto y Clases", "Servidumbres Prediales y Personales", "Constitución y Extinción de Servidumbres", "Derecho de Superficie", "Derechos Reales de Garantía", "Hipoteca Inmobiliaria", "Prenda o Pignoración", "Anticresis", "Registro de la Propiedad", "Principios Registrales (Inscripción, Legitimación, Fe Pública Registral)", "Derecho de Familia", "El Matrimonio: Concepto y Requisitos", "Nulidad, Separación y Divorcio", "Efectos Personales y Patrimoniales del Matrimonio", "Regímenes Económicos Matrimoniales (Gananciales, Separación de Bienes, Participación)", "Uniones de Hecho (Parejas de Hecho)", "Filiación: Matrimonial y Extramatrimonial", "Acciones de Filiación (Reclamación e Impugnación)", "Adopción", "Patria Potestad: Contenido y Ejercicio", "Alimentos entre Parientes", "Derecho de Sucesiones (Mortis Causa)", "Sucesión Testada e Intestada (Ab Intestato)", "La Herencia: Concepto", "Heredero y Legatario", "Testamento: Concepto y Tipos (Ológrafo, Abierto, Cerrado)", "Capacidad para Testar", "Institución de Heredero", "Legados", "Sustituciones Hereditarias", "La Legítima: Porción Indisponible", "Desheredación", "Preterición", "Sucesión Intestada: Orden de Suceder", "Aceptación y Repudiación de la Herencia", "Beneficio de Inventario", "Comunidad Hereditaria", "Partición de la Herencia", "Colación Hereditaria", "Albacea o Ejecutor Testamentario", "Prescripción y Caducidad: El Tiempo en el Derecho", "Diferencias entre Prescripción y Caducidad", "Plazos de Prescripción", "Interrupción y Suspensión de la Prescripción", "Caducidad: Plazos y Efectos", "Normas de Derecho Internacional Privado (Básico)", "Normas de Conflicto", "Prueba de los Hechos en Derecho Civil", "Carga de la Prueba", "Medios de Prueba (Documental, Testifical, Pericial, etc.)", "Valoración de la Prueba", "Cosa Juzgada", "Abuso del Derecho", "Fraude de Ley", "Buena Fe Objetiva y Subjetiva", "Equidad", "Derecho Transitorio"
            // ... Añadir más términos hasta llegar a ~400
        ];
        const civilLawThemes = [ // Temas para generar más títulos
            "derechos de las personas", "obligaciones y contratos", "derechos reales y propiedad", "derecho de familia", "derecho de sucesiones", "responsabilidad civil", "actos y hechos jurídicos", "bienes y patrimonio", "prescripción y caducidad", "elementos del negocio jurídico", "tipos de contratos específicos", "garantías reales y personales", "efectos de las obligaciones", "relaciones paterno-filiales", "regímenes matrimoniales"
        ];
        const textApiConfig = {
            model: "mistral", // O el modelo que prefieras y funcione bien
            systemPrompt: `Eres un jurista experto y un excelente comunicador. Tu tarea es explicar términos o conceptos de Derecho Civil de forma muy clara, precisa y detallada, como si escribieras para un glosario jurídico ampliado destinado a estudiantes o al público general interesado. Define el término, explica su contexto legal, sus elementos esenciales, sus efectos y proporciona ejemplos sencillos y claros (sin entrar en detalles jurisprudenciales complejos). Estructura la explicación lógicamente usando párrafos y, si es útil, sub-títulos (usando markdown como #, ##, ### o ####). El objetivo es una explicación completa y fácil de entender de unas 1200-1300 palabras. Basa tu explicación únicamente en el siguiente término o concepto:`,
            timeoutSeconds: 150 // Aumentado el timeout
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso. Genera exactamente 15 términos o conceptos clave sobre Derecho Civil, adecuados para ser explicados de forma sencilla en un glosario. Devuelve *solo* la lista de términos/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 45 // Ligero aumento por posible complejidad
        };

        // ========== DOM ELEMENTS ========== (sin cambios estructurales)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        // ... (resto de elementos DOM igual)
         const generateMoreSpinner = generateMoreBtn.querySelector('i');
         const storyModal = document.getElementById('story-modal');
         const modalCloseBtn = document.getElementById('modal-close');
         const modalLoadingIndicator = document.getElementById('modal-loading');
         const modalStoryContentArea = document.getElementById('modal-story-content-area');
         const modalTitle = document.getElementById('modal-title');
         const modalImageContainer = document.getElementById('modal-image-container');
         const modalImage = document.getElementById('modal-image');
         const modalImageSpinner = modalImageContainer.querySelector('.spinner');
         const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
         const modalContent = document.getElementById('modal-content');
         const modalError = document.getElementById('modal-error');
         const modalErrorMessage = document.getElementById('modal-error-message');

        // --- Variable to hold the current scroll listener ---
        let currentScrollHandler = null; // (igual)

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) { // (igual)
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url}`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 // Check for common refusal patterns might be useful here too
                 const lowerText = text.toLowerCase();
                 if (lowerText.includes("no puedo") || lowerText.includes("i cannot") || lowerText.includes("incapaz de") || lowerText.includes("unable to")) {
                    throw new Error("La IA indicó que no puede generar la explicación solicitada.");
                 }
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
             }
         }
        async function fetchExplanationText(conceptTitle) { // (igual)
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              // Adjust minimum length check if needed, although word count prompt is primary
              if (text.trim().length < 800) { // Check a reasonable minimum length
                   console.warn("Generated text shorter than expected, but proceeding.");
               }
             return text;
         }
        async function fetchGeneratedTitles() { // (igual)
             const randomTheme = getRandomElement(civilLawThemes) || "conceptos generales";
             const specificPrompt = `Genera 15 términos o conceptos clave sobre ${randomTheme} en Derecho Civil`;
             console.log("Generating concepts with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150); // Adjusted min length slightly
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de conceptos.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) { // (adaptado)
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText.replace(/[¿?]/g, '') : "legal concept abstract"; // Remove question marks for prompt
             // Enhanced prompt focused on legal symbolism/abstraction
             const enhancedPrompt = `Abstract symbolic visualization related to the legal concept of '${safePromptText}', minimalist style, balance, structure, fairness metaphor, no text`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Strengthened negative prompt for legal context
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, equations, graphs, charts, diagrams, figures, judge gavel, courtroom sketch, law books pile, legal document text, scales of justice illustration, police, handcuffs, specific laws, case names, people, persons, realistic photo, handwriting, signature, seal, court building, flag, paragraphs";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (igual)
        function formatExplanationText(rawText) { /* ... (misma función que antes) ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, '<br>');
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (igual, scroll fix incluido)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
             if(!storyModal || !modalContent) return;
             storyModal.classList.remove('active');
             document.body.style.overflow = '';
             modalContent.scrollTop = 0; // Reset scroll
             console.log("Scroll set to 0 on hideModal");
             if (currentScrollHandler) {
                 modalContent.removeEventListener('scroll', currentScrollHandler);
                 currentScrollHandler = null;
                 console.log("Scroll listener removed on hideModal.");
             }
             resetModalState();
         }
        function resetModalState() { // (igual)
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.classList.remove('visible');
             modalImageContainer.style.display = 'none';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (igual, scroll fix incluido)
        function getRandomElement(arr) { /* ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... */
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]);
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay términos disponibles.</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        async function handleTitleClick(title) { // (igual, scroll fix incluido)
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalImageContainer.style.display = 'none';
            modalImageContainer.classList.remove('visible');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
            }

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                // <<<--- RESET SCROLL AQUÍ ---<<<
                modalContent.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                modalImageSpinner.style.display = 'block';
                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL:", title);
                     modalImageSpinner.style.display = 'none';
                     modalImagePlaceholder.style.display = 'block';
                 }

                const scrollBuffer = 20; // Buffer slightly larger for longer text might be good
                currentScrollHandler = () => {
                    if (modalContent.scrollHeight <= modalContent.clientHeight) {
                         console.log("Content fits, showing image immediately.");
                         modalImageContainer.classList.add('visible');
                         modalImageContainer.style.display = 'flex';
                         modalContent.removeEventListener('scroll', currentScrollHandler);
                         currentScrollHandler = null;
                    } else if ((modalContent.scrollTop + modalContent.clientHeight) >= (modalContent.scrollHeight - scrollBuffer)) {
                        console.log("Scroll end reached, showing image.");
                        modalImageContainer.classList.add('visible');
                        modalImageContainer.style.display = 'flex';
                        modalContent.removeEventListener('scroll', currentScrollHandler);
                        currentScrollHandler = null;
                        console.log("Scroll listener removed after showing image.");
                    }
                };
                modalContent.addEventListener('scroll', currentScrollHandler);
                console.log("Scroll listener added.");
                setTimeout(currentScrollHandler, 150); // Check slightly later

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error al cargar: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = '';
                 if (currentScrollHandler) {
                    modalContent.removeEventListener('scroll', currentScrollHandler);
                    currentScrollHandler = null;
                 }
            }
        }

        async function handleGenerateMoreTitles() { // (igual)
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se pudieron generar nuevos términos en este momento."); }
             } catch (error) { console.error("Failed generation:", error); alert(`Error: ${error.message}`);
             } finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Términos'; }
         }

        // ========== INITIALIZATION ========== (igual)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p>Error crítico.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            // IMPORTANT: Remember to expand predefinedTitles manually to ~400
            if (predefinedTitles.length < 350) {
                console.warn(`La lista inicial de títulos solo tiene ${predefinedTitles.length}. Se recomienda ampliarla a ~400.`);
            }
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>