<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secretos del Vodú Haitiano - Archivos Interactivos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Evocadoras pero Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Vodú Haitiano --- */
        :root {
            --color-primary: #8c1c13; /* Rojo Sangre Oscuro */
            --color-secondary: #4a044e; /* Púrpura Profundo */
            --color-tertiary: #ffffff; /* Blanco (Pureza, Hueso) */
            --color-accent: #a0522d; /* Siena/Marrón Tierra */
            --color-background: #1a1a1a; /* Negro/Gris Muy Oscuro (Misterio) */
            --color-text: #f5f5f5; /* Blanco Hueso / Gris Muy Claro */
            --color-text-muted: #a3a3a3; /* Gris Medio */
            --color-modal-bg: #262626; /* Gris Oscuro Intenso */
            --color-border: #525252; /* Borde Gris Oscuro */
            --color-error-bg: #3f1212; /* Fondo error rojo oscuro */
            --color-error-text: #fecaca; /* Texto error claro */
            --color-error-border: #b91c1c; /* Borde error rojo más oscuro */

            --shadow-sm: 0 1px 2px 0 rgba(255, 255, 255, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(255, 255, 255, 0.08), 0 2px 4px -2px rgba(255, 255, 255, 0.05);
            --shadow-lg: 0 0 20px -5px rgba(140, 28, 19, 0.3), 0 8px 10px -6px rgba(140, 28, 19, 0.2); /* Sombra rojiza */
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"%3E%3Cg fill-rule="evenodd"%3E%3Cg fill="%233a0ca3" fill-opacity="0.05"%3E%3Cpath d="M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l-2.83-2.83 1.41-1.41L20 17.17l1.41-1.41 1.41 1.41L20 18.6zm0 2.83l-1.41-1.41-1.41 1.41L20 22.83l2.83-2.83-1.41-1.41L20 21.43zm0 2.83l-2.83 2.83 1.41 1.41L20 25.66l1.41 1.41 1.41-1.41L20 24.26zM18.59 20l-2.83-2.83 1.41-1.41L18.59 17.17l1.41-1.41 1.41 1.41L18.59 20zm2.83 0l-1.41-1.41-1.41 1.41L21.43 20l2.83 2.83-1.41 1.41L21.43 20z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); /* Sutil patrón de fondo */
        }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px rgba(140, 28, 19, 0.7); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 6px rgba(140, 28, 19, 0.6); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 4px rgba(140, 28, 19, 0.5); }
        .navbar { background-color: rgba(26, 26, 26, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(38, 38, 38, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Merriweather'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(140, 28, 19, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Merriweather'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-accent); color: var(--color-tertiary); background-color: #3f3f46; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: var(--color-tertiary); padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-tertiary); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.92); backdrop-filter: blur(3px); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Allow space for game/content */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-tertiary); transform: rotate(90deg); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-accent) rgba(82, 82, 82, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(82, 82, 82, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-accent); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-accent); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-accent); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-accent); border-radius: var(--border-radius); box-shadow: 0 0 15px rgba(160, 82, 45, 0.3); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(82, 82, 82, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-accent); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(26, 26, 26, 0.7); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(82, 82, 82, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(82, 82, 82, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-family: 'Merriweather'; }
        .user-message { background-color: var(--color-accent); color: var(--color-tertiary); margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #525252; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #3f3f46; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Merriweather'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-tertiary); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #b91c1c; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator and Minigame Area */
        #modal-loading { text-align: center; padding: 2rem 1rem; /* Reducir padding vertical */ position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 26, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1rem auto; /* Menos margen inferior */ flex-shrink: 0; }
        #modal-loading p.loading-text { font-weight: 400; color: var(--color-text); font-size: 1.3rem; font-family: 'Cinzel'; text-shadow: 0 0 5px var(--color-primary); margin-bottom: 1.5rem; /* Espacio antes del juego */ flex-shrink: 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Minigame Styles */
        #loading-minigame { width: 90%; max-width: 350px; height: 200px; /* Altura fija para el juego */ background-color: rgba(0, 0, 0, 0.2); border: 1px solid var(--color-border); border-radius: var(--border-radius); position: relative; overflow: hidden; cursor: crosshair; flex-shrink: 0; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .minigame-dot { position: absolute; width: 25px; height: 25px; background-color: var(--color-accent); border-radius: 50%; border: 2px solid var(--color-tertiary); cursor: pointer; transition: transform 0.1s ease, background-color 0.2s ease; box-shadow: 0 0 8px var(--color-accent); }
        .minigame-dot:hover { background-color: var(--color-primary); transform: scale(1.15); box-shadow: 0 0 12px var(--color-primary); }
        .minigame-dot.clicked { background-color: var(--color-secondary); transform: scale(0.8); opacity: 0.5; pointer-events: none; }
        #minigame-info { margin-top: 0.8rem; color: var(--color-text-muted); font-size: 0.9em; font-family: 'Merriweather'; flex-shrink: 0; }
        #minigame-level { font-weight: bold; color: var(--color-tertiary); }
        #minigame-score { font-weight: bold; color: var(--color-accent); }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Merriweather'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.96); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-accent); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-tertiary); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-book-dead mr-3"></i> <!-- Icono libro/cráneo -->
                     Secretos del Vodú
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">~ Archivos Interactivos de Haití ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Las Voces de los Lwa</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Explora las profundidades del Vodú haitiano. Descubre los espíritus, rituales y relatos ancestrales que conforman esta rica tradición.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar Lwa, concepto o historia...">
             <i class="fas fa-search fa-feather-alt"></i> <!-- Icono pluma/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-vihara text-red-700 mr-2"></i> <!-- Icono templo/vihara -->
                 Índice de Saberes
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Consultando los archivos ancestrales...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">~ Ningún saber coincide con tu búsqueda ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Invocar Más Saberes
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p class="loading-text">Canalizando conocimiento...</p>
                 <!-- Minigame Area -->
                 <div id="loading-minigame">
                     <!-- Dots will be added here by JS -->
                 </div>
                 <div id="minigame-info">
                     Nivel: <span id="minigame-level">1</span> | Símbolos Activados: <span id="minigame-score">0</span>
                 </div>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <h4 class="text-sm font-semibold text-center text-gray-400 mb-2 font-cinzel">Consulta al Espíritu</h4>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Interpretando pregunta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este Lwa o concepto...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos y de divulgación cultural sobre el Vodú haitiano.</p>
              <p class="mt-1">Esta es una representación interpretativa. Consulta fuentes académicas y practicantes para un entendimiento profundo.</p>
              <p class="mt-2">© 2024 Archivos del Vodú Interactivo</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Lwa Principales (Rada)
            "Papa Legba", "Legba Atibon", "Legba Kalfou (Carrefour)", "Marassa Dosu Dosa (Gemelos Divinos)", "Loko Atissou", "Ayizan Velekete", "Damballa Wedo", "Ayida Wedo", "Sogbo", "Badè", "Agwe Tawoyo", "La Sirène", "Erzulie Freda Dahomey", "Clemeil", "Ogou Feray", "Ogou Badagris", "Ogou Shango", "Ogou Balendjo", "Zaka (Azaka Mede)", "Kouzen Zaka",
            // Lwa Principales (Petwo)
            "Ezili Dantor", "Ezili Je Wouj", "Gran Bwa", "Kalfou (Petwo aspect)", "Ogou Ge Wouj", "Simbi Makaya", "Simbi Andezo", "Ti Jean Petwo", "Marinèt Bwa Chech", "Lenglensou", "Krabiye", "Bosou Twa Kòn (Bosou Tres Cuernos)", "Erzulie Mapyang", "Ogou Balizaj", "Don Petwo",
            // Lwa Gede
            "Baron Samdi", "Baron La Croix", "Baron Kriminel", "Maman Brigitte", "Gede Nibo", "Brav Gede", "Gede Loraj", "Gede Ti Wawè", "Gede Masaka", "Gede Zarenyen", "Los Gede (Colectivo)",
            // Otros Lwa y Espíritus
            "Agassou", "Anminan", "Adjinakou", "Agarou", "Anasi", "Belie Belcan", "Brise", "Congo Savanne", "Dan Petwo", "Filomez", "Grand Bois d'Ilet", "Jean Zombi", "Joseph Danger", "Kita", "Linglessou", "Mami Wata (Influencia)", "Nago Shango", "Ountò (Espíritus del tambor)", "Pie", "Simbi Ganga", "Sobo", "Ti Kita", "Wanga", "Zantray",
            // Conceptos Fundamentales
            "Vodú (Visión General)", "Bondye (Dios Supremo)", "Lwa / Loa (Los Espíritus)", "Sèvitè (El Servidor/Practicante)", "Ounfò / Hounfour (Templo)", "Oungan / Houngan (Sacerdote)", "Manbo / Mambo (Sacerdotisa)", "Bokor (Hechicero - con precaución)", "Poto Mitan (Poste Central)", "Peristil (Espacio Ritual)", "Ason (Maraca Sagrada)", "Vèvè (Símbolos Sagrados)", "Nanchon (Naciones/Ritos - Rada, Petwo, Congo, Nago)", "Rada (Rito Frío/Benevolente)", "Petwo (Rito Caliente/Fiero)", "Congo (Rito)", "Nago (Rito)", "Sincretismo Vodú-Católico", "Santos Católicos y Lwa (Asociaciones)", "Espri (Alma - Gros Bon Ange, Ti Bon Ange)", "Lakou (Comunidad/Patio)", "Sosyete (Sociedad Vodú)", "Regleman (Reglas/Tradición)",
            // Rituales y Prácticas
            "Ceremonia Vodú (General)", "Bautismo Vodú (Cabeza)", "Kanzo (Iniciación)", "Pran Asòn (Tomar la Maraca)", "Fèt Gede (Fiesta de los Muertos)", "Manje Lwa (Alimentar a los Espíritus)", "Sèvis Lwa (Servicio a un Lwa)", "Dans (Danza Ritual)", "Chante (Canto Ritual)", "Tanbou (Tambores Sagrados)", "Ountòki (Tamboreros)", "La Priyè Deyò (Oración Afuera)", "Kasé Kanari (Romper la Jarra - Rito Funerario)", "Retire Mò Nan Dlo (Sacar al Muerto del Agua)", "Wanga (Magia/Hechizo)", "Gad (Protección Mágica)", "Travay (Trabajo Espiritual)", "Bain (Baño Ritual)", "Lamp (Lámpara Mágica)", "Pwen (Punto de Poder/Magia)", "Posesión Espiritual (Chwal)", "Interpretación de Sueños en Vodú", "Adivinación en Vodú", "Sacrificio Animal (Contexto y Significado)", "Ofrendas a los Lwa", "Altares Vodú",
            // Objetos y Símbolos
            "El significado de los Colores en Vodú", "Velas en el Vodú", "Perfumes y Aguas Floridas", "Paquet Congo (Paquete Mágico)", "Drapo Vodú (Banderas Rituales)", "Goat's Head (Cabeza de Chivo simbólica)", "Kwi (Calabaza)", "Chaplet (Rosario adaptado)", "Kouto (Cuchillo Ritual)", "Pilon (Mortero)", "Pierres (Piedras Sagradas)", "Pot Tèt (Vasija de la Cabeza)", "Tablèt (Tabla de Adivinación)", "Savalou (Cántaro de Agua Sagrada)",
            // Historia y Sociedad
            "Orígenes Africanos del Vodú (Dahomey, Yoruba, Kongo)", "El Vodú y la Revolución Haitiana", "Ceremonia de Bois Caïman", "Dutty Boukman", "Cécile Fatiman", "El Vodú durante la Ocupación Estadounidense", "Persecución del Vodú (Campañas Antisupersticiosas)", "El Vodú en la Diáspora (Nueva Orleans, Miami, NY)", "Vodú y Política en Haití", "Representación del Vodú en la Cultura Popular (Crítica)", "Zonbi / Zombie (Significado Real vs. Ficción)", "Sociedades Secretas (Bizango, Zobop - con precaución)", "Santería vs. Vodú (Diferencias)", "Candomblé vs. Vodú (Diferencias)", "El rol de la Mujer en el Vodú (Manbos)", "El Vodú como Sistema de Salud Tradicional", "Arte Haitiano inspirado en el Vodú", "Música y Vodú (Racine/Roots Music)",
            // Relatos y Folclore
            "Historias de Papa Legba abriendo caminos", "Cuentos de astucia de Ti Malice y Bouki (influencia)", "Leyendas sobre Ezili Dantor y su fiereza protectora", "Relatos de encuentros con los Gede", "Mitos de creación relacionados con Damballa y Ayida Wedo", "Historias de Zaka y la vida campesina", "Cuentos sobre la rivalidad Erzulie Freda y Dantor", "Narraciones de Agwe y La Sirène en el mar", "Historias de Ogou como guerrero y trabajador", "Leyendas sobre los Marassa y su poder dual", "Cuentos de advertencia sobre Bokors", "Relatos de protección otorgada por los Lwa", "Historias sobre la interacción entre humanos y espíritus", "Mitos sobre el origen de los tambores sagrados", "Leyendas de tesoros escondidos guardados por Lwa",
            // Preguntas Comunes
            "¿El Vodú es adoración al diablo?", "¿Qué significa 'servir a los Lwa'?", "¿Cómo funciona la posesión en el Vodú?", "¿Es el Vodú una religión organizada?", "¿Cuál es el rol de los ancestros?", "¿Qué es un vèvè y cómo se usa?", "¿Por qué hay sacrificios?", "¿Qué relación tiene con el catolicismo?", "¿Todos los haitianos practican Vodú?", "¿Qué es el Rada y el Petwo?", "¿Se puede aprender Vodú de un libro?", "¿Qué son los zombies realmente?", "¿Qué es un Oungan o Manbo?", "¿Cómo se inicia alguien en el Vodú?", "¿El Vodú hace daño (magia negra)?"
             // ... Y muchos más para alcanzar >400
        ];
        const vodouThemes = [
            "Lwa Rada", "Lwa Petwo", "Lwa Gede", "Rituales Vodú", "Símbolos Vodú (Veve)", "Historia del Vodú", "Vodú y Revolución Haitiana", "Conceptos Vodú (Alma, Espíritus)", "Ounfò y Sacerdocio", "Magia y Protección (Wanga, Gad)", "Posesión Espiritual", "Vodú y Catolicismo", "Tambores y Música Vodú", "Ofrendas y Sacrificios", "Arte Vodú Haitiano", "Relatos y Leyendas Vodú", "Naciones Vodú (Rada, Petwo)", "Iniciación Vodú (Kanzo)", "Figuras históricas del Vodú", "El concepto de Zonbi", "Vodú en la Diáspora", "Ancestros en el Vodú"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un experto antropólogo cultural y narrador, especializado en el Vodú haitiano. Tu tono es respetuoso, informativo y evita el sensacionalismo. Describe el Lwa, concepto, ritual o historia de Vodú haitiano indicado, basándote en conocimiento académico y tradicional. Incluye: Origen/mitología, atributos/dominios, símbolos asociados (vèvè abstracto, colores, día, ofrendas preferidas), cómo se le 'sirve' o interactúa con él/ella/ello, historias o leyendas relevantes, y su importancia dentro del sistema de creencias Vodú. Si es un concepto, explica su significado y función. Si es un ritual, detalla sus pasos principales y propósito. Si es una historia, nárrala con contexto cultural. Extensión objetivo: 1200-1300 palabras.",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúas como un guía experto y respetuoso sobre el tema específico de Vodú haitiano que se está mostrando (Lwa, concepto, etc.). Responde preguntas de seguimiento de forma concisa, clara y culturalmente sensible, basándote estrictamente en el contexto proporcionado y el conocimiento general sobre Vodú. No especules ni des información no relacionada.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
             // *** AUMENTADO A 40 ***
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia sobre Vodú haitiano. Genera exactamente 40 nombres de Lwa (espíritus), conceptos clave, tipos de rituales o ideas para historias tradicionales relacionadas con el Vodú haitiano. Devuelve *solo* la lista, un ítem por línea. Sin números, guiones, introducciones o despedidas. Prioriza variedad (Lwa, conceptos, rituales, etc.).",
            timeoutSeconds: 60 // Un poco más de tiempo para generar 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameContainer = document.getElementById('loading-minigame');
        const minigameLevelDisplay = document.getElementById('minigame-level');
        const minigameScoreDisplay = document.getElementById('minigame-score');

        // ========== State Variables ==========
        let currentVodouTopic = null; // Contexto para chat
        let minigameState = { // Estado del minijuego
            intervalId: null,
            level: 1,
            score: 0,
            dots: [],
            dotsToSpawn: 3,
            spawnRateMs: 1500, // ms entre puntos
            dotLifetimeMs: 3000 // ms que dura un punto
        };

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentVodouTopic
                ? `Eres un guía experto y respetuoso sobre '${currentVodouTopic}' del Vodú haitiano. Responde preguntas de seguimiento concisas y culturalmente sensibles sobre este tema específico.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                     // *** MENSAJE DE ERROR AMIGABLE ***
                     throw new Error(`(Código ${response.status}) Nuestros servidores tienen mucho tráfico o hubo un problema. Por favor, inténtalo de nuevo en unos segundos.`);
                 }
                const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o elige otro tema.");
                 }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                     throw new Error(`La conexión con los servidores tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 // Usa el mensaje de error ya formateado o uno genérico
                throw new Error(error.message || "Ocurrió un error inesperado al contactar los servidores de conocimiento.");
            }
        }
        async function fetchExplanationText(topicTitle) { return fetchTextFromApi(topicTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentVodouTopic) throw new Error("Error interno: Contexto del tema perdido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(vodouThemes) || "conceptos generales del Vodú";
             const specificPrompt = `Genera 40 ítems (Lwa, conceptos, rituales, historias) sobre ${randomTheme}`;
             // Usa la función genérica fetchTextFromApi
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                  .then(text => {
                      // Ajustar el filtro para 40 títulos
                      const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                      if (titles.length < 20) throw new Error("La IA no generó suficientes ideas nuevas."); // Umbral más bajo por si acaso
                      return titles.slice(0, 40); // Tomar hasta 40
                  });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Haitian Vodou symbolism";
            // Prompt ENFOCADO en simbolismo, atmósfera, NO personas específicas, NO estereotipos.
            const enhancedPrompt = `Atmospheric artwork inspired by '${safePromptText}', Haitian Vodou tradition. Focus on symbolism (abstract veve patterns, elements like earth, water, fire), spiritual energy, ritual objects (candles, drums abstractly). Use deep, rich, earthy colors (reds, purples, browns, white accents). Evocative, mysterious, respectful style. Avoid depicting specific human figures, stereotypes, or explicit gore. No text, labels.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, charts, diagrams, map, flag, cartoon, caricature, photorealistic human face, voodoo doll stereotype, skull pile, gore, bright neon colors, simple background, watermark, signature";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (misma función que antes) ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, ' ');
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
        }

        // ========== MINIGAME FUNCTIONS ==========
        function resetMinigame() {
            if (minigameState.intervalId) clearInterval(minigameState.intervalId);
            minigameState = { intervalId: null, level: 1, score: 0, dots: [], dotsToSpawn: 3, spawnRateMs: 1500, dotLifetimeMs: 3000 };
            minigameContainer.innerHTML = ''; // Clear old dots
            updateMinigameDisplay();
        }
        function updateMinigameDisplay() {
            minigameLevelDisplay.textContent = minigameState.level;
            minigameScoreDisplay.textContent = minigameState.score;
        }
        function spawnDot() {
            if (!minigameContainer) return;
            const containerRect = minigameContainer.getBoundingClientRect();
            if (containerRect.width === 0 || containerRect.height === 0) return; // Don't spawn if container not visible/sized

            const dot = document.createElement('div');
            dot.classList.add('minigame-dot');
            const dotId = `dot-${Date.now()}-${Math.random().toString(16).slice(2)}`;
            dot.id = dotId;

            // Ensure dot spawns fully inside container
            const dotSize = 25; // Should match CSS width/height
            const maxX = containerRect.width - dotSize;
            const maxY = containerRect.height - dotSize;
            dot.style.left = `${Math.random() * maxX}px`;
            dot.style.top = `${Math.random() * maxY}px`;

            dot.addEventListener('click', handleDotClick);
            minigameContainer.appendChild(dot);
            minigameState.dots.push(dotId);

            // Remove dot after its lifetime
            setTimeout(() => {
                const dotToRemove = document.getElementById(dotId);
                if (dotToRemove && !dotToRemove.classList.contains('clicked')) {
                    dotToRemove.remove();
                    const index = minigameState.dots.indexOf(dotId);
                    if (index > -1) minigameState.dots.splice(index, 1);
                }
            }, minigameState.dotLifetimeMs);
        }
        function handleDotClick(event) {
            const dot = event.target;
            if (dot.classList.contains('clicked')) return;

            dot.classList.add('clicked');
            minigameState.score++;
            updateMinigameDisplay();

            // Optional: Remove immediately or let fade out via CSS
            setTimeout(() => dot.remove(), 300);

            const index = minigameState.dots.indexOf(dot.id);
            if (index > -1) minigameState.dots.splice(index, 1);

            // Check for level up (e.g., every 10 points)
            if (minigameState.score > 0 && minigameState.score % 10 === 0) {
                levelUpMinigame();
            }
        }
        function levelUpMinigame() {
            minigameState.level++;
            // Increase difficulty: more dots, faster spawn, shorter lifetime (within reason)
            minigameState.dotsToSpawn = Math.min(10, minigameState.dotsToSpawn + 1); // Cap at 10 simultaneous
            minigameState.spawnRateMs = Math.max(500, minigameState.spawnRateMs - 150); // Min 0.5s spawn
            minigameState.dotLifetimeMs = Math.max(1500, minigameState.dotLifetimeMs - 200); // Min 1.5s lifetime
            updateMinigameDisplay();
            // Restart interval with new speed
            startGameLoop();
            console.log(`Minigame Level Up: ${minigameState.level}, SpawnRate: ${minigameState.spawnRateMs}, Lifetime: ${minigameState.dotLifetimeMs}`);
        }
        function startGameLoop() {
            if (minigameState.intervalId) clearInterval(minigameState.intervalId);
            minigameState.intervalId = setInterval(() => {
                // Spawn multiple dots per interval based on level, but not too many at once
                const dotsToSpawnThisTick = Math.min(minigameState.dotsToSpawn - minigameState.dots.length, 2); // Spawn max 2 per tick
                for (let i = 0; i < dotsToSpawnThisTick; i++) {
                     if (minigameState.dots.length < minigameState.dotsToSpawn) {
                         spawnDot();
                     }
                }
            }, minigameState.spawnRateMs);
        }
        function stopMinigame() {
             if (minigameState.intervalId) {
                 clearInterval(minigameState.intervalId);
                 minigameState.intervalId = null;
                 console.log("Minigame stopped.");
             }
             // Optionally clear remaining dots
             // minigameContainer.innerHTML = '';
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            resetModalState(); // Resets minigame too
        }
        function resetModalState() {
             stopMinigame(); // Stop game first
             resetMinigame(); // Reset game state variables and display
             modalLoadingIndicator.style.display = 'flex'; // Show loading indicator (contains game)
             modalStoryContentArea.classList.add('content-hidden'); // Hide content area
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentVodouTopic = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if(!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src=imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow='hidden'; }
        function hideFullscreenImage() { /* ... */ if(!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if(!storyModal.classList.contains('active')){ document.body.style.overflow=''; } fullscreenImage.src=''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender==='user'?'user-message':'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>'); msgDiv.innerHTML=message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errDiv=document.createElement('div'); errDiv.classList.add('chat-error'); errDiv.textContent=message; chatHistory.appendChild(errDiv); chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const userQuery = chatInput.value.trim(); if(!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery,'user'); chatInput.value=''; chatSendBtn.disabled=true; chatLoadingIndicator.style.display='block'; try{ const aiResponse=await fetchChatResponse(userQuery); addChatMessage(aiResponse,'ai'); } catch(error){ console.error("Chat Error:",error); addChatError(`Error IA: ${error.message}`); } finally{ chatLoadingIndicator.style.display='none'; chatSendBtn.disabled=false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">~ No hay saberes disponibles ~</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to START MINIGAME and STOP it on completion/error ***
        async function handleTitleClick(title) {
            resetModalState(); // Includes resetting minigame state
            showModal();
            modalTitle.textContent = title;
            currentVodouTopic = title;
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; // Show loading area

            // *** START MINIGAME ***
            startGameLoop();
            console.log("Minigame started.");

            try {
                // Fetch main content WHILE minigame is running
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // *** Content Ready - Stop Minigame, Hide Loading, Show Content ***
                stopMinigame();
                modalLoadingIndicator.style.display = 'none'; // Hide loading area
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Show content area
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder (same logic as before)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-eye placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Buscando visión...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación simbólica de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                     placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visión no encontrada.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al invocar visión.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                 // *** STOP MINIGAME on error ***
                stopMinigame();
                modalLoadingIndicator.style.display = 'none'; // Hide loading
                modalErrorMessage.textContent = error.message || "Error desconocido al canalizar el saber.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
            // No finally block needed here for stopGame, as it's called on success OR error path explicitly.
        }

        // *** MODIFIED: handleGenerateMoreTitles to fetch 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando oráculos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches up to 40 now
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Los oráculos no ofrecieron nuevos saberes en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al invocar saberes: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Invocar Más Saberes';
             }
         }

         // Search Filter Function (sin cambios)
         function filterTitles(searchTerm) { /* ... */ const term=searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();const titleItems=titleListContainer.querySelectorAll('.title-item');let visibleCount=0;titleItems.forEach(item=>{const titleText=item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");const isVisible=titleText.includes(term);item.classList.toggle('hidden',!isVisible);if(isVisible)visibleCount++;});noResultsMsg.classList.toggle('hidden',visibleCount>0); }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check all essential elements, including minigame parts
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameContainer || !minigameLevelDisplay || !minigameScoreDisplay) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #fecaca; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: Cinzel;">++ ERROR CRÍTICO // FALLO AL CARGAR INTERFAZ ANCESTRAL ++</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>