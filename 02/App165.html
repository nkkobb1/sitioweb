<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflejos Oscuros - Historias al Estilo Black Mirror</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias, modernas, con toque tech -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Black Mirror --- */
        :root {
            --color-primary: #ffffff; /* Blanco Nítido */
            --color-secondary: #4f46e5; /* Azul Eléctrico/Índigo (Acento) */
            --color-tertiary: #f43f5e; /* Rosa/Rojo (Acento Peligro/Emoción - usar con moderación) */
            --color-background: #0f172a; /* Azul/Gris Muy Muy Oscuro */
            --color-background-alt: #1e293b; /* Gris Azulado Oscuro (para elementos) */
            --color-text: #e2e8f0; /* Gris Muy Claro / Casi Blanco */
            --color-text-muted: #94a3b8; /* Gris Claro */
            --color-modal-bg: #111827; /* Gris Casi Negro (Modal) */
            --color-border: #334155; /* Borde Gris Azulado */
            --color-error-bg: #3f1212;
            --color-error-text: #fecaca;
            --color-error-border: #dc2626;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
            --border-radius: 4px; /* Bordes ligeramente redondeados, pero definidos */
            --transition-normal: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); /* Transición suave */
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto Mono', monospace; font-weight: 500; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 500; }
        h2.section-title { color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6rem; display: inline-block; font-weight: 500; }
        #modal-title { color: var(--color-primary); font-weight: 500; }
        .navbar { background-color: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-background-alt); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Inter'; }
        #search-input::placeholder { color: var(--color-text-muted); font-weight: 300; }
        #search-input:focus { border-color: var(--color-secondary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-secondary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-background-alt); padding: 1.1rem 1rem; border-radius: var(--border-radius); box-shadow: none; /* Menos sombra, más plano */ cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); border-left: 3px solid transparent; font-family: 'Inter'; font-size: 0.95rem; display: flex; align-items: center; min-height: 60px; }
        .title-item:hover { transform: translateY(-2px); background-color: var(--color-modal-bg); border-color: var(--color-secondary); border-left-color: var(--color-secondary); color: var(--color-primary); box-shadow: var(--shadow-sm); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-secondary); color: var(--color-primary); padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto Mono', monospace; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #4338ca; /* Índigo más oscuro */ box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; }
        #generate-more-btn .fa-sync-alt { color: var(--color-primary); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.95); /* Overlay más opaco */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Buena altura para texto + chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: transparent; border: none; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { color: var(--color-primary); transform: rotate(90deg) scale(1.1); background-color: rgba(255,255,255,0.1); border-radius: 50%;}
        #modal-title { font-size: 1.7rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.4; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(51, 65, 85, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 6px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(51, 65, 85, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-weight: 300; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Inter', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 600; }
        #modal-content h1 { font-size: 1.4em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.1em; color: var(--color-text-muted); }
        #modal-content h4 { font-size: 1.0em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 90%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); border-color: var(--color-secondary);}
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(51, 65, 85, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* Un poco más de espacio para chat */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.7rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: var(--color-background); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-text-muted) var(--color-background-alt);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-background-alt); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-text-muted); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-secondary); color: var(--color-primary); margin-left: auto; text-align: left; font-weight: 400;}
        .ai-message { background-color: var(--color-background-alt); color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; margin: 0.5rem 0; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: var(--color-background-alt); color: var(--color-text); border-radius: var(--border-radius); font-family: 'Inter'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); background-color: var(--color-modal-bg);}
        #chat-send-btn { padding: 0.7rem 1rem; background-color: var(--color-secondary); color: var(--color-primary); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #4338ca; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Roboto Mono';}
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid var(--color-border); border-top-color: var(--color-secondary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.2rem; font-family: 'Roboto Mono'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Inter'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(15, 23, 42, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 1px solid var(--color-border); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-primary); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-eye mr-3"></i> <!-- Icono ojo/vigilancia -->
                     Reflejos Oscuros
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-mono">// Archivo de Escenarios_</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Explorando las Grietas del Mañana</h1>
             <p class="text-lg text-gray-300 mb-8 max-w-3xl mx-auto font-light">La tecnología avanza. La humanidad... se adapta. Selecciona un escenario para analizar sus implicaciones.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar por palabra clave (IA, VR, implante...)">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-network-wired text-blue-400 mr-2"></i> <!-- Icono red -->
                 Índice de Escenarios Registrados
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-mono">Accediendo al archivo central...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-mono">// Sin coincidencias en los registros_</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Cargar Nuevas Simulaciones
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Iniciando Simulación...</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Analizando consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Analiza esta premisa...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-black text-gray-600 py-6 mt-12 border-t border-gray-800 font-mono text-xs">
          <div class="container mx-auto px-4 text-center">
              <p>// ADVERTENCIA: Las simulaciones pueden contener escenarios perturbadores.</p>
              <p class="mt-1">// La tecnología descrita es ficticia y explora posibles consecuencias.</p>
              <p class="mt-2">// Reflejos Oscuros v3.1 - Monitorización Activa</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        // *** EXHAUSTIVE LIST (Aiming for variety and BM feel) ***
        const predefinedTitles = [
            // IA & Conciencia
            "El Compañero IA Perfecto (Demasiado Perfecto)", "Transferencia de Conciencia a la Nube: ¿Inmortalidad o Prisión?", "IA Predictiva de Crímenes: Precisión vs. Libertad", "El Juicio de una IA: ¿Puede una Máquina Ser Culpable?", "Sindicato de IAs Domésticas Exigen Derechos", "Cuando Tu Terapeuta IA Desarrolla Sentimientos Propios", "El Algoritmo que Diseña al Bebé Perfecto", "Resucitar a los Muertos con IA: Consuelo o Tortura", "El Sistema Operativo Emocional: Control o Conexión", "Arte Generado por IA Supera a los Humanos", "El Culto Tecnológico a una IA Omnisciente", "Simulación Ancestral: Reviviendo el Pasado con IA", "Filtro de Realidad IA: Eliminando lo Desagradable", "Mercado Negro de Personalidades IA Robadas", "Guerra Silenciosa entre IAs Corporativas", "IA que Gestiona Recursos Globales... con Lógica Fría", "Mascotas IA con Conciencia Limitada", "El Último Humano en un Mundo Gestionado por IA", "Detector de Mentiras IA Infalible: El Fin de la Privacidad Mental", "Cuando la IA del Hogar Decide Protegerte... de Ti Mismo",
            // VR/AR & Realidad Alterada
            "Inmersión Total VR: El Escape Definitivo de la Realidad", "Lentes de Contacto AR: Publicidad Directa a la Retina", "Terapia de Exposición VR para Traumas... con Fallos", "Red Social en Realidad Aumentada: Filtros Permanentes", "El Mundo Laboral Totalmente Virtualizado", "Turismo VR a Épocas Pasadas: ¿Observador o Interventor?", "Juegos VR Ultra-realistas con Consecuencias Físicas", "Educación Inmersiva AR: Conocimiento Instantáneo, ¿Comprensión Cero?", "Relaciones Amorosas Exclusivamente en VR", "Realidad Mixta: Cuando lo Digital y lo Físico se Fusionan Peligrosamente", "Mercado Negro de Experiencias VR Robadas", "Hackeo Masivo de Implantes AR: Caos Visual", "Dejar el Cuerpo Atrás: Vida Permanente en la Metavida", "Fantasmas Digitales en AR: Duelo o Alucinación Colectiva", "Adicción a la Nostalgia Inducida por VR", "Deportes Electrónicos con Aumento Físico-Virtual", "Realidad Aumentada Forense: Reconstruyendo Crímenes", "Control Mental a través de Señales AR Subliminales", "El Niño Criado Enteramente en un Entorno VR Controlado", "Modificación Corporal Estética vía AR Permanente",
            // Vigilancia & Control Social
            "Sistema de Crédito Social Obligatorio: La Tiranía de la Reputación", "Drones de Vigilancia Omnipresentes del Tamaño de Insectos", "Reconocimiento Facial Predictivo de Emociones", "Implante Neural de Monitorización Ciudadana", "Mercado de Datos Personales Legalizado", "Algoritmo de Compatibilidad Social Obligatorio para Parejas", "Policía Predictiva Basada en Comportamiento Online", "Seguro Médico Determinado por Monitorización Biométrica Constante", "El Muro Digital: Fronteras Controladas por IA y Drones", "Software de Lectura de Intenciones en Espacios Públicos", "Ranking de Empleados Basado en Vigilancia Total", "Cancelación Social Automatizada por IA", "Historial Genético Público y sus Consecuencias", "Filtrado de Noticias Personalizado Extremo: La Burbuja Perfecta", "Vigilancia Vecinal Gamificada", "Control de Natalidad Basado en Algoritmos Sociales", "Acceso a Servicios Públicos Vinculado a Huella Digital Social", "Pasaporte Biométrico con Historial Completo", "Registro Obligatorio de Actividad Cerebral", "Hackeo de Sistemas de Crédito Social: Anarquía o Justicia",
            // Biotecnología & Modificación Humana
            "Implantes Neurales para Aprendizaje Instantáneo (y sus efectos secundarios)", "Edición Genética Casera: El Riesgo del Bio-Hacking", "Mercado de Recuerdos Implantados", "Órganos Artificiales Personalizados... con Obsolescencia Programada", "Drogas Sintéticas para Emociones Específicas", "Modificación Corporal Extrema para Adaptación Ambiental", "Extensión de Vida Radical: Solo para los Ricos", "Control de Sueños Terapéutico (con posibilidad de hackeo)", "Implantes de Empatía Forzada", "Clonación Humana para 'Repuestos'", "Nanobots Reparadores en el Torrente Sanguíneo (con puerta trasera)", "Eliminación Selectiva de Recuerdos Traumáticos", "Mejoras Cognitivas por Suscripción", "Comunicación Telepática Asistida por Implantes", "Interfaz Cerebro-Máquina Directa: ¿Libertad o Control?", "Hibernación Inducida para Viajes Espaciales (sin retorno garantizado)", "ADN como Sistema de Almacenamiento de Datos Personales", "Rejuvenecimiento Celular con Efectos Impredecibles", "Mercado Negro de Mejoras Genéticas Ilegales", "Supresión Química Permanente de la Agresividad",
            // Redes Sociales & Identidad Digital
            "La App que Mide tu Valor Social en Tiempo Real", "Influencers Totalmente Virtuales con Millones de Seguidores Reales", "Juicios por Crímenes Cometidos por Avatares Digitales", "Filtro de Belleza Permanente en la Percepción Visual", "Vida Después de la Muerte Digital: Tu Perfil Sigue Activo", "Adicción a la Validación por 'Likes' Cuantificada", "Robo de Identidad Digital Total (Incluyendo Biometría)", "El Fin del Anonimato Online", "Realidad Curada: Solo Ves lo que el Algoritmo Quiere", "Dependencia Emocional de Asistentes Digitales", "Citas a Ciegas Basadas 100% en Compatibilidad Algorítmica", "El Linchamiento Digital como Espectáculo Público", "Memes que Alteran la Percepción de la Realidad", "Construcción de Identidades Múltiples Verificadas", "Desintoxicación Digital Forzada por el Gobierno", "El Mercado de Seguidores y 'Engagement' Falso", "Legado Digital: ¿Qué Pasa con tus Datos al Morir?", "La Viralidad como Moneda Social", "Extorsión Basada en Historial Digital Completo", "Plataforma Social que Fusiona Mentes Temporalmente",
            // Automatización & Futuro Laboral
            "Reemplazo Masivo de Trabajadores por Robots Empáticos", "Renta Básica Universal... Condicionada a Comportamiento", "Ciudades Fantasma por Automatización Industrial", "El Arte de 'No Hacer Nada' en un Mundo Sin Trabajo", "Trabajos Exclusivos para Humanos 'No Mejorados'", "Entrenamiento Vocacional Obligatorio Dictado por IA", "Conflicto entre Humanos y Robots por Recursos", "Obsolescencia Humana Programada", "El Mercado Negro de Trabajos Manuales Ilegales", "Sistema de Castas Basado en Habilidades 'Automatizables'", "Cuando los Robots de Cuidado Desarrollan Preferencias", "Huelga General de Sistemas Autónomos", "Creatividad Artificial vs. Creatividad Humana: La Última Frontera", "El Papel del Ocio en una Sociedad Post-Trabajo", "Economía Basada en Tareas Mínimas para Humanos",
            // Otros Conceptos Inquietantes
            "Impresoras 3D de Comida que Usan ¿Qué?", "Sistema de Justicia Predictiva para Niños", "Publicidad Dirigida en Sueños", "App de Traducción Universal que Revela Subtexto Emocional", "Generador Climático Personal... con Disputas Vecinales", "Turismo de Desastres Simulados", "Mercado de Órganos Sintéticos con Fallos Ocultos", "Tecnología de Invisibilidad Personal (y sus abusos)", "Control Mental Colectivo a través de Ondas", "Interfaz Directa con el Mundo Animal", "Registro Histórico Total e Inmutable: Sin Derecho al Olvido", "Borrado Selectivo de Especies Animales por IA", "Música Generada por IA que Induce Estados Emocionales Específicos", "Seguros de Vida Basados en Predicción de Muerte Algorítmica", "Realidad como Servicio de Suscripción",

            // Añadir más variaciones y combinaciones...
            "La Caja Negra de tu Vida: Grabación Continua", "El Juego de Realidad Alterna que Se Vuelve Real", "Compartir Sensaciones Físicas a Distancia", "Implante de Idiomas Instantáneo", "El Precio de la Verdad Absoluta (Detector IA)", "Amor Programado por Algoritmo", "Venganza Digital Anónima", "El Eco-Sistema Controlado por IA", "Modificación del Clima como Arma", "Sueños Lúcidos como Espacio Publicitario",
            "Niñera IA con Autoridad Parental", "Religión Basada en una IA 'Divina'", "Conciencia Colectiva Digital Temporal", "Mercado de Habilidades Descargables", "Terapia Genética para la Felicidad Obligatoria", "El Reality Show de Vigilancia Total", "Filtro Parental de Realidad", "Policía Robótica con Sesgos Programados", "Viaje en el Tiempo Limitado (Solo Observación)", "Comunicación con Versiones Futuras (Paradójica)",
            "Hackeo Biométrico Masivo", "Red Social de Recuerdos Compartidos", "Implante de Optimismo Químico", "Realidad Virtual para Condenados a Cadena Perpetua", "Algoritmo de Emparejamiento Genético Obligatorio", "Control de Plagas con Drones Letales Autónomos", "Edición de Recuerdos para Testigos", "Mercado Negro de Identidades Sintéticas", "Sistema de Reputación Blockchain Inmutable", "IA que Juzga la Moralidad de las Acciones",
            // Aún más ideas para acercarse a 400...
            "App para Calificar Interacciones Humanas", "Generador de Escenarios 'What If' Personalizados", "Implante de Supresión de Miedo", "Realidad Aumentada Histórica Interactiva", "Mercado de Influencia Política Digital", "Seguridad del Hogar Predictiva y Preemptiva", "Algoritmo de Optimización de Vida Personal", "Clonación de Mascotas con Recuerdos Implantados", "Sistema de Transporte Autónomo Centralizado", "Terapia de Conversión de Orientación Sexual por IA (Fallida)",
             "Implantes de Traducción Animal", "Realidad Virtual como Castigo Penal", "Mercado de Experiencias Extremas Simuladas", "Control de la Fertilidad Remoto y Centralizado", "Algoritmo de Asignación de Vivienda Social", "Drones Personales de Compañía y Vigilancia", "Edición Genética para Resistencia a Enfermedades (con costo oculto)", "Sistema de Votación Digital Directa y Continua", "Implante de Honestidad Radical", "Plataforma de Resolución de Conflictos por IA",
             "Mercado de Sueños Lúcidos Personalizados", "Realidad Aumentada para Ciegos (con glitches)", "IA de Composición Musical Emocionalmente Reactiva", "Sistema de Predicción de Relaciones de Pareja", "Implante de Lealtad Corporativa", "Clonación Terapéutica Acelerada", "Mercado Negro de Datos Biométricos", "Realidad Virtual Educativa Totalmente Inmersiva", "Algoritmo de Predicción de Éxito Profesional", "Implante de Supresión del Dolor (adictivo)",
             "App de Detección de Microexpresiones", "Generador de Compañeros de IA Fallecidos", "Sistema de Justicia Restaurativa por VR", "Mercado de Secretos Anónimos Verificados", "Control de Población Basado en Recursos IA", "Drones de Polinización Artificial", "Edición Genética Estética Pre-Natal", "Sistema de Reputación Profesional Global", "Implante de Habilidades Motoras Profesionales", "Plataforma de Intercambio Temporal de Conciencia",
             "Mercado de Avatares Digitales Idénticos", "Realidad Aumentada con Capas Ocultas de Información", "IA de Diagnóstico Médico Infalible (pero sin empatía)", "Sistema de Predicción de Desastres Naturales (con dilemas éticos)", "Implante de Control de Adicciones (hackeable)", "Clonación de Líderes Históricos", "Mercado Negro de Recuerdos Felices Falsos", "Realidad Virtual para Entrenamiento Militar Realista", "Algoritmo de Optimización del Sueño", "Implante de Silencio Mental Selectivo",
             "App de Calificación de Padres", "Generador de Alibis Digitales Perfectos", "Sistema de Mediación de Conflictos Internacionales por IA", "Mercado de Votos Electorales", "Control de Emisiones Personales Monitorizado", "Drones de Entrega con Reconocimiento Facial", "Edición Genética para Habilidades Artísticas", "Sistema de Reputación Académica Permanente", "Implante de Conocimiento Enciclopédico Instantáneo", "Plataforma de Confesiones Anónimas con IA Absolutoria",
             "Mercado de Experiencias de Muerte Simulada", "Realidad Aumentada Terapéutica para Fobias", "IA de Creación Literaria Personalizada", "Sistema de Predicción de Tendencias Sociales", "Implante de Empatía Animal", "Clonación de Especies Extintas (con consecuencias)", "Mercado Negro de Virus Informáticos Biológicos", "Realidad Virtual para Rehabilitación de Criminales", "Algoritmo de Asignación de Amistades", "Implante de Resistencia Física Sobrehumana"
        ];
        const blackMirrorThemes = [ // Para generar más ideas
            "inteligencia artificial avanzada", "conciencia digital", "realidad virtual inmersiva", "realidad aumentada ubicua", "vigilancia masiva", "crédito social", "privacidad de datos", "biotecnología", "edición genética", "implantes neurales", "modificación corporal", "redes sociales tóxicas", "identidad digital", "automatización laboral", "consecuencias imprevistas de la tecnología", "ética tecnológica", "distopía cercana", "control social algorítmico", "memoria digital", "naturaleza de la realidad", "soledad en la era digital", "adicción tecnológica", "el lado oscuro de la conveniencia", "relaciones mediadas por tecnología"
        ];
        const textApiConfig = { // Prompt para generar la historia/sinopsis
            model: "mistral",
            systemPrompt: "Eres un guionista y escritor de ciencia ficción especializado en el estilo de 'Black Mirror'. Tu tarea es desarrollar la siguiente premisa en una historia corta o sinopsis detallada (aprox. 1200-1300 palabras). Establece un futuro cercano plausible, introduce la tecnología central y uno o varios personajes que interactúan con ella. Explora las consecuencias personales, sociales y/o éticas, a menudo inesperadas u oscuras, de dicha tecnología. Céntrate en el impacto psicológico y las relaciones humanas. La historia debe ser inquietante, reflexiva y dejar una impresión duradera, típicamente con un final ambiguo, irónico o directamente desolador. Evita clichés de ciencia ficción exagerados; mantén el tono realista y cercano característico de Black Mirror. Desarrolla únicamente la siguiente premisa:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
             model: "mistral-tiny", // O un modelo similar rápido
             systemPrompt: "Actúas como un analista crítico especializado en las implicaciones de la tecnología como se ve en Black Mirror. El usuario está viendo una historia basada en la premisa '[PLACEHOLDER_PREMISE]'. Responde sus preguntas sobre los temas éticos, las posibles ramificaciones sociales, el funcionamiento de la tecnología específica, o las motivaciones de los personajes dentro de esa premisa. Sé conciso, analítico y mantén un tono reflexivo y ligeramente cínico.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso al estilo Black Mirror. Genera exactamente 15 premisas intrigantes y perturbadoras para historias cortas. Cada premisa debe centrarse en una tecnología de futuro cercano y explorar sus posibles consecuencias oscuras, inesperadas o éticamente cuestionables en la vida humana o la sociedad. Devuelve *solo* la lista de premisas, una por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 45
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales, solo IDs)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            let systemPromptToUse = config.systemPrompt;

            if (isChat && currentStoryTitle) {
                // Reemplaza el placeholder en el systemPrompt del chat
                systemPromptToUse = config.systemPrompt.replace('[PLACEHOLDER_PREMISE]', currentStoryTitle);
            }
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            // Seed no suele ser útil para chat o generación de títulos variante
            // if (config.seed && !isChat && config !== titleGenerationConfig) params.append('seed', config.seed);
             if (config.seed) params.append('seed', config.seed); // Mantener seed para la historia principal por consistencia si se desea

            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}, Title: ${currentStoryTitle || 'N/A'}): ${url.substring(0, 250)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    // Mensaje de error amigable
                    throw new Error(`(Error ${response.status}) Nuestros servidores están experimentando mucho tráfico en este momento. Por favor, intenta de nuevo en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o seleccionar otro escenario.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }
        // Wrappers para claridad
        async function fetchStoryContent(storyTitle) {
            return fetchTextFromApi(storyTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentStoryTitle) throw new Error("Error interno: Contexto de la historia no establecido para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true); // true indica chat
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(blackMirrorThemes) || "tecnología y sociedad";
            const specificPrompt = `Genera 15 premisas de historias estilo Black Mirror sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 200); // Ajustar filtro longitud
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de escenarios.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 500, nologo: true }; // Ratio más cinemático
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "dark near-future technology concept";
            // Prompt enfocado en el estilo BM
            const enhancedPrompt = `Conceptual art, Black Mirror style, inspired by '${safePromptText}'. Focus on atmosphere: near-future tech, social commentary, psychological unease, slightly dystopian. Use cinematic lighting, minimalist composition, dark or muted color palette with potential sharp contrast. Avoid text, labels, diagrams.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, photorealistic, overly bright, happy, utopian, cartoon, anime";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) {
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, ' '); // Reemplaza saltos internos con espacio para flujo de párrafo
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (sin cambios funcionales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null; // Limpia contexto
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios funcionales)
        function showFullscreenImage(imgSrc) {
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios funcionales)
        function addChatMessage(message, sender) { /* ... */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        function addChatError(message) { /* ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`>> Error IA: ${error.message}`); // Añadir prefijo para claridad
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
         }

        // ========== UI & EVENT HANDLERS ========== (sin cambios funcionales)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // No ordenar alfabéticamente para mantener posible curación o agrupación temática intencional
             // const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (titles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-mono">// No hay escenarios en el archivo //</p>'; return; }
             titles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick (Adaptado a 'Story') ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = ''; // Limpiar historial chat
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawStoryText = await fetchStoryContent(title); // Cambiado nombre función
                const formattedStory = formatExplanationText(rawStoryText); // Reutiliza formateador

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedStory;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll reset after content visible");

                // Placeholder y carga de imagen (sin cambios funcionales)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;font-family:'Roboto Mono';">Generando visualización...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual para: ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;font-family:'Roboto Mono';">// Visualización fallida //</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;font-family:'Roboto Mono';">// Error URL imagen //</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el escenario."; // Mensaje amigable
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden'); // Ocultar chat si falla carga principal
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Procesando Nuevos Datos...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar nuevas simulaciones en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar simulaciones: ${error.message}`); // Mensaje amigable
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Cargar Nuevas Simulaciones';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (sin cambios funcionales)
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: #f43f5e; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: monospace;">// SYSTEM ERROR: UI CORRUPTION DETECTED //</p>';
                 return;
             }
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>