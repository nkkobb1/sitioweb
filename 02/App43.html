<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ciencia Sencilla - Conceptos de Química</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Base (sin cambios) --- */
        :root {
            --color-primary: #3b82f6; --color-secondary: #a855f7; --color-background: #f8fafc;
            --color-text: #111827; --color-text-muted: #4b5563; --color-modal-bg: #ffffff;
            --color-border: #e5e7eb; --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px; --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); }
        h1, h2, h3, h4, .logo { font-family: 'Quicksand', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #2563eb; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.8); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem; max-width: 850px; width: 95%; max-height: 90vh; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e5e7eb; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.4rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #d1d5db; color: var(--color-text); }
        #modal-title { color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; }
        #modal-content { line-height: 1.7; color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 10px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content::-webkit-scrollbar { width: 8px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.2em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Quicksand', sans-serif; margin-top: 1.8em; margin-bottom: 0.8em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.3em; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.2em; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-secondary); }
        /* --- NEW: Styles for converted formulas --- */
        #modal-content .formula {
            text-align: center;
            font-family: 'Consolas', 'Courier New', Courier, monospace; /* Monospace for formulas */
            font-size: 1.1em; /* Slightly larger */
            padding: 0.8em;
            margin: 1.2em 0;
            border: 1px solid var(--color-border);
            background-color: #f9fafb; /* Light background */
            border-radius: var(--border-radius);
            overflow-x: auto; /* Handle long formulas */
            white-space: nowrap; /* Prevent wrapping within the formula */
        }
        #modal-content .formula sub,
        #modal-content .formula sup {
             font-size: 0.8em; /* Make sub/sup slightly smaller */
             line-height: 0; /* Prevent affecting line height */
             position: relative;
             vertical-align: baseline;
        }
        #modal-content .formula sub { top: 0.5em; }
        #modal-content .formula sup { top: -0.5em; }
        /* --- End of new styles --- */
        #modal-image-container { width: 100%; height: 220px; background-color: #f3f4f6; border-radius: var(--border-radius); overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 2.5rem; color: var(--color-border); display: none; }
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: var(--border-radius); border: 1px solid #fecaca; margin-top: 1rem; text-align: center; flex-shrink: 0; }
        .error-msg i { margin-right: 0.5rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
    <!-- Interface HTML (Navbar, Main Content, Modal, Footer) -->
    <!-- ... (HTML igual que en la versión anterior) ... -->
     <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-3 flex justify-center items-center">
             <div class="flex items-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-vial mr-2"></i> Ciencia Sencilla: Química
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Descifrando la Materia</h1>
             <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Explora los bloques fundamentales del universo con explicaciones claras de química por IA. ¡Selecciona un concepto!</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-atom text-purple-500 mr-2"></i>
                 Conceptos a Explorar
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Buscando elementos...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Conceptos
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Sintetizando explicación...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                 </div>
                  <!-- Image Container (Fixed height, at bottom) -->
                 <div id="modal-image-container">
                     <div class="spinner"></div>
                     <i class="fas fa-flask placeholder-icon"></i> <!-- Placeholder icon -->
                     <img id="modal-image" alt="Ilustración abstracta del concepto" />
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-circle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
         </div>
     </div>

     <!-- Footer -->
     <footer class="bg-gray-100 text-gray-600 py-5 mt-12 border-t border-gray-200">
         <div class="container mx-auto px-4 text-center text-sm">
             <p>Explicaciones generadas por IA con fines educativos. La química requiere rigor, consulta fuentes expertas.</p>
             <p class="mt-1">© 2025 Ciencia Sencilla</p>
         </div>
     </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [ /* ... Lista de títulos de química (igual) ... */
            "¿Qué es un Átomo?", "Protones, Neutrones y Electrones", "El Núcleo Atómico", "La Nube Electrónica", "Número Atómico (Z) y Número Másico (A)", "Isótopos: Átomos del Mismo Elemento, Diferente Masa", "Iones: Átomos con Carga Eléctrica", "La Tabla Periódica de los Elementos", "Grupos y Periodos en la Tabla Periódica", "Metales, No Metales y Metaloides", "Propiedades Periódicas (Radio Atómico, Electronegatividad)", "Gases Nobles: Los Elementos Estables", "Alcalinos y Alcalinotérreos", "Halógenos: Formadores de Sales", "¿Qué es un Enlace Químico?", "Enlace Iónico: Transferencia de Electrones", "Formación de Compuestos Iónicos (Sales)", "Enlace Covalente: Compartiendo Electrones", "Enlace Covalente Polar y No Polar", "Enlace Covalente Simple, Doble y Triple", "Moléculas: Unión de Átomos", "Estructuras de Lewis Simplificadas", "Geometría Molecular Básica (Lineal, Angular, Tetraédrica)", "Fuerzas Intermoleculares (Van der Waals, Puentes de Hidrógeno)", "Enlace Metálico: El Mar de Electrones", "¿Qué es una Reacción Química?", "Reactivos y Productos", "La Ley de Conservación de la Masa", "Balanceo de Ecuaciones Químicas Sencillas", "Tipos de Reacciones (Síntesis, Descomposición, Desplazamiento, Combustión)", "Reacciones de Óxido-Reducción (Redox)", "Agentes Oxidantes y Reductores", "Estequiometría: Cálculos Químicos Básicos", "¿Qué es un Mol?", "El Número de Avogadro", "Masa Molar: Masa de un Mol", "Estados de la Materia: Sólido, Líquido, Gas", "Cambios de Estado (Fusión, Vaporización, etc.)", "Punto de Fusión y Ebullición", "Las Propiedades de los Gases (Ley de Boyle, Charles, Gay-Lussac)", "El Modelo Cinético Molecular", "Plasma: El Cuarto Estado de la Materia", "¿Qué es una Disolución (Solución)?", "Soluto y Disolvente", "Concentración de Disoluciones (Molaridad, Porcentaje)", "Solubilidad: ¿Cuánto se Disuelve?", "Disoluciones Saturadas, Insaturadas y Sobresaturadas", "Factores que Afectan la Solubilidad", "¿Qué son los Ácidos?", "Características de los Ácidos (Sabor, Corrosión)", "¿Qué son las Bases (Álcalis)?", "Características de las Bases (Tacto Jabonoso, Amargas)", "La Escala de pH: Midiendo Acidez y Alcalinidad", "Indicadores de pH (Papel Tornasol, Fenolftaleína)", "Reacción de Neutralización: Ácido + Base -> Sal + Agua", "Ácidos y Bases Fuertes vs. Débiles", "Química Orgánica: La Química del Carbono", "Hidrocarburos: Alcanos, Alquenos, Alquinos", "Isómeros: Misma Fórmula, Diferente Estructura", "Grupos Funcionales (Alcoholes, Aldehídos, Cetonas, Ácidos Carboxílicos)", "Polímeros: Moléculas Gigantes (Plásticos)", "Introducción a la Bioquímica: Moléculas de la Vida", "Termoquímica: Energía en las Reacciones", "Reacciones Exotérmicas y Endotérmicas", "Entalpía: Calor de Reacción", "Energía de Activación: La Barrera a Superar", "Cinética Química: Velocidad de las Reacciones", "Factores que Afectan la Velocidad (Temperatura, Concentración, Catalizadores)", "Catalizadores: Aceleradores de Reacciones", "¿Qué es el Equilibrio Químico?", "Principio de Le Châtelier: Perturbando el Equilibrio", "Constante de Equilibrio (Kc)", "Química Nuclear: El Núcleo Inestable", "Radiactividad (Alfa, Beta, Gamma)", "Fisión Nuclear: Rompiendo Átomos", "Fusión Nuclear: Uniendo Átomos (Estrellas)", "Vida Media de Isótopos Radiactivos", "Aplicaciones de la Química Nuclear", "Electroquímica: Química y Electricidad", "Pilas y Baterías: Generando Electricidad", "Electrólisis: Usando Electricidad para Reacciones", "Corrosión: La Oxidación de los Metales", "Química Ambiental: Química y Medio Ambiente", "El Efecto Invernadero y el Calentamiento Global", "La Lluvia Ácida", "La Contaminación del Agua y el Aire", "La Capa de Ozono y su Protección", "Química Verde: Previniendo la Contaminación", "Materiales: Propiedades y Usos", "Metales y Aleaciones", "Cerámicas y Vidrios", "Polímeros Sintéticos y Naturales", "Materiales Compuestos", "Nanomateriales: Química a Escala Pequeña", "Química Analítica: Identificando Sustancias", "Técnicas de Separación (Filtración, Destilación, Cromatografía)", "Espectroscopía Básica: Interacción Luz-Materia", "Química Inorgánica: Más Allá del Carbono", "Compuestos de Coordinación", "Química del Estado Sólido", "Nomenclatura Química Básica (Óxidos, Hidruros, Sales Binarias)", "Ácidos Oxácidos e Hidrácidos", "Hidróxidos (Bases)", "Historia de la Química: De la Alquimia a la Ciencia", "Dalton y la Teoría Atómica", "Mendeléyev y la Tabla Periódica", "Lavoisier y la Conservación de la Masa", "Marie Curie y la Radiactividad", "Seguridad en el Laboratorio Químico", "Cristales y Estructuras Cristalinas", "Coloides: Entre Disolución y Suspensión", "Ósmosis y Presión Osmótica", "Entropía: El Desorden del Universo", "Energía Libre de Gibbs: Espontaneidad", "Combustión: Reacciones con Oxígeno", "Neutralización Ácido-Base en la Vida Diaria", "Jabones y Detergentes: Limpieza Química", "Química de los Alimentos (Carbohidratos, Lípidos, Proteínas)", "Química en la Cocina: Reacciones al Cocinar", "Conservantes y Aditivos Alimentarios", "Fertilizantes: Nutrientes para Plantas", "Pesticidas y Herbicidas", "Química Forense: Ciencia en la Investigación", "Química de los Explosivos", "Química de los Fármacos", "Desarrollo de Nuevos Medicamentos", "Interacciones Químicas en el Cuerpo Humano", "La Química del Amor (Neurotransmisores)", "Química de los Colores (Pigmentos y Tintes)", "Química Atmosférica", "Ciclo del Nitrógeno y Fósforo", "Química del Suelo", "Tratamiento del Agua Potable", "Química del Petróleo y Gas Natural", "Refinación del Petróleo", "Combustibles Fósiles y Alternativos", "Celdas de Combustible de Hidrógeno", "Energía Solar y Química Fotovoltaica", "Química Computacional: Simulando Moléculas", "Química Supramolecular", "Teoría de Orbitales Moleculares Básica"
        ];
        const chemistryThemes = [ /* ... Lista de temas de química (igual) ... */
            "la estructura atómica", "la tabla periódica", "los enlaces químicos", "las reacciones químicas", "la estequiometría", "los estados de la materia", "las disoluciones", "los ácidos y bases", "la química orgánica", "la termoquímica", "la cinética química", "el equilibrio químico", "la electroquímica", "la química nuclear", "la química ambiental", "los materiales", "la nomenclatura", "la historia de la química", "la bioquímica básica", "la química analítica", "la química inorgánica", "la seguridad en el laboratorio", "la química de la vida diaria", "la energía", "las propiedades de la materia"
        ];
        const textApiConfig = { model: "mistral", systemPrompt: "Eres un excelente comunicador científico especializado en química. Tu tarea es explicar conceptos químicos complejos de forma muy clara, sencilla y detallada para un público general o estudiantes (similar a un artículo de divulgación introductorio). Utiliza analogías simples, ejemplos cotidianos y evita la jerga excesiva. Estructura la explicación con claridad usando párrafos y ocasionalmente sub-títulos (usando markdown como #, ##, ### o ####). El objetivo es una explicación completa y fácil de entender de unas 700-800 palabras. Basa tu explicación únicamente en el siguiente concepto:", timeoutSeconds: 100 };
        const titleGenerationConfig = { model: "mistral", systemPrompt: "Actúa como un generador de ideas conciso. Genera exactamente 15 conceptos o preguntas clave sobre química, adecuados para ser explicados de forma sencilla. Devuelve *solo* la lista de conceptos/preguntas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.", timeoutSeconds: 30 };

        // ========== DOM ELEMENTS ========== (sin cambios)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) { /* ... sin cambios ... */
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url}`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
             }
        }
        async function fetchExplanationText(conceptTitle) { /* ... sin cambios ... */
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              if (text.trim().length < 500 || text.toLowerCase().includes("cannot fulfill")) {
                  throw new Error("La IA no pudo generar una explicación adecuada para este concepto.");
              }
             return text;
        }
        async function fetchGeneratedTitles() { /* ... sin cambios ... */
             const randomTheme = getRandomElement(chemistryThemes) || "conceptos básicos";
             const specificPrompt = `Genera 15 conceptos o preguntas clave sobre ${randomTheme} en química`;
             console.log("Generating concepts with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 120);
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de conceptos.");
             return titles.slice(0, 15);
        }
        function createPollinationsImageUrl(promptText, options = {}) { /* ... sin cambios ... */
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "chemistry concept abstract";
             const enhancedPrompt = `Abstract conceptual visualization related to the chemistry concept of '${safePromptText}', artistic render, minimalist style, focus on energy or interaction`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, chemical formulas, equations, diagrams, charts, graphs, schematics, UI, interface, menu, buttons, overlay, watermark, signature, infographic, scientific illustration with labels, molecule diagram, atomic model diagram, periodic table elements, realistic photo, person, people, lab equipment drawing, beaker drawing, flask drawing";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
        }

        // ========== Text Formatting Function (Updated) ==========
        /**
         * Converts simple Markdown-like and LaTeX-like syntax to HTML.
         * Handles: #, ##, ###, #### Headings, **bold**, *italic*, paragraphs,
         * LaTeX formulas \[ ... \], \text{}, _subscript, ^superscript, \rightarrow.
         * @param {string} rawText - The text from the API.
         * @returns {string} - HTML formatted string.
         */
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();

            // --- ORDERED REPLACEMENTS ---

            // 1. Inner LaTeX-like elements FIRST (within potential \[...\] or inline)
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); // Remove \text{}
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); // Subscripts X_2 or X_{22}
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { // Superscripts X^+ X^- X^{2+} X^{2-}
                 // Replace unicode minus sign if present from API
                const cleanExponent = exponent.replace('−', '-');
                return `${base}<sup>${cleanExponent}</sup>`;
            });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); // Arrow

            // 2. LaTeX Display Math delimiters -> Wrap in styled paragraph
            // Use non-greedy match (.*?) and handle potential spaces
            // Process this BEFORE markdown headings to avoid conflicts if # used inside formula
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');

            // 3. Markdown Headings (multiline mode) - Order matters
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');

            // 4. Markdown Bold/Italics
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // 5. Handle Paragraphs (split by double newline AFTER other block elements)
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                // If it's already a heading or formula, keep it as is
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) {
                    return block;
                }
                // Otherwise, wrap in <p> and handle internal newlines as <br>
                // Make sure internal <br> doesn't break sub/sup tags
                let content = block.replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');

            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (sin cambios)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { if(!storyModal) return; storyModal.classList.remove('active'); document.body.style.overflow = ''; resetModalState(); }
        function resetModalState() { /* ... sin cambios ... */
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalContent.scrollTop = 0;
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.style.display = 'flex';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... sin cambios ... */
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]);
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay conceptos disponibles.</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        // handleTitleClick (sin cambios, ya usa formatExplanationText)
        async function handleTitleClick(title) { /* ... lógica sin cambios ... */
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalImageContainer.style.display = 'none';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText); // Format applies ALL rules

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'flex';
                modalImageSpinner.style.display = 'block';

                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else { console.error("Could not create image URL:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; }

            } catch (error) {
                console.error("Failed display:", error); modalLoadingIndicator.style.display = 'none'; modalErrorMessage.textContent = `${error.message}`; modalError.classList.remove('content-hidden'); modalStoryContentArea.classList.remove('content-hidden'); modalImageContainer.style.display = 'none'; modalContent.innerHTML = '';
            }
        }
        // handleGenerateMoreTitles (sin cambios)
        async function handleGenerateMoreTitles() { /* ... sin cambios ... */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Cargando...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se pudieron generar nuevos conceptos en este momento."); }
             } catch (error) { console.error("Failed generation:", error); alert(`Error: ${error.message}`);
             } finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Conceptos'; }
         }

        // ========== INITIALIZATION ========== (sin cambios)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p>Error crítico.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>