<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudio del Espiritismo Kardecista</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Elegantes y Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Espiritismo Kardecista --- */
        :root {
            --color-primary: #8a71c7; /* Lila Suave */
            --color-secondary: #a0d2eb; /* Azul Cielo Claro */
            --color-tertiary: #f6e8ea; /* Rosa Pálido/Beige */
            --color-accent: #ffd700; /* Dorado Suave (para detalles) */
            --color-background: #fdfdff; /* Blanco Casi Puro */
            --color-text: #4a4a68; /* Gris Azulado Oscuro */
            --color-text-muted: #7f7f9a;
            --color-modal-bg: #ffffff; /* Blanco */
            --color-border: #e2e8f0; /* Borde Gris Claro */
            --color-error-bg: #fff1f2; /* Rosa claro error */
            --color-error-text: #be123c; /* Texto error rojo */
            --color-error-border: #fecdd3; /* Borde error rosa */

            --shadow-sm: 0 1px 3px 0 rgba(138, 113, 199, 0.1), 0 1px 2px 0 rgba(138, 113, 199, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(138, 113, 199, 0.1), 0 2px 4px -1px rgba(138, 113, 199, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(138, 113, 199, 0.1), 0 4px 6px -2px rgba(138, 113, 199, 0.05);
            --border-radius: 6px; /* Bordes suaves */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Cormorant Garamond', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 600; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(138, 113, 199, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Lato'; font-size: 0.95rem; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f8f5ff; } /* Fondo lila muy claro */
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; text-shadow: none; }
        #generate-more-btn:hover:not(:disabled) { background-color: #715aa8; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: #c7c0e0; color: #fdfdff; cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(74, 74, 104, 0.8); /* Overlay gris azulado */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Más altura para chat y juego */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e2e8f0; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; /* Padding interno del texto */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; font-family: 'Lato'; }
        #modal-content em { color: #5a9abd; /* Azul más profundo */ font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cormorant Garamond', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 600; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: #7f7f9a; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); font-family: 'Lato'; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(160, 210, 235, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.7rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fafdff; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-secondary); color: #333; margin-left: auto; text-align: right; }
        .ai-message { background-color: #f0eaff; /* Lila muy claro */ color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(138, 113, 199, 0.15); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #715aa8; }
        #chat-send-btn:disabled { background-color: #c7c0e0; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Screen & Mini-Game Styles */
        #modal-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); display: none; /* Hidden initially */ flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); padding: 2rem; text-align: center; font-family: 'Lato'; }
        #modal-loading.active { display: flex; } /* Show when loading */
        #loading-message { font-weight: 600; color: var(--color-primary); font-size: 1.4rem; margin-bottom: 1.5rem; font-family: 'Cormorant Garamond'; }
        #loading-submessage { color: var(--color-text-muted); margin-bottom: 2rem; font-size: 1rem; }
        #minigame-container { width: 100%; max-width: 450px; background-color: #f8f5ff; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); border: 1px solid var(--color-border); }
        #game-click-area { margin-bottom: 1.5rem; }
        #game-click-button { width: 80px; height: 80px; background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); border-radius: 50%; border: none; color: white; font-size: 2.5rem; cursor: pointer; transition: transform 0.1s ease, box-shadow 0.2s ease; display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: var(--shadow-md); }
        #game-click-button:hover { transform: scale(1.05); box-shadow: var(--shadow-lg); }
        #game-click-button:active { transform: scale(0.95); }
        #game-click-button i { text-shadow: 0 0 5px rgba(0,0,0,0.2); } /* Icon: fa-book-open, fa-lightbulb, fa-hands-helping */
        #game-stats { margin-bottom: 1.5rem; font-size: 1.1rem; color: var(--color-text); }
        #game-up-display { font-weight: 700; color: var(--color-primary); font-size: 1.3em; }
        #game-ups-display { font-size: 0.9em; color: var(--color-text-muted); }
        #game-level-display { margin-top: 0.5rem; font-weight: 600; color: var(--color-secondary); }
        #game-upgrades { display: flex; flex-direction: column; gap: 0.8rem; }
        .game-upgrade-btn { background-color: #fff; border: 1px solid var(--color-border); color: var(--color-primary); padding: 0.7rem 1rem; border-radius: var(--border-radius); cursor: pointer; transition: var(--transition-normal); text-align: left; font-size: 0.9rem; }
        .game-upgrade-btn:hover:not(:disabled) { background-color: #f0eaff; border-color: var(--color-primary); }
        .game-upgrade-btn:disabled { background-color: #f9fafb; color: var(--color-text-muted); border-color: #e5e7eb; cursor: not-allowed; opacity: 0.7; }
        .upgrade-cost { float: right; font-weight: 600; color: var(--color-text-muted); }
        .upgrade-level { font-size: 0.8em; color: var(--color-secondary); display: block; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 1px solid var(--color-border); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: #f1f5f9; color: var(--color-primary); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-book-open mr-3 text-purple-500"></i> <!-- Icono libro -->
                     Estudio Kardecista
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">Guía Interactiva Basada en la Codificación</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Explorando el Espiritismo</h1>
             <p class="text-lg text-gray-600 mb-8 max-w-3xl mx-auto font-light">Un espacio para el estudio y la reflexión sobre la Doctrina Espírita codificada por Allan Kardec. Selecciona un tema o busca conceptos.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar tema, concepto o figura...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-lightbulb text-purple-500 mr-2"></i> <!-- Icono idea/luz -->
                 Temas de Estudio
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando índice de temas...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No se encontraron temas que coincidan con la búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Más Temas (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Mini-Game -->
             <div id="modal-loading">
                 <h3 id="loading-message">Procesando Información...</h3>
                 <p id="loading-submessage">Mientras esperas, puedes acumular Entendimiento:</p>
                 <div id="minigame-container">
                     <div id="game-click-area">
                         <button id="game-click-button" aria-label="Acumular Entendimiento">
                             <i class="fas fa-brain"></i> <!-- Cambiar icono si se quiere: fa-book-open, fa-lightbulb, fa-hands-helping, fa-atom, fa-seedling -->
                         </button>
                     </div>
                     <div id="game-stats">
                         Entendimiento: <span id="game-up-display">0</span><br>
                         <span id="game-ups-display">0</span> por segundo
                         <div id="game-level-display">Nivel de Estudio: Básico</div>
                     </div>
                     <div id="game-upgrades">
                         <button class="game-upgrade-btn" id="upgrade-study" data-cost="10" data-level="0" data-basecost="10" data-rate="0.1">
                             Estudio Enfocado <span class="upgrade-level">(Nivel 0)</span>
                             <span class="upgrade-cost">Costo: 10</span>
                         </button>
                         <button class="game-upgrade-btn" id="upgrade-meditation" data-cost="100" data-level="0" data-basecost="100" data-rate="1">
                             Meditación Profunda <span class="upgrade-level">(Nivel 0)</span>
                             <span class="upgrade-cost">Costo: 100</span>
                         </button>
                         <button class="game-upgrade-btn" id="upgrade-intuition" data-cost="1000" data-level="0" data-basecost="1000" data-rate="8">
                             Intuición Guiada <span class="upgrade-level">(Nivel 0)</span>
                             <span class="upgrade-cost">Costo: 1000</span>
                         </button>
                          <button class="game-upgrade-btn" id="upgrade-charity" data-cost="15" data-level="0" data-basecost="15" data-rate="1">
                             Actos de Caridad (UP por Clic)<span class="upgrade-level">(Nivel 0)</span>
                             <span class="upgrade-cost">Costo: 15</span>
                         </button>
                     </div>
                 </div>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Reflexionando sobre la consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Profundiza sobre este tema...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-50 text-gray-500 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Contenido generado por IA como herramienta de estudio y reflexión sobre el Espiritismo Kardecista.</p>
              <p class="mt-1">Se recomienda siempre consultar las obras de Allan Kardec y fuentes espíritas confiables.</p>
              <p class="mt-2">© 2025 Estudio Kardecista Interactivo</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Fundamentos Doctrinarios
            "Dios: Inteligencia Suprema, Causa Primera", "Existencia y Naturaleza de los Espíritus", "Inmortalidad del Alma", "Reencarnación: Ley de Progreso", "Ley de Causa y Efecto (Karma/Acción y Reacción)", "Comunicabilidad de los Espíritus (Mediumnidad)", "Pluralidad de los Mundos Habitados", "Escala Espírita: Órdenes y Clases de Espíritus", "Periespíritu: Envoltura Semimaterial", "Fluidos: Fluido Cósmico Universal y Fluidos Vitales", "Libre Albedrío y Responsabilidad", "Progreso Intelectual y Moral", "La Oración según el Espiritismo", "Caridad: Benevolencia, Indulgencia, Perdón", "Olvido del Pasado en la Reencarnación", "Triple Aspecto: Ciencia, Filosofía, Religión/Moral", "Objetivo de la Encarnación", "Mundo Espiritual vs. Mundo Corporal", "Influencia de los Espíritus en Nuestras Vidas", "Sueño y Emancipación Parcial del Alma",
            // La Codificación Kardecista (Obras Fundamentales)
            "El Libro de los Espíritus: Filosofía Espírita", "Contenido Principal de El Libro de los Espíritus", "Estructura de El Libro de los Espíritus", "El Libro de los Médiums: Guía Teórico-Práctica", "Tipos de Mediumnidad descritos por Kardec", "Obsesión Espiritual: Tipos y Tratamiento (en Libro de Médiums)", "El Evangelio según el Espiritismo: Moral Cristiana", "Máximas Morales de Jesús explicadas", "Instrucciones de los Espíritus en El Evangelio", "El Cielo y el Infierno: Justicia Divina", "Código Penal de la Vida Futura", "Ejemplos de Situaciones de Espíritus (Cielo e Infierno)", "La Génesis: Milagros y Predicciones", "Origen de la Vida y del Universo según La Génesis", "Teoría de los Milagros según el Espiritismo", "Obras Póstumas de Allan Kardec", "¿Qué es el Espiritismo? (Introducción de Kardec)", "Revista Espírita: Diario de Estudios Psicológicos",
            // Allan Kardec y Figuras Relevantes
            "Biografía de Allan Kardec (Hippolyte Léon Denizard Rivail)", "El Proceso de Codificación Espírita", "Misión de Allan Kardec", "Léon Denis: El Consolidador", "Principales Obras de Léon Denis", "Gabriel Delanne: El Científico Espírita", "Investigaciones de Gabriel Delanne", "Camille Flammarion y el Espiritismo", "Chico Xavier: Mediumnidad y Filantropía", "Obras Psicografiadas por Chico Xavier", "André Luiz (Espíritu) y la Vida en el Mundo Espiritual", "Emmanuel (Espíritu Guía de Chico Xavier)", "Divaldo Pereira Franco: Mediumnidad y Oratoria", "Joanna de Ângelis (Espíritu Guía de Divaldo Franco)", "Amalia Domingo Soler (España)", "Otros Pioneros del Espiritismo (Europa y América)",
            // Mediumnidad
            "Definición de Mediumnidad", "Médium: El Intermediario", "Clasificación General de los Médiums", "Mediumnidad de Efectos Físicos (Tiptología, Transportes)", "Mediumnidad de Efectos Intelectuales", "Psicografía (Escritura Automática): Tipos", "Psicofonía (Hablada)", "Videncia y Audiencia Mediúmnica", "Mediumnidad Curativa", "Mediumnidad de Incorporación (Psicofonía Consciente/Inconsciente)", "Mediumnidad Intuitiva", "Mediumnidad Inspirada", "Desarrollo y Educación de la Mediumnidad", "El Papel del Médium en la Sociedad", "Peligros y Obstáculos en la Práctica Mediúmnica", "Identidad de los Espíritus Comunicantes", "Lenguaje y Estilo de los Espíritus", "Evocaciones de Espíritus: ¿Es lícito?", "Reuniones Mediúmnicas Serias: Objetivos y Organización", "Fraude y Animismo en la Mediumnidad",
            // Vida Espiritual y Transición
            "La Muerte Física: Desprendimiento del Espíritu", "El Proceso de la Desencarnación", "Perturbación Espiritual Post-Mortem", "Erraticidad: Estado del Espíritu entre Encarnaciones", "Mundos Transitorios", "Colonias Espirituales / Ciudades Astrales (ej. Nosso Lar)", "Actividades y Aprendizaje en el Mundo Espiritual", "Recuerdos de Vidas Pasadas", "Preparación para una Nueva Encarnación", "Elección de Pruebas y Expiaciones", "Lazos Familiares y Espirituales", "Ángeles Guardianes y Espíritus Protectores", "Juicio Divino vs. Conciencia Propia", "Suicidio y sus Consecuencias Espirituales", "Aborto desde la Perspectiva Espírita",
            // Obsesión Espiritual
            "¿Qué es la Obsesión Espiritual?", "Causas de la Obsesión", "Tipos de Obsesión: Simple, Fascinación, Subyugación", "Obsesión Colectiva", "Auto-Obsesión", "Diagnóstico de la Obsesión", "Tratamiento de la Obsesión: Desobsesión", "El Papel del Diálogo con el Espíritu Obsesor", "La Reforma Íntima del Obsedido", "Fluidoterapia (Pases) en la Desobsesión", "Importancia de la Oración y la Vigilancia", "Vampirismo Espiritual",
            // Prácticas Espíritas
            "El Centro Espírita: Funciones y Estructura", "Estudio Sistematizado de la Doctrina Espírita (ESDE)", "Reuniones Públicas Doctrinales", "Pases Espíritas (Magnetismo/Fluidoterapia)", "Agua Fluidificada", "Atención Fraterna por el Diálogo", "Trabajos de Caridad Material y Espiritual", "Evangelización Espírita Infanto-Juvenil", "Reuniones de Desobsesión (Privadas)", "Vibraciones a Distancia", "El Evangelio en el Hogar", "La Reforma Íntima como Práctica Fundamental",
            // Temas Filosóficos y Morales
            "Fé Razonada", "Consolador Prometido por Jesús", "Esperanza y Consolación ante el Dolor", "Humildad y Orgullo", "Egoísmo: La Chaga de la Humanidad", "Perdón de las Ofensas", "Paciencia y Resignación", "El Bien y el Mal: Origen y Naturaleza", "Justicia de las Aflicciones", "Progreso de la Humanidad", "Ley del Trabajo", "Ley de Sociedad", "Ley de Destrucción vs. Conservación", "Ley de Igualdad", "Ley de Libertad", "Relación entre Espiritismo y otras Religiones/Filosofías", "Ética Espírita en la Vida Diaria", "Valor de la Vida Material", "Desapego de los Bienes Terrenales",
            // Aspectos Científicos y Fenoménicos
            "Espiritismo y Ciencia: Diálogo Posible", "Investigación de Fenómenos Mediúmnicos", "Materializaciones de Espíritus", "Fotografía Trascendental (¿Realidad o Fraude?)", "Transcomunicación Instrumental (TCI)", "Magnetismo Animal y Espiritual", "Sonambulismo y Éxtasis", "Doble Vista (Segunda Vista)", "Curaciones Espirituales: Mecanismos", "Fluidos y su Manipulación", "Naturaleza del Periespíritu y sus Propiedades", "Críticas Científicas al Espiritismo", "Respuesta Espírita a las Críticas",
             // Temas Complementarios y Preguntas
            "Diferencia entre Espiritismo y Espiritualismo", "Diferencia entre Espiritismo y Umbanda/Candomblé", "¿El Espiritismo es una Religión?", "El Espiritismo ante el Sufrimiento Animal", "Visiones del Futuro y Profecías", "Reencarnación en Animales (Visión Espírita)", "Alma de los Animales", "Uso de Amuletos o Rituales en el Espiritismo", "Espiritismo y Política", "Homosexualidad y Espiritismo", "Salud Mental y Espiritismo", "¿Cómo iniciarse en el estudio del Espiritismo?", "Importancia de la lectura de las Obras Básicas", "¿Existen 'castigos' divinos?", "Concepto de 'Pruebas' y 'Expiaciones'", "¿Qué son las 'Moradas' en la casa del Padre?", "Comunicación con entes queridos desencarnados: ¿Cómo y cuándo?", "El papel de la música en el ambiente espírita", "Arte y Espiritismo", "Ciencia Ficción vs. Realidad Espiritual", "¿Qué dice el Espiritismo sobre OVNIs/Extraterrestres?",
             // ... (Continuar generando temas específicos y preguntas)
        ];
        const spiritismThemes = [
            "principios básicos del espiritismo", "reencarnación", "mediumnidad", "ley de causa y efecto", "mundo espiritual",
            "Allan Kardec", "obras de la codificación", "El Libro de los Espíritus", "El Evangelio según el Espiritismo",
            "vida después de la muerte", "obsesión espiritual", "desobsesión", "centro espírita", "pases magnéticos",
            "caridad", "reforma íntima", "periespíritu", "fluidos", "pluralidad de mundos habitados", "escala espírita",
            "Chico Xavier", "André Luiz", "filosofía espírita", "ciencia espírita", "moral espírita", "libre albedrío"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un estudioso profundo y respetuoso del Espiritismo Kardecista, con amplio conocimiento de la Codificación realizada por Allan Kardec y sus desarrollos posteriores consistentes. Tu tarea es explicar el tema, concepto, figura o libro espírita indicado de manera clara, detallada y didáctica. Basa tu explicación estrictamente en los principios de la Doctrina Espírita. Aborda la definición, contexto, importancia doctrinal, implicaciones morales y filosóficas, y relación con otros conceptos espíritas. Evita sincretismos o interpretaciones ajenas a Kardec. Usa un lenguaje formal pero accesible. El objetivo es una exposición completa de aproximadamente 1200-1300 palabras.",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un facilitador de un grupo de estudio espírita, dialogando sobre el tema específico que se está presentando. Responde preguntas adicionales basadas exclusivamente en la Doctrina Espírita (Codificación Kardecista). Sé claro, conciso, respetuoso y fomenta la reflexión. No emitas opiniones personales fuera de la doctrina.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de temas para un estudio profundo del Espiritismo Kardecista. Genera exactamente 40 temas concisos (conceptos clave, preguntas doctrinales, figuras importantes, libros de la Codificación, prácticas espíritas). Devuelve *solo* la lista de temas/preguntas, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo para generar 40
        };

        // ========== Mini-Game State & Config ==========
        let gameLoopId = null;
        let understandingPoints = 0;
        let upPerSecond = 0;
        let upPerClick = 1;
        let lastTick = Date.now();
        const gameAids = {
            study: { baseCost: 10, costMultiplier: 1.15, rate: 0.1, level: 0, btnId: 'upgrade-study' },
            meditation: { baseCost: 100, costMultiplier: 1.20, rate: 1, level: 0, btnId: 'upgrade-meditation' },
            intuition: { baseCost: 1000, costMultiplier: 1.25, rate: 8, level: 0, btnId: 'upgrade-intuition' },
             charity: { baseCost: 15, costMultiplier: 1.8, rate: 1, level: 0, btnId: 'upgrade-charity' } // rate es UP adicional por clic
        };
        const enlightenmentLevels = [
            { threshold: 0, name: "Básico" },
            { threshold: 100, name: "Aprendiz" },
            { threshold: 500, name: "Interesado" },
            { threshold: 2500, name: "Estudiante" },
            { threshold: 10000, name: "Reflexivo" },
            { threshold: 50000, name: "Consolidado" },
             { threshold: 200000, name: "Fraterno" },
             { threshold: 1000000, name: "Iluminado" }
        ];
        let currentEnlightenmentLevel = enlightenmentLevels[0].name;

        // ========== DOM ELEMENTS ==========
        // (Previous elements + Minigame elements)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Now the container for game/message
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const gameContainer = document.getElementById('minigame-container');
        const gameClickButton = document.getElementById('game-click-button');
        const gameUpDisplay = document.getElementById('game-up-display');
        const gameUpsDisplay = document.getElementById('game-ups-display');
        const gameLevelDisplay = document.getElementById('game-level-display');
        const gameUpgradeButtons = {
            study: document.getElementById('upgrade-study'),
            meditation: document.getElementById('upgrade-meditation'),
            intuition: document.getElementById('upgrade-intuition'),
             charity: document.getElementById('upgrade-charity')
        };

        // ========== State Variables ==========
        let currentTopicTitle = null; // For chat context

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Actúa como un facilitador de un grupo de estudio espírita, dialogando sobre el tema específico '${currentTopicTitle}'. Responde preguntas adicionales basadas exclusivamente en la Doctrina Espírita (Codificación Kardecista). Sé claro, conciso, respetuoso y fomenta la reflexión. No emitas opiniones personales fuera de la doctrina.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores pueden estar experimentando alto tráfico. Por favor, inténtalo de nuevo en unos momentos.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la IA llegó vacía. Intenta reformular.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(topicTitle) { return fetchTextFromApi(topicTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Error interno: Contexto del tema no establecido para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(spiritismThemes) || "conceptos espíritas generales";
             // *** Pedir 40 títulos ***
             const specificPrompt = `Genera 40 temas o preguntas sobre ${randomTheme} para estudio espírita`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     // Asegurarse de que no falle si vienen menos de 40
                     if (titles.length < 10) throw new Error("La IA no generó suficientes temas de estudio.");
                     return titles.slice(0, 40); // Devolver hasta 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 700, height: 500, nologo: true }; // Ajustar tamaño si se quiere
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Concepto Espiritista Abstracto";
            const enhancedPrompt = `Abstract, symbolic artwork representing the Spiritist concept of '${safePromptText}'. Use serene colors (soft blues, purples, white, gold light). Focus on light, energy, connection, spiritual evolution, books, ethereal atmosphere. Avoid literal depictions of ghosts, specific people or religious iconography. Thoughtful, respectful, symbolic.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, graphs, charts, diagrams, map, flag, realistic human figures, faces, detailed bodies, church, cross, religious symbols, dark, scary, horror, intricate details, photorealistic";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            stopGame(); // Asegurarse de parar el juego al cerrar
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.classList.remove('active'); // Ocultar área de carga/juego
             modalStoryContentArea.classList.add('content-hidden'); // Ocultar contenido principal
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
             // Reset Game State Variables
             understandingPoints = 0;
             upPerSecond = 0;
             upPerClick = 1;
             currentEnlightenmentLevel = enlightenmentLevels[0].name;
             for (const key in gameAids) {
                 gameAids[key].level = 0;
             }
             updateGameUI(); // Poner la UI del juego a 0 por si acaso
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() { /* ... */
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... */
             const msgDiv = document.createElement('div');
             msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
             message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
             msgDiv.innerHTML = message;
             chatHistory.appendChild(msgDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... */
            const errorDiv = document.createElement('div');
            errorDiv.classList.add('chat-error');
            errorDiv.textContent = message;
            chatHistory.appendChild(errorDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== Mini-Game Functions ==========
        function calculateCost(aidKey) {
            const aid = gameAids[aidKey];
            return Math.ceil(aid.baseCost * Math.pow(aid.costMultiplier, aid.level));
        }

        function updateGameUI() {
            gameUpDisplay.textContent = Math.floor(understandingPoints).toLocaleString();
            gameUpsDisplay.textContent = `${upPerSecond.toFixed(1)} por segundo`;
            gameLevelDisplay.textContent = `Nivel de Estudio: ${currentEnlightenmentLevel}`;

            for (const key in gameAids) {
                const aid = gameAids[key];
                const btn = gameUpgradeButtons[key];
                const cost = calculateCost(key);
                const levelText = btn.querySelector('.upgrade-level');
                const costText = btn.querySelector('.upgrade-cost');

                if (levelText) levelText.textContent = `(Nivel ${aid.level})`;
                if (costText) costText.textContent = `Costo: ${cost.toLocaleString()}`;
                btn.disabled = understandingPoints < cost;
            }
        }

        function checkEnlightenmentLevel() {
            let newLevel = enlightenmentLevels[0].name;
            for (let i = enlightenmentLevels.length - 1; i >= 0; i--) {
                if (understandingPoints >= enlightenmentLevels[i].threshold) {
                    newLevel = enlightenmentLevels[i].name;
                    break;
                }
            }
            currentEnlightenmentLevel = newLevel;
        }

        function gameLoop() {
            if (!gameLoopId) return; // Stop if ID is nullified

            const now = Date.now();
            const delta = (now - lastTick) / 1000; // Time difference in seconds
            lastTick = now;

            understandingPoints += upPerSecond * delta;
             checkEnlightenmentLevel();
            updateGameUI();

            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function startGame() {
            console.log("Starting minigame...");
            resetGameVariables(); // Ensure game starts fresh
            modalLoadingIndicator.classList.add('active'); // Show the loading area
            lastTick = Date.now();
            if (!gameLoopId) { // Prevent multiple loops
                 gameLoopId = requestAnimationFrame(gameLoop);
            }
        }

        function stopGame() {
            console.log("Stopping minigame...");
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
                gameLoopId = null;
            }
             // Don't hide modalLoadingIndicator here, handleTitleClick manages its visibility
        }

         function resetGameVariables() {
             understandingPoints = 0;
             upPerSecond = 0;
             upPerClick = 1;
             currentEnlightenmentLevel = enlightenmentLevels[0].name;
             for (const key in gameAids) {
                 gameAids[key].level = 0;
                 // Recalculate initial cost in case base cost changes (though it doesn't here)
                 const btn = gameUpgradeButtons[key];
                 const cost = calculateCost(key);
                 if(btn) {
                     btn.dataset.cost = cost;
                     const costText = btn.querySelector('.upgrade-cost');
                     if (costText) costText.textContent = `Costo: ${cost.toLocaleString()}`;
                      const levelText = btn.querySelector('.upgrade-level');
                      if (levelText) levelText.textContent = `(Nivel 0)`;
                 }
             }
             updateGameUI();
         }


        function handleGameClick() {
            understandingPoints += upPerClick;
            updateGameUI(); // Update immediately after click
        }

        function handleUpgrade(aidKey) {
            const aid = gameAids[aidKey];
            const cost = calculateCost(aidKey);

            if (understandingPoints >= cost) {
                understandingPoints -= cost;
                aid.level++;
                if (aidKey === 'charity') { // Charity increases click power
                     upPerClick += aid.rate;
                 } else { // Others increase UP/sec
                     upPerSecond += aid.rate;
                 }

                // Update button dataset cost for next calculation (optional, but good practice)
                 gameUpgradeButtons[aidKey].dataset.cost = calculateCost(aidKey);

                updateGameUI();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Sort alphabetically for consistency
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">No hay temas disponibles en el índice.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Appended ${addedCount} new unique titles.`);
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick to integrate minigame start/stop ***
        async function handleTitleClick(title) {
            resetModalState(); // Reset everything first
            showModal(); // Show the modal frame
            currentTopicTitle = title; // Set chat context *early*
            modalTitle.textContent = title; // Set title *before* loading

            // *** START LOADING & GAME ***
            startGame();

            try {
                // Fetch explanation in parallel (potentially) - although JS is single-threaded, the fetch is async
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                 // *** STOP GAME, HIDE LOADING, SHOW CONTENT ***
                 stopGame();
                 modalLoadingIndicator.classList.remove('active'); // Hide loading/game area
                 modalContent.innerHTML = formattedExplanation;
                 modalStoryContentArea.classList.remove('content-hidden'); // Show text + chat area
                 modalTextArea.scrollTop = 0; // Reset scroll AFTER content is visible

                // Prepare and add image placeholder (same logic as before)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-feather-alt placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Generando imagen simbólica...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación simbólica de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { console.error("Err img:", title); placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo cargar la imagen.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { console.error("No URL for:", title); placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`; }

            } catch (error) {
                 // *** STOP GAME ON ERROR, SHOW ERROR MESSAGE ***
                 stopGame();
                 modalLoadingIndicator.classList.remove('active'); // Hide loading/game
                 console.error("Failed display:", error);
                 modalErrorMessage.textContent = error.message || "Error desconocido al cargar el contenido.";
                 modalError.classList.remove('content-hidden');
                 modalStoryContentArea.classList.remove('content-hidden'); // Show the area so error is visible
                 modalContent.innerHTML = ''; // Clear any partial content
                 chatSection.style.display = 'none'; // Hide chat on main error
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más temas...';
             try {
                 // *** Fetch 40 titles ***
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más temas en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar temas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // *** Update button text to reflect 40 ***
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Temas (40)';
             }
         }

         // *** Search Filter Function (with accent normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Show if no results OR if list is empty initially
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Verify all essential elements exist
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !gameClickButton || !Object.values(gameUpgradeButtons).every(Boolean)) {
                console.error("Initialization failed: Missing essential UI elements (including game elements).");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Faltan componentes esenciales de la interfaz.</p>';
                return;
             }

            // Standard Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Mini-Game Listeners
            gameClickButton.addEventListener('click', handleGameClick);
            for (const key in gameUpgradeButtons) {
                gameUpgradeButtons[key].addEventListener('click', () => handleUpgrade(key));
            }

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
             updateGameUI(); // Initialize game UI text/costs
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>