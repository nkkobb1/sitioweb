<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estructuras Asombrosas de la Humanidad</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes: Una serif elegante para títulos, una sans-serif limpia para cuerpo -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Estructuras Asombrosas --- */
        :root {
            --color-primary: #2c3e50; /* Azul Pizarra Oscuro (Solidez, Elegancia) */
            --color-secondary: #c19a6b; /* Arenisca / Dorado Pálido (Historia, Piedra) */
            --color-tertiary: #3498db; /* Azul Cielo Claro (Aspiración, Ingeniería) */
            --color-background: #ecf0f1; /* Gris Muy Claro (Neutralidad) */
            --color-text: #34495e; /* Gris Azulado Oscuro */
            --color-text-muted: #7f8c8d; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco */
            --color-border: #bdc3c7; /* Gris Claro */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
            --border-radius: 5px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 1px 1px 1px rgba(0,0,0,0.1); }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-secondary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700;}
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; box-shadow: var(--shadow-sm); transition: var(--transition-normal); background-color: #fff; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 700; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Merriweather', serif; font-size: 1rem; }
        .title-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f8f9f9; }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1f2b38; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #95a5a6; color: #ecf0f1; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(44, 62, 80, 0.9); /* Overlay más oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 2.5rem 3rem; /* Más padding */
            max-width: 950px; /* Más ancho */
            width: 95%;
            max-height: 90vh;
            min-height: 350px; /* Altura mínima */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: #ecf0f1; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.8rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.35; }
        #modal-content {
            line-height: 1.8;
            color: var(--color-text);
            white-space: normal;
            overflow-y: auto;
            padding: 0 15px 2rem 15px; /* Padding inferior para espacio post-imagen */
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content::-webkit-scrollbar { width: 9px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; font-weight: bold;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: bold; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos para imagen y placeholder dentro del contenido */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 1rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; margin-bottom: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid #bdc3c7; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-primary); font-size: 1.3rem; font-family: 'Lato'; font-style: italic; } /* LOADING PHRASE */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fbeae5; color: #c0392b; /* Rojo error suave */ padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #e74c3c; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
        .title-item.hidden { display: none; } /* Para ocultar con buscador */
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-landmark mr-3 text-blue-500"></i> <!-- Icono monumento -->
                     Maravillas Construidas
                 </h1>
             </div>
             <span class="text-sm text-gray-700">Un Viaje por la Ingeniería y Arquitectura Humana</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-10 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Estructuras Asombrosas de la Humanidad</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto">Desde antiguas pirámides hasta modernos rascacielos, explora las obras maestras de la ingeniería y el diseño que definen nuestra civilización.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-8 max-w-2xl mx-auto">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Buscar estructura, lugar o concepto...">
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-gavel text-yellow-600 mr-2"></i> <!-- Icono martillo/herramienta -->
                 Explora las Grandes Obras
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Catalogando maravillas...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden">No se encontraron estructuras para tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Estructuras
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p id="loading-phrase">Consultando archivos históricos...</p> <!-- Placeholder inicial -->
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - La imagen se añadirá aquí al final -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                     <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-700 py-6 mt-12 border-t border-gray-300">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Descripciones generadas por IA con fines educativos e informativos sobre arquitectura e ingeniería.</p>
              <p class="mt-1">Admira el ingenio humano a través de sus construcciones.</p>
              <p class="mt-2">© 2025 Maravillas Construidas</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
             // Antigüedad Clásica y Preclásica
            "Las Grandes Pirámides de Giza (Keops, Kefrén, Micerinos)", "¿Cómo se construyó la Gran Pirámide de Giza?", "La Esfinge de Giza: Guardián del Nilo", "Stonehenge: Círculo de misterio megalítico", "Göbekli Tepe: El templo más antiguo del mundo", "El Partenón de Atenas: Perfección clásica griega", "El Erecteion y las Cariátides", "El Coliseo Romano: Arena de gladiadores", "El Panteón de Roma: Cúpula maestra de la ingeniería", "Acueductos Romanos: Llevando agua a las ciudades", "El Foro Romano: Corazón de un imperio", "Termas Romanas (Caracalla, Bath)", "El Muro de Adriano: Frontera del Imperio Romano", "Petra: Ciudad tallada en la roca", "Biblioteca de Celso en Éfeso", "Teatro de Epidauro: Acústica perfecta", "Templo de Karnak en Egipto", "Templo de Luxor", "Abu Simbel: Templos rescatados", "Zigurat de Ur: Escalera al cielo mesopotámica", "Persépolis: Capital del Imperio Persa", "El Caballo de Troya: ¿Mito o estructura real?", "Los Jardines Colgantes de Babilonia (¿Existieron?)", "El Faro de Alejandría", "El Coloso de Rodas", "Templo de Artemisa en Éfeso", "Estatua de Zeus en Olimpia", "Mausoleo de Halicarnaso", "Chichén Itzá: Pirámide de Kukulcán (El Castillo)", "Teotihuacán: Pirámides del Sol y la Luna", "Palenque: Templo de las Inscripciones", "Tikal: Corazón de la civilización Maya", "Líneas de Nazca: Geoglifos gigantes en Perú", "Machu Picchu: Ciudad perdida de los Incas", "Sacsayhuamán: Fortaleza Inca de piedras colosales", "Moáis de la Isla de Pascua", "Cuevas de Ajanta y Ellora (India)", "Estupas Budistas (Sanchi, Borobudur)", "Templo de Borobudur: Mandala cósmico", "Templo de Prambanan (Indonesia)", "Guerreros de Terracota de Xi'an", "La Gran Muralla China: ¿Se ve desde el espacio?", "Construcción y propósito de la Gran Muralla China",
            // Edad Media y Renacimiento
            "Santa Sofía (Hagia Sophia): De basílica a mezquita y museo", "La Mezquita de Córdoba: Bosque de arcos", "La Alhambra de Granada: Palacio Nazarí", "Mont Saint-Michel: Abadía en una isla", "Catedral de Notre Dame de París: Gótico francés", "Catedral de Chartres: Vidrieras maestras", "Catedral de Colonia: Agujas hacia el cielo", "Catedral de Canterbury", "Catedral de Milán (Duomo)", "Catedral de Florencia (Santa Maria del Fiore): Cúpula de Brunelleschi", "Basílica de San Pedro en el Vaticano: Corazón del catolicismo", "Capilla Sixtina: Frescos de Miguel Ángel (Arquitectura + Arte)", "El Kremlin de Moscú: Fortaleza histórica", "Catedral de San Basilio en Moscú: Cúpulas de colores", "Puente de Carlos en Praga", "Torre de Pisa: Inclinación icónica", "Castillo de Neuschwanstein: Fantasía bávara", "Castillo de Edimburgo", "Torre de Londres: Historia y leyendas", "Castillo de Himeji (Japón): Garza blanca", "Angkor Wat: El templo más grande del mundo", "Ciudad Prohibida de Beijing", "Templo del Cielo en Beijing", "Palacio de Potala en Lhasa, Tíbet", "Mezquita Azul de Estambul", "Mezquita del Viernes (Masjid-e Jameh) de Isfahán", "Puente Viejo de Mostar (Stari Most)", "Castillos Cátaros (Francia)", "Krak des Chevaliers (Siria): Castillo cruzado", "Ciudadela de Alepo", "Gran Mezquita de Djenné (Malí): Arquitectura de barro",
            // Edad Moderna y Contemporánea (Hasta ~1950)
            "Palacio de Versalles: Opulencia barroca", "Palacio de Schönbrunn (Viena)", "Palacio de Invierno (San Petersburgo)", "Taj Mahal: Mausoleo de amor en mármol", "Fuerte Rojo de Agra", "Fuerte Amber (India)", "Ópera Garnier de París", "Palacio de Westminster y Big Ben (Londres)", "Parlamento de Budapest", "Puente de Brooklyn: Icono de Nueva York", "Estatua de la Libertad: Regalo de amistad", "Torre Eiffel: Símbolo de París", "Crystal Palace (Londres): Exposición Universal", "Canal de Suez: Atajo entre mares", "Canal de Panamá: Ingeniería monumental", "Edificio Empire State: Rascacielos legendario", "Edificio Chrysler: Art Déco en altura", "Rockefeller Center", "Puente Golden Gate: Naranja sobre la bahía", "Presa Hoover: Domando el río Colorado", "Monte Rushmore: Rostros en la montaña", "Cristo Redentor de Río de Janeiro", "Sagrada Familia de Gaudí (Barcelona): Obra inacabada", "Parque Güell de Gaudí", "Casa Batlló y Casa Milà (La Pedrera) de Gaudí", "Fallingwater (Casa de la Cascada) de Frank Lloyd Wright", "Museo Guggenheim de Nueva York (Wright)", "Villa Savoye de Le Corbusier", "Pabellón de Barcelona (Mies van der Rohe)", "Escuela Bauhaus (Dessau)", "Atomium de Bruselas",
            // Estructuras Contemporáneas (Post ~1950) y Conceptos
            "Ópera de Sídney: Velas sobre el puerto", "Centro Pompidou (París): Arquitectura invertida", "Museo Guggenheim de Bilbao (Gehry)", "Walt Disney Concert Hall (Gehry)", "Burj Khalifa: El edificio más alto del mundo", "Torres Petronas (Kuala Lumpur)", "Taipei 101", "One World Trade Center (Nueva York)", "The Shard (Londres)", "Marina Bay Sands (Singapur): Piscina infinita", "Estadio Nacional de Beijing (Nido de Pájaro)", "Centro Acuático Nacional de Beijing (Cubo de Agua)", "Millau Viaduct (Francia): Puente atirantado elegante", "Puente Akashi Kaikyō (Japón): El colgante más largo", "Eurotúnel (Canal de la Mancha)", "Presa de las Tres Gargantas (China): La más grande del mundo", "Presa de Itaipú (Brasil/Paraguay)", "Palm Jumeirah (Dubái): Isla artificial", "The World Islands (Dubái)", "CERN - Gran Colisionador de Hadrones (Suiza/Francia): Ciencia subterránea", "Estación Espacial Internacional (ISS): Hogar en órbita", "Telescopio Espacial Hubble (Aunque en órbita, una 'estructura')", "Radiotelescopio de Arecibo (Antes de colapso)", "FAST (Radiotelescopio Esférico de Quinientos Metros Apertura - China)", "Svalbard Global Seed Vault (Bóveda Global de Semillas)", "Iglesia de la Luz (Tadao Ando)", "Capilla de Ronchamp (Le Corbusier)", "Turning Torso (Malmö, Calatrava)", "Ciudad de las Artes y las Ciencias (Valencia, Calatrava)", "Aeropuerto Internacional de Denver (Techos tensados)", "Aeropuerto de Kansai (Osaka, Isla artificial)", "Kingdom Centre (Riad): El 'abrebotellas'", "Biblioteca de Alejandría (Moderna)", "Museo del Louvre y su Pirámide", "Tate Modern (Londres): Central eléctrica renacida", "Jewish Museum Berlin (Libeskind)", "MAXXI Museum (Roma, Zaha Hadid)", "Heydar Aliyev Center (Bakú, Zaha Hadid)", "The Vessel (Hudson Yards, Nueva York)", "Gardens by the Bay (Singapur): Superárboles", "Eden Project (Cornwall): Biomas geodésicos",
            // Conceptos y Tipos de Estructuras
            "¿Qué es una Cúpula Geodésica?", "Principios de la Arquitectura Gótica", "El Orden Dórico, Jónico y Corintio en Grecia", "Anfiteatros Romanos vs Teatros Griegos", "Ingeniería de los Puentes Colgantes", "Ingeniería de los Puentes Atirantados", "Construcción de Rascacielos: Retos y técnicas", "Arquitectura Brutalista: Estética del hormigón", "Arquitectura Deconstructivista", "Arquitectura Biomimética: Inspiración en la naturaleza", "Estructuras Tensadas y Membranas Textiles", "Construcción con Tierra Apisonada (Tapial)", "Adobe y Arquitectura Vernácula", "Castillos Medievales: Diseño defensivo", "Fortalezas Estrelladas (Vauban)", "Minaretes Islámicos: Llamada a la oración", "Pagodas Asiáticas: Torres de templos", "Dolmenes y Menhires: Construcciones megalíticas", "Acueductos: Legado romano y más allá", "Faros: Guías en la costa", "Presas: Control del agua y energía", "Túneles: Cruzando montañas y mares", "Estadios Deportivos: Diseño para multitudes", "Aeropuertos Modernos: Puertas al mundo", "Estaciones de Tren: Catedrales del viaje", "Bibliotecas: Templos del saber", "Museos: Contenedores de arte y cultura", "Rascacielos Verdes y Sostenibilidad", "Ciudades Subterráneas", "Hábitats Espaciales: ¿El futuro?"
        ];
        const structureThemes = [
            "antiguas maravillas", "arquitectura romana", "arquitectura griega", "arquitectura gótica", "castillos medievales",
            "rascacielos icónicos", "puentes famosos", "presas monumentales", "templos asiáticos", "arquitectura islámica",
            "pirámides del mundo", "arquitectura moderna", "arquitectura contemporánea", "ingeniería civil extrema",
            "estructuras megalíticas", "arquitectura renacentista", "arquitectura barroca", "arquitectura de Gaudí",
            "obras de Frank Lloyd Wright", "arquitectura brutalista", "ciudades perdidas", "islas artificiales",
            "estaciones espaciales y telescopios", "museos con arquitectura destacada", "estadios olímpicos"
        ];
        const loadingPhrases = [ // Frases temáticas de carga
            "Consultando planos antiguos...", "Excavando datos históricos...", "Levantando los andamios de la información...",
            "Midiendo la magnitud de la obra...", "Calculando esfuerzos estructurales...", "Descifrando jeroglíficos arquitectónicos...",
            "Pulido los detalles finales...", "Consultando a los maestros constructores...", "Colocando la piedra angular del conocimiento...",
            "Trazando las líneas maestras...", "Desenterrando secretos constructivos...", "Montando el rompecabezas histórico...",
            "Ajustando la plomada de la precisión...", "Admirando la escala del proyecto...", "Revisando los cimientos de la información..."
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un apasionado historiador de la arquitectura y la ingeniería civil, un narrador entusiasta de las grandes obras de la humanidad. Tu tarea es describir y analizar la estructura o concepto arquitectónico/ingenieril indicado. Explica su contexto histórico, propósito original, estilo arquitectónico, innovaciones o desafíos de ingeniería, materiales empleados, significado cultural o simbólico, estado actual y (si aplica) experiencia para el visitante. Usa un lenguaje evocador pero preciso, destacando lo que hace 'asombrosa' a la estructura. El objetivo es un ensayo detallado y cautivador de aproximadamente 1200-1300 palabras. Basa tu análisis únicamente en la siguiente estructura o concepto:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia de grandes construcciones. Genera exactamente 15 nombres de estructuras famosas (antiguas, modernas, etc.), lugares arquitectónicos icónicos o conceptos de ingeniería/arquitectura relevantes. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalLoadingPhrase = document.getElementById('loading-phrase'); // Para texto de carga
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Contenedor texto e imagen
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ========== (Sin cambios funcionales)
        async function fetchTextFromApi(prompt, config) { /* ... */
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo.`);
                 throw new Error(`Error de comunicación con la API: ${error.message}`);
             }
        }
        async function fetchExplanationText(conceptTitle) { /* ... */
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
               if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de")) {
                    throw new Error("La IA no pudo generar una descripción adecuada o suficientemente detallada para esta estructura/concepto.");
                }
              return text;
        }
        async function fetchGeneratedTitles() { /* ... */
             const randomTheme = getRandomElement(structureThemes) || "estructuras icónicas del mundo";
             const specificPrompt = `Genera 15 ítems (estructuras, conceptos) sobre ${randomTheme}`;
             console.log("Generating titles with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a Estructuras
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Architectural wonder concept art";
            // Prompt ENFOCADO en concepto/atmósfera, NO texto, NO diagramas.
            const enhancedPrompt = `Concept art, atmospheric, dramatic lighting, architectural study inspired by '${safePromptText}'. Focus on form, scale, material texture, or historical context. Avoid text, labels, technical diagrams, people. Artistic interpretation.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, graphs, charts, diagrams, blueprint, schematic, map, flag, people, crowds, tourists, photograph, photorealistic, ugly, deformed, blurry, low quality, watermark, signature, multiple images, collage";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); // Keep just in case
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, ' '); // Reemplaza saltos internos con espacio para formar párrafos
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Sin cambios funcionales)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalLoadingPhrase) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = ''; // Limpia texto e imagen
             modalErrorMessage.textContent = '';
             modalLoadingPhrase.textContent = getRandomElement(loadingPhrases) || 'Cargando...'; // Resetea con frase random
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar podría ser bueno, pero quizás barajar da sensación de descubrimiento
             // const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             const shuffledTitles = shuffleArray([...titles]); // Barajar para variedad
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay estructuras catalogadas.</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             const shuffledNewTitles = shuffleArray([...newTitles]); // Barajar los nuevos también
             shuffledNewTitles.forEach(title => {
                 if (!existingTitles.has(title)) {
                     titleListContainer.appendChild(createTitleItem(title));
                 }
             });
             filterTitles(searchInput.value); // Re-aplicar filtro
         }

        // *** MODIFIED: handleTitleClick con frase de carga ***
        async function handleTitleClick(title) {
            resetModalState(); // Esto ya pone una frase random inicial
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            // Seleccionar y mostrar una frase de carga ANTES de la llamada a la API
            modalLoadingPhrase.textContent = getRandomElement(loadingPhrases) || 'Procesando solicitud...';
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation; // Poner texto
                modalStoryContentArea.classList.remove('content-hidden');

                modalContent.scrollTop = 0; // Resetear scroll DESPUÉS de contenido visible
                console.log("Scroll set to 0 after content visible");

                // Preparar y añadir placeholder de imagen DENTRO de modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-drafting-compass placeholder-icon"></i> <!-- Icono compás/diseño -->
                    <p style="font-size: 0.8em;">Generando visualización...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Crear y añadir elemento imagen
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Interpretación artística de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-eye-slash placeholder-icon"></i>
                        <p style="font-size: 0.8em;">No se pudo cargar la imagen.</p>
                    `;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Añadir img al final
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle placeholder-icon"></i>
                        <p style="font-size: 0.8em;">Error al generar URL de imagen.</p>
                    `;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             // Usar frase de carga también aquí
             const loadingText = getRandomElement(loadingPhrases) || 'Buscando más...';
             generateMoreBtn.innerHTML = `<i class="fas fa-sync-alt mr-2 animate-spin"></i> ${loadingText.substring(0, 20)}...`; // Acortar si es muy larga
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     appendTitles(newTitles);
                 } else {
                     alert("No se pudieron descubrir más estructuras en este momento.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al descubrir estructuras: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Estructuras';
             }
         }

         // *** Search Filter Function (sin cambios) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;

             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase();
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) {
                     visibleCount++;
                 }
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !modalLoadingPhrase) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #c0392b; font-size: 1.5em; text-align: center; padding-top: 3em;">Error catastrófico: ¡Los cimientos de la aplicación han fallado!</p>'; // Thematic Error
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            searchInput.addEventListener('input', (event) => { filterTitles(event.target.value); });

            displayTitles(predefinedTitles); // Carga inicial
            noResultsMsg.classList.add('hidden'); // Asegurar que no se muestre al inicio
            // Poner una frase de carga inicial en el modal (aunque esté oculto)
            modalLoadingPhrase.textContent = getRandomElement(loadingPhrases) || 'Preparando la expedición...';
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>