<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secretos del Ilusionismo - Nivel Medio</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Elegantes/Clásicas -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Ilusionismo --- */
        :root {
            --color-primary: #b91c1c; /* Rojo Oscuro (Telón) */
            --color-secondary: #f59e0b; /* Dorado/Ámbar (Prestigio) */
            --color-tertiary: #60a5fa; /* Azul Claro (Misterio/Magia) */
            --color-background: #1e293b; /* Azul/Gris Muy Oscuro */
            --color-text: #e5e7eb; /* Gris Claro */
            --color-text-muted: #9ca3af; /* Gris Medio */
            --color-modal-bg: #334155; /* Azul/Gris Oscuro Medio */
            --color-border: #4b5563; /* Borde Gris Oscuro */
            --color-error-bg: #450a0a; /* Fondo error rojo muy oscuro */
            --color-error-text: #fecaca; /* Texto error claro */
            --color-error-border: #ef4444; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.15), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.15);
            --border-radius: 4px;
            --transition-normal: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Transición suave */
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-secondary); text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        h1.page-title { color: var(--color-secondary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; }
        .navbar { background-color: rgba(30, 41, 59, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #374155; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-secondary); box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); outline: none; background-color: #4b5563; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-secondary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Lato'; font-size: 1rem; position: relative; overflow: hidden; }
        .title-item::before { /* Sutil efecto hover */ content: ''; position: absolute; bottom: 0; left: -100%; width: 100%; height: 3px; background: var(--color-secondary); transition: left 0.4s ease-out; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); border-color: var(--color-border); color: var(--color-secondary); background-color: #3e4f66; }
        .title-item:hover::before { left: 0; }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.4); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(30, 41, 59, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Más altura para chat y posible juego largo */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); box-shadow: 0 0 8px var(--color-primary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área Principal Modal (Contenido + Chat) */
        #modal-story-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; /* Contendrá Texto+Imagen y Chat */ }

        /* Área de Contenido (Texto + Imagen al final) - Scrollable */
        #modal-content-area { flex-grow: 1; min-height: 0; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(75, 85, 99, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(75, 85, 99, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 700; }
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; font-weight: 400; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 3rem auto 1.5rem auto; border: 2px solid var(--color-secondary); border-radius: var(--border-radius); box-shadow: 0 0 18px rgba(245, 158, 11, 0.3); cursor: pointer; transition: transform 0.25s ease, box-shadow 0.25s ease; }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: 0 0 25px rgba(245, 158, 11, 0.5); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { /* Reemplazado por juego, pero mantenemos estructura por si acaso */ display: none; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.8rem; }

        /* Chat Section Styles (sin cambios significativos) */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 230px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(30, 41, 59, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(75, 85, 99, 0.5); }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(75, 85, 99, 0.5); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem;}
        .user-message { background-color: var(--color-tertiary); color: #111827; margin-left: auto; text-align: right; font-weight: 400; }
        .ai-message { background-color: #4b5563; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #374155; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-secondary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; font-weight: bold;}
        #chat-send-btn:hover:not(:disabled) { background-color: #fca5a5; /* Rojo claro hover */ }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Screen with Mini-Game */
        #modal-loading {
            text-align: center; padding: 1.5rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--color-background); /* Fondo sólido para tapar contenido */
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start; /* Alinea arriba */
            z-index: 55; border-radius: var(--border-radius); overflow-y: auto; /* Permitir scroll si el juego es grande */
        }
        #memory-game-container { width: 100%; max-width: 600px; margin-top: 1rem;}
        #game-info { margin-bottom: 1rem; color: var(--color-secondary); font-family: 'Merriweather';}
        #game-level { font-size: 1.2em; font-weight: bold; }
        #game-status { font-size: 0.9em; color: var(--color-text-muted); margin-top: 0.3rem; }
        #memory-grid {
            display: grid; gap: 0.8rem; width: 100%; margin: 0 auto;
            /* Grid columns se definirá en JS según el nivel */
            perspective: 1000px; /* Para efecto 3D flip */
        }
        .memory-card {
            background-color: transparent; height: 0; padding-bottom: 100%; /* Aspect ratio 1:1 */
            border: 1px solid var(--color-secondary); border-radius: var(--border-radius);
            position: relative; cursor: pointer;
            transform-style: preserve-3d; transition: transform 0.5s; transform: scale(1);
        }
        .memory-card:active { transform: scale(0.97); transition: transform 0.2s; }
        .memory-card.flip { transform: rotateY(180deg); }
        .memory-card .front-face, .memory-card .back-face {
            position: absolute; top:0; left:0; width: 100%; height: 100%; padding: 10%; /* Padding para que icono no toque bordes */
            border-radius: var(--border-radius);
            backface-visibility: hidden; display: flex; align-items: center; justify-content: center;
        }
        .memory-card .front-face { background: var(--color-modal-bg); transform: rotateY(180deg); color: var(--color-text); font-size: 2.5rem; /* Tamaño iconos */ }
         /* Estilos específicos para iconos para asegurar tamaño consistente */
        .memory-card .front-face i { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .memory-card .back-face { background: linear-gradient(135deg, var(--color-primary), #881337); /* Rojo gradiente */ color: var(--color-secondary); font-size: 3rem; /* Icono dorso */ }
        .memory-card.matched { /* Efecto para cartas emparejadas */
            border-color: var(--color-tertiary); transform: scale(0.95); opacity: 0.7; cursor: default;
        }
        .memory-card.matched .front-face { color: var(--color-tertiary); }
        /* --- Fin estilos minijuego --- */

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay (sin cambios) */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(30, 41, 59, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-secondary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-hat-wizard mr-3 text-blue-400"></i> <!-- Icono Sombrero Mago -->
                     Secretos del Ilusionismo
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Guía Interactiva Nivel Medio «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Desvela los Misterios</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Explora una colección de trucos de ilusionismo de nivel intermedio. Aprende los métodos, la psicología y el arte detrás de la magia.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar truco, técnica o principio...">
             <i class="fas fa-search fa-wand-magic-sparkles"></i> <!-- Icono Varita/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-red-500 mr-2"></i> <!-- Icono Libro Abierto -->
                 Repertorio de Ilusiones
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Consultando los grimorios...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún secreto encontrado con esos términos «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar Más Secretos (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Mini-Game -->
             <div id="modal-loading">
                 <div id="memory-game-container">
                    <div id="game-info" class="text-center">
                        <div id="game-level">Nivel 1</div>
                        <div id="game-status">Encuentra las parejas mientras se prepara el secreto...</div>
                    </div>
                    <div id="memory-grid">
                        <!-- Las cartas del juego se generan aquí -->
                    </div>
                 </div>
             </div>

             <!-- Content Area Wrapper (Hidden initially) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al maestro...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este truco o técnica...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Ilustración Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Descripciones generadas por IA con fines educativos y de entretenimiento sobre ilusionismo.</p>
              <p class="mt-1">La práctica y la ética son esenciales. Usa estos conocimientos responsablemente.</p>
              <p class="mt-2">© MMXLII Academia Arcana</p> <!-- Año romano ;) -->
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Cartomagia Nivel Medio
            "Control de Carta Superior (Single Card Top Control)", "Control de Carta Inferior (Single Card Bottom Control)", "Mezcla Falsa por Arrastre (Overhand False Shuffle)", "Corte Falso Simple (Single False Cut)", "Forzaje Clásico (Classic Force - Introducción)", "Forzaje por Cruce (Cross-cut Force)", "Forzaje Hindú (Hindu Shuffle Force)", "Carta Guía (Key Card Placement/Use)", "La Carta Ambiciosa (Ambitious Card - Rutina Básica)", "Doble Volteo (Double Lift - Fundamentos)", "Triple Volteo (Triple Lift - Introducción)", "Empalme Superior (Top Palm - Single Card)", "Empalme Inferior (Bottom Palm - Single Card)", "Cambio de Color Clásico (Classic Color Change)", "Cambio de Color Erdnase (Erdnase Color Change - Simplificado)", "Sandwich de Cartas Simple (Basic Sandwich Effect)", "Carta a través de la Mesa (Card Through Table - Método Simple)", "Triunfo (Triumph - Método Básico)", "Out of This World (Simplificado)", "Predicción con Carta Marcada (Subtle Marked Deck Use)", "Rutina de 'Haz lo que yo hago' (Do As I Do - Basic)", "Carta Volteada Secretamente (Secret Reversal)", "Floritura: Abanico a una Mano (One-Handed Fan)", "Floritura: Extensión en Cinta (Ribbon Spread & Turnover)", "Floritura: Corte Charlier (Charlier Cut)", "Floritura: Corte Giratorio (Revolution Cut - Basic)", "Principio de la Carta Clave Múltiple", "Uso del 'Cull' Básico (Basic Culling)", "Manejo de Cartas Duplicadas (Simple Duplicate Uses)", "Carta al Número (Card at Any Number - Non-sleight methods)", "Control de Paquetes Pequeños (Packet Control Basics)", "Pico de Viuda (Peek Technique - Basic)", "Aparición de Cuatro Ases (Simple Four Ace Production)", "Viaje de Cartas Firmadas (Signed Card Transposition - Basic)", "Carta Rota y Recompuesta (Torn and Restored Card - Simple Methods)", "Predicción en Sobre Sellado (Sealed Envelope Prediction - Basic)", "Lectura de Pensamiento con Baraja Mnemónica Simple (Simple Stack Mind Reading)",
            // Numismagia (Monedas) Nivel Medio
            "Empalme Clásico (Classic Palm - Moneda)", "Empalme Dactilar (Finger Palm)", "Empalme de Pulgar (Thumb Palm)", "Retención de Vista (Retention Vanish)", "Falsa Deposición (False Deposit/Take)", "Pase Francés (French Drop)", "Producción de Moneda desde Aire Fino (Produce from Thin Air - Basic)", "Moneda a través de la Mano (Coin Through Hand - Basic)", "Moneda a través de la Mesa (Coin Through Table - Basic)", "Rutina 'Matrix' Simple (Basic Matrix Routine)", "Multiplicación de Monedas (Coins Across - Basic)", "Vuelo de Monedas (Coins Across a la Manga - Introducción)", "Jumbo Coin Production Finale", "Cambio de Moneda Simple (Simple Coin Switch)", "Moneda Doblada (Bent Coin Illusion - Basic)", "Pase Muscular (Muscle Pass - Introducción/Práctica)", "Rutina de Tres Monedas (Three Coin Routine - e.g., Spellbound intro)", "Moneda en la Botella (Coin in Bottle - Basic Prep/Method)", "Nido de Cajas Simplificado (Simplified Nest of Boxes)", "Desvanecimiento con Pañuelo (Vanish using Handkerchief)",
            // Cuerdas y Nudos
            "Cuerda Cortada y Recompuesta (Cut and Restored Rope - Método Básico/Medio)", "Nudo Falso (False Knot)", "Nudo que se Disuelve (Dissolving Knot)", "Tres Cuerdas Iguales (Professor's Nightmare - Básico)", "Nudo Corredizo Mágico", "Aros Chinos Simplificados (Linking Ropes - Basic)", "Cuerda a través del Cuello (Rope Through Neck - Método Seguro)", "Estiramiento de Cuerda",
            // Pañuelos y Sedas
            "Uso Básico de la Yema del Pulgar (Thumb Tip Basics - Vanish/Production)", "Pañuelo que Cambia de Color (Color Changing Silk - Dye Tube Basic)", "Producción de Seda de la Mano Vacía (Silk from Bare Hand - Basic)", "Nudo Falso con Seda", "Seda Penetrante (Silk Through Microphone Stand/Object)", "Producción Múltiple de Sedas Pequeñas",
            // Mentalismo Nivel Medio
            "Forzaje Psicológico (Magician's Choice)", "Predicción Simple (One-Ahead Principle)", "Lectura en Frío Básica (Cold Reading Intro/Stock Lines)", "Test del Libro Simplificado (Basic Book Test)", "Forzaje Numérico (Simple Number Force)", "Adivinación de Dibujo Simple (Center Tear - Intro)", "Predicción con Pizarra Espiritual Simple (Spirit Slate Basics)", "Rutina de 'Sí/No' (Basic Q&A act structure)", "Uso de Claves Sutiles (Subtle Cueing - Partner Intro)", "Pseudo-psicometría (Reading Objects - Basic)",
            // Objetos Cotidianos
            "Clips que se Enlazan (Linking Paperclips)", "Desaparición de Bolígrafo (Pen Vanish - Basic Sleeve/Pocket)", "Cuchara Doblada (Spoon Bending - Basic Misdirection Method)", "Servilleta a Rosa (Napkin Rose Production/Transformation)", "Goma Elástica Penetrante (Jumping Rubber Band)", "Goma Rota y Recompuesta (Broken and Restored Rubber Band)", "Billete Flotante (Floating Bill - Basic Thread Work Intro)", "Azúcar a través de la Mesa (Salt/Sugar Through Table)", "Equilibrio Imposible (Balancing Objects)", "Anillo en Cordón (Ring on String - Basic On/Off)",
            // Principios y Teoría (Nivel Medio)
            "Psicología de la Misdirection (Types and Application)", "Construcción de Patter (Storytelling/Engagement)", "Manejo del Tiempo y Ritmo (Timing and Pacing)", "Importancia del Ángulo (Angle Proofing)", "Creación de una Rutina Corta (Opening/Middle/Close)", "Manejo de Errores (Handling Mistakes Gracefully)", "Selección de Efectos Apropiados para el Público", "Ética en el Ilusionismo (Exposure/Secrecy)", "Desarrollo de Personaje Escénico (Basic Stage Persona)", "Uso de la Música y el Sonido", "Técnicas de Ensayo Efectivas", "Análisis de Actuaciones (Self-Critique)", "Historia Breve de Ilusionistas Famosos (Influences)", "Diferencia entre Ilusionismo y Prestidigitación", "El Arte de la 'Carga' y 'Descarga' (Loading/Stealing Objects)", "Principios de la Atención Dividida", "Uso del Off-beat (Moments of Misdirection)", "Naturalidad en los Movimientos", "Contacto Visual y Lenguaje Corporal", "Adaptación al Entorno (Close-up vs. Stage)",
            // Añadir muchísimos más títulos específicos y variaciones...
            // ... (aprox. 250-300 más para acercarse a 400)
            "El Vaso de Leche que Desaparece (Método Seguro)", "Aparición de Palomas (Introducción y Cuidado)", "Multiplicación de Bolas de Billar (Rutina Básica 1-4)", "Serpiente Encantada (Cuerda Hindú - Básico)", "Agua y Aceite (Cartomagia)", "Carta Atrapada entre Cristales", "Reloj Detenido a Voluntad", "Adivinación del Día de la Semana (Calendario Mental)", "Cartera en Llamas (Fire Wallet - Manejo Seguro)", "Lectura de Cenizas en el Brazo", "Aguja a través del Globo", "Producción de Paraguas", "Sombras Chinescas Básicas", "Anillos Chinos (Rutina 3 anillos)", "La Caja de Cerillas Flotante", "El Cubilete Único (One Cup Routine)", "Adivinación de Color con Cubos", "Periódico Roto y Recompuesto", "Agua India (Lota Bowl - Básico)", "Flor que Aparece", "Control Zarrow (Introducción)", "Pase de Herman (Herman Pass - Intro)", "Control de Inclinación (Tilt/Depth Illusion)", "La Moneda Fantasma (Copper/Silver - Básico)", "Adivinación con Péndulo (Pendulum Basics)", "Escapismo Básico (Nudos, Cadenas Simples)", "Hipnosis Simulada (Suggestibility Tests)", "Levitación de Objetos Pequeños (Thread Work)", "Lectura Muscular (Contact Mind Reading - Intro)", "Efecto con Dados (Predicción Simple)"
            // ... y así sucesivamente, detallando variaciones, métodos específicos, etc.
        ];
        const illusionismThemes = [
            "cartomagia nivel medio", "trucos con monedas", "magia con cuerdas", "mentalismo práctico", "ilusionismo con objetos cotidianos", "técnicas de manipulación", "misdirection", "psicología del engaño", "construcción de rutinas mágicas", "historia del ilusionismo", "magia de cerca (close-up)", "magia de salón", "principios de la prestidigitación", "forzajes de cartas", "controles de cartas", "empalmes (palming)", "floritures (cardistry básico)", "magia con pañuelos (sedas)", "escapismo básico", "ilusionismo cómico", "magia infantil (nivel medio)", "efectos con gomas elásticas", "presentación y patter", "manejo de escenario"
        ];
        const textApiConfig = {
            model: "mistral", // Puedes probar con otros si Mistral no da buenos resultados para magia
            systemPrompt: "Eres un ilusionista profesional experimentado y un excelente maestro de magia. Tu especialidad son los trucos de nivel intermedio y explicar sus secretos de forma clara y detallada. Describe el truco, técnica o principio de ilusionismo indicado. Incluye: El efecto percibido por el espectador, el método secreto (explicado paso a paso, asumiendo conocimientos básicos de magia), los materiales necesarios, puntos clave de la presentación (patter, misdirection, psicología), posibles variaciones o consejos para la práctica, y nivel de dificultad aproximado dentro del rango 'medio'. Sé detallado y preciso, como si estuvieras enseñando a un estudiante dedicado. El objetivo es una explicación completa de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente truco o concepto:",
            timeoutSeconds: 180 // Aumentado ligeramente por si la explicación detallada toma más tiempo
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúa como un asistente de mago experimentado, enfocado *únicamente* en el truco o concepto que se está discutiendo. Responde preguntas de seguimiento sobre detalles del método, la presentación, la resolución de problemas comunes o variaciones de ese truco específico. Sé claro, conciso y mantente estrictamente en el tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de ideas para un repertorio de ilusionismo de nivel medio. Genera exactamente 40 nombres de trucos específicos, técnicas de manipulación, principios psicológicos o conceptos relevantes para un mago de nivel intermedio. Devuelve *solo* la lista de nombres/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas. Sé variado (cartas, monedas, mentalismo, objetos, teoría).",
            timeoutSeconds: 60 // Aumentado para generar 40 títulos
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que la versión anterior, pero añadiendo los del minijuego)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Ahora contiene el juego
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Mini-Game Elements
        const memoryGameContainer = document.getElementById('memory-game-container');
        const memoryGrid = document.getElementById('memory-grid');
        const gameLevelDisplay = document.getElementById('game-level');
        const gameStatusDisplay = document.getElementById('game-status');


        // ========== State Variables ==========
        let currentTrickTitle = null;
        let memoryGameActive = false; // Flag para controlar el estado del juego
        let memoryGameLevel = 1;
        let memoryCards = [];
        let hasFlippedCard = false;
        let lockBoard = false; // Prevenir clickear más de 2 cartas
        let firstCard, secondCard;
        let matchesFound = 0;
        let totalPairs = 0;
        // Iconos para el juego de memoria (usando FontAwesome)
        const magicIcons = ['fa-hat-wizard', 'fa-wand-magic-sparkles', 'fa-star', 'fa-clover', 'fa-heart', 'fa-diamond', 'fa-spade', 'fa-rabbit', 'fa-key', 'fa-bolt', 'fa-moon', 'fa-dice-d6', 'fa-ring', 'fa-crown', 'fa-feather'];


        // ========== API FUNCTIONS ==========
        // fetchTextFromApi (sin cambios funcionales, solo posible ajuste de timeout en config)
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentTrickTitle
                ? `Eres un asistente de mago experimentado, enfocado *únicamente* en el truco o concepto llamado '${currentTrickTitle}'. Responde preguntas de seguimiento sobre detalles del método, la presentación, la resolución de problemas comunes o variaciones de ese truco específico. Sé claro, conciso y mantente estrictamente en el tema actual.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}, Timeout: ${config.timeoutSeconds}s): ${url.substring(0, 200)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) { throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, por favor intenta en unos segundos.`); }
                const text = await response.text();
                if (!text || text.trim().length === 0) { throw new Error("La respuesta de la IA llegó vacía. Intenta de nuevo o reformula."); }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') { throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`); }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }
        // Wrappers (sin cambios)
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTrickTitle) throw new Error("Error interno: Contexto del truco no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        // MODIFIED: fetchGeneratedTitles for 40 titles
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(illusionismThemes) || "ilusionismo general";
            const specificPrompt = `Genera 40 ítems (trucos, técnicas, conceptos) sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 4 && line.length < 150);
                     // Aumentar el mínimo esperado
                     if (titles.length < 20) throw new Error("La IA no generó suficientes ideas de trucos.");
                     // Devolver hasta 40
                     return titles.slice(0, 40);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Adaptar prompt para magia
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "magic trick illustration";
            const enhancedPrompt = `Stylized illustration representing the magic trick or concept '${safePromptText}'. Mysterious atmosphere, stage magic elements (cards, coins, top hat, wand, smoke, curtains). Avoid text, labels, diagrams. Artistic interpretation, painterly style.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, photograph, realistic, blurry, low quality, multiple images, collage";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            stopMemoryGame(); // Asegurarse de parar el juego al cerrar
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             // NO mostrar el juego aquí, se inicia en handleTitleClick
             modalLoadingIndicator.style.display = 'none'; // Ocultar área de carga/juego por defecto
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTrickTitle = null;
             hideFullscreenImage();
             memoryGameLevel = 1; // Resetear nivel del juego para la próxima vez
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== MEMORY GAME FUNCTIONS ==========
        function shuffle(array) { // Fisher-Yates Shuffle
             let currentIndex = array.length, randomIndex;
             while (currentIndex > 0) {
                 randomIndex = Math.floor(Math.random() * currentIndex);
                 currentIndex--;
                 [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
             }
             return array;
        }

        function createGameBoard(level) {
            if (!memoryGrid || !gameLevelDisplay || !gameStatusDisplay) return;
            memoryGrid.innerHTML = ''; // Limpiar grid anterior
            matchesFound = 0;
            // Ajustar tamaño del grid basado en el nivel
            let columns, pairsCount;
            if (level === 1) { columns = 4; pairsCount = 6; } // 4x3 grid
            else if (level === 2) { columns = 4; pairsCount = 8; } // 4x4 grid
            else if (level === 3) { columns = 5; pairsCount = 10; } // 5x4 grid
            else if (level === 4) { columns = 6; pairsCount = 12; } // 6x4 grid
             else if (level === 5) { columns = 6; pairsCount = 15; } // 6x5 grid
            else { columns = 6; pairsCount = 18; } // 6x6 grid (máximo o repetir)

            totalPairs = pairsCount;
            memoryGrid.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;

            // Seleccionar iconos y duplicarlos para formar parejas
            const iconsForLevel = shuffle([...magicIcons]).slice(0, pairsCount);
            const cardIcons = shuffle([...iconsForLevel, ...iconsForLevel]);

            memoryCards = []; // Resetear array de cartas
            cardIcons.forEach(iconClass => {
                const card = document.createElement('div');
                card.classList.add('memory-card');
                card.dataset.icon = iconClass; // Guardar el icono como data attribute

                card.innerHTML = `
                    <div class="front-face"><i class="fas ${iconClass}"></i></div>
                    <div class="back-face"><i class="fas fa-question"></i></div>
                `;
                memoryGrid.appendChild(card);
                memoryCards.push(card);
                card.addEventListener('click', handleCardClick);
            });

            gameLevelDisplay.textContent = `Nivel ${level}`;
            gameStatusDisplay.textContent = `Encuentra ${totalPairs} parejas...`;
            console.log(`Memory game level ${level} created with ${totalPairs} pairs.`);
        }

        function handleCardClick() {
            if (!memoryGameActive || lockBoard || this === firstCard || this.classList.contains('flip') || this.classList.contains('matched')) return;

            this.classList.add('flip');

            if (!hasFlippedCard) {
                // Primera carta clickeada
                hasFlippedCard = true;
                firstCard = this;
                return;
            }

            // Segunda carta clickeada
            secondCard = this;
            lockBoard = true; // Bloquear tablero mientras se revisa

            checkForMatch();
        }

        function checkForMatch() {
            let isMatch = firstCard.dataset.icon === secondCard.dataset.icon;

            if (isMatch) {
                matchesFound++;
                gameStatusDisplay.textContent = `¡Pareja encontrada! (${matchesFound}/${totalPairs})`;
                disableCards();
                if (matchesFound === totalPairs) {
                     // Nivel completado
                     console.log(`Level ${memoryGameLevel} completed!`);
                     gameStatusDisplay.textContent = `¡Nivel ${memoryGameLevel} superado! Preparando siguiente...`;
                     setTimeout(() => {
                         if (memoryGameActive) { // Solo avanza si el juego no se detuvo
                             memoryGameLevel++;
                             createGameBoard(memoryGameLevel);
                         }
                     }, 1500); // Espera antes de pasar al siguiente nivel
                } else {
                    resetBoard(); // Resetear para seguir buscando
                }
            } else {
                gameStatusDisplay.textContent = `No coinciden... ¡Sigue buscando!`;
                unflipCards();
            }
        }

        function disableCards() { // Marcar como matched y quitar listener
            firstCard.classList.add('matched');
            secondCard.classList.add('matched');
            firstCard.removeEventListener('click', handleCardClick);
            secondCard.removeEventListener('click', handleCardClick);
            // Opcional: Pequeño delay antes de resetear para que se vea el match
             // setTimeout(resetBoard, 300); // No necesario si resetBoard se llama después
        }

        function unflipCards() { // Voltear si no son pareja
            setTimeout(() => {
                if (firstCard) firstCard.classList.remove('flip');
                if (secondCard) secondCard.classList.remove('flip');
                resetBoard();
            }, 1200); // Tiempo para ver la segunda carta antes de voltear
        }

        function resetBoard() { // Resetear estado después de un par de clicks
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }

        function startMemoryGame() {
            if (!memoryGameContainer) return;
            console.log("Starting memory game...");
            memoryGameActive = true;
            modalLoadingIndicator.style.display = 'flex'; // Mostrar área de carga/juego
            modalStoryContentArea.classList.add('content-hidden'); // Asegurar contenido oculto
            memoryGameLevel = 1; // Empezar siempre en nivel 1
            createGameBoard(memoryGameLevel);
        }

        function stopMemoryGame() {
            if (!memoryGameActive) return;
            console.log("Stopping memory game.");
            memoryGameActive = false;
            memoryGrid.innerHTML = ''; // Limpiar tablero
            // No ocultar modalLoadingIndicator aquí, se hace en handleTitleClick al mostrar contenido/error
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { if (!titleListContainer || !titlesLoading) return; const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none'; if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» No hay secretos disponibles en este momento «</p>'; return; } sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        // MODIFIED: appendTitles handles 40 new titles
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => {
                 if (!existingTitles.has(title)) {
                     titleListContainer.appendChild(createTitleItem(title));
                     addedCount++;
                 }
             });
             console.log(`Added ${addedCount} new titles.`);
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to integrate game start/stop ***
        async function handleTitleClick(title) {
            resetModalState(); // Limpia estado anterior (incluye parar juego si estaba corriendo)
            showModal();
            modalTitle.textContent = title;
            currentTrickTitle = title; // Contexto para chat
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');

            // *** INICIAR JUEGO ***
            startMemoryGame();

            // *** Iniciar Fetching en paralelo ***
            let explanationPromise = fetchExplanationText(title);
            let imagePromise = Promise.resolve(createPollinationsImageUrl(title)); // Crear URL es rápido

            try {
                // Esperar a que termine la explicación (lo más largo)
                const rawExplanationText = await explanationPromise;

                // *** PARAR EL JUEGO AQUÍ, JUSTO ANTES DE MOSTRAR CONTENIDO ***
                stopMemoryGame();
                modalLoadingIndicator.style.display = 'none'; // Ocultar área del juego

                // Procesar y mostrar texto
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Mostrar área de contenido

                modalTextArea.scrollTop = 0; // Reset scroll
                console.log("Scroll set to 0 after content visible");

                // Añadir placeholder de imagen (simple ahora, sin spinner complejo)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Cargando ilustración...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Crear imagen y esperar a que cargue (puede ser rápido o lento)
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Ilustración no disponible.</p>`;
                };

                const imageUrl = await imagePromise; // Ya teníamos la URL
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                // *** PARAR JUEGO TAMBIÉN EN CASO DE ERROR ***
                stopMemoryGame();
                modalLoadingIndicator.style.display = 'none'; // Ocultar área juego/carga

                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el secreto.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Mostrar área para ver error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // MODIFIED: handleGenerateMoreTitles uses new config
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando secretos...';
             try {
                 // Ya está configurado para pedir 40 en titleGenerationConfig
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron revelar más secretos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al revelar secretos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Revelar Más Secretos (40)';
             }
         }

         // Search Filter Function (sin cambios)
         function filterTitles(searchTerm) { const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); const titleItems = titleListContainer.querySelectorAll('.title-item'); let visibleCount = 0; titleItems.forEach(item => { const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const isVisible = titleText.includes(term); item.classList.toggle('hidden', !isVisible); if (isVisible) visibleCount++; }); noResultsMsg.classList.toggle('hidden', visibleCount > 0); }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Comprobar elementos esenciales, incluyendo los del juego
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !memoryGameContainer || !memoryGrid || !gameLevelDisplay || !gameStatusDisplay) {
                 console.error("Initialization failed: Missing essential UI elements (incl. game elements).");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡Abracadabra Fallido! Faltan componentes de la interfaz.</p>';
                 return;
             }
            // Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Carga inicial
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>