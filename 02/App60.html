<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glosario de Derecho Informático</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #2563eb; /* Blue 600 */
            --color-secondary: #0d9488; /* Teal 600 */
            --color-background: #f9fafb; /* Gray 50 */
            --color-text: #1f2937;      /* Gray 800 */
            --color-text-muted: #4b5563; /* Gray 600 */
            --color-modal-bg: #ffffff;
            --color-border: #e5e7eb;     /* Gray 200 */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); }
        h1, h2, h3, h4, .logo { font-family: 'Quicksand', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; } /* Slightly wider items */
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; } /* Slightly taller */
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1d4ed8; box-shadow: var(--shadow-sm); } /* Slightly darker blue */
        #generate-more-btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; } /* Darker overlay */
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem; max-width: 900px; width: 95%; max-height: 90vh; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; } /* Slightly wider modal */
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e5e7eb; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.4rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #d1d5db; color: var(--color-text); }
        #modal-title { color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; }
        #modal-content { line-height: 1.75; color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 15px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); } /* More padding */
        #modal-content::-webkit-scrollbar { width: 8px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; } /* Slightly more space */
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Quicksand', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.3em; }
        #modal-content h4 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content .formula { text-align: center; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 1.1em; padding: 0.8em; margin: 1.2em 0; border: 1px solid var(--color-border); background-color: #f9fafb; border-radius: var(--border-radius); overflow-x: auto; white-space: nowrap; }
        #modal-content .formula sub, #modal-content .formula sup { font-size: 0.8em; line-height: 0; position: relative; vertical-align: baseline; }
        #modal-content .formula sub { top: 0.5em; }
        #modal-content .formula sup { top: -0.5em; }
        #modal-image-container { width: 100%; height: 250px; /* Taller image area */ background-color: #f3f4f6; border-radius: var(--border-radius); overflow: hidden; display: none; /* Start hidden */ align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; margin-top: 1rem; }
        #modal-image-container.visible { display: flex; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 3rem; color: var(--color-border); display: none; }
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: var(--border-radius); border: 1px solid #fecaca; margin-top: 1rem; text-align: center; flex-shrink: 0; }
        .error-msg i { margin-right: 0.5rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
    <!-- Header/Navbar -->
    <nav class="navbar mb-8">
        <div class="container mx-auto px-4 py-3 flex justify-center items-center">
            <div class="flex items-center">
                <h1 class="logo text-2xl sm:text-3xl">
                    <i class="fas fa-gavel mr-2"></i> Glosario de Derecho Informático
                </h1>
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <main class="container mx-auto px-4 pb-16">
        <!-- Hero section -->
        <section class="mb-12 text-center">
            <h1 class="page-title text-4xl sm:text-5xl mb-4">Navegando el Ciberespacio Legal</h1>
            <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Definiciones claras y detalladas de términos clave en la intersección del derecho y la tecnología, generadas por IA.</p>
        </section>

        <!-- Title List Container -->
        <section class="mb-10">
            <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                <i class="fas fa-book-reader text-teal-500 mr-2"></i>
                Términos a Explorar
            </h2>
            <div id="title-list">
                 <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Compilando jurisprudencia digital...</p>
            </div>
            <div id="generate-more-container" class="text-center mt-8">
                <button id="generate-more-btn">
                     <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                    Generar Más Términos
                 </button>
            </div>
        </section>

    </main>

    <!-- Explanation Modal -->
    <div id="story-modal">
        <div class="modal-content-wrapper">
            <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

            <!-- Loading Indicator -->
            <div id="modal-loading">
                <div class="loading-spinner-modal"></div>
                <p>Consultando bases de datos legales...</p>
            </div>

            <!-- Content Area -->
            <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                <!-- Text Content (Scrollable) -->
                <div id="modal-content" class="text-base md:text-lg">
                    <!-- Explanation text (HTML) goes here -->
                </div>
                 <!-- Image Container (Initially Hidden) -->
                <div id="modal-image-container">
                    <div class="spinner"></div>
                    <i class="fas fa-balance-scale placeholder-icon"></i> <!-- Placeholder icon -->
                    <img id="modal-image" alt="Visualización conceptual del término legal" />
                </div>
                 <!-- Error Display Area -->
                <div id="modal-error" class="error-msg content-hidden">
                     <i class="fas fa-exclamation-circle"></i>
                     <span id="modal-error-message"></span>
                 </div>
            </div>
         </div>
     </div>

     <!-- Footer -->
     <footer class="bg-gray-100 text-gray-600 py-5 mt-12 border-t border-gray-200">
         <div class="container mx-auto px-4 text-center text-sm">
             <p>Definiciones generadas por IA con fines informativos. El derecho informático es complejo, consulte a un profesional legal.</p>
             <p class="mt-1">© 2025 Glosario Jurídico Digital</p>
         </div>
     </footer>


    <script>
        // ========== CONFIG & DATA ==========
        // --- Increased title list (~400 examples) ---
        const predefinedTitles = [
            "Abuso de Confianza Informático", "Acceso Ilícito a Sistemas", "Activo Intangible Digital", "Admisibilidad de la Prueba Electrónica", "Agente de Software", "Agente Encubierto Informático", "Algoritmo", "Anonimato en Línea", "Anonimización de Datos", "Arbitraje Electrónico", "Archivo Electrónico", "Aseguramiento de la Prueba Digital", "Ataque de Denegación de Servicio (DoS)", "Ataque de Denegación de Servicio Distribuido (DDoS)", "Auditoría de Sistemas", "Autenticación", "Autenticación de Doble Factor (2FA)", "Autenticación Multifactor (MFA)", "Autoridad de Certificación", "Autoría Digital", "Backup (Copia de Seguridad)", "Base de Datos", "Big Data", "Biometría", "Bitcoin", "Blockchain (Cadena de Bloques)", "Booleano (Lógica)", "Botnet", "Brecha de Datos (Data Breach)", "Bulo (Hoax)", "Cadena de Custodia Digital", "Certificado Digital", "Ciberacoso (Cyberbullying)", "Ciberataque", "Ciberdefensa", "Ciberdelincuencia (Cybercrime)", "Ciberespacio", "Ciberespionaje", "Ciberguerra", "Ciberseguridad (Cybersecurity)", "Cifrado (Encriptación)", "Cifrado Asimétrico (Clave Pública/Privada)", "Cifrado Simétrico (Clave Secreta)", "Ciudadanía Digital", "Cláusula de Confidencialidad (NDA)", "Cláusula de Propiedad Intelectual", "Cloud Computing (Computación en la Nube)", "Código Abierto (Open Source)", "Código Fuente", "Código Malicioso (Malware)", "Código Objeto", "Comercio Electrónico (E-commerce)", "Compliance Tecnológico", "Comunicaciones Electrónicas", "Conciliación Electrónica", "Confidencialidad de Datos", "Consentimiento Informado (Datos)", "Conservación de Datos", "Contenido Digital", "Contenido Generado por el Usuario (UGC)", "Contratación Electrónica", "Contrato Inteligente (Smart Contract)", "Control de Acceso", "Control Parental", "Cookie", "Copia Privada Digital", "Copyright (Derecho de Autor)", "Correo Electrónico (Email)", "Cortafuegos (Firewall)", "Cracking", "Creative Commons", "Criptoactivo", "Criptografía", "Criptomoneda", "Custodia de Claves", "Dark Web", "Dato Biométrico", "Dato Personal", "Dato Sensible", "Deep Web", "Deepfake", "Defensa en Profundidad", "Delegado de Protección de Datos (DPO/DPD)", "Delito Informático", "Denegación de Servicio (DoS/DDoS)", "Derecho al Olvido", "Derecho a la Desconexión Digital", "Derecho a la Intimidad (Privacidad)", "Derecho a la Portabilidad de Datos", "Derecho de Acceso (Datos)", "Derecho de Oposición (Datos)", "Derecho de Rectificación (Datos)", "Derecho de Supresión (Datos)", "Derechos ARCO/ARCOPOL", "Derechos de Autor en Software", "Derechos Digitales", "Descifrado", "Descubrimiento Electrónico (eDiscovery)", "Desindexación", "Detección de Intrusiones (IDS)", "Dictamen Pericial Informático", "Diligencia Debida Tecnológica", "Dirección IP", "Disponibilidad de Datos", "Documento Electrónico", "Dominio de Internet", "Doxing", "Dumping Informático", "E-Administración", "E-Justicia", "Eavesdropping (Escucha Clandestina)", "Economía Colaborativa", "EDI (Intercambio Electrónico de Datos)", "Encriptación (Cifrado)", "Engineering Social (Ingeniería Social)", "Enlace (Link)", "Escrow de Código Fuente", "Estafa Nigeriana (419 Scam)", "Esteganografía", "Etiqueta Digital (Netiqueta)", "Evaluación de Impacto en Protección de Datos (EIPD)", "Evidencia Digital", "Exploit", "Fake News (Noticias Falsas)", "Federal Information Processing Standards (FIPS)", "Filtración de Datos", "Firma Biométrica", "Firma Digital", "Firma Electrónica", "Firma Electrónica Avanzada", "Firma Electrónica Cualificada", "Fintech", "Forense Digital (Informática Forense)", "Foro Competente (Jurisdicción)", "Fraccionamiento de Datos", "Fraude Informático", "Función Hash", "Garantía de Software", "Gestión de Identidad Digital", "Gestión de Riesgos Tecnológicos", "Gobernanza de Datos", "Grooming (Ciberacoso Sexual a Menores)", "Gusano Informático (Worm)", "Habeas Data", "Hacker", "Hacking", "Hacking Ético", "Hardware", "Hash", "Huella Digital (Navegación)", "Identidad Digital", "Impacto Algorítmico", "Incidente de Seguridad", "Inclusión Digital", "Infraestructura Crítica", "Ingeniería Inversa", "Ingeniería Social", "Inimputabilidad Informática", "Inobservancia de Medidas de Seguridad", "Inspección Ocular Tecnológica", "Integridad de Datos", "Inteligencia Artificial (IA)", "Inteligencia Artificial Generativa", "Internet de las Cosas (IoT)", "Interceptación de Comunicaciones", "Intranet", "Intrusión Informática", "Investigación Forense Digital", "IP Spoofing", "ISO 27001 (Seguridad de la Información)", "Jurisdicción en el Ciberespacio", "Keylogger", "Know-How Tecnológico", "La Nube (Cloud Computing)", "Legaltech", "Legislación Aplicable", "Ley de Cookies", "Ley de Moore", "Ley de Servicios de la Sociedad de la Información (LSSI)", "Libertad de Expresión en Línea", "Licencia de Software", "Licencia de Usuario Final (EULA)", "Limitación de la Finalidad (Datos)", "Litigación Electrónica", "Log (Registro de Eventos)", "Machine Learning (Aprendizaje Automático)", "Malvertising", "Malware", "Man-in-the-Middle (Ataque)", "Marco Legal", "Marca Registrada (Trademark)", "Marketplace Digital", "Mediación Electrónica", "Medida Cautelar Tecnológica", "Medidas de Seguridad (Datos)", "Memoria Caché", "Metadatos", "Minimización de Datos", "Monitorización de Empleados", "Motor de Búsqueda", "Navegación Anónima", "Negligencia Informática", "Netiqueta", "Neutralidad de la Red", "Nivel de Seguridad", "Nombre de Dominio", "Notificación de Brecha de Datos", "Notificación Electrónica", "Nube Híbrida", "Nube Privada", "Nube Pública", "Objeto Conectado (IoT)", "Obsolescencia Programada", "Oficina sin Papeles", "Open Data (Datos Abiertos)", "Open Source", "Operador de Telecomunicaciones", "Pago Electrónico", "Página Web", "Paquete de Datos", "Pasarela de Pago", "Patente de Software", "Pentesting (Pruebas de Penetración)", "Pericia Caligráfica Digital", "Perito Informático", "Permisos de Acceso", "Pharming", "Phishing", "Piratería de Software", "Plagio Digital", "Plan de Continuidad de Negocio", "Plan de Recuperación ante Desastres", "Plataforma Digital", "Política de Cookies", "Política de Privacidad", "Política de Seguridad", "Portabilidad de Datos", "Portal Web", "Posicionamiento Web (SEO)", "Prestador de Servicios de Certificación", "Prestador de Servicios de Intermediación", "Prevención de Intrusiones (IPS)", "Principio de Responsabilidad Proactiva (Accountability)", "Privacidad por Diseño", "Privacidad por Defecto", "Propiedad Industrial", "Propiedad Intelectual", "Protocolo de Internet (IP)", "Protocolo Seguro (HTTPS)", "Proveedor de Acceso a Internet (ISP)", "Proveedor de Servicios en la Nube (CSP)", "Prueba Electrónica", "Pseudonimización", "Publicidad Comportamental", "Puerto (Redes)", "Querella Electrónica", "Ransomware", "Raspado Web (Web Scraping)", "Recuperación de Datos", "Red Neuronal Artificial", "Red Privada Virtual (VPN)", "Red Social", "Registro de Actividades de Tratamiento", "Reglamento General de Protección de Datos (RGPD/GDPR)", "Regtech", "Repudio (No Repudio)", "Reputación Online", "Requisito Legal", "Responsabilidad Civil por Daños Informáticos", "Responsabilidad del Intermediario", "Responsabilidad Penal Informática", "Retención de Datos", "Revocación de Certificado", "Riesgo Informático", "Robo de Identidad", "Robot (Software)", "Rootkit", "Router", "Sabotaje Informático", "SaaS (Software como Servicio)", "Sanción por Infracción de Datos", "Sandbox (Entorno de Pruebas)", "Secreto Empresarial Tecnológico", "Sede Electrónica", "Seguridad de la Información", "Seguridad Informática", "Seguridad por Diseño", "Sello de Tiempo (Timestamping)", "Servicio de Alojamiento (Hosting)", "Servicios de la Sociedad de la Información", "Sesgo Algorítmico", "Sexting", "Sextorsión", "Sharenting", "Sistema de Ficheros", "Sistema Experto", "Sistema Informático", "Sistema Operativo", "Sitio Web", "Smart Contract", "Smishing", "Sniffing", "Software", "Software As A Service (SaaS)", "Software Espía (Spyware)", "Software Libre", "Software Malicioso (Malware)", "Software Propietario", "Spam", "Spoofing", "Spyware", "SSL/TLS (Protocolos de Seguridad)", "Suplantación de Identidad (Spoofing)", "Tablón de Anuncios Electrónico", "TCP/IP", "Tecnología Blockchain", "Tecnología de Registro Distribuido (DLT)", "Tecnologías de la Información y Comunicación (TIC)", "Teletrabajo", "Tercero de Confianza", "Términos y Condiciones", "Test de Intrusión", "Testigo Digital", "Token", "Tokenización", "Toxicidad en Línea", "Trafficking de Datos", "Transferencia Internacional de Datos", "Tratamiento de Datos Personales", "Troyano (Trojan Horse)", "Tutela Judicial Efectiva Digital", "URL (Localizador Uniforme de Recursos)", "Usabilidad Web", "Usuario", "Validez Legal del Documento Electrónico", "Verificación de Identidad", "Vigilancia Electrónica", "Violación de Derechos de Autor", "Violación de la Privacidad", "Virus Informático", "Visibilidad en Línea", "Vishing", "Voto Electrónico", "Vulnerabilidad", "Web 2.0", "Web 3.0", "Web Hosting", "Web Profunda (Deep Web)", "Web Semántica", "WiFi", "Zero-Day Exploit"
        ];
        const lawThemes = [
            "protección de datos personales", "ciberdelincuencia y delitos informáticos", "propiedad intelectual en el entorno digital", "contratación electrónica y comercio electrónico", "firma electrónica y certificación digital", "responsabilidad de intermediarios en internet", "evidencia digital y informática forense", "ciberseguridad y gestión de incidentes", "privacidad y comunicaciones electrónicas", "jurisdicción y ley aplicable en internet", "redes sociales y libertad de expresión", "inteligencia artificial y derecho", "blockchain, criptomonedas y derecho", "computación en la nube (cloud computing) y aspectos legales", "teletrabajo y aspectos legales", "gobernanza de internet y neutralidad de la red", "derechos digitales y ciudadanía digital", "regulación de plataformas digitales", "legaltech y transformación digital del sector legal", "aspectos legales del software (licencias, patentes)", "biometría y reconocimiento facial", "Internet de las Cosas (IoT) y derecho", "videojuegos y derecho (eSports)", "deepfakes y manipulación de información", "ética en la tecnología y derecho"
        ];
        // --- Increased length target and timeout ---
        const textApiConfig = { model: "mistral", systemPrompt: "Eres un experto en Derecho Informático y un excelente comunicador. Tu tarea es definir y explicar términos complejos de derecho informático de forma muy clara, exhaustiva y detallada para profesionales, estudiantes o público interesado (similar a una entrada de glosario enciclopédico). Utiliza definiciones precisas, contexto legal, ejemplos prácticos (hipotéticos o reales anonimizados) y posibles implicaciones. Si es relevante, menciona normativa clave (ej. RGPD) de forma genérica sin entrar en detalles específicos de un país. Estructura la explicación con claridad usando párrafos y sub-títulos (usando markdown como #, ##, ### o ####). El objetivo es una definición completa y fácil de entender de unas 1200-1300 palabras. Basa tu explicación únicamente en el siguiente término:", timeoutSeconds: 150 };
        const titleGenerationConfig = { model: "mistral", systemPrompt: "Actúa como un generador de ideas conciso. Genera exactamente 15 términos o conceptos clave sobre derecho informático o tecnología legal, adecuados para ser definidos en un glosario. Devuelve *solo* la lista de términos/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.", timeoutSeconds: 30 };

        // ========== DOM ELEMENTS ========== (sin cambios)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // --- Variable to hold the current scroll listener ---
        let currentScrollHandler = null;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) { /* ... (sin cambios) ... */
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`); // Log shorter URL
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 console.log(`Received ${text.length} characters from API.`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
             }
        }
        async function fetchExplanationText(conceptTitle) { /* ... (sin cambios, usa textApiConfig actualizada) ... */
             console.log(`Fetching definition for: ${conceptTitle}`);
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              // Adjust length check for the new target
              if (text.trim().length < 1000 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo ayudarte con eso")) {
                   console.warn(`Received text length ${text.trim().length} might be too short or indicates failure.`);
                   throw new Error("La IA no pudo generar una definición adecuada o suficientemente detallada para este término.");
               }
             return text;
         }
        async function fetchGeneratedTitles() { /* ... (sin cambios, usa titleGenerationConfig actualizada) ... */
             const randomTheme = getRandomElement(lawThemes) || "terminología básica";
             const specificPrompt = `Genera 15 términos o conceptos clave sobre ${randomTheme} en derecho informático`;
             console.log("Generating terms with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150); // Allow shorter terms too
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de términos.");
             console.log("Generated new terms:", titles);
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) { /* ... (prompt adaptado) ... */
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "legal technology abstract";
             // Enhanced prompt for IT Law
             const enhancedPrompt = `Abstract conceptual visualization related to the IT Law term '${safePromptText}', digital law concept, cybersecurity, data privacy, network connections, flowing data streams, binary code patterns, abstract legal scales integrated with technology, minimalist style, focus on structure or interaction`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Strong negative prompt for IT Law
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, paragraphs, book pages, legal documents, contracts, laws, articles, court decision text, judge, gavel, courtroom, scales of justice drawing, specific legal symbols, realistic photo, person, people, office scene, computer screen showing text, code snippets, diagrams with labels, charts, graphs, interface, watermark, signature";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, '<br>');
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (sin cambios en la lógica de scroll/imagen)
        function showModal() { /* ... */ if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { /* ... */
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
                console.log("Scroll listener removed on hideModal.");
            }
            resetModalState();
        }
        function resetModalState() { /* ... */
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.classList.remove('visible');
             modalImageContainer.style.display = 'none';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (sin cambios en la lógica de scroll/imagen)
        function getRandomElement(arr) { /* ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... */
            if (!titleListContainer || !titlesLoading) return;
            const shuffledTitles = shuffleArray([...titles]);
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay términos disponibles.</p>'; return; }
            shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
        }
        function appendTitles(newTitles) { /* ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        async function handleTitleClick(title) { /* ... (sin cambios en la lógica de scroll/imagen) ... */
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalImageContainer.style.display = 'none';
            modalImageContainer.classList.remove('visible');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
            }

            try {
                const rawExplanationText = await fetchExplanationText(title); // Uses updated config
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;

                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.scrollTop = 0; // <<<--- RESET SCROLL HERE
                console.log("Scroll set to 0 after content visible");

                modalImageSpinner.style.display = 'block';
                const imageUrl = createPollinationsImageUrl(title); // Uses updated prompts
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL:", title);
                     modalImageSpinner.style.display = 'none';
                     modalImagePlaceholder.style.display = 'block';
                 }

                const scrollBuffer = 20; // Adjusted buffer might be needed for longer text
                currentScrollHandler = () => {
                    if (modalContent.scrollHeight <= modalContent.clientHeight) {
                         console.log("Content fits, showing image immediately.");
                         modalImageContainer.classList.add('visible');
                         modalImageContainer.style.display = 'flex';
                         modalContent.removeEventListener('scroll', currentScrollHandler);
                         currentScrollHandler = null;
                    } else if ((modalContent.scrollTop + modalContent.clientHeight) >= (modalContent.scrollHeight - scrollBuffer)) {
                        console.log("Scroll end reached, showing image.");
                        modalImageContainer.classList.add('visible');
                        modalImageContainer.style.display = 'flex';
                        modalContent.removeEventListener('scroll', currentScrollHandler);
                        currentScrollHandler = null;
                        console.log("Scroll listener removed after showing image.");
                    }
                };
                modalContent.addEventListener('scroll', currentScrollHandler);
                console.log("Scroll listener added.");
                setTimeout(currentScrollHandler, 100);

            } catch (error) {
                console.error("Failed to display definition:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error al cargar: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = '';
                 if (currentScrollHandler) {
                    modalContent.removeEventListener('scroll', currentScrollHandler);
                    currentScrollHandler = null;
                 }
            }
        }
        async function handleGenerateMoreTitles() { /* ... (sin cambios, usa config actualizada) ... */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Investigando...'; // Updated text
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se pudieron generar nuevos términos en este momento."); }
             } catch (error) { console.error("Failed generation:", error); alert(`Error: ${error.message}`);
             } finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Términos'; } // Updated text
         }

        // ========== INITIALIZATION ========== (sin cambios)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p>Error crítico.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles); // Uses the large list
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>