<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmovisión Andina Precolombina</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes con toque rústico/antiguo pero legible -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Source+Sans+Pro:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Cosmovisión Andina --- */
        :root {
            --color-primary: #D4AF37; /* Oro/Ocre (Inti, Riqueza) */
            --color-secondary: #8B4513; /* Marrón Tierra (Pachamama) */
            --color-tertiary: #0077B6; /* Azul Profundo (Cielo, Agua) */
            --color-accent: #2E8B57; /* Verde (Naturaleza, Agricultura) */
            --color-background: #FDF5E6; /* Blanco Hueso/Pergamino claro */
            --color-text: #4A2C2A; /* Marrón Oscuro (Casi Negro) */
            --color-text-muted: #A0522D; /* Siena/Marrón claro */
            --color-modal-bg: #FFF8DC; /* Crema/Maíz */
            --color-border: #CD853F; /* Perú/Marrón dorado */
            --color-error-bg: #fceded; /* Fondo error rosado muy claro */
            --color-error-text: #8B0000; /* Texto error rojo oscuro */
            --color-error-border: #CD5C5C; /* Borde error rojo indio */

            --shadow-sm: 0 2px 4px 0 rgba(139, 69, 19, 0.1);
            --shadow-md: 0 4px 8px -1px rgba(139, 69, 19, 0.15), 0 2px 4px -2px rgba(139, 69, 19, 0.1);
            --shadow-lg: 0 10px 20px -5px rgba(139, 69, 19, 0.2), 0 8px 10px -6px rgba(139, 69, 19, 0.15);
            --border-radius: 4px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Source Sans Pro', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-secondary); }
        h1.page-title { color: var(--color-secondary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700;}
        #modal-title { color: var(--color-secondary); font-weight: 700; }
        .navbar { background-color: rgba(253, 245, 230, 0.85); /* Pergamino semi-transparente */ backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fffaf0; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Source Sans Pro'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2); outline: none; background-color: white; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Source Sans Pro'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-secondary); background-color: #fffdfa; border-left-color: var(--color-secondary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); box-shadow: var(--shadow-lg); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-text-muted); color: #f0e6d2; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; text-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(74, 44, 42, 0.9); /* Overlay Marrón oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Ensure space for content */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-background); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: var(--color-primary); transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid var(--color-modal-bg); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 600; }
        #modal-content em { color: var(--color-accent); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel', serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 400; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-secondary); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(160, 82, 45, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(253, 245, 230, 0.6); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--color-accent); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #eaddc6; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #fffaf0; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Source Sans Pro'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-secondary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #a0522d; } /* Siena hover */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator & Minigame */
        #modal-loading { text-align: center; padding: 2rem 1rem; /* More padding */ position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 248, 220, 0.97); /* Crema overlay */ display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid var(--color-border); border-top-color: var(--color-secondary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1rem auto; flex-shrink: 0; }
        #modal-loading p.loading-text { font-weight: 600; color: var(--color-text); font-size: 1.2rem; font-family: 'Cinzel'; margin-bottom: 1.5rem; flex-shrink: 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Puzzle Game Styles */
        #loading-game-container { margin-top: 1rem; padding: 1rem; border: 1px dashed var(--color-border); border-radius: var(--border-radius); background-color: rgba(255, 255, 255, 0.5); display: flex; flex-direction: column; align-items: center; max-width: 260px; flex-shrink: 0;}
        #puzzle-status { font-size: 0.9em; color: var(--color-text-muted); margin-bottom: 0.8rem; font-weight: 600; min-height: 1.2em; }
        #puzzle-grid { display: grid; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(3, 60px); gap: 5px; margin-bottom: 1rem; border: 2px solid var(--color-secondary); background-color: var(--color-border); padding: 5px; }
        .puzzle-tile { width: 60px; height: 60px; background-color: var(--color-primary); color: var(--color-secondary); font-size: 1.5em; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s, transform 0.2s; user-select: none; border-radius: 2px; font-family: 'Cinzel'; }
        .puzzle-tile:hover { background-color: #e7c057; transform: scale(1.05); }
        .puzzle-tile.empty { background-color: var(--color-modal-bg); cursor: default; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); border: 1px dashed var(--color-text-muted); }
        #puzzle-controls button { background-color: var(--color-secondary); color: white; border: none; padding: 0.4rem 0.8rem; margin: 0 0.3rem; border-radius: var(--border-radius); font-size: 0.85em; cursor: pointer; transition: background-color 0.2s; }
        #puzzle-controls button:hover { background-color: var(--color-text-muted); }
        #puzzle-controls button:disabled { background-color: #ccc; cursor: not-allowed; }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Source Sans Pro'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(74, 44, 42, 0.95); /* Overlay Marrón oscuro */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-secondary); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-sun mr-3 text-yellow-500"></i> <!-- Icono Sol (Inti) -->
                     Cosmovisión Andina
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Creencias Precolombinas «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">El Mundo Sagrado de los Andes</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora las deidades, rituales y conceptos que dieron forma a las grandes civilizaciones precolombinas.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar deidad, concepto, ritual...">
             <i class="fas fa-search fa-feather-alt"></i> <!-- Icono pluma/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-brown-700 mr-2"></i> <!-- Icono libro abierto -->
                 Índice de Conocimientos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Recopilando saberes ancestrales...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron entradas para esta búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar Más Sabiduría
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator & Minigame Area -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p class="loading-text">Descifrando quipus...</p>
                 <!-- Puzzle Game Container -->
                 <div id="loading-game-container">
                     <div id="puzzle-status">¡Completa el puzzle mientras esperas!</div>
                     <div id="puzzle-grid">
                         <!-- Tiles are generated by JS -->
                     </div>
                     <div id="puzzle-controls">
                         <button id="puzzle-reset">Reiniciar</button>
                         <button id="puzzle-new">Nuevo Puzzle</button>
                     </div>
                 </div>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image placeholder/image appended here by JS -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando oráculos...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este tema...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-feather-alt"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-yellow-50 text-brown-800 py-6 mt-12 border-t border-yellow-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Interpretaciones basadas en estudios arqueológicos y antropológicos sobre creencias andinas precolombinas.</p>
              <p class="mt-1">Contenido generado por IA con fines educativos y de divulgación.</p>
              <p class="mt-2">© Era Precolombina - Sabiduría Andina</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Deidades Principales (Panteón Inca y Pre-Inca)
            "Viracocha (Huiracocha): El Creador Primordial", "Inti: El Dios Sol, Padre de los Incas", "Pachamama: La Madre Tierra, Diosa de la Fertilidad", "Mama Killa: La Diosa Luna, Esposa de Inti", "Illapa: Dios del Trueno, Rayo y Lluvia", "Pachacámac: Dios Creador Costeño, Oráculo Principal", "Mama Cocha: Diosa del Mar y las Aguas", "Supay: Señor del Uku Pacha (Mundo Inferior)", "Kon: Antiguo Dios Creador Costeño (Sequía)", "Ai Apaec: Dios Decapitador Moche", "Naylamp: Fundador Mítico Chimú/Lambayeque", "Catequil: Oráculo y Dios del Rayo (Huamachuco)", "Huallallo Carhuincho: Dios Destructor Wanka", "Pariacaca: Dios de las Aguas y Lluvias Torrenciales (Yauyos)", "Tunupa: Deidad Viajera del Altiplano (Fuego, Volcanes)",
            // Deidades Menores y Espíritus
            "Apus: Espíritus Sagrados de las Montañas", "Huacas (Wak'as): Lugares, Objetos y Seres Sagrados", "Mallquis: Ancestros Momificados Venerados", "Conopas (Illas): Objetos de Poder y Fertilidad Doméstica", "Achachilas: Espíritus Ancestrales del Altiplano", "Auki: Espíritus Protectores Menores", "Larilari: Espíritu Maligno de las Alturas", "Anchanchu: Espíritu Malévolo que habita lugares aislados", "Duendes o Espíritus de la Naturaleza (conceptual)", "Génios Locales: Deidades Específicas de Comunidades", "Qhoa (Qowa): Felino Mítico asociado a la lluvia y granizo", "Amaru: La Serpiente Mítica Cósmica", "El Cóndor: Mensajero entre Mundos", "El Puma: Símbolo de Poder y del Kay Pacha", "La Llama: Animal Sagrado y de Sacrificio",
            // Cosmología y Conceptos Fundamentales
            "Hanan Pacha: El Mundo de Arriba (Celestial)", "Kay Pacha: Este Mundo (Terrenal)", "Uku Pacha: El Mundo de Abajo (Subterráneo)", "La Chakana: La Cruz Andina y su Simbolismo Cósmico", "Dualismo Andino: Oposición Complementaria (Hanan/Urin, Paña/Lloq'e)", "Ayni: Principio de Reciprocidad Mutua", "Minka (Minga): Trabajo Comunal Recíproco", "Mita: Tributo en Trabajo para el Estado/Comunidad", "Pachakuti: Concepto de Cataclismo y Renovación Cósmica", "Tiempo Cíclico vs. Lineal en la Cosmovisión Andina", "El Concepto de 'Pacha' (Tiempo-Espacio)", "Animismo: La Creencia en Espíritus en la Naturaleza", "Sacralidad del Paisaje Andino", "Ceques: Líneas Sagradas que irradian del Cusco", "La Vía Láctea (Mayu) como Río Celestial", "Orientación Astronómica de Templos y Ciudades", "El Rol de los Sueños y Visiones", "Concepto de 'Kamaq' (Fuerza Vital Animadora)", "Concepto de 'Sami' (Energía Vital Ligera)", "Concepto de 'Jucha' (Energía Vital Pesada)",
            // Rituales y Ceremonias
            "Inti Raymi: La Fiesta del Sol (Solsticio de Invierno)", "Capacocha: Sacrificio Humano Inca (Niños)", "Ofrendas a la Pachamama: Chicha, Coca, Alimentos", "Quema de Ofrendas (Textiles, etc.)", "Ceremonias de Marcación del Tiempo (Solsticios, Equinoccios)", "Rituales Agrícolas: Siembra y Cosecha", "Ch'alla: Ritual de Ofrenda y Agradecimiento", "Lectura de Hojas de Coca para Adivinación", "Adivinación a través de Vísceras de Animales (Aruspicina)", "Consulta a los Oráculos (Pachacámac, Catequil)", "Procesiones Rituales con Ídolos y Mallquis", "Rituales de Purificación", "Ceremonias de Iniciación", "Festivales dedicados a Deidades Específicas", "El Culto a los Ancestros (Mallquis)", "Mummificación: Técnicas y Significado", "Construcción y Veneración de Huacas", "Peregrinaciones a Lugares Sagrados", "Uso Ritual de Sustancias Psicoactivas (Vilca, San Pedro)", "Danzas Rituales y Música Ceremonial", "Libaciones Rituales con Chicha", "Sacrificio de Animales (Llamas, Cuyes)", "Wañuy: Rituales Funerarios", "Ceremonias de Fundación de Edificios", "Situa: Ritual Inca de Purificación y Expulsión de Males",
            // Sacerdocio y Roles Religiosos
            "Willaq Umu: Sumo Sacerdote Inca del Sol", "Sacerdotes Menores y Especialistas Rituales", "Aqllakuna (Acllas): Mujeres Escogidas al Servicio del Culto", "Mamaconas: Mujeres Mayores que instruían a las Acllas", "Chamanes o 'Paqos': Intermediarios con el Mundo Espiritual", "Yachaq: Sabios o Conocedores de lo Oculto", "Umuyayas: Adivinos especializados", "Confesores Incas: Ichuri", "Guardianes de Huacas", "Intérpretes de Sueños", "Médicos Herbolarios y su Conexión Espiritual", "Rol Religioso del Sapa Inca", "La Coya (Reina) y sus Deberes Rituales", "Organización Jerárquica del Sacerdocio Inca", "Diferencias Regionales en Roles Religiosos",
            // Objetos, Símbolos y Arte Religioso
            "El Quipu: ¿Sistema de Contabilidad y Algo Más?", "Textiles Andinos (Tocapu): Simbolismo y Uso Ritual", "Keros: Vasos Ceremoniales de Madera", "El Tumi: Cuchillo Ceremonial (Lambayeque/Inca)", "Conchas Spondylus (Mullu): Ofrenda Preciada", "Ídolos y Representaciones de Deidades (Oro, Plata, Piedra, Madera)", "Mascaras Rituales", "Arquitectura Sagrada: Templos del Sol (Coricancha), Ushnus", "Arte Rupestre con Motivos Religiosos", "Cerámica Ceremonial (Moche, Nazca, Inca)", "Instrumentos Musicales Rituales (Antaras, Quenas, Tambores)", "Amuletos y Talismanes Personales (Huayruros)", "Unku: Túnica Masculina y sus Diseños", "Lliclla: Manta Femenina y su Importancia", "Plumería y su Uso en Atuendos Ceremoniales",
            // Creencias Específicas por Cultura/Región
            "Religión Estatal Inca vs. Creencias Locales", "Influencias Wari y Tiwanaku en la Religión Inca", "Mitología Moche: Ai Apaec y el Mundo Marino", "Cosmovisión Nazca: Geoglifos y Agua", "Religión Chimú: Culto a la Luna (Si) y al Mar", "Creencias de los Chachapoyas: Culto a los Muertos y Sarcófagos", "Religión de los Reinos Aymaras del Altiplano", "Creencias de los Cañaris (Ecuador)", "Variaciones del Culto a Pachamama", "Sincretismo Temprano con el Catolicismo (Post-Conquista)", "Pervivencia de Creencias Ancestrales Hoy", "Mitología de Huarochirí: Fuentes Nativas", "Religión en Caral-Supe: La Civilización Más Antigua", "Cosmovisión Chavín: El Lanzón y la Tríada Divina", "Religión Paracas: Textiles Funerarios y Trepanación",
            // Vida después de la Muerte y Otros Mundos
            "Creencias sobre el Destino del Alma", "Viaje al Uku Pacha o Hanan Pacha", "Importancia de los Ritos Funerarios para el Viaje", "El Rol de los Perros en el Viaje al Más Allá (Algunas culturas)", "Paraísos e Infiernos Andinos (Conceptos)", "Comunicación con los Muertos (Mallquis)", "Reencarnación (¿Existía el concepto?)", "Transformación Espiritual Post-Mortem", "Los Peligros del Viaje del Alma", "El Mundo de los Muertos como Reflejo Invertido del Kay Pacha", "Ofrendas para los Muertos", "Miedo a los Muertos que no Descansan", "El Puente de Cabellos para Cruzar al Otro Mundo", "Juicio Post-Mortem (Conceptos Variables)", "La Muerte como Transición, no Final Absoluto",
            // Añadir más títulos con "Revelar Más Sabiduría"
        ];
        const andeanBeliefThemes = [
            "deidades Incas", "espíritus andinos", "cosmología andina", "mitología precolombina", "rituales Incas", "ceremonias andinas", "huacas sagradas", "Pachamama", "Inti Dios Sol", "Viracocha creador", "Apus montañas sagradas", "dualismo andino", "reciprocidad Ayni", "mundo de los muertos andino", "sacerdocio Inca", "oráculos andinos", "simbolismo Chakana", "arte religioso precolombino", "momificación andina", "sacrificios humanos Incas", "calendario ritual andino", "medicina tradicional andina", "influencia Wari Tiwanaku", "mitología Moche Chimú", "concepto de Pacha"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un respetado arqueólogo y antropólogo especializado en las civilizaciones andinas precolombinas. Tu conocimiento abarca desde Caral hasta el Imperio Inca. Describe la deidad, concepto, ritual o creencia andina indicada de manera profunda, académica pero accesible. Incluye: Origen y desarrollo (si se conoce), características principales, simbolismo, roles/funciones, evidencia arqueológica o etnohistórica, variaciones regionales, y su importancia dentro de la cosmovisión andina. Usa un lenguaje respetuoso y evita la exotización. El objetivo es una explicación detallada de aproximadamente 1200-1300 palabras. Basa tu descripción únicamente en el siguiente elemento de la cosmovisión andina:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente experto en el tema andino específico que se está discutiendo (indicado por el título). Responde preguntas de seguimiento sobre detalles, comparaciones, o implicaciones mencionadas en la descripción principal. Sé conciso, preciso y mantente enfocado en el tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia sobre religión andina precolombina. Genera exactamente 40 nombres de deidades menores, conceptos específicos, rituales detallados, lugares sagrados particulares o símbolos menos conocidos del mundo andino precolombino. Devuelve *solo* la lista de ítems, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 70 // Aumentado ligeramente para 40 títulos
        };

        // ========== DOM ELEMENTS ==========
        // (Identical DOM element grabbing as previous versions)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Puzzle Game Elements
        const loadingGameContainer = document.getElementById('loading-game-container');
        const puzzleGrid = document.getElementById('puzzle-grid');
        const puzzleStatus = document.getElementById('puzzle-status');
        const puzzleResetBtn = document.getElementById('puzzle-reset');
        const puzzleNewBtn = document.getElementById('puzzle-new');


        // ========== State Variables ==========
        let currentBeliefTitle = null; // Context for chat
        let puzzleState = []; // Array for puzzle numbers (0 is empty)
        let puzzleSolved = false; // Track if current puzzle is solved

        // ========== PUZZLE GAME LOGIC ==========
        const PUZZLE_SIZE = 3; // 3x3 grid

        // Check if a puzzle configuration is solvable (for standard sliding puzzles)
        function isSolvable(arr) {
            let inversions = 0;
            const flatArr = arr.filter(val => val !== 0); // Ignore the empty slot
            for (let i = 0; i < flatArr.length; i++) {
                for (let j = i + 1; j < flatArr.length; j++) {
                    if (flatArr[i] > flatArr[j]) {
                        inversions++;
                    }
                }
            }
            // For an odd grid width (3x3), the number of inversions must be even
            return inversions % 2 === 0;
        }

        // Shuffle array ensuring solvability
        function shuffleSolvable(size) {
            const n = size * size;
            let arr;
            do {
                arr = Array.from({ length: n }, (_, i) => i); // 0 to n-1 (0 is empty)
                // Fisher-Yates shuffle
                for (let i = n - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
            } while (!isSolvable(arr)); // Reshuffle if not solvable
            return arr;
        }

        function initializePuzzle() {
            puzzleState = shuffleSolvable(PUZZLE_SIZE);
            puzzleSolved = false;
            drawPuzzle();
            puzzleStatus.textContent = "¡Completa el puzzle mientras esperas!";
            enablePuzzleControls();
        }

        function resetCurrentPuzzle() {
            // Re-draw the current state, useful if user wants to restart the same shuffle
            puzzleSolved = isPuzzleSolvedState(puzzleState); // Check if it was already solved
            drawPuzzle();
             puzzleStatus.textContent = puzzleSolved ? "¡Puzzle Completado!" : "Puzzle Reiniciado";
             if (!puzzleSolved) enablePuzzleControls(); else disablePuzzleControls();
        }

        function drawPuzzle() {
            puzzleGrid.innerHTML = '';
            puzzleState.forEach((value, index) => {
                const tile = document.createElement('div');
                tile.classList.add('puzzle-tile');
                if (value === 0) {
                    tile.classList.add('empty');
                } else {
                    tile.textContent = value;
                    // Only add click listener if not solved
                    if (!puzzleSolved) {
                         tile.addEventListener('click', () => handleTileClick(value));
                    }
                }
                puzzleGrid.appendChild(tile);
            });
        }

        function handleTileClick(value) {
            if (puzzleSolved) return; // Don't move if already solved

            const tileIndex = puzzleState.indexOf(value);
            const emptyIndex = puzzleState.indexOf(0);

            const tileRow = Math.floor(tileIndex / PUZZLE_SIZE);
            const tileCol = tileIndex % PUZZLE_SIZE;
            const emptyRow = Math.floor(emptyIndex / PUZZLE_SIZE);
            const emptyCol = emptyIndex % PUZZLE_SIZE;

            // Check if adjacent (Manhattan distance === 1)
            if (Math.abs(tileRow - emptyRow) + Math.abs(tileCol - emptyCol) === 1) {
                // Swap
                [puzzleState[tileIndex], puzzleState[emptyIndex]] = [puzzleState[emptyIndex], puzzleState[tileIndex]];
                drawPuzzle(); // Redraw the board
                checkWinCondition();
            }
        }

        function isPuzzleSolvedState(state) {
             // Check if numbers are 1 to n-1 followed by 0
            for (let i = 0; i < state.length - 1; i++) {
                 if (state[i] !== i + 1) return false;
            }
             return state[state.length - 1] === 0;
        }

        function checkWinCondition() {
            if (isPuzzleSolvedState(puzzleState)) {
                puzzleSolved = true;
                puzzleStatus.textContent = "¡Puzzle Completado!";
                disablePuzzleControls(false); // Keep "New Puzzle" enabled
                // Optional: Visual feedback for solved state
                 const tiles = puzzleGrid.querySelectorAll('.puzzle-tile:not(.empty)');
                 tiles.forEach(t => t.style.backgroundColor = 'var(--color-accent)'); // Turn green
            }
        }

        function disablePuzzleControls(disableAll = true) {
             puzzleResetBtn.disabled = true;
             if(disableAll) puzzleNewBtn.disabled = true;
              // Remove click listeners from tiles indirectly by redrawing without them
              drawPuzzle();
        }
        function enablePuzzleControls() {
            puzzleResetBtn.disabled = false;
            puzzleNewBtn.disabled = false;
            // Re-add click listeners indirectly by redrawing with them
             drawPuzzle();
        }


        // ========== API FUNCTIONS ==========
        // fetchTextFromApi remains largely the same, but update context/prompts
         async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentBeliefTitle
                 ? `Eres un asistente experto únicamente en el tema andino precolombino '${currentBeliefTitle}'. Responde preguntas sobre sus detalles, simbolismo, o conexiones mencionados en la descripción principal. Sé conciso y preciso.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores espirituales están consultando los Apus, pero hay tráfico. Intenta en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("Los ancestros guardan silencio (respuesta vacía). Intenta preguntar de otra forma.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con el Hanan Pacha tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado consultando la sabiduría ancestral.");
             }
         }
         // Wrappers for clarity
         async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
         async function fetchChatResponse(userQuery) {
             if (!currentBeliefTitle) throw new Error("Error interno: No se ha establecido el contexto del tema para el chat.");
             return fetchTextFromApi(userQuery, chatApiConfig, true);
         }
         // *** MODIFIED: Fetch 40 titles ***
         async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(andeanBeliefThemes) || "creencias andinas generales";
            // *** Ask for 40 items ***
            const specificPrompt = `Genera 40 nombres/conceptos específicos sobre ${randomTheme} en la cosmovisión andina precolombina.`;
            console.log("Generating 40 titles with prompt:", specificPrompt);
            // Use the generic fetchTextFromApi with titleGenerationConfig (includes updated timeout)
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n')
                                      .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                      .filter(line => line.length > 5 && line.length < 150);
                     // Expect more titles now
                     if (titles.length < 20) { // Lowered threshold slightly, still expect many
                          throw new Error("La IA no generó suficientes conceptos nuevos.");
                      }
                     return titles.slice(0, 40); // Return up to 40
                 });
        }
        // Image prompt adapted
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "andean pre-columbian religious symbol";
             const enhancedPrompt = `Artistic representation inspired by the Andean pre-columbian belief/concept: '${safePromptText}'. Style like ancient Andean textiles, ceramics, or stone carving. Focus on symbolism, geometric patterns, key figures (Inti, serpent, puma, condor if relevant). Earthy tones, gold, deep blue accents. Avoid photorealism, avoid depicting specific modern people. Abstract or stylized representation.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, map, flag, photograph, realistic human face, modern clothing, european features, christian symbols, multiple images, collage, blurry, low quality";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (No changes needed)
        function formatExplanationText(rawText) { /* ... identical to previous version ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             loadingGameContainer.classList.add('content-hidden'); // Hide game initially
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentBeliefTitle = null;
             hideFullscreenImage();
             // Reset puzzle state too, but don't initialize yet
             puzzleState = [];
             puzzleSolved = false;
             puzzleGrid.innerHTML = ''; // Clear grid visually
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (No changes needed)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (No changes needed, uses adapted API call)
        function addChatMessage(message, sender) { const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error Consulta: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { if (!titleListContainer || !titlesLoading) return; const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none'; if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay saberes registrados en esta búsqueda «</p>'; return; } sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title)); newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } }); filterTitles(searchInput.value); }

        // *** MODIFIED: handleTitleClick to show puzzle game ***
        async function handleTitleClick(title) {
            resetModalState(); // Reset general state
            showModal();
            modalTitle.textContent = title;
            currentBeliefTitle = title; // Set chat context
            modalError.classList.add('content-hidden');

            // *** Show loading indicator AND initialize+show puzzle ***
            modalLoadingIndicator.style.display = 'flex';
            loadingGameContainer.classList.remove('content-hidden');
            initializePuzzle(); // Setup and draw the puzzle

            try {
                // Fetch data IN PARALLEL with user playing the puzzle
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // *** Data ready: Hide loading/game, show content ***
                modalLoadingIndicator.style.display = 'none'; // Hide spinner
                loadingGameContainer.classList.add('content-hidden'); // Hide game
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;

                // Add image placeholder and load image (logic remains the same)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-palette placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Creando representación...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Representación fallida.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                // *** Error occurred: Hide loading/game, show error ***
                modalLoadingIndicator.style.display = 'none';
                loadingGameContainer.classList.add('content-hidden');
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el saber.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: Handle Generate More for 40 titles ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando Apus...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40 titles now
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Los ancestros no revelaron más saberes en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al revelar sabiduría: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Revelar Más Sabiduría';
             }
         }

        // Search Filter Function (with normalization for accents)
        function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Ensure all elements exist, including puzzle controls
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !loadingGameContainer || !puzzleGrid || !puzzleStatus || !puzzleResetBtn || !puzzleNewBtn) {
                 console.error("Initialization failed: Missing essential elements (incl. puzzle).");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Pachakuti: Fallaron los cimientos de la página.</p>';
                 return;
             }
            // Standard Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // *** Puzzle Control Listeners ***
            puzzleResetBtn.addEventListener('click', resetCurrentPuzzle);
            puzzleNewBtn.addEventListener('click', initializePuzzle); // Starts a new shuffled game

            // Initial Display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            loadingGameContainer.classList.add('content-hidden'); // Ensure game is hidden initially
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>