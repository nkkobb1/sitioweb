<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historia Alternativa: Victoria del Eje - Archivos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes con aire histórico/formal -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Historia Alternativa (Victoria Eje) --- */
        :root {
            --color-primary: #8B0000; /* Rojo Oscuro (Sangre/Autoridad) */
            --color-secondary: #D3D3D3; /* Gris Claro (Contraste/Metal) */
            --color-tertiary: #556B2F; /* Verde Oliva Oscuro (Feldgrau) */
            --color-background: #1a1a1a; /* Casi Negro (Sombrío) */
            --color-text: #cccccc; /* Gris muy claro (Legibilidad) */
            --color-text-muted: #888888; /* Gris Medio */
            --color-modal-bg: #2b2b2b; /* Gris Oscuro */
            --color-border: #444444; /* Borde Gris Oscuro */
            --color-error-bg: #4a0000; /* Fondo error rojo muy oscuro */
            --color-error-text: #ffbaba; /* Texto error rojo claro */
            --color-error-border: #990000; /* Borde error rojo oscuro */

            --shadow-sm: 0 1px 2px 0 rgba(200, 200, 200, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
            --border-radius: 2px; /* Bordes más rectos/duros */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Oswald', sans-serif; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; }
        .logo { color: var(--color-secondary); text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); }
        h2.section-title { color: var(--color-secondary); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 400; }
        #modal-title { color: var(--color-secondary); font-weight: 700; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); }
        .navbar { background-color: rgba(26, 26, 26, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(43, 43, 43, 0.9); color: var(--color-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); transition: var(--transition-normal); font-family: 'Merriweather'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(139, 0, 0, 0.4); outline: none; background-color: #333333; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.1rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Merriweather'; font-size: 0.95rem; border-left: 4px solid var(--color-tertiary); }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-secondary); background-color: #3a3a3a; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-secondary); padding: 0.8rem 1.6rem; border: 1px solid #660000; border-radius: var(--border-radius); font-family: 'Oswald', sans-serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-transform: uppercase; }
        #generate-more-btn:hover:not(:disabled) { background-color: #a00000; border-color: #770000; box-shadow: var(--shadow-md); color: #ffffff; }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; border-color: #333; }
        #generate-more-btn .fa-sync-alt { color: var(--color-secondary); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-top: 3px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 8px; right: 8px; background: var(--color-border); border: none; border-radius: var(--border-radius); width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-secondary); transform: scale(1.1); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(68, 68, 68, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(68, 68, 68, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Oswald', sans-serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; text-transform: uppercase; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; filter: saturate(0.8) contrast(0.95); /* Slightly desaturated look */ }
        #modal-content .final-image:hover { transform: scale(1.02); filter: saturate(1) contrast(1); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(68, 68, 68, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(26, 26, 26, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(68, 68, 68, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(68, 68, 68, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--color-tertiary); color: #ffffff; margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #444444; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #3a3a3a; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Merriweather'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); background-color: #444; }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-secondary); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #a00000; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 26, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-secondary); font-size: 1.3rem; font-family: 'Oswald'; text-transform: uppercase; letter-spacing: 1px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Merriweather'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); box-shadow: var(--shadow-lg); filter: saturate(0.9) contrast(1); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-secondary); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-history mr-3"></i> <!-- Icono historia -->
                     Archivo: Victoria del Eje
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">// Líneas Temporales Divergentes</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">El Mundo Que Pudo Ser</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Explora escenarios hipotéticos donde el curso de la Segunda Guerra Mundial tomó un rumbo diferente. Analiza las consecuencias de una victoria del Eje.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar escenario o palabra clave...">
             <i class="fas fa-search search-icon"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-folder-open text-red-700 mr-2"></i> <!-- Icono carpeta -->
                 Índice de Escenarios
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Accediendo a los archivos históricos clasificados...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">// Ningún escenario coincide con la consulta //</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Solicitar Más Archivos Divergentes
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Calculando Línea Temporal...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                      <h3 class="text-sm font-semibold uppercase text-gray-400 mb-2 text-center tracking-wider font-sans">Análisis Adicional</h3>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este escenario específico...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Escenario">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Simulaciones generadas por IA con fines especulativos y educativos sobre historia alternativa.</p>
              <p class="mt-1">Los escenarios descritos son hipotéticos y no reflejan eventos reales.</p>
              <p class="mt-2">Archivo Temporal // División de Análisis Contrafactual</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Victorias Militares Clave del Eje
            "Qué pasaría si... Operación León Marino (invasión de UK) tiene éxito en 1940",
            "Qué pasaría si... Alemania captura Moscú en 1941",
            "Qué pasaría si... Japón destruye la flota del Pacífico de EEUU en Pearl Harbor (completo)",
            "Qué pasaría si... Rommel gana la Segunda Batalla de El Alamein y captura Egipto",
            "Qué pasaría si... Alemania gana la Batalla de Stalingrado",
            "Qué pasaría si... La ofensiva del Kursk alemana tiene éxito en 1943",
            "Qué pasaría si... Japón neutraliza a China rápidamente en los años 30",
            "Qué pasaría si... Italia logra mayores éxitos militares en África y el Mediterráneo",
            "Qué pasaría si... La Batalla del Atlántico es ganada decisivamente por los U-Boats",
            "Qué pasaría si... Alemania desarrolla y usa armas nucleares antes que los Aliados",
            "Qué pasaría si... Los jets alemanes (Me 262) dominan los cielos en 1944-45",
            "Qué pasaría si... La Ofensiva de las Ardenas alemana tiene éxito en 1944",
            "Qué pasaría si... El Eje logra coordinar estrategias globales efectivamente",
            "Qué pasaría si... Franco une España al Eje activamente",
            "Qué pasaría si... Turquía se une al Eje",

            // Escenarios Políticos
            "Qué pasaría si... EEUU permanece estrictamente neutral durante toda la guerra",
            "Qué pasaría si... Reino Unido firma una paz negociada con Alemania en 1940/41",
            "Qué pasaría si... La URSS colapsa o firma una paz separada tras las derrotas iniciales",
            "Qué pasaría si... Hay un golpe de estado exitoso contra Hitler antes/durante la guerra",
            "Qué pasaría si... Roosevelt pierde las elecciones de 1940 o 1944",
            "Qué pasaría si... Las potencias del Eje no declaran la guerra a EEUU tras Pearl Harbor",
            "Qué pasaría si... Existe una guerra fría entre una Alemania victoriosa y Japón",
            "Qué pasaría si... Hay una guerra civil en EEUU tras una derrota o invasión parcial",
            "Qué pasaría si... Se forman gobiernos colaboracionistas estables en Europa ocupada",
            "Qué pasaría si... El Pacto Molotov-Ribbentrop se mantiene indefinidamente",
            "Qué pasaría si... La resistencia europea es completamente aplastada",
            "Qué pasaría si... Los países neutrales (Suecia, Suiza) son invadidos por Alemania",
            "Qué pasaría si... El Holocausto se expande globalmente bajo dominio del Eje",
            "Qué pasaría si... Japón establece firmemente la Esfera de Coprosperidad de Asia Oriental",
            "Qué pasaría si... Se crea un 'Nuevo Orden' global dominado por Berlín y Tokio",

            // Escenarios Tecnológicos
            "Qué pasaría si... Las 'Wunderwaffen' (armas maravillosas) alemanas cambian el curso de la guerra",
            "Qué pasaría si... El programa espacial alemán (V2 y sucesores) avanza sin interrupción",
            "Qué pasaría si... La tecnología de submarinos alemanes (Tipo XXI) llega antes y en masa",
            "Qué pasaría si... El Eje desarrolla tecnología informática/criptográfica superior",
            "Qué pasaría si... La tecnología nuclear japonesa avanza significativamente",
            "Qué pasaría si... Se perfeccionan y despliegan armas biológicas o químicas a gran escala",
            "Qué pasaría si... La producción industrial del Eje supera a la de los Aliados",
            "Qué pasaría si... El desarrollo de portaaviones japoneses o alemanes es superior",
            "Qué pasaría si... Se controlan los recursos petroleros clave (Cáucaso, Medio Oriente)",
            "Qué pasaría si... La medicina y la ingeniería genética avanzan bajo la ética nazi",

            // Escenarios Sociales y Culturales
            "Cómo sería la vida diaria en una Norteamérica ocupada por el Eje",
            "El destino de las minorías en un mundo dominado por el Eje",
            "La cultura (arte, cine, música) bajo el control del Tercer Reich y Japón Imperial",
            "El sistema educativo en una Europa dominada por Alemania",
            "El rol de la mujer en la sociedad nazi victoriosa",
            "La propaganda y el control de la información en el 'Nuevo Orden'",
            "Movimientos de resistencia a largo plazo contra el dominio del Eje",
            "El desarrollo económico bajo modelos corporativistas/fascistas",
            "El idioma alemán o japonés como lingua franca global",
            "La religión y la espiritualidad bajo regímenes totalitarios ateos o paganos",
            "Deportes y entretenimiento en un mundo del Eje",
            "Ciudades reconstruidas bajo la arquitectura nazi (Germania)",
            "El impacto psicológico a largo plazo de vivir bajo tiranía",
            "Las relaciones interraciales bajo las leyes de Nuremberg globales",
            "El futuro del sionismo y del pueblo judío",

            // Largo Plazo y Colapso Potencial
            "La estabilidad a largo plazo de un imperio nazi global",
            "Conflictos internos entre Alemania, Japón e Italia por la supremacía",
            "El colapso económico eventual del sistema del Eje",
            "Rebeliones masivas en territorios ocupados décadas después",
            "Una 'Guerra Fría' entre Berlín y Tokio",
            "El desarrollo espacial en una carrera dominada por el Eje",
            "El impacto ambiental de la industrialización desenfrenada del Eje",
            "La posibilidad de una disidencia interna dentro del partido nazi o el ejército japonés",
            "El legado histórico y la memoria de una victoria del Eje",
            "La emergencia de nuevas superpotencias (¿Brasil? ¿India?) contra el Eje",
            // Más escenarios...
             "Qué pasaría si... El Proyecto Manhattan falla o es saboteado",
             "Qué pasaría si... La inteligencia aliada (Ultra/Magic) no descifra los códigos del Eje",
             "Qué pasaría si... Los partisanos soviéticos/yugoslavos son ineficaces",
             "Qué pasaría si... La producción de caucho sintético alemán (Buna) es mucho mayor",
             "Qué pasaría si... El liderazgo aliado (Churchill, Roosevelt, Stalin) comete errores fatales",
             "El destino de América Latina bajo influencia o dominio del Eje",
             "La 'germanización' o 'japonización' de territorios conquistados",
             "Avances en eugenesia y 'Lebensborn' a escala masiva",
             "El control de los océanos por las armadas del Eje",
             "La exploración y colonización de la Antártida por la Alemania nazi",
             "La persistencia de movimientos fascistas/nazis en países 'liberados'",
             "El desarrollo de la energía nuclear con fines pacíficos (o no) por el Eje",
             "La erradicación de la cultura 'degenerada' a nivel mundial",
             "El estado de la ciencia y la investigación bajo control ideológico",
             "El futuro de África bajo planes de colonización del Eje"
             // Se continuará expandiendo... la meta de 400 es ambiciosa pero se intenta cubrir ampliamente
        ];
        const alternateHistoryThemes = [
            "Operación León Marino", "Frente Oriental victoria Eje", "Pearl Harbor éxito total", "Victoria Eje en África", "Tecnología Wunderwaffen", "EEUU neutral", "Paz negociada UK-Alemania", "Colapso URSS", "Mundo dominado por Eje", "Guerra Fría Alemania-Japón", "Vida bajo ocupación nazi/japonesa", "Resistencia contra el Eje", "Holocausto expandido", "Programa nuclear Eje", "Nuevo Orden Mundial", "Japón domina Asia", "Caída de Moscú", "Victoria en Stalingrado", "Jets alemanes dominan", "España se une al Eje", "Futuro tecnológico Eje", "Cultura bajo el fascismo", "Colonización Eje", "Destino minorías", "Arquitectura nazi"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral", // Podría usarse un modelo más potente si se necesita más profundidad
            systemPrompt: "Eres un experto historiador especializado en análisis contrafactual y líneas temporales alternativas, enfocado en escenarios donde las potencias del Eje ganaron la Segunda Guerra Mundial. Basándote *únicamente* en el título del escenario proporcionado, genera una narrativa detallada, plausible y analítica explorando las consecuencias directas e indirectas de esa divergencia. Cubre la reestructuración política global, desarrollos tecnológicos, cambios sociales y culturales, el destino de las naciones involucradas, y la posible trayectoria a largo plazo. Mantén un tono neutral y académico, explorando tanto los aparentes 'éxitos' del Eje como los problemas inherentes, contradicciones o fuentes de inestabilidad. El objetivo es un análisis profundo de aproximadamente 1200-1300 palabras. Escenario:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat, system prompt se sobreescribe
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúa como un asistente de investigación especializado *exclusivamente* en el escenario de historia alternativa titulado '[ESCENARIO ACTUAL]'. Responde preguntas de seguimiento sobre detalles, implicaciones o suposiciones presentadas en la descripción principal de este escenario específico. Sé conciso, relevante y mantente dentro del contexto de esta línea temporal particular.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // *** PROMPT PARA GENERAR 40 TÍTULOS ***
            systemPrompt: "Actúa como un generador de ideas para archivos de historia alternativa. Genera exactamente 40 títulos concisos y distintos de escenarios 'Qué pasaría si...' o puntos de divergencia clave relacionados con una victoria del Eje en la Segunda Guerra Mundial. Cubre aspectos políticos, militares, sociales, tecnológicos o culturales. Devuelve *solo* la lista de títulos, uno por línea. Sin números, introducciones, explicaciones ni despedidas.",
            timeoutSeconds: 60 // Aumentar un poco el timeout por si pide más tiempo para 40
        };

        // ========== DOM ELEMENTS ==========
        // (Sin cambios respecto a la versión anterior, excepto nombres de variables si se prefiere)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Área texto+imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentScenarioTitle = null; // Renombrado para claridad

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             // *** USA EL SYSTEM PROMPT DINÁMICO PARA CHAT ***
             const systemPromptToUse = isChat && currentScenarioTitle
                 ? `Actúa como un asistente de investigación especializado *exclusivamente* en el escenario de historia alternativa titulado '${currentScenarioTitle}'. Responde preguntas de seguimiento sobre detalles, implicaciones o suposiciones presentadas en la descripción principal de este escenario específico. Sé conciso, relevante y mantente dentro del contexto de esta línea temporal particular.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, intenta en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta de nuevo o reformula la pregunta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar los archivos.");
             }
        }
        async function fetchExplanationText(scenarioTitle) {
            return fetchTextFromApi(scenarioTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentScenarioTitle) throw new Error("Error interno: No se ha establecido el contexto del escenario para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true); // true indica que es chat
        }
        // *** MODIFICADO PARA 40 TÍTULOS ***
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(alternateHistoryThemes) || "victoria del Eje general";
            // El system prompt ya pide 40. La API debería devolverlos.
             const specificPrompt = `Genera 40 escenarios sobre ${randomTheme}`; // Prompt simple, la complejidad está en el system prompt
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n')
                                       .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                       .filter(line => line.length > 10 && line.length < 200); // Filtros razonables
                     if (titles.length < 20) { // Esperar al menos la mitad de los solicitados
                         throw new Error("La IA no generó suficientes escenarios nuevos.");
                     }
                     // Devolver hasta 40, aunque la API debería controlar esto
                     return titles.slice(0, 40);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 550, nologo: true }; // Ratio un poco más panorámico
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "alternate history WWII axis victory";
             // Prompt adaptado
             const enhancedPrompt = `Conceptual artwork evoking the alternate history scenario '${safePromptText}' where the Axis won WWII. Style: potentially dystopian, retro-futuristic (Axis tech aesthetic), somber, atmospheric, cinematic lighting. Focus on architecture (brutalist, Speer-like), technology (advanced jets, strange tanks), altered landscapes, or symbolic elements reflecting Axis dominance or subdued resistance. Use a muted color palette (grays, dark reds, olive greens, black). Avoid explicit hate symbols unless abstractly essential. No text, labels. Moody, detailed.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "photorealistic happy people, bright sunny day, modern city skyline, clear swastika, text, words, labels, captions, graphs, charts, diagrams, UI elements, collage, multiple images, watermark, signature, deformed figures";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, ' ');
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (sin cambios estructurales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentScenarioTitle = null; // Limpia el contexto del chat
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden'; }
        function hideFullscreenImage() { /* ... */ if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src=''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios estructurales)
        function addChatMessage(message, sender) { /* ... */ const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() {
             const userQuery = chatInput.value.trim();
             if (!userQuery || chatSendBtn.disabled) return;
             addChatMessage(userQuery, 'user');
             chatInput.value = '';
             chatSendBtn.disabled = true;
             chatLoadingIndicator.style.display = 'block';
             try {
                 const aiResponse = await fetchChatResponse(userQuery);
                 addChatMessage(aiResponse, 'ai');
             } catch (error) {
                 console.error("Chat Error:", error);
                 addChatError(`Error Analista IA: ${error.message}`); // Mensaje de error temático
             } finally {
                 chatLoadingIndicator.style.display = 'none';
                 chatSendBtn.disabled = false;
                 chatInput.focus();
             }
        }

        // ========== UI & EVENT HANDLERS ========== (sin cambios estructurales)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar puede ser útil, pero con tantos títulos, quizás el orden 'natural' de adición está bien.
             // const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (titles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">// No hay escenarios disponibles en este archivo //</p>'; return; }
             titles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-aplicar filtro
         }

        // *** MODIFIED: handleTitleClick (Contexto, placeholder) ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentScenarioTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Placeholder temático
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-film placeholder-icon"></i> <!-- Icono película/archivo -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización del archivo...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Imagen
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de: ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización corrupta o inaccesible.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al acceder al archivo.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFICADO: handleGenerateMoreTitles (Botón texto) ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             // Texto temático
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando Nuevas Divergencias...';
             try {
                 // La función fetchGeneratedTitles ya está configurada para 40
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se encontraron nuevos archivos divergentes en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al solicitar archivos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Solicitar Más Archivos Divergentes';
             }
         }

         // *** Search Filter Function (Con normalización para tildes) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (sin cambios estructurales)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">// ERROR CRÍTICO: Faltan componentes de la interfaz //</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>