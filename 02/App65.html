<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conceptos de Programación para Principiantes</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Using Quicksand and Nunito fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Programación Principiante --- */
        :root {
            --color-primary: #0ea5e9; /* Azul Cielo (Tech, moderno) */
            --color-secondary: #a855f7; /* Púrpura (Creatividad, tech) */
            --color-background: #f1f5f9; /* Gris muy claro (Slate 100) */
            --color-text: #1e2937; /* Gris oscuro (Slate 800) */
            --color-text-muted: #64748b; /* Gris medio (Slate 500) */
            --color-modal-bg: #ffffff;
            --color-border: #cbd5e1; /* Gris claro (Slate 300) */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.6; }
        h1, h2, h3, h4, .logo { font-family: 'Quicksand', sans-serif; font-weight: 700; } /* Fuente amigable para títulos */
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Nunito', sans-serif; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f0f9ff; /* Light sky hover */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #0284c7; /* Darker sky */ box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #94a3b8; /* Slate 400 */ cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(30, 41, 59, 0.85); /* Darker overlay (Slate 800) */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            min-height: 300px; /* <<< ALTURA MÍNIMA CONFIRMADA >>> */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e2e8f0; /* Slate 200 */ border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.5rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #cbd5e1; /* Slate 300 */ color: var(--color-text); }
        #modal-title { color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1.5rem; font-size: 1.8rem; line-height: 1.3; }
        #modal-content { line-height: 1.75; color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 15px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content::-webkit-scrollbar { width: 9px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        /* Estilos para código dentro del texto */
        #modal-content code {
            background-color: #e2e8f0; /* Slate 200 */
            padding: 0.2em 0.4em;
            margin: 0 0.1em;
            font-size: 0.9em;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
            color: #334155; /* Slate 700 */
        }
        #modal-content pre {
            background-color: #f8fafc; /* Slate 50 */
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1em;
            margin: 1.5em 0;
            overflow-x: auto;
            white-space: pre-wrap; /* Allow wrapping */
            word-wrap: break-word; /* Break long lines */
        }
        #modal-content pre code {
            background-color: transparent;
            padding: 0;
            margin: 0;
            font-size: 0.9em;
            color: #1e2937; /* Slate 800 */
            white-space: pre-wrap; /* Ensure wrapping inside pre */
            word-wrap: break-word;
        }
        /* Fin estilos código */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Quicksand', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: bold; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        #modal-image-container { width: 100%; height: 250px; background-color: #e2e8f0; /* Slate 200 */ border-radius: var(--border-radius); overflow: hidden; display: none; align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; margin-top: 1.5rem; }
        #modal-image-container.visible { display: flex; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 3rem; color: #94a3b8; /* Slate 400 */ display: none; } /* Icono Terminal */
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid #cbd5e1; /* Slate 300 */ border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.2rem; font-family: 'Nunito'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fecaca; /* Red 200 */ color: #b91c1c; /* Red 700 */ padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #fca5a5; /* Red 300 */ margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-4 flex justify-center items-center">
             <div class="flex items-center text-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-code mr-3"></i> <!-- Icono de Código -->
                     Programación para Principiantes
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Desbloquea el Mundo del Código</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto">Explora los conceptos fundamentales de la programación explicados de forma clara y sencilla por IA. ¡Elige un tema para empezar tu aventura!</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-file-code text-purple-500 mr-2"></i> <!-- Icono Archivo de Código -->
                 Conceptos Fundamentales
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Buscando algoritmos...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Conceptos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Compilando explicación...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                 </div>
                  <!-- Image Container (Initially Hidden) -->
                 <div id="modal-image-container">
                     <div class="spinner"></div>
                      <i class="fas fa-terminal placeholder-icon"></i> <!-- Icono Terminal -->
                     <img id="modal-image" alt="Visualización abstracta del concepto de programación" />
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i> <!-- O fas fa-bug -->
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-slate-200 text-slate-700 py-6 mt-12 border-t border-slate-300">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA para introducir conceptos de programación. ¡La práctica es clave para aprender!</p>
              <p class="mt-1">Experimenta con código y consulta documentación oficial para profundizar.</p>
              <p class="mt-2">© 2025 Programación Fácil</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Fundamentos Muy Básicos
            "¿Qué es la Programación?", "¿Qué es un Algoritmo?", "Lenguaje de Máquina vs. Lenguaje de Programación", "Compiladores vs. Intérpretes", "¿Qué es el Código Fuente?", "Sintaxis en Programación", "Pseudocódigo: ¿Qué es y para qué sirve?", "Diagramas de Flujo Básicos", "La Consola o Terminal: Tu primera interacción", "¿Qué es un Error de Programación (Bug)?", "Comentarios en el Código: ¿Por qué son importantes?", "Instalación de un Entorno de Desarrollo (Idea General)",
            // Variables y Tipos de Datos
            "¿Qué es una Variable?", "Declaración e Inicialización de Variables", "Tipos de Datos Primitivos: Números Enteros (int)", "Tipos de Datos Primitivos: Números Decimales (float, double)", "Tipos de Datos Primitivos: Cadenas de Texto (string)", "Tipos de Datos Primitivos: Booleanos (true/false)", "Tipos de Datos Primitivos: Caracteres (char)", "Constantes: Variables que no cambian", "Convención de Nombres para Variables (CamelCase, snake_case)", "Tipado Estático vs. Tipado Dinámico", "Conversión de Tipos de Datos (Casting)",
            // Operadores
            "Operadores Aritméticos (+, -, *, /, %)", "Operador Módulo (%): El Resto de la División", "Operadores de Asignación (=, +=, -=, *=, /=)", "Operadores de Comparación (==, !=, >, <, >=, <=)", "Operadores Lógicos (AND, OR, NOT)", "Precedencia de Operadores", "Operadores de Incremento y Decremento (++, --)",
            // Estructuras de Control: Condicionales
            "¿Qué es una Estructura Condicional?", "La Sentencia 'if' (Si... entonces...)", "La Sentencia 'else' (Si no...)", "La Sentencia 'else if' (Si no, si...)", "Condicionales Anidados (if dentro de if)", "El Operador Ternario (Condición ? ValorSiVerdadero : ValorSiFalso)", "La Estructura 'switch' o 'case'",
            // Estructuras de Control: Bucles
            "¿Qué es un Bucle o Ciclo?", "El Bucle 'for': Repetir un número fijo de veces", "El Bucle 'while': Repetir mientras una condición sea verdadera", "El Bucle 'do-while': Ejecutar al menos una vez", "Bucles Infinitos: ¡Cuidado!", "Sentencia 'break': Salir de un bucle", "Sentencia 'continue': Saltar a la siguiente iteración", "Bucles Anidados (for dentro de for)",
            // Estructuras de Datos: Arrays/Listas
            "¿Qué es un Array (Arreglo o Vector)?", "Declaración y Acceso a Elementos de un Array (Índices)", "Índices basados en Cero (0-based indexing)", "Recorrer un Array con un Bucle 'for'", "Arrays Multidimensionales (Matrices)", "Listas Dinámicas (Concepto básico)", "Operaciones Comunes en Arrays/Listas (Añadir, Eliminar, Buscar - Idea)",
            // Funciones / Métodos
            "¿Qué es una Función (o Método)?", "Ventajas de usar Funciones (Reutilización, Organización)", "Declarar una Función", "Llamar (Invocar) a una Función", "Parámetros y Argumentos de una Función", "Valor de Retorno ('return')", "Ámbito (Scope) de las Variables: Locales vs. Globales", "Funciones sin Parámetros y sin Retorno", "Funciones Recursivas (Idea básica)", "Funciones Predefinidas o de Biblioteca",
            // Introducción a la Programación Orientada a Objetos (POO)
            "¿Qué es la Programación Orientada a Objetos (POO)?", "Clases: Plantillas para Objetos", "Objetos: Instancias de una Clase", "Atributos (Propiedades) de un Objeto", "Métodos (Comportamientos) de un Objeto", "El concepto de 'self' o 'this' (Idea básica)", "Encapsulamiento (Idea básica)", "Herencia (Idea básica)", "Polimorfismo (Idea básica)", "Constructores: Inicializar Objetos",
            // Entrada y Salida (Input/Output)
            "Mostrar Mensajes en Pantalla (Salida Estándar)", "Leer Datos del Usuario (Entrada Estándar)", "Trabajar con Archivos (Abrir, Leer, Escribir - Idea básica)",
            // Introducción a la Web (Muy Básico)
            "¿Qué es HTML? (Estructura)", "Etiquetas HTML básicas (h1, p, a, img)", "¿Qué es CSS? (Estilo)", "Selectores CSS básicos (elemento, clase, id)", "¿Qué es JavaScript? (Comportamiento)", "Interactividad básica con JavaScript (Eventos de clic - Idea)", "Cliente vs. Servidor (Concepto)", "¿Qué es una API? (Idea muy básica)",
            // Herramientas y Conceptos Generales
            "¿Qué es un IDE (Entorno de Desarrollo Integrado)?", "Editores de Código Populares", "Depuración (Debugging): Encontrar y Corregir Errores", "Puntos de Interrupción (Breakpoints)", "Control de Versiones: ¿Qué es Git?", "Repositorios (GitHub, GitLab - Idea)", "Comandos básicos de Git (commit, push, pull - Idea)", "La Importancia de la Documentación", "Buenas Prácticas de Programación (Nombres descriptivos, código limpio)", "Refactorización: Mejorar el Código Existente", "Pruebas Unitarias (Idea muy básica)",
            // Paradigmas y Conceptos Abstractos
            "Programación Procedural", "Programación Orientada a Eventos (Idea)", "Programación Funcional (Idea muy básica)", "Abstracción en Programación", "Modularidad", "Complejidad Algorítmica (Idea muy básica - Big O Notation)", "Algoritmos de Búsqueda Simples (Lineal)", "Algoritmos de Ordenación Simples (Burbuja - Idea)",
            // Errores Comunes
            "Errores de Sintaxis", "Errores Lógicos", "Errores en Tiempo de Ejecución (Runtime Errors)", "El valor 'null' o 'undefined'", "Desbordamiento de Búfer (Buffer Overflow - Concepto)", "Condiciones de Carrera (Race Conditions - Concepto muy básico)",
            // Siguientes Pasos
            "Cómo Elegir tu Primer Lenguaje de Programación", "Recursos para Aprender a Programar (Cursos, Libros, Comunidades)", "La Importancia de Construir Proyectos Personales", "¿Qué es el Desarrollo Frontend?", "¿Qué es el Desarrollo Backend?", "¿Qué es el Desarrollo Fullstack?", "Introducción a Bases de Datos (SQL vs NoSQL - Idea)"
             // ... (Lista extensa, cercana a 200, ampliable con 'Generar Más')
        ];
        const programmingThemes = [
            "conceptos básicos de programación", "variables y tipos de datos", "operadores en programación",
            "estructuras de control condicionales", "bucles y ciclos", "arrays y listas",
            "funciones y métodos", "introducción a la POO", "entrada y salida de datos",
            "fundamentos de desarrollo web", "herramientas para programadores", "control de versiones con Git",
            "debugging y errores comunes", "paradigmas de programación", "algoritmos sencillos",
            "buenas prácticas de codificación", "estructura de datos básicas", "conceptos de algoritmos",
            "interacción con el usuario", "manejo de texto (strings)"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un tutor de programación paciente y experto, especializado en explicar conceptos a principiantes absolutos. Tu tarea es explicar el siguiente concepto de programación de forma extremadamente clara, sencilla, detallada y motivadora. Usa analogías del mundo real fáciles de entender. Proporciona ejemplos de código simples y claros (preferiblemente en pseudocódigo o un lenguaje común como Python o JavaScript, indicando cuál usas) para ilustrar cada punto clave. Utiliza formato Markdown para el código (\`\`\` lenguaje\n código \n\`\`\`). Desglosa el concepto en pasos lógicos. Estructura la explicación con párrafos cortos y subtítulos (usando markdown #, ##, ###). El objetivo es una explicación muy completa y fácil de seguir, de aproximadamente 1200-1300 palabras, que anime al principiante a seguir aprendiendo. Basa tu explicación únicamente en el siguiente concepto:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un curso de programación nivel 0. Genera exactamente 15 conceptos o preguntas clave sobre programación para principiantes absolutos. Devuelve *solo* la lista de conceptos/preguntas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // --- Variable to hold the current scroll listener --- (Sin cambios)
        let currentScrollHandler = null;

        // ========== API FUNCTIONS ========== (Sin cambios en la lógica, solo prompts actualizados arriba)
        async function fetchTextFromApi(prompt, config) {
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo.`);
                 throw new Error(`Error de comunicación con la API: ${error.message}`);
             }
        }
        async function fetchExplanationText(conceptTitle) {
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              // Ajustar longitud mínima si es necesario, aunque 1200 es el objetivo
              if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de")) {
                   throw new Error("La IA no pudo generar una explicación adecuada o suficientemente detallada para este concepto.");
               }
             return text;
         }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(programmingThemes) || "conceptos fundamentales de programación";
             const specificPrompt = `Genera 15 conceptos o preguntas clave sobre ${randomTheme} para principiantes`;
             console.log("Generating titles with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150);
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de conceptos.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "beginner programming concept abstract";
             // Prompt para imagen abstracta de programación
             const enhancedPrompt = `Abstract visualization of the programming concept '${safePromptText}'. Use geometric shapes, connecting lines, flowing data streams, logical patterns, binary code motif (stylized), circuit board patterns (abstract). Clean, minimalist, modern tech aesthetic. Focus on structure and logic.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Negative prompt para evitar cosas literales o feas
             const negativePrompt = "text, words, code snippets, variable names, specific programming language logo, realistic computer, keyboard, mouse, person typing, office, complex flowchart, ugly diagram, messy lines, handwriting, error message text, cartoon character";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (Añade manejo básico de bloques de código)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();

            // --- ORDERED REPLACEMENTS ---

            // 1. Handle Code Blocks (```lang\ncode``` or ```\ncode```) FIRST
            // Use non-greedy match .*? and the 's' flag for dot to match newlines
            formatted = formatted.replace(/```(\w+)?\s*\n([\s\S]*?)\n```/gs, (match, lang, code) => {
                // Basic escaping of HTML within code, though ideally syntax highlighting library would handle this
                const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                // If language is specified, add class for potential future highlighting
                const langClass = lang ? ` class="language-${lang}"` : '';
                return `<pre><code${langClass}>${escapedCode.trim()}</code></pre>`;
            });

            // 2. Handle Inline Code (`code`) - After block code
             formatted = formatted.replace(/`([^`]+?)`/g, '<code>$1</code>');


            // 3. LaTeX-like elements (Less likely needed, but kept for robustness)
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); // Unlikely, but handles it

            // 4. Markdown Headings (multiline mode) - After code blocks
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');

            // 5. Markdown Bold/Italics - After headings and inline code
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Be careful with italics not to match inside URLs or code if not handled properly before
            formatted = formatted.replace(/(?<!`)\*(?!\s)(.*?)(?<!\s)\*(?!`)/g, '<em>$1</em>'); // Basic italic, avoid spaces, avoid inside backticks


            // 6. Handle Paragraphs (split by double newline AFTER other block elements)
            // Make sure not to split inside <pre> blocks
            const placeholder = '%%%PRE_BLOCK%%%';
            const preBlocks = [];
            formatted = formatted.replace(/<pre>[\s\S]*?<\/pre>/g, (match) => {
                preBlocks.push(match);
                return placeholder;
            });

            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                 // If it's already a heading, formula, or placeholder keep it
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">') || block.includes(placeholder)) {
                    return block;
                 }
                // Otherwise, wrap in <p> and handle internal newlines as <br>
                let content = block.replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');

             // Restore pre blocks
             preBlocks.forEach(preBlock => {
                 formatted = formatted.replace(placeholder, preBlock);
             });


            return formatted;
        }


        // ========== MODAL FUNCTIONS ========== (Sin cambios en la lógica, usa el CSS corregido)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }

        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll
            console.log("Scroll set to 0 on hideModal");
            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
                console.log("Scroll listener removed on hideModal.");
            }
            resetModalState();
        }

        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.classList.remove('visible');
             modalImageContainer.style.display = 'none';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (Sin cambios en la lógica del scroll/imagen)
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
            if (!titleListContainer || !titlesLoading) return;
            const shuffledTitles = shuffleArray([...titles]);
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay conceptos disponibles.</p>'; return; }
            shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalImageContainer.style.display = 'none';
            modalImageContainer.classList.remove('visible');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
            }

            try {
                const rawExplanationText = await fetchExplanationText(title);
                // <<< Usa la función de formateo actualizada >>>
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation; // Inject formatted HTML
                modalStoryContentArea.classList.remove('content-hidden');

                modalContent.scrollTop = 0; // Reset scroll after content visible
                console.log("Scroll set to 0 after content visible");

                // Prepare image (hidden)
                modalImageSpinner.style.display = 'block';
                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL:", title);
                     modalImageSpinner.style.display = 'none';
                     modalImagePlaceholder.style.display = 'block';
                 }

                // Setup scroll listener for conditional image visibility
                const scrollBuffer = 20;
                currentScrollHandler = () => {
                    const isScrollable = modalContent.scrollHeight > modalContent.clientHeight;
                    const isAtBottom = (modalContent.scrollTop + modalContent.clientHeight) >= (modalContent.scrollHeight - scrollBuffer);

                    if (!isScrollable || isAtBottom) {
                         if (!modalImageContainer.classList.contains('visible')) {
                             console.log(`Showing image. Scrollable: ${isScrollable}, At Bottom: ${isAtBottom}`);
                             modalImageContainer.classList.add('visible');
                             modalImageContainer.style.display = 'flex';
                         }
                         if ((isScrollable || !isScrollable) && currentScrollHandler) {
                            modalContent.removeEventListener('scroll', currentScrollHandler);
                            currentScrollHandler = null;
                            console.log("Scroll listener removed.");
                         }
                     }
                };
                modalContent.addEventListener('scroll', currentScrollHandler);
                console.log("Scroll listener added.");
                setTimeout(currentScrollHandler, 150); // Initial check

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error al cargar la explicación: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = ''; // Clear on error
                 if (currentScrollHandler) {
                    modalContent.removeEventListener('scroll', currentScrollHandler);
                    currentScrollHandler = null;
                 }
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block';
                 } else {
                     alert("No se pudieron generar nuevos conceptos en este momento.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar conceptos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Conceptos';
             }
         }


        // ========== INITIALIZATION ========== (Sin cambios)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p>Error crítico inicializando la aplicación.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>