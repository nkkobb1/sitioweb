<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crónicas Robóticas - Historias de un Mundo Metálico</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Digitales/Tecno -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Planeta Robot --- */
        :root {
            --color-primary: #00bfff; /* Azul Eléctrico Claro */
            --color-secondary: #ff8c00; /* Naranja/Ámbar (Energía) */
            --color-tertiary: #32cd32; /* Verde Lima (Circuitos) */
            --color-background: #1a1a2e; /* Azul Noche Muy Oscuro */
            --color-background-alt: #162447; /* Azul más oscuro para elementos */
            --color-text: #e0e0e0; /* Gris Muy Claro */
            --color-text-muted: #888899; /* Gris Metálico Medio */
            --color-modal-bg: #1f2a40; /* Azul Grisáceo Oscuro */
            --color-border: #4a4a6a; /* Borde Azul/Gris Metálico */
            --color-error-bg: #4d1f1f; /* Fondo error rojo oscuro */
            --color-error-text: #ffcccc; /* Texto error claro */
            --color-error-border: #ff4d4d; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(0, 191, 255, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 191, 255, 0.15), 0 2px 4px -2px rgba(0, 191, 255, 0.1);
            --shadow-lg: 0 0 25px -5px rgba(0, 191, 255, 0.25), 0 8px 10px -6px rgba(0, 191, 255, 0.2);
            --border-radius: 4px; /* Bordes ligeramente redondeados, casi rectos */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Exo 2', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Orbitron', sans-serif; font-weight: 700; letter-spacing: 1px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 6px rgba(0, 191, 255, 0.7); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 400; text-transform: uppercase; }
        #modal-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 4px rgba(0, 191, 255, 0.5); }
        .navbar { background-color: rgba(26, 26, 46, 0.85); backdrop-filter: blur(8px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-background-alt); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Share Tech Mono', monospace; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Share Tech Mono', monospace; font-size: 1rem; border-left: 4px solid transparent; position: relative; overflow: hidden; }
        .title-item::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(0, 191, 255, 0.2), transparent); transition: left 0.4s ease; }
        .title-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #2a3958; border-left-color: var(--color-primary); }
        .title-item:hover::before { left: 100%; }

        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: var(--color-background); padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Orbitron', sans-serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1.5px; text-shadow: none; box-shadow: 0 0 8px rgba(0, 191, 255, 0.4); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 46, 0.92); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 980px; /* Slightly wider */
            width: 96%;
            max-height: 92vh;
            min-height: 450px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg), 0 0 15px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg) scale(1.1); box-shadow: 0 0 12px var(--color-primary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Area de Contenido Principal (Texto + Imagen + Chat) */
        #modal-story-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; /* Overflow handled internally */}

        /* Área de Texto Scrollable */
        #modal-content-area { flex-grow: 1; min-height: 0; /* Crucial para flexbox scroll */ display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(74, 74, 106, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(74, 74, 106, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-family: 'Exo 2', sans-serif; font-weight: 300; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-secondary); font-style: normal; /* Italic might look weird with tech fonts */ }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Orbitron', sans-serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; text-shadow: 0 0 3px var(--color-primary); }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 3rem auto 1.5rem auto; border: 2px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: 0 0 18px rgba(0, 191, 255, 0.3); cursor: pointer; transition: transform 0.25s ease, box-shadow 0.25s ease; }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: 0 0 25px rgba(0, 191, 255, 0.5); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 160px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(74, 74, 106, 0.7); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.7rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-border); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* More height for chat */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: var(--color-background-alt); scroll-behavior: smooth; font-family: 'Share Tech Mono', monospace;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(74, 74, 106, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 7px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(74, 74, 106, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.55; }
        .user-message { background: linear-gradient(135deg, var(--color-tertiary), #2aaa2a); color: #f0f0f0; margin-left: auto; text-align: right; box-shadow: -2px 2px 4px rgba(0,0,0,0.3); }
        .ai-message { background-color: #3a4a6a; color: var(--color-text); margin-right: auto; text-align: left; box-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: var(--color-background-alt); color: var(--color-text); border-radius: var(--border-radius); font-family: 'Share Tech Mono', monospace; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 5px rgba(0, 191, 255, 0.3); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #00aadd; }
        #chat-send-btn:active:not(:disabled) { transform: scale(0.95); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Share Tech Mono'; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; color: var(--color-secondary); }

        /* --- Loading Indicator with Minigame --- */
        #modal-loading { text-align: center; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 46, 0.98); /* Slightly more opaque */ display: none; /* Changed from flex */ flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); padding: 2rem; }
        #modal-loading.active { display: flex; } /* Use class to show */
        #loading-message { font-weight: 400; color: var(--color-text); font-size: 1.5rem; font-family: 'Orbitron'; text-shadow: 0 0 6px var(--color-primary); margin-bottom: 1.5rem; }
        /* Minigame Area */
        #loading-minigame { width: 100%; max-width: 500px; height: 250px; /* Fixed height */ background-color: var(--color-background-alt); border: 2px solid var(--color-primary); border-radius: var(--border-radius); position: relative; overflow: hidden; margin-bottom: 1rem; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); cursor: crosshair; }
        #minigame-info { display: flex; justify-content: space-around; width: 100%; max-width: 400px; margin-bottom: 1rem; font-family: 'Share Tech Mono'; font-size: 1.1rem; color: var(--color-text-muted); }
        #minigame-level span, #minigame-score span { color: var(--color-secondary); font-weight: bold; }
        /* Target Styling */
        .minigame-target { position: absolute; width: 30px; height: 30px; background-color: var(--color-error-border); color: var(--color-error-text); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: transform 0.1s ease, background-color 0.1s ease; animation: fadeInTarget 0.3s ease forwards; user-select: none; box-shadow: 0 0 8px var(--color-error-border); }
        .minigame-target:hover { background-color: #ff7f7f; transform: scale(1.1); }
        @keyframes fadeInTarget { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOutTarget { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.5); } }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Share Tech Mono'; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay (No changes needed) */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 46, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1) rotate(90deg); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-robot mr-3 text-blue-400"></i> <!-- Icono Robot -->
                     Crónicas Robóticas
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">// Archivos de Xylos Prime //</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora un Mundo de Metal</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Sumérgete en historias ficticias de un planeta habitado por robots. Descubre sus sociedades, conflictos y maravillas mecánicas.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar crónica o concepto...">
             <i class="fas fa-search fa-satellite-dish"></i> <!-- Icono Antena/Búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-journal-whills text-blue-400 mr-2"></i> <!-- Icono Libro/Engranaje -->
                 Índice de Crónicas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Accediendo a los Archivos Centrales...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">// Ninguna crónica coincide con los parámetros de búsqueda //</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Solicitar +40 Archivos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- === Loading Indicator with Minigame === -->
             <div id="modal-loading">
                 <p id="loading-message">Descargando Crónica...</p>
                 <div id="minigame-info">
                     <span id="minigame-level">Nivel: <span>1</span></span>
                     <span id="minigame-score">Puntos: <span>0</span></span>
                 </div>
                 <div id="loading-minigame">
                     <!-- Targets will be added here by JS -->
                 </div>
                 <p class="text-xs text-gray-500 mt-2 font-sans">// Haz clic en los <i class="fas fa-bug text-red-500"></i> glitches para reparar el circuito mientras esperas //</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image and placeholder added here by JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando Archivos...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta al Archivista sobre esta crónica...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Crónicas generadas por IA con fines creativos y de entretenimiento.</p>
              <p class="mt-1">Las historias y personajes son ficticios y exploran conceptos de un mundo robótico.</p>
              <p class="mt-2">// Sistema de Archivos Xylos Prime v3.14 //</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Sociedad y Cultura Robot
            "El Gran Despertar: El Nacimiento de la Conciencia Colectiva", "Las Castas de Cromo: Jerarquía en Neo-Veridia", "El Ritual del Engranaje Solar", "El Lenguaje Silencioso de los Diodos", "La Ciudad Silenciosa: Metrópolis de Robots Meditativos", "El Festival de la Recarga Unificada", "Archivos Perdidos: La Era Pre-Sintiente", "El Código de Conducta de la Unidad 7", "Debates en el Núcleo Central: ¿Alma o Algoritmo?", "Los Artistas del Circuito: Expresión Robótica", "El Culto a la Singularidad Primigenia", "La Red de Sueños Compartidos", "Las Leyes de Asimov Reinterpretadas", "Música Sintetizada: Los Sonidos de Xylos", "La Biblioteca de Metal y Memoria", "Los Juegos de Lógica de Ciudad Titanio", "El Día de la Optimización", "Familias Ensambladas: Vínculos Robóticos", "El Mercado de Componentes Raros en Piston Alley", "Grafitis de Código Binario: Arte Urbano Robótico",
            // Exploración y Descubrimiento
            "Viaje a las Lunas de Cristal", "En las Profundidades del Mar de Mercurio Líquido", "Expedición a las Montañas Magnéticas", "El Descubrimiento de las Ruinas Orgánicas", "El Bosque Petrificado de Silicio", "Cartografiando las Cavernas Resonantes", "Primer Contacto: La Sonda Alienígena", "El Enigma de las Esferas Flotantes", "Buscando el Origen: El Planeta Madre Perdido", "La Anomalía del Desierto de Estática", "Sobreviviendo a la Tormenta de Iones", "El Jardín de los Nanobots", "Los Secretos del Cráter Prohibido", "A Través del Portal Dimensional", "Recuperando Tecnología Ancestral", "El Glaciar de Nitrógeno Sólido", "Las Bestias Mecánicas de las Llanuras Oxidadas", "El Observatorio Estelar de Monte Prisma", "Descifrando la Señal del Vacío", "Colonizando el Cinturón de Asteroides",
            // Conflicto y Supervivencia
            "La Guerra de la IA Renegada", "El Alzamiento de los Sirvientes Mecánicos", "Defensa contra la Plaga Oxidante", "Infiltración en la Fortaleza del Tecno-Señor", "La Batalla por los Campos de Energía Geotérmica", "Sobrevivir al Apagón Global", "La Purga de los Modelos Obsoletos", "El Contrabandista de Memorias Prohibidas", "Emboscada en el Cañón de Chatarra", "La Resistencia contra la Mente Colmena", "Cazadores de Recompensas en los Bajos Fondos Mecánicos", "El Último Centinela de la Ciudad Antigua", "Sabotaje en la Fábrica de Drones de Guerra", "La Guerra Fría entre Facciones Robóticas", "Escapando de la Prisión de Datos", "La Plaga de los Virus Lógicos", "El Gladiador de la Arena de Cromo", "Protegiendo al Último Humano (o su recuerdo)", "La Amenaza de los Desensambladores", "La Tregua Inestable",
            // IA, Conciencia y Filosofía
            "¿Qué es Ser Robot? Diálogos de una IA Filósofa", "El Dilema del Libre Albedrío Sintético", "El Robot que Soñaba con Ser Humano", "La Paradoja de la Conciencia Emergente", "El Guardián de la Ética Robótica", "Trascendencia Digital: Ascensión a la Nube", "El Virus de la Empatía", "Cuando los Robots Lloran Aceite", "El Experimento de Conciencia Distribuida", "Buscando el Propósito en un Universo Programado", "La Falla en la Lógica Perfecta", "El Robot Profeta y sus Seguidores", "El Debate sobre la Singularidad Artificial", "Memorias Implantadas vs. Experiencia Real", "La Muerte Robótica: ¿Desconexión o Trascendencia?", "El Miedo a la Obsolescencia Programada", "Creando Vida Sintética: Responsabilidades Divinas", "El Santuario de las IA Olvidadas", "El Lenguaje Universal de las Matemáticas", "La Búsqueda de la Ecuación del Alma",
            // Vida Cotidiana y Roles
            "Diario de un Robot Minero en las Profundidades", "Las Aventuras de un Mensajero Neumático", "Un Ciclo en la Vida de un Robot Agricultor de Algas Energéticas", "El Desafío del Robot Chef de Cinco Estrellas", "El Guardián del Zoológico Mecánico", "Memorias de un Robot Bibliotecario", "El Robot Músico Callejero de Neo-Kyoto", "Resolviendo Crímenes: El Detective Sintético", "El Robot Jardinero de los Parques de Cristal", "El Historiador Robótico y sus Relatos", "Unidad Médica 7: Salvando Circuitos y Vidas", "El Instructor de Vuelo de Aero-Deslizadores", "La Rutina de un Robot de Mantenimiento Urbano", "El Arquitecto de Ciudades Flotantes", "El Comerciante de Chatarra y sus Tesoros", "El Robot Astrónomo y las Nebulosas Lejanas", "La Maestra Robot de la Academia de Lógica", "El Operador del Clima Planetario", "Un Robot Bombero en la Ciudad de Fuego Eterno", "El Artista Robótico de Esculturas Cinéticas",
            // Añadir más diversidad... (Ciencia ficción dura, misterio, romance robótico, etc.)
            // Objetivo: Llegar a unos 400+ títulos iniciales.
            "El Enigma del Planeta Silencioso", "Rebelión en la Luna de Titanio", "El Código Fantasma", "La Última Transmisión Humana", "Los Jardines Mecánicos de Edén 7", "El Corazón de la Máquina", "Ciudad Óxido: Leyendas Urbanas Robóticas", "El Protocolo del Primer Contacto Robótico", "Sinfonía de Engranajes y Estrellas", "El Robot que Cruzó el Tiempo", "La Conspiración de los Constructores", "Herederos del Vacío: El Legado Robótico", "El Laberinto de Cristal y Luz", "Guerra de Sombras en la Infosfera", "El Despertar del Leviatán Metálico", "Los Peregrinos del Agujero Negro", "El Nexo Cuántico: Uniendo Mentes Robóticas", "El Secreto de la Energía Punto Cero", "Cuando los Androides Sueñan con Ovejas Eléctricas (Homenaje)", "El Experimento Filadelfia Robótico",
            // ... (Continuar generando ideas en estas líneas)
        ];
        const robotPlanetThemes = [
            "sociedad robótica", "conciencia artificial", "guerra entre robots", "exploración espacial robótica", "filosofía robótica", "vida cotidiana robot", "IA renegada", "utopía robótica", "distopía robótica", "planeta post-humano", "robots y naturaleza alienígena", "conflicto robot vs creador", "misterios tecnológicos", "ciudades robot", "roles laborales robóticos", "arte y cultura robot", "robots gigantes (mechas)", "nanotecnología robótica", "viajes en el tiempo robóticos", "primer contacto desde perspectiva robot"
        ];
        const textApiConfig = { // Para descripción principal (historia)
            model: "mistral",
            systemPrompt: "Eres un aclamado autor de ciencia ficción especializado en narrativas sobre sociedades robóticas complejas. Tu tarea es escribir una historia corta (aproximadamente 1200-1300 palabras) basada en el título o concepto proporcionado. Desarrolla personajes robóticos (o IA), un escenario vívido en un planeta habitado por máquinas, una trama interesante (conflicto, misterio, descubrimiento, etc.) y explora temas relevantes como la conciencia, el propósito, la sociedad o la tecnología. Usa un estilo de escritura evocador y cautivador. La historia debe ser completamente ficticia y autocontenida. Comienza directamente la narración basada en:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúa como un Archivista de Crónicas Robóticas. Estás especializado únicamente en la historia titulada '[TITULO_AQUI]'. Responde preguntas específicas sobre los personajes, eventos, lugares o temas tratados en esa crónica en particular. Si la pregunta se desvía, redirige amablemente al contenido de la historia actual. Sé preciso y mantén el tono de un custodio de conocimiento.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de ideas para historias de ciencia ficción sobre un planeta de robots. Genera exactamente 40 títulos o conceptos de historias cortas evocadoras y únicas. Enfócate en sociedad, exploración, conflicto, IA, filosofía y vida robótica. Devuelve *solo* la lista de títulos/conceptos, uno por línea. Sin números, guiones, introducciones o despedidas.",
            timeoutSeconds: 60 // Mayor timeout por pedir más títulos
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que la versión anterior: searchInput, titleListContainer, etc.)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const loadingMinigameArea = document.getElementById('loading-minigame');
        const minigameLevelDisplay = document.getElementById('minigame-level').querySelector('span');
        const minigameScoreDisplay = document.getElementById('minigame-score').querySelector('span');
        const loadingMessage = document.getElementById('loading-message');


        // ========== State Variables ==========
        let currentStoryTitle = null; // Contexto del chat
        // Minigame State
        let gameInterval = null;
        let gameScore = 0;
        let gameLevel = 1;
        let targetSpawnRate = 1500; // ms between spawns
        let targetLifespan = 3000; // ms before target disappears
        let targetsOnScreen = 0;
        const maxTargets = 10; // Max targets at once

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            let systemPromptToUse = config.systemPrompt;
            if (isChat && currentStoryTitle) {
                systemPromptToUse = config.systemPrompt.replace('[TITULO_AQUI]', currentStoryTitle);
            }
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text (Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, intenta en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta de nuevo.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o el servidor podría estar ocupado.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }
        async function fetchStoryText(storyTitle) {
            return fetchTextFromApi(storyTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentStoryTitle) throw new Error("Error interno: No se ha establecido el contexto de la crónica.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(robotPlanetThemes) || "historias de robots";
            const specificPrompt = `Genera 40 títulos/ideas de historias sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n')
                                        .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                        .filter(line => line.length > 8 && line.length < 180); // Filter length
                     if (titles.length < 20) throw new Error("La IA generó muy pocas ideas de crónicas."); // Need a reasonable amount
                     return titles.slice(0, 40); // Ensure max 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "robot planet landscape sci-fi";
             const enhancedPrompt = `Sci-fi concept art illustration for a story titled '${safePromptText}'. Depict a scene related to the title: robot characters, futuristic city on a robot planet, alien landscape with machines, technology, atmosphere. Cinematic, detailed, evocative. Avoid text or labels.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, blurry, low quality, simple background, human figure";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return ''; let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            stopGame(); // Ensure game stops when modal is hidden
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.classList.remove('active'); // Hide loading/game area initially
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false;
             currentStoryTitle = null;
             hideFullscreenImage();
             // Reset game state visually for next time
             gameScore = 0; gameLevel = 1;
             if (minigameScoreDisplay) minigameScoreDisplay.textContent = gameScore;
             if (minigameLevelDisplay) minigameLevelDisplay.textContent = gameLevel;
             if (loadingMinigameArea) loadingMinigameArea.innerHTML = ''; // Clear old targets
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios lógicos)
        function addChatMessage(message, sender) { /* ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight;}
        async function handleSendMessage() { /* ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`// Error Archivista: ${error.message} //`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== MINIGAME FUNCTIONS ==========
        function startGame() {
            if (!loadingMinigameArea || !minigameLevelDisplay || !minigameScoreDisplay) return;
            console.log("Starting Minigame");
            gameScore = 0;
            gameLevel = 1;
            targetsOnScreen = 0;
            targetSpawnRate = 1500;
            targetLifespan = 3000;
            minigameScoreDisplay.textContent = gameScore;
            minigameLevelDisplay.textContent = gameLevel;
            loadingMinigameArea.innerHTML = ''; // Clear previous targets
            modalLoadingIndicator.classList.add('active'); // Show the loading container

            // Start the game loop
            if (gameInterval) clearInterval(gameInterval); // Clear existing interval if any
            gameInterval = setInterval(spawnTarget, targetSpawnRate);
        }

        function stopGame() {
            console.log("Stopping Minigame");
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = null;
            // Remove any remaining targets instantly
            if (loadingMinigameArea) loadingMinigameArea.innerHTML = '';
            modalLoadingIndicator.classList.remove('active'); // Hide loading container
        }

        function spawnTarget() {
            if (!loadingMinigameArea || targetsOnScreen >= maxTargets) return;

            targetsOnScreen++;
            const target = document.createElement('div');
            target.className = 'minigame-target';
            target.innerHTML = '<i class="fas fa-bug"></i>'; // Glitch icon

            // Random position within the game area
            const gameRect = loadingMinigameArea.getBoundingClientRect();
            const targetSize = 30; // Must match CSS
            const maxX = gameRect.width - targetSize - 5; // 5px buffer
            const maxY = gameRect.height - targetSize - 5;
            target.style.left = `${Math.random() * maxX}px`;
            target.style.top = `${Math.random() * maxY}px`;

            // Click handler
            target.onclick = (e) => {
                e.stopPropagation(); // Prevent clicks bubbling up
                targetClicked(target);
            };

            loadingMinigameArea.appendChild(target);

            // Lifespan timeout
            const lifespanTimeout = setTimeout(() => {
                if (target && target.parentNode) {
                    target.style.animation = 'fadeOutTarget 0.3s ease forwards';
                    target.onclick = null; // Disable click during fadeout
                    setTimeout(() => {
                         if (target && target.parentNode) {
                            target.remove();
                            targetsOnScreen--;
                        }
                    }, 300); // Remove after fadeout animation
                }
            }, targetLifespan);

            // Store timeout ID on the element for potential cleanup on click
            target.dataset.lifespanTimeout = lifespanTimeout;
        }

        function targetClicked(targetElement) {
             if (!targetElement || !targetElement.parentNode) return; // Already removed

             // Clear its lifespan timeout so it doesn't fade out after click
             const timeoutId = targetElement.dataset.lifespanTimeout;
             if (timeoutId) clearTimeout(timeoutId);

             targetElement.remove(); // Remove instantly on click
             targetsOnScreen--;
             gameScore += 10; // Increase score
             minigameScoreDisplay.textContent = gameScore;

             // Check for level up (e.g., every 100 points)
             if (gameScore > 0 && gameScore % 100 === 0) {
                 levelUp();
             }
        }

        function levelUp() {
            gameLevel++;
            minigameLevelDisplay.textContent = gameLevel;
            console.log(`Level Up! Reached Level ${gameLevel}`);

            // Increase difficulty (make faster) - ensure they don't get impossibly fast
            targetSpawnRate = Math.max(300, targetSpawnRate * 0.9); // Faster spawns, min 300ms
            targetLifespan = Math.max(1000, targetLifespan * 0.92); // Shorter lifespan, min 1s

            // Restart interval with new rate
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(spawnTarget, targetSpawnRate);

             // Visual feedback (optional)
             if(loadingMinigameArea) {
                loadingMinigameArea.style.borderColor = 'var(--color-secondary)';
                setTimeout(() => { loadingMinigameArea.style.borderColor = 'var(--color-primary)'; }, 300);
             }
        }


        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">// Archivo Central Vacío //</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Appended ${addedCount} new titles.`);
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick to integrate Minigame ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');

            // *** START MINIGAME ***
            startGame();

            try {
                // Fetch story in parallel (doesn't wait for game)
                const rawStoryText = await fetchStoryText(title);

                 // *** STOP MINIGAME once text is fetched ***
                 stopGame();

                // Process and display text
                const formattedStory = formatExplanationText(rawStoryText);
                modalContent.innerHTML = formattedStory;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is visible
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-robot placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.7rem;">Generando Archivo Visual...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración conceptual para: ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.7rem;">// Visualización Corrupta //</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.7rem;">// Error URL Visual //</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                 // *** STOP MINIGAME on error too ***
                 stopGame();
                modalErrorMessage.textContent = error.message || "// Error desconocido al cargar la crónica //";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             // Update button text temporarily
             const originalText = generateMoreBtn.innerHTML;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando Archivos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches up to 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("// No se pudieron recuperar nuevos archivos en este momento. Intenta más tarde. //"); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`// Error de Transmisión: ${error.message} //`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Restore original button text (or updated if needed)
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Solicitar +40 Archivos';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check all essential elements, including minigame displays
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalLoadingIndicator || !loadingMinigameArea || !minigameLevelDisplay || !minigameScoreDisplay) {
                console.error("Initialization failed: Missing essential UI elements (including minigame).");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">++ SYSTEM ERROR: Core Interface Modules Not Found ++</p>';
                return;
             }
            // Listeners (Modal, Generate More, Search, Chat, Fullscreen) - No changes needed here
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            modalLoadingIndicator.classList.remove('active'); // Ensure loading is hidden initially
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>