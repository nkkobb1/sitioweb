<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecos de Tolstoi - Generador de Cuentos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Clásicas/Literarias -->
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,600;1,400&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Ecos de Tolstoi --- */
        :root {
            --color-primary: #8B4513; /* Marrón Silla de Montar (Madera, Tierra) */
            --color-secondary: #A0522D; /* Siena (Tono cálido) */
            --color-tertiary: #556B2F; /* Verde Oliva Oscuro (Campo, Naturaleza) */
            --color-background: #fdfbf5; /* Crema/Beige Muy Claro (Papel Viejo) */
            --color-text: #3a3a3a; /* Gris Muy Oscuro (Tinta) */
            --color-text-muted: #6c757d; /* Gris Apagado */
            --color-modal-bg: #ffffff; /* Blanco Puro (Página Limpia) */
            --color-border: #dcdcdc; /* Gris Claro (Borde Sutil) */
            --color-error-bg: #f8d7da; /* Fondo error rosa pálido */
            --color-error-text: #721c24; /* Texto error rojo oscuro */
            --color-error-border: #f5c6cb; /* Borde error rosa */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.08);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'EB Garamond', serif; font-weight: 600; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; font-size: 1.7rem; } /* Tamaño título modal */
        .navbar { background-color: rgba(253, 251, 245, 0.9); /* Fondo crema semi-transparente */ backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Merriweather'; font-weight: 300; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.15); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.1rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Merriweather'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-primary); background-color: #fffaf0; /* Floral white hover */ border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'EB Garamond', serif; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #6a3309; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #bcaaa4; color: #f5f5f5; cursor: not-allowed; opacity: 0.8; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(58, 58, 58, 0.85); /* Overlay gris */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 900px; /* Un poco más estrecho para lectura */
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e9ecef; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: #ffffff; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) #e9ecef;
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: #e9ecef; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid #e9ecef; }

        #modal-content { padding: 0 5px; font-size: 1.05rem; /* Texto ligeramente más grande */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; text-indent: 1.5em; /* Sangría */ }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'EB Garamond', serif; margin-top: 2.5em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 600; text-indent: 0; /* Sin sangría en títulos */ }
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 3rem auto 1.5rem auto; border: 1px solid var(--color-border); border-radius: 2px; box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f8f9fa; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) #e9ecef;
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: #e9ecef; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; font-family: 'Merriweather', serif; font-weight: 400; }
        .user-message { background-color: var(--color-tertiary); color: white; margin-left: auto; text-align: left; }
        .ai-message { background-color: #e9ecef; color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Merriweather'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #6a3309; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #e9ecef; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.2rem; font-family: 'EB Garamond'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Merriweather'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-text); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(58, 58, 58, 0.92); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); box-shadow: var(--shadow-lg); background-color: white; /* Fondo blanco por si la imagen tiene transparencia */ }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: white; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-feather-alt mr-3"></i> <!-- Icono pluma -->
                     Ecos de Tolstoi
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">» Generador de Cuentos «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Explorando el Alma Humana</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Sumérgete en narrativas ficticias inspiradas en la profundidad psicológica, los dilemas morales y la observación social del maestro León Tolstoi.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar por palabra clave o tema...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-brown-700 mr-2"></i> <!-- Icono libro abierto -->
                 Semillas Narrativas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando archivo de ideas...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Ninguna entrada coincide con su búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Inspirar Nuevas Historias
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Componiendo el relato...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image and placeholder will be appended here via JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                      <h4 class="text-sm font-semibold text-gray-600 mb-2 text-center font-sans">Analizar este Cuento</h4>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Reflexionando...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre personajes, temas, estilo...">
                         <button id="chat-send-btn" aria-label="Enviar Pregunta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Ilustración Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Cuentos generados por IA, inspirados en el estilo y temas de León Tolstoi, con fines creativos y de exploración literaria.</p>
              <p class="mt-1">Estas narrativas son obras de ficción originales.</p>
              <p class="mt-2">© <span id="footer-year"></span> Ecos de Tolstoi</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Dilemas Morales y Sociales
            "La Confesión del Mercader", "El Honor Perdido del Teniente", "La Dote de la Campesina", "El Secreto del Icono Familiar", "La Deuda Impagable", "El Juicio del Pueblo", "Entre la Fe y la Duda", "La Caridad del Avaro", "El Peso de la Conciencia", "La Mentira Piadosa de Anna", "El Exilio Voluntario", "La Tentación del Sacerdote Ortodoxo", "Lealtad Familiar vs. Justicia", "El Precio de la Verdad", "La Redención del Jugador", "El Estigma Social", "La Promesa Rota al Soldado", "La Ambición del Funcionario", "Un Acto de Venganza Justificada?", "El Sacrificio Silencioso", "La Culpa Heredada", "El Dilema del Médico Rural", "La Doble Vida del Aristócrata", "El Perdón Inesperado", "La Envidia entre Hermanos", "El Código de Honor no Escrito", "La Corrupción en la Provincia", "El Amor Prohibido y sus Consecuencias", "La Responsabilidad del Terrateniente", "La Pobreza Honrada", "El Error Judicial", "La Fuga del Siervo", "El Legado Disputado", "La Traición de un Amigo", "El Valor de la Palabra Dada", "La Intriga en el Salón de San Petersburgo", "La Desesperación del Artista", "El Orgullo Herido", "La Hipocresía de la Alta Sociedad", "La Búsqueda de Sentido en la Adversidad",
            // Vida Rural y Naturaleza
            "Un Invierno en la Dacha", "La Cosecha Tardía", "El Guardabosques Solitario", "La Vida Simple del Mujik", "El Río que Divide Familias", "La Nieve como Testigo", "El Vínculo con la Tierra", "Secretos Bajo el Abedul", "La Caza del Oso", "El Ciclo de las Estaciones", "La Melancolía del Campo", "El Caballo Fiel", "La Tormenta de Verano", "El Huerto Olvidado", "La Sabiduría del Anciano Campesino", "El Bosque como Refugio", "La Sequía y la Fe", "El Regreso al Hogar Rural", "La Belleza Austera del Paisaje", "El Trabajo en la Tierra Comunitaria (Mir)", "La Inmensidad de la Estepa", "El Canto del Urogallo", "La Pesca en el Volga", "El Miedo a los Lobos", "La Celebración de la Cosecha", "El Molino Detenido", "La Vida en Armonía (o Desarmonía) con la Naturaleza", "El Incendio en el Campo", "La Llegada de la Primavera", "El Lago Congelado", "La Tradición de la Siega", "El Perro del Pueblo", "La Visita del Noble a sus Tierras", "El Camino Polvoriento", "La Soledad del Pastor", "El Eco en las Montañas", "La Noche Estrellada en el Campo", "La Superstición Rural", "El Viento en los Campos de Trigo", "El Jardín Descuidado de la Mansión",
            // Familia, Amor y Relaciones
            "El Matrimonio Arreglado", "Cartas desde el Frente", "La Visita de la Tía Lejana", "El Hijo Pródigo Regresa", "La Rivalidad entre Primas", "El Primer Amor de Juventud", "Secretos Matrimoniales", "La Ausencia del Padre", "La Educación de los Hijos", "La Viuda y sus Pretendientes", "El Vínculo Inquebrantable Madre-Hijo", "La Herencia Dividida", "Celos en la Familia", "El Baile de Debutantes", "La Reconciliación Familiar", "La Institutriz Francesa", "Amor no Correspondido", "La Presión por Casarse", "La Figura del Patriarca", "La Pérdida de un Hijo", "La Adopción Secreta", "La Tensión entre Suegra y Nuera", "El Abuelo Cuentacuentos", "La Fuga de los Amantes", "La Cena Familiar Incómoda", "El Nacimiento del Heredero", "La Hermana Soltera", "El Recuerdo de la Infancia", "La Diferencia de Edad en el Amor", "El Divorcio Silencioso", "La Carga de Cuidar a los Padres Ancianos", "El Amor que Supera las Clases Sociales", "La Infidelidad Descubierta", "La Boda Campesina", "El Destino de los Huérfanos", "La Nostalgia del Hogar Paterno", "La Comunicación Rota", "El Perdón entre Cónyuges", "La Celebración del Aniversario", "La Influencia de los Sirvientes en la Familia",
            // Guerra, Historia y Sociedad
            "El Veterano de Crimea", "La Partida hacia la Guerra", "El Hospital de Campaña", "Noticias del Frente", "El Soldado Desconocido", "La Vida Bajo Ocupación (Ficticia)", "El Impacto de las Reformas Zaristas", "El Estudiante Revolucionario", "La Sociedad Secreta", "Un Día en la Vida del Siervo Emancipado", "El Duelo por Honor", "Recuerdos de 1812", "La Burocracia Imperial", "El Contraste entre Moscú y San Petersburgo", "La Llegada del Ferrocarril al Pueblo", "El Exiliado Político", "La Censura y el Escritor", "El Movimiento Nihilista", "La Vida en la Guarnición Fronteriza", "El Espía del Zar", "La Conspiración Fallida", "El Noble Liberal", "El Descontento Campesino", "La hambruna en la Provincia", "El Servicio Militar Obligatorio", "La Construcción de una Nueva Iglesia", "El Debate sobre la Modernización", "La Influencia Extranjera (Francesa/Alemana)", "El Periódico Local y sus Noticias", "La Feria Anual del Pueblo", "La Visita del Obispo", "El Recaudador de Impuestos", "La Escuela Rural", "El Miedo a la Revuelta", "La Celebración de una Victoria Militar", "El Prisionero de Guerra", "La Propaganda Imperial", "La Rutina del Cuartel", "El Futuro Incierto de Rusia", "El Comerciante Extranjero",
            // Búsqueda Espiritual y Filosófica
            "La Crisis de Fe del Terrateniente", "En Busca de la Verdad Simple", "La Muerte y su Significado", "El Peregrino Iluminado", "La Conversación con el Stárets", "El Sentido del Sufrimiento", "La Búsqueda de la Felicidad Auténtica", "El Ateísmo del Intelectual", "La Vida Monástica", "El Encuentro con la Muerte Inminente", "La Reflexión sobre la Propia Mortalidad", "La Lectura de los Evangelios", "El Poder de la Oración", "La Culpa y la Expiación", "La Belleza como Vislumbre Divino", "El Hombre que Abandonó Todo", "La Duda Metódica", "La Naturaleza de Dios", "El Libre Albedrío vs. Destino", "La Simplicidad como Camino Espiritual", "La Vanidad de la Vida Mundana", "La Influencia de la Filosofía Oriental", "El Debate Teológico", "La Experiencia Mística", "La Caridad como Práctica Espiritual", "El Arrepentimiento Sincero", "La Fe Ingenua del Campesino", "La Lucha Interior contra el Pecado", "La Interpretación de los Sueños", "La Muerte de un Niño y la Fe", "La Búsqueda de la Paz Interior", "El Asceta en el Bosque", "La Música Sacra y la Trascendencia", "La Confesión Pública", "El Valor del Trabajo Manual", "La Lectura de los Padres de la Iglesia", "La Influencia de un Libro Prohibido", "La Reconciliación con Dios", "El Silencio Contemplativo", "La Muerte como Liberación",
             // Títulos más abstractos/evocadores
             "Sombras del Pasado", "El Eco de una Promesa", "Bajo Cielos Grises", "El Largo Camino a Casa", "Donde los Caminos se Bifurcan", "El Último Baile", "Susurros en la Nieve", "El Corazón Inquieto", "Fragmentos de una Vida", "La Luz Tenue de la Vela", "El Jardín de los Secretos", "Antes del Amanecer", "La Melodía Olvidada", "El Peso del Silencio", "Ecos en el Salón Vacío", "El Hilo Invisible", "Cuando Cae la Noche", "La Mirada del Retrato", "El Legado del Tiempo", "Cenizas y Recuerdos", "El Río del Olvido", "La Puerta Entreabierta", "El Color del Arrepentimiento", "Voces en el Viento", "El Reflejo en el Agua", "La Última Carta", "El Círculo Cerrado", "Donde Muere la Esperanza", "El Brillo Fugaz", "La Huella Imborrable",
             // Continuar con más variaciones... (400+ es un objetivo alto)
        ];
        const tolstoyThemes = [ // Para generar más títulos
            "dilemas morales en la Rusia del siglo XIX", "conflicto de clases sociales", "vida rural vs. urbana", "relaciones familiares complejas", "búsqueda espiritual y fe", "impacto de la guerra en el individuo", "psicología profunda de personajes", "matrimonio y adulterio", "propiedad de la tierra y campesinado", "aristocracia rusa", "honor y deber", "perdón y redención", "la condición humana universal", "influencia de la naturaleza", "crítica social sutil", "el paso del tiempo y la memoria", "la muerte y la mortalidad", "inocencia y corrupción", "el papel de la mujer en la sociedad"
        ];
        const textApiConfig = { // Para generar el cuento
            model: "mistral", // Puedes probar otros modelos si Mistral no captura bien el estilo
            systemPrompt: "Eres un escritor experto que emula magistralmente el estilo de León Tolstoi. Tu tarea es escribir un cuento corto ficticio (aproximadamente 1200-1300 palabras) inspirado directamente en el título/idea proporcionado. Ambientado generalmente en la Rusia del siglo XIX, el cuento debe explorar la psicología profunda de los personajes, presentar dilemas morales complejos, ofrecer observaciones sociales realistas y detalladas, y reflexionar sobre temas universales como la familia, la fe, la duda, el amor, la muerte, o el sentido de la vida. Utiliza una prosa descriptiva, un ritmo pausado pero intencional, diálogos realistas y una narrativa omnisciente o focalizada que revele los pensamientos y sentimientos internos. Evita finales simplistas; busca la complejidad y la ambigüedad de la vida real. Comienza a escribir directamente el cuento basado en este título/idea:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúa como un analista literario erudito, especializado en la obra y estilo de León Tolstoi. Acabas de 'leer' el cuento titulado '[Story Title]'. Responde preguntas específicas sobre ESE CUENTO: sus personajes, temas, simbolismo, desarrollo argumental, posibles interpretaciones, o cómo refleja elementos del estilo tolstoyano. Basa tus respuestas únicamente en el contenido del cuento proporcionado. Sé perspicaz, claro y conciso.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // Para generar más títulos
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para cuentos al estilo de León Tolstoi. Genera exactamente 15 títulos o premisas evocadoras para narrativas cortas. Deben sugerir dilemas morales, conflictos sociales o familiares, exploraciones psicológicas, o reflexiones filosóficas ambientadas preferentemente en la Rusia del siglo XIX. Devuelve *solo* la lista de títulos/premisas, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        // (Identical to previous versions, just ensure IDs match HTML)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        const footerYear = document.getElementById('footer-year');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Renamed for clarity

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `Actúa como un analista literario erudito, especializado en la obra y estilo de León Tolstoi. Acabas de 'leer' el cuento titulado '${currentStoryTitle}'. Responde preguntas específicas sobre ESE CUENTO: sus personajes, temas, simbolismo, desarrollo argumental, posibles interpretaciones, o cómo refleja elementos del estilo tolstoyano. Basa tus respuestas únicamente en el contenido del cuento proporcionado. Sé perspicaz, claro y conciso.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             // No seed for chat or title generation usually
             if (config.seed && !isChat && config !== titleGenerationConfig) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Código ${response.status}) Nuestros servidores tienen mucho tráfico en este momento. Por favor, intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta de nuevo o con otro título.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La solicitud tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(conceptTitle) { // Renamed for clarity
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentStoryTitle) throw new Error("Error interno: No se ha establecido el contexto del cuento para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(tolstoyThemes) || "dilemas morales rusos";
            const specificPrompt = `Genera 15 títulos/premisas para cuentos al estilo Tolstoi sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas literarias.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Adjusted prompt for theme
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 768, height: 512, nologo: true }; // Slightly smaller image default?
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "escena rusa del siglo XIX";
            // Focus on atmosphere, realism, 19th century Russia
            const enhancedPrompt = `Atmospheric illustration inspired by a story titled '${safePromptText}'. Style of Russian Realism painters (like Peredvizhniki). Setting: 19th century Russia (snowy landscape, dacha interior, peasant hut, grand ballroom, battlefield). Focus on mood, light, character expression (if visible). Avoid text, labels. Painting aesthetic.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, photograph, photorealistic, modern elements, cartoon, anime, 3D render";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (Added text-indent logic)
        function formatExplanationText(rawText) {
             if (!rawText) return '';
             let formatted = rawText.trim();

             // Basic Markdown/Syntax fixes first
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             formatted = formatted.replace(/^#+\s+(.*)$/gm, (match, p1) => {
                 const level = match.match(/^#+/)[0].length;
                 return `<h${level+1}>${p1.trim()}</h${level+1}>`; // +1 because H1 is usually the main title
             });

             // Paragraph handling with indentation
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 // Don't indent headings
                 if (block.match(/^<h\d>/)) return block;
                 // Replace internal newlines with spaces for flow
                 let content = block.replace(/\n/g, ' ').trim();
                 // Wrap in <p> - CSS will handle the text-indent
                 return `<p>${content}</p>`;
             }).join('');

             return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Mostly unchanged, check scroll target)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            // *** Ensure scrolling modalTextArea (the one with overflow-y: auto) ***
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal for modalTextArea");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = ''; // Clear story text and image
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null; // Clear story context
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Unchanged)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (Unchanged logic, check context variable name)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... */ } // Unchanged
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentStoryTitle) return; // Check context too

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ========== (Check variable names)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ } // Unchanged
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            div.innerHTML = `<i class="fas fa-book fa-xs mr-2 text-gray-400"></i> ${title}`; // Add subtle icon
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
         }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Optionally sort, or keep random feel? Let's sort for consistency.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay ideas en el archivo.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
            if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
        }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // SET CHAT CONTEXT
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawStoryText = await fetchExplanationText(title); // Fetch the story
                const formattedStory = formatExplanationText(rawStoryText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedStory; // Add formatted story text
                modalStoryContentArea.classList.remove('content-hidden'); // Show content area

                // *** Reset scroll AFTER content is potentially long ***
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible for modalTextArea");

                // Prepare image placeholder within modalContent (at the end)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-palette placeholder-icon"></i> <!-- Palette icon -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Creando ilustración...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Append placeholder

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración inspirada en: ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo crear la ilustración.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append image to the text content div
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el cuento.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando inspiración...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar nuevas ideas en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar ideas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Inspirar Nuevas Historias';
             }
         }

         // Search Filter Function (with normalization)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check all essential elements, including new ones if any
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !footerYear || !modalTextArea ) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #721c24; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: serif;">Error Crítico: No se pudieron cargar los componentes esenciales de la página.</p>';
                return;
             }
            // Set Footer Year
            footerYear.textContent = new Date().getFullYear();

            // Event Listeners (identical setup to previous version)
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>