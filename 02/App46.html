<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inglés Sencillo - Conceptos de Gramática</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Gramática --- */
        :root {
            --color-primary: #14b8a6; /* Teal */
            --color-secondary: #6366f1; /* Indigo */
            --color-background: #f8fafc; /* Slightly off-white */
            --color-text: #1f2937; /* Darker Gray */
            --color-text-muted: #6b7280;
            --color-modal-bg: #ffffff;
            --color-border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); }
        h1, h2, h3, h4, .logo { font-family: 'Quicksand', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #0d9488; /* Darker Teal */ box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.8); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem; max-width: 850px; width: 95%; max-height: 90vh; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e5e7eb; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.4rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #d1d5db; color: var(--color-text); }
        #modal-title { color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; }
        #modal-content { line-height: 1.7; color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 10px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content::-webkit-scrollbar { width: 8px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.2em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Quicksand', sans-serif; margin-top: 1.8em; margin-bottom: 0.8em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.3em; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.2em; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-secondary); }
        /* Formula styles kept for robustness, but less likely needed */
        #modal-content .formula { text-align: center; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 1.1em; padding: 0.8em; margin: 1.2em 0; border: 1px solid var(--color-border); background-color: #f9fafb; border-radius: var(--border-radius); overflow-x: auto; white-space: nowrap; }
        #modal-content .formula sub, #modal-content .formula sup { font-size: 0.8em; line-height: 0; position: relative; vertical-align: baseline; }
        #modal-content .formula sub { top: 0.5em; }
        #modal-content .formula sup { top: -0.5em; }
        #modal-image-container { width: 100%; height: 220px; background-color: #f3f4f6; border-radius: var(--border-radius); overflow: hidden; display: none; /* Start hidden */ align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; margin-top: 1rem; }
        #modal-image-container.visible { display: flex; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 2.5rem; color: var(--color-border); display: none; }
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: var(--border-radius); border: 1px solid #fecaca; margin-top: 1rem; text-align: center; flex-shrink: 0; }
        .error-msg i { margin-right: 0.5rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
    <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-3 flex justify-center items-center">
             <div class="flex items-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-comments mr-2"></i> Inglés Sencillo: Gramática
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Descomplica la Gramática Inglesa</h1>
             <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Entiende las reglas del inglés con explicaciones claras por IA, pensadas para hispanohablantes. ¡Elige un tema!</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-spell-check text-indigo-500 mr-2"></i>
                 Conceptos a Dominar
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Buscando reglas...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Conceptos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Traduciendo reglas...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                 </div>
                  <!-- Image Container (Initially Hidden) -->
                 <div id="modal-image-container">
                     <div class="spinner"></div>
                     <i class="fas fa-language placeholder-icon"></i> <!-- Placeholder icon -->
                     <img id="modal-image" alt="Visualización abstracta del concepto gramatical" />
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-circle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-5 mt-12 border-t border-gray-200">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA con fines educativos. La gramática tiene matices, ¡practica y consulta fuentes expertas!</p>
              <p class="mt-1">© 2025 Inglés Sencillo</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            "El Verbo 'To Be' (Ser/Estar) en Presente Simple",
            "El Verbo 'To Be' en Pasado Simple (Was/Were)",
            "El Verbo 'To Have' (Tener) en Presente Simple",
            "El Verbo 'To Have' como Auxiliar (Present Perfect)",
            "El Auxiliar 'Do/Does' para Preguntas y Negaciones (Present Simple)",
            "El Auxiliar 'Did' para Preguntas y Negaciones (Past Simple)",
            "Presente Simple: Usos y Formación",
            "Presente Continuo (Progressive): Usos y Formación",
            "Diferencia entre Presente Simple y Presente Continuo",
            "Pasado Simple: Usos y Formación (Verbos Regulares)",
            "Pasado Simple: Verbos Irregulares Comunes",
            "Pasado Continuo (Progressive): Usos y Formación",
            "Diferencia entre Pasado Simple y Pasado Continuo",
            "Presente Perfecto Simple: Usos y Formación",
            "Presente Perfecto Continuo: Usos y Formación",
            "Diferencia entre Presente Perfecto Simple y Continuo",
            "Pasado Perfecto Simple: Usos y Formación",
            "Pasado Perfecto Continuo: Usos y Formación",
            "Futuro Simple con 'Will'",
            "Futuro con 'Be Going To'",
            "Diferencia entre 'Will' y 'Be Going To'",
            "Futuro Continuo (Progressive)",
            "Futuro Perfecto Simple",
            "Verbos Modales: Can / Could (Habilidad, Permiso)",
            "Verbos Modales: May / Might (Posibilidad)",
            "Verbos Modales: Must / Have to (Obligación)",
            "Verbos Modales: Should / Ought to (Consejo)",
            "Artículos Definidos (The) vs. Indefinidos (A/An)",
            "Cuándo NO usar 'The'",
            "Uso de 'A' vs. 'An'",
            "Sustantivos Contables e Incontables (Countable/Uncountable)",
            "Uso de 'Some' y 'Any'",
            "Uso de 'Much', 'Many', 'A lot of'",
            "Uso de '(A) Few' y '(A) Little'",
            "Plurales Regulares e Irregulares de Sustantivos",
            "Adjetivos: Posición y Orden",
            "Adjetivos Comparativos (Comparative)",
            "Adjetivos Superlativos (Superlative)",
            "Comparativos y Superlativos Irregulares",
            "Adverbios de Modo (-ly)",
            "Adverbios de Frecuencia (Always, Sometimes, Never...)",
            "Posición de los Adverbios de Frecuencia",
            "Diferencia entre Adjetivo y Adverbio",
            "Preposiciones de Lugar: In, On, At",
            "Preposiciones de Tiempo: In, On, At",
            "Preposiciones de Movimiento: To, Into, Towards...",
            "Verbos con Preposiciones Comunes (Phrasal Verbs - Introducción)",
            "Look for, Look at, Look after",
            "Get up, Get on, Get off",
            "Put on, Put off, Put out",
            "Take off, Take out, Take after",
            "Preguntas con Wh- (What, Where, When, Who, Why, How)",
            "Formación de Preguntas Yes/No",
            "Question Tags (Isn't it?, Don't you?)",
            "Pronombres Personales (Subject Pronouns: I, You, He...)",
            "Pronombres Objeto (Object Pronouns: Me, You, Him...)",
            "Adjetivos Posesivos (My, Your, His...)",
            "Pronombres Posesivos (Mine, Yours, His...)",
            "Pronombres Reflexivos (Myself, Yourself...)",
            "Uso de 'This', 'That', 'These', 'Those'",
            "Condicional Cero (Zero Conditional)",
            "Primer Condicional (First Conditional)",
            "Segundo Condicional (Second Conditional)",
            "Tercer Condicional (Third Conditional)",
            "Diferencia entre los Condicionales",
            "Voz Pasiva (Passive Voice): Formación y Usos",
            "Pasiva en Diferentes Tiempos Verbales",
            "Estilo Indirecto (Reported Speech): Cambios en Tiempos Verbales",
            "Reported Speech: Cambios en Pronombres y Expresiones de Tiempo/Lugar",
            "Reported Questions",
            "Reported Commands/Requests",
            "Gerundios (-ing) como Sujeto u Objeto",
            "Infinitivos (to + verb) después de Verbos y Adjetivos",
            "Diferencia entre Gerundio e Infinitivo",
            "Used to + Infinitivo (Hábitos Pasados)",
            "Be used to + Gerundio (Estar acostumbrado a)",
            "Get used to + Gerundio (Acostumbrarse a)",
            "Conjunciones Coordinantes (And, But, Or, So)",
            "Conjunciones Subordinantes (Because, Although, When, If...)",
            "Relative Clauses (Who, Which, That, Whose, Where)",
            "Defining vs. Non-defining Relative Clauses",
            "Orden de las Palabras en la Oración Afirmativa (SVO)",
            "Orden de las Palabras en la Oración Negativa",
            "Orden de las Palabras en la Pregunta",
            "Either... or / Neither... nor",
            "Both... and",
            "Not only... but also",
            "Too vs. Enough",
            "So vs. Such",
            "False Friends Comunes (Actually, Library, Sensible...)",
            "Diferencia entre 'Say' y 'Tell'",
            "Diferencia entre 'Make' y 'Do'",
            "Diferencia entre 'Like' y 'As'",
            "Diferencia entre 'Job' y 'Work'",
            "Diferencia entre 'Travel', 'Trip', 'Journey'",
            "Diferencia entre 'Hear' y 'Listen'",
            "Diferencia entre 'See', 'Look', 'Watch'",
            "Uso de 'Yet', 'Still', 'Already'",
            "Since vs. For (Present Perfect)",
            "Ago (Past Simple)",
            "If vs. Whether",
            "Wish + Past Simple (Deseos sobre el presente)",
            "Wish + Past Perfect (Lamentos sobre el pasado)",
            "Could have / Should have / Would have",
            "Contracciones Comunes (I'm, Don't, Isn't...)",
            "Capitalización (Mayúsculas) en Inglés",
            "Puntuación Básica: Coma, Punto, Interrogación, Exclamación",
            "Apóstrofo para Posesión ('s)",
            "Apóstrofo para Contracciones",
            "Números Cardinales y Ordinales",
            "Cómo Decir la Hora",
            "Cómo Decir Fechas",
            "Prefijos Comunes (un-, in-, dis-, re-)",
            "Sufijos Comunes (-able, -ness, -ly, -er)",
            "Collocations Comunes (Make a mistake, Do homework)",
            "Expresiones Idiomáticas Sencillas (Break a leg, Piece of cake)",
            "Consejos para Aprender Vocabulario",
            "La Importancia de la Pronunciación (Sonidos Clave)",
            "El Alfabeto Fonético Internacional (IPA) - Introducción",
            "Diferencia entre Inglés Británico y Americano (Vocabulario Básico)",
            "Diferencia entre Inglés Británico y Americano (Ortografía Básica)",
            "Slang y Lenguaje Informal (Introducción)",
            "Cómo Usar un Diccionario Bilingüe Efectivamente",
            "Errores Comunes de Hispanohablantes al Aprender Inglés",
            "La Doble Negación (Incorrecta en Inglés)",
            "Omisión del Sujeto (Incorrecta en Inglés)",
            "Concordancia Sujeto-Verbo (He plays / They play)",
            "Uso Excesivo del Presente Continuo",
            "Confusión entre Adjetivos terminados en -ed y -ing (Bored vs Boring)"
        ];
        const englishGrammarThemes = [
            "el verbo 'to be'", "los tiempos verbales presentes", "los tiempos verbales pasados", "los tiempos verbales futuros", "los verbos modales", "los artículos (a/an/the)", "sustantivos contables e incontables", "adjetivos y adverbios", "comparativos y superlativos", "las preposiciones (in, on, at)", "los phrasal verbs", "la formación de preguntas", "los pronombres", "los condicionales", "la voz pasiva", "el estilo indirecto (reported speech)", "gerundios e infinitivos", "conjunciones", "relative clauses", "el orden de las palabras", "errores comunes para hispanohablantes", "vocabulario y expresiones", "puntuación y mayúsculas"
        ];
        const textApiConfig = { model: "mistral", systemPrompt: "Eres un excelente profesor de inglés especializado en gramática para hispanohablantes. Tu tarea es explicar conceptos gramaticales ingleses de forma muy clara, sencilla, detallada y paciente. Contrasta con el español cuando sea útil para aclarar diferencias. Usa ejemplos prácticos y fáciles de entender. Evita la jerga técnica o explícala muy bien. Estructura la explicación con párrafos claros y subtítulos (usando markdown #, ##, ###, ####). El objetivo es una explicación completa y fácil de seguir de unas 700-800 palabras. Basa tu explicación únicamente en el siguiente concepto:", timeoutSeconds: 100 };
        const titleGenerationConfig = { model: "mistral", systemPrompt: "Actúa como un generador de ideas conciso. Genera exactamente 15 conceptos o preguntas clave sobre gramática inglesa, especialmente relevantes o difíciles para hablantes nativos de español. Devuelve *solo* la lista de conceptos/preguntas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.", timeoutSeconds: 30 };

        // ========== DOM ELEMENTS ========== (sin cambios)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // --- Variable to hold the current scroll listener --- (sin cambios)
        let currentScrollHandler = null;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) { /* ... (sin cambios desde la versión funcional) ... */
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url}`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
             }
         }
        async function fetchExplanationText(conceptTitle) { /* ... (sin cambios desde la versión funcional) ... */
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              if (text.trim().length < 500 || text.toLowerCase().includes("cannot fulfill")) {
                   throw new Error("La IA no pudo generar una explicación adecuada para este concepto.");
               }
             return text;
         }
        async function fetchGeneratedTitles() { /* ... (sin cambios desde la versión funcional) ... */
             const randomTheme = getRandomElement(englishGrammarThemes) || "conceptos básicos de gramática";
             const specificPrompt = `Genera 15 conceptos o preguntas clave sobre ${randomTheme} en gramática inglesa para hispanohablantes`;
             console.log("Generating concepts with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 120);
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de conceptos.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) { /* ... (Prompt adaptado) ... */
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "english grammar concept abstract";
             // Prompt for abstract language/communication visuals
             const enhancedPrompt = `Abstract visualization related to language learning, communication structure, or the concept of '${safePromptText}', minimalist style, clean design, interconnected shapes or patterns`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Stronger negative prompt against any text or literal representations
             const negativePrompt = "text, words, letters, alphabet, flags, national flags, specific language text, sentences, grammar rules written out, diagrams, charts, graphs, tables, UI elements, buttons, realistic photo, people, faces, books, notebooks, pens, pencils, classroom, teacher, student, computer screen, website screenshot, flags of USA, flags of UK, flags of Spain";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios, sigue siendo útil)
        function formatExplanationText(rawText) { /* ... (sin cambios desde la versión funcional) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (sin cambios desde la versión funcional)
        function showModal() { /* ... */ if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { /* ... (Incluye scrollTop = 0 y limpieza del listener) ... */
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
                console.log("Scroll listener removed on hideModal.");
            }
            resetModalState();
        }
        function resetModalState() { /* ... (sin cambios desde la versión funcional) ... */
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.classList.remove('visible');
             modalImageContainer.style.display = 'none';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (sin cambios desde la versión funcional)
        function getRandomElement(arr) { /* ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... */
            if (!titleListContainer || !titlesLoading) return;
            const shuffledTitles = shuffleArray([...titles]);
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay conceptos disponibles.</p>'; return; }
            shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
        }
        function appendTitles(newTitles) { /* ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        async function handleTitleClick(title) { /* ... (Incluye scrollTop = 0 post-render y listener para imagen) ... */
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalImageContainer.style.display = 'none';
            modalImageContainer.classList.remove('visible');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
            }

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;

                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.scrollTop = 0; // <<<--- RESET SCROLL AQUÍ
                console.log("Scroll set to 0 after content visible");

                modalImageSpinner.style.display = 'block';
                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL:", title);
                     modalImageSpinner.style.display = 'none';
                     modalImagePlaceholder.style.display = 'block';
                 }

                const scrollBuffer = 15;
                currentScrollHandler = () => {
                    if (modalContent.scrollHeight <= modalContent.clientHeight) {
                         console.log("Content fits, showing image immediately.");
                         modalImageContainer.classList.add('visible');
                         modalImageContainer.style.display = 'flex';
                         modalContent.removeEventListener('scroll', currentScrollHandler);
                         currentScrollHandler = null;
                    } else if ((modalContent.scrollTop + modalContent.clientHeight) >= (modalContent.scrollHeight - scrollBuffer)) {
                        console.log("Scroll end reached, showing image.");
                        modalImageContainer.classList.add('visible');
                        modalImageContainer.style.display = 'flex';
                        modalContent.removeEventListener('scroll', currentScrollHandler);
                        currentScrollHandler = null;
                        console.log("Scroll listener removed after showing image.");
                    }
                };
                modalContent.addEventListener('scroll', currentScrollHandler);
                console.log("Scroll listener added.");
                setTimeout(currentScrollHandler, 100);

            } catch (error) {
                console.error("Failed to display explanation:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error al cargar: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = '';

                 if (currentScrollHandler) {
                    modalContent.removeEventListener('scroll', currentScrollHandler);
                    currentScrollHandler = null;
                 }
            }
        }
        async function handleGenerateMoreTitles() { /* ... (Texto del botón adaptado) ... */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando reglas...'; // Adaptar texto loading
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se pudieron generar nuevos conceptos en este momento."); }
             } catch (error) { console.error("Failed generation:", error); alert(`Error: ${error.message}`);
             } finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Conceptos'; } // Adaptar texto botón
         }

        // ========== INITIALIZATION ========== (sin cambios)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p>Error crítico.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>