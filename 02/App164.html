<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laberintos Kafkianos - Relatos Interactivos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes evocadoras -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Laberintos Kafkianos --- */
        :root {
            --color-primary: #a1a1aa; /* Gris piedra/metal */
            --color-secondary: #7f1d1d; /* Rojo oscuro apagado (uso muy moderado) */
            --color-tertiary: #e2e8f0; /* Blanco hueso/papel viejo */
            --color-background: #1f2937; /* Gris azulado muy oscuro */
            --color-text: #d1d5db; /* Gris claro */
            --color-text-muted: #9ca3af; /* Gris medio */
            --color-modal-bg: #111827; /* Casi negro */
            --color-border: #4b5563; /* Borde gris oscuro */
            --color-error-bg: #3f1212; /* Fondo error rojo oscuro */
            --color-error-text: #fecaca; /* Texto error claro */
            --color-error-border: #dc2626; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.15), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.15);
            --border-radius: 2px; /* Bordes muy afilados/rectos */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto Condensed', sans-serif; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; }
        .logo { color: var(--color-tertiary); }
        h1.page-title { color: var(--color-tertiary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 0.7rem; display: inline-block; font-weight: 400; }
        #modal-title { color: var(--color-tertiary); font-weight: 700; letter-spacing: 1px; }
        .navbar { background-color: rgba(17, 24, 39, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); transition: var(--transition-normal); font-family: 'Roboto Condensed', sans-serif; }
        #search-input::placeholder { color: var(--color-text-muted); font-weight: 300; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: inset 0 1px 3px rgba(0,0,0,0.3), 0 0 0 2px rgba(161, 161, 170, 0.3); outline: none; background-color: #0d1117; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Merriweather', serif; font-size: 0.95rem; border-left: 3px solid var(--color-border); }
        .title-item:hover { transform: translateX(5px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-tertiary); background-color: #1f2937; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-border); color: var(--color-tertiary); padding: 0.7rem 1.4rem; border: 1px solid var(--color-primary); border-radius: var(--border-radius); font-family: 'Roboto Condensed', sans-serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-transform: uppercase; letter-spacing: 1px; }
        #generate-more-btn:hover:not(:disabled) { background-color: var(--color-primary); border-color: var(--color-tertiary); color: var(--color-background); box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #111827; border-color: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; }
        #generate-more-btn .fa-sync-alt { }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 900px; /* Slightly narrower */
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: none; border-radius: 0; width: 35px; height: 35px; font-size: 2rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; font-family: serif; }
        .modal-close-btn:hover { color: var(--color-tertiary); transform: rotate(90deg); }
        #modal-title { font-size: 1.7rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.4; text-transform: none; font-family: 'Merriweather', serif; font-weight: 700; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 8px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-border) rgba(17, 24, 39, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 6px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(17, 24, 39, 0.5); border-radius: 0; }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-border); border-radius: 0; }

        #modal-content { padding: 0 5px; font-size: 1.05rem; /* Slightly larger text */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.6em; }
        #modal-content strong { color: var(--color-tertiary); font-weight: 700; }
        #modal-content em { color: var(--color-primary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto Condensed', sans-serif; margin-top: 2.5em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px dotted var(--color-border); padding-bottom: 0.6em; font-weight: 400; text-transform: uppercase; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.1em; color: var(--color-text-muted); }
        #modal-content h4 { font-size: 1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; /* Smaller max width */ height: auto; margin: 3rem auto 1.5rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: filter 0.3s ease; filter: grayscale(30%) sepia(20%); /* Kafkaesque filter */ }
        #modal-content .final-image:hover { filter: grayscale(0%) sepia(0%); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); opacity: 0.7; }
        #modal-content .image-placeholder .spinner { border: 3px solid var(--color-border); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1.5s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2rem; opacity: 0.5;}

        /* Chat Section Styles */
        #chat-section { border-top: 1px dashed var(--color-border); padding-top: 1rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(10, 15, 31, 0.5); scroll-behavior: smooth; font-size: 0.9rem;
            scrollbar-width: thin; scrollbar-color: var(--color-border) rgba(17, 24, 39, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 5px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(17, 24, 39, 0.5); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-border); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; }
        .user-message { background-color: #374151; color: var(--color-tertiary); margin-left: auto; text-align: left; /* Keep left align for readability */ }
        .ai-message { background-color: #262f3d; color: var(--color-text); margin-right: auto; text-align: left; border-left: 3px solid var(--color-primary); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.85em; opacity: 0.8; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.9rem; border: 1px solid var(--color-border); background-color: #262f3d; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-size: 0.9rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); background-color: var(--color-modal-bg); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-border); color: var(--color-tertiary); border: 1px solid var(--color-border); border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-primary); color: var(--color-background); }
        #chat-send-btn:disabled { background-color: #111827; color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.85em; color: var(--color-text-muted); display: none; font-family: 'Roboto Condensed'; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(17, 24, 39, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 45px; height: 45px; border: 4px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.8s linear infinite; margin: 0 auto 1.8rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.2rem; font-family: 'Roboto Condensed'; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Merriweather', serif; font-size: 0.95rem; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 10, 10, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 90%; max-height: 90%; object-fit: contain; border: 1px solid var(--color-border); box-shadow: var(--shadow-lg); filter: grayscale(30%) sepia(20%); /* Apply filter here too */ }
        #fullscreen-close-btn { position: absolute; top: 15px; right: 20px; background: transparent; border: none; width: 45px; height: 45px; font-size: 2.2rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); font-family: serif; }
        #fullscreen-close-btn:hover { color: var(--color-tertiary); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-key mr-3 text-gray-500"></i> <!-- Icono llave -->
                     Laberintos Kafkianos
                 </h1>
             </div>
             <span class="text-xs text-gray-400 font-sans tracking-wider uppercase">» Expedientes Narrativos «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">El Archivo de lo Inexplicable</h1>
             <p class="text-lg text-gray-400 mb-8 max-w-3xl mx-auto font-light leading-relaxed">Consulte los registros. Cada entrada detalla un caso singular, un fragmento de existencia distorsionada. Proceda bajo su propio riesgo.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-xl mx-auto"> <!-- Narrower search -->
             <input type="text" id="search-input" placeholder="Buscar por número de expediente o palabra clave...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-folder-open text-gray-500 mr-2"></i> <!-- Icono carpeta -->
                 Índice de Expedientes
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los archivos centrales...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún expediente coincide con la consulta «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Solicitar Nuevos Expedientes
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar Expediente">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Procesando Expediente...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image and placeholder will be appended here -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                    <h4 class="text-sm uppercase text-gray-500 mb-2 text-center tracking-wider font-sans">Consulta Adicional</h4>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Formular pregunta sobre este expediente...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Visualización Ampliada del Expediente">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-600 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-xs">
              <p>Las narrativas contenidas son constructos ficticios generados por una entidad algorítmica, inspirados en temáticas kafkianas.</p>
              <p class="mt-1">Cualquier parecido con la realidad, burocrática o existencial, es puramente especulativo.</p>
              <p class="mt-2">Archivo K-AI © Ciclo Actual</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Metamorfosis / Cuerpo
            "El Despertar del Señor K como Pólipo de Escritorio", "La Epidermis Archivadora", "Cuando mis Dientes Empezaron a Contar Chistes", "El Hombre que Exudaba Tinta China", "La Metamorfosis Inversa de Gregor Samsa", "El Órgano Supernumerario del Inspector", "Mi Piel se Convirtió en Pergamino Oficial", "El Corazón Mecánico del Archivero", "Los Ojos Prestados del Funcionario", "El Paciente Cuyo Estornudo era un Decreto", "Transformado en Silla de Espera", "El Dedo Índice Acusador Autónomo", "La Lengua Bífida del Burócrata", "El Apéndice Olvidado en el Formulario", "Cuando las Uñas se Volvieron Llaves Maestras", "El Hombre que se Deshizo en Polvo de Expediente", "La Piel de Naranja del Condenado", "El Esqueleto Transparente", "La Voz Alojada en la Rodilla", "Mutación a Insecto de Archivo", "El Oído que Escuchaba el Pasado", "Convertido en Mancha de Humedad", "El Cabello que Formaba Laberintos", "La Sombra con Voluntad Propia", "El Ombligo que Dictaba Órdenes", "Mis Huellas Dactilares Escribían Solas", "El Sudor que Cristalizaba en Párrafos", "La Costilla Flotante del Legislador", "Transformación en Sello de Goma", "El Cuerpo como Expediente Incompleto",
            // Burocracia / Sistemas
            "El Formulario para Solicitar la Inexistencia", "El Ministerio de los Ecos Perdidos", "La Ley del Marco Vacío", "El Juicio por el Crimen Aún No Cometido", "Departamento de Quejas contra la Gravedad", "La Circular Infinita", "El Archivo de los Nombres Olvidados", "La Oficina de Objetos Perdidos del Alma", "El Proceso contra el Silencio", "Reglamento para la Correcta Respiración en Pasillos", "El Comité para la Estandarización de las Pesadillas", "La Ventanilla Única hacia la Nada", "El Impuesto sobre la Sombra Proyectada", "Manual de Procedimientos para Desaparecer", "La Auditoría de los Sueños", "El Sello que Validaba la Locura", "La Jerarquía de los Susurros", "El Permiso para Dudar", "La Comisión Investigadora del Vacío", "El Expediente G-734: El Caso del Eco", "Normativa sobre el Uso Indebido de Metáforas", "El Censo de los Seres Imaginarios", "La Burocracia del Tiempo Detenido", "El Departamento de Devoluciones Existenciales", "La Multa por Exceso de Conciencia", "Archivo General de Intenciones Fallidas", "El Protocolo para Entrevistas con Fantasmas", "La Sección de Reclamaciones contra el Destino", "El Organigrama del Caos", "La Tasa por el Uso del Lenguaje",
            // Absurdo / Eventos Inexplicables
            "El Día que los Paraguas se Negaron a Abrirse", "La Ciudad Construida con Suspiros", "El Reloj que Marcaba el Tiempo Hacia Atrás", "El Juicio de los Muebles contra su Dueño", "La Plaga de Comas Errantes", "El Hombre Atrapado en un Bucle Adverbial", "Cuando la Lluvia Olía a Tinta Fresca", "El Espejo que Devolvía una Espalda", "La Huelga General de las Sombras", "El Eco que Llegaba Antes que la Voz", "La Conferencia sobre el Sonido del Color Negro", "El Tranvía que Solo Viajaba a Ayer", "La Rebelión de los Adjetivos Calificativos", "El Banquete de Palabras No Dichas", "La Biblioteca de Libros Jamás Escritos", "El Río que Fluía hacia Arriba los Martes", "El Inventario de los Agujeros en el Queso", "La Orquesta de Ruidos Imperceptibles", "El Circo de las Leyes Físicas Retiradas", "La Epidemia de Bostezos Contagiosos de Sentido", "Cuando los Nudos de Corbata se Volvieron Serpientes", "El Mapa del Territorio Inexistente", "La Asamblea de Objetos Inútiles", "El Silencio que Gritaba Órdenes", "La Competencia de Miradas Vacías", "El Perfume con Olor a Olvido", "La Noche en que las Estrellas Cambiaron de Sitio", "El Hombre Perseguido por un Signo de Puntuación", "La Tienda Donde Vendían Tiempo Usado", "El Puente Hecho de Dudas",
            // Alienación / Soledad
            "El Habitante Único del Edificio Infinito", "El Hombre Transparente en la Multitud", "La Conversación con mi Propio Eco", "El Extraño Caso del Nombre que Nadie Recordaba", "Perdido en el Pasillo de las Puertas Idénticas", "El Empleado que se Fusionó con su Escritorio", "La Sombra que No Coincidía", "El Vecino que Era Solo un Sombrero Flotante", "El Hombre Invisible para los Espejos", "Atrapado entre Dos Pensamientos Idénticos", "La Ciudad Donde Nadie Miraba Hacia Arriba", "El Eco de una Voz que Nunca Habló", "El Retrato que Envejecía por Mí", "El Funcionario que Olvidó su Propio Rostro", "La Soledad del Último Punto Final", "El Pasajero del Tren Fantasma de la Rutina", "El Laberinto de mi Propia Mente", "El Diálogo con la Mancha en la Pared", "El Hombre que Solo Existía en los Márgenes", "La Espera Interminable en la Sala Vacía", "El Coleccionista de Silencios Ajenos", "El Reflejo que Vivía una Vida Mejor", "El Intruso en mi Propia Piel", "La Llave que No Abría Ninguna Puerta Conocida", "El Prisionero de un Recuerdo Falso", "El Oficinista y su Sombra Desobediente", "La Carta que Nunca Llegó a Nadie", "El Visitante que Tocaba a la Puerta desde Dentro", "El Muro Invisible entre Yo y el Mundo", "La Identidad Perdida en un Trámite",
            // Labyrinths / Espacios Opresivos
            "El Edificio que Crecía Hacia Adentro", "El Pasillo que Siempre Doblaba a la Izquierda", "La Escalera que No Llevaba a Ningún Piso", "Atrapado en la Sala de Espera del Tiempo", "La Oficina Cuyo Techo Descendía un Milímetro al Día", "El Laberinto de Formularios Idénticos", "La Ciudad sin Calles, Solo Corredores", "La Habitación que Cambiaba de Tamaño", "El Ascensor Hacia el Sótano Infinito", "El Mapa que se Redibujaba Solo", "La Biblioteca Donde los Libros Eran Muros", "El Pasadizo Secreto Detrás del Reloj de Fichar", "La Ventana que Daba a Otra Ventana Idéntica", "El Jardín de Senderos que se Bifurcan... y Vuelven al Mismo Punto", "La Cola que Rodeaba el Mundo", "El Archivo como Organismo Vivo", "El Techo Lleno de Ojos Vigilantes", "La Puerta Giratoria hacia la Locura", "El Laberinto Hecho de Normas y Reglamentos", "La Estación de Tren sin Salidas", "El Escritorio como Isla Desierta", "El Edificio de Administración Central del Vértigo", "La Ciudad Subterránea de los Archivos Muertos", "El Pasillo Iluminado por Lámparas Apagadas", "La Trampa de la Geometría Imposible", "El Apartamento con Paredes Móviles", "La Escalera de Caracol hacia el Olvido", "El Bosque de Archivadores Metálicos", "La Plaza Mayor Rodeada de Ventanillas", "El Callejón sin Retorno de la Burocracia",
            // Culpa / Juicio
            "El Juicio por un Crimen Olvidado", "La Culpa Hereditaria del Archivero", "Acusado por el Reloj de Pared", "El Proceso de Canonización del Error", "La Sentencia Dictada por un Eco", "El Pecado Original de Haber Nacido", "El Tribunal de las Miradas Inquisidoras", "La Confesión Escrita en Polvo", "Culpable de Ser K.", "El Abogado que Defendía al Vacío", "La Evidencia Escondida en un Bostezo", "El Jurado Compuesto por Sombras", "La Condena a Repetir el Mismo Día", "El Fiscal que Era un Maniquí", "La Apelación Rechazada por Silencio Administrativo", "El Testigo que Solo Podía Mentir", "El Crimen de Existir Demasiado", "La Prisión Hecha de Papel Timbrado", "La Deuda Impagable con el Sistema", "El Perdón que Requería un Formulario Imposible", "Acusado de Respirar Aire No Autorizado", "El Juez con Cabeza de Pájaro", "La Celda Decorada con Párrafos Legales", "El Verdugo que Ofrecía un Trámite", "La Inocencia como Agravante", "El Sumario Secreto de mi Propia Vida", "La Culpa Flotando en el Aire Acondicionado", "El Recurso de Amparo contra la Realidad", "El Delito de Tener Sueños No Reglamentarios", "La Absolución que Era Otra Condena",
             // Extra Absurdities
            "El Filósofo que Enseñaba a las Sillas", "El Poeta Empleado en el Ministerio de Puntos y Comas", "El Músico que Componía para Archivos", "El Matemático que Calculaba la Raíz Cuadrada de la Angustia", "El Inventor del Silencio Embotellado", "El Lingüista que Traducía Bostezos", "El Biólogo que Clasificaba Tipos de Polvo", "El Astrónomo que Observaba el Interior de los Cajones", "El Geógrafo de los Espacios Interiores", "El Historiador de los Minutos Perdidos", "El Químico que Analizaba la Composición de la Nada", "El Físico que Estudiaba la Elasticidad del Tiempo", "El Zoólogo de Insectos Imaginarios", "El Botánico de Plantas de Oficina Mustias", "El Crítico de Arte de Manchas en la Pared", "El Chef Especializado en Comida de Pensamiento", "El Entrenador Personal de Burócratas", "El Guía Turístico de Laberintos Administrativos", "El Detective de Intenciones Ocultas", "El Cartógrafo de Estados de Ánimo",
            "La Autobiografía de un Número de Expediente", "El Diario Íntimo de una Grapa", "Las Memorias de un Sello de Goma", "La Correspondencia entre una Llave y una Cerradura", "El Monólogo Interior de un Formulario", "La Conspiración de los Clips", "El Amor Prohibido entre el Memorándum y la Circular", "La Tragedia del Papel Carbón Olvidado", "La Odisea de un Documento Extraviado", "El Alzamiento de las Carpetas Colgantes",
            // --- Continue adding more titles, varying themes ---
            "El Hombre que Cambió su Cabeza por un Expediente", "La Ley de la Perspectiva Obligatoria", "El Departamento de Asuntos Irrelevantes", "El Sueño Recurrente del Formulario B-12", "Cuando las Paredes Empezaron a Susurrar Reglamentos", "El Color Oficial del Desasosiego", "La Melodía Prohibida del Archivador", "El Olor Característico de la Desesperanza Administrativa", "El Laberinto Táctil de la Burocracia Nocturna", "El Juicio Sumarísimo de las Intenciones", "La Metamorfosis del Alma en Nota a Pie de Página", "El Silencio Administrativo como Respuesta Universal", "El Empleado Modelo Reducido a una Firma Ilegible", "La Ciudadela de Papel", "El Expediente que Devoraba a sus Lectores", "La Sombra Burócrata", "El Corredor de los Ecos Duplicados", "La Ventanilla de Reclamaciones contra Uno Mismo", "El Engranaje Humano", "El Sello de 'Rechazado' en el Alma", "El Hombre que Vivía en un Margen", "La Oficina de Normalización de Anomalías", "El Informe sobre la Inexistencia de Informes", "La Escalera de Servicios hacia el Vacío", "El Funcionario y el Insecto Intercambiables", "La Tinta Simpática de la Verdad Oculta", "El Reloj de Fichar que Marcaba la Eternidad", "El Laberinto de Espejos Deformantes de la Administración", "La Ventana Tapiada con Decretos", "El Caso del Hombre Duplicado por Error", "El Ministerio de la Niebla Perpetua", "La Culpa Como Requisito Indispensable", "El Formulario que se Rellenaba Solo", "La Ley de la Gravedad Opcional (Formulario Requerido)", "El Proceso Kafkiano por Antonomasia", "El Hombre que Olvidó Cómo Salir de su Oficina", "La Máquina de Escribir que Anticipaba el Futuro", "El Juicio de la Coma Mal Puesta", "La Circular sobre la Prohibición de la Esperanza", "El Archivo de los Destinos Equivocados", "La Metamorfosis en Pura Burocracia", "El Eco de la Culpa Original", "La Sentencia Escrita en el Aire", "El Laberinto del Propio Nombre", "La Puerta que Llevaba Siempre al Mismo Lugar", "El Empleado que se Volvió Invisible Lentamente", "La Ciudad Administrada por Insectos", "El Informe Perdido sobre el Sentido de la Vida", "La Culpa sin Crimen, el Juicio sin Juez", "El Sótano donde Guardaban los Sueños Rechazados", "La Transformación Involuntaria en Párrafo Legal", "El Sistema que se Alimentaba de Dudas", "El Hombre Atrapado en una Metáfora Literal", "La Oficina del Tiempo Suspendido", "El Expediente Eterno", "La Burocracia de los Sentimientos", "El Juicio por Haber Nacido en el Lugar Equivocado", "La Metamorfosis en Sombra", "El Corredor Infinito de la Espera", "El Funcionario que Perdió su Número", "La Ley del Absurdo Cotidiano", "El Archivo de las Posibilidades Descartadas", "La Culpa Transparente", "El Laberinto de las Instrucciones Contradictorias", "El Hombre Convertido en Sello Oficial", "La Ciudad donde las Calles eran Formularios", "El Proceso contra K." // Clásico
            // Aim for 400+
        ];
        const kafkaThemes = [ // Themes for generating more titles
            "metamorfosis corporal kafkiana", "burocracia absurda", "sistemas opresivos", "eventos inexplicables surrealistas", "alienación y soledad urbana", "laberintos arquitectónicos", "espacios opresivos de oficina", "culpa inexplicable", "juicios sin sentido", "transformación en objeto inanimado", "pérdida de identidad", "la insignificancia del individuo", "el cuerpo como prisión", "reglamentos absurdos", "comunicación fallida", "la lógica del sueño en la vigilia", "animales o insectos con roles humanos", "la autoridad impersonal", "la espera interminable", "el castillo inalcanzable", "el proceso legal como laberinto", "la familia disfuncional kafkiana", "objetos cotidianos con vida propia", "la ciudad como trampa"
        ];
        const textApiConfig = { // Story generation config
            model: "mistral",
            systemPrompt: "Eres un escritor experto emulando el estilo distintivo de Franz Kafka. Tu tarea es escribir una historia corta original, de aproximadamente 1200-1300 palabras, basada únicamente en el título proporcionado. Captura la esencia kafkiana: atmósfera de ansiedad, burocracia laberíntica, alienación, transformaciones surrealistas, culpa ambigua, lógica absurda y onírica, personajes atrapados en sistemas incomprensibles, y finales abiertos o ambiguos. Evita explicaciones claras o resoluciones sencillas. Céntrate en la atmósfera y la experiencia psicológica del protagonista. Usa un lenguaje preciso pero evocador de extrañeza y opresión. NO añadas introducciones ni conclusiones que rompan el estilo. La historia debe comenzar directamente inspirada por el título.",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Chat config (base, system prompt changes dynamically)
            model: "mistral-tiny", // Faster model for chat
             systemPrompt: "Actúa como un analista literario distante o un funcionario perplejo, especializado únicamente en el expediente narrativo (la historia kafkiana) actualmente en consulta. Responde preguntas sobre los detalles, personajes, simbolismo o atmósfera *de esta historia específica*. Mantén un tono ligeramente formal, ambiguo, evasivo o desconcertado, acorde con el universo kafkiano. No ofrezcas opiniones personales ni salgas del contexto del relato proporcionado.",
            timeoutSeconds: 50 // Shorter timeout for chat
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Genera exactamente 15 títulos originales y evocadores para historias cortas al estilo de Franz Kafka. Enfócate en temas como burocracia, absurdo, transformación, alienación, culpa, laberintos. Deben sonar intrigantes y ligeramente perturbadores. Devuelve *solo* la lista de títulos, uno por línea. Sin números, guiones, introducciones ni comentarios.",
            timeoutSeconds: 45
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Scrollable area
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div for HTML text
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Context for chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `Actúa como un analista literario distante o un funcionario perplejo, especializado únicamente en el expediente narrativo titulado '${currentStoryTitle}'. Responde preguntas sobre los detalles, personajes, simbolismo o atmósfera *de esta historia específica*. Mantén un tono formal, ambiguo, evasivo o desconcertado, acorde con el universo kafkiano. No ofrezcas opiniones personales ni salgas del contexto del relato.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     // *** USER-FRIENDLY ERROR ***
                     throw new Error(`(Error ${response.status}) Nuestros archivos están procesando un volumen inusual de solicitudes. Por favor, intente consultar nuevamente en unos instantes.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la entidad consultada ha resultado vacía. Intente reformular la consulta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     // *** USER-FRIENDLY TIMEOUT ERROR ***
                     throw new Error(`La conexión con los archivos centrales ha excedido el tiempo permitido (>${config.timeoutSeconds}s). Verifique su conexión o inténtelo más tarde.`);
                 }
                 throw new Error(error.message || "Ha ocurrido una anomalía imprevista durante la consulta a los archivos.");
             }
        }
        // Wrappers
        async function fetchExplanationText(conceptTitle) { // Actually fetches the story
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentStoryTitle) throw new Error("Error Interno: El contexto del expediente actual no está definido para la consulta.");
            return fetchTextFromApi(userQuery, chatApiConfig, true); // true indicates chat
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(kafkaThemes) || "temática kafkiana general";
            const specificPrompt = `Genera 15 títulos de historias cortas originales estilo Kafka sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La entidad generadora no pudo proveer suficientes nuevos expedientes.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 768, height: 512, nologo: true }; // Slightly smaller image
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Kafkaesque scene";
             // Prompt for unsettling, symbolic imagery
             const enhancedPrompt = `Surreal, symbolic, unsettling illustration inspired by the Kafkaesque title '${safePromptText}'. Use a muted color palette (grays, sepia, dark tones). Focus on atmosphere, strange architecture, bureaucracy, alienation, or bizarre transformation. Dreamlike, ambiguous. Style of Käthe Kollwitz, Edvard Munch, or German Expressionism. Avoid text, labels, writing, clear faces.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, writing, signature, watermark, bright colors, cheerful, photorealistic, clear depiction, multiple panels, diagram, chart";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (Standard Markdown subset)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            // Basic Markdown/formatting corrections
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');     // Italic
            // Handle paragraphs (double line breaks)
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                // Basic heading detection (optional, Kafka might not use them much)
                if (block.startsWith('# ')) return `<h2>${block.substring(2)}</h2>`; // Simple H2 example
                // Replace single line breaks within a block with space (often better for prose)
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0; // Ensure scroll reset here
            console.log("Scroll reset on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null;
             hideFullscreenImage(); // Ensure image overlay is also hidden/reset
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ==========
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            // Only restore body scroll if the main modal is *also* closed
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            // Basic formatting within chat
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message; // Use innerHTML for formatting
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentStoryTitle) return;

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                // Use the potentially user-friendly error message from the API function
                addChatError(`Anomalía en la consulta: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.innerHTML = `<i class="fas fa-file-alt fa-fw mr-3 text-gray-600"></i>${title}`; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; } // Added icon
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Sort maybe less relevant for Kafka? Keep alphabetical for consistency.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No se encontraron expedientes coincidentes en el archivo «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawStoryText = await fetchExplanationText(title); // Fetch the story
                const formattedStory = formatExplanationText(rawStoryText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedStory; // Display story text
                modalStoryContentArea.classList.remove('content-hidden');

                // *** CRUCIAL: Reset scroll AFTER content is visible and potentially sized ***
                 requestAnimationFrame(() => { // Ensure rendering cycle completed
                     modalTextArea.scrollTop = 0;
                     console.log("Scroll reset requested for:", title);
                 });


                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="far fa-eye placeholder-icon"></i> <!-- Eye icon -->
                    <p style="font-size: 0.75em; margin-top: 0.5rem;">Generando ilustración...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Append placeholder to text content

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración conceptual para: ${title}`;
                imgElement.style.display = 'none'; // Hide until loaded

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    // Add click listener for fullscreen
                    imgElement.addEventListener('click', () => {
                        showFullscreenImage(imgElement.src);
                    });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-ban placeholder-icon"></i><p style="font-size:0.75em;margin-top:0.5rem;">Ilustración no disponible.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append image at the end of text content
                } else {
                     console.error("Failed to create image URL:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon"></i><p style="font-size:0.75em;margin-top:0.5rem;">Error al generar URL.</p>`;
                }

            } catch (error) {
                console.error("Display failed:", error);
                modalLoadingIndicator.style.display = 'none';
                 // *** Use the potentially user-friendly error message ***
                modalErrorMessage.textContent = error.message || "Error desconocido al procesar el expediente.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = ''; // Clear partial content if any
                chatSection.classList.add('content-hidden'); // Hide chat on main load error
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando Archivos Remotos...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron recuperar nuevos expedientes en este momento."); }
             } catch (error) {
                 console.error("Title generation failed:", error);
                 alert(`Error durante la consulta: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Solicitar Nuevos Expedientes';
             }
         }

         // Search Filter Function (with normalization)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check for essential elements
            if (![titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, modalTextArea].every(el => el)) {
                 console.error("Initialization Failure: Crucial UI elements are missing.");
                 document.body.innerHTML = '<p style="color: #f87171; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: monospace;">ERROR CATASTROFICO: Fallo en la carga de componentes de interfaz. Imposible continuar.</p>';
                 return;
             }
            // Event listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            console.log("Kafkaesque Archive Initialized.");
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>