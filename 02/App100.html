<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animales del Mundo - Enciclopedia Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y naturales -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Animales del Mundo --- */
        :root {
            --color-primary: #228B22; /* Verde Bosque */
            --color-secondary: #8B4513; /* Marrón Tierra (SaddleBrown) */
            --color-tertiary: #4682B4; /* Azul Acero (SteelBlue) */
            --color-background: #fdfdf5; /* Blanco Hueso muy claro (casi blanco) */
            --color-text: #3a3a3a; /* Gris Oscuro cálido */
            --color-text-muted: #708090; /* Gris Pizarra (SlateGray) */
            --color-modal-bg: #ffffff; /* Blanco puro modal */
            --color-border: #dcdcdc; /* Gris Gainsboro */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.06);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.08);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 8px; /* Bordes más suaves */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-secondary); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700;}
        #modal-title { color: var(--color-secondary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1.05rem; box-shadow: var(--shadow-sm); transition: var(--transition-normal); background-color: #fff; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(34, 139, 34, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 700; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Nunito', sans-serif; font-size: 1rem; }
        .title-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f5fff5; /* Verde muy pálido hover */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1e7e1e; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: #a9a9a9; /* DarkGray */ color: #e0e0e0; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(58, 58, 58, 0.9); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 2.5rem 3rem; /* Más padding */
            max-width: 950px; /* Ligeramente más ancho */
            width: 95%;
            max-height: 90vh;
            min-height: 350px; /* Altura mínima carga */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: #e0e0e0; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(180deg); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.8rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }
        #modal-content {
            line-height: 1.8;
            color: var(--color-text);
            white-space: normal;
            overflow-y: auto;
            padding: 0 15px 2rem 15px; /* Padding inferior generoso */
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content::-webkit-scrollbar { width: 9px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-secondary); font-weight: bold; }
        #modal-content em { color: var(--color-primary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.2em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid #e0e0e0; padding-bottom: 0.5em; font-weight: bold; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos para imagen y placeholder dentro del contenido */
        #modal-content .final-image { display: block; max-width: 90%; height: auto; margin: 2.5rem auto 1.5rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 2.5rem auto 1.5rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 5px solid rgba(0, 0, 0, 0.08); width: 45px; height: 45px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 1rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3.5rem; opacity: 0.7; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid #dcdcdc; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.8rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.3rem; font-family: 'Nunito'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fff5f5; color: #cc0000; /* Rojo error */ padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid #ffcccc; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 700; font-size: 1.05rem; }
        .error-msg i { margin-right: 0.8rem; }
        .content-hidden { display: none; }
        .title-item.hidden { display: none; } /* Para ocultar con buscador */
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-paw mr-3 text-green-700"></i> <!-- Icono huella -->
                     Animales del Mundo
                 </h1>
             </div>
             <span class="text-md text-gray-700 flex items-center">
                 <i class="fas fa-globe-americas mr-2"></i> Explora la Fauna Global <!-- Icono globo -->
             </span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Descubre la Increíble Diversidad Animal</h1>
             <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Desde las profundidades del océano hasta las cimas más altas, conoce las criaturas que comparten nuestro planeta. Busca un animal o explora la lista.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Buscar animal, grupo o concepto...">
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-binoculars text-brown-700 mr-2"></i> <!-- Icono binoculares -->
                 Selecciona un Animal o Tema
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Catalogando la vida salvaje...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-5 hidden">No se encontraron animales o temas para tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-10">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Especies y Temas
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Investigando especie...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-5 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - La imagen se añadirá aquí al final -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                     <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Contenido generado por IA con fines educativos e informativos sobre la fauna mundial.</p>
              <p class="mt-1">La información sobre estado de conservación puede variar. Consulta fuentes como la UICN para datos actualizados.</p>
              <p class="mt-2">© 2025 Enciclopedia Animal Interactiva</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
             // Mamíferos
            "León Africano", "Tigre de Bengala", "Elefante Africano de Sabana", "Elefante Asiático", "Jirafa", "Cebra Común", "Rinoceronte Blanco", "Rinoceronte Negro", "Hipopótamo Común", "Gorila de Montaña", "Chimpancé Común", "Orangután de Borneo", "Oso Pardo (Grizzly)", "Oso Polar", "Oso Panda Gigante", "Lobo Gris", "Zorro Rojo", "Coyote", "Perro Salvaje Africano (Licaón)", "Hiena Manchada", "Leopardo", "Jaguar", "Puma (León de Montaña)", "Guepardo (Chita)", "Lince Ibérico", "Gato Doméstico (Concepto general)", "Canguro Rojo", "Koala", "Demonio de Tasmania", "Wombat", "Ornitorrinco", "Equidna", "Ballena Azul", "Ballena Jorobada (Yubarta)", "Orca (Ballena Asesina)", "Delfín Mular (Nariz de Botella)", "Narval", "Manatí del Caribe", "Foca Común", "León Marino de California", "Morsa", "Nutria Marina", "Castor Americano", "Perezoso de Tres Dedos", "Armadillo de Nueve Bandas", "Oso Hormiguero Gigante", "Tapir Malayo", "Murciélago Vampiro Común", "Zorro Volador Gigante", "Lémur de Cola Anillada", "Aye-aye", "Suricata (Meerkat)", "Ciervo Rojo (Venado)", "Alce", "Reno (Caribú)", "Bisonte Americano", "Búfalo Africano", "Cabra Montesa", "Guanaco", "Vicuna", "Camello Bactriano", "Dromedario", "Caballo (Concepto general)", "Conejo Europeo", "Liebre Ártica", "Ardilla Roja", "Marmota Alpina", "Puercoespín Norteamericano", "Ratón Común", "Rata Parda", "Topo Europeo", "Musaraña Común", "Pangolín",
             // Aves
            "Águila Calva", "Águila Real", "Cóndor de los Andes", "Búho Nival", "Lechuza Común", "Pingüino Emperador", "Pingüino Rey", "Pingüino de Magallanes", "Avestruz", "Emú", "Casuario", "Colibrí Pico Espada", "Picaflor Gigante", "Guacamayo Rojo (Macao)", "Loro Gris Africano (Yaco)", "Cacatúa Blanca", "Tucán Toco", "Flamenco Común", "Cisne Vulgar", "Ganso Canadiense", "Pelícano Pardo", "Albatros Viajero", "Halcón Peregrino", "Secretario (Ave)", "Buitre Leonado", "Quebrantahuesos", "Pavo Real Común", "Faisán Dorado", "Gallina Doméstica (Concepto)", "Paloma Bravía", "Cuervo Común", "Urraca Común", "Petirrojo Europeo", "Golondrina Común", "Martín Pescador Común", "Pito Real (Pájaro Carpintero)", "Frailecillo Atlántico", "Gaviota Argéntea", "Cigüeña Blanca", "Garza Real", "Kiwi Común", "Correcaminos Grande", "Cucaburra Común",
             // Reptiles
            "Cocodrilo del Nilo", "Cocodrilo Marino", "Aligátor Americano", "Caimán Negro", "Cobra Real", "Mamba Negra", "Serpiente de Cascabel Diamante del Oeste", "Pitón Reticulada", "Anaconda Verde", "Boa Constrictor", "Serpiente de Coral Oriental", "Dragón de Komodo", "Iguana Verde", "Camaleón Común", "Geco Leopardo", "Lagarto Monitor del Nilo", "Monstruo de Gila", "Tortuga Laúd", "Tortuga Verde", "Tortuga Galápago (Gigante)", "Tortuga Mediterránea", "Tortuga de Florida (Orejas Rojas)", "Gavial",
             // Anfibios
            "Rana Flecha Azul (Dendrobates azureus)", "Rana Arborícola de Ojos Rojos", "Rana Toro Americana", "Sapo Común Europeo", "Sapo Marino (Sapo de Caña)", "Salamandra Común (Salamandra salamandra)", "Tritón Alpino", "Ajolote Mexicano", "Cecilia (Anfibio ápodo)",
             // Peces
            "Tiburón Blanco", "Tiburón Martillo", "Tiburón Tigre", "Tiburón Ballena", "Manta Raya Gigante (Manta birostris)", "Atún Rojo", "Salmón del Atlántico", "Pez Payaso", "Pez Ángel Emperador", "Pez Cirujano Azul", "Caballito de Mar Común", "Pez Globo", "Pez León", "Piraña Roja", "Rape Abisal", "Anguila Eléctrica", "Pez Gato Europeo (Siluro)", "Carpa Común", "Pez Dorado (Goldfish)", "Pez Betta (Luchador de Siam)", "Bacalao Común", "Morena Común", "Celacanto",
             // Invertebrados
            "Tarántula Goliat", "Araña Viuda Negra", "Escorpión Emperador", "Mariposa Monarca", "Polilla Atlas", "Abeja Europea (Miel)", "Avispa Papelera", "Hormiga Bala", "Hormiga Cortadora de Hojas", "Escarabajo Hércules", "Escarabajo Pelotero", "Mariquita de Siete Puntos", "Libélula Emperador", "Saltamontes Común", "Mantis Religiosa Europea", "Cucaracha Americana", "Pulpo Común", "Calamar Gigante", "Sepia Común", "Medusa Luna (Aurelia aurita)", "Carabela Portuguesa", "Anémona de Mar Común", "Estrella de Mar Común", "Erizo de Mar Común", "Pepino de Mar", "Cangrejo Herradura", "Cangrejo Ermitaño", "Langosta Americana", "Camarón Común", "Percebe", "Caracol de Jardín Común", "Babosa Común", "Lombriz de Tierra Común", "Sanguijuela Medicinal", "Nautilus Pompilius", "Coral Cerebro", "Esponja de Mar Común", "Milpiés Gigante Africano", "Ciempiés Doméstico", "Mosca Doméstica", "Mosquito Común",
             // Conceptos y Grupos
            "¿Qué es un Mamífero?", "¿Qué es un Ave?", "¿Qué es un Reptil?", "¿Qué es un Anfibio?", "¿Qué es un Pez?", "¿Qué es un Insecto?", "¿Qué es un Arácnido?", "¿Qué son los Vertebrados?", "¿Qué son los Invertebrados?", "Animales en Peligro Crítico de Extinción", "Especies Invasoras", "Biodiversidad: ¿Qué es y por qué importa?", "Cadena Alimentaria (Red Trófica)", "Clasificación Taxonómica de Linneo", "Reino Animalia", "Filo Chordata", "Filo Arthropoda", "Filo Mollusca", "Ecosistema: Definición y Tipos", "Hábitat: La Casa de los Animales", "Nicho Ecológico", "Adaptación Animal", "Camuflaje y Mimetismo", "Migración Animal: Grandes Viajes", "Hibernación y Estivación", "Animales Nocturnos vs Diurnos", "Comportamiento Social en Animales", "Comunicación Animal: Sonidos, Olores, Gestos", "Simbiosis: Mutualismo, Comensalismo, Parasitismo", "Depredador vs Presa", "Animales Herbívoros, Carnívoros y Omnívoros", "Reproducción Sexual y Asexual", "Metamorfosis en Insectos y Anfibios", "El Papel de los Polinizadores", "Animales Venenosos vs Ponzoñosos", "Evolución: La Teoría de Darwin", "Fósiles: Ventanas al Pasado Animal", "Conservación de la Vida Silvestre", "Parques Nacionales y Reservas Naturales", "El Impacto Humano en la Fauna", "Cambio Climático y los Animales",
             // Hábitats Específicos (Como temas)
            "Fauna de la Selva Amazónica", "Vida Salvaje en la Sabana Africana", "Animales del Desierto del Sahara", "Habitantes del Océano Ártico", "Biodiversidad en la Gran Barrera de Coral", "Criaturas de las Profundidades Abisales", "Fauna de los Andes", "Animales de los Bosques Boreales (Taiga)", "Vida en la Tundra", "Ecosistema de Manglar", "Fauna de las Islas Galápagos", "Vida Silvestre en Madagascar", "Animales del Himalaya", "Fauna del Pantanal (Brasil)"
        ];
        const animalThemes = [
            "mamíferos africanos", "grandes felinos", "primates del mundo", "osos del mundo", "cetáceos (ballenas y delfines)",
            "aves rapaces", "aves marinas", "pingüinos", "reptiles venenosos", "grandes serpientes", "tortugas marinas",
            "anfibios coloridos", "tiburones", "peces de arrecife de coral", "peces abisales", "insectos sociales", "arácnidos",
            "moluscos marinos", "animales en peligro de extinción", "adaptaciones al desierto", "vida en el ártico",
            "fauna de Australia", "animales de la selva tropical", "biodiversidad", "comportamiento animal", "migraciones épicas"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un zoólogo y divulgador científico apasionado por la vida salvaje. Tu tarea es proporcionar una ficha descriptiva completa, precisa y fascinante sobre el animal, grupo animal o concepto zoológico indicado. Cubre aspectos clave como: nombre común y científico (si aplica), clasificación básica (clase, orden), descripción física detallada (tamaño, peso, pelaje/plumaje/escamas, características distintivas), distribución geográfica y hábitat natural, dieta (alimentación), comportamiento (social, reproductivo, patrones de actividad), ciclo de vida/reproducción, estado de conservación actual (según UICN si es posible, ej. Vulnerable, En Peligro), amenazas principales, y 2-3 datos curiosos o características sorprendentes. Utiliza un lenguaje claro, atractivo y riguroso. El objetivo es un texto informativo de aproximadamente 1200-1300 palabras. Basa tu descripción únicamente en el siguiente ítem:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia de animales. Genera exactamente 15 nombres de animales diversos (comunes o interesantes), grupos taxonómicos (ej. 'Felinos', 'Insectos') o conceptos zoológicos clave (ej. 'Migración', 'Camuflaje'), adecuados para una descripción detallada. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ========== (Sin cambios funcionales)
        async function fetchTextFromApi(prompt, config) { /* ... */
            const encodedPrompt = encodeURIComponent(prompt);
            const encodedSystem = encodeURIComponent(config.systemPrompt);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intenta de nuevo.`);
                throw new Error(`Error de comunicación con la API: ${error.message}`);
            }
        }
        async function fetchExplanationText(conceptTitle) { /* ... */
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de")) {
                   throw new Error("La IA no pudo generar una descripción adecuada o suficientemente detallada para este animal/tema.");
               }
             return text;
         }
        async function fetchGeneratedTitles() { /* ... */
            const randomTheme = getRandomElement(animalThemes) || "animales fascinantes";
            const specificPrompt = `Genera 15 nombres de animales, grupos o conceptos zoológicos sobre ${randomTheme}`;
            console.log("Generating titles with prompt:", specificPrompt);
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
            const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 2 && line.length < 100); // Ajustar longitud mínima/máxima si es necesario
            if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas nuevas.");
            return titles.slice(0, 15);
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a Animales
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "wild animal in nature";
            // Prompt ENFOCADO en el animal en su hábitat o ilustración de calidad.
            const enhancedPrompt = `High-quality illustration or realistic depiction of '${safePromptText}', the animal, shown in its natural habitat. Focus on anatomical accuracy and typical environment. Dynamic or natural pose. Detailed background relevant to the animal's biome (forest, ocean, desert, savanna, arctic, etc.). Avoid cages, humans, text.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            // Negative prompt MÁS estricto contra elementos no deseados
            const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, graphs, charts, diagrams, map, flag, cage, enclosure, zoo, human, person, people, drawing, sketch, cartoon, animation, abstract, blurry, low quality, deformed, mutated, ugly, watermark, signature, multiple animals crowded, text overlay";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios funcionales)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' '); // Replace internal newlines with space for paragraphs
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Sin cambios funcionales)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (Sin cambios funcionales mayores)
        function getRandomElement(arr) { /* ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { // Ordenar alfabéticamente
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' })); // Sort ignoring case/accents
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay animales o temas disponibles.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { // Evitar duplicados y re-filtrar
            if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title.toLowerCase()));
             let added = false;
             newTitles.forEach(title => {
                 if (!existingTitles.has(title.toLowerCase())) {
                     titleListContainer.appendChild(createTitleItem(title));
                     added = true;
                 }
             });
             if(added) {
                filterTitles(searchInput.value); // Re-apply filter only if titles were added
             }
        }

        // *** MODIFIED: handleTitleClick (sin cambios funcionales, texto/iconos actualizados) ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalContent.scrollTop = 0; // Reset scroll DESPUÉS de poner contenido
                console.log("Scroll set to 0 after content visible");

                // Placeholder de imagen DENTRO de modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-feather-alt placeholder-icon"></i> <!-- Icono pluma/naturaleza -->
                    <p style="font-size: 0.85em; margin-top: 0.8rem;">Generando ilustración...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Crear y añadir elemento imagen
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración o representación de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-eye-slash placeholder-icon"></i> <!-- Icono ojo tachado -->
                        <p style="font-size: 0.85em; margin-top: 0.8rem;">No se pudo cargar la imagen.</p>
                    `;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle placeholder-icon"></i>
                        <p style="font-size: 0.85em; margin-top: 0.8rem;">Error al generar URL de imagen.</p>
                    `;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
            }
        }

        async function handleGenerateMoreTitles() { /* ... (texto de botón/alerta actualizado) */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Explorando...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     appendTitles(newTitles);
                 } else {
                     alert("No se encontraron más especies o temas por ahora.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al explorar: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Especies y Temas';
             }
         }

         // *** NEW: Search Filter Function (sin cambios funcionales) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); // Normalize for accent insensitive search
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;

             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) {
                     visibleCount++;
                 }
             });

             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Hide if results OR if list is empty initially
         }

        // ========== INITIALIZATION ========== (sin cambios funcionales)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡Error Crítico! No se pudo iniciar la Enciclopedia Animal.</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Add Search Listener
            searchInput.addEventListener('input', (event) => {
                filterTitles(event.target.value);
            });

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden'); // Ensure hidden initially
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>