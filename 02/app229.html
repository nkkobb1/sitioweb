<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historias Bíblicas - Guía Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Clásicas/Bíblicas -->
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Historias Bíblicas --- */
        :root {
            --color-primary: #b8860b; /* Dorado Oscuro */
            --color-secondary: #8b4513; /* Marrón Silla de Montar */
            --color-tertiary: #4682b4; /* Azul Acero (Vitral/Cielo) */
            --color-background: #fdf5e6; /* Pergamino/Blanco Roto */
            --color-text: #3a2f2f; /* Marrón Oscuro/Casi Negro */
            --color-text-muted: #696969; /* Gris Dim */
            --color-modal-bg: #fffaf0; /* Floral Blanco (Ligeramente crema) */
            --color-border: #d2b48c; /* Tan (Borde pergamino) */
            --color-error-bg: #fde8e8; /* Fondo error rojo muy claro */
            --color-error-text: #991b1b; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo claro */

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 8px rgba(139, 69, 19, 0.1); /* Sombra marrón */
            --shadow-lg: 0 10px 20px rgba(184, 134, 11, 0.15), 0 3px 6px rgba(0, 0, 0, 0.1); /* Sombra dorada/negra */
            --border-radius: 4px; /* Bordes suaves */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'EB Garamond', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-secondary); } /* Marrón oscuro */
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
        h2.section-title { color: var(--color-secondary); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; font-size: 1.9rem; text-align: center; }
        .navbar { background-color: rgba(253, 245, 230, 0.85); /* Fondo pergamino semi-transparente */ backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(255, 250, 240, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(184, 134, 11, 0.2); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 500; color: var(--color-secondary); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'EB Garamond', serif; font-size: 1.05rem; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #fffef7; }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'EB Garamond', serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background-color: #a0740a; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #bcaaa4; color: #efefef; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(58, 47, 47, 0.85); /* Overlay marrón oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Altura para carga/juego/chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); box-shadow: 0 0 8px var(--color-primary); }

        /* Loading Indicator Area (Contiene el Juego) */
        #modal-loading { text-align: center; padding: 2rem 1rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 250, 240, 0.98); /* Fondo modal claro */ display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        /* Estilos del Minijuego */
        #loading-game-container { display: none; /* Oculto por defecto */ flex-direction: column; align-items: center; margin-top: 1.5rem; width: 90%; max-width: 400px; }
        #scrambled-word { font-family: 'EB Garamond', serif; font-size: 2.2rem; font-weight: 700; color: var(--color-secondary); margin-bottom: 1.5rem; letter-spacing: 4px; border: 1px dashed var(--color-border); padding: 0.5rem 1rem; background-color: #fff; }
        #game-input { font-family: 'Lato', sans-serif; width: 100%; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); margin-bottom: 1rem; text-align: center; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 2px; }
        #game-input:focus { outline: none; border-color: var(--color-primary); }
        #game-message { min-height: 20px; font-size: 0.95rem; font-style: italic; color: var(--color-tertiary); }
        .game-correct { color: #22c55e !important; /* Verde éxito */ font-weight: bold; }
        .game-incorrect { color: #ef4444 !important; /* Rojo error */ }
        .loading-spinner-modal { /* Spinner clásico como fallback o si el juego no carga */ width: 50px; height: 50px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p.loading-text { font-weight: 500; color: var(--color-text); font-size: 1.2rem; font-family: 'EB Garamond', serif; margin-top: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }
        #modal-content { padding: 0 5px; font-size: 1.05rem; /* Un poco más grande */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-secondary); font-weight: bold; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'EB Garamond', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 500; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-primary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 2px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; background-color: #fff; /* Fondo blanco si la imagen es transparente */ }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(210, 180, 140, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-border); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; background-color: #fdfbf7; /* Fondo ligeramente diferente */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(255, 255, 255, 0.6); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--color-tertiary); color: #fff; margin-left: auto; text-align: left; /* Mejor alineación izq para lectura */ box-shadow: var(--shadow-sm); }
        .ai-message { background-color: #eaddcc; /* Marrón claro */ color: var(--color-text); margin-right: auto; text-align: left; box-shadow: var(--shadow-sm); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(184, 134, 11, 0.15); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #a0740a; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }


        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(253, 245, 230, 0.95); /* Fondo pergamino */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: var(--shadow-lg); background-color: #fff; }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-book-bible mr-3 text-yellow-700"></i> <!-- Icono Biblia -->
                     Historias Bíblicas
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">Guía Interactiva</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora las Sagradas Escrituras</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre las narrativas, personajes y enseñanzas fundamentales de la Biblia. Selecciona una historia o busca un tema.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar historia, personaje, libro...">
             <i class="fas fa-search fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll text-yellow-600 mr-2"></i> <!-- Icono Rollo -->
                 Índice de Relatos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando índice de historias...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No se encontraron relatos para tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Mostrar Más Relatos (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Game -->
             <div id="modal-loading">
                  <!-- Spinner (Fallback or initial display) -->
                  <div class="loading-spinner-modal"></div>
                  <p class="loading-text">Cargando relato...</p>
                  <!-- Game Container -->
                  <div id="loading-game-container">
                      <p style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--color-secondary);">Mientras esperas, descifra la palabra:</p>
                      <div id="scrambled-word">PALABRA</div>
                      <input type="text" id="game-input" placeholder="Escribe tu respuesta aquí">
                      <p id="game-message"></p>
                  </div>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder go here -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando las escrituras...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta historia...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Ilustración Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-yellow-50 text-gray-600 py-6 mt-12 border-t border-yellow-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Relatos generados por IA basados en textos bíblicos con fines educativos y de referencia.</p>
              <p class="mt-1">Para estudios profundos, consulta fuentes teológicas y las Sagradas Escrituras.</p>
              <p class="mt-2">© 2025 Guía Bíblica Interactiva</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const numTitlesToGenerate = 40; // Número de títulos a generar con el botón
        const predefinedTitles = [
            // Génesis
            "La Creación del Mundo (Génesis 1-2)", "Adán y Eva en el Edén", "La Caída del Hombre (El Pecado Original)", "Caín y Abel", "El Arca de Noé y el Diluvio Universal", "La Torre de Babel", "El Llamado de Abraham", "Abraham y el Pacto con Dios", "Abraham e Isaac: El Sacrificio", "Isaac y Rebeca", "Jacob y Esaú: La Primogenitura", "La Escalera de Jacob", "Jacob Lucha con el Ángel", "José y sus Hermanos: La Túnica de Colores", "José en Egipto: Esclavo a Gobernador", "José se Reencuentra con sus Hermanos",
            // Éxodo
            "El Nacimiento de Moisés y su Rescate", "Moisés y la Zarza Ardiente", "Las Diez Plagas de Egipto", "El Cruce del Mar Rojo (Éxodo)", "El Maná en el Desierto", "Los Diez Mandamientos en el Sinaí", "El Becerro de Oro", "La Construcción del Tabernáculo",
            // Levítico, Números, Deuteronomio
            "Leyes y Sacrificios (Levítico)", "Los Espías en Canaán (Números)", "La Serpiente de Bronce", "Balaam y su Asna", "Las Leyes Deuteronómicas", "La Muerte de Moisés",
            // Josué, Jueces, Rut
            "La Conquista de Canaán: Jericó", "Josué y el Sol Detenido", "Los Jueces de Israel (Visión General)", "Gedeón y los 300 Hombres", "Sansón y Dalila", "La Historia de Rut y Booz",
            // Samuel, Reyes, Crónicas
            "El Llamado de Samuel", "Saúl, el Primer Rey de Israel", "David y Goliat", "David y Jonatán: Amistad", "David y Betsabé", "El Rey David como Salmista", "El Reinado de Salomón: Sabiduría", "La Construcción del Templo de Salomón", "La División del Reino (Israel y Judá)", "El Profeta Elías y los Profetas de Baal", "Elías es Llevado al Cielo", "El Profeta Eliseo: Milagros", "El Rey Ezequías y la Reforma", "El Rey Josías y el Hallazgo de la Ley", "La Destrucción de Jerusalén y el Exilio Babilónico",
            // Esdras, Nehemías, Ester
            "El Regreso del Exilio (Esdras)", "La Reconstrucción del Templo", "Nehemías Reconstruye los Muros de Jerusalén", "La Reina Ester Salva a su Pueblo",
            // Libros Sapienciales y Poéticos
            "La Paciencia de Job", "Los Salmos (Visión General)", "Salmo 23: El Señor es mi Pastor", "Salmo 91: Bajo la Sombra del Omnipotente", "Salmo 139: Maravillosamente Hecho", "Proverbios: La Sabiduría Divina", "Eclesiastés: Vanidad de Vanidades", "Cantar de los Cantares: El Amor",
            // Profetas Mayores
            "El Llamado del Profeta Isaías", "Isaías 53: El Siervo Sufriente", "El Profeta Jeremías: Lamentos", "Jeremías y el Nuevo Pacto", "Las Visiones de Ezequiel: El Valle de los Huesos Secos", "Daniel en el Foso de los Leones", "Los Compañeros de Daniel en el Horno de Fuego", "Las Profecías de Daniel",
            // Profetas Menores (Selección)
            "Oseas y Gomer: Amor Infiel", "El Libro de Jonás y la Ballena", "Amós: Justicia Social", "Miqueas: ¿Qué pide Dios de ti?", "Habacuc: El Justo por la Fe Vivirá", "Malaquías: El Mensajero Venidero",
            // Nuevo Testamento - Evangelios (Vida de Jesús)
            "La Anunciación a María", "El Nacimiento de Jesús en Belén", "La Visita de los Magos de Oriente", "La Huida a Egipto", "Jesús en el Templo a los 12 Años", "El Bautismo de Jesús por Juan el Bautista", "Las Tentaciones de Jesús en el Desierto", "El Llamado de los Primeros Discípulos", "Las Bodas de Caná (Primer Milagro)", "El Sermón del Monte: Las Bienaventuranzas", "El Sermón del Monte: Padre Nuestro", "El Sermón del Monte: No Juzguéis", "La Pesca Milagrosa", "Jesús Calma la Tempestad", "La Alimentación de los 5000 (Multiplicación de Panes y Peces)", "Jesús Camina sobre el Agua", "La Transfiguración de Jesús", "Parábola del Sembrador", "Parábola del Hijo Pródigo", "Parábola del Buen Samaritano", "Parábola de las Diez Vírgenes", "Parábola de los Talentos", "Jesús y la Mujer Samaritana", "La Resurrección de Lázaro", "La Entrada Triunfal en Jerusalén (Domingo de Ramos)", "La Última Cena", "Jesús Orando en Getsemaní", "El Arresto de Jesús", "El Juicio de Jesús ante Pilato", "La Crucifixión de Jesús", "Las Siete Palabras de Jesús en la Cruz", "La Muerte y Sepultura de Jesús", "La Resurrección de Jesús", "Las Apariciones de Jesús Resucitado (Emaús, Tomás)", "La Gran Comisión", "La Ascensión de Jesús",
            // Hechos de los Apóstoles
            "Pentecostés: La Venida del Espíritu Santo", "La Iglesia Primitiva: Compartir y Oración", "Pedro y Juan Sanan al Cojo", "Esteban, el Primer Mártir", "La Conversión de Saulo (Pablo)", "Pedro y Cornelio: El Evangelio a los Gentiles", "El Primer Viaje Misionero de Pablo", "El Concilio de Jerusalén", "El Segundo Viaje Misionero de Pablo (Filipos, Atenas, Corinto)", "El Tercer Viaje Misionero de Pablo (Éfeso)", "El Arresto de Pablo en Jerusalén", "Pablo ante Félix, Festo y Agripa", "El Viaje de Pablo a Roma (Naufragio)", "Pablo Prisionero en Roma",
            // Epístolas (Selección de Temas/Libros)
            "Romanos: La Justificación por la Fe", "1 Corintios 13: El Amor", "2 Corintios: El Ministerio de la Reconciliación", "Gálatas: La Libertad en Cristo", "Efesios: La Unidad del Cuerpo de Cristo", "Filipenses: El Gozo en Medio de las Pruebas", "Colosenses: La Supremacía de Cristo", "1 Tesalonicenses: La Segunda Venida de Cristo", "2 Timoteo: Pelea la Buena Batalla", "Filemón: Perdón y Restauración", "Hebreos: Cristo, Superior Sumo Sacerdote", "Santiago: La Fe y las Obras", "1 Pedro: El Sufrimiento por Cristo", "1 Juan: Dios es Amor",
            // Apocalipsis
            "La Visión de Juan en Patmos", "Las Cartas a las Siete Iglesias", "La Visión del Trono Celestial", "Los Cuatro Jinetes del Apocalipsis", "Los Sellos, Trompetas y Copas", "La Mujer y el Dragón", "Las Dos Bestias", "El Juicio Final", "Cielos Nuevos y Tierra Nueva", "La Nueva Jerusalén",
            // Conceptos Clave
            "El Pacto Abrahámico", "El Pacto Mosaico (La Ley)", "El Pacto Davídico", "El Nuevo Pacto en Cristo", "La Santísima Trinidad", "La Naturaleza de Dios (Atributos)", "El Pecado y la Redención", "La Gracia Divina", "La Fe", "El Amor (Ágape)", "La Esperanza Cristiana", "La Oración", "El Espíritu Santo", "Los Ángeles", "Satanás y los Demonios", "La Iglesia (Ekklesia)", "Los Sacramentos/Ordenanzas (Bautismo, Santa Cena)", "El Reino de Dios", "La Profecía Bíblica", "La Inspiración de las Escrituras", "El Canon Bíblico (Cómo se formó la Biblia)"
            // Lista extensa y variada
        ];
        const biblicalThemes = [ // Para generación de más títulos
            "historias del Génesis", "la vida de Moisés", "los Jueces de Israel", "el rey David", "el rey Salomón", "los profetas mayores", "los profetas menores", "parábolas de Jesús", "milagros de Jesús", "la Pasión de Cristo", "la Resurrección de Jesús", "los Hechos de los Apóstoles", "la vida del apóstol Pablo", "enseñanzas de las Epístolas", "temas del Apocalipsis", "personajes del Antiguo Testamento", "personajes del Nuevo Testamento", "libros de la Ley (Pentateuco)", "libros históricos", "libros poéticos y sapienciales", "libros proféticos", "los Evangelios", "conceptos teológicos clave", "lugares bíblicos importantes", "mujeres importantes en la Biblia"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un narrador y erudito bíblico respetuoso, claro y conocedor. Tu tarea es relatar la historia, describir al personaje o explicar el concepto bíblico indicado de forma detallada, fiel a las Escrituras y contextualizada. Incluye los eventos clave, personajes involucrados, significado teológico/histórico principal, y si es posible, referencias a pasajes relevantes (ej. Génesis 3, Juan 3:16). Utiliza un lenguaje respetuoso, accesible y narrativo. El objetivo es una exposición clara y completa de aproximadamente 1200-1300 palabras. Basa tu relato únicamente en la siguiente historia, personaje o concepto bíblico:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un guía o maestro de escuela dominical amable y experto. Responde preguntas de seguimiento *únicamente* sobre la historia, personaje o concepto bíblico que se está mostrando actualmente. Basa tus respuestas en la información bíblica estándar y sé conciso, claro y respetuoso.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: `Actúa como un generador de ideas conciso para una guía bíblica interactiva. Genera exactamente ${numTitlesToGenerate} nombres de historias significativas, personajes importantes, parábolas, milagros, libros, o conceptos clave de la Biblia (Antiguo y Nuevo Testamento). Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas. Prioriza variedad y relevancia.`,
            timeoutSeconds: 60 // Un poco más de tiempo para generar más títulos
        };
        // Palabras para el minijuego de carga
        const gameWords = ["ADAN", "EVA", "NOE", "ARCA", "MOISES", "EXODO", "LEY", "DAVID", "GOLIAT", "SALOMON", "TEMPLO", "ISAIAS", "JERUSALEN", "BELEN", "JESUS", "MARIA", "CRUZ", "PASCUA", "FE", "AMOR", "PABLO", "ROMA", "ANGEL", "EDEN", "MANA", "RUT", "JOB", "SALMO", "DANIEL", "JONAS", "PEDRO", "MATEO", "LUCAS", "JUAN", "APOCALIPSIS"];


        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Loading Game Elements
        const loadingGameContainer = document.getElementById('loading-game-container');
        const loadingSpinner = modalLoadingIndicator.querySelector('.loading-spinner-modal');
        const loadingText = modalLoadingIndicator.querySelector('.loading-text');
        const scrambledWordDisplay = document.getElementById('scrambled-word');
        const gameInput = document.getElementById('game-input');
        const gameMessage = document.getElementById('game-message');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Contexto del chat
        let currentGameWord = ''; // Palabra actual del minijuego
        let gameActive = false; // Estado del minijuego

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentStoryTitle
                ? `Actúa como un guía o maestro amable y experto. Responde preguntas de seguimiento *únicamente* sobre la historia, personaje o concepto bíblico '${currentStoryTitle}'. Basa tus respuestas en la información bíblica estándar y sé conciso, claro y respetuoso.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores parecen tener mucho tráfico ahora. Por favor, inténtalo de nuevo en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta de nuevo o con otra consulta.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o espera un momento.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }
        async function fetchExplanationText(storyTitle) { return fetchTextFromApi(storyTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentStoryTitle) throw new Error("Error interno: Contexto del relato no establecido para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(biblicalThemes) || "historias bíblicas generales";
            const specificPrompt = `Genera ${numTitlesToGenerate} ítems (historias, personajes, conceptos) sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de relatos.");
                     return titles.slice(0, numTitlesToGenerate); // Asegura que no exceda el número pedido
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Biblical scene illustration";
            const enhancedPrompt = `Artwork inspired by the biblical story or figure '${safePromptText}'. Style: illuminated manuscript OR stained glass OR classical painting OR symbolic representation. Focus on scene, symbols, atmosphere. Avoid text, labels, realistic faces for divine figures.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, photograph, photorealistic, modern setting, watermark, signature, multiple panels, logo";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (exactamente la misma función que antes) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            stopLoadingGame(); // Asegura que el juego se detenga al cerrar
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null;
             // Reset Game State
             stopLoadingGame();
             // Reset Fullscreen Image
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden'; }
        function hideFullscreenImage() { /* ... */ if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src=''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... */ const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errDiv=document.createElement('div');errDiv.classList.add('chat-error');errDiv.textContent=message;chatHistory.appendChild(errDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const q=chatInput.value.trim();if(!q||chatSendBtn.disabled)return;addChatMessage(q,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const r=await fetchChatResponse(q);addChatMessage(r,'ai');}catch(e){console.error("Chat Error:",e);addChatError(`Error IA: ${e.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();} }

        // ========== LOADING MINIGAME FUNCTIONS ==========
        function scrambleWord(word) {
            let a = word.toUpperCase().split(""), n = a.length;
            // Evitar que la palabra quede igual (si es corta, podría pasar)
            let scrambled = a.slice();
            let maxAttempts = 10;
            do {
                for(let i = n - 1; i > 0; i--) {
                    let j = Math.floor(Math.random() * (i + 1));
                    [scrambled[i], scrambled[j]] = [scrambled[j], scrambled[i]];
                }
                maxAttempts--;
            } while (scrambled.join("") === word && maxAttempts > 0); // Intentar de nuevo si es igual
            return scrambled.join("");
        }
        function showNewGameWord() {
            currentGameWord = getRandomElement(gameWords);
            const scrambled = scrambleWord(currentGameWord);
            scrambledWordDisplay.textContent = scrambled;
            gameInput.value = '';
            gameMessage.textContent = 'Intenta descifrarla...';
            gameMessage.className = 'game-message'; // Reset class
            gameInput.disabled = false;
            gameInput.focus();
        }
        function checkGameGuess() {
            const guess = gameInput.value.trim().toUpperCase();
            if (!guess || !gameActive) return;

            if (guess === currentGameWord) {
                gameMessage.textContent = `¡Correcto! Era ${currentGameWord}. Cargando nuevo...`;
                gameMessage.className = 'game-message game-correct';
                gameInput.disabled = true; // Prevenir más intentos hasta la nueva palabra
                setTimeout(showNewGameWord, 1500); // Mostrar nueva palabra después de un breve delay
            } else {
                gameMessage.textContent = 'Incorrecto. ¡Sigue intentando!';
                gameMessage.className = 'game-message game-incorrect';
                gameInput.select(); // Seleccionar texto para facilitar corrección
            }
        }
        function startLoadingGame() {
            if (!loadingGameContainer || !loadingSpinner || !loadingText) return;
            gameActive = true;
            loadingSpinner.style.display = 'none'; // Ocultar spinner
            loadingText.style.display = 'none'; // Ocultar texto "Cargando..."
            loadingGameContainer.style.display = 'flex'; // Mostrar juego
            showNewGameWord();
        }
        function stopLoadingGame() {
             if (!loadingGameContainer || !loadingSpinner || !loadingText) return;
             gameActive = false;
             loadingGameContainer.style.display = 'none'; // Ocultar juego
             loadingSpinner.style.display = 'block'; // Mostrar spinner de nuevo (o no, si ya cargó)
             loadingText.style.display = 'block';
             currentGameWord = '';
             gameInput.value = '';
             gameMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... (igual que antes) ... */ let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { /* ... (igual que antes) ... */ const div=document.createElement('div');div.className='title-item';div.textContent=title;div.setAttribute('data-title',title);div.addEventListener('click',()=>handleTitleClick(title));return div; }
        function displayTitles(titles) { /* ... (igual que antes) ... */ if(!titleListContainer||!titlesLoading)return;const sortedTitles=titles.sort((a,b)=>a.localeCompare(b));titleListContainer.innerHTML='';titlesLoading.style.display='none';if(sortedTitles.length===0){titleListContainer.innerHTML='<p class="text-gray-500 col-span-full text-center font-sans">No hay relatos disponibles en el índice.</p>';return;} sortedTitles.forEach(title=>titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { /* ... (igual que antes) ... */ if(!titleListContainer||!newTitles||newTitles.length===0)return;const existingTitles=new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item=>item.dataset.title));newTitles.forEach(title=>{if(!existingTitles.has(title)){titleListContainer.appendChild(createTitleItem(title));}});filterTitles(searchInput.value); }

        // *** MODIFIED: handleTitleClick to integrate game start/stop ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title;
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';
            startLoadingGame(); // <<< START THE GAME

            try {
                const rawExplanationText = await fetchExplanationText(title);
                stopLoadingGame(); // <<< STOP THE GAME (API success)
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none'; // Hide loading area (game included)
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Image Placeholder & Loading (within modalContent)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Cargando ilustración...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración sobre ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Ilustración no disponible.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { /* error handled by onerror */ }

            } catch (error) {
                console.error("Failed display:", error);
                stopLoadingGame(); // <<< STOP THE GAME (API error)
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el relato.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles to request 40 ***
        async function handleGenerateMoreTitles() {
            if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
            generateMoreBtn.disabled = true;
            generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más relatos...';
            try {
                // Note: The config already specifies numTitlesToGenerate in the prompt
                const newTitles = await fetchGeneratedTitles();
                if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                else { alert("No se pudieron encontrar más relatos en este momento."); }
            } catch (error) {
                console.error("Failed title generation:", error);
                alert(`Error al buscar relatos: ${error.message}`);
            } finally {
                generateMoreBtn.disabled = false;
                // Update button text to reflect the number
                generateMoreBtn.innerHTML = `<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Mostrar Más Relatos (${numTitlesToGenerate})`;
            }
        }

        // *** Search Filter Function (con normalización) ***
        function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check essential elements
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !loadingGameContainer) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #8b0000; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: No se pudieron cargar los componentes de la página. Por favor, recarga.</p>';
                return;
             }
            // Initial Button Text
            generateMoreBtn.innerHTML = `<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Mostrar Más Relatos (${numTitlesToGenerate})`;

            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Game Input Listener
            gameInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter' && gameActive) {
                    checkGameGuess();
                }
            });
            // Optional: Check on button click if you add a button

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>