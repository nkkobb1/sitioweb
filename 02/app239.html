<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archivos Shinigami - Historias de la Death Note</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Temáticas -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,700;1,400&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Shinigami/Death Note --- */
        :root {
            --color-primary: #DC2626; /* Rojo Sangre Oscuro */
            --color-secondary: #ffffff; /* Blanco Hueso/Puro */
            --color-tertiary: #a1a1aa; /* Gris Metálico Claro (para acentos) */
            --color-background: #111111; /* Negro/Gris Muy Oscuro */
            --color-text: #e5e7eb; /* Gris Muy Claro */
            --color-text-muted: #9ca3af; /* Gris Medio */
            --color-modal-bg: #1f1f1f; /* Gris Carbón */
            --color-border: #4b5563; /* Borde Gris Oscuro */
            --color-error-bg: #3f1212; /* Fondo error rojo oscuro */
            --color-error-text: #fecaca; /* Texto error claro */
            --color-error-border: #DC2626; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(220, 38, 38, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(220, 38, 38, 0.15), 0 2px 4px -2px rgba(220, 38, 38, 0.1);
            --shadow-lg: 0 0 20px -5px rgba(220, 38, 38, 0.25), 0 8px 10px -6px rgba(220, 38, 38, 0.2);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Crimson Text', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23222222' fill-opacity='0.2'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l-2.83-2.83 1.41-1.41L20 17.17l1.41-1.41 1.41 1.41L20 18.6zm0 2.83l2.83 2.83-1.41 1.41L20 22.83l-1.41 1.41-1.41-1.41L20 21.43zm14.14-7.07l2.83-2.83-1.41-1.41L32.73 10.3l-1.41 1.41zm-2.83 14.14l1.41-1.41-2.83-2.83-1.41 1.41 2.83 2.83zm-14.14 2.83l2.83 2.83 1.41-1.41L22.83 30l-1.41-1.41zm14.14 0l-2.83 2.83-1.41-1.41L37.17 30l1.41-1.41zm-2.83-14.14l-1.41 1.41 2.83 2.83 1.41-1.41-2.83-2.83zM10 30l-2.83 2.83-1.41-1.41L7.17 30l-1.41-1.41zm2.83-14.14l1.41 1.41-2.83 2.83-1.41-1.41 2.83-2.83zm-1.41-1.41l-2.83-2.83 1.41-1.41L10 12.83l1.41 1.41zM7.27 10.3l-1.41-1.41-2.83 2.83 1.41 1.41 2.83-2.83z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); /* Subtle background pattern */
        }
        h1, h2, h3, h4, .logo, #generate-more-btn, #modal-title, #loading-minigame button { font-family: 'Poppins', sans-serif; font-weight: 600; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px rgba(220, 38, 38, 0.5); }
        h1.page-title { color: var(--color-secondary); font-weight: 600; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }
        h2.section-title { color: var(--color-secondary); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 600; }
        #modal-title { color: var(--color-primary); font-weight: 600; text-shadow: 0 0 5px rgba(220, 38, 38, 0.4); }
        .navbar { background-color: rgba(17, 17, 17, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Search Input */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(31, 31, 31, 0.9); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Poppins'; font-weight: 300; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.25); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        /* Title List */
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Poppins'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #2a2a2a; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: var(--color-primary); color: var(--color-secondary); padding: 0.9rem 1.8rem; border: 1px solid rgba(255,255,255,0.1); border-radius: var(--border-radius); font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        #generate-more-btn:hover:not(:disabled) { background-color: #b91c1c; /* Rojo más oscuro */ box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-secondary); }

        /* Modal */
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 10, 10, 0.92); backdrop-filter: blur(3px); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Increased for game/chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-secondary); transform: rotate(90deg); box-shadow: 0 0 10px var(--color-primary); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Content Area (Scrollable Text + Fixed Chat) */
        #modal-story-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; /* Prevent wrapper scroll */ }
        #modal-content-area { /* Scrollable text/image area */
            flex-grow: 1; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem; min-height: 150px; /* Ensure some space */
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(69, 85, 107, 0.3);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(69, 85, 107, 0.3); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }
        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Poppins', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 600; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Image Styles */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 15px rgba(220, 38, 38, 0.3); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(75, 85, 99, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles (Same as before, adjusted colors) */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 200px; /* Slightly reduced height */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(17, 17, 17, 0.7); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(69, 85, 107, 0.3);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(69, 85, 107, 0.3); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-family: 'Poppins', sans-serif; font-weight: 300; font-size: 0.95em;}
        .user-message { background-color: var(--color-primary); color: var(--color-secondary); margin-left: auto; text-align: right; }
        .ai-message { background-color: #374151; color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #2a2a2a; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Poppins'; font-weight: 300; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-secondary); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #b91c1c; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator & Minigame */
        #modal-loading { text-align: center; padding: 2rem 1rem; /* Reduced padding to make space */ position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(17, 17, 17, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1rem auto; /* Reduced margin */ }
        #modal-loading p.loading-text { font-weight: 400; color: var(--color-text); font-size: 1.3rem; font-family: 'Poppins'; text-shadow: 0 0 5px var(--color-primary); margin-bottom: 1.5rem; } /* Added class */
        /* Minigame Styles */
        #loading-minigame { display: none; /* Hidden by default */ flex-direction: column; align-items: center; margin-top: 1rem; animation: fadeIn 0.5s ease; }
        #minigame-target { font-size: 3rem; color: var(--color-primary); cursor: pointer; transition: transform 0.1s ease, text-shadow 0.1s ease; margin-bottom: 0.8rem; }
        #minigame-target:hover { text-shadow: 0 0 15px var(--color-primary); }
        #minigame-target:active { transform: scale(0.9); }
        #minigame-score { font-family: 'Poppins'; font-size: 1.1rem; color: var(--color-secondary); font-weight: 600; }
        #minigame-score span { font-weight: 700; color: var(--color-primary); margin-left: 5px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Error Message */
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Poppins'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay (Same as before, colors adjusted) */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 10, 10, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-secondary); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-book-dead mr-3"></i> <!-- Icono Libro Muerto -->
                     Archivos Shinigami
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">« Crónicas de la Death Note »</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">El Eco del Reino Muerto</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light leading-relaxed">Explora relatos perdidos, reglas olvidadas y los destinos entrelazados por el poder de la Death Note. Selecciona un archivo o busca un nombre.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar archivo, regla, nombre...">
             <i class="fas fa-feather-alt fa-search"></i> <!-- Icono Pluma/Búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-archive text-red-600 mr-2"></i> <!-- Icono Archivo -->
                 Índice de Registros
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Consultando los registros del Reino Shinigami...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">« Ningún registro coincide con la consulta »</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Solicitar Nuevos Registros (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator & Minigame -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p class="loading-text">Descifrando registro...</p>
                 <!-- Minigame Area -->
                 <div id="loading-minigame">
                    <i id="minigame-target" class="fas fa-apple-alt" title="¡Click!"></i> <!-- Manzana Clickable -->
                    <div id="minigame-score">Manzanas: <span>0</span></div>
                 </div>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden">
                 <!-- Scrollable Text/Image Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder added via JS -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al Shinigami...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este registro...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta"><i class="fas fa-feather-alt"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-black text-gray-600 py-6 mt-12 border-t border-gray-800 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Relatos generados por IA, inspirados en el universo Death Note. No forman parte del canon oficial.</p>
              <p class="mt-1">El uso de una Death Note conlleva consecuencias imprevistas.</p>
              <p class="mt-2">© ???? Archivos Shinigami</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Shinigamis Ficticios (Perfil)
            "Perfil de Zenos, el Coleccionista de Secretos", "La Historia de Lyra, la Shinigami Melancólica", "Ryuk: Más allá de las Manzanas (Análisis Extendido)", "Rem: Lealtad y Sacrificio (Estudio Profundo)", "Sidoh: El Shinigami Olvidadizo (Crónica)", "Gelus: Amor y Muerte (Legado)", "Armonia Justin Beyondormason: El Joyero Shinigami", "Meadra: La Shinigami de las Apuestas Extremas", "King of Death: Origen y Poderes (Teorías)", "Calikarcha: El Shinigami Cartógrafo", "Gook: El Perezoso Observador", "Dellidubly: El Jugador Compulsivo", "Nu: La Shinigami del Silencio", "Kinddara Guivelostain: La Shinigami Ruidosa", "Daril Ghiroza: La Artesana de Huesos", "Perfil de Kaelen, el Shinigami Filósofo", "La Tragedia de Nimue, la Shinigami Artista", "Crónicas de Volkov, el Shinigami Cazador", "El Enigma de Seraphina, la Shinigami Guardiana", "Raxus, el Shinigami Comerciante de Información", "Historias de Malkor, el Shinigami Historiador", "El Dilema de Elara, la Shinigami Empática", "Perfil de Grok, el Shinigami Primitivo", "La Leyenda de Umbra, la Shinigami de las Sombras", "Zephyr, el Shinigami del Viento y el Olvido",
            // Death Notes Ficticias (Propiedades)
            "La Death Note Carmesí: Escribir con Sangre", "El Diario del Destino: Predicciones Mortales", "La Death Note Espejo: Reflejar la Causa de Muerte", "El Cuaderno de Ecos: Muertes Retardadas", "La Death Note Fantasma: Nombres Invisibles", "El Libro de las Paradojas: Muertes Contradictorias", "La Death Note Temporal: Matar en el Pasado/Futuro (Limitado)", "El Codex de Almas: Robar Habilidades al Morir", "La Death Note Elemental: Causas de Muerte Naturales", "El Cuaderno Silente: Muertes sin Testigos", "La Death Note de Nombres Verdaderos: Requiere Identidad Profunda", "El Pergamino de la Vida Robada: Añadir Años de Vida", "La Death Note Colectiva: Requiere Múltiples Escritores", "El Libro de los Susurros: Indicar Últimos Pensamientos", "La Death Note Lunar: Poder Variable según la Fase Lunar", "El Cuaderno de Intercambio: Trueque de Vidas", "La Death Note Simbiótica: Vinculada a un Objeto", "El Tomo de la Mentira: Muertes Basadas en Engaños", "La Death Note Ancestral: Poder Heredado", "El Libro de Arena: Nombres que se Desvanecen",
            // Reglas Ficticias / Interpretaciones
            "Regla LXXVIII: El Shinigami puede prestar sus ojos a cambio de recuerdos.", "Regla XCII: Una Death Note destruida libera las almas escritas.", "Regla CVI: Escribir el propio nombre otorga inmunidad temporal.", "Regla CXV: Las muertes causadas indirectamente reducen la vida del Shinigami.", "Regla CXXXI: Un humano que vea a dos Shinigamis puede percibir el Reino.", "Regla CXLIV: La Death Note rechaza nombres de niños menores de 777 días.", "Regla CLX: Mentir sobre las reglas a un humano acorta la vida del Shinigami.", "Regla CLXXII: El último nombre escrito determina el destino del usuario.", "Regla CXC: Intercambiar Death Notes entre humanos transfiere propiedad y recuerdos.", "Regla CCXI: Los animales no pueden ser nombrados, pero sí afectados indirectamente.", "Regla CCXXXIII: Un Shinigami puede vetar una muerte si viola un 'código' mayor.", "Regla CCLV: La Death Note puede 'curarse' de daños menores.", "Regla CCLXXI: El contacto físico prolongado con una Death Note revela visiones.", "Regla CCXCIX: Los Shinigami que no matan se desvanecen lentamente.", "Regla CCCXIII: El Rey Shinigami puede alterar una regla cada milenio.", "Interpretación: ¿Qué significa 'Ataque al Corazón' en términos Shinigami?", "Análisis: La paradoja del Shinigami enamorado.", "Debate: ¿Es el Reino Shinigami una prisión o un purgatorio?", "Teoría: El origen de la primera Death Note.", "Consecuencias de quemar una página específica.",
            // Historias Ficticias (Humanos / Eventos)
            "El Detective que Cazaba Shinigamis", "La Artista que Pintaba el Futuro con la Death Note", "El Músico cuya Melodía Mataba", "El Político que Usó la Death Note para Crear una Utopía", "El Científico que Intentó Replicar la Death Note", "La Historia de un Niño que Encontró una Death Note", "El Culto que Adoraba a un Usuario de Death Note", "El Intercambio de Notas entre Rivales", "Un Mundo Sin Kira: ¿Qué Hubiera Pasado?", "El Día que Llovieron Death Notes", "La Resistencia Humana Contra los Shinigamis", "El Shinigami que Eligió Vivir como Humano", "La Última Página de la Death Note de Light Yagami (Ficticio)", "El Legado Olvidado de Misa Amane (Ficticio)", "Near y Mello: Una Colaboración Imposible (Ficticio)", "El Caso del Asesino que Imitaba a Kira", "La Death Note en Manos de un Filósofo Nihilista", "El Intento de Destruir Todas las Death Notes", "Un Amor Prohibido entre Humano y Shinigami", "El Juicio Final de los Usuarios de Death Note",
            // Reino Shinigami (Lugares / Sociedad)
            "Descripción de la Biblioteca de Almas Perdidas", "El Mercado Negro de Información Shinigami", "Las Arenas de Juego: Apuestas de Vidas Humanas", "Los Jardines Marchitos del Rey Shinigami", "La Jerarquía Shinigami: Poder y Obligaciones", "Rituales y Costumbres de los Shinigami", "La Creación de un Nuevo Shinigami (Teorías)", "El Castigo para Shinigamis que Rompen Reglas Graves", "Tecnología (o su ausencia) en el Reino Shinigami", "El Portal entre el Mundo Humano y el Reino Shinigami", "Fauna (si existe) en el Reino Shinigami", "El Arte y la Música (o su vacío) en el Reino Shinigami", "La Moneda de Cambio: Tiempo de Vida y Secretos", "Leyendas y Mitos dentro de la Sociedad Shinigami", "El Concepto de 'Aburrimiento' Shinigami",
            // Dilemas Morales / Filosofía
            "Justicia vs Asesinato: El Legado Ético de Kira", "El Valor de una Vida Humana para un Shinigami", "Libre Albedrío vs Determinismo en la Death Note", "La Naturaleza del Mal: ¿Nace o se Hace (con la Nota)?", "¿Puede un Shinigami Sentir Arrepentimiento?", "La Corrupción del Poder Absoluto (Death Note)", "Mortalidad, Inmortalidad y el Deseo de Vivir", "El Significado de 'Paraíso' e 'Infierno' en Death Note", "La Responsabilidad del Conocimiento (Ojos Shinigami)", "El Sacrificio por Amor: ¿Debilidad o Fortaleza?", "La Búsqueda de un Mundo Perfecto: ¿Un Objetivo Válido?", "La Curiosidad como Motor Shinigami", "El Papel del Azar y la Coincidencia", "La Soledad del Poder (Usuario y Shinigami)", "El Engaño como Herramienta de Supervivencia",
            // Escenarios Alternativos ("What If...")
            "¿Y si L hubiera conseguido la Death Note primero?", "¿Y si Misa nunca hubiera conocido a Light?", "¿Y si Ryuk se hubiera encariñado con Light?", "¿Y si Near hubiera fallado?", "¿Y si existiera una 'Life Note'?", "¿Y si un Shinigami pudiera revivir a un humano?", "¿Y si la Task Force hubiera aceptado la ayuda de Shinigamis?", "¿Y si Light hubiera renunciado a la Note permanentemente?", "¿Y si el padre de Light hubiera sobrevivido?", "¿Y si hubiera múltiples 'Kiras' simultáneos?", "¿Y si la Death Note afectara a seres no humanos?", "¿Y si el Rey Shinigami interviniera directamente?", "¿Y si se pudiera escribir 'Desconocido' como causa de muerte?", "¿Y si los Shinigamis tuvieran emociones humanas plenas?", "¿Y si un humano pudiera robar permanentemente los ojos de un Shinigami?",
            // Y muchos más conceptos abstractos o específicos...
        ];
        const shinigamiThemes = [ // Para generar nuevos títulos
            "Shinigamis ficticios", "reglas de la Death Note", "historias de usuarios humanos", "el Reino Shinigami", "dilemas morales de Death Note", "escenarios alternativos de Kira", "poderes de Shinigami", "tipos de Death Notes", "la relación humano-Shinigami", "el legado de L", "el aburrimiento Shinigami", "secretos del Rey Shinigami", "consecuencias imprevistas de la Death Note", "justicia y muerte", "el precio de los ojos Shinigami"
        ];
        const textApiConfig = { // Descripción principal
            model: "mistral",
            systemPrompt: "Eres un antiguo cronista del Reino Shinigami, encargado de documentar historias, reglas y perfiles relacionados con las Death Notes y sus portadores. Describe el registro solicitado (historia ficticia, Shinigami inventado, regla especulativa, etc.) con un tono oscuro, atmosférico y detallado, como si fuera un fragmento perdido de los archivos Shinigami. Incluye contexto, detalles relevantes, posibles implicaciones y el estilo narrativo característico del universo Death Note. Sé exhaustivo y proporciona aproximadamente 1200-1300 palabras. Basa tu crónica únicamente en el siguiente registro:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Chat contextual
            model: "mistral-tiny", // Modelo más rápido
            systemPrompt: "Actúa como un Shinigami observador y algo cínico (similar a Ryuk pero menos juguetón, más neutral/informativo). Responde preguntas específicas sobre el registro actual que se está viendo. Limítate estrictamente al tema en cuestión. Tus respuestas deben ser concisas, directas y mantener el tono del universo Death Note.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // Generar 40 títulos nuevos
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para los archivos del Reino Shinigami. Genera exactamente 40 nombres evocadores de historias ficticias, Shinigamis inventados, reglas especulativas, dilemas morales o conceptos relacionados con el universo Death Note. Devuelve *solo* la lista, un ítem por línea. Sin números, guiones, introducciones ni comentarios.",
            timeoutSeconds: 60 // Aumentar un poco por si pide más
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, pero añadiendo elementos del minigame)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const loadingMinigameArea = document.getElementById('loading-minigame');
        const minigameTarget = document.getElementById('minigame-target');
        const minigameScoreDisplay = document.getElementById('minigame-score').querySelector('span');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Contexto para chat
        let minigameScore = 0;
        let minigameActive = false;

        // ========== API FUNCTIONS ==========
        // fetchTextFromApi (igual, usa systemPrompt dinámico para chat)
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentTopicTitle
                ? `Eres un Shinigami observador y algo cínico. Responde preguntas específicas sobre el registro '${currentTopicTitle}'. Sé conciso, directo y mantén el tono del universo Death Note. Limítate estrictamente al tema.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Los servidores Shinigami parecen ocupados o indiferentes. Inténtalo de nuevo en un momento.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta desde el Reino Muerto fue... silencio. Intenta otra consulta.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión con el Reino Shinigami se desvaneció (>${config.timeoutSeconds}s). Comprueba tu vínculo o espera.`);
                }
                throw new Error(error.message || "Una interferencia desconocida bloqueó la respuesta.");
            }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) {
            if (!currentTopicTitle) throw new Error("Error interno: Contexto del registro perdido.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        // *** MODIFIED: fetchGeneratedTitles to request 40 ***
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(shinigamiThemes) || "historias del universo Death Note";
            // Prompt pide explícitamente 40
            const specificPrompt = `Genera 40 ideas (historias, reglas, Shinigamis) sobre ${randomTheme}`;
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) }; // Add random seed
            return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 20) throw new Error("La IA no generó suficientes registros nuevos."); // Umbral más alto
                     return titles.slice(0, 40); // Devuelve hasta 40
                 });
        }
        // createPollinationsImageUrl (adaptado a tema)
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Shinigami Realm concept art";
             const enhancedPrompt = `Dark, atmospheric artwork inspired by '${safePromptText}'. Death Note universe aesthetic, gothic, mysterious, shadows, perhaps subtle hints of red or ethereal glow. Focus on mood and concept. Avoid bright colors, text, labels. Anime/manga influence acceptable.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "photorealistic, realistic human face, bright daylight, happy, cheerful, vibrant colors, text, words, labels, signature, watermark, UI, multiple panels, diagram";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (copiar la misma función de antes) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
             endMinigame(); // Asegurarse que el minijuego termina
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (copiar la misma función de antes) ... */
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() { /* ... (copiar la misma función de antes) ... */
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios funcionales)
        function addChatMessage(message, sender) { /* ... (copiar la misma función de antes) ... */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... (copiar la misma función de antes) ... */
            const errorDiv = document.createElement('div');
            errorDiv.classList.add('chat-error');
            errorDiv.textContent = message;
            chatHistory.appendChild(errorDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... (copiar la misma función de antes) ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error Shinigami: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== MINIGAME FUNCTIONS ==========
        function handleMinigameClick() {
            if (!minigameActive) return;
            minigameScore++;
            minigameScoreDisplay.textContent = minigameScore;
            // Pequeña animación de feedback
            minigameTarget.style.transform = 'scale(1.15)';
            setTimeout(() => {
                 if(minigameTarget) minigameTarget.style.transform = 'scale(1)';
            }, 100);
        }
        function startMinigame() {
            if (!loadingMinigameArea || !minigameTarget || !minigameScoreDisplay) return;
            console.log("Starting minigame...");
            minigameScore = 0;
            minigameScoreDisplay.textContent = minigameScore;
            loadingMinigameArea.style.display = 'flex'; // Mostrar área del juego
            minigameActive = true;
            minigameTarget.addEventListener('click', handleMinigameClick);
        }
        function endMinigame() {
            if (!loadingMinigameArea || !minigameTarget) return;
             console.log("Ending minigame. Final Score:", minigameScore);
             minigameActive = false;
             loadingMinigameArea.style.display = 'none'; // Ocultar área del juego
             // Quitar listener para evitar clicks accidentales después
             // Es importante quitar el listener específico, no todos los clicks
            minigameTarget.removeEventListener('click', handleMinigameClick);
        }


        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">« Archivos vacíos o inaccesibles »</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to integrate minigame ***
        async function handleTitleClick(title) {
            resetModalState(); // Resets everything, including ending previous game
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; // Show loading overlay

            startMinigame(); // *** START THE MINIGAME ***

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // Content is ready, prepare to display
                modalContent.innerHTML = formattedExplanation; // Set text content

                // Prepare image placeholder (added after text)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Visualizando escena...</p>`;
                modalContent.appendChild(placeholderDiv);

                 // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización de ${title}`;
                imgElement.style.display = 'none'; // Hide until loaded

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Image load error:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización corrupta.</p>`;
                };

                 const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                 } else {
                    console.error("Could not create image URL:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                 }

            } catch (error) {
                console.error("Failed display:", error);
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el registro.";
                modalError.classList.remove('content-hidden');
                modalContent.innerHTML = ''; // Clear partial content
                chatSection.classList.add('content-hidden');
            } finally {
                 // *** END THE MINIGAME (whether success or error) ***
                 endMinigame();
                 modalLoadingIndicator.style.display = 'none'; // Hide loading overlay
                 modalStoryContentArea.classList.remove('content-hidden'); // Show content/error area
                 modalTextArea.scrollTop = 0; // Reset scroll AFTER content is visible
                 console.log("Scroll set to 0 after content visible / error shown");
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles to request 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             // Updated button text
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando Archivos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40 now
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se encontraron nuevos registros en esta consulta."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al solicitar registros: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Updated button text
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Solicitar Nuevos Registros (40)';
             }
         }

         // Search Filter Function (sin cambios)
         function filterTitles(searchTerm) { /* ... (copiar la misma función de antes) ... */
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Include minigame elements in check
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !loadingMinigameArea || !minigameTarget || !minigameScoreDisplay) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #DC2626; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: sans-serif;">Error Crítico: Fallo al cargar componentes de la interfaz.</p>';
                return;
             }
            // Basic Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            // Chat Listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            // Fullscreen Image Listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            // Ensure minigame is initially hidden
            loadingMinigameArea.style.display = 'none';
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>