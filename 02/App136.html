<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conceptos de Economía - Nivel Intermedio</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Clean, Readable Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Conceptos de Economía --- */
        :root {
            --color-primary: #2563eb; /* Azul Principal (Confianza, Estabilidad) */
            --color-secondary: #10b981; /* Verde (Crecimiento, Positivo) */
            --color-tertiary: #f59e0b; /* Amarillo/Oro (Valor - uso moderado) */
            --color-background: #f9fafb; /* Blanco Hueso / Gris Muy Claro */
            --color-text: #1f2937; /* Gris Muy Oscuro */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro */
            --color-border: #e5e7eb; /* Borde Gris Claro */
            --color-error-bg: #fef2f2; /* Fondo error rojo muy claro */
            --color-error-text: #b91c1c; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #ffffff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); outline: none; background-color: #ffffff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 500; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Roboto', sans-serif; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-border); border-left-color: var(--color-primary); color: var(--color-primary); background-color: #f3f4f6; /* Gris claro hover */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1d4ed8; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Increased height */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e5e7eb; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(209, 213, 219, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; /* Light background for chat */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: #ffffff; margin-left: auto; text-align: left; } /* User messages on right, text aligned left */
        .ai-message { background-color: #e5e7eb; /* Light gray for AI */ color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #ffffff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-secondary); color: #ffffff; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.95rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #059669; }
        #chat-send-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 500; color: var(--color-text); font-size: 1.3rem; font-family: 'Roboto'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.95); /* Dark overlay */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-modal-bg); box-shadow: var(--shadow-lg); background-color: var(--color-modal-bg); /* Add background for images with transparency */ }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-modal-bg); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-chart-line mr-3 text-blue-600"></i> <!-- Icono gráfico -->
                     Economía Intermedia
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">» Explorador de Conceptos «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Descubre los Conceptos Clave</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora definiciones, modelos y aplicaciones de la economía a un nivel intermedio. Selecciona un tema o utiliza el buscador.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar concepto económico...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-green-600 mr-2"></i> <!-- Icono libro -->
                 Índice Temático
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando conceptos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron conceptos para tu búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Más Conceptos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Cargando explicación...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <h3 class="text-lg font-semibold mb-2 text-gray-700 text-center font-roboto">¿Preguntas sobre "<span id="chat-context-title">este concepto</span>"?</h3>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Escribe tu pregunta aquí...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA con fines educativos. Consulta fuentes académicas para estudios formales.</p>
              <p class="mt-1">Los modelos y conceptos pueden tener simplificaciones.</p>
              <p class="mt-2">© 2025 Explorador Económico</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Microeconomía - Consumidor
            "Teoría de la Utilidad Ordinal", "Curvas de Indiferencia: Propiedades", "Restricción Presupuestaria", "Elección Óptima del Consumidor", "Efecto Sustitución y Efecto Renta (Ingreso)", "Curva de Demanda Individual Derivada", "Elasticidad Precio de la Demanda", "Elasticidad Cruzada de la Demanda", "Elasticidad Renta (Ingreso) de la Demanda", "Excedente del Consumidor", "Función de Utilidad Cobb-Douglas", "Preferencias Cuasilineales", "Demanda Compensada (Hicksiana)", "Dualidad en la Teoría del Consumidor", "Índices de Precios (Laspeyres, Paasche)", "Axiomas de Preferencia del Consumidor", "Bien Giffen: Definición y Condiciones", "Bien Veblen: Características", "Teoría de la Preferencia Revelada",
            // Microeconomía - Productor
            "Función de Producción a Corto Plazo", "Producto Marginal y Producto Medio", "Ley de Rendimientos Decrecientes", "Isocuantas: Propiedades", "Tasa Marginal de Sustitución Técnica (TMST)", "Costos Explícitos e Implícitos", "Costos a Corto Plazo (Fijo, Variable, Total, Medio, Marginal)", "Función de Producción a Largo Plazo", "Rendimientos a Escala (Crecientes, Decrecientes, Constantes)", "Isocostos", "Minimización de Costos a Largo Plazo", "Senda de Expansión", "Costos a Largo Plazo (Total, Medio, Marginal)", "Economías y Deseconomías de Escala", "Función de Producción Cobb-Douglas (Productor)", "Maximización de Beneficios", "Ingreso Marginal y Costo Marginal", "Excedente del Productor",
            // Microeconomía - Estructuras de Mercado
            "Competencia Perfecta: Supuestos", "Equilibrio a Corto Plazo en Competencia Perfecta", "Curva de Oferta a Corto Plazo de la Empresa Competitiva", "Equilibrio a Largo Plazo en Competencia Perfecta", "Eficiencia Asignativa y Productiva en Competencia Perfecta", "Monopolio: Causas y Características", "Maximización de Beneficios del Monopolista (IMg = CMg)", "Poder de Monopolio: Índice de Lerner", "Costos Sociales del Monopolio (Pérdida Irrecuperable de Eficiencia)", "Discriminación de Precios (Primer, Segundo, Tercer Grado)", "Regulación del Monopolio Natural", "Competencia Monopolística: Características", "Equilibrio a Corto y Largo Plazo en Competencia Monopolística", "Exceso de Capacidad en Competencia Monopolística", "Oligopolio: Características e Interdependencia", "Modelo de Cournot (Duopolio)", "Modelo de Bertrand (Duopolio)", "Modelo de Stackelberg (Líder-Seguidor)", "Teoría de Juegos: Conceptos Básicos (Jugadores, Estrategias, Pagos)", "Equilibrio de Nash", "Dilema del Prisionero", "Colusión y Cárteles", "Estrategias Mixtas",
            // Microeconomía - Fallos de Mercado
            "Externalidades: Tipos (Positivas y Negativas)", "Externalidades en la Producción y el Consumo", "Internalización de Externalidades (Impuestos Pigouvianos, Subsidios)", "Teorema de Coase", "Bienes Públicos: Características (No Rivalidad, No Exclusión)", "El Problema del Free-Rider (Polizón)", "Provisión Óptima de Bienes Públicos (Condición de Samuelson)", "Recursos Comunes: Tragedia de los Comunes", "Información Asimétrica: Selección Adversa", "Información Asimétrica: Riesgo Moral (Moral Hazard)", "El Mercado de 'Limones' (Akerlof)", "Señalización en Mercados con Información Asimétrica", "Screening (Selección)",
            // Macroeconomía - Medición
            "Producto Interno Bruto (PIB): Enfoques (Gasto, Ingreso, Producción)", "Componentes del PIB por Gasto (C, I, G, XN)", "PIB Nominal vs. PIB Real", "Deflactor del PIB", "Limitaciones del PIB como Medida de Bienestar", "Producto Nacional Bruto (PNB)", "Índice de Precios al Consumidor (IPC): Cálculo y Sesgos", "Tasa de Inflación", "Índice de Precios al Productor (IPP)", "Tasa de Desempleo: Definición y Cálculo", "Tasa de Participación Laboral", "Tipos de Desempleo (Friccional, Estructural, Cíclico)", "Tasa Natural de Desempleo (NAIRU)", "Ley de Okun",
            // Macroeconomía - Modelo AS-AD
            "Demanda Agregada (DA): Componentes y Pendiente", "Desplazamientos de la Curva de Demanda Agregada", "Oferta Agregada a Corto Plazo (OAC): Pendiente y Desplazamientos", "Oferta Agregada a Largo Plazo (OAL): Verticalidad", "Equilibrio Macroeconómico a Corto Plazo", "Equilibrio Macroeconómico a Largo Plazo", "Brechas Recesivas e Inflacionarias", "Mecanismo de Autoajuste de la Economía", "Shocks de Demanda y Oferta", "Estanflación",
            // Macroeconomía - Política Fiscal
            "Política Fiscal: Instrumentos (Gasto Público, Impuestos, Transferencias)", "Política Fiscal Expansiva y Contractiva", "Efecto Multiplicador del Gasto Público", "Efecto Multiplicador de los Impuestos", "Estabilizadores Automáticos", "Efecto Desplazamiento (Crowding Out)", "Equivalencia Ricardiana", "Déficit Presupuestario y Deuda Pública", "Sostenibilidad de la Deuda Pública", "Curva de Laffer",
            // Macroeconomía - Política Monetaria
            "Funciones del Dinero", "Agregados Monetarios (M1, M2, M3)", "El Banco Central: Funciones e Independencia", "Instrumentos de Política Monetaria (Operaciones de Mercado Abierto, Tasa de Descuento, Coeficiente de Caja)", "El Multiplicador Monetario", "Mercado Monetario: Demanda y Oferta de Dinero", "Teoría de la Preferencia por la Liquidez (Keynes)", "Trampa de la Liquidez", "Mecanismo de Transmisión de la Política Monetaria", "Reglas de Política Monetaria (Regla de Taylor)", "Objetivos de Inflación (Inflation Targeting)", "Curva de Phillips (Relación Inflación-Desempleo)", "Expectativas Racionales vs. Adaptativas",
            // Macroeconomía - Crecimiento y Ciclos
            "Ciclo Económico: Fases (Expansión, Pico, Contracción, Valle)", "Fuentes del Crecimiento Económico (Capital Físico, Capital Humano, Tecnología)", "Modelo de Crecimiento de Solow", "Estado Estacionario en el Modelo de Solow", "Convergencia Económica", "Teoría del Crecimiento Endógeno", "Importancia de las Instituciones para el Crecimiento",
            // Economía Internacional
            "Ventaja Comparativa (Modelo Ricardiano)", "Modelo Heckscher-Ohlin (Dotación de Factores)", "Teorema de Stolper-Samuelson", "Nuevas Teorías del Comercio (Economías de Escala, Diferenciación)", "Aranceles: Efectos Económicos", "Cuotas de Importación: Efectos Económicos", "Subsidios a la Exportación", "Argumentos a favor y en contra del Proteccionismo", "Balanza de Pagos: Cuenta Corriente, Cuenta de Capital y Financiera", "Tipos de Cambio Nominales y Reales", "Sistemas de Tipos de Cambio (Fijo, Flotante, Administrado)", "Paridad del Poder Adquisitivo (PPA)", "Paridad Descubierta de Tasas de Interés", "Modelo Mundell-Fleming (Economía Abierta Pequeña)", "Áreas Monetarias Óptimas", "Globalización: Aspectos Económicos",
            // Finanzas Básicas y Comportamiento
            "Valor Presente y Valor Futuro", "Tasa de Descuento", "Valor Actual Neto (VAN)", "Tasa Interna de Retorno (TIR)", "Riesgo y Rendimiento: Diversificación", "Modelo de Valoración de Activos de Capital (CAPM) - Introducción", "Beta como Medida de Riesgo Sistémico", "Hipótesis de los Mercados Eficientes (Formas Débil, Semifuerte, Fuerte)", "Finanzas Conductuales (Behavioral Finance): Introducción", "Sesgo de Anclaje", "Aversión a la Pérdida", "Exceso de Confianza", "Comportamiento de Rebaño", "Teoría del Prospecto (Prospect Theory)", "Empujones (Nudges)",
            // Otros Temas
            "Mercado Laboral: Oferta y Demanda de Trabajo", "Determinación de Salarios", "Capital Humano", "Sindicatos: Efectos Económicos", "Discriminación en el Mercado Laboral", "Principios de la Tributación (Equidad, Eficiencia)", "Incidencia Fiscal", "Tipos de Impuestos (Progresivo, Regresivo, Proporcional)", "Economía del Bienestar: Teoremas Fundamentales", "Función de Bienestar Social", "Econometría: Regresión Lineal Simple", "Correlación vs. Causalidad", "Historia del Pensamiento Económico: Mercantilismo", "Historia del Pensamiento Económico: Fisiocracia", "Adam Smith y la Mano Invisible", "David Ricardo y la Ventaja Comparativa", "Karl Marx y la Crítica al Capitalismo", "La Revolución Marginalista", "John Maynard Keynes y la Macroeconomía Moderna", "Milton Friedman y el Monetarismo", "La Escuela Austriaca (Hayek)",
            // Añadir más según sea necesario...
        ];
        const economicsThemes = [
            "teoría del consumidor", "teoría de la producción y costos", "estructuras de mercado", "fallos de mercado", "externalidades y bienes públicos",
            "medición macroeconómica (PIB, inflación, desempleo)", "modelo de oferta y demanda agregada", "política fiscal", "política monetaria y bancos centrales",
            "ciclos económicos", "crecimiento económico", "comercio internacional", "tipos de cambio y balanza de pagos",
            "finanzas corporativas básicas", "valoración de activos", "hipótesis de mercados eficientes", "economía del comportamiento",
            "mercado laboral", "economía pública e impuestos", "historia del pensamiento económico", "econometría básica", "economía del desarrollo"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un profesor universitario de economía explicando conceptos a estudiantes de nivel intermedio. Tu tarea es definir y desarrollar el concepto económico proporcionado de manera clara, estructurada y rigurosa. Incluye: 1) Definición precisa. 2) Supuestos clave del modelo/teoría (si aplica). 3) Componentes o mecanismos principales. 4) Representación gráfica conceptual (descrita textualmente, no dibujada). 5) Implicaciones o predicciones. 6) Ejemplos del mundo real o aplicaciones. 7) Limitaciones o críticas comunes. Utiliza un lenguaje académico pero accesible. El objetivo es una explicación completa de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente concepto económico:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Opcional: modelo más rápido para chat
             systemPrompt: "Actúa como un asistente de tutoría IA, especializado únicamente en el concepto económico que se está visualizando actualmente. Responde preguntas específicas sobre sus detalles, definiciones, relaciones con otros conceptos o ejemplos mencionados en la explicación principal. Sé preciso, conciso y mantente enfocado estrictamente en el concepto económico en cuestión.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de temas para un curso de economía intermedia. Genera exactamente 15 conceptos, modelos, teorías o preguntas relevantes de microeconomía, macroeconomía o economía internacional de nivel intermedio. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Área de texto e imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const chatContextTitle = document.getElementById('chat-context-title'); // Span for chat title
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentConceptTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentConceptTitle
                 ? `Eres un asistente de tutoría IA, especializado únicamente en el concepto económico llamado '${currentConceptTitle}'. Responde preguntas específicas sobre sus detalles, definiciones, relaciones con otros conceptos o ejemplos mencionados en la explicación principal. Sé preciso, conciso y mantente enfocado estrictamente en este concepto.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     // MENSAJE DE ERROR AMIGABLE
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, por favor intenta en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La solicitud tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentConceptTitle) throw new Error("Error interno: No se ha establecido el concepto económico para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(economicsThemes) || "conceptos económicos generales";
             const specificPrompt = `Genera 15 conceptos, modelos o teorías sobre ${randomTheme} de nivel intermedio`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de conceptos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "economic concept abstract visualization";
            // Prompt para imagen conceptual/abstracta de economía
            const enhancedPrompt = `Abstract conceptual visualization representing the economic concept '${safePromptText}'. Use metaphors like balance scales, graphs (stylized lines/curves, not data plots), interconnected nodes, gears, flow charts, simple human interaction silhouettes related to markets or exchange. Clean, modern, minimalist or slightly technical style. Avoid literal money stacks, complex confusing diagrams, text labels, specific company logos.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, realistic photo, complex chart, data plot, numbers, formulas, UI, menu, button, watermark, signature, multiple images, collage, dollar bills, coins pile, specific country flag";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (No changes needed)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula" style="text-align:center; font-style:italic; margin: 1em 0;">$1</p>'); // Style formulas
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' '); // Replace single newlines within a block with space
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentConceptTitle = null;
             chatContextTitle.textContent = 'este concepto'; // Reset chat context title
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (No changes needed)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (No changes needed)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentConceptTitle) return;

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Optional: Sort alphabetically or by topic? Alphabetical is simpler.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay conceptos disponibles «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentConceptTitle = title; // SET CHAT CONTEXT
            chatContextTitle.textContent = title; // Update chat title span
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-lightbulb placeholder-icon"></i> <!-- Icono idea/concepto -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); // Add click listener
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                // USE FRIENDLY ERROR MESSAGE
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la explicación.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                // Optionally hide chat section on major error
                // chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más temas...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más conceptos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 // USE FRIENDLY ERROR MESSAGE
                 alert(`Error al generar conceptos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Conceptos';
             }
         }

         // *** Search Filter Function (Added normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (Added chatContextTitle check)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !chatContextTitle) { // Added check
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: No se pudieron inicializar los componentes de la interfaz.</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>