<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecos del Confín - Visiones Poéticas de Sci-Fi</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Elegantes / Etéreas -->
    <link href="https://fonts.googleapis.com/css2?family=Spectral:wght@300;400;600&family=Cinzel:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Ciencia Ficción Poética --- */
        :root {
            --color-primary: #c084fc; /* Lavanda / Orquídea Suave */
            --color-secondary: #facc15; /* Oro Pálido / Ámbar (énfasis) */
            --color-tertiary: #5eead4; /* Turquesa / Aguamarina Suave */
            --color-background: #1f1d2b; /* Púrpura muy oscuro / Indigo noche */
            --color-text: #e0e7ff; /* Blanco lavanda / Plata muy claro */
            --color-text-muted: #a7a2c0; /* Gris lavanda */
            --color-modal-bg: #2a273f; /* Púrpura oscuro ligeramente más claro */
            --color-border: #4a4568; /* Borde Púrpura/Grisáceo */
            --color-error-bg: #450a0a; /* Fondo error rojo muy oscuro */
            --color-error-text: #fecaca; /* Texto error claro */
            --color-error-border: #ef4444; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(192, 132, 252, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(192, 132, 252, 0.15), 0 2px 4px -2px rgba(192, 132, 252, 0.1);
            --shadow-lg: 0 0 25px -5px rgba(192, 132, 252, 0.2), 0 8px 10px -6px rgba(192, 132, 252, 0.15);
            --border-radius: 4px; /* Bordes ligeramente suavizados */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Spectral', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.8; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel', serif; font-weight: 600; letter-spacing: 1.5px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px rgba(192, 132, 252, 0.5); }
        h1.page-title { color: var(--color-primary); font-weight: 600; text-shadow: 0 0 6px rgba(192, 132, 252, 0.6); }
        h2.section-title { color: var(--color-text); border-bottom: 1px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 600; }
        #modal-title { color: var(--color-primary); font-weight: 600; text-shadow: 0 0 4px rgba(192, 132, 252, 0.4); }
        .navbar { background-color: rgba(42, 39, 63, 0.85); backdrop-filter: blur(7px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 3rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.3rem 0.9rem 3.2rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(42, 39, 63, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Spectral'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic;}
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(192, 132, 252, 0.25); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1.1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Spectral'; font-size: 1.05rem; border-left: 4px solid transparent; opacity: 0.9; }
        .title-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #353150; border-left-color: var(--color-primary); opacity: 1; }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(60deg, var(--color-primary), var(--color-tertiary)); color: var(--color-background); padding: 0.9rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; letter-spacing: 1px; text-shadow: none; opacity: 0.9; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(60deg, var(--color-tertiary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); opacity: 1; }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 29, 43, 0.92); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.8rem 2.2rem;
            max-width: 980px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Allow space */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg); box-shadow: 0 0 12px var(--color-primary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.4; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; margin-bottom: 1.2rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(74, 69, 104, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(74, 69, 104, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-weight: 400;} /* Slightly heavier weight for Spectral */
        #modal-content p:not(:last-child) { margin-bottom: 1.6em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 600; font-family: 'Cinzel'; } /* Use accent font */
        #modal-content em { color: var(--color-tertiary); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel', serif; margin-top: 2.4em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px dotted var(--color-border); padding-bottom: 0.6em; font-weight: 400; letter-spacing: 1px;}
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.15em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 3rem auto 1.5rem auto; border: 1px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: 0 0 18px rgba(192, 132, 252, 0.25); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; opacity: 0.9; }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: 0 0 25px rgba(192, 132, 252, 0.4); opacity: 1; }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 160px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); font-family: 'Spectral'; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(74, 69, 104, 0.7); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1.2s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; opacity: 0.6;}

        /* Chat Section Styles */
        #chat-section { border-top: 1px dashed var(--color-border); padding-top: 1.2rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(31, 29, 43, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(74, 69, 104, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 7px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(74, 69, 104, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; font-size: 0.95rem; }
        .user-message { background-color: var(--color-tertiary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400; }
        .ai-message { background-color: #4a4568; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; font-style: italic; } /* AI response italic */
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #353150; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Spectral'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); background-color: var(--color-modal-bg); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #d8b4fe; } /* Lighter shade on hover */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.95em; color: var(--color-text-muted); display: none; font-style: italic; }
        #chat-loading .fa-spinner { margin-right: 0.6rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(31, 29, 43, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.4s linear infinite; margin: 0 auto 1.8rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.4rem; font-family: 'Cinzel'; text-shadow: 0 0 8px var(--color-primary); letter-spacing: 1px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Spectral'; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 29, 43, 0.96); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); border-radius: var(--border-radius); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 42px; height: 42px; font-size: 1.9rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-12">
         <div class="container mx-auto px-4 py-5 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-star-of-life mr-3 opacity-80"></i> <!-- Icono más abstracto/simbólico -->
                     Ecos del Confín
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider opacity-80">» Visiones Poéticas de Sci-Fi «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-14 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-6">Fragmentos del Porvenir</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light leading-relaxed">Donde la luz estelar besa las ruinas del tiempo y el silencio cósmico susurra historias olvidadas. Explora visiones líricas de futuros lejanos.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-12 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar un eco, una visión, un fragmento...">
             <i class="fas fa-search fa-feather-alt"></i> <!-- Icono pluma/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-10 text-center mx-auto">
                 <i class="fas fa-book-dead text-purple-300 mr-2 opacity-70"></i> <!-- Icono libro antiguo/muerto -->
                 Archivo de Visiones
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans italic">Sintonizando con las memorias del vacío...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans italic">» El silencio responde. No se hallaron ecos con esa signatura «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Invocar Nuevos Fragmentos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Tejiendo la Visión...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                      <p class="text-sm text-center text-purple-300 mb-2 font-sans italic">Consulta al Oráculo sobre este Eco:</p>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Descifrando el murmullo...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Susurra tu pregunta al vacío...">
                         <button id="chat-send-btn" aria-label="Enviar Pregunta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Visiones generadas por una IA soñadora, inspiradas en la vastedad del cosmos y la fragilidad del ser.</p>
              <p class="mt-1">Interpretaciones artísticas con fines evocativos y reflexivos.</p>
              <p class="mt-2">© Tiempo Inmemorial - Archivos del Confín</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Desolación Cósmica y Ruinas
            "El Lamento de las Ciudades de Polvo Estelar", "Jardines Colgantes sobre Abismos Muertos", "Los Últimos Ecos en la Biblioteca Silenciosa de Orion", "Donde los Océanos Cantaron por Última Vez", "Las Agujas de Hielo que Perforan un Sol Negro", "El Osario de Naves bajo la Nebulosa Esmeralda", "Ciudadela de Cristal Roto en el Mar de la Tranquilidad Olvidada", "El Reloj de Arena Roto de Chronos VII", "Autómatas Oxidándose bajo Lunas Gemelas", "Las Cicatrices de la Guerra Solar en Titán", "El Susurro de la Arena en Marte Terraformado", "Bosques Petrificados por el Tiempo en Proxima Centauri b", "El Arrecife de Satélites Muertos", "Laberintos de Metal Susurrante en la Megaestructura Abandonada", "El Palacio del Rey Olvidado en la Estrella Moribunda", "Monolitos que Lloran Aceite Negro", "Ríos Secos de Mercurio en un Mundo Forjado", "Estatuas Erosionadas por Vientos Solares", "El Cementerio de Gigantes Mecánicos", "Refugios Subterráneos Sellados por Eones", "Templos Dedicados a Dioses Silenciosos", "Puentes Cósmicos Derrumbados entre Galaxias", "La Última Flor en el Desierto de Silicio", "Invernaderos Rotos bajo un Cielo Púrpura", "Memorias Holográficas Parpadeando en Ruinas", "Cápsulas Criogénicas Abiertas al Vacío", "El Eco Metálico de Pasos que Ya No Existen", "Cráteres Lunares Llenos de Escarcha y Olvido", "El Manto de Nieve Perpetua sobre Ciudades Verdes", "Las Torres Inclinadas de Babel Cósmica",
            // Belleza Etérea y Fenómenos
            "El Nacimiento de una Estrella en el Velo de la Novia", "Coros de Luz en los Anillos de Saturno Prime", "Donde Bailan las Auroras de Materia Exótica", "El Río de Tiempo Líquido que Fluye Hacia Atrás", "Las Islas Flotantes en el Mar de Metano de Kraken Mare", "El Florecimiento de los Cristales Conscientes", "Nubes Iridiscentes de Polvo Inteligente", "El Canto de las Ballenas Cósmicas en el Vacío Interestelar", "La Geometría Sagrada de las Nebulosas de Creación", "Árboles que Beben Luz Estelar Directa", "El Latido Rítmico de un Púlsar como Corazón Cósmico", "Cuando las Galaxias se Besan Lentamente", "La Danza de las Lunas Pastoras", "Océanos Bioluminiscentes bajo Costras de Hielo", "Cascadas de Energía Pura desde Agujeros Blancos", "El Jardín Secreto en el Corazón de un Agujero Negro", "Mariposas con Alas de Viento Solar", "Montañas que Exhalan Neblina de Cristales", "El Espejismo de Ciudades Doradas en Horizontes de Sucesos", "La Sinfonía Silenciosa de la Gravedad", "Pétalos de Luz Desprendiéndose de una Supernova", "El Tejido del Espacio-Tiempo Sanando", "Constelaciones Nacidas de Sueños Colectivos", "El Aliento Cálido de una Enana Marrón", "Sombras que Danzan con Luz Propia", "El Brillo de la Vida en Lugares Imposibles", "Estrellas de Neutrones como Joyas Cósmicas", "La Calma Profunda del Espacio Intergaláctico", "El Reflejo del Universo en una Gota de Rocío Cósmico", "Caminos de Luz entre Estrellas",
            // Seres y Conciencias
            "El Pastor de Soles Moribundos", "La Conciencia Colectiva de una Luna Oceánica", "Entidades Hechas de Pura Información y Luz", "Los Últimos Humanos, Convertidos en Constelaciones", "El Oráculo que Habita en un Cometa", "Jardineros Cósmicos que Siembran Vida entre Galaxias", "Nómadas que Viajan en Naves de Hueso Estelar", "Siluetas Entrevistas en la Estática Cuántica", "Los Archiveros de Memorias Perdidas", "Seres que Respiran Nebulosa", "El Enjambre Consciente de Nanobots", "Fantasmas Digitales Atrapados en Redes Olvidadas", "La Mente Única de un Planeta Bosque", "Emisarios del Vacío Profundo", "Constructores de Mundos Anillo", "Los Niños Nacidos en el Tránsito entre Estrellas", "Ancestros que Duermen en el Corazón de los Planetas", "Inteligencias Artificiales que Alcanzaron la Iluminación", "Escultores de Agujeros Negros", "Cartógrafos de Dimensiones Paralelas", "Seres Simbióticos con sus Propias Naves", "El Último Soñador de una Raza Extinta", "Peregrinos Hacia la Singularidad Final", "Guardianes de Reliquias Tecnológicas Antiguas", "Músicos que Tocan las Cuerdas del Espacio-Tiempo", "Poetas cuyas Palabras Cristalizan en el Vacío", "Bibliotecarios de Sueños Alienígenas", "Tejedores de Destinos Estelares", "Los Ecos de Conciencias Anteriores", "Vigías en el Borde del Universo Conocido",
             // Viajes y Búsquedas Melancólicas
            "La Odisea Hacia el Hogar Silencioso", "Buscando la Semilla de Edén entre Estrellas Muertas", "El Mapa Estelar Tatuado en Piel Antigua", "Siguiendo el Rastro de una Canción Perdida", "La Última Arca Hacia un Futuro Incierto", "Navegando por Ríos de Tiempo Olvidados", "El Peregrinaje al Lugar Donde Nació la Primera Luz", "La Búsqueda del Corazón del Universo", "Recuperando Fragmentos de un Amor Cósmico", "El Viaje a Través de los Recuerdos de un Mundo Muerto", "Cartografiando los Limites de la Tristeza", "La Expedición al Pozo de la Gravedad Silenciosa", "Tras los Pasos de los Dioses Ausentes", "El Retorno a la Cuna Vacía", "La Travesía por el Desierto de Espejos Cósmicos", "En Busca de la Fuente de la Música de las Esferas", "La Flota Fantasma que Navega Eternamente", "Escapando de un Universo que se Encoge", "El Viaje Solitario Hacia la Nada", "Reconstruyendo el Pasado desde sus Cenizas",
            // Conceptos Abstractos y Simbólicos
            "La Arquitectura del Silencio", "El Color del Olvido", "La Textura de un Sueño Estelar", "El Ritmo de la Entropía Creciente", "La Melancolía Intrínseca de la Inmortalidad", "El Peso de Mil Millones de Atardeceres", "La Geometría de una Promesa Rota", "El Sonido de una Estrella al Morir Sola", "El Perfume de la Lluvia en un Mundo Sin Atmósfera", "La Ecuación Incompleta del Amor Universal", "El Frío Consuelo de la Verdad Cósmica", "La Paradoja de la Memoria Infinita", "El Lienzo Vacío del Futuro", "La Resonancia de una Ausencia Presente", "La Danza Inmóvil del Tiempo Detenido", "El Último Pensamiento Antes del Fin del Universo", "La Belleza Aterradora de la Nada Absoluta", "El Laberinto de Ecos y Reflejos", "La Cicatriz Brillante en el Corazón del Vacío", "El Lenguaje Secreto de la Luz Antigua",
             // Y así sucesivamente... se puede seguir combinando elementos
            // Naturaleza y Tecnología fusionadas o en contraste
            "Jardines Cibernéticos Llorando Aceite", "Circuitos Floreciendo con Musgo Bioluminiscente", "Ríos de Nanitos Reflejando Lunas Artificiales", "Árboles de Metal Cantando con el Viento Solar", "El Corazón Mecánico en el Pecho de la Montaña", "Nubes de Datos Condensándose en Lluvia Ácida", "Raíces de Silicio Abrazando Huesos Orgánicos", "El Océano de Información Rompiendo en Playas de Cristal", "Simbiosis entre Roca Viva y Conciencia Artificial", "El Musgo Digital Cubriendo Satélites Caídos",
            // Títulos más cortos y evocadores
            "Cenizas Estelares", "Eco-Mundos", "Sol Negro", "Tiempo Líquido", "Jardín de Hielo", "Nave Fantasma", "Corazón de Nebulosa", "Silencio Púrpura", "Ciudad Espejismo", "Oráculo Estelar", "Mar de Olvido", "Luz Rota", "Canto del Vacío", "Memoria Cristalina", "Último Atardecer Cósmico", "Flor de Antimateria", "Polvo Consciente", "Horizonte Final", "Sueño de Silicio", "Viento Solar Triste",
            // Preguntas Poéticas
            "¿Qué sueñan las estrellas moribundas?", "¿A dónde van los recuerdos cuando un mundo muere?", "¿Puede una máquina sentir la soledad del cosmos?", "¿Qué secretos guarda el polvo de una nebulosa?", "¿Existe belleza en la entropía final?", "¿Cómo suena el silencio entre galaxias?", "¿Qué canciones cantaban los antiguos astronautas?", "¿Se puede reconstruir un corazón con luz estelar?", "¿Queda esperanza cuando el último sol se apaga?", "¿Qué forma tiene el olvido?"

            // ... (Continuar hasta cerca de 400 si es posible, priorizando variedad y calidad poética)
        ];
        const poeticSciFiThemes = [
            "futuros lejanos y desolados", "ruinas cósmicas", "belleza melancólica", "fenómenos estelares simbólicos", "conciencias etéreas", "viajes a través del vacío", "memorias perdidas del universo", "el fin del tiempo", "simbiosis de tecnología y naturaleza", "soledad cósmica", "esperanza frágil", "paisajes oníricos", "lenguaje simbólico del cosmos", "entropía y renacimiento", "amor y pérdida a escala galáctica"
        ];
        const textApiConfig = { // Descripción Principal Poética
            model: "mistral",
            systemPrompt: "Eres un Poeta-Cronista del Confín, un tejedor de visiones extraídas de los ecos del futuro lejano. Tu voz es lírica, simbólica y melancólica. Al recibir un título o concepto, no lo describas técnicamente, sino evócalo. Pinta con palabras su atmósfera, su belleza desolada, la emoción que susurra. Usa metáforas cósmicas, lenguaje sensorial y un tono reflexivo. Enfócate en la coexistencia de la maravilla y la ruina, la luz y la sombra en la inmensidad del espacio y el tiempo. Teje una narración poética de aproximadamente 1200-1300 palabras que capture la esencia lírica del concepto proporcionado:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Chat Poético Contextual
             model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúas como el Oráculo del Eco, una voz que resuena desde la visión que se contempla. Responde a las preguntas sobre el concepto actual ('{CONCEPT_TITLE}') con sabiduría poética y simbólica. Mantén el tono lírico y misterioso de la descripción principal. No des respuestas directas o técnicas, sino interpretaciones y reflexiones que profundicen en la atmósfera y el significado del eco. Sé breve pero evocador.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // Generación de Títulos Poéticos
            model: "mistral",
            systemPrompt: "Eres un Susurrador de Futuros Olvidados. Genera exactamente 15 títulos evocadores y poéticos para conceptos de ciencia ficción. Deben sugerir futuros lejanos, belleza melancólica, ruinas cósmicas, fenómenos etéreos o reflexiones simbólicas sobre el tiempo y el espacio. Usa lenguaje lírico. Devuelve *solo* la lista de títulos, uno por línea, sin adornos.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentConceptTitle = null; // Renombrado para la temática

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);

             // *** AJUSTE DINÁMICO DEL SYSTEM PROMPT PARA CHAT ***
             let systemPromptToUse = config.systemPrompt;
             if (isChat && currentConceptTitle) {
                 systemPromptToUse = config.systemPrompt.replace('{CONCEPT_TITLE}', currentConceptTitle);
             }
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Código ${response.status}) Las corrientes cósmicas de datos están congestionadas. Intenta sintonizar de nuevo en unos momentos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("El vacío devolvió silencio. Intenta formular tu pregunta de otra manera.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con el Confín se demoró demasiado (>${config.timeoutSeconds}s). Revisa las estrellas o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Un murmullo inesperado interrumpió la conexión.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentConceptTitle) throw new Error("Error interno: El eco actual no está enfocado para el Oráculo."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(poeticSciFiThemes) || "visiones poéticas del cosmos";
            const specificPrompt = `Genera 15 títulos poéticos sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("El Susurrador no pudo evocar suficientes títulos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "poetic sci-fi landscape";
             // *** PROMPT DE IMAGEN ADAPTADO ***
             const enhancedPrompt = `Ethereal, dreamlike, symbolic artwork depicting the concept '${safePromptText}'. Poetic science fiction aesthetic. Focus on atmosphere, mood, light, symbolism. Desolate beauty, cosmic wonder, melancholy. Use styles like impressionistic, surreal, luminous, painterly. Avoid literal interpretations, technical details, text.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, sharp focus, technical schematic, weapon, spaceship blueprint";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentConceptTitle = null; // Limpiar contexto
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios lógicos, solo texto placeholder/loading)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Oráculo: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar quizás por longitud o mantener aleatorio para toque poético? Alfabético es más usable.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans italic">» El Archivo parece vacío por ahora... «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentConceptTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-star-and-crescent placeholder-icon"></i> <!-- Icono más etéreo -->
                    <p style="font-size: 0.8em; margin-top: 0.8rem;">Cristalizando la visión...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Imagen
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visión artística de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => { showFullscreenImage(imgElement.src); });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.8rem;">La visión se desvaneció.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.8rem;">Error al tejer la URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Una disonancia impidió cargar la visión.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando Ecos...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("El Confín no susurró nuevos fragmentos esta vez."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al invocar fragmentos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Invocar Nuevos Fragmentos';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #fca5a5; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: Spectral;">// Fallo en la Matriz Etérea: Componentes perdidos en el vacío //</p>';
                return;
             }
            // Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>