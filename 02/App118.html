<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Las Leyes del Poder - Análisis Estratégico</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Elegantes/Serif -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Leyes del Poder --- */
        :root {
            --color-primary: #800020; /* Borgoña / Vino Tinto */
            --color-secondary: #B8860B; /* Dorado Oscuro / Oro Viejo */
            --color-tertiary: #006400; /* Verde Oscuro Bosque */
            --color-background: #1a1a1a; /* Gris Muy Oscuro / Casi Negro */
            --color-text: #e8e6e3; /* Blanco Hueso / Pergamino Claro */
            --color-text-muted: #a0a0a0; /* Gris Medio */
            --color-modal-bg: #2b2b2b; /* Gris Oscuro Carbón */
            --color-border: #444444; /* Borde Gris Medio-Oscuro */
            --color-error-bg: #4d0f0f; /* Fondo error rojo muy oscuro */
            --color-error-text: #f5c6cb; /* Texto error rosa pálido */
            --color-error-border: #8B0000; /* Borde error rojo oscuro */

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 5px 10px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(184, 134, 11, 0.2); /* Sombra negra + leve brillo dorado */
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-secondary); text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }
        h1.page-title { color: var(--color-text); font-weight: 700; }
        h2.section-title { color: var(--color-secondary); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .navbar { background-color: rgba(26, 26, 26, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(43, 43, 43, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-secondary); box-shadow: 0 0 0 3px rgba(184, 134, 11, 0.2); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-secondary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 75px; font-family: 'Lato'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item i { margin-right: 0.8rem; color: var(--color-secondary); opacity: 0.6; transition: opacity 0.2s ease; min-width: 16px; text-align: center;} /* Icono sutil */
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-secondary); background-color: #333; border-left-color: var(--color-secondary); }
        .title-item:hover i { opacity: 1; }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), #a0522d); /* Borgoña a Siena */ color: var(--color-text); padding: 0.9rem 1.8rem; border: 1px solid var(--color-secondary); border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, #a0522d, var(--color-primary)); border-color: lighten(var(--color-secondary), 10%); box-shadow: var(--shadow-lg); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; border-color: var(--color-border); }
        #generate-more-btn .fa-sync-alt { color: var(--color-text); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.92); /* Overlay oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-top: 3px solid var(--color-primary); /* Borde superior distintivo */
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 980px; /* Ligeramente más ancho */
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Más altura */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-text); transform: rotate(90deg); box-shadow: 0 0 8px var(--color-primary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; /* Espacio para scrollbar */ margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(68, 68, 68, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(68, 68, 68, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-size: 1.05rem; /* Ligeramente más grande */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 700; }
        #modal-content em { color: var(--color-text); font-style: italic; font-weight: 300; } /* Cursiva sutil */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 700; letter-spacing: 0.3px;}
        #modal-content h1 { font-size: 1.6em; color: var(--color-secondary); }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 3rem auto 1.5rem auto; border: 2px solid var(--color-secondary); border-radius: var(--border-radius); box-shadow: 0 0 20px rgba(184, 134, 11, 0.3); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; opacity: 0.9; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 30px rgba(184, 134, 11, 0.5); opacity: 1; }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(68, 68, 68, 0.7); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1.2s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* Un poco más de altura */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(26, 26, 26, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(68, 68, 68, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(68, 68, 68, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.55; font-size: 0.95rem; }
        .user-message { background-color: var(--color-tertiary); color: var(--color-text); margin-left: auto; text-align: left; font-weight: 400; border-left: 3px solid var(--color-secondary); }
        .ai-message { background-color: #3a3a3a; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; border-left: 3px solid var(--color-primary); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #333; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); background-color: #3a3a3a; }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-secondary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #daa520; /* Dorado más brillante */ }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Lato'; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 26, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 6px solid var(--color-border); border-top-color: var(--color-secondary); border-radius: 50%; animation: spin 1.3s linear infinite; margin: 0 auto 1.8rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.4rem; font-family: 'Merriweather'; text-shadow: 1px 1px 3px rgba(0,0,0,0.6); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-secondary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); opacity: 0.8; }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-background); transform: scale(1.1); opacity: 1; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-chess-king mr-3"></i> <!-- Icono Rey Ajedrez -->
                     Leyes del Poder
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Análisis Estratégico «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">El Arte de la Influencia y la Estrategia</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Explora los principios atemporales que rigen la dinámica del poder. Selecciona una ley o concepto para un análisis detallado.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar ley, concepto o estrategia...">
             <i class="fas fa-scroll fa-search"></i> <!-- Icono Pergamino/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-balance-scale-left text-red-800 mr-2"></i> <!-- Icono Balanza -->
                 Compendio de Estrategias
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Accediendo a los archivos históricos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» Ninguna estrategia coincide con la búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Estrategias
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Analizando Archivos...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando al estratega...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta ley o estrategia...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta">
                             <i class="fas fa-feather-alt"></i> <!-- Icono Pluma -->
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Representación Simbólica Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Análisis estratégico generado por IA con fines educativos y de reflexión sobre la naturaleza del poder.</p>
              <p class="mt-1">El contenido se basa en interpretaciones históricas y filosóficas; aplique el discernimiento.</p>
              <p class="mt-2">© 2025 Archivos Estratégicos</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Basadas en las 48 Leyes (ejemplos, no todas textualmente)
            "Ley 1: Nunca le haga sombra a su amo", "Ley 2: Nunca confíe demasiado en sus amigos", "Ley 3: Disimule sus intenciones", "Ley 4: Diga siempre menos de lo necesario", "Ley 5: Defienda su reputación a muerte", "Ley 6: Llame la atención a cualquier precio", "Ley 7: Logre que otros trabajen por usted", "Ley 8: Haga que la gente acuda a usted", "Ley 9: Gane a través de sus acciones", "Ley 10: Peligro de contagio: Evite a los perdedores", "Ley 11: Haga que la gente dependa de usted", "Ley 12: Use la franqueza selectiva", "Ley 13: Apelar al interés propio de los demás", "Ley 14: Muéstrese como amigo, actúe como espía", "Ley 15: Aniquile por completo a su enemigo", "Ley 16: Use la ausencia para incrementar respeto", "Ley 17: Mantenga el suspenso", "Ley 18: No construya fortalezas para protegerse", "Ley 19: Sepa con quién está tratando", "Ley 20: No se comprometa con nadie", "Ley 21: Finja candidez para atrapar a los cándidos", "Ley 22: Utilice la táctica de la capitulación", "Ley 23: Concentre sus fuerzas", "Ley 24: Desempeñe el papel de cortesano perfecto", "Ley 25: Reinventese a sí mismo", "Ley 26: Mantenga sus manos limpias", "Ley 27: Juegue con la necesidad de la gente", "Ley 28: Sea audaz al entrar en acción", "Ley 29: Planifique sus acciones hasta el final", "Ley 30: Haga que sus logros parezcan fáciles", "Ley 31: Controle las opciones", "Ley 32: Juegue con las fantasías de la gente", "Ley 33: Descubra el talón de Aquiles", "Ley 34: Actúe como un rey para ser tratado como tal", "Ley 35: Domine el arte de la oportunidad", "Ley 36: Menosprecie las cosas que no puede obtener", "Ley 37: Arme espectáculos imponentes", "Ley 38: Piense como quiera, pero compórtese como los demás", "Ley 39: Revuelva las aguas para asegurarse una buena pesca", "Ley 40: Menosprecie lo que es gratuito", "Ley 41: Evite imitar a los grandes hombres", "Ley 42: Muerto el perro, se acabó la rabia", "Ley 43: Trabaje sobre el corazón y la mente de los demás", "Ley 44: Desarme y enfurezca con el efecto espejo", "Ley 45: Predique la necesidad de introducir cambios", "Ley 46: Nunca se muestre demasiado perfecto", "Ley 47: No vaya más allá de su objetivo original", "Ley 48: Sea cambiante en su forma",
            // Conceptos Generales de Poder y Estrategia
            "La naturaleza del poder", "Poder duro vs. Poder blando (Soft Power)", "El poder de la información", "La importancia del carisma", "Construcción y mantenimiento de alianzas", "El arte de la negociación", "Estrategia y táctica: diferencias clave", "El principio de economía de fuerzas", "La sorpresa como elemento estratégico", "Inteligencia y contra-inteligencia", "Manejo de la propaganda y la percepción", "Guerra psicológica", "Teoría de juegos aplicada al poder", "El dilema del prisionero en la política", "El rol de la suerte y la fortuna (Maquiavelo)", "Virtú vs. Fortuna (Maquiavelo)", "El concepto de 'Realpolitik'", "Poder legítimo vs. Poder coercitivo", "Fuentes de autoridad", "El liderazgo transformacional", "El liderazgo transaccional", "La microfísica del poder (Foucault)", "Poder y conocimiento (Foucault)", "La banalidad del mal (Arendt)", "Estrategias de Sun Tzu: El Arte de la Guerra", "Conócete a ti mismo y a tu enemigo (Sun Tzu)", "El engaño como herramienta (Sun Tzu)", "La velocidad y la adaptabilidad (Sun Tzu)", "Lecciones de 'El Príncipe' de Maquiavelo", "La crueldad bien utilizada (Maquiavelo)", "Ser temido vs. Ser amado (Maquiavelo)", "Estrategias de Clausewitz: 'De la Guerra'", "La guerra como continuación de la política (Clausewitz)", "La fricción en la guerra (Clausewitz)", "El centro de gravedad estratégico (Clausewitz)", "Poder en las relaciones interpersonales", "Dinámicas de poder en el lugar de trabajo", "Estrategias de ascenso corporativo", "El poder en la familia", "Manipulación emocional", "Técnicas de persuasión", "El lenguaje corporal del poder", "La asertividad como herramienta", "Gestión de conflictos de poder", "Identificación de juegos de poder", "Cómo decir 'no' con poder", "Establecer límites personales",
            // Figuras Históricas y Poder
            "Estrategias de Julio César", "El ascenso de Augusto", "El poder según los emperadores romanos", "Maquiavelo y los Médici", "Richelieu y la Razón de Estado", "Luis XIV: El Estado soy yo", "Estrategias de Napoleón Bonaparte", "Bismarck y la unificación alemana", "Lenin y la toma del poder", "Stalin: El culto a la personalidad", "Estrategias de Churchill", "Gandhi y el poder de la no violencia", "Mao Zedong y la Larga Marcha", "El poder según los dictadores del siglo XX", "Líderes carismáticos y su influencia", "Reinas y mujeres de poder en la historia", "El poder de los consejeros (Rasputín, etc.)", "Movimientos de resistencia y poder popular",
            // Contra-estrategias y Ética
            "Cómo detectar la manipulación", "Defensa contra la adulación", "Neutralizar a un rival envidioso", "Mantener la autonomía personal", "La ética del poder: ¿El fin justifica los medios?", "El poder y la corrupción", "Límites morales de la estrategia", "La responsabilidad del poderoso", "Poder para el bien común vs. Poder egoísta", "Transparencia vs. Secreto en el poder", "El estoicismo frente al poder", "La humildad como fortaleza", "El poder de la vulnerabilidad (Brené Brown)", "Construir confianza genuina", "El liderazgo ético", "Consecuencias a largo plazo del poder abusivo",
            // Conceptos más específicos o modernos
            "El poder de las redes sociales", "Influencers y poder digital", "Guerra de información en la era digital", "Ciberseguridad y poder estatal", "El poder económico de las corporaciones", "Lobbying e influencia política", "Poder simbólico (Bourdieu)", "Capital social y poder", "Poder cultural y hegemonía (Gramsci)", "Neurociencia y persuasión", "Psicología de la obediencia (Milgram)", "El experimento de la cárcel de Stanford", "Sesgos cognitivos y toma de decisiones", "El poder de la narrativa", "Storytelling para líderes", "Inteligencia emocional y liderazgo", "Gestión de la reputación online", "Cancel culture y poder social", "Geopolítica y equilibrio de poder", "Teoría de la dependencia en relaciones internacionales", "El poder estructural en la sociedad", "Dinámicas de poder y género", "Poder y clase social", "Interseccionalidad y poder",
             // ... (Continuar expandiendo hasta cerca de 400)
             "El arte de retirarse a tiempo", "Saber cuándo luchar y cuándo no", "El poder del silencio", "Crear un culto de seguidores", "La audacia calculada", "El miedo como herramienta de control", "La esperanza como motor de acción", "Generar misterio alrededor de uno mismo", "Adaptarse a las circunstancias cambiantes", "El dominio del tiempo y el ritmo", "No mostrar todas las cartas", "Usar chivos expiatorios", "La importancia de la paciencia estratégica", "Convertir debilidades en fortalezas", "Atacar los puntos débiles del oponente", "El poder de la delegación efectiva", "Mantener la calma bajo presión", "Aprender de los errores (propios y ajenos)", "El valor de la preparación meticulosa", "No subestimar a ningún adversario", "Crear facciones y dividir para reinar", "La seducción como forma de poder", "El poder de la simplicidad en la comunicación", "Anticipar los movimientos del contrario", "Forzar la mano del oponente", "El poder de la tradición y el ritual", "Romper las reglas (con inteligencia)", "Saber perdonar (estratégicamente)", "Construir un legado duradero", "El poder de la visión a largo plazo"
             // Añadir más leyes, conceptos, tácticas, ejemplos históricos, etc.
        ];
        const powerThemes = [
            "estrategias de influencia", "poder político", "manipulación psicológica", "liderazgo maquiavélico", "historia del poder", "tácticas de negociación", "construcción de reputación", "guerra psicológica", "poder corporativo", "dinámicas interpersonales de poder", "Sun Tzu", "Maquiavelo", "Clausewitz", "ética y poder", "poder blando (soft power)", "carisma y liderazgo", "alianzas estratégicas", "manejo de crisis", "poder en la era digital", "contra-estrategias de poder"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un historiador, filósofo político y estratega experto en las dinámicas del poder a lo largo de la historia y en diversos contextos. Analiza la ley, concepto o estrategia de poder indicada de forma profunda, objetiva y crítica. Explica su significado fundamental, cita ejemplos históricos o contemporáneos relevantes (si aplica), discute sus mecanismos de acción, ventajas, desventajas, riesgos potenciales y consideraciones éticas. Utiliza un lenguaje erudito pero claro, propio de un análisis académico o un tratado estratégico. El objetivo es una disertación detallada de aproximadamente 1200-1300 palabras. Basa tu análisis únicamente en la siguiente ley o concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúa como un consejero estratégico especializado únicamente en la ley o concepto de poder que se está discutiendo. Responde preguntas específicas sobre su aplicación, matices, ejemplos adicionales o contra-argumentos relacionados con el tema actual. Sé preciso, analítico y conciso.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un compendio sobre las leyes del poder. Genera exactamente 15 títulos de leyes, conceptos, tácticas estratégicas o temas relacionados con la adquisición, mantenimiento y ejercicio del poder. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Área de texto+imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentPowerLawTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentPowerLawTitle
                 ? `Eres un consejero estratégico especializado únicamente en la ley o concepto de poder llamado '${currentPowerLawTitle}'. Responde preguntas específicas sobre su aplicación, matices, ejemplos adicionales o contra-argumentos relacionados con el tema actual. Sé preciso, analítico y conciso.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     // MENSAJE DE ERROR AMIGABLE
                     throw new Error(`(Error ${response.status}) Nuestros servidores están experimentando mucho tráfico en este momento. Por favor, intente de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intente reformular la pregunta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Compruebe su conexión o inténtelo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentPowerLawTitle) throw new Error("Error interno: No se ha establecido el contexto de la ley para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(powerThemes) || "estrategias de poder generales";
            const specificPrompt = `Genera 15 títulos (leyes, conceptos, tácticas) sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas estratégicas.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "power dynamics symbolism";
             // Prompt mejorado para arte simbólico/alegórico
             const enhancedPrompt = `Symbolic artwork representing the concept or law of power: '${safePromptText}'. Allegorical style, perhaps classical, renaissance, or surreal. Focus on symbolism (scales, crowns, chess pieces, shadows, masks, keys, chains, light/dark contrast, animals like lion/snake/fox). Avoid literal depictions, text, labels, diagrams. Evocative atmosphere.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, modern setting unless specified, simple icon";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (sin cambios funcionales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentPowerLawTitle = null; // Limpia contexto
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios funcionales)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios funcionales)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error Consejero: ${error.message}`); // Mensaje temático
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        // Add icon to title item creation
        function createTitleItem(title) {
             const div = document.createElement('div');
             div.className = 'title-item';
             // Intenta encontrar un icono relevante (simple)
             let iconClass = 'fa-scroll'; // Default
             if (title.toLowerCase().includes('amo') || title.toLowerCase().includes('rey') || title.toLowerCase().includes('lider')) iconClass = 'fa-chess-king';
             else if (title.toLowerCase().includes('amigo') || title.toLowerCase().includes('alianza')) iconClass = 'fa-users';
             else if (title.toLowerCase().includes('reputación') || title.toLowerCase().includes('atención')) iconClass = 'fa-eye';
             else if (title.toLowerCase().includes('guerra') || title.toLowerCase().includes('enemigo') || title.toLowerCase().includes('fuerza')) iconClass = 'fa-shield-halved';
             else if (title.toLowerCase().includes('tiempo') || title.toLowerCase().includes('oportunidad')) iconClass = 'fa-clock';
             else if (title.toLowerCase().includes('ley') || title.toLowerCase().includes('regla')) iconClass = 'fa-gavel';
             else if (title.toLowerCase().includes('corazón') || title.toLowerCase().includes('mente') || title.toLowerCase().includes('fantasía')) iconClass = 'fa-brain';
             else if (title.toLowerCase().includes('dinero') || title.toLowerCase().includes('gratuito')) iconClass = 'fa-coins';
             else if (title.toLowerCase().includes('espectáculo') || title.toLowerCase().includes('apariencia')) iconClass = 'fa-mask';
             div.innerHTML = `<i class="fas ${iconClass} fa-fw"></i> ${title}`; // Usa innerHTML
             div.setAttribute('data-title', title); // Guardar el título limpio
             div.addEventListener('click', () => handleTitleClick(title));
             return div;
         }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Podríamos ordenar por número de Ley si el formato es consistente, o alfabético
             const sortedTitles = titles.sort((a, b) => {
                const numA = parseInt(a.match(/^Ley (\d+)/)?.[1]);
                const numB = parseInt(b.match(/^Ley (\d+)/)?.[1]);
                if (numA && numB) return numA - numB;
                if (numA) return -1; // Leyes primero
                if (numB) return 1;
                return a.localeCompare(b); // Alfabético para el resto
             });
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» No hay estrategias disponibles en los archivos «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Reaplicar filtro
             // Podríamos reordenar todo, pero sería más costoso
         }

        // MODIFIED: handleTitleClick (contexto, imagen click)
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentPowerLawTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset scroll
                console.log("Scroll set to 0 after content visible");

                // Placeholder Imagen
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-palette placeholder-icon"></i> <!-- Icono paleta/arte -->
                    <p style="font-size: 0.8em; margin-top: 0.8rem;">Generando representación simbólica...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Imagen
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación simbólica de: ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    // *** ADD CLICK LISTENER FOR FULLSCREEN ***
                    imgElement.addEventListener('click', () => { showFullscreenImage(imgElement.src); });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.8rem;">No se pudo generar la imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.8rem;">Error al crear URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el análisis."; // Mensaje temático
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // MODIFIED: handleGenerateMoreTitles (mensajes error)
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando en archivos...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se encontraron nuevas estrategias en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar estrategias: ${error.message}`); // Usa mensaje amigable
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Estrategias';
             }
         }

        // Search Filter Function (con normalización)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (sin cambios funcionales mayores)
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #800020; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: Merriweather;">Error Catastrófico: Fallo al cargar la interfaz estratégica.</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>