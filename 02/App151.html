<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conceptos Filosóficos - Explorador Interactivo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Clásicas/Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Conceptos Filosóficos --- */
        :root {
            --color-primary: #4a5568; /* Gris Azulado Oscuro (Intelectual) */
            --color-secondary: #a0aec0; /* Gris Claro (Neutro) */
            --color-tertiary: #b794f4; /* Púrpura Suave (Pensamiento, Creatividad) */
            --color-accent: #ecc94b; /* Ocre/Dorado Apagado (Sabiduría, Valor) */
            --color-background: #f7fafc; /* Blanco Hueso / Gris muy claro */
            --color-text: #2d3748; /* Gris Muy Oscuro (Legibilidad) */
            --color-text-muted: #718096; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro Modal */
            --color-border: #e2e8f0; /* Borde Gris Claro */
            --color-error-bg: #fff5f5; /* Fondo error rojo muy claro */
            --color-error-text: #c53030; /* Texto error rojo oscuro */
            --color-error-border: #fc8181; /* Borde error rojo claro */

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.07), 0 1px 2px 0 rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            --border-radius: 5px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-accent); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: white; box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: white; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(236, 201, 75, 0.3); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-accent); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: white; padding: 1.1rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f8fafc; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #2d3748; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: var(--color-secondary); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(45, 55, 72, 0.85); /* Overlay gris */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px; /* Consistent width */
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.1em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 700; }
        #modal-content h1 { font-size: 1.45em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: #4a5568; } /* Slightly darker than primary */
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid var(--color-border); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-accent); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fdfdfe; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95em; }
        .user-message { background-color: var(--color-accent); color: var(--color-text); margin-left: auto; text-align: left; font-weight: 400;} /* Cambiado a left para lectura normal */
        .ai-message { background-color: var(--color-secondary); color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-accent); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #2d3748; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid var(--color-border); border-top-color: var(--color-accent); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.25rem; font-family: 'Merriweather'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(45, 55, 72, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-accent); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-accent); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-accent); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-accent); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-brain mr-3 text-purple-400"></i> <!-- Icono cerebro -->
                     Philosophia Interactiva
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-serif italic">» Explorador de Conceptos «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Grandes Ideas de la Filosofía</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Navega por los conceptos fundamentales que han moldeado el pensamiento humano. Selecciona un tema para profundizar.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar concepto, teoría o filósofo...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-yellow-500 mr-2"></i> <!-- Icono libro abierto -->
                 Índice de Conceptos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los archivos del pensamiento...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron conceptos para los términos de búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Más Ideas
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Profundizando en el concepto...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Reflexionando sobre la pregunta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta más sobre este concepto...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA con fines educativos y de divulgación filosófica.</p>
              <p class="mt-1">Consulta siempre fuentes académicas para estudios profundos.</p>
              <p class="mt-2">© 2025 Philosophia Interactiva</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // METAFÍSICA
            "Metafísica", "Ontología", "Ser y Devenir", "Existencia", "Esencia", "Sustancia", "Accidente (Filosofía)", "Universales y Particulares", "Realismo (Metafísica)", "Nominalismo", "Idealismo", "Materialismo", "Dualismo Cartesiano (Mente-Cuerpo)", "Monismo", "Pluralismo", "Causalidad", "Determinismo", "Libre Albedrío", "Compatibilismo", "Incompatibilismo", "Libertarismo (Metafísica)", "Necesidad y Contingencia", "Tiempo (Filosofía)", "Presentismo", "Eternalismo", "Teoría del Bloque Creciente", "Espacio (Filosofía)", "Identidad Personal", "Teoría del Haz (Bundle Theory)", "Teoría Sustancialista de la Identidad", "Persistencia a través del Tiempo", "El Absoluto (Hegel)", "La Cosa en Sí (Kant)", "Teoría de las Formas (Platón)", "Hilemorfismo (Aristóteles)", "Acto y Potencia (Aristóteles)", "Las Cuatro Causas (Aristóteles)", "Mónadas (Leibniz)", "La Voluntad (Schopenhauer)", "Voluntad de Poder (Nietzsche)", "Procesos y Objetos", "Realidad Virtual y Metafísica", "Posibilidad y Mundos Posibles",
            // EPISTEMOLOGÍA
            "Epistemología", "Conocimiento", "Creencia", "Justificación (Epistemología)", "Verdad", "Teoría de la Correspondencia de la Verdad", "Teoría Coherentista de la Verdad", "Teoría Pragmática de la Verdad", "Teoría Deflacionista de la Verdad", "Racionalismo", "Empirismo", "Ideas Innatas", "Tabula Rasa", "Escepticismo", "Escepticismo Pirrónico", "Escepticismo Académico", "Problema de Gettier", "Análisis Tripartito del Conocimiento", "Fiabilismo", "Fundacionalismo", "Coherentismo", "Evidencialismo", "Externalismo vs. Internalismo", "Conocimiento a Priori y a Posteriori", "Conocimiento Proposicional ('Saber que')", "Conocimiento Práctico ('Saber cómo')", "Percepción", "Problema de la Percepción", "Realismo Directo", "Realismo Indirecto (Representacionalismo)", "Fenomenalismo", "Memoria (Epistemología)", "Testimonio (Epistemología)", "Inducción", "Problema de la Inducción (Hume)", "Deducción", "Abducción (Inferencia a la Mejor Explicación)", "Paradoja de la Lotería", "Paradoja del Prefacio", "Contextualismo Epistémico", "Relativismo Epistémico", "Virtudes Epistémicas", "Epistemología Social", "Epistemología Feminista",
            // ÉTICA
            "Ética", "Metaética", "Ética Normativa", "Ética Aplicada", "Bien y Mal", "Correcto e Incorrecto", "Valor Intrínseco y Extrínseco", "Objetivismo Moral", "Subjetivismo Moral", "Relativismo Moral", "Emotivismo", "Prescriptivismo", "Teoría del Error (Mackie)", "Naturalismo Ético", "No Naturalismo Ético (Intuicionismo)", "Consecuencialismo", "Utilitarismo (Bentham, Mill)", "Utilitarismo del Acto", "Utilitarismo de la Regla", "Hedonismo", "Eudaimonia (Felicidad, Florecimiento)", "Deontología (Ética del Deber)", "Imperativo Categórico (Kant)", "Imperativo Hipotético (Kant)", "Ética Kantiana", "Teoría del Mandato Divino", "Ética de la Virtud (Aristóteles)", "Justo Medio (Aristóteles)", "Virtudes Cardinales", "Ética del Cuidado", "Contractualismo Moral", "Egoísmo Ético", "Altruismo", "Derechos Morales", "Justicia Distributiva", "Justicia Retributiva", "Problema del Tranvía (Trolley Problem)", "Ética Animal", "Bioética", "Ética Ambiental", "Ética Empresarial", "Ética Profesional", "Nihilismo Moral", "Supererogación", "Obligación Moral", "Intención",
            // LÓGICA
            "Lógica", "Argumento", "Premisa", "Conclusión", "Validez (Lógica)", "Solidez (Lógica)", "Lógica Formal", "Lógica Informal", "Lógica Proposicional", "Lógica de Predicados", "Lógica Modal", "Lógica Deóntica", "Lógica Temporal", "Lógica Difusa (Fuzzy Logic)", "Silogismo", "Modus Ponens", "Modus Tollens", "Falacia Lógica", "Falacia Ad Hominem", "Falacia del Hombre de Paja", "Falacia de Apelación a la Autoridad", "Falacia de Falsa Dicotomía", "Falacia de Petición de Principio (Circularidad)", "Falacia de Generalización Apresurada", "Non Sequitur", "Afirmación del Consecuente", "Negación del Antecedente", "Cuantificadores (Universal y Existencial)", "Tablas de Verdad", "Axioma", "Teorema", "Prueba Lógica", "Paradoja", "Paradoja del Mentiroso", "Paradoja de Russell", "Paradoja de Zenón (Aquiles y la Tortuga)", "Paradoja del Sorites (Montón)", "Identidad (Lógica)", "Principio de No Contradicción", "Principio del Tercero Excluido", "Principio de Identidad", "Ley de Peirce",
            // FILOSOFÍA POLÍTICA
            "Filosofía Política", "Estado", "Gobierno", "Autoridad Política", "Legitimidad", "Soberanía", "Contrato Social (Hobbes, Locke, Rousseau)", "Estado de Naturaleza", "Derechos Naturales", "Justicia", "Justicia como Equidad (Rawls)", "Posición Original (Rawls)", "Velo de la Ignorancia (Rawls)", "Libertad (Libertad Positiva vs. Negativa)", "Igualdad", "Democracia", "Democracia Directa", "Democracia Representativa", "Teoría de la Elección Pública", "Liberalismo", "Liberalismo Clásico", "Libertarismo", "Anarquismo", "Socialismo", "Comunismo", "Marxismo", "Fascismo", "Conservadurismo", "Republicanismo", "Comunitarismo", "Multiculturalismo", "Ciudadanía", "Desobediencia Civil", "Guerra Justa", "Tiranía", "Totalitarismo", "Utopía", "Distopía", "Bien Común", "Poder", "Propiedad Privada", "Separación de Poderes", "Teoría Política Normativa", "Teoría Política Descriptiva",
            // ESTÉTICA
            "Estética", "Belleza", "Fealdad", "Sublime", "Gusto (Estética)", "Juicio Estético", "Experiencia Estética", "Arte", "Definición del Arte", "Teoría Institucional del Arte", "Teoría Histórica del Arte", "Teoría Imitativa del Arte (Mímesis)", "Teoría Expresivista del Arte", "Formalismo (Arte)", "Intención del Artista", "Interpretación (Arte)", "Valor Artístico", "Autenticidad (Arte)", "Falsificación (Arte)", "Estética de la Música", "Estética de la Literatura", "Estética de las Artes Visuales", "Estética Ambiental", "Kitsch", "Vanguardia", "Postmodernismo (Estética)", "Catarsis",
            // FILOSOFÍA DE LA MENTE
            "Filosofía de la Mente", "Conciencia", "Problema Mente-Cuerpo", "Qualia", "Problema Difícil de la Conciencia (Chalmers)", "Intencionalidad", "Estados Mentales", "Creencias, Deseos, Intenciones", "Conductismo Filosófico", "Teoría de la Identidad Mente-Cerebro", "Funcionalismo (Mente)", "Materialismo Eliminativo", "Emergentismo", "Panpsiquismo", "Argumento de la Habitación China (Searle)", "Argumento del Conocimiento (Mary la Daltónica)", "Zombis Filosóficos", "Conciencia Animal", "Inteligencia Artificial (Filosofía)", "Test de Turing", "Libre Albedrío y Neurociencia", "El Inconsciente",
            // FILOSOFÍA DEL LENGUAJE
            "Filosofía del Lenguaje", "Lenguaje", "Significado", "Referencia", "Sentido y Referencia (Frege)", "Teoría Descriptivista de los Nombres", "Teoría Causal de la Referencia", "Teoría Verificacionista del Significado", "Teoría del Uso del Significado (Wittgenstein)", "Juegos de Lenguaje (Wittgenstein)", "Actos de Habla (Austin, Searle)", "Acto Locutivo, Ilocutivo, Perlocutivo", "Implicatura Conversacional (Grice)", "Principio de Cooperación (Grice)", "Teoría de la Relevancia", "Vaguedad", "Ambigüedad", "Metáfora", "Lenguaje Privado", "Semántica", "Sintaxis", "Pragmática", "Holismo Semántico", "Atomismo Semántico",
            // FILOSOFÍA DE LA CIENCIA
            "Filosofía de la Ciencia", "Método Científico", "Observación", "Experimentación", "Hipótesis", "Teoría Científica", "Ley Científica", "Explicación Científica", "Predicción Científica", "Falsacionismo (Popper)", "Problema de la Demarcación", "Paradigma Científico (Kuhn)", "Revolución Científica (Kuhn)", "Inconmensurabilidad (Kuhn)", "Realismo Científico", "Antirrealismo Científico", "Instrumentalismo", "Constructivismo Social (Ciencia)", "Teoría de la Confirmación", "Paradoja de Hempel (Cuervos)", "Unidad de la Ciencia", "Reduccionismo", "Explicación Causal", "Filosofía de la Biología", "Filosofía de la Física", "Filosofía de las Matemáticas", "Pseudociencia",
            // FILOSOFÍA DE LA RELIGIÓN
            "Filosofía de la Religión", "Dios", "Existencia de Dios", "Argumento Ontológico (Anselmo, Descartes)", "Argumento Cosmológico (Aquino)", "Argumento Teleológico (Diseño)", "Argumento Moral", "Apuesta de Pascal", "Ateísmo", "Agnosticismo", "Teísmo", "Deísmo", "Panteísmo", "Panenteísmo", "Problema del Mal", "Teodicea", "Milagro", "Fe y Razón", "Experiencia Religiosa", "Lenguaje Religioso", "Vida Después de la Muerte", "Alma", "Omnipotencia, Omnisciencia, Omnibenevolencia", "Paradoja de la Omnipotencia",
            // FILOSOFÍA ORIENTAL (Conceptos Clave)
            "Filosofía Oriental (General)", "Dao (Taoísmo)", "Wu Wei (Taoísmo)", "Yin y Yang", "Qi (Chi)", "Confucianismo", "Ren (Confucianismo)", "Li (Confucianismo)", "Budismo", "Cuatro Nobles Verdades", "Óctuple Sendero", "Nirvana", "Karma", "Samsara", "Anatta (No-Ser)", "Anicca (Impermanencia)", "Dukkha (Sufrimiento)", "Zen (Budismo)", "Satori", "Koan", "Hinduismo", "Brahman", "Atman", "Moksha", "Yoga (Filosofía)", "Jainismo", "Ahimsa", "Sikhismo",
            // FILÓSOFOS Y ESCUELAS (Conceptos asociados)
            "Presocráticos", "Sofistas", "Sócrates (Método Socrático)", "Platón (Teoría de las Formas, Alegoría de la Caverna)", "Aristóteles (Ética de la Virtud, Lógica, Metafísica)", "Cinismo", "Estoicismo", "Epicureísmo", "Escepticismo Antiguo", "Neoplatonismo", "San Agustín (Ciudad de Dios, Problema del Mal)", "Santo Tomás de Aquino (Escolástica, Cinco Vías)", "Renacimiento (Filosofía)", "Maquiavelo (El Príncipe)", "Descartes (Cogito Ergo Sum, Dualismo)", "Spinoza (Panteísmo, Ética Geométrica)", "Leibniz (Mónadas, Optimismo)", "Locke (Empirismo, Derechos Naturales)", "Berkeley (Idealismo Subjetivo)", "Hume (Empirismo Radical, Escepticismo)", "Rousseau (Contrato Social, Voluntad General)", "Kant (Idealismo Trascendental, Imperativo Categórico)", "Idealismo Alemán", "Hegel (Dialéctica, Espíritu Absoluto)", "Schopenhauer (La Voluntad)", "Kierkegaard (Existencialismo Cristiano)", "Marx (Materialismo Histórico, Lucha de Clases)", "Utilitarismo (Bentham, Mill)", "Nietzsche (Voluntad de Poder, Eterno Retorno, Superhombre)", "Pragmatismo (Peirce, James, Dewey)", "Frege (Logicismo)", "Russell (Atomismo Lógico, Paradoja)", "Wittgenstein (Tractatus, Investigaciones Filosóficas)", "Círculo de Viena (Positivismo Lógico)", "Fenomenología (Husserl)", "Existencialismo (Sartre, Camus, Beauvoir)", "Ser y Tiempo (Heidegger)", "Escuela de Frankfurt (Teoría Crítica)", "Filosofía Analítica", "Filosofía Continental", "Popper (Falsacionismo)", "Kuhn (Paradigmas)", "Rawls (Teoría de la Justicia)", "Foucault (Poder, Discurso)", "Derrida (Deconstrucción)", "Filosofía Postmoderna", "Singer (Ética Práctica)", "Chalmers (Problema Difícil)",
            // OTROS CONCEPTOS Y PARADOJAS
            "Navaja de Ockham", "Barco de Teseo", "Asno de Buridán", "Máquina de Experiencias (Nozick)", "Tierra Gemela (Putnam)", "Argumento del Mal Cerebro (Brain in a Vat)", "Solipsismo", "Humanismo", "Transhumanismo", "Posthumanismo", "Absurdismo", "Nihilismo", "Intuición", "Razón", "Emoción (Filosofía)", "Pensamiento Crítico", "Sabiduría", "Felicidad"
        ];
        const philosophicalThemes = [
            "metafísica occidental", "epistemología contemporánea", "teorías éticas", "lógica formal y falacias", "filosofía política moderna", "estética y teoría del arte", "filosofía de la mente", "filosofía del lenguaje", "filosofía de la ciencia", "filosofía de la religión", "conceptos de filosofía oriental", "ideas clave de Platón", "conceptos aristotélicos", "filosofía cartesiana", "empirismo británico", "ética kantiana", "idealismo alemán", "existencialismo", "positivismo lógico", "paradojas filosóficas", "teorías de la justicia", "problema mente-cuerpo", "teorías de la verdad", "libre albedrío vs determinismo", "conceptos del budismo zen"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un filósofo académico y divulgador experto. Tu tarea es explicar el siguiente concepto o teoría filosófica de manera clara, profunda y accesible. Define el término, explora sus orígenes históricos (si aplica), presenta los argumentos principales a favor y en contra, menciona a los filósofos clave asociados, discute sus implicaciones en diferentes áreas (ética, epistemología, metafísica, etc.), y si es pertinente, incluye ejemplos o experimentos mentales relevantes. El objetivo es una explicación completa de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente concepto filosófico:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat, system prompt se sobreescribe
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente de filosofía especializado únicamente en el concepto que se está mostrando. Responde preguntas de seguimiento sobre sus detalles, implicaciones, filósofos relacionados o críticas mencionadas en la explicación principal. Sé conciso y mantente estrictamente dentro del tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador conciso de temas filosóficos. Genera exactamente 15 nombres de conceptos filosóficos, paradojas, teorías éticas/políticas, o preguntas fundamentales adecuadas para una explicación detallada. Devuelve *solo* la lista, una por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que la versión anterior: searchInput, titleListContainer, etc.)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentConceptTitle = null; // Para el contexto del chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentConceptTitle
                ? `Actúa como un asistente de filosofía especializado únicamente en el concepto '${currentConceptTitle}'. Responde preguntas de seguimiento sobre sus detalles, implicaciones, filósofos relacionados o críticas mencionadas en la explicación principal. Sé conciso y mantente estrictamente dentro del tema actual.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores pueden estar experimentando mucho tráfico. Por favor, intenta de nuevo en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o elegir otro concepto.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentConceptTitle) throw new Error("Error interno: Contexto filosófico no establecido para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(philosophicalThemes) || "conceptos filosóficos generales";
            const specificPrompt = `Genera 15 nombres de conceptos, teorías o paradojas filosóficas sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                .then(text => {
                    const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                    if (titles.length < 5) throw new Error("La IA no generó suficientes ideas filosóficas.");
                    return titles.slice(0, 15);
                });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "abstract philosophical concept";
             // Prompt adaptado para conceptos abstractos
             const enhancedPrompt = `Abstract conceptual artwork representing the philosophical concept '${safePromptText}'. Use symbolism, metaphors, muted colors (deep blues, grays, ochre, cream), perhaps classical elements (columns, scrolls) or representations of thought/mind (mazes, lightbulbs, abstract shapes). Avoid literal depictions, text, labels, people unless metaphorical (like 'The Thinker'). Focus on mood and idea. Painterly style, thoughtful atmosphere.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, diagram, chart, realistic photograph, logo, signature, multiple images, collage, bright neon colors, cartoonish, simple illustration, clear depiction of a person";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (exactamente igual que antes) ... */
            if (!rawText) return ''; let formatted=rawText.trim(); formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1'); formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>'); formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match, base, exponent) => { const cleanExponent=exponent.replace('−','-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted=formatted.replace(/\\rightarrow/g,'&rarr;'); formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>'); formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>'); formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>'); formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>'); formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>'); formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>'); formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>'); const blocks=formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted=blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content=block.replace(/\n/g,' '); return `<p>${content}</p>`; }).join(''); return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (sin cambios en la lógica principal)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { storyModal.classList.remove('active'); if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; } modalTextArea.scrollTop = 0; console.log("Scroll set to 0 on hideModal"); resetModalState(); }
        function resetModalState() { modalLoadingIndicator.style.display = 'flex'; modalStoryContentArea.classList.add('content-hidden'); modalError.classList.add('content-hidden'); modalTitle.textContent = ''; modalContent.innerHTML = ''; modalErrorMessage.textContent = ''; chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; currentConceptTitle = null; hideFullscreenImage(); }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios en la lógica principal)
        function addChatMessage(message, sender) { const msgDiv=document.createElement('div'); msgDiv.classList.add('chat-message', sender==='user'?'user-message':'ai-message'); message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>'); message=message.replace(/\*(.*?)\*/g,'<em>$1</em>'); msgDiv.innerHTML=message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv=document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent=message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { const userQuery=chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ========== (sin cambios en la lógica principal)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { if (!titleListContainer || !titlesLoading) return; const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' })); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none'; if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay conceptos filosóficos disponibles «</p>'; return; } sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title)); newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } }); filterTitles(searchInput.value); }

        // MODIFIED handleTitleClick (sin cambios funcionales mayores, adaptado para 'concept')
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentConceptTitle = title; // SET CHAT CONTEXT
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-lightbulb placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización simbólica...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => { console.log("Image loaded successfully."); placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => { showFullscreenImage(imgElement.src); }); };
                imgElement.onerror = () => { console.error("Error loading image for:", title); placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { console.error("Could not create image URL for:", title); placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el concepto.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más ideas...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más conceptos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar conceptos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Ideas';
             }
         }

         // Search Filter Function (con normalización para tildes)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (sin cambios en la lógica principal)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) { console.error("Initialization failed: Missing essential elements."); document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error crítico: Faltan componentes de la interfaz.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>