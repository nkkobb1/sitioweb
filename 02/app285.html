<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MK vs DB - Crónicas del Crossover</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Temáticas -->
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para MK vs DB Crossover --- */
        :root {
            --color-mk-red: #e60000; /* Rojo Sangre MK */
            --color-db-orange: #ff8c00; /* Naranja Energía DB */
            --color-electric-blue: #00ffff; /* Ki/Raiden Blue */
            --color-deep-black: #080808; /* Fondo principal */
            --color-gold-accent: #ffcc00; /* Detalles, Super Saiyan */
            --color-purple-accent: #800080; /* Energía oscura/Frieza */
            --color-background: var(--color-deep-black);
            --color-text: #f0f0f0; /* Blanco Hueso */
            --color-text-muted: #a0a0a0; /* Gris Claro */
            --color-modal-bg: #1a1a1a; /* Gris muy oscuro para modal */
            --color-border: #444; /* Borde gris oscuro */
            --color-error-bg: #4d0000; /* Fondo error rojo oscuro */
            --color-error-text: #ffaaaa; /* Texto error rosa pálido */
            --color-error-border: var(--color-mk-red);

            --shadow-glow-red: 0 0 8px rgba(230, 0, 0, 0.7);
            --shadow-glow-blue: 0 0 8px rgba(0, 255, 255, 0.6);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.6), 0 4px 6px -4px rgba(0, 0, 0, 0.5);
            --border-radius: 4px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Teko', sans-serif; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; }
        .logo { color: var(--color-mk-red); text-shadow: 0 0 5px var(--color-db-orange); }
        .logo .db-part { color: var(--color-db-orange); margin-left: -5px; } /* Estilo para DB */
        h1.page-title { color: var(--color-text); font-weight: 700; text-shadow: 1px 1px 0 var(--color-mk-red), -1px -1px 0 var(--color-db-orange); }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid; border-image: linear-gradient(to right, var(--color-mk-red), var(--color-db-orange)) 1; padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-gold-accent); font-weight: 700; text-shadow: 0 0 4px rgba(255, 204, 0, 0.7); }
        .navbar { background-color: rgba(8, 8, 8, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1.1rem; background-color: rgba(26, 26, 26, 0.8); color: var(--color-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); transition: var(--transition-normal); font-family: 'Roboto'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-db-orange); box-shadow: 0 0 0 3px rgba(255, 140, 0, 0.3), inset 0 1px 3px rgba(0,0,0,0.5); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.2rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-db-orange); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Roboto'; font-size: 0.95rem; border-left: 4px solid transparent; position: relative; overflow: hidden;}
        .title-item::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 140, 0, 0.3), transparent); transition: left 0.4s ease; }
        .title-item:hover { transform: translateY(-3px) scale(1.01); box-shadow: 0 6px 12px rgba(0,0,0,0.6); border-color: var(--color-db-orange); color: var(--color-gold-accent); border-left-color: var(--color-mk-red); }
        .title-item:hover::before { left: 100%; }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-mk-red), var(--color-db-orange)); color: var(--color-deep-black); padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Teko', sans-serif; font-size: 1.5rem; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; letter-spacing: 2px; text-shadow: none; text-transform: uppercase; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-db-orange), var(--color-mk-red)); box-shadow: 0 0 15px rgba(255, 140, 0, 0.5); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: #777; cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-deep-black); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(8, 8, 8, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-image: linear-gradient(to bottom right, var(--color-mk-red), var(--color-db-orange)) 1;
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 980px; width: 95%;
            max-height: 90vh; min-height: 450px; /* Min height for game/content */
            overflow: hidden; position: relative;
            box-shadow: var(--shadow-lg), 0 0 20px rgba(255, 140, 0, 0.2);
            display: flex; flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: 1px solid #555; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-mk-red); color: var(--color-text); transform: rotate(90deg); box-shadow: var(--shadow-glow-red); border-color: var(--color-mk-red); }
        #modal-title { font-size: 2.2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.2; }

        /* Area Contenido Principal */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-db-orange) #333;
        }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: #2a2a2a; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-db-orange); border-radius: var(--border-radius); border: 1px solid #555; }
        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-db-orange); font-weight: 700; }
        #modal-content em { color: var(--color-electric-blue); font-style: italic; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Teko', sans-serif; margin-top: 2.4em; margin-bottom: 1.2em; color: var(--color-mk-red); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
        #modal-content h1 { font-size: 1.6em; } #modal-content h2 { font-size: 1.45em; }
        #modal-content h3 { font-size: 1.3em; color: var(--color-db-orange); }
        #modal-content h4 { font-size: 1.15em; color: var(--color-text-muted); border-bottom: none; }
        /* Imagen Final */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 3rem auto 1rem auto; border: 2px solid var(--color-gold-accent); border-radius: var(--border-radius); box-shadow: 0 0 18px rgba(255, 204, 0, 0.3); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: 0 0 25px rgba(255, 204, 0, 0.5); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 3rem auto 1rem auto; color: var(--color-text-muted); font-family: 'Roboto'; }
        #modal-content .image-placeholder .spinner { /* Spinner será reemplazado por el juego */ display: none; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-border); margin-bottom: 1rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid #333; border-radius: var(--border-radius); background-color: rgba(8, 8, 8, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-mk-red) #333; }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: #2a2a2a; }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-mk-red); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background: linear-gradient(to right, var(--color-db-orange), #cc7000); color: var(--color-deep-black); margin-left: auto; text-align: right; font-weight: 700; box-shadow: 2px 2px 5px rgba(0,0,0,0.4); }
        .ai-message { background-color: #383838; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; border-left: 3px solid var(--color-mk-red); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #222; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Roboto'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-mk-red); box-shadow: 0 0 5px rgba(230, 0, 0, 0.4); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-mk-red); color: var(--color-text); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #ff3333; }
        #chat-send-btn:disabled { background-color: #777; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.95em; color: var(--color-text-muted); display: none; font-family: 'Roboto'; }
        #chat-loading .fa-spinner { margin-right: 0.6rem; }

        /* Loading Overlay & Puzzle Game */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(8, 8, 8, 0.97);
            display: none; /* Changed initial state */
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius); padding: 2rem;
            text-align: center;
        }
        #modal-loading.active { display: flex; } /* Use class to show */

        #puzzle-game-container {
            width: 100%; max-width: 450px;
            margin-top: 1.5rem; padding: 1.5rem;
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
        }
        #puzzle-status {
            margin-bottom: 1.5rem;
            font-family: 'Teko', sans-serif;
            font-size: 1.8rem;
            color: var(--color-text);
        }
        #puzzle-status .level { color: var(--color-gold-accent); }
        #puzzle-status .message { font-size: 1.1rem; color: var(--color-text-muted); display: block; margin-top: 0.3rem; font-family: 'Roboto'; text-transform: none; letter-spacing: 0.5px;}

        #puzzle-sequence-display {
            display: flex; justify-content: center; align-items: center;
            min-height: 60px; margin-bottom: 1.5rem;
            background-color: #111; padding: 0.8rem;
            border-radius: var(--border-radius); border: 1px solid #333;
        }
        .puzzle-icon {
            font-size: 2.2rem; margin: 0 0.5rem;
            color: var(--color-text-muted);
            opacity: 0.3; transition: opacity 0.1s ease, color 0.1s ease, transform 0.1s ease;
        }
        .puzzle-icon.active {
            opacity: 1;
            transform: scale(1.2);
            text-shadow: 0 0 10px currentColor; /* Glow effect */
        }
        /* Icon specific colors when active */
        .puzzle-icon.active.fa-hand-fist { color: var(--color-mk-red); } /* Punch */
        .puzzle-icon.active.fa-shoe-prints { color: var(--color-electric-blue); transform: scale(1.2) rotate(10deg);} /* Kick */
        .puzzle-icon.active.fa-shield-halved { color: var(--color-gold-accent); } /* Block */
        .puzzle-icon.active.fa-bolt { color: var(--color-db-orange); } /* Ki Blast */
        .puzzle-icon.active.fa-skull-crossbones { color: var(--color-purple-accent); transform: scale(1.3);} /* Special/Fatality */
        .puzzle-icon.active.fa-arrow-up,
        .puzzle-icon.active.fa-arrow-down,
        .puzzle-icon.active.fa-arrow-left,
        .puzzle-icon.active.fa-arrow-right { color: #ccc; }


        #puzzle-input-area {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; justify-items: center;
        }
        .puzzle-input-btn {
            padding: 1rem; width: 70px; height: 70px;
            background-color: #333; border: 1px solid #555;
            border-radius: 50%; color: var(--color-text-muted);
            font-size: 1.8rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition-normal);
        }
        .puzzle-input-btn:hover:not(:disabled) { background-color: #444; color: var(--color-text); transform: scale(1.05); }
        .puzzle-input-btn:active:not(:disabled) { background-color: #555; transform: scale(0.98); }
        .puzzle-input-btn:disabled { background-color: #222; color: #666; cursor: not-allowed; }
        /* Centering the middle buttons */
        .puzzle-input-btn[data-input="up"] { grid-column: 2; grid-row: 1; }
        .puzzle-input-btn[data-input="left"] { grid-column: 1; grid-row: 2; }
        .puzzle-input-btn[data-input="right"] { grid-column: 3; grid-row: 2; }
        .puzzle-input-btn[data-input="down"] { grid-column: 2; grid-row: 3; }
        /* Corner buttons */
        .puzzle-input-btn[data-input="punch"] { grid-column: 1; grid-row: 1; }
        .puzzle-input-btn[data-input="kick"] { grid-column: 3; grid-row: 1; }
        .puzzle-input-btn[data-input="block"] { grid-column: 1; grid-row: 3; }
        .puzzle-input-btn[data-input="ki"] { grid-column: 3; grid-row: 3; }
        .puzzle-input-btn[data-input="special"] { grid-column: 2; grid-row: 2; background-color: var(--color-mk-red); color: white; } /* Center special */


        #loading-message { margin-top: 2rem; font-size: 1.1rem; color: var(--color-text-muted); font-family: 'Roboto';}
        #loading-message .fa-spinner { margin-right: 0.5rem; }

        /* General Error Message Style */
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Roboto'; font-size: 1.05rem; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); font-size: 1.2em; }

        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(8, 8, 8, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-gold-accent); box-shadow: var(--shadow-lg), 0 0 30px rgba(255, 204, 0, 0.4); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-gold-accent); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-gold-accent); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-gold-accent); color: var(--color-background); transform: scale(1.1) rotate(90deg); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-12">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-4xl sm:text-5xl">
                     <i class="fas fa-skull-crossbones mr-2 text-red-600"></i> <!-- MK Icon -->
                     MK <span class="text-gray-500 text-3xl mx-1">vs</span> <span class="db-part">DB</span>
                     <i class="fas fa-dragon ml-2 text-orange-500"></i> <!-- DB Icon -->
                 </h1>
             </div>
             <span class="text-lg text-gray-400 font-sans tracking-wider font-light">» Crónicas del Crossover «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-14 text-center">
             <h1 class="page-title text-5xl sm:text-7xl mb-6">Universos en Kolisión</h1>
             <p class="text-xl text-gray-300 mb-9 max-w-4xl mx-auto font-light">Los reinos chocan. Guerreros legendarios se enfrentan. Explora historias no contadas del encuentro más épico jamás imaginado.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-12 max-w-3xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar personaje, escenario o título...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-5xl mb-10 text-center mx-auto">
                 <i class="fas fa-scroll text-yellow-400 mr-3"></i> <!-- Icono pergamino -->
                 Archivos de Historias
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-xl font-sans">Accediendo a las líneas temporales alternativas...</p>
                  <!-- .title-item added here -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-6 hidden font-sans">» Ninguna crónica coincide con tu búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-10">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Más Crossovers
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Overlay with Puzzle Game -->
             <div id="modal-loading">
                 <div id="puzzle-game-container">
                     <div id="puzzle-status">
                         Nivel <span class="level">1</span>
                         <span class="message">¡Prepara tus reflejos!</span>
                     </div>
                     <div id="puzzle-sequence-display">
                         <!-- Icons will appear here -->
                     </div>
                     <div id="puzzle-input-area">
                         <!-- Buttons for Up, Down, Left, Right, Punch, Kick, Block, Ki, Special -->
                         <button class="puzzle-input-btn" data-input="punch" aria-label="Puño"><i class="fas fa-hand-fist"></i></button>
                         <button class="puzzle-input-btn" data-input="up" aria-label="Arriba"><i class="fas fa-arrow-up"></i></button>
                         <button class="puzzle-input-btn" data-input="kick" aria-label="Patada"><i class="fas fa-shoe-prints"></i></button>
                         <button class="puzzle-input-btn" data-input="left" aria-label="Izquierda"><i class="fas fa-arrow-left"></i></button>
                         <button class="puzzle-input-btn" data-input="special" aria-label="Especial"><i class="fas fa-skull-crossbones"></i></button>
                         <button class="puzzle-input-btn" data-input="right" aria-label="Derecha"><i class="fas fa-arrow-right"></i></button>
                         <button class="puzzle-input-btn" data-input="block" aria-label="Bloqueo"><i class="fas fa-shield-halved"></i></button>
                         <button class="puzzle-input-btn" data-input="down" aria-label="Abajo"><i class="fas fa-arrow-down"></i></button>
                         <button class="puzzle-input-btn" data-input="ki" aria-label="Ki"><i class="fas fa-bolt"></i></button>
                     </div>
                 </div>
                 <p id="loading-message">
                     <i class="fas fa-spinner fa-spin"></i> Cargando crónica... ¡Entrena mientras esperas!
                 </p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2> <!-- Title injected by JS -->
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image and placeholder injected by JS -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Analizando multiverso...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta línea temporal...">
                         <button id="chat-send-btn" aria-label="Enviar Pregunta"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Crossover">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-600 py-6 mt-16 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias generadas por IA como fan fiction, combinando los universos de Mortal Kombat y Dragon Ball.</p>
              <p class="mt-1">Mortal Kombat © Warner Bros. Entertainment Inc. Dragon Ball © Bird Studio/Shueisha, Toei Animation.</p>
              <p class="mt-2">© 2025 Crónicas del Crossover Interdimensional</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // 1v1 Matchups (Classic & Interesting)
            "Scorpion vs Vegeta: Duelo en el Netherrealm", "Sub-Zero vs Goku: Combate bajo cero", "Liu Kang vs Gohan (Místico): Torneo por el destino de la Tierra", "Raiden vs Beerus: Choque de Deidades", "Sonya Blade vs Androide 18: Batalla Tecnológica", "Johnny Cage vs Mr. Satan: El Verdadero Campeón", "Kano vs Freezer (Forma Final): Negocios Sucios Intergalácticos", "Shang Tsung vs Cell (Perfecto): Robo de Almas y Poder", "Shao Kahn vs Broly (Legendario): Conquista y Furia Desatada", "Kitana vs Bulma (con Armadura de Batalla): Princesa contra Genio", "Mileena vs Majin Buu (Gordo): Festín Macabro", "Jax vs Piccolo: Fuerza Bruta contra Estrategia Namekiana", "Kung Lao vs Krillin: Sombrero Filoso contra Kienzan", "Ermac vs Trunks (Futuro): Almas contra Espada", "Reptile vs Raditz: Duelo Saiyan Primitivo", "Baraka vs Yamcha: Garras contra Colmillo de Lobo", "Sindel vs Zamasu (Fusionado): Grito Mortal contra Justicia Divina", "Goro vs Nappa: Cuatro Brazos contra Élite Saiyan", "Quan Chi vs Babidi: Duelo de Hechiceros Malignos", "Kabal vs Dyspo: Carrera Supersónica", "Noob Saibot vs Janemba: Sombras y Demonios", "Smoke vs Hit: Asesinos Silenciosos", "Cyber Sub-Zero vs Frost Demon (Cooler)", "Cassie Cage vs Pan: Nueva Generación", "Jacqui Briggs vs Videl: Luchadoras Terrestres", "Kotal Kahn vs Jiren: Emperador contra Guerrero Absoluto", "D'Vorah vs Zarbon: Belleza Monstruosa", "Erron Black vs Mercenario Tao: Pistoleros Legendarios", "Fujin vs Whis: Dioses del Viento y el Tiempo", "Sheeva vs Ribrianne: Poder Femenino Bruto",
            // Team Ups & Team Battles
            "Z-Fighters en el Torneo Mortal Kombat de Shang Tsung", "Guerreros de Outworld invaden la Tierra (Universo DB)", "Liu Kang y Goku entrenan juntos bajo Raiden", "Vegeta y Scorpion: Alianza Infernal por Venganza", "Sub-Zero y Piccolo defienden un Templo Shaolin", "Sonya Blade y Equipo Universo 7 contra el Ejército de Shao Kahn", "Fuerzas Especiales vs Red Ribbon Army: Guerra Tecnológica", "Kitana lidera a los Saiyans para liberar Edenia", "Majin Buu absorbe a los participantes de Mortal Kombat", "Cell organiza su propio Torneo Mortal Kombat Perfecto", "Los Dioses Ancianos solicitan ayuda a los Dioses de la Destrucción", "Trunks viaja para evitar la fusión de Outworld y el Universo 7", "Androides 17 y 18 vs Sektor y Cyrax: Batalla Cibernética", "Goku Black siembra el terror en los Reinos de MK", "El Torneo del Poder incluye luchadores de Mortal Kombat", "Kombat Kids (Cassie, Jacqui, Takeda, Kung Jin) vs Goten y Trunks", "Alianza inesperada: Freezer y Quan Chi", "Raiden reúne a los Z-Fighters contra Shinnok", "Goku Super Saiyan Blue vs Shao Kahn con el poder del Kamidogu", "Vegeta Ultra Ego vs Liu Kang Dios del Fuego",
            // Quest & Scenario Based
            "Scorpion busca las Esferas del Dragón para revivir a su clan y esposa", "Bulma intenta reparar a los Cyber Lin Kuei", "Los Z-Fighters deben destruir el Amuleto de Shinnok", "Vegeta intenta aprender la hechicería de Shang Tsung", "Viaje al Netherrealm para rescatar a un Z-Fighter caído", "Shao Kahn intenta recolectar las Esferas del Dragón Negativas", "Goku aprende el 'Fatality' (versión no letal)", "Un personaje de MK desea la inmortalidad con las Esferas del Dragón", "El Torneo Shaolin es interrumpido por un ataque Saiyan", "Fusión Potara: ¿Goku y Raiden?", "Fusión Potara: ¿Vegeta y Sub-Zero?", "Fusión Dance: ¿Piccolo y Scorpion?", "Fusión Dance: ¿Gotenks y Ermac?", "Universo MK reacciona a la primera transformación Super Saiyan", "Hyperbolic Time Chamber en Outworld", "Krilin intenta sobrevivir un día en el Netherrealm", "Mr. Satan intenta reclamar la victoria en Mortal Kombat", "¿Qué pasaría si un Saiyan fuera infectado por el Tarkata?", "Entrenamiento con Kaiosama para personajes de MK", "Bills destruye un reino de Mortal Kombat por mala comida", "Whis entrena a un luchador de MK", "Los Namekianos intentan proteger sus Esferas de Shao Kahn", "Un personaje de DB queda atrapado en el Netherealm", "La Patrulla del Tiempo (DB Xenoverse) interviene en MK", "Cell absorbe ADN de luchadores de MK", "Majin Buu convierte a personajes de MK en chocolate", "La Genkidama contra la invasión de Outworld",
            // What Ifs & Alternate Realities
            "¿Y si Gohan fuera encontrado y entrenado por los Lin Kuei?", "¿Y si Vegeta fuera el campeón de Mortal Kombat?", "¿Y si Liu Kang pudiera transformarse en Super Saiyan?", "¿Y si Raiden fuera un Dios de la Destrucción?", "¿Y si Goku fuera corrompido por el poder de Shinnok?", "¿Y si Freezer conquistara Outworld?", "¿Y si Cell fuera un creación de Shang Tsung?", "¿Y si los eventos de MK9 ocurrieran en el Universo DB?", "¿Y si los Z-Fighters participaran en la defensa contra Shinnok (MKX)?", "¿Y si Kronika intentara fusionar las líneas temporales de MK y DB?", "¿Y si un personaje de MK se convirtiera en Ozaru?", "¿Y si un personaje de DB aprendiera la magia de Quan Chi?", "¿Y si las Fuerzas Especiales tuvieran acceso a la tecnología de Capsule Corp?", "¿Y si el torneo de Cell incluyera luchadores de MK?", "¿Y si Babidi intentara controlar a Shao Kahn con la marca Majin?", "¿Y si las Dragon Balls pudieran revertir los Fatalities?", "¿Y si un Dios Anciano se enfrentara a Zeno?", "¿Y si la energía Ki y la magia de MK fueran lo mismo?", "¿Y si los Cyber Lin Kuei fueran basados en los Androides?", "¿Y si Jiren fuera el guardián del Jinsei?",
             // Añadiendo más variedad
            "El Deseo de Kano: Riquezas de Capsule Corp", "La Ira de Broly Desatada en el Torneo Shaolin", "Piccolo Medita en el Templo del Cielo de Raiden", "Trunks del Futuro advierte a Raiden sobre la llegada de Cell", "Vegeta busca el poder de los Kamidogu", "Goku y Liu Kang: Rivales Respetuosos", "Sonya Blade investiga la tecnología Saiyan", "El Entrenamiento de Gohan con Bo' Rai Cho", "Majin Buu (Kid) vs Raiden Defensor de la Tierra", "Beerus juzga el Torneo Mortal Kombat", "Frieza intenta esclavizar a los Tarkatanos", "Cell vs Shang Tsung: Batalla de Absorción", "La Resurrección de 'F' en el Universo MK", "Supervivencia en Namek durante la invasión de Outworld", "Los Secretos del Clan Shirai Ryu y el Ki", "Sub-Zero busca la paz en el Otro Mundo de DB", "Kotal Kahn impresionado por el poder Saiyan", "D'Vorah considera a los Saiyans como huéspedes perfectos", "Erron Black en el Salvaje Oeste del Universo DB", "Los Dioses Ancianos observan el Torneo del Poder", "Kabal intenta superar la velocidad de la Luz (DB)", "Noob Saibot corrompe a un guerrero Z", "El origen cibernético: Dr. Gero y el Lin Kuei", "Cassie Cage usa Ki en sus ataques", "Jacqui Briggs con guanteletes de Capsule Corp", "Takeda aprende a sentir presencias como los Z-Fighters", "Kung Jin usa flechas de Ki", "Gotenks fusionado accidentalmente con un guerrero MK", "Goku Black admira la brutalidad de Mortal Kombat", "Zamasu considera a los mortales de MK una abominación aún mayor", "Jiren vs El One Being", "El Poder del Ultra Instinto contra la Magia de Quan Chi", "Vegeta Ultra Ego vs la Hechicería de Shang Tsung", "El Hakai de Beerus contra la inmortalidad de Shao Kahn", "Whis rebobina un Fatality", "Las Super Dragon Balls para restaurar los reinos caídos de MK", "La Fusión Metamoru entre dos luchadores de MK", "La Fusión Potara entre Raiden y Shin (Kai Supremo)", "Un personaje de MK aprende el Kaioken", "Un Saiyan aprende a usar la magia del Netherrealm", "Tecnología de Scouter para las Fuerzas Especiales", "Senzu Beans en medio de un combate Mortal Kombat", "La Nube Voladora en Outworld", "Las Fuerzas Ginyu posan en un escenario de MK", "Recreando la saga Saiyan con luchadores de MK", "Recreando la saga de Freezer con luchadores de MK", "Recreando la saga de Cell con luchadores de MK", "Recreando la saga de Buu con luchadores de MK", "Batalla por las Esferas del Dragón en Shang Tsung's Island", "Entrenamiento en la Habitación del Tiempo con luchadores MK", "El deseo de Shenron: '¡Hazme campeón de Mortal Kombat!'", "El deseo de Porunga: '¡Revive a todos los caídos en el torneo!'", "Reacción de los personajes MK al poder de Zeno", "Reacción de los personajes DB a los Fatalities", "Goku intenta hacer 'Friendship' con Shao Kahn", "Vegeta impresionado por la disciplina Lin Kuei", "Bulma y Jax: Colaboración tecnológica", "Piccolo respeta la sabiduría de Raiden", "Krillin aterrorizado por Mileena", "Yamcha derrotado... otra vez (por un Tarkatano)", "Tien y Ermac: Poderes múltiples", "Chaos y Quan Chi: ¿Marionetas?", "Maestro Roshi intenta ligar con Kitana o Sindel", "Androide 16 vs Goro: Gigantes silenciosos", "Androide 17 y 18 se aburren y causan estragos en Outworld", "Cooler busca venganza en Earthrealm (MK)", "Lord Slug invade un reino de MK", "Turles planta el Árbol del Poder en Edenia", "Bojack y su banda en el Torneo MK", "Super Androide 13 vs Cyber Ninjas", "El ejército de Freezer contra las hordas de Outworld", "La patrulla de Jaco investiga anomalías en los reinos MK", "Monaka resulta ser el campeón secreto de MK", "Hit contratado para eliminar a un personaje de DB en MK", "Caulifla y Kale aprendiendo artes marciales MK", "El Trio De Dangers (Bergamo, Lavender, Basil) vs Reptile, Ermac, Baraka", "Toppo (God of Destruction Candidate) vs Raiden", "Aniraza vs Onaga", "Frost (U6) vs Frost (MK)", "Magetta vs Tremor", "Botamo vs Bo' Rai Cho (Duelo de barrigas)", "Cabba entrenando con los Shaolin", "Auta Magetta vs Ferra/Torr", "Universo 6 vs Universo MK en un torneo amistoso (o no)", "Las Valkirias de U2 (Ribrianne, Kakunsa, Rozie) vs Kitana, Jade, Mileena", "Personajes olvidados de MK (Hsu Hao, Mavado) vs personajes olvidados de DB (Launch)", "Mokap vs Jaco: Héroes inesperados", "Meat vs Bacterian", "Blaze vs Bills: Duelo de energía elemental/destructiva", "Onaga (Rey Dragón) vs Super Shenron", "Taven y Daegon en busca de las Super Dragon Balls", "Shujinko aprende técnicas de los Z-Fighters", "Ashrah vs Dabura: Demonio contra Demonio Purificado", "Havik vs Kid Buu: Agentes del Caos Puro", "Hotaru vs Zamasu: Orden extremo", "Kira y Kobra vs Goten y Trunks (jóvenes delincuentes)", "Li Mei vs Chi-Chi: Mujeres guerreras y protectoras", "Nitara vs Puar (transformado en murciélago)", "Reiko vs Vegeta (ambición de poder)", "Sareena vs Androide 21 (Dualidad Demoniaca/Científica)", "Tanya vs Bulma (Intrigas y tecnología)",
            // ... y seguir combinando personajes, escenarios, poderes y conceptos...
        ];
        const crossoverThemes = [ // Para generar más títulos
            "Mortal Kombat vs Dragon Ball", "personajes de MK en el universo DB", "personajes de DB en el universo MK",
            "torneo crossover MK DB", "alianzas inesperadas MK DB", "villanos de MK contra Z-Fighters", "villanos de DB en Outworld",
            "fusión de personajes MK DB", "búsqueda de las Dragon Balls en MK", "poderes Ki vs Magia MK", "Super Saiyans en Mortal Kombat",
            "Fatalities vs Técnicas DB", "Raiden vs Dioses DB", "Shao Kahn vs Villanos DB", "Tecnología Capsule Corp vs Fuerzas Especiales",
            "Lin Kuei vs Guerreros Z", "Netherrealm vs Infierno DB", "Elder Gods vs Kais Supremos", "What if MK DB",
            "Kombat Kids vs Nueva Generación DB", "Cyber Iniciativa vs Androides DB", "Shinnok vs Goku Black/Zamasu",
            "Kronika vs Patrulla del Tiempo (Xenoverse)", "Torneo del Poder con luchadores MK"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un talentoso escritor de fan fiction especializado en crossovers épicos, particularmente entre Mortal Kombat y Dragon Ball. Tu tarea es escribir una historia corta y emocionante (aproximadamente 1200-1300 palabras) basada en el título/prompt proporcionado. Captura la esencia de ambos universos: la brutalidad y oscuridad de MK, la acción de alta energía y los niveles de poder de DB. Desarrolla las interacciones de los personajes de forma creíble dentro del escenario crossover. Usa un lenguaje vívido y enfócate en la acción, el diálogo y la atmósfera. Asegúrate de que la narrativa sea coherente con el prompt inicial. Escribe la historia basándote únicamente en este prompt:",
            timeoutSeconds: 180 // Aumentado ligeramente por la complejidad potencial
        };
         const chatApiConfig = {
             model: "mistral-tiny",
             systemPrompt: "Actúa como un experto conocedor de la crónica crossover específica entre Mortal Kombat y Dragon Ball que se acaba de presentar. Responde preguntas sobre los eventos de *esta* historia, las interacciones entre personajes específicos dentro de ella, o posibles desarrollos futuros basados *únicamente* en lo narrado. Sé conciso y mantén el tono de un fan entusiasta analizando esta línea temporal particular.",
             timeoutSeconds: 50
         };
        const titleGenerationConfig = {
            model: "mistral",
            // MODIFICADO: Solicitar 40 títulos
            systemPrompt: "Eres un generador de ideas prolífico para fan fiction crossover entre Mortal Kombat y Dragon Ball. Genera exactamente 40 títulos o prompts de historias únicos y atractivos. Mezcla enfrentamientos 1v1, batallas de equipos, escenarios 'what if', búsquedas de objetos (Dragon Balls/Reliquias MK), fusiones, y llegadas a universos alternos. Asegúrate de que haya variedad. Devuelve *solo* la lista, un ítem por línea. Sin números, guiones, introducciones o comentarios.",
            timeoutSeconds: 60 // Más tiempo para generar 40
        };

        // ========== DOM ELEMENTS ==========
        // ... (Igual que la versión anterior: searchInput, titleListContainer, etc.) ...
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingOverlay = document.getElementById('modal-loading'); // El overlay entero
        const modalStoryContentAreaWrapper = document.getElementById('modal-story-content-area'); // Wrapper del contenido principal
        const modalTextArea = document.getElementById('modal-content-area'); // Área de texto scrollable
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div para texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Puzzle Game Elements
        const puzzleGameContainer = document.getElementById('puzzle-game-container');
        const puzzleStatus = document.getElementById('puzzle-status');
        const puzzleSequenceDisplay = document.getElementById('puzzle-sequence-display');
        const puzzleInputArea = document.getElementById('puzzle-input-area');
        const puzzleInputBtns = puzzleInputArea.querySelectorAll('.puzzle-input-btn');
        const loadingMessage = document.getElementById('loading-message');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Contexto para chat
        let puzzleGameActive = false;
        let currentPuzzleSequence = [];
        let playerPuzzleInput = [];
        let puzzleLevel = 1;
        let puzzleSequenceTimeoutId = null;
        let puzzleIconFlashTimeoutId = null;
        let apiFetchController = null; // Para abortar fetch si se cierra el modal

        // ========== Puzzle Game Constants ==========
        const PUZZLE_ICONS = {
            'up': 'fa-arrow-up', 'down': 'fa-arrow-down', 'left': 'fa-arrow-left', 'right': 'fa-arrow-right',
            'punch': 'fa-hand-fist', 'kick': 'fa-shoe-prints', 'block': 'fa-shield-halved',
            'ki': 'fa-bolt', 'special': 'fa-skull-crossbones'
        };
        const PUZZLE_INPUTS = Object.keys(PUZZLE_ICONS);
        const BASE_SEQUENCE_LENGTH = 3;
        const SEQUENCE_DISPLAY_TIME_MS = 600; // Tiempo que cada icono está activo
        const TIME_BETWEEN_ICONS_MS = 200; // Pausa entre iconos
        const MAX_LEVEL = 20; // Opcional: un límite para que no sea infinito

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             apiFetchController = new AbortController(); // Nuevo controller para cada fetch

             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `Eres un experto conocedor de la crónica crossover específica entre Mortal Kombat y Dragon Ball titulada '${currentStoryTitle}'. Responde preguntas sobre los eventos de *esta* historia, las interacciones entre personajes específicos dentro de ella, o posibles desarrollos futuros basados *únicamente* en lo narrado. Sé conciso y mantén el tono de un fan entusiasta analizando esta línea temporal particular.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text (Chat: ${isChat}): ${url.substring(0, 150)}...`);

             const timeoutId = setTimeout(() => {
                if (apiFetchController) apiFetchController.abort();
             }, config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: apiFetchController.signal });
                 clearTimeout(timeoutId);
                 apiFetchController = null; // Limpiar controller después de uso

                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico ahora. Intenta en unos segundos, por favor.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La IA no pudo generar una respuesta coherente. Intenta con otro título.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 apiFetchController = null; // Limpiar en error
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con los reinos tardó demasiado (>${config.timeoutSeconds}s). Intenta de nuevo.`);
                 }
                 throw new Error(error.message || "Una fluctuación temporal impidió obtener la crónica.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentStoryTitle) throw new Error("Contexto perdido. No sé de qué historia hablamos."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() { // MODIFIED: Expect 40 titles
            const randomTheme = getRandomElement(crossoverThemes) || "Mortal Kombat vs Dragon Ball general";
            const specificPrompt = `Genera 40 prompts de historias crossover MK vs DB sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 200);
                     // Ajustar la validación para esperar más títulos
                     if (titles.length < 20) throw new Error("La IA no generó suficientes ideas de crossovers esta vez.");
                     return titles.slice(0, 40); // Devolver hasta 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 1024, height: 768, nologo: true }; // Mayor resolución
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Mortal Kombat vs Dragon Ball epic clash";
            // Prompt mejorado para la fusión de estilos
            const enhancedPrompt = `Epic crossover battle scene: ${safePromptText}. Style blend: gritty realism and dark fantasy of Mortal Kombat meets high-energy anime action and vibrant Ki effects of Dragon Ball Z. Dynamic composition, cinematic lighting, detailed characters (if mentioned), atmospheric background (Outworld, Namek, tournament arena etc.). No text, labels, logos.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, logo, watermark, signature, multiple panels, collage, simple background, cartoonish, chibi, poorly drawn, deformed, blurry";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (implementation hidden for brevity) ... */
            if (!rawText) return ''; let formatted=rawText.trim(); formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1'); formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>'); formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('−','-');return `${base}<sup>${cleanExponent}</sup>`;}); formatted=formatted.replace(/\\rightarrow/g,'&rarr;'); formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>'); formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>'); formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>'); formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>'); formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>'); formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>'); formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>'); const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0); formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block; let content=block.replace(/\n/g,' '); return `<p>${content}</p>`;}).join(''); return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            stopPuzzleGame(); // Asegurarse de detener el juego al cerrar
            if (apiFetchController) { // Abortar fetch si aún está activo
                 apiFetchController.abort();
                 apiFetchController = null;
                 console.log("API fetch aborted by modal close.");
            }
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             // No mostramos el loading overlay inmediatamente, lo activa handleTitleClick
             modalLoadingOverlay.classList.remove('active');
             modalStoryContentAreaWrapper.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = ''; chatInput.value = '';
             chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false;
             currentStoryTitle = null;
             // Reset Puzzle State (importante)
             puzzleLevel = 1; currentPuzzleSequence = []; playerPuzzleInput = [];
             puzzleStatus.innerHTML = `Nivel <span class="level">1</span><span class="message">¡Prepárate!</span>`;
             puzzleSequenceDisplay.innerHTML = '';
             disablePuzzleInput();
             // Hide fullscreen image
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (implementation hidden) ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... (implementation hidden) ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... (implementation hidden) ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... (implementation hidden) ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... (implementation hidden) ... */ const userQuery=chatInput.value.trim(); if(!userQuery||chatSendBtn.disabled)return; addChatMessage(userQuery,'user'); chatInput.value=''; chatSendBtn.disabled=true; chatLoadingIndicator.style.display='block'; try{const aiResponse=await fetchChatResponse(userQuery); addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error); addChatError(`Error IA: ${error.message}`);}finally{chatLoadingIndicator.style.display='none'; chatSendBtn.disabled=false; chatInput.focus();} }

        // ========== PUZZLE GAME FUNCTIONS ==========
        function startPuzzleGame() {
            console.log("Starting Puzzle Game");
            puzzleGameActive = true;
            puzzleLevel = 1;
            modalLoadingOverlay.classList.add('active'); // Mostrar el overlay de carga AHORA
            loadingMessage.classList.remove('content-hidden'); // Asegurarse que el mensaje 'cargando' es visible
            updatePuzzleStatus(`Nivel <span class="level">${puzzleLevel}</span>`, "Observa la secuencia...");
            generatePuzzleSequence();
            displayCurrentSequence();
        }

        function stopPuzzleGame() {
            console.log("Stopping Puzzle Game");
            puzzleGameActive = false;
            clearTimeout(puzzleSequenceTimeoutId);
            clearTimeout(puzzleIconFlashTimeoutId);
            disablePuzzleInput();
            // No ocultamos el overlay aquí, se oculta cuando el contenido está listo
        }

        function generatePuzzleSequence() {
            currentPuzzleSequence = [];
            const sequenceLength = BASE_SEQUENCE_LENGTH + puzzleLevel - 1;
            for (let i = 0; i < sequenceLength; i++) {
                currentPuzzleSequence.push(getRandomElement(PUZZLE_INPUTS));
            }
            playerPuzzleInput = []; // Resetear input del jugador
             console.log("Generated Sequence (Lvl", puzzleLevel,"): ", currentPuzzleSequence);
        }

        function displayCurrentSequence() {
            disablePuzzleInput();
            updatePuzzleStatus(`Nivel <span class="level">${puzzleLevel}</span>`, "Memoriza...");
            puzzleSequenceDisplay.innerHTML = ''; // Limpiar display
            currentPuzzleSequence.forEach(inputKey => {
                const iconClass = PUZZLE_ICONS[inputKey];
                const iconElement = document.createElement('i');
                iconElement.className = `fas ${iconClass} puzzle-icon`;
                iconElement.setAttribute('data-key', inputKey); // Guardar la key para referencia
                puzzleSequenceDisplay.appendChild(iconElement);
            });

            let index = 0;
            function showNextIcon() {
                if (!puzzleGameActive || index >= currentPuzzleSequence.length) {
                    enablePuzzleInput();
                    updatePuzzleStatus(`Nivel <span class="level">${puzzleLevel}</span>`, "¡Tu turno! Repite la secuencia.");
                    return;
                }

                const keyToShow = currentPuzzleSequence[index];
                const iconElement = puzzleSequenceDisplay.querySelector(`.puzzle-icon[data-key="${keyToShow}"]:nth-child(${index + 1})`);

                if (iconElement) {
                     // Apagar el anterior si existe
                     if (index > 0) {
                          const prevKey = currentPuzzleSequence[index - 1];
                          const prevIcon = puzzleSequenceDisplay.querySelector(`.puzzle-icon[data-key="${prevKey}"]:nth-child(${index})`);
                          if(prevIcon) prevIcon.classList.remove('active');
                     }

                    // Encender el actual
                    iconElement.classList.add('active');
                    // Apagar después de un tiempo
                    clearTimeout(puzzleIconFlashTimeoutId); // Limpiar timeout anterior si existe
                    puzzleIconFlashTimeoutId = setTimeout(() => {
                        if(puzzleGameActive && iconElement) iconElement.classList.remove('active');
                        // Llamar al siguiente icono después de una pausa
                         clearTimeout(puzzleSequenceTimeoutId);
                        puzzleSequenceTimeoutId = setTimeout(showNextIcon, TIME_BETWEEN_ICONS_MS);
                    }, SEQUENCE_DISPLAY_TIME_MS);

                    index++;
                } else {
                     // Si no se encuentra el icono (error improbable), pasar al siguiente
                     clearTimeout(puzzleSequenceTimeoutId);
                    puzzleSequenceTimeoutId = setTimeout(showNextIcon, TIME_BETWEEN_ICONS_MS);
                    index++;
                 }
            }
             clearTimeout(puzzleSequenceTimeoutId); // Limpiar cualquier timeout anterior
            puzzleSequenceTimeoutId = setTimeout(showNextIcon, TIME_BETWEEN_ICONS_MS); // Iniciar la secuencia
        }

        function handlePuzzleInput(event) {
            if (!puzzleGameActive || puzzleInputBtns[0].disabled) return; // Salir si el juego no está activo o inputs deshabilitados

            const inputKey = event.currentTarget.dataset.input;
            playerPuzzleInput.push(inputKey);

            // Feedback visual inmediato al presionar
            event.currentTarget.style.transform = 'scale(0.9)';
            event.currentTarget.style.backgroundColor = '#555';
            setTimeout(() => {
                event.currentTarget.style.transform = '';
                event.currentTarget.style.backgroundColor = '';
                 // Restaurar color especial del botón central si es él
                 if(event.currentTarget.dataset.input === 'special') {
                      event.currentTarget.style.backgroundColor = 'var(--color-mk-red)';
                 }
            }, 150);

            const currentIndex = playerPuzzleInput.length - 1;

            // Comprobar si el input es correcto hasta ahora
            if (currentPuzzleSequence[currentIndex] !== inputKey) {
                // Incorrecto
                 console.log("Incorrect Input!");
                 updatePuzzleStatus(`Nivel <span class="level">${puzzleLevel}</span>`, "<span style='color:var(--color-mk-red)'>¡Fallo!</span> Reintentando secuencia...");
                disablePuzzleInput();
                 // Penalización simple: volver a mostrar la secuencia actual
                setTimeout(() => {
                    if (puzzleGameActive) {
                         playerPuzzleInput = []; // Reset input
                         displayCurrentSequence(); // Mostrar de nuevo
                    }
                 }, 1200);
            } else if (playerPuzzleInput.length === currentPuzzleSequence.length) {
                // Secuencia completada correctamente
                 console.log("Sequence Correct!");
                updatePuzzleStatus(`Nivel <span class="level">${puzzleLevel}</span>`, "<span style='color:var(--color-electric-blue)'>¡Perfecto!</span> Preparando siguiente...");
                disablePuzzleInput();
                // Avanzar al siguiente nivel (si no es el máximo)
                if (puzzleLevel < MAX_LEVEL) {
                    puzzleLevel++;
                } else {
                     // Si ya está en el máximo, puede simplemente generar otra secuencia del mismo nivel
                     console.log("Max level reached, generating new sequence for level", puzzleLevel);
                }
                setTimeout(() => {
                    if (puzzleGameActive) {
                        generatePuzzleSequence();
                        displayCurrentSequence();
                    }
                }, 1000);
            }
            // Si es correcto pero no ha terminado la secuencia, no hacer nada, esperar el siguiente input.
        }

        function enablePuzzleInput() {
             if (!puzzleGameActive) return;
             puzzleInputBtns.forEach(btn => btn.disabled = false);
        }

        function disablePuzzleInput() {
             puzzleInputBtns.forEach(btn => btn.disabled = true);
        }

        function updatePuzzleStatus(levelText, messageText) {
            if (!puzzleStatus) return;
            puzzleStatus.innerHTML = `${levelText}<span class="message">${messageText}</span>`;
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... (implementation hidden) ... */ let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { /* ... (implementation hidden) ... */ const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... (implementation hidden) ... */ if (!titleListContainer || !titlesLoading) return; const sortedTitles=titles.sort((a,b)=>a.localeCompare(b)); titleListContainer.innerHTML=''; titlesLoading.style.display='none'; if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center">» No hay crónicas disponibles en esta línea temporal. «</p>'; return; } sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { /* ... (implementation hidden) ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title)); newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } }); filterTitles(searchInput.value); }

        // *** MODIFIED: handleTitleClick to integrate Puzzle Game ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal(); // Mostrar modal base (aún vacío/oculto)
            currentStoryTitle = title;
            modalTitle.textContent = title; // Poner título mientras carga

            // --- Iniciar Juego y Carga ---
            startPuzzleGame(); // Inicia el juego y muestra el overlay de carga

            try {
                // Fetch en segundo plano
                const rawExplanationText = await fetchExplanationText(title);

                 // --- Carga Terminada ---
                if (!puzzleGameActive) {
                     console.log("Puzzle game was stopped before API finished, likely modal closed.");
                     return; // Si el usuario cerró el modal mientras cargaba
                }
                stopPuzzleGame(); // Detener el juego
                modalLoadingOverlay.classList.remove('active'); // Ocultar overlay de carga

                // Mostrar Contenido
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentAreaWrapper.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;

                // Preparar y añadir placeholder/imagen (igual que antes)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<i class="fas fa-image placeholder-icon"></i><p>Procesando visualización del crossover...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización: ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p>Visualización fallida.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p>Error URL de imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                 if (!puzzleGameActive && error.name !== 'AbortError') { // Evitar doble error si ya se abortó
                     console.log("Modal likely closed during fetch error handling.");
                     return;
                }
                stopPuzzleGame(); // Detener juego en caso de error
                modalLoadingOverlay.classList.remove('active'); // Ocultar overlay
                modalErrorMessage.textContent = error.message || "Fallo catastrófico al cargar la crónica.";
                modalError.classList.remove('content-hidden');
                modalStoryContentAreaWrapper.classList.remove('content-hidden'); // Mostrar area de error
                modalContent.innerHTML = ''; // Limpiar
                chatSection.classList.add('content-hidden');
            }
        }

        // MODIFIED: handleGenerateMoreTitles requests 40
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando líneas temporales...';
             try {
                 // Usa la función fetchTextFromApi directamente con la config de títulos
                 const text = await fetchTextFromApi("Genera 40 prompts crossover MK DB", titleGenerationConfig, false);
                 const newTitles = text.split('\n')
                                     .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                     .filter(line => line.length > 10 && line.length < 200)
                                     .slice(0, 40); // Asegurar que no exceda 40

                 if (newTitles && newTitles.length > 10) { // Esperar al menos algunas
                     appendTitles(newTitles);
                 } else {
                     alert("No se pudieron encontrar suficientes nuevas crónicas en este momento.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error explorando crossovers: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Crossovers';
             }
         }

         // Search Filter Function (con normalización)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // ... (Verificar todos los elementos, incluyendo los del puzzle) ...
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalLoadingOverlay || !puzzleGameContainer || !puzzleStatus || !puzzleSequenceDisplay || !puzzleInputArea ) {
                console.error("Initialization failed: Missing essential UI elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">FATAL ERROR: UI Components Corrupted. Cannot initiate Crossover Protocol.</p>';
                return;
             }

            // Base Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            // Chat Listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            // Fullscreen Image Listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Puzzle Game Input Listeners
            puzzleInputBtns.forEach(btn => {
                btn.addEventListener('click', handlePuzzleInput);
            });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            modalLoadingOverlay.classList.remove('active'); // Asegurarse que empieza oculto
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>