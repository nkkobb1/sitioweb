<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Entrenamiento Mental - Guía Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y enfocadas -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Entrenamiento Mental --- */
        :root {
            --color-primary: #2563eb; /* Azul Enfocado */
            --color-secondary: #10b981; /* Verde Menta/Calma */
            --color-tertiary: #8b5cf6; /* Púrpura Suave (énfasis) */
            --color-background: #f9fafb; /* Blanco Hueso / Gris muy claro */
            --color-text: #1f2937; /* Gris Oscuro */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco */
            --color-border: #d1d5db; /* Borde Gris Claro */
            --color-error-bg: #fef2f2; /* Fondo error rojo muy claro */
            --color-error-text: #991b1b; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Poppins', sans-serif; font-weight: 600; }
        .logo { color: var(--color-primary); font-weight: 700; }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 600;}
        #modal-title { color: var(--color-primary); font-weight: 600; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-primary); background-color: #f0fdf4; border-left-color: var(--color-secondary); }
        #generate-more-btn { grid-column: 1 / -1; background: var(--color-primary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Poppins', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1d4ed8; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { /* Spinner style if needed */ }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Increased for game */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e5e7eb; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.5rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: scale(1.1); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Poppins', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 600;}
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(209, 213, 219, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary); } /* Icono relacionado */

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; /* Adjusted height */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95em; }
        .user-message { background-color: var(--color-primary); color: #ffffff; margin-left: auto; text-align: left; } /* Adjusted alignment */
        .ai-message { background-color: #e5e7eb; color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-secondary); color: #ffffff; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #059669; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; color: var(--color-primary); }

        /* Loading Modal & Minigame */
        #modal-loading {
            text-align: center; padding: 2rem 1rem; /* More padding for game */
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.98); /* Lighter background */
            display: none; /* Hidden initially, shown by JS */
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius);
        }
        #modal-loading.active { display: flex; } /* Use class to show */
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p#loading-text { font-weight: 500; color: var(--color-text); font-size: 1.2rem; font-family: 'Poppins'; margin-bottom: 1.5rem; }
        /* Minigame Styles */
        #minigame-container { margin-top: 1rem; width: 100%; max-width: 250px; }
        #loading-minigame { display: block; /* Canvas is inline by default */ margin: 0 auto 0.5rem auto; background-color: #e5e7eb; border-radius: 4px; cursor: pointer; border: 1px solid var(--color-border); }
        #minigame-instructions { font-size: 0.9em; color: var(--color-text-muted); margin-bottom: 0.5rem; }
        #minigame-score-display { font-size: 1em; font-weight: 600; color: var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Error Message */
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.92); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-modal-bg); box-shadow: var(--shadow-lg); border-radius: 4px; }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); opacity: 0.8; }
        #fullscreen-close-btn:hover { opacity: 1; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-brain mr-3 text-blue-500"></i> <!-- Icono Cerebro -->
                     Entrenamiento Mental
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Optimiza tu Potencial Cognitivo «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora Técnicas Cognitivas</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre y aprende sobre métodos para mejorar memoria, enfoque, creatividad y más. Selecciona un área o busca un concepto.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar técnica, concepto o ejercicio...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-lightbulb text-yellow-500 mr-2"></i> <!-- Icono Idea -->
                 Áreas de Entrenamiento
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando catálogo de técnicas...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron técnicas para tu búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Más Técnicas (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading"> <!-- Initially hidden via style -->
                 <div class="loading-spinner-modal"></div>
                 <p id="loading-text">Cargando información...</p>
                 <div id="minigame-container">
                     <p id="minigame-instructions">Juego de Reacción: Haz clic cuando el círculo sea azul.</p>
                     <canvas id="loading-minigame" width="150" height="150"></canvas>
                     <p id="minigame-score-display">Puntuación: <span id="minigame-score">0</span></p>
                 </div>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder added here by JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <h4 class="text-sm font-semibold text-gray-600 mb-2 text-center">¿Preguntas sobre "<span id="chat-topic-title"></span>"?</h4>
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Procesando...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Escribe tu pregunta aquí...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos y de referencia sobre entrenamiento cognitivo.</p>
              <p class="mt-1">Consulta siempre a profesionales para asesoramiento personalizado en salud mental o aprendizaje.</p>
              <p class="mt-2">© 2025 Centro de Entrenamiento Mental</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Memoria
            "Técnica del Palacio de la Memoria (Método de Loci)", "Sistema de Repetición Espaciada (SRS)", "Mnemotecnia: Acrónimos y Acrósticos", "Mnemotecnia: Sistema Mayor (Fonético)", "Mnemotecnia: Técnica de la Cadena", "Mnemotecnia: Visualización Asociativa", "Mejorar la Memoria de Trabajo", "Memoria a Corto Plazo vs. Largo Plazo", "Cómo recordar nombres y caras", "Técnicas para recordar números largos", "El papel del sueño en la consolidación de la memoria", "Memoria Episódica: Recordar eventos", "Memoria Semántica: Recordar hechos", "Memoria Procedimental: Habilidades motoras", "El olvido: Curva de Ebbinghaus", "Interferencia Proactiva y Retroactiva", "Efecto de la Posición Serial (Primacy & Recency)", "Chunking: Agrupar información", "Memoria Autobiográfica", "Flashbulb Memories (Recuerdos Vívidos)", "Mejorar la memoria con ejercicio físico", "Dieta y suplementos para la memoria", "Mindfulness y su impacto en la memoria", "Cómo estudiar para mejorar la retención", "Técnica de Feynman para el aprendizaje", "Elaboración: Conectar nueva información", "Context-Dependent Memory", "State-Dependent Memory", "Mejorar la memoria visual", "Mejorar la memoria auditiva", "Metamemoria: Conciencia de la propia memoria",
            // Enfoque y Atención
            "Técnica Pomodoro", "Mindfulness y Meditación para el Enfoque", "Eliminar distracciones digitales", "Entrenamiento de la Atención Sostenida", "Entrenamiento de la Atención Selectiva", "Entrenamiento de la Atención Dividida", "Manejo del TDAH (Estrategias cognitivas)", "Flujo (Flow State): Cómo alcanzarlo", "Deep Work: Trabajo Profundo", "Single-Tasking vs. Multi-Tasking", "El Costo del Cambio de Tarea (Task Switching Cost)", "Notificaciones: Cómo gestionarlas", "Organización del espacio de trabajo", "Descansos activos para mantener el enfoque", "La importancia de la hidratación y nutrición", "Ejercicio y su efecto en la atención", "Música para la concentración (Binaural, Clásica, etc.)", "Reducir la Carga Cognitiva", "Priorización de Tareas (Matriz de Eisenhower)", "Establecer Objetivos SMART", "Vencer la Procrastinación: Estrategias", "Atención Plena en actividades diarias", "Escucha Activa", "Observación Detallada", "Control de Impulsos", "Resistencia a la gratificación instantánea", "Manejo del aburrimiento productivo", "Fatiga de Decisión: Cómo combatirla", "Mind Wandering (Divagación Mental): ¿Bueno o malo?", "Neurofeedback para la atención",
            // Resolución de Problemas y Lógica
            "Pensamiento Crítico: Fundamentos", "Análisis FODA (SWOT)", "Diagrama de Ishikawa (Causa-Efecto)", "Técnica de los Seis Sombreros para Pensar", "Brainstorming y Brainwriting", "Mapas Mentales para la resolución de problemas", "Pensamiento Lateral (Edward de Bono)", "Método SCAMPER", "Algoritmos vs. Heurísticas", "Razonamiento Deductivo", "Razonamiento Inductivo", "Razonamiento Analógico", "Falacias Lógicas Comunes", "Resolución de Problemas Complejos", "Definición del Problema: Técnica de los 5 Porqués", "Generación de Soluciones Alternativas", "Evaluación de Soluciones", "Implementación y Seguimiento", "Pensamiento Basado en Sistemas", "Teoría de Restricciones (TOC)", "Diseño Centrado en el Usuario (Problem Solving)", "Pruebas A/B para decisiones", "Análisis de Causa Raíz (RCA)", "Toma de Decisiones Bajo Incertidumbre", "Modelado de Problemas", "Simulación Mental", "Juegos de Lógica (Sudoku, Ajedrez)", "Programación y Pensamiento Computacional", "Matemáticas Recreativas", "Desarrollo del Pensamiento Abstracto",
            // Creatividad e Innovación
            "Pensamiento Divergente vs. Convergente", "Técnicas de Brainstorming Avanzadas", "Método 6-3-5 (Brainwriting)", "Conexiones Forzadas (Random Word)", "Analogías y Metáforas Creativas", "Visualización Creativa", "Escritura Libre (Freewriting)", "Storytelling para la creatividad", "El Proceso Creativo: Etapas", "Superar Bloqueos Creativos", "La importancia del juego en la creatividad", "Cultivar la Curiosidad", "Apertura a Nuevas Experiencias", "Pensamiento Visual", "Prototipado Rápido", "Design Thinking", "Innovación Disruptiva vs. Incremental", "Inteligencia Colectiva", "Serendipia: Fomentar descubrimientos casuales", "El rol del descanso y la incubación", "Ambientes que fomentan la creatividad", "Miedo al fracaso y creatividad", "Originalidad vs. Inspiración", "Combinación de Ideas Existentes", "Improvisación como herramienta creativa", "Humor y Creatividad", "Arte Terapia", "Música y Creatividad", "Lectura Diversa para inspirar", "Viajar y Exponerse a Culturas",
            // Inteligencia Emocional y Social
            "Autoconciencia Emocional", "Autorregulación Emocional", "Motivación Intrínseca y Extrínseca", "Empatía Cognitiva y Afectiva", "Habilidades Sociales: Comunicación Asertiva", "Manejo de Conflictos", "Escucha Activa Empática", "Lenguaje Corporal: Interpretación", "Construcción de Relaciones (Rapport)", "Inteligencia Social", "Teoría de la Mente", "Reconocimiento de Microexpresiones", "Manejo del Estrés y la Ansiedad", "Resiliencia Emocional", "Optimismo Aprendido (Seligman)", "Gratitud: Práctica y Beneficios", "Regulación del Estado de Ánimo", "Inteligencia Emocional en el Liderazgo", "Trabajo en Equipo y Colaboración", "Feedback Efectivo: Dar y Recibir", "Manejo de la Crítica", "Negociación basada en principios", "Persuasión Ética", "Carisma: ¿Se aprende?", "Validación Emocional", "Límites Saludables", "Inteligencia Emocional y Toma de Decisiones", "Resolver Malentendidos", "Cultura y Expresión Emocional",
            // Lectura Rápida y Procesamiento de Información
            "Técnicas de Lectura Rápida: Skimming y Scanning", "Eliminar la Subvocalización", "Ampliar el Campo Visual de Lectura", "Uso de Puntero o Guía Visual", "Comprensión Lectora a Alta Velocidad", "Lectura Activa: SQ3R", "Tomar Notas Efectivamente (Cornell, Mapas Mentales)", "Síntesis de Información", "Evaluación Crítica de Fuentes", "Procesamiento Rápido de Información Digital", "Filtrado de Información Relevante", "Curación de Contenidos", "Velocidad de Procesamiento Cognitivo", "Memoria de Trabajo y Lectura", "Vocabulario y Velocidad de Lectura", "Concentración Durante la Lectura Prolongada", "Lectura Diagonal", "PhotoReading (Concepto y Críticas)", "Software y Apps de Lectura Rápida", "Cuándo NO usar Lectura Rápida", "Lectura Profunda (Deep Reading)", "Comprensión vs. Velocidad: El Equilibrio", "Mejorar la Velocidad de Escritura (Tipeo)", "Organización de la Información Leída", "Recordar lo Leído a Largo Plazo",
            // Salud Cerebral y Neurociencia Básica
            "Neuroplasticidad: El Cerebro Cambiante", "Neurogénesis: Creación de Neuronas", "Importancia del Sueño para el Cerebro", "Impacto del Ejercicio Físico en el Cerebro (BDNF)", "Dieta Saludable para el Cerebro (Omega-3, Antioxidantes)", "Hidratación y Función Cognitiva", "Manejo del Estrés Crónico y el Cortisol", "Reserva Cognitiva: Protección contra el Declive", "Envejecimiento Cerebral Saludable", "Estimulación Cognitiva a lo Largo de la Vida", "Bilingüismo y Beneficios Cognitivos", "Aprendizaje de Habilidades Nuevas (Música, Idiomas)", "Meditación y Cambios Cerebrales", "Conectividad Cerebral (Redes Neuronales)", "Hemisferios Cerebrales: Mitos y Realidades", "Lóbulos Cerebrales y sus Funciones", "Neurotransmisores Clave (Dopamina, Serotonina, Acetilcolina)", "Impacto del Alcohol y Drogas en el Cerebro", "Prevención del Deterioro Cognitivo Leve", "Salud Cardiovascular y Salud Cerebral", "Socialización y Salud Cerebral", "La Mente Corporal (Embodied Cognition)", "El Microbioma Intestinal y el Cerebro", "Luz Solar y Vitamina D para el Cerebro", "Contaminación Ambiental y Cerebro",
             // Ejercicios Específicos
            "Ejercicio N-Back", "Dual N-Back", "Test de Stroop", "Torre de Hanoi", "Problema de las Jarras de Agua", "Matrices Progresivas de Raven", "Analogías de Miller", "Trail Making Test", "Corsi Block-Tapping Test", "Wisconsin Card Sorting Test (WCST)", "Simon Task", "Flanker Task", "Go/No-Go Task", "Digit Span Test (Amplitud de Dígitos)", "Juegos de Entrenamiento Cerebral (Lumosity, Elevate, etc.) - Efectividad", "Ajedrez como Entrenamiento Mental", "Sudoku y Kakuro", "Crucigramas y Sopas de Letras", "Aprender un Instrumento Musical", "Aprender un Nuevo Idioma", "Malabares y Coordinación", "Origami y Concentración", "Meditación Guiada", "Ejercicios de Respiración Profunda", "Escaneo Corporal (Body Scan)", "Práctica de la Gratitud Diaria", "Llevar un Diario Reflexivo", "Debate y Argumentación Estructurada", "Juegos de Rol (RPG) y Toma de Decisiones", "Programación como Ejercicio Lógico", "Escritura Creativa", "Dibujo y Pintura",
            // Sesgos Cognitivos y Metacognición
            "Sesgo de Confirmación", "Heurística de Disponibilidad", "Heurística de Representatividad", "Anclaje (Anchoring Bias)", "Efecto Dunning-Kruger", "Sesgo Retrospectivo (Hindsight Bias)", "Falacia del Costo Hundido", "Aversión a la Pérdida", "Efecto Halo", "Pensamiento de Grupo (Groupthink)", "Sesgo de Optimismo", "Sesgo de Negatividad", "Error Fundamental de Atribución", "Cómo Identificar y Mitigar Sesgos", "Metacognición: Pensar sobre el Pensamiento", "Monitoreo Cognitivo", "Control Cognitivo", "Autoevaluación del Aprendizaje", "Estrategias Metacognitivas", "Calibración de la Confianza", "Reflexión sobre Procesos Mentales", "Aprender a Aprender", "Mentalidad de Crecimiento (Growth Mindset)", "Curiosidad Intelectual", "Humildad Intelectual",
        ];
        const mentalTrainingThemes = [
            "técnicas de memoria", "mejorar la concentración", "resolución de problemas", "estimulación de la creatividad", "inteligencia emocional", "lógica y razonamiento", "lectura rápida y comprensión", "mindfulness y meditación", "salud cerebral", "neurociencia cognitiva", "ejercicios mentales específicos", "superar bloqueos mentales", "aprendizaje efectivo", "toma de decisiones", "sesgos cognitivos", "metacognición", "atención plena", "manejo del estrés cognitivo", "plasticidad cerebral", "juegos mentales", "habilidades sociales cognitivas", "pensamiento crítico", "organización mental", "optimización cognitiva"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral", // Puedes probar "mistral-large" si necesitas más profundidad, pero será más lento
            systemPrompt: "Eres un neurocientífico cognitivo y experto en psicología del aprendizaje y rendimiento mental. Tu tarea es explicar de forma clara, detallada y práctica la técnica, concepto o ejercicio de entrenamiento mental indicado. Incluye: Definición clara, principios subyacentes (base científica si aplica, de forma sencilla), cómo aplicarlo paso a paso (si es una técnica), beneficios esperados, posibles dificultades o consejos, y áreas cognitivas que impacta (memoria, atención, etc.). Usa un lenguaje accesible pero preciso, evitando jerga excesiva. El objetivo es una guía útil y motivadora de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tema de entrenamiento mental:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúa como un asistente de entrenamiento mental enfocado únicamente en el tema actual. Responde preguntas específicas sobre cómo aplicar la técnica, aclarar dudas sobre la explicación principal, o dar ejemplos relacionados. Sé conciso, práctico y motivador.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
             // **MODIFIED PROMPT FOR 40 TITLES**
            systemPrompt: "Actúa como un generador de ideas conciso para un catálogo de entrenamiento mental. Genera exactamente 40 nombres de técnicas, ejercicios, conceptos o áreas de mejora cognitiva. Deben ser variados y relevantes para el desarrollo mental. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Slightly longer timeout for more titles
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Loading overlay div
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const chatTopicTitle = document.getElementById('chat-topic-title');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameCanvas = document.getElementById('loading-minigame');
        const minigameScoreSpan = document.getElementById('minigame-score');
        const minigameContainer = document.getElementById('minigame-container');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Context for chat
        let minigameInterval = null; // Interval ID for the minigame loop
        let minigameScore = 0;
        let minigameCtx = null;
        let minigameCurrentColor = 'grey';
        const MINIGAME_TARGET_COLOR = '#2563eb'; // Blue (matches primary)
        const MINIGAME_OTHER_COLOR = '#d1d5db'; // Grey
        const MINIGAME_HIT_COLOR = '#10b981';   // Green
        const MINIGAME_MISS_COLOR = '#ef4444'; // Red
        const MINIGAME_INTERVAL_MS = 800; // Speed of color change

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Eres un asistente de entrenamiento mental enfocado únicamente en '${currentTopicTitle}'. Responde preguntas específicas sobre cómo aplicar la técnica, aclarar dudas sobre la explicación principal, o dar ejemplos relacionados. Sé conciso, práctico y motivador.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     // *** USER-FRIENDLY ERROR MESSAGE ***
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, por favor intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o seleccionar otro tema.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     // *** USER-FRIENDLY TIMEOUT MESSAGE ***
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentTopicTitle) throw new Error("Error interno: Contexto del tema no establecido para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        // ** MODIFIED TO EXPECT 40+ TITLES **
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(mentalTrainingThemes) || "entrenamiento cognitivo general";
            // Prompt pide explícitamente 40
            const specificPrompt = `Genera 40 nombres/conceptos variados sobre ${randomTheme} para entrenamiento mental.`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     // Expect more titles
                     if (titles.length < 15) throw new Error("La IA no generó suficientes ideas de técnicas.");
                     return titles.slice(0, 40); // Take up to 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "mental training concept abstract";
             // Prompt focused on abstract/conceptual visuals for mental training
             const enhancedPrompt = `Abstract conceptual art representing '${safePromptText}'. Focus on concepts like focus, memory, neural networks, brain waves, learning, problem-solving. Use calm or focused color palettes (blues, greens, purples, greys). Avoid text, labels, diagrams, realistic human figures. Clean, modern, slightly minimalist style.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, letters, labels, diagrams, charts, graphs, realistic person, busy background, clutter, watermark, signature, cartoon, drawing, illustration, multiple images";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MINIGAME FUNCTIONS ==========
        function drawMinigameShape(color = MINIGAME_OTHER_COLOR) {
            if (!minigameCtx) return;
            const canvas = minigameCanvas;
            minigameCtx.clearRect(0, 0, canvas.width, canvas.height);
            minigameCtx.fillStyle = color;
            minigameCtx.beginPath();
            minigameCtx.arc(canvas.width / 2, canvas.height / 2, canvas.width / 2 - 10, 0, Math.PI * 2); // Draw a circle
            minigameCtx.fill();
            minigameCurrentColor = color; // Store current color
        }

        function changeMinigameColor() {
            // Higher chance of grey, lower chance of blue
            const isTarget = Math.random() < 0.25; // 25% chance of target color
            drawMinigameShape(isTarget ? MINIGAME_TARGET_COLOR : MINIGAME_OTHER_COLOR);
        }

        function handleMinigameClick(event) {
            if (!minigameInterval) return; // Game not running

            if (minigameCurrentColor === MINIGAME_TARGET_COLOR) {
                minigameScore++;
                minigameScoreSpan.textContent = minigameScore;
                drawMinigameShape(MINIGAME_HIT_COLOR); // Flash green on hit
                // Optional: Immediately change color after hit
                setTimeout(() => {
                    if (minigameInterval) drawMinigameShape(MINIGAME_OTHER_COLOR);
                }, 150);
            } else if (minigameCurrentColor === MINIGAME_OTHER_COLOR) {
                // Optional: Penalize clicks on non-target color
                 minigameScore = Math.max(0, minigameScore - 1); // Decrease score, but not below 0
                 minigameScoreSpan.textContent = minigameScore;
                 drawMinigameShape(MINIGAME_MISS_COLOR); // Flash red on miss
                 setTimeout(() => {
                    if (minigameInterval) drawMinigameShape(MINIGAME_OTHER_COLOR);
                }, 150);
            }
            // Do nothing if clicked on green/red flash
        }

        function startMinigame() {
            if (!minigameCanvas || !minigameContainer) return;
            if (minigameInterval) clearInterval(minigameInterval); // Clear previous interval if any

            minigameContainer.style.display = 'block'; // Show the game container
            minigameScore = 0;
            minigameScoreSpan.textContent = minigameScore;
            minigameCtx = minigameCanvas.getContext('2d');
            minigameCanvas.addEventListener('click', handleMinigameClick);

            drawMinigameShape(); // Initial draw
            minigameInterval = setInterval(changeMinigameColor, MINIGAME_INTERVAL_MS);
            console.log("Minigame started");
        }

        function stopMinigame() {
            if (minigameInterval) {
                clearInterval(minigameInterval);
                minigameInterval = null;
            }
             if (minigameCanvas) {
                minigameCanvas.removeEventListener('click', handleMinigameClick);
             }
             if (minigameContainer) {
                minigameContainer.style.display = 'none'; // Hide game container
             }
             // Optionally clear the canvas
             if(minigameCtx) {
                minigameCtx.clearRect(0, 0, minigameCanvas.width, minigameCanvas.height);
             }
            console.log("Minigame stopped. Final Score:", minigameScore);
        }


        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            stopMinigame(); // Make sure game stops when modal closes
            resetModalState();
        }
        function resetModalState() {
             // Hide content, show loading structure (but not the game yet)
             modalLoadingIndicator.classList.remove('active'); // Hide loading overlay initially
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             chatTopicTitle.textContent = ''; // Clear topic title in chat placeholder
             // Reset Fullscreen Image
             hideFullscreenImage();
             // Stop minigame just in case
             stopMinigame();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (Minor change: update topic title placeholder)
        function addChatMessage(message, sender) { /* ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay técnicas disponibles en el catálogo «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick to integrate minigame ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title;
            chatTopicTitle.textContent = title; // Update chat placeholder title
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');

            // Show loading overlay AND start the minigame
            modalLoadingIndicator.classList.add('active');
            startMinigame();

            try {
                // Fetch text while game is running
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // Stop game and hide loading AFTER text is fetched
                stopMinigame();
                modalLoadingIndicator.classList.remove('active');

                // Display content
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is visible
                console.log("Scroll set to 0 after content visible");

                // Image loading (placeholder appears, image loads in background)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-palette placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Generando visualización...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { console.log("Image loaded."); placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { console.error("Error loading image for:", title); placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { console.error("Could not create image URL for:", title); placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                // Stop game and hide loading on error too
                stopMinigame();
                modalLoadingIndicator.classList.remove('active');

                modalErrorMessage.textContent = error.message || "Error desconocido al cargar datos.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 titles ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más técnicas...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Function now expects ~40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más técnicas en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar técnicas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Update button text reflecting the number
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Técnicas (40)';
             }
         }

         // *** Search Filter Function (minor improvement: normalize accents) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameCanvas) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Faltan componentes de la interfaz.</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            minigameContainer.style.display = 'none'; // Ensure game is hidden initially
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>