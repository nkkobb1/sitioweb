<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creencias Tradicionales Chinas - Guía Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes con aire oriental/elegante -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Religión Tradicional China --- */
        :root {
            --color-primary: #c0392b; /* Rojo Chino Intenso */
            --color-secondary: #f1c40f; /* Dorado */
            --color-tertiary: #27ae60; /* Verde Jade */
            --color-background: #fdf6e3; /* Crema / Papel Arroz Claro */
            --color-text: #34495e; /* Gris Azulado Oscuro */
            --color-text-muted: #7f8c8d; /* Gris Medio */
            --color-modal-bg: #fffefb; /* Blanco Ligeramente Cálido */
            --color-border: #e0e0e0; /* Borde Gris Claro */
            --color-error-bg: #f5e9e9; /* Fondo error rojo muy claro */
            --color-error-text: #9a2a2a; /* Texto error rojo oscuro */
            --color-error-border: #e74c3c; /* Borde error rojo */

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 5px 10px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 20px rgba(52, 73, 94, 0.1), 0 3px 6px rgba(0, 0, 0, 0.06);
            --border-radius: 5px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Noto Serif SC', serif; font-weight: 700; } /* Fuente Serif para títulos */
        .logo { color: var(--color-primary); text-shadow: 1px 1px 3px rgba(0,0,0,0.1); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(255, 254, 251, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Poppins'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-secondary); box-shadow: 0 0 0 3px rgba(241, 196, 15, 0.3); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-secondary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Poppins'; font-size: 0.95rem; position: relative; overflow: hidden; }
        .title-item::before { /* Efecto hover sutil */ content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 3px; background-color: var(--color-primary); transition: width 0.3s ease; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: #d3d3d3; color: var(--color-primary); }
        .title-item:hover::before { width: 100%; }

        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), #e74c3c); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, #e74c3c, var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-text-muted); color: #f0f0f0; cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; text-shadow: none;}
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(52, 73, 94, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px; width: 95%; max-height: 90vh;
            min-height: 450px; /* Allow space for game visuals */
            overflow: hidden; position: relative; box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #eee; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #fff; transform: rotate(90deg); box-shadow: 0 0 8px var(--color-primary); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.4; }

        /* Area de Contenido Principal (Texto + Imagen + Chat) */
        #modal-story-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; }
        /* Scrollable Text Area */
        #modal-content-area { flex-grow: 1; min-height: 0; /* Crucial for flexbox scroll */ overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) #f0f0f0;
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: #f0f0f0; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid #e0e0e0; }
        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; } /* Jade color for emphasis */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Noto Serif SC', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid #eee; padding-bottom: 0.6em; font-weight: 700;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: #a0522d; } /* Sienna/Brown for H3 */
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(200, 200, 200, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-tertiary); } /* Jade Icon */

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 230px; /* Slightly less height */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fdfbf7; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) #f0f0f0; /* Gold scrollbar */
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: #f0f0f0; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.55; font-size: 0.95rem; }
        .user-message { background-color: var(--color-tertiary); color: #fff; margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #eee; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Poppins'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 2px rgba(241, 196, 15, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: #fff; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #a52a2a; } /* Darker Red */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator & Minigame Area */
        #modal-loading { text-align: center; padding: 1rem 0 0 0; /* Less top padding */ position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(253, 246, 227, 0.98); /* Semi-transparent cream */ display: none; /* Hidden initially */ flex-direction: column; align-items: center; justify-content: flex-start; /* Align top */ z-index: 55; border-radius: var(--border-radius); }
        #modal-loading.active { display: flex; } /* Show when loading */
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid rgba(192, 57, 43, 0.3); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 1rem auto 0.5rem auto; flex-shrink: 0;}
        #modal-loading p.loading-text { font-weight: 600; color: var(--color-primary); font-size: 1.2rem; font-family: 'Noto Serif SC'; margin-bottom: 1rem; flex-shrink: 0;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Minigame Styles */
        #minigame-container { width: 95%; height: 75%; /* Ocupa la mayor parte del espacio de carga */ background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%23f1c40f" fill-opacity="0.05" d="M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-48 50c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48-25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7z"/></svg>'), linear-gradient(to bottom, rgba(255, 255, 255, 0.1), rgba(253, 235, 208, 0.2)); border: 1px solid var(--color-secondary); border-radius: var(--border-radius); position: relative; overflow: hidden; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); flex-grow: 1; margin-bottom: 1rem;}
        .game-object { position: absolute; cursor: pointer; transition: transform 0.1s ease-out, opacity 0.2s ease; font-size: 1.8rem; /* Tamaño inicial */ text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .game-object.good:hover { transform: scale(1.2); }
        .game-object.bad { opacity: 0.8; filter: grayscale(80%); }
        .game-object.clicked { transform: scale(1.5); opacity: 0; } /* Feedback de click */
        #game-info { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; font-family: 'Poppins'; font-weight: 600; color: var(--color-primary); background-color: rgba(255, 254, 251, 0.7); padding: 5px 10px; border-radius: 3px; font-size: 0.9em; }
        #game-score, #game-level { }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Poppins'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(52, 73, 94, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-secondary); box-shadow: 0 0 25px rgba(241, 196, 15, 0.3); border-radius: 3px;}
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-modal-bg); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-yin-yang mr-3 text-red-700"></i> <!-- Icono Yin Yang -->
                     Creencias Chinas
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">~ Guía Interactiva de Sabiduría Ancestral ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explorando la Tradición Milenaria</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre las deidades, conceptos y prácticas de la rica y diversa religión popular china.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar deidad, concepto, práctica...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-torii-gate text-red-600 mr-2"></i> <!-- Icono Puerta Torii (similar a Paifang) -->
                 Índice de Conocimiento
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los archivos ancestrales...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">~ No se hallaron entradas para esa consulta ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar Más Sabiduría (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator & Minigame -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p class="loading-text">Canalizando conocimiento...</p>
                 <div id="minigame-container">
                     <div id="game-info">
                         <span id="game-score">Puntos: 0</span>
                         <span id="game-level">Nivel: 1</span>
                     </div>
                     <!-- Game objects will be added here by JS -->
                 </div>
             </div>

             <!-- Content Area Wrapper (Text + Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando oráculos...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Profundiza tu pregunta...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos y de referencia sobre las creencias populares chinas.</p>
              <p class="mt-1">La religión tradicional china es diversa y compleja; esta guía es una introducción.</p>
              <p class="mt-2">© 2025 Guía Interactiva de Creencias Chinas</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Conceptos Fundamentales
            "Qi (Energía Vital)", "Yin y Yang (Dualidad Cósmica)", "Wuxing (Cinco Elementos/Fases)", "Tian (Cielo / Principio Supremo)", "Mandato del Cielo (Tianming)", "Dao (El Camino / Principio Universal)", "Shen (Espíritus / Deidades Benignas)", "Gui (Fantasmas / Espíritus Malignos)", "Hun y Po (Almas Duales)", "Ming (Destino / Decreto Celestial)", "Yun (Suerte / Fortuna Personal)", "Bao Ying (Retribución Kármica)", "Feng Shui (Geomancia)", "Jing (Esencia Vital)", "Li (Ritual / Etiqueta Cósmica)", "Correlación Cósmica (Tian Ren He Yi)", "El Vacío (Wu / Wuji)", "Ziran (Naturalidad / Espontaneidad)", "Te (Virtud / Poder Interior)",
            // Deidades Principales y Arquetípicas
            "Yu Huang Dadi (Emperador de Jade)", "Xiwangmu (Reina Madre de Occidente)", "Guanyin (Bodhisattva de la Compasión)", "Zao Jun (Dios de la Cocina)", "Cai Shen (Dios de la Riqueza)", "Tu Di Gong (Dios Local de la Tierra)", "Cheng Huang (Dios de la Ciudad)", "Mazu (Diosa del Mar)", "Guan Yu (Dios de la Guerra y la Lealtad)", "Nezha (Deidad Protectora)", "Sun Wukong (Rey Mono - figura sincrética)", "Los Ocho Inmortales (Ba Xian)", "Lei Gong (Dios del Trueno)", "Dian Mu (Diosa del Relámpago)", "Chang'e (Diosa de la Luna)", "Hou Yi (Arquero Divino)", "Menshen (Dioses Guardianes de la Puerta)", "Yan Wang (Rey del Infierno/Inframundo)", "Zhong Kui (Exorcista de Demonios)", "Nüwa (Diosa Creadora)", "Pangu (Creador del Universo)", "Fuxi (Héroe Cultural)", "Shennong (Emperador Divino Agricultor)", "Huangdi (Emperador Amarillo)", "Long Wang (Rey Dragón)", "Heibai Wuchang (Guardianes del Inframundo)", "Yue Lao (Dios del Matrimonio)", "Wen Chang Di Jun (Dios de la Literatura y Exámenes)",
            // Prácticas y Rituales
            "Veneración de Ancestros (Zu Xian Chong Bai)", "Ofrendas (Comida, Incienso, Papel Moneda)", "Quema de Incienso (Shang Xiang)", "Quema de Papel Moneda (Shao Zhi Qian)", "Adivinación con Bloques Jiaobei", "Adivinación con Palillos Kau Cim", "Lectura de la Fisonomía (Mian Xiang)", "Interpretación de Sueños (Jie Meng)", "Uso de Talismanes y Amuletos (Fu Lu)", "Exorcismo y Pacificación de Espíritus", "Visitas a Templos (Bai Bai)", "Médiums Espirituales (Ji Tong / Dang Ki)", "Oraciones y Peticiones", "Festivales Anuales (Ciclo Lunar)", "Rituales de Purificación", "Prácticas Funerarias Tradicionales", "Matrimonio Tradicional (Ritos y Creencias)", "Rituales de Nacimiento y Primer Mes", "Danzas del León y del Dragón", "Ópera China (Contexto Religioso)", "Peticiones en Árboles de los Deseos", "Liberación de Animales (Fang Sheng)", "Consultas de Feng Shui", "Prácticas Dietéticas Religiosas (Vegetarianismo Ocasional)", "Peregrinaciones a Montañas Sagradas",
            // Festivales Importantes
            "Año Nuevo Lunar (Chun Jie)", "Festival de los Faroles (Yuan Xiao Jie)", "Festival Qingming (Día de Limpieza de Tumbas)", "Festival del Bote del Dragón (Duan Wu Jie)", "Festival Qixi (Día de los Enamorados Chinos)", "Festival de los Fantasmas (Zhong Yuan Jie)", "Festival del Medio Otoño (Zhong Qiu Jie)", "Festival del Solsticio de Invierno (Dong Zhi)", "Cumpleaños del Emperador de Jade", "Cumpleaños de Mazu", "Cumpleaños de Guanyin",
            // Símbolos y Objetos
            "Dragón Chino (Long)", "Fénix Chino (Fenghuang)", "Tortuga Negra (Xuanwu)", "Qilin (Criatura Auspiciosa)", "Tigre Blanco (Baihu)", "Bagua (Ocho Trigramas)", "Taijitu (Símbolo Yin-Yang)", "Nudo Místico (Pan Chang)", "Monedas de la Suerte (Qian)", "Melocotón de la Inmortalidad (Shou Tao)", "Carácter Fu (福 - Fortuna)", "Carácter Shou (壽 - Longevidad)", "Carácter Xi (囍 - Doble Felicidad)", "Lingotes Sycee (Yuanbao)", "Espejos Bagua", "Calabaza Wu Lou", "Estatuillas de Deidades", "Tablillas Ancestrales (Pai Wei)", "Farolillos Rojos (Deng Long)", "Petardos y Fuegos Artificiales", "Color Rojo (Simbolismo)", "Color Dorado/Amarillo (Simbolismo)", "Jade (Simbolismo)", "Bambú (Simbolismo)", "Flor de Loto (Simbolismo)",
            // Lugares y Estructuras
            "Templos Populares (Miao)", "Salones Ancestrales (Ci Tang)", "Altares Domésticos", "Montañas Sagradas (Wuyue, etc.)", "Cuevas y Grutas Sagradas", "Árboles Sagrados", "Tumbas y Cementerios (Feng Shui)", "Templos del Dios de la Ciudad (Chenghuang Miao)", "Templos de Mazu (Tianhou Gong)", "Puertas Paifang",
            // Relación con Otras Tradiciones
            "Sincretismo Religioso Chino", "Influencia del Taoísmo en las Creencias Populares", "Influencia del Budismo en las Creencias Populares", "Influencia del Confucianismo en la Ética Popular", "Chamanismo Chino (Wu)", "Nuevos Movimientos Religiosos (Contexto)", "Religión Popular vs. Religión Organizada", "Filosofía vs. Religión en China",
             // Aspectos Sociales y Culturales
            "Religión y Familia", "Religión y Comunidad", "Ética y Moralidad Popular", "Creencias sobre la Salud y la Enfermedad", "Creencias sobre la Muerte y el Más Allá", "Impacto en el Arte y la Literatura", "Supersticiones Comunes", "Tabúes Culturales", "La Religión Popular en la Diáspora China", "Modernización y Secularización", "Preservación de Tradiciones", "Religión Popular y Gobierno",
            // Añadir más títulos específicos si es necesario
            "El concepto de 'Ling' (Eficacia Espiritual)", "Tipos de Fantasmas y Espíritus (Gui)", "Jerarquía Celestial en la Religión Popular", "Prácticas adivinatorias del I Ching (Yijing)", "El Altar del Dios de la Cocina", "Rituales específicos del Año Nuevo", "Significado de los animales del zodiaco chino", "Leyendas de los Ocho Inmortales", "Historias sobre Guan Yu", "El Viaje al Oeste (Contexto religioso popular)", "Magia popular y hechicería (Fashi)", "Amuletos protectores para bebés", "El papel de las mujeres en la religión popular", "Templos dedicados a dioses locales específicos", "Creencias sobre la posesión espiritual", "El inframundo chino (Diyu)", "Reencarnación en la creencia popular", "El concepto de 'Cara' (Mianzi) y la religión", "Música ritual en templos", "Arquitectura de templos populares", "Ofrendas de 'comida espiritual'", "Protección contra la mala suerte", "Adivinos callejeros", "Festivales regionales específicos", "El culto a los héroes locales deificados", "Sanadores tradicionales y religión", "Interpretación de presagios (Zhao Tou)", "El uso de sellos religiosos (Yin)"
        ];
        const chineseFolkThemes = [
            "deidades chinas", "conceptos filosóficos chinos", "prácticas religiosas chinas", "festivales chinos", "mitología china", "símbolos chinos auspiciosos", "Feng Shui", "veneración de ancestros", "espíritus y fantasmas chinos", "templos chinos", "sincretismo religioso chino", "Taoísmo popular", "Budismo popular chino", "I Ching", "medicina tradicional y religión", "vida después de la muerte china", "dioses de la riqueza chinos", "diosas chinas", "héroes deificados chinos", "magia popular china"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un erudito sinólogo, experto en religiones comparadas y antropología cultural, especializado en la religión tradicional/popular china (民间信仰). Describe el concepto, deidad, práctica o símbolo indicado de manera profunda, clara y respetuosa. Explica su origen (si se conoce), significado, variantes regionales (si aplica), iconografía asociada, rituales relacionados, y su relevancia cultural/social dentro del complejo entramado de creencias chinas, incluyendo su relación sincrética con el Taoísmo, Budismo y Confucianismo. Proporciona un análisis detallado de aproximadamente 1200-1300 palabras. Basa tu descripción únicamente en el siguiente elemento de la creencia popular china:",
            timeoutSeconds: 180 // Aumentado ligeramente por posible complejidad
        };
        const chatApiConfig = {
            model: "mistral-tiny",
             systemPrompt: "Actúa como un asistente IA versado exclusivamente en el tema de religión popular china que se está discutiendo actualmente. Responde preguntas de seguimiento sobre [TEMA_ACTUAL], basándote en la información principal proporcionada. Sé preciso, respetuoso y conciso.",
            timeoutSeconds: 50
        };
        const titleGenerationConfig = {
            model: "mistral",
             // **Prompt para generar 40 títulos**
             systemPrompt: "Actúa como un generador de ideas experto en religión popular china. Genera exactamente 40 nombres distintos y específicos de deidades menores, conceptos sutiles, prácticas regionales, símbolos menos comunes o figuras mitológicas relevantes para las creencias populares chinas. Evita los más obvios si es posible. Devuelve *solo* la lista, uno por línea, sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Más tiempo para generar 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameContainer = document.getElementById('minigame-container');
        const gameScoreDisplay = document.getElementById('game-score');
        const gameLevelDisplay = document.getElementById('game-level');

        // ========== State Variables ==========
        let currentTopicTitle = null;
        // Minigame State
        let gameActive = false;
        let gameScore = 0;
        let gameLevel = 1;
        let gameObjects = [];
        let lastSpawnTime = 0;
        let spawnInterval = 1500; // Initial interval ms
        let objectSpeed = 1; // Initial speed pixels per frame
        let gameLoopId = null;
        const goodObjects = ['🍊', '🍑', '💰', '🧧', '🏮', '🥮', '🪙', '👑']; // Emojis: Orange, Peach, Money Bag, Red Envelope, Lantern, Mooncake, Coin, Sycee(Crown)
        const badObjects = ['碎', '💀', '👻']; // Broken character, Skull, Ghost

        // ========== MINIGAME FUNCTIONS ==========
        function startGame() {
            if (gameActive) return;
            console.log("Starting Minigame...");
            gameActive = true;
            gameScore = 0;
            gameLevel = 1;
            spawnInterval = 1500;
            objectSpeed = 1.5; // Start a bit faster
            gameObjects = [];
            lastSpawnTime = Date.now();
            minigameContainer.innerHTML = `
                <div id="game-info">
                     <span id="game-score">Puntos: 0</span>
                     <span id="game-level">Nivel: 1</span>
                 </div>`; // Reset container
            updateGameInfo();
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function stopGame() {
            if (!gameActive) return;
            console.log("Stopping Minigame...");
            gameActive = false;
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
                gameLoopId = null;
            }
            // Clear remaining objects
            gameObjects.forEach(obj => obj.element.remove());
            gameObjects = [];
            minigameContainer.innerHTML = ''; // Clear the container
        }

        function updateGameInfo() {
            const scoreEl = minigameContainer.querySelector('#game-score');
            const levelEl = minigameContainer.querySelector('#game-level');
            if (scoreEl) scoreEl.textContent = `Puntos: ${gameScore}`;
            if (levelEl) levelEl.textContent = `Nivel: ${gameLevel}`;
        }

        function createGameObject() {
            const element = document.createElement('div');
            element.classList.add('game-object');
            const isGood = Math.random() > 0.2; // 80% chance of good object
            let emoji;
            if (isGood) {
                emoji = getRandomElement(goodObjects);
                element.classList.add('good');
                element.onclick = (event) => handleObjectClick(event, gameObject, true);
            } else {
                emoji = getRandomElement(badObjects);
                element.classList.add('bad');
                element.onclick = (event) => handleObjectClick(event, gameObject, false);
            }
            element.textContent = emoji;
            element.style.left = `${Math.random() * (minigameContainer.offsetWidth - 30)}px`; // 30px approx width
            element.style.top = `-40px`; // Start above screen
            element.style.fontSize = `${1.5 + Math.random() * 0.8}rem`; // Vary size slightly

            minigameContainer.appendChild(element);

            const gameObject = {
                element: element,
                y: -40,
                speed: objectSpeed + (Math.random() * 0.5 - 0.25), // Slight speed variation
                isGood: isGood,
                removed: false
            };
            gameObjects.push(gameObject);
        }

        function handleObjectClick(event, obj, isGood) {
            if (!gameActive || obj.removed) return;
            event.stopPropagation(); // Prevent clicks passing through

            obj.removed = true; // Mark for removal
            obj.element.classList.add('clicked'); // Visual feedback

            if (isGood) {
                gameScore += 10 * gameLevel; // More points for higher levels
            } else {
                gameScore -= 5 * gameLevel; // Penalty
                if (gameScore < 0) gameScore = 0;
            }
            updateGameInfo();

            // Remove element after animation (short delay)
            setTimeout(() => {
                if (obj.element && obj.element.parentNode) {
                     obj.element.remove();
                }
            }, 200); // Matches opacity transition
        }

        function updateLevel() {
             // Increase level every 150 points (adjust as needed)
            const nextLevelThreshold = gameLevel * 150;
            if (gameScore >= nextLevelThreshold) {
                gameLevel++;
                // Increase difficulty
                spawnInterval = Math.max(500, spawnInterval * 0.9); // Faster spawns, min 0.5s
                objectSpeed += 0.2; // Faster objects
                console.log(`Level Up! Level: ${gameLevel}, Speed: ${objectSpeed.toFixed(1)}, Spawn: ${spawnInterval.toFixed(0)}ms`);
                updateGameInfo();
                 // Maybe add a visual flash or sound effect here later
            }
        }

        function gameLoop(timestamp) {
            if (!gameActive) return;

            const now = Date.now();
            const delta = (timestamp - (gameLoopId ? lastTimestamp : timestamp)) / 16.67; // Frame delta compensation (approx)
            lastTimestamp = timestamp;

            // Spawn new objects based on interval
            if (now - lastSpawnTime > spawnInterval) {
                createGameObject();
                lastSpawnTime = now;
            }

            // Update existing objects
            const containerHeight = minigameContainer.offsetHeight;
            gameObjects = gameObjects.filter(obj => {
                if (obj.removed) return false; // Already clicked and fading

                obj.y += obj.speed * delta; // Move based on delta time
                obj.element.style.top = `${obj.y}px`;

                // Remove if off-screen
                if (obj.y > containerHeight) {
                    obj.element.remove();
                    // Optional penalty for missing good items?
                    // if (obj.isGood) gameScore -= 1;
                    return false; // Remove from array
                }
                return true; // Keep in array
            });

            updateLevel(); // Check for level up

            gameLoopId = requestAnimationFrame(gameLoop);
        }
        let lastTimestamp = 0; // For delta time calculation in gameLoop

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                  ? config.systemPrompt.replace("[TEMA_ACTUAL]", `'${currentTopicTitle}'`) // Inject current topic
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico. Intenta en unos segundos.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la IA llegó vacía. Intenta reformular.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 throw new Error(error.message || "Error inesperado al contactar la IA.");
             }
         }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Error interno: No se estableció el contexto."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        // *** MODIFIED: fetchGeneratedTitles to request and handle 40 ***
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(chineseFolkThemes) || "creencias populares chinas generales";
             const specificPrompt = `Genera 40 ítems distintos (deidades, conceptos, prácticas) sobre ${randomTheme}`;
             console.log("Generating 40 titles with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) }; // Add seed here if desired
             return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 20) throw new Error("La IA no generó suficientes ideas (se esperaban 40)."); // Expect at least half
                     console.log(`Generated ${titles.length} titles.`);
                     return titles.slice(0, 40); // Return up to 40
                 });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Chinese folk religion symbolism";
             // Enhanced prompt for conceptual/symbolic art
             const enhancedPrompt = `Symbolic and artistic representation inspired by '${safePromptText}' from Chinese folk religion. Focus on atmosphere, key symbols (like dragons, phoenix, specific deities abstractly, yin yang, elements), traditional Chinese art style (ink wash, silk painting feel). Avoid text, labels, diagrams, maps, flags. Evocative, respectful.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, graphs, charts, diagrams, map, flag, photograph, realistic human faces, multiple panels, UI elements, watermark, signature, blurry, low quality";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */ if(!rawText)return'';let formatted=rawText.trim();formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1');formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('−','-');return`${base}<sup>${cleanExponent}</sup>`;});formatted=formatted.replace(/\\rightarrow/g,'&rarr;');formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>');const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0);formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block;let content=block.replace(/\n/g,' ');return`<p>${content}</p>`;}).join('');return formatted; }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
             stopGame(); // Ensure game stops when modal closes
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.classList.remove('active'); // Hide loading/game area
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
             stopGame(); // Double ensure game is stopped
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden'; }
        function hideFullscreenImage() { /* ... */ if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src=''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... */ const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Error IA: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}}

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'zh-Hans-CN')); // Sort respecting Chinese characters
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">~ No hay entradas en los archivos ~</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Appended ${addedCount} new titles.`);
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to integrate Minigame Start/Stop ***
        async function handleTitleClick(title) {
            resetModalState(); // Reset general state, including chat context & stops game
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');

            // *** START LOADING & MINIGAME ***
            modalLoadingIndicator.classList.add('active'); // Show the loading area
            startGame(); // Start the minigame

            try {
                console.time(`fetch_explain_${title}`);
                const rawExplanationText = await fetchExplanationText(title);
                 console.timeEnd(`fetch_explain_${title}`);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // *** STOP MINIGAME, HIDE LOADING (on success) ***
                 stopGame();
                 modalLoadingIndicator.classList.remove('active');

                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-dragon placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Generando Imagen Ritual...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                 // *** STOP MINIGAME, HIDE LOADING (on error) ***
                 stopGame();
                 modalLoadingIndicator.classList.remove('active');

                modalErrorMessage.textContent = error.message || "Error desconocido al cargar datos.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando Oráculos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudo revelar más sabiduría en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al consultar oráculos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Revelar Más Sabiduría (40)';
             }
         }

         // *** Search Filter Function (added Chinese normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 // Normalize title text as well for comparison
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 // Simple check for Roman characters or full Chinese match
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check essential elements including game container
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameContainer) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #c0392b; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: Noto Serif SC;">系統錯誤：缺少頁面組件。</p>'; // System Error in Chinese
                return;
             }
            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
             console.log("Chinese Folk Religion App Initialized.");
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>