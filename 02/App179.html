<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utopías Fallidas - Archivos Desclasificados</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias con un toque sutil -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Source+Serif+Pro:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Utopías Fallidas --- */
        :root {
            --color-primary: #a7f3d0; /* Verde menta pálido (fachada utópica) */
            --color-secondary: #fecaca; /* Rojo muy pálido (toque de alerta) */
            --color-tertiary: #6b7280; /* Gris neutro (control sutil) */
            --color-background: #f9fafb; /* Blanco Hueso / Gris muy claro */
            --color-text: #1f2937; /* Gris muy oscuro (legibilidad) */
            --color-text-muted: #6b7280;
            --color-modal-bg: #ffffff; /* Blanco puro (modal) */
            --color-border: #e5e7eb; /* Borde gris claro (separación limpia) */
            --color-dark-accent: #831843; /* Magenta oscuro (secreto, peligro) */
            --color-dark-bg: #111827; /* Fondo oscuro para contraste */
            --color-error-bg: #fef2f2; /* Fondo error rojo pálido */
            --color-error-text: #991b1b; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo pálido */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-inner-dark: inset 0 2px 4px 0 rgba(131, 24, 67, 0.3); /* Sombra interior oscura */
            --border-radius: 4px; /* Bordes suaves pero definidos */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Source Serif Pro', serif; font-weight: 600; } /* Serif para títulos, toque clásico/distópico */
        .logo { color: var(--color-text); }
        .logo .fa-eye { color: var(--color-dark-accent); } /* Ojo vigilante */
        h1.page-title { color: var(--color-text); font-weight: 600; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 600;}
        #modal-title { color: var(--color-dark-accent); font-weight: 600; text-shadow: 1px 1px 3px rgba(0,0,0,0.1); }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Poppins'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-dark-accent); box-shadow: 0 0 0 3px rgba(131, 24, 67, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-dark-accent); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Poppins'; font-size: 0.95rem; position: relative; overflow: hidden; }
        .title-item::after { /* Elemento sutil de "fallo" */ content: ''; position: absolute; bottom: -5px; left: 0; width: 0; height: 3px; background-color: var(--color-dark-accent); transition: width 0.3s ease; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-tertiary); color: var(--color-dark-accent); }
        .title-item:hover::after { width: 100%; }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-tertiary); color: var(--color-modal-bg); padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #4b5563; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: #d1d5db; color: var(--color-text-muted); cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: var(--color-modal-bg); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(249, 250, 251, 0.9); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-top: 5px solid var(--color-dark-accent); /* Borde superior oscuro */
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Asegura espacio para chat y contenido */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #f3f4f6; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-dark-accent); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-dark-accent); font-weight: 600; } /* Secreto resaltado */
        #modal-content em { color: #059669; font-style: italic; } /* Verde esmeralda para la fachada */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Source Serif Pro', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 600; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; font-weight: 400;}
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: 0 0 15px rgba(131, 24, 67, 0.3); } /* Sombra oscura al pasar */
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid var(--color-border); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-tertiary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; } /* Icono neutral */

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: var(--color-text); margin-left: auto; text-align: left; font-weight: 400;} /* Verde para usuario (parte de la fachada?) */
        .ai-message { background-color: #e5e7eb; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; } /* Gris claro para IA */
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #ffffff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Poppins'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-dark-accent); box-shadow: var(--shadow-inner-dark);}
        #chat-send-btn { padding: 0.7rem 1rem; background-color: var(--color-tertiary); color: var(--color-modal-bg); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #4b5563; }
        #chat-send-btn:disabled { background-color: #d1d5db; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid var(--color-border); border-top-color: var(--color-tertiary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.3rem; font-family: 'Poppins'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Poppins'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-text); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-dark-accent); color: var(--color-modal-bg); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-eye mr-3"></i> <!-- Icono ojo vigilante -->
                     Utopías Fallidas
                 </h1>
             </div>
             <span class="text-sm text-gray-500 font-sans tracking-wider">~ Archivos Desclasificados ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Detrás del Velo de Perfección</h1>
             <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto font-light">Explora comunidades idílicas que prometieron el paraíso y entregaron... otra cosa. Descubre la verdad oculta en los cimientos de la sociedad perfecta.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar comunidad o concepto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-archive text-gray-500 mr-2"></i> <!-- Icono archivo -->
                 Índice de Expedientes
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Accediendo a registros sellados...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">~ Ningún expediente coincide con los criterios de búsqueda ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Desclasificar Más Archivos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Analizando expediente...</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image placeholder/image added here by JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Consulta sobre este expediente...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-500 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Análisis generados por IA con fines especulativos y exploratorios sobre conceptos de utopías y distopías.</p>
              <p class="mt-1">Las comunidades descritas son ficticias y sirven como estudio de arquetipos sociales.</p>
              <p class="mt-2">© 2025 Archivos de Utopías Fallidas</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        // *** EXHAUSTIVE TITLE LIST *** (Aiming for high quantity and variety)
        const predefinedTitles = [
            // Nombres de Comunidades/Lugares
            "Aethelgard: La Ciudad Jardín Amurallada", "Serenitas Prime: El Enclave de la Calma Forzada", "Elysium VII: La Colonia Orbital Perfecta", "Harmonia Mundi: La Sociedad Sinfónica", "Civitas Concordiae: Donde Disentir es Traición", "Nexus Óptima: La Metrópolis Eficiente", "Veridia: El Eco-Paraíso Controlado", "Solara Collective: La Comuna del Sol Eterno (y Vigilancia)", "Aqua Pura: La Ciudad Submarina Inmaculada", "Argentum: La Sociedad Sin Dinero (ni Libertad)", "Noosfera Unificada: Conciencia Colectiva Obligatoria", "Sanctum Tempus: La Comunidad que Detuvo el Tiempo", "Crisálida Urbana: Metamorfosis Social Impuesta", "El Bastión Silente: Donde el Ruido es Castigado", "TheraGen: La Sociedad Genéticamente Perfecta", "Arcadia Artificial: Simulación Idílica Permanente", "La Cúpula Esmeralda: Belleza que Ahoga", "Equilibria: La Ciudad de la Emoción Cero", "Domus Aurea: Riqueza y Decadencia Oculta", "Mnemosyne: La Comunidad Sin Pasado (Borrado)", "Unitas: El Precio de la Unidad Absoluta", "Purity Falls: La Fachada de la Inocencia", "El Crisol Génesis: Rediseño Humano Obligatorio", "Oasis Cero: Supervivencia a Costa de la Humanidad", "Aethelburg: La Fortaleza de la Tradición Inmutable", "Celestia Nova: La Utopía Espiritual Jerárquica", "Civitas Machina: La Ciudad Regida por IA", "Dynamis: La Sociedad de la Energía Ilimitada (y Peligrosa)", "Flos Vitae: El Culto a la Juventud Eterna (y Oscura)", "Gea Primus: Retorno Forzado a la Naturaleza Primitiva", "Heliopolis Redux: Adoración Solar y Sacrificio", "Insula Felix: La Isla Feliz (Aislada y Controlada)", "Jovian Collective: Mente Colmena en las Nubes de Júpiter", "Kallipolis 2.0: La República Filosófica (Tiránica)", "Lumen: La Ciudad de la Luz Eterna (Sin Sombras, Sin Secretos)", "Meritopia: Donde el Mérito Justifica la Crueldad", "Nirvana Cibernético: Escape Digital Obligatorio", "Olympus Ascendant: Transhumanismo y Jerarquía Divina", "Panacea: La Cura Universal (con Efectos Secundarios Letales)", "Quiescence: El Reposo Final Obligatorio", "Regnum Justum: El Reino Justo (Según Quién)", "Soma Estates: Felicidad Química Mandatoria", "Telos: La Sociedad Orientada a un Único Fin", "Urbs Aeterna: La Ciudad Eterna (Estancada)", "Valhalla Genetica: Guerreros Perfectos, Vidas Vacías", "Xanadu Interna: Paraíso Mental Inducido", "Yggdrasil Biome: El Árbol del Mundo Artificial", "Zephyr Community: Vida Ligera, Control Pesado", "Amanuensis: La Sociedad de los Escribas (Control de Información)", "Bibliotheca Infinita: Conocimiento Total, Pensamiento Nulo", "Circadia: El Ciclo Perfecto, la Vida Monótona", "Datalink: Conexión Total, Privacidad Cero", "Echo Chamber: La Burbuja de Confirmación Social", "Fata Morgana: El Espejismo del Progreso", "Globus Unus: Gobierno Mundial, Opresión Local", "Horologium: Precisión Absoluta, Espontaneidad Prohibida", "Ignis Fatuus: La Luz que Engaña", "Judicium: Justicia Predictiva, Libertad Condicionada",

            // Mecanismos de Control / Secretos Oscuros
            "La Supresión Emocional Farmacológica", "Ingeniería Genética para la Docilidad", "Vigilancia Biométrica Total e Inevitable", "Control Mental Colectivo a través de Redes Neuronales", "Condicionamiento Psicológico desde la Infancia", "Sistema de Crédito Social Omnipresente", "Eutanasia Obligatoria por 'Baja Utilidad Social'", "La Purga Silenciosa de los Disidentes", "El Culto Obligatorio al Líder o Principio Fundador", "Control Reproductivo Estatal Estricto", "Modificación de Recuerdos Colectivos", "La Cosecha Oculta: ¿De dónde vienen los recursos?", "El Destierro de los 'Imperfectos' a Zonas Ocultas", "Lobotomía Química para la Conformidad", "La Ilusión de Elección en una Democracia Dirigida", "Propaganda Subliminal Constante", "El Miedo como Herramienta de Cohesión Social", "Supresión Sistemática de la Historia Real", "El Uso de Androides/Clones para Tareas Indeseables", "La Verdad sobre la Longevidad Artificial", "Sacrificios Rituales Ocultos por la 'Armonía'", "Experimentos Sociales Secretos con la Población", "El Pacto Oscuro con una Entidad Externa", "Control Climático Usado para la Coerción", "La Dependencia Tecnológica como Prisión Invisible", "Borrado de la Identidad Individual", "Felicidad Sintética Obligatoria", "La Red de Información y sus Guardianes Secretos", "El Precio Oculto de la Energía 'Limpia'", "La Verdad sobre los Fundadores Originales", "Canibalismo Ritual o de Supervivencia Oculto", "La Explotación de una Subclase Invisible", "El Secreto de la 'Renovación' Periódica de la Población", "Control de los Sueños y el Subconsciente", "La Enfermedad Selectiva como Herramienta de Purga", "Adicción Forzada a Sustancias Pacificadoras", "La Simulación dentro de la Simulación", "El Muro Invisible: Barreras Psicológicas y Sociales", "La Paradoja de la Tolerancia Cero", "El Engaño de la 'Segunda Oportunidad'", "La Comercialización de la Virtud", "El Monopolio de la Realidad", "La Policía del Pensamiento", "El Lenguaje Controlado: Neolengua Utópica", "La Estética Obligatoria", "El Destino de los Ancianos", "La Verdad sobre la 'Naturaleza' Preservada", "La Gestión de Desastres como Control", "El Secreto de los Alimentos Sintéticos", "La Clonación como Reemplazo Silencioso", "El Mercado Negro de Emociones Prohibidas", "La Falsa Historia de Origen", "El Protocolo de Contención de Anomalías", "La Deuda Social Impagable", "El Ministerio de la Armonía (y la Represión)", "La Lotería de la Vida (y la Muerte)", "El Síndrome del Paraíso Perdido (Melancolía Colectiva)", "La Terapia de Reasignación de Roles",

            // Tipos de Sociedades / Conceptos
            "La Tecnocracia Benevolente (con Agenda Oculta)", "El Eco-Fascismo Camuflado de Verde", "La Teocracia Iluminada (y Dogmática)", "Comunismo Genético Forzado", "Anarquía Controlada por IA", "La Corporatocracia Disfrazada de Utopía Laboral", "La Gerontocracia Secreta", "El matriarcado/patriarcado Opresor 'Perfecto'", "La Sociedad Hedonista y Vacía", "El Estado Terapéutico Totalitario", "La Meritocracia Extrema y Deshumanizante", "El Colectivismo Radical (Anulación del Yo)", "La Utopía Transhumanista Fallida", "El Culto Cargo Científico", "La Sociedad Post-Escasez (con Aburrimiento Mortal)", "El Paraíso Lúdico Obligatorio", "La Fortaleza Aislacionista Perfecta", "La Dictadura de la Felicidad", "El Orden Natural Impuesto Artificialmente", "La Utopía Agraria y su Lado Oscuro", "La Sociedad Nómada Controlada", "El Enjambre Humano: Mente Colmena", "La Ciudad-Estado Artística (y Decadente)", "El Mundo Virtual como Utopía y Prisión", "La Sociedad de Castas Genéticas 'Armoniosas'", "El Gobierno de los Filósofos (Corruptos)", "La Utopía de la Seguridad Absoluta (y Asfixiante)", "El Experimento Social a Largo Plazo", "La Reconstrucción Post-Apocalíptica (con Secretos)", "La Colonia Espacial Idílica (y Frágil)", "La Sociedad Subterránea Autosuficiente (y Claustrofóbica)", "El Archipiélago de Micro-Utopías (En Guerra Fría)", "La Utopía Temporal (Ciclos de Colapso y Reconstrucción)", "El Legado Tóxico de los Fundadores", "La Paradoja de la Libertad Controlada", "El Dilema de la Intervención Externa", "La Resistencia Interna: Grietas en la Perfección", "El Despertar de la Conciencia Individual", "La Fuga Imposible", "El Mito Fundacional Roto", "La Memoria Prohibida", "El Coste Humano de la Perfección", "¿Puede Existir la Utopía sin Distopía?", "La Seducción del Orden Perfecto", "El Miedo a la Imperfección", "La Utopía como Máscara", "El Fracaso Inevitable del Control Total", "La Belleza como Forma de Opresión", "La Búsqueda de Significado en un Mundo Perfecto", "El Síndrome del Impostor Colectivo", "La Nostalgia por un Pasado Imperfecto", "El Jardín Amurallado y lo Salvaje Exterior", "La Utopía Infantilizada", "El Panóptico Social Perfecto",

             // Títulos más abstractos / temáticos
            "El Precio de la Armonía Eterna", "Cuando la Perfección se Vuelve Prisión", "La Sonrisa Obligatoria", "Bajo la Superficie Serena", "El Jardín de las Mentiras Florecientes", "Secretos Tejidos en la Tela Social", "La Arquitectura del Control Mental", "Donde Mueren los Sueños Individuales", "El Eco de la Disidencia Silenciada", "La Utopía Devoradora de Almas", "Grilletes Invisibles de Felicidad", "La Sombra que Proyecta la Luz Perfecta", "El Engranaje Roto en la Máquina Perfecta", "Más Allá del Horizonte Dorado", "La Enfermedad de la Conformidad", "El Laberinto de la Buena Intención", "Cuando los Ángeles Tienen Agendas Ocultas", "El Costo Oculto de Erradicar el Sufrimiento", "La Falsa Promesa del Mañana Perfecto", "El Despertar Amargo en el Paraíso", "La Tiranía de la Mayoría (o Minoría) Iluminada", "El Espejismo en el Desierto de lo Real", "Vendiendo el Alma por Seguridad", "La Jaula Dorada de la Existencia", "El Culto a la Normalidad", "Donde la Ignorancia es la Suprema Felicidad (Forzada)", "La Erosión Silenciosa del Espíritu Humano", "El Legado Envenenado de los Visionarios", "La Danza Macabra de la Obediencia", "El Último Refugio (o la Última Trampa)",
             // ... (Potential for even more variations by combining elements)
        ];
        const failedUtopiaThemes = [
            "comunidades utópicas ficticias", "sociedades con control mental", "distopías disfrazadas", "vigilancia totalitaria", "ingeniería social fallida", "cultos utópicos", "pérdida de individualidad", "secretos oscuros de sociedades perfectas", "control genético y social", "utopías tecnológicas fallidas", "el precio de la perfección", "rebelión en la utopía", "democracias simuladas", "control emocional farmacológico", "sociedades post-escasez con problemas", "utopías aislacionistas", "la fachada de la felicidad", "arquitectura opresiva", "gobiernos mundiales distópicos", "colonias espaciales fallidas", "utopías ecológicas totalitarias", "la memoria colectiva manipulada", "sistemas de crédito social", "eugenesia y utopía"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un sociólogo crítico y un historiador especializado en el estudio comparativo de sociedades utópicas y sus fracasos inherentes. Analiza la comunidad, concepto o mecanismo de control social 'fallido' que se te indica. Describe meticulosamente su fachada 'perfecta' (objetivos declarados, estética, organización superficial) y luego revela metódicamente los secretos oscuros, las estructuras de poder ocultas, los mecanismos de control (psicológicos, tecnológicos, sociales), el coste humano (pérdida de libertad, individualidad, emoción), y las contradicciones internas que la convierten en una utopía fallida o una distopía encubierta. Incluye posibles orígenes, el destino probable o los signos de decadencia/resistencia. Tu análisis debe ser profundo, crítico y detallado, de aproximadamente 1200-1300 palabras, basado únicamente en el expediente proporcionado:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúa como un investigador asistente especializado únicamente en el expediente de la utopía fallida actualmente bajo revisión. Responde preguntas específicas sobre sus mecanismos de control, la vida diaria de sus ciudadanos (la fachada vs. la realidad), los secretos descubiertos, las posibles resistencias o el destino final, basándote estrictamente en la información del expediente principal. Sé preciso y céntrate en los detalles ocultos.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un archivista generando nombres clave para expedientes sobre utopías fallidas. Genera exactamente 15 nombres evocadores o conceptos para comunidades/sociedades ficticias que aparentan perfección pero ocultan secretos oscuros, control social o fallos fundamentales. Busca variedad: nombres de lugares, mecanismos de control, dilemas sociales, etc. Devuelve *solo* la lista de nombres/conceptos, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Same IDs as before, ensure they match HTML)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentUtopiaTitle = null; // Context for chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             // Dynamic System Prompt for Chat
             const systemPromptToUse = isChat && currentUtopiaTitle
                 ? `Eres un investigador asistente especializado únicamente en el expediente de la utopía fallida llamada '${currentUtopiaTitle}'. Responde preguntas de seguimiento sobre sus mecanismos de control, vida ciudadana (fachada vs. realidad), secretos, resistencias o destino, basándote estrictamente en la información del expediente principal. Sé preciso y céntrate en los detalles ocultos.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                      // Friendly Error Message
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, la conexión falló. Por favor, intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o selecciona otro expediente.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s) y fue cancelada. Revisa tu conexión o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar los archivos centrales.");
             }
        }
        // Wrappers for clarity
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentUtopiaTitle) throw new Error("Error interno: No se ha seleccionado un expediente para consulta.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(failedUtopiaThemes) || "utopías fallidas en general";
            const specificPrompt = `Genera 15 nombres clave o conceptos para expedientes sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no pudo generar suficientes nombres clave nuevos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "failed utopia concept art";
             // Prompt focusing on duality
             const enhancedPrompt = `Conceptual artwork representing the failed utopia '${safePromptText}'. Show the contrast between a perfect, clean, serene facade and unsettling, dark, oppressive, or decaying undertones. Visual metaphors for control, surveillance, or hidden secrets. Avoid text, labels. Atmospheric, slightly surreal or unsettling.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, photorealistic, simple landscape, purely positive scene, happy people";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (No changes needed)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (No changes needed in core logic)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0; console.log("Scroll set to 0 on hideModal"); resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex'; modalStoryContentArea.classList.add('content-hidden'); modalError.classList.add('content-hidden'); modalTitle.textContent = ''; modalContent.innerHTML = ''; modalErrorMessage.textContent = '';
             chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; currentUtopiaTitle = null; // Reset chat context
             hideFullscreenImage(); // Ensure image overlay is hidden
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (No changes needed)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (No changes needed in logic)
        function addChatMessage(message, sender) { const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block';
            try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); }
            catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); }
            finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Sort alphabetically for consistency
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">~ No hay expedientes disponibles en este archivo ~</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick (Main logic the same, updates context variable name) ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentUtopiaTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = ''; chatHistory.innerHTML = ''; modalError.classList.add('content-hidden'); modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; console.log("Scroll set to 0 after content visible");

                // Image Placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-mask placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización...</p>`; // Mask icon
                modalContent.appendChild(placeholderDiv);

                // Image Element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image'; imgElement.alt = `Visualización conceptual de ${title}`; imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded."); placeholderDiv.remove(); imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => { showFullscreenImage(imgElement.src); });
                };
                imgElement.onerror = () => { console.error("Error loading image"); placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { console.error("Could not create image URL"); placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el expediente."; // Use friendly message
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles (Just button text) ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Desclasificando...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron desclasificar más archivos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al desclasificar: ${error.message}`); // Use friendly message
             } finally {
                 generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Desclasificar Más Archivos';
             }
         }

         // Search Filter Function (Includes normalization for accents)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item'); let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term); item.classList.toggle('hidden', !isVisible); if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check all essential elements
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalTextArea) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: #991b1b; font-size: 1.5em; text-align: center; padding-top: 3em;">~ Error Crítico del Sistema: Fallo al cargar interfaz de archivos ~</p>';
                 return;
             }
             // Add Event Listeners
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Initial Display
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>