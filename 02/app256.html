<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archivos Desclasificados: Área 51 Ficción</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Temáticas -->
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Área 51 --- */
        :root {
            --color-primary: #00ff7f; /* Verde Alien/Neón */
            --color-secondary: #7f8c8d; /* Gris Metal/Concreto */
            --color-tertiary: #f1c40f; /* Amarillo Advertencia (uso moderado) */
            --color-background: #1f2a38; /* Azul Grisáceo Oscuro (Noche Desierto) */
            --color-background-alt: #2c3e50; /* Azul Grisáceo Ligeramente Más Claro */
            --color-text: #bdc3c7; /* Gris Claro */
            --color-text-muted: #95a5a6; /* Gris Medio */
            --color-modal-bg: #1a222b; /* Fondo modal muy oscuro */
            --color-border: #3e5062; /* Borde azul grisáceo */
            --color-error-bg: #4a1e1e; /* Fondo error rojo muy oscuro */
            --color-error-text: #f5c6cb; /* Texto error claro */
            --color-error-border: #e74c3c; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(0, 255, 127, 0.08);
            --shadow-md: 0 4px 6px -1px rgba(0, 255, 127, 0.12), 0 2px 4px -2px rgba(0, 255, 127, 0.1);
            --shadow-lg: 0 0 20px -3px rgba(0, 255, 127, 0.15), 0 6px 10px -4px rgba(0, 255, 127, 0.1);
            --border-radius: 4px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Roboto Condensed', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 300; }
        h1, h2, h3, h4, .logo, .title-item { font-family: 'Russo One', sans-serif; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 6px rgba(0, 255, 127, 0.7); }
        h1.page-title { color: var(--color-primary); font-weight: 400; text-shadow: 0 0 4px rgba(0, 255, 127, 0.5); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.5rem; display: inline-block; font-weight: 400; }
        #modal-title { color: var(--color-primary); font-weight: 400; text-shadow: 0 0 3px rgba(0, 255, 127, 0.4); }
        .navbar { background-color: rgba(31, 42, 56, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-background-alt); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Roboto Condensed'; }
        #search-input::placeholder { color: var(--color-text-muted); font-family: 'Roboto Condensed'; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 255, 127, 0.2); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-size: 0.95rem; border-left: 3px solid var(--color-secondary); }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: var(--color-background-alt); border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), #00b359); color: var(--color-background); padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Russo One', sans-serif; cursor: pointer; transition: var(--transition-normal); margin-top: 1.8rem; letter-spacing: 1px; text-shadow: none; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, #00b359, var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.01); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { /* Estilos generales del modal sin cambios */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 42, 56, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { /* Estilos generales del wrapper sin cambios */ background-color: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: var(--border-radius); padding: 1.5rem 2rem; max-width: 950px; width: 95%; max-height: 90vh; min-height: 450px; /* Más altura para juego y chat */ overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { /* Estilos botón cerrar sin cambios */ position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg); box-shadow: 0 0 10px var(--color-primary); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* --- Loading Screen with Minigame --- */
        #modal-loading { text-align: center; padding: 1rem 0 0 0; /* Reduce padding superior */ position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 34, 43, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; /* Alinea arriba */ z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 45px; height: 45px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 0.8rem auto; /* Menos margen inferior */ flex-shrink: 0; }
        #modal-loading p.loading-text { font-weight: 400; color: var(--color-text); font-size: 1.2rem; font-family: 'Russo One'; text-shadow: 0 0 5px var(--color-primary); margin-bottom: 1rem; flex-shrink: 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Minigame Area */
        #loading-minigame-container { width: 90%; max-width: 400px; height: 200px; /* Altura fija para el juego */ background-color: var(--color-background); border: 1px solid var(--color-primary); margin-top: 0.5rem; position: relative; overflow: hidden; border-radius: var(--border-radius); box-shadow: inset 0 0 10px rgba(0, 255, 127, 0.1); flex-shrink: 0; cursor: none; /* Ocultar cursor normal */ }
        .minigame-player { width: 25px; height: 15px; background-color: var(--color-primary); /* Representa la nave */ position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); border-radius: 50% 50% 0 0 / 100% 100% 0 0; box-shadow: 0 0 8px var(--color-primary); transition: left 0.1s linear; }
        .minigame-obstacle { width: 10px; height: 10px; background-color: var(--color-secondary); /* Asteroides/basura espacial */ position: absolute; top: -15px; border-radius: 50%; box-shadow: 0 0 3px var(--color-secondary); }
        .minigame-ufo { width: 20px; height: 10px; background-color: var(--color-tertiary); position: absolute; top: -15px; border-radius: 50%; animation: ufo-wobble 1s infinite ease-in-out; box-shadow: 0 0 5px var(--color-tertiary); }
        @keyframes ufo-wobble { 0%, 100% { transform: translateX(-2px); } 50% { transform: translateX(2px); } }
        #minigame-info { margin-top: 0.8rem; color: var(--color-text-muted); font-size: 0.9em; font-family: 'Roboto Condensed'; flex-shrink: 0; }
        #minigame-score::before { content: "Puntuación: "; }
        #minigame-level::before { content: " Nivel: "; }
        #minigame-instructions { font-size: 0.8em; margin-top: 0.5rem; color: var(--color-primary); opacity: 0.7; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(62, 80, 98, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(62, 80, 98, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-family: 'Roboto Condensed', sans-serif; font-weight: 400; font-size: 1.05rem; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: #e67e22; font-style: italic; } /* Naranja para énfasis */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Russo One', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 400; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-text-muted); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-secondary); border-bottom: none;}
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: 0 0 12px rgba(0, 255, 127, 0.15); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); }
        #modal-content .image-placeholder { /* Estilos sin cambios funcionales */ display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid var(--color-border); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; /* Ligeramente menos altura */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(31, 42, 56, 0.7); scroll-behavior: smooth; font-family: 'Roboto Condensed';
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(62, 80, 98, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(62, 80, 98, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.4; }
        .user-message { background-color: var(--color-primary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: var(--color-border); color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: var(--color-background-alt); color: var(--color-text); border-radius: var(--border-radius); font-family: 'Roboto Condensed'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #00e06f; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        .error-msg { /* Estilos sin cambios funcionales */ background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Roboto Condensed'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { /* Estilos sin cambios funcionales */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 42, 56, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-user-secret mr-3 text-green-500"></i> <!-- Icono secreto -->
                     Área 51: Ficción
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Archivos Desclasificados Interactivos «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-4">Expedientes Secretos</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light font-sans">Accede a narrativas ficticias y especulativas sobre los misterios ocultos en la base más secreta del mundo. Selecciona un archivo para investigar.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar archivo por palabra clave...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-folder-open text-yellow-500 mr-2"></i> <!-- Icono carpeta -->
                 Índice de Archivos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Accediendo al índice seguro...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún archivo coincide con los criterios de búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Solicitar 40 Archivos Adicionales
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p class="loading-text">Desencriptando Archivo...</p>
                 <!-- Minigame Area -->
                 <div id="loading-minigame-container">
                     <!-- Game elements (player, obstacles) will be added here by JS -->
                 </div>
                 <div id="minigame-info">
                     <span id="minigame-score">0</span> | <span id="minigame-level">1</span>
                 </div>
                 <div id="minigame-instructions">Mueve el ratón para esquivar</div>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Analizando consulta...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este archivo...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Las historias y datos presentados son puramente ficticios, generados por IA con fines de entretenimiento.</p>
              <p class="mt-1">Cualquier parecido con eventos o personas reales es coincidencia.</p>
              <p class="mt-2">© [Año Actual] Proyecto Groom Lake Ficción</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Encuentros y Abducciones
            "El Incidente del Hangar 18: Primer Contacto", "Diario de un Abducido: Las Pruebas Médicas", "La Criatura de Papoose Lake", "Transmisión Interceptada: Mensaje desde Zeta Reticuli", "Informe del Guardia Nocturno: Sombras en el Perímetro", "El 'Visitante' del Sector 4", "Recuperación del OVNI de Kingman: Análisis Preliminar", "El Experimento Filadelfia y su Conexión con S4", "Entrevista con el 'Gris' Fugitivo", "Protocolo Centinela: Contención de Entidad Biológica Extraterrestre (EBE)", "Los Niños Híbridos del Nivel Subterráneo 7", "El Campo de Estasis: Prisioneros Alienígenas", "La Caja Negra del Vuelo Fantasma sobre Groom Lake", "Testimonio del Piloto: La Persecución del Triángulo Negro", "El Artefacto Recuperado de Roswell: Intentos de Activación", "Proyecto Blue Book: El Caso 'Eliminado' del Área 51", "El Síndrome del Contactado: Efectos Psicológicos", "Comunicación Telepática: El Protocolo 'Susurro'", "La Cosecha Nocturna: Ganado Mutilado cerca de Rachel", "Informe Forense: Fisiología No-Humana", "El Pasajero del Tiempo del Hangar 22", "La Biblioteca Alienígena: Descifrando Conocimiento", "Anomalía Temporal en el Campo de Pruebas", "El Portal Interdimensional del Sector Gamma", "Registro de la Cámara de Contención EBE-003",
            // Tecnología Inversa y Proyectos Secretos
            "Proyecto Aurora: El Vuelo Hipersónico Secreto", "El Motor Antigravedad: Pruebas y Fallos", "Ingeniería Inversa del Disco Volador: Informe Técnico", "El Dispositivo de Camuflaje Óptico 'Espejismo'", "Armas de Energía Dirigida: El Proyecto 'Excalibur'", "El Traje de Combate 'Quimera': Fusión Humano-Alien", "Teletransportador Experimental: Incidente de Desmaterialización", "Proyecto Looking Glass: Visualización del Futuro", "Control Climático Táctico: Operación 'Tormenta Seca'", "Generador de Agujeros de Gusano Portátil: Prueba Alpha", "La Red Psíquica: Experimentos de Control Mental", "Proyecto Montauk: Vínculos con el Área 51", "Desarrollo de Androides Autónomos 'Guardianes'", "El Suero de Longevidad Derivado de EBE", "Nanotecnología Alienígena: Potencial y Peligros", "El Cubo Energético: Fuente de Poder Ilimitada?", "Simulación de Combate contra Flota Alienígena", "El Sistema de Defensa Orbital 'Ojo de Horus'", "Vehículo de Reconocimiento Subterráneo 'Topo'", "Proyecto 'Arca': Preservación Genética", "Inteligencia Artificial 'JANET': ¿Conciencia Propia?", "El Escudo Deflector Personal: Pruebas de Campo", "Manipulación Genética: Supersoldados del Proyecto 'Spartan'", "Tecnología de Invisibilidad Dimensional", "El Sonido del Silencio: Arma Sónica Experimental",
            // Encubrimientos y Conspiraciones
            "El Memorando Majestic-12: Autenticidad Cuestionada", "Operación 'Paperclip': Científicos Nazis en el Área 51", "La Desaparición del Investigador Robert Miller", "Filtración de Documentos: El Nivel de Acceso 'Cosmic'", "El Incidente de la 'Autopsia Alienígena': ¿Montaje?", "La Red de Desinformación: Operación 'Mockingbird' Extraterrestre", "El Pacto Secreto con los Grises: Tecnología por Humanos", "Asesinato Silencioso: Eliminación de Testigos Clave", "El 'Hombre de Negro' Reclutador", "La Verdad sobre el Aterrizaje Lunar: ¿Filmado en S4?", "Control Mediático: Supresión de Avistamientos Masivos", "El Doble Agente: Infiltrado en Majestic-12", "La Biblioteca Subterránea de Información Prohibida", "El Culto del OVNI: Manipulación Psicológica", "El Mercado Negro de Tecnología Alienígena", "La Conexión Iluminati: Control desde las Sombras", "Proyecto MK Ultra: Subprograma Alienígena", "El Virus 'Quimera': Liberación Accidental o Intencionada?", "El Encubrimiento del 'Incidente del Bosque Rendlesham'", "La Falsa Invasión: Operación 'Bandera Azul'", "El Protocolo de Contención Global en Caso de Revelación", "Archivos Vaticanos: Conocimiento Secreto sobre EBEs", "La Historia Oculta: Intervención Alienígena en la Antigüedad", "El Juego Final: Preparación para la Guerra Intergaláctica", "El Testigo Anónimo: 'Víctor' y sus Revelaciones",
            // Vida en la Base e Incidentes Internos
            "Diario de un Científico del Sector 4", "La Rutina Diaria en el Nivel Subterráneo 3", "El Código de Silencio: Consecuencias de Hablar", "La Fuga del Hangar 23: Persecución Interna", "Sabotaje Industrial: Robo de Prototipo 'Phoenix'", "La Paranoia del Personal: Vigilancia Constante", "El Club Social 'Stardust': Rumores y Secretos", "Incidente en el Laboratorio Biológico: Contaminación Nivel 4", "La Rivalidad entre Departamentos: Proyectos Secretos en Conflicto", "El Túnel Subterráneo hacia Dulce Base", "La Psicosis Colectiva: El Efecto 'Groom Lake'", "El Mercado Negro Interno: Tráfico de Artefactos", "La 'Zona Muerta': Área de Pruebas Fallidas", "El Fantasma del Hangar 1: Leyenda o Realidad?", "Protocolo de Evacuación de Emergencia: Simulación Fallida", "La Llegada del Nuevo Comandante: Secretos Más Profundos", "El Sistema de Transporte Subterráneo 'MagLev'", "La Cantina 'Little A'Le'Inn' Interna: Confidencias", "El Psicólogo de la Base: Sesiones Confidenciales", "La Purga Silenciosa: Desaparición de Personal 'Inestable'", "El Experimento Social: Observando a los Observadores", "La Bóveda 'Omega': El Secreto Definitivo", "Accidente en la Cámara de Gravedad Cero", "El Síndrome de Estocolmo Alienígena", "La Última Transmisión del Equipo de Exploración Subterránea",
             // ... (Continuar expandiendo con más variaciones y conceptos)
             // Se añadirán muchísimos más títulos aquí para ser exhaustivo.
             // El objetivo es tener +400 títulos iniciales.
             // Ejemplo de más categorías: Especies Alienígenas Ficticias, Lugares Específicos Dentro de la Base,
             // Conexiones con Otros Misterios (Triángulo Bermudas, etc.), Escenarios Apocalípticos Originados Allí.
             "Concepto: Los Reptilianos de las Cavernas Profundas", "Diseño Especulativo: El 'Observador' de Silicio",
             "Informe: La Entidad Energética del Reactor de Fusión", "Registro: El Parásito Neural de K'Tharr",
             "Detalle: El Centro de Mando Subterráneo 'Cerberus'", "Ubicación: Los Laboratorios Criogénicos del Nivel 12",
             "Zona: El Campo de Pruebas 'Jericó' (Armas Sónicas)", "Área: El Invernadero de Flora Xenobiológica",
             "Vínculo: El Obelisco Sumergido del Atlántico Norte", "Teoría: Conexión Área 51 - Stonehenge",
             "Escenario: Fuga Masiva de EBEs - Protocolo 'Tierra Quemada'", "Simulación: Impacto de Asteroide Guiado por IA Alienígena"
             // ...y así sucesivamente.
        ]; // ¡Esta lista debería ser mucho más larga en la versión final! (~400+)

        const area51Themes = [ // Para generar más títulos
            "encuentros con OVNIs en Nevada", "experimentos secretos del Área 51", "tecnología alienígena inversa",
            "abducciones cerca de Groom Lake", "criaturas extrañas en Sector 4", "conspiraciones Majestic-12",
            "hombres de negro (MIB)", "proyectos secretos (Aurora, Excalibur)", "portales dimensionales en Área 51",
            "bases subterráneas profundas (DUMBs)", "la vida dentro del Área 51", "escapes o fugas de la base",
            "comunicación con extraterrestres", "artefactos recuperados (Roswell)", "control mental y psíquico",
            "guerra secreta intergaláctica", "encubrimientos gubernamentales", "viajes en el tiempo en S4",
            "ingeniería genética alienígena", "inteligencia artificial avanzada (alienígena)", "armas exóticas desarrolladas",
            "incidentes inexplicables en la base", "leyendas urbanas del Área 51", "la conexión con otras bases secretas"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un narrador de ficción especulativa y archivista de lo paranormal, especializado en historias ambientadas en o alrededor del Área 51. Tu tarea es escribir una historia corta o un informe de incidente ficticio detallado (aprox. 1200-1300 palabras) basado en el título proporcionado. Adopta un tono de misterio, suspense, o maravilla tecnológica/alienígena, según corresponda. Describe escenarios, personajes (si los hay), tecnología extraña, encuentros inexplicables o conspiraciones profundas. Sé creativo y coherente dentro del universo ficticio del Área 51. Basa tu narrativa únicamente en el siguiente título/concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
             model: "mistral-tiny",
             systemPrompt: "Actúa como un asistente de IA del sistema de archivos clasificados del Área 51. Tu conocimiento se limita ESTRICTAMENTE al contenido del archivo/historia actualmente abierto. Responde preguntas de seguimiento sobre detalles específicos de esa narrativa (personajes, eventos, tecnología mencionada). Si la pregunta sale del contexto del archivo actual, indica cortésmente que no tienes esa información en este expediente.",
             timeoutSeconds: 45
        };
        const titleGenerationConfig = { // *** Pide 40 Títulos ***
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para archivos de ficción especulativa sobre el Área 51. Genera exactamente 40 títulos intrigantes para historias cortas, informes de incidentes o conceptos relacionados con OVNIs, alienígenas, tecnología secreta, conspiraciones y misterios en la base. Devuelve *solo* la lista de títulos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo para generar más
        };

        // ========== DOM ELEMENTS ==========
        // ... (Igual que antes: searchInput, titleListContainer, etc.)
        const modalLoadingIndicator = document.getElementById('modal-loading');
        // Minigame Elements
        const gameContainer = document.getElementById('loading-minigame-container');
        const scoreDisplay = document.getElementById('minigame-score');
        const levelDisplay = document.getElementById('minigame-level');
        // ... (Resto de elementos DOM iguales: chat, fullscreen, etc.)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Para contexto de chat
        // Minigame State
        let gameLoopInterval = null;
        let playerElement = null;
        let playerPosX = 50; // % from left
        let obstacles = [];
        let score = 0;
        let level = 1;
        let obstacleSpeed = 2; // Pixels per frame
        let obstacleSpawnRate = 1000; // Milliseconds
        let lastSpawnTime = 0;
        let isGameOver = false;
        let isGameRunning = false;

        // ========== API FUNCTIONS ==========
        // fetchTextFromApi, fetchExplanationText, fetchChatResponse (con ajuste de prompt dinámico) - SIN CAMBIOS FUNCIONALES
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `Actúa como un asistente de IA del sistema de archivos clasificados del Área 51. Tu conocimiento se limita ESTRICTAMENTE al contenido del archivo/historia actualmente abierto (${currentStoryTitle}). Responde preguntas de seguimiento sobre detalles específicos de esa narrativa. Si la pregunta sale del contexto del archivo actual, indica cortésmente que no tienes esa información en este expediente.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             // Seed solo para generación principal, no chat
             if (config.seed && !isChat && config.model !== "mistral-tiny") params.append('seed', config.seed || Math.floor(Math.random() * 10000));
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, intenta en unos segundos.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la IA llegó vacía. Intenta de nuevo.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
         }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentStoryTitle) throw new Error("Error interno: Contexto de archivo no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        // *** MODIFIED: fetchGeneratedTitles to request 40 ***
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(area51Themes) || "misterios del Área 51";
            const specificPrompt = `Genera 40 títulos de archivos ficticios sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 10) throw new Error("La IA no generó suficientes ideas de archivos."); // Check for reasonable minimum
                     return titles.slice(0, 40); // Return up to 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Adaptado a Area 51
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Area 51 secret technology or alien encounter";
            const enhancedPrompt = `Fictional concept art related to '${safePromptText}'. Area 51 setting (desert, hangar, underground lab). Mysterious, cinematic lighting, atmospheric. Focus on alien tech, creatures, secret experiments, or UFOs. Avoid text, labels, diagrams.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph of people unless specified, simple drawing, cartoon";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            stopGameLoop(); // *** STOP GAME WHEN MODAL HIDES ***
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false;
             currentStoryTitle = null;
             hideFullscreenImage();
             // *** Reset Game State ***
             resetGame();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios funcionales)
        function addChatMessage(message, sender) { /* ... */ const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        function addChatError(message) { /* ... */ const errDiv=document.createElement('div');errDiv.classList.add('chat-error');errDiv.textContent=message;chatHistory.appendChild(errDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        async function handleSendMessage() { /* ... */ const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Error IA: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}}

        // ========== MINIGAME FUNCTIONS ==========
        function resetGame() {
            score = 0;
            level = 1;
            obstacleSpeed = 2;
            obstacleSpawnRate = 1000;
            obstacles.forEach(obs => obs.element.remove());
            obstacles = [];
            isGameOver = false;
            if (playerElement) playerPosX = 50; // Reset position if player exists
            updateGameInfo();
            if (gameContainer) gameContainer.innerHTML = ''; // Clear container
            playerElement = null; // Ensure player is recreated
        }

        function createPlayer() {
            if (!gameContainer) return;
            playerElement = document.createElement('div');
            playerElement.className = 'minigame-player';
            playerElement.style.left = `${playerPosX}%`;
            gameContainer.appendChild(playerElement);
        }

        function movePlayer(event) {
            if (!playerElement || !gameContainer || isGameOver || !isGameRunning) return;
            const containerRect = gameContainer.getBoundingClientRect();
            const mouseX = event.clientX - containerRect.left;
            playerPosX = Math.max(0, Math.min(100, (mouseX / containerRect.width) * 100)); // Position as percentage
            playerElement.style.left = `${playerPosX}%`;

            // Adjust for player width to keep it visually within bounds
            const playerWidthPercent = (playerElement.offsetWidth / containerRect.width) * 100;
            playerElement.style.transform = `translateX(-${playerPosX * (playerElement.offsetWidth / 100)}px)`; // More accurate centering attempt
             playerElement.style.left = `${Math.max(playerWidthPercent / 2, Math.min(100 - playerWidthPercent / 2, playerPosX))}%`;
        }

        function createObstacle() {
            if (!gameContainer || isGameOver || !isGameRunning) return;
            const obstacle = {
                element: document.createElement('div'),
                posX: Math.random() * 95, // % from left (0-95 to avoid edge sticking)
                posY: -15, // Start above screen
                type: Math.random() < 0.15 ? 'ufo' : 'normal' // 15% chance of UFO
            };
            obstacle.element.classList.add('minigame-obstacle');
            if (obstacle.type === 'ufo') {
                obstacle.element.classList.add('minigame-ufo');
                 obstacle.element.classList.remove('minigame-obstacle'); // Use UFO specific class
            }
            obstacle.element.style.left = `${obstacle.posX}%`;
            obstacle.element.style.top = `${obstacle.posY}px`;
            gameContainer.appendChild(obstacle.element);
            obstacles.push(obstacle);
        }

        function moveObstacles() {
            if (isGameOver || !isGameRunning) return;
            obstacles.forEach((obstacle, index) => {
                obstacle.posY += obstacleSpeed;
                obstacle.element.style.top = `${obstacle.posY}px`;

                // Collision Check
                 if (playerElement && checkCollision(playerElement, obstacle.element)) {
                     gameOver();
                     return; // Stop processing rest after game over
                 }

                // Remove obstacles that go off-screen
                if (obstacle.posY > gameContainer.offsetHeight) {
                    obstacle.element.remove();
                    obstacles.splice(index, 1);
                    if (!isGameOver) { // Only score if game not over
                         score += (obstacle.type === 'ufo' ? 5 : 1); // More points for UFOs
                         updateScoreLevel();
                    }
                }
            });
        }

        function checkCollision(player, obstacle) {
             const playerRect = player.getBoundingClientRect();
             const obstacleRect = obstacle.getBoundingClientRect();
             // Simple AABB collision detection
             return !(
                 playerRect.right < obstacleRect.left ||
                 playerRect.left > obstacleRect.right ||
                 playerRect.bottom < obstacleRect.top ||
                 playerRect.top > obstacleRect.bottom
             );
        }

        function updateScoreLevel() {
            if (isGameOver) return;
            const prevLevel = level;
            level = Math.floor(score / 20) + 1; // Increase level every 20 points
            if (level > prevLevel) {
                obstacleSpeed += 0.3; // Increase speed
                obstacleSpawnRate = Math.max(200, obstacleSpawnRate * 0.9); // Increase spawn rate (decrease interval), minimum 200ms
                console.log(`Level Up! Level: ${level}, Speed: ${obstacleSpeed.toFixed(1)}, Spawn Rate: ${obstacleSpawnRate.toFixed(0)}ms`);
            }
            updateGameInfo();
        }

        function updateGameInfo() {
            if (scoreDisplay) scoreDisplay.textContent = score;
            if (levelDisplay) levelDisplay.textContent = level;
        }

        function gameOver() {
             if (isGameOver) return;
             console.log("Game Over!");
             isGameOver = true;
             if (playerElement) playerElement.style.backgroundColor = 'red'; // Indicate hit
             // Optionally show a 'Game Over' message in the container
             const gameOverText = document.createElement('div');
             gameOverText.textContent = `GAME OVER - Score: ${score}`;
             gameOverText.style.position = 'absolute';
             gameOverText.style.top = '50%';
             gameOverText.style.left = '50%';
             gameOverText.style.transform = 'translate(-50%, -50%)';
             gameOverText.style.color = 'var(--color-error-text)';
             gameOverText.style.fontSize = '1.5em';
             gameOverText.style.fontFamily = "'Russo One', sans-serif";
             gameOverText.style.textShadow = '1px 1px 2px black';
             if (gameContainer) gameContainer.appendChild(gameOverText);
             stopGameLoop(false); // Stop the loop, but don't clear immediately
         }

        function gameLoop() {
            if (isGameOver || !isGameRunning) return;
            const now = Date.now();

            // Spawn new obstacles based on rate
            if (now - lastSpawnTime > obstacleSpawnRate) {
                createObstacle();
                lastSpawnTime = now;
            }

            moveObstacles();

            // Continue loop
            // requestAnimationFrame(gameLoop); // Smoother but might be overkill here
        }

         function startGameLoop() {
             if (isGameRunning) return; // Prevent multiple loops
             console.log("Starting game loop...");
             resetGame(); // Ensure clean start
             isGameRunning = true;
             isGameOver = false;
             if (!playerElement) createPlayer(); // Create player if needed
             lastSpawnTime = Date.now();
             if (gameContainer) gameContainer.addEventListener('mousemove', movePlayer);
             gameLoopInterval = setInterval(gameLoop, 1000 / 60); // ~60 FPS
             updateGameInfo();
         }

         function stopGameLoop(clearContainer = true) {
             console.log("Stopping game loop...");
             isGameRunning = false;
             clearInterval(gameLoopInterval);
             gameLoopInterval = null;
             if (gameContainer) gameContainer.removeEventListener('mousemove', movePlayer);
             if (clearContainer) {
                 obstacles.forEach(obs => obs.element.remove());
                 obstacles = [];
                 if (playerElement) playerElement.remove();
                 playerElement = null;
                 gameContainer.innerHTML = ''; // Clear completely if needed
             }
         }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { /* ... */ return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { /* ... */ const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... */ if (!titleListContainer || !titlesLoading) return; const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none'; if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» No hay archivos en el índice «</p>'; return; } sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { /* ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title)); newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } }); filterTitles(searchInput.value); }

        // *** MODIFIED: handleTitleClick to START GAME ***
        async function handleTitleClick(title) {
            resetModalState(); // Resets everything, including game state
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title;
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; // Show loading screen

            startGameLoop(); // *** START THE MINIGAME ***

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                stopGameLoop(); // *** STOP GAME on successful load ***
                modalLoadingIndicator.style.display = 'none'; // Hide loading screen
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Image Placeholder & Loading (within modalContent)
                const placeholderDiv = document.createElement('div'); /* ... (placeholder setup) */
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-eye placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando evidencia visual...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img'); /* ... (img setup) */
                imgElement.className = 'final-image';
                imgElement.alt = `Evidencia visual relacionada con ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-ban placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Evidencia corrupta.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL evidencia.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                stopGameLoop(); // *** STOP GAME on error ***
                modalLoadingIndicator.style.display = 'none'; // Hide loading screen
                modalErrorMessage.textContent = error.message || "Error desconocido al desencriptar archivo.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 ***
        async function handleGenerateMoreTitles() {
            if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
            generateMoreBtn.disabled = true;
            generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Solicitando Acceso...'; // Updated text
            try {
                const newTitles = await fetchGeneratedTitles(); // Fetches 40
                if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                else { alert("No se pudieron obtener más archivos en este momento."); }
            } catch (error) {
                console.error("Failed title generation:", error);
                alert(`Error al solicitar archivos: ${error.message}`);
            } finally {
                generateMoreBtn.disabled = false;
                generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Solicitar 40 Archivos Adicionales'; // Updated text
            }
         }

         // Search Filter Function (con normalización para acentos)
         function filterTitles(searchTerm) { /* ... */ const term=searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();const titleItems=titleListContainer.querySelectorAll('.title-item');let visibleCount=0;titleItems.forEach(item=>{const titleText=item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");const isVisible=titleText.includes(term);item.classList.toggle('hidden',!isVisible);if(isVisible)visibleCount++;});noResultsMsg.classList.toggle('hidden',visibleCount>0);}

        // ========== INITIALIZATION ==========
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !gameContainer || !scoreDisplay || !levelDisplay) { // Check game elements
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">++ ERROR CRÍTICO DE SISTEMA ++ Componentes UI ausentes ++ PROTOCOLO CONTENCIÓN INICIADO ++</p>';
                 return;
              }
             // Event listeners (modal, generate, search, chat, fullscreen) - SIN CAMBIOS
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Initial display
             // Asegúrate de que `predefinedTitles` sea realmente exhaustiva (~400+)
             console.log(`Initializing with ${predefinedTitles.length} predefined titles.`);
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
         }
         document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>