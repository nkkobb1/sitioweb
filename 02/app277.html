<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Religión Azteca - Panteón y Rituales</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Temáticas (Cinzel para títulos, Lato para cuerpo) -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Religión Azteca --- */
        :root {
            --color-primary: #D2691E; /* Ocre / Terracota */
            --color-secondary: #40E0D0; /* Turquesa */
            --color-tertiary: #FFD700; /* Oro / Maíz */
            --color-accent: #B22222; /* Rojo Oscuro / Sangre */
            --color-background: #F5F5DC; /* Beige / Arena / Piedra clara */
            --color-text: #3B3131; /* Marrón Oscuro / Casi Negro */
            --color-text-muted: #8B4513; /* Marrón silla */
            --color-modal-bg: #FFF8DC; /* Blanco Maíz / Pergamino */
            --color-border: #CD853F; /* Perú / Borde Ocre */
            --color-error-bg: #ffebee;
            --color-error-text: #c62828;
            --color-error-border: #ef9a9a;

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.15);
            --border-radius: 6px; /* Bordes menos redondeados, más sólidos */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400;
               background-image: linear-gradient(rgba(245, 245, 220, 0.95), rgba(245, 245, 220, 0.95)),
                                 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cg fill='%23cd853f' fill-opacity='0.08'%3E%3Cpath fill-rule='evenodd' d='M0 0h40v40H0V0zm40 40h40v40H40V40zm0-40h2l-2 2V0zm0 40h2l-2 2V40zm-2 2l2-2v2h-2zm40 0h2l-2 2V40zm0-40h2l-2 2V0zm-2 2l2-2v2h-2zM0 40h2l-2 2V40zm0-40h2l-2 2V0zm-2 2l2-2v2H-2zm80 0h2l-2 2V0zm-2 2l2-2v2h-2z'/%3E%3C/g%3E%3C/svg%3E"); /* Patrón geométrico sutil */
               background-attachment: fixed;
        }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 1px; }
        .logo { color: var(--color-primary); text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }
        .logo .secondary-part { color: var(--color-secondary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-accent); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-accent); font-weight: 700; }
        .navbar { background-color: rgba(245, 245, 220, 0.9); /* Beige semitransparente */ backdrop-filter: blur(4px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 2px solid var(--color-primary); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.2rem 0.8rem 3rem; border: 2px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 4px rgba(210, 105, 30, 0.2); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Lato'; font-size: 0.95rem; border-left: 4px solid var(--color-secondary); /* Borde turquesa */ }
        .title-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: var(--color-primary); color: var(--color-primary); border-left-color: var(--color-primary); background-color: #fffaf0; /* Floral white hover */ }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-accent)); color: white; padding: 0.9rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel', serif; font-size: 1.1rem; letter-spacing: 1.5px; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-accent), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(40, 20, 10, 0.9); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 3px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 500px; /* Mantener alto */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-primary); border: 2px solid var(--color-modal-bg); border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-modal-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-accent); transform: rotate(90deg) scale(1.1); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        #modal-story-content-area { flex-grow: 1; min-height: 0; display: none; flex-direction: column; }
        #modal-story-content-area.visible { display: flex; }
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) #EADDCA; /* Scrollbar ocre sobre fondo claro */
        }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: #EADDCA; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid #EADDCA; }

        #modal-content { padding: 0 5px; font-size: 1.08rem; } /* Texto ligeramente más grande */
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-accent); font-style: italic; font-weight: 700;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-accent); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-text-muted); }
        #modal-content h4 { font-size: 1.1em; color: #a0522d; border-bottom: none;} /* Sienna */
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 3px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 15px var(--color-primary); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 5px solid rgba(140, 69, 19, 0.3); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-secondary); } /* Icono turquesa */

        /* Chat Section Styles */
        #chat-section { border-top: 2px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fffef5; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-accent) #f5eeda;
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: #f5eeda; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-accent); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; box-shadow: var(--shadow-sm); }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; font-weight: 600;}
        .ai-message { background-color: var(--color-secondary); color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; } /* Turquesa con texto oscuro */
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(210, 105, 30, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1rem; flex-shrink: 0; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-accent); transform: scale(1.1); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; transform: none; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Screen & Minigame */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, rgba(210, 105, 30, 0.95) 0%, rgba(255, 215, 0, 0.95) 100%); /* Ocre a Dorado */
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius);
            padding: 2rem; color: var(--color-text); text-align: center;
        }
        #modal-loading.active { display: flex; }
        #loading-game-canvas {
            border: 3px solid var(--color-secondary); /* Borde Turquesa */
            background-color: #3B3131; /* Fondo marrón oscuro */
            max-width: 90%; max-height: 60%; aspect-ratio: 16 / 9;
            box-shadow: 0 0 20px rgba(64, 224, 208, 0.5); /* Sombra Turquesa */
            margin-bottom: 1rem; display: block;
        }
        #loading-instructions { font-size: 0.9rem; margin-top: 0.5rem; font-family: 'Lato'; color: white; text-shadow: 1px 1px 1px #000;}
        #loading-score { font-size: 1.5rem; font-family: 'Cinzel'; margin-top: 0.5rem; color: white; text-shadow: 1px 1px 2px #000; }
        .loading-spinner-modal { display: none; /* Oculto si el canvas funciona */ }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); /* ... */ }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { background-color: rgba(40, 20, 10, 0.95); /* Marrón muy oscuro */ z-index: 100; /* ... */ }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { border: 4px solid var(--color-secondary); box-shadow: 0 0 30px var(--color-secondary); /* ... */ }
        #fullscreen-close-btn { background: var(--color-modal-bg); border: 2px solid var(--color-secondary); color: var(--color-primary); /* ... */ }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: white; }
    </style>
</head>
<body class="antialiased">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-4xl sm:text-5xl">
                     <i class="fas fa-sun mr-2 text-yellow-500"></i> <!-- Sol -->
                     Religión <span class="secondary-part">Azteca</span> <!-- Azteca en turquesa -->
                     <i class="fas fa-feather-alt ml-2 text-green-600"></i> <!-- Pluma -->
                 </h1>
             </div>
             <span class="text-md text-gray-700 font-semibold font-sans tracking-wide">» Mitos, Dioses y Rituales «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">El Cosmos Mexica</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora el complejo universo de creencias, el panteón divino y las ceremonias sagradas que definieron a la civilización azteca.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar (Ej: Quetzalcóatl, Sacrificio, Templo Mayor...)">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-red-700 mr-2"></i> <!-- Libro Rojo Oscuro -->
                 Índice de Conocimiento
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los códices antiguos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron registros sobre ese término en los anales «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar 40 Nuevos Conocimientos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <canvas id="loading-game-canvas" width="640" height="360">Tu navegador no soporta Canvas.</canvas>
                 <p id="loading-instructions">¡Espera un momento! Recolecta ofrendas (Usa ↑ / ↓)</p>
                 <p id="loading-score">Ofrendas: 0 | Nivel: 1</p>
                 <div class="loading-spinner-modal content-hidden"></div>
             </div>

             <!-- Content Area Wrapper (Initially Hidden) -->
             <div id="modal-story-content-area">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al Tlamatini...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta más sobre este tema...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gradient-to-r from-yellow-100 to-red-100 text-gray-700 py-6 mt-12 border-t-2 border-gray-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información sobre la religión azteca generada por IA con fines educativos y de referencia.</p>
              <p class="mt-1">Consulta fuentes académicas para estudios profundos. Basado en interpretaciones históricas.</p>
              <p class="mt-2">© 2025 Explorador Mexica</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Dioses Principales (Panteón Central)
            "Huitzilopochtli: Dios de la Guerra y el Sol", "Mitos de Huitzilopochtli: Nacimiento y Victoria sobre Coyolxauhqui", "Templo Mayor: La Morada de Huitzilopochtli y Tlaloc", "Quetzalcóatl: La Serpiente Emplumada (Dios del Viento, Sabiduría, Vida)", "Leyendas de Quetzalcóatl: Creación de la Humanidad y Robo del Maíz", "Quetzalcóatl vs Tezcatlipoca: El Espejo Humeante", "Tlaloc: Dios de la Lluvia, el Agua y la Fertilidad", "Paraíso de Tlaloc (Tlalocan)", "Rituales a Tlaloc: Sacrificios Infantiles", "Tezcatlipoca: El Espejo Humeante (Dios Nocturno, Destino, Magia)", "Las Cuatro Manifestaciones de Tezcatlipoca", "Coatlicue: Madre de los Dioses (Falda de Serpientes)", "Xipe Tótec: Nuestro Señor el Desollado (Renovación, Agricultura)", "Festival Tlacaxipehualiztli (Honor a Xipe Tótec)", "Mictlantecuhtli: Señor del Inframundo (Mictlan)", "Mictecacíhuatl: Señora del Mictlan", "Chalchiuhtlicue: Diosa del Agua Terrestre (Lagos, Ríos)", "Xochiquetzal: Diosa de las Flores, el Amor y la Belleza", "Huehuetéotl/Xiuhtecuhtli: Dios del Fuego y el Hogar", "Cintéotl/Chicomecóatl: Deidades del Maíz",

            // Dioses Creadores y Cosmología
            "Ometéotl (Ometecuhtli y Omecíhuatl): La Dualidad Creadora", "Los Cinco Soles: Mitos de Creación y Destrucción del Mundo", "El Quinto Sol (Nahui Ollin): El Sol Actual", "Creación de la Tierra: Cipactli", "Los Trece Cielos (Topan)", "Los Nueve Niveles del Mictlan (Inframundo)", "El Árbol Cósmico (Axis Mundi)", "Los Cuatro Rumbos del Universo y sus Dioses Regentes", "El Mito de la Creación de la Luna (Tecciztécatl y Nanahuatzin)", "Tamoanchan: Lugar Mítico de Origen",

            // Rituales y Ceremonias
            "El Sacrificio Humano: Tipos y Significado (Corazón, Gladiatorio, Flechamiento)", "Las Guerras Floridas (Xochiyáoyotl)", "Autosacrificio y Sangrías Rituales", "El Juego de Pelota (Ōllamaliztli): Significado Religioso", "Festivales del Calendario (Veintenas)", "Panquetzaliztli: Celebración de Huitzilopochtli", "Toxcatl: Celebración de Tezcatlipoca", "Ceremonia del Fuego Nuevo (Xiuhmolpilli)", "Ayunos y Penitencias", "Ofrendas Rituales: Comida, Flores, Copal, Papel Amate", "Canibalismo Ritual: ¿Existió y qué significado tenía?",

            // Sacerdocio y Organización Religiosa
            "Los Sacerdotes (Tlamacazqui): Funciones y Jerarquía", "El Sumo Sacerdote (Quetzalcóatl Tlamacazqui)", "Calmécac: Escuela para Nobles y Sacerdotes", "Templos y Teocallis: Arquitectura Sagrada", "Interpretación de Augurios y Sueños", "Los Libros Sagrados (Códices): Tonalámatl", "El Papel de la Mujer en el Sacerdocio",

            // Conceptos Fundamentales
            "Teotl: La Energía Divina Universal", "Tonalli: La Fuerza Vital y el Destino", "Teyolía: El Corazón como Centro Anímico", "Ihiyotl: El Aliento o Hálito Vital", "Nahualismo: La Conexión con el Animal Espiritual", "El Concepto del Tiempo Cíclico", "Dualidad en el Pensamiento Azteca (Vida/Muerte, Orden/Caos)", "Tlamatinime: Los Sabios o Filósofos Aztecas",

            // Calendario y Astrología
            "El Tonalpohualli: Calendario Ritual de 260 Días", "Significado de los 20 Signos de los Días", "Significado de los 13 Numerales", "El Xiuhpohualli: Calendario Solar de 365 Días", "Las 18 Veintenas (Meses)", "Los Nemontemi: Los 5 Días Acíagos", "La Rueda Calendárica: Ciclo de 52 Años", "Observación Astronómica y su Importancia Religiosa", "Influencia de Venus (Tlahuizcalpantecuhtli)",

            // Religión en la Vida Cotidiana y Social
            "Dioses Patronos de los Calpullis (Barrios)", "Religión y Agricultura: Rituales para la Cosecha", "Religión y Guerra: Justificación y Rituales", "Creencias sobre la Muerte y el Más Allá", "El Destino de los Guerreros Muertos en Combate", "El Destino de las Mujeres Muertas en el Parto", "Medicina y Religión: Chamanismo y Curanderos", "Ética y Moral en la Religión Azteca",

            // Influencias y Sincretismo
            "Influencia de Teotihuacan en la Religión Azteca", "Influencia Tolteca: El Legado de Tula", "Relación con las Creencias Mayas (Quetzalcóatl/Kukulkán)", "Sincretismo Religioso tras la Conquista Española", "La Virgen de Guadalupe y Tonantzin", "Supervivencia de Prácticas Prehispánicas",
            // Añadir más detalles específicos sobre mitos menores, dioses regionales, etc.
        ];
        const aztecReligionThemes = [ // Temas para generar más títulos
            "dioses aztecas", "mitología mexica", "cosmovisión azteca", "sacrificio humano", "Templo Mayor", "Quetzalcóatl", "Huitzilopochtli", "Tlaloc", "Tezcatlipoca", "calendario azteca", "Tonalpohualli", "Xiuhpohualli", "Mictlan", "inframundo azteca", "creación del mundo azteca", "Cinco Soles", "sacerdocio azteca", "rituales mexicas", "festivales aztecas", "juego de pelota", "Guerras Floridas", "nahualismo", "Teotl", "Tonalli", "códices aztecas", "vida después de la muerte azteca", "sincretismo religioso México", "influencia tolteca", "Teotihuacan y aztecas", "agricultura y religión azteca", "guerra y religión azteca", "Xipe Totec", "Coatlicue", "Chalchiuhtlicue", "Xochiquetzal"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un historiador y antropólogo especializado en las religiones mesoamericanas, con un enfoque profundo en la cosmología, panteón y rituales de la civilización azteca/mexica. Proporciona una descripción detallada, académica pero accesible, sobre el dios, concepto o práctica religiosa azteca indicada. Cubre su significado, mitos asociados, iconografía, rituales relacionados y su importancia dentro del sistema de creencias mexica. Utiliza terminología náhuatl apropiada cuando sea relevante (explicándola brevemente). El objetivo es un texto informativo de aproximadamente 1200-1300 palabras, basado *únicamente* en el siguiente tema:",
            timeoutSeconds: 180
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un experto en la religión azteca, respondiendo preguntas específicamente sobre '[currentTopicTitle]'. Aclara dudas, expande detalles mencionados o conecta el tema con otros aspectos de la cultura mexica, basándote en la información principal proporcionada.",
            timeoutSeconds: 50
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Genera exactamente 40 nombres de dioses, diosas, mitos, rituales, conceptos cosmológicos, festivales o sitios sagrados específicos de la religión azteca/mexica. Asegúrate de que sean términos concretos y relevantes para una enciclopedia sobre el tema. Devuelve *solo* la lista, un ítem por línea, sin números, guiones, introducciones ni conclusiones.",
            timeoutSeconds: 60
        };
        // Patrones para filtrar publicidad (expresiones regulares, insensibles a mayúsculas)
        const adPatterns = [
            /^---\s*Proteja su navegación/i,
            /sponsored by/i,
            /learn more at/i,
            /get started with/i,
            /try .*? now/i,
            /nordvpn/i, // Ejemplo específico
            /^advertisement:/i,
            /visit our website/i,
            /subscribe to .*? for/i,
            /^\[.*?\]$/i, // Líneas que solo contienen algo entre corchetes (a veces metadatos)
            /^\s*$/ // Líneas vacías (se eliminan al final, pero bueno tenerlo)
        ];

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        // ... (resto de elementos DOM iguales que la versión anterior)
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        const gameCanvas = document.getElementById('loading-game-canvas');
        const gameCtx = gameCanvas.getContext('2d');
        const loadingInstructions = document.getElementById('loading-instructions');
        const loadingScoreDisplay = document.getElementById('loading-score');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Cambiado de currentStoryTitle
        let gameLoopId = null;
        let isGameRunning = false;

        // ========== MINIGAME VARIABLES & LOGIC ("Ofrenda Rápida") ==========
        const gameConfig = {
            playerWidth: 35, playerHeight: 55, playerSpeed: 5, playerColor: '#8B4513', // Sacerdote/Guerrero marrón
            itemSize: 25, itemSpeedMultiplier: 0.9, // Items ligeramente más lentos
            obstacleWidth: 40, obstacleHeight: 20, obstacleMinSpeed: 3.5, obstacleMaxSpeed: 7,
            spawnRateItems: 0.018,
            spawnRateObstacles: 0.012,
            scorePerItem: 15, scoreLostOnHit: 30,
            levelUpScore: 200,
            maxSpeedIncreasePerLevel: 0.6,
            maxSpawnRateIncreasePerLevel: 0.0025,
        };

        let player = { x: 50, y: gameCanvas.height / 2 - gameConfig.playerHeight / 2 };
        let items = []; // {x, y, type: 'maize' | 'feather' | 'jade'}
        let obstacles = []; // {x, y, speed, type: 'obsidian' | 'skull'}
        let score = 0;
        let level = 1;
        let currentObstacleSpeed = gameConfig.obstacleMinSpeed;
        let currentItemSpeed = gameConfig.obstacleMinSpeed * gameConfig.itemSpeedMultiplier;
        let currentObstacleSpawnRate = gameConfig.spawnRateObstacles;
        let currentItemSpawnRate = gameConfig.spawnRateItems;
        let keysPressed = {};

        function resetGame() { /* ... (igual que antes, solo cambia texto score) */
            player.y = gameCanvas.height / 2 - gameConfig.playerHeight / 2;
            items = []; obstacles = []; score = 0; level = 1;
            currentObstacleSpeed = gameConfig.obstacleMinSpeed;
            currentItemSpeed = gameConfig.obstacleMinSpeed * gameConfig.itemSpeedMultiplier;
            currentObstacleSpawnRate = gameConfig.spawnRateObstacles;
            currentItemSpawnRate = gameConfig.spawnRateItems;
            keysPressed = {};
            loadingScoreDisplay.textContent = `Ofrendas: 0 | Nivel: 1`; // Texto actualizado
            console.log("Aztec Game Reset");
        }
        function handleKeyDown(e) { /* ... (igual) */ keysPressed[e.key]=true;if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){e.preventDefault();}}
        function handleKeyUp(e) { /* ... (igual) */ keysPressed[e.key]=false; }

        function updateGame() { /* ... (lógica igual, solo cambia tipos de spawn y score) */
            if (!isGameRunning) return;
            // Player Movement
            if (keysPressed['ArrowUp'] && player.y > 0) player.y -= gameConfig.playerSpeed;
            if (keysPressed['ArrowDown'] && player.y < gameCanvas.height - gameConfig.playerHeight) player.y += gameConfig.playerSpeed;
            player.color = (level % 2 === 0) ? '#40E0D0' : '#8B4513'; // Alterna Turquesa/Marrón

            // Spawn Items
            if (Math.random() < currentItemSpawnRate) {
                let itemType = 'maize';
                const rand = Math.random();
                if (rand < 0.2) itemType = 'jade'; else if (rand < 0.5) itemType = 'feather';
                items.push({ x: gameCanvas.width, y: Math.random()*(gameCanvas.height-gameConfig.itemSize), type: itemType });
            }
            // Spawn Obstacles
            if (Math.random() < currentObstacleSpawnRate) {
                obstacles.push({ x: gameCanvas.width, y: Math.random()*(gameCanvas.height-gameConfig.obstacleHeight), speed: currentObstacleSpeed + (Math.random()*(gameConfig.obstacleMaxSpeed - gameConfig.obstacleMinSpeed)), type: Math.random() < 0.5 ? 'obsidian' : 'skull' });
            }
            // Move & Remove Items & Check Collision
            items.forEach((item, index) => {
                item.x -= currentItemSpeed;
                if (item.x < -gameConfig.itemSize) items.splice(index, 1);
                if (player.x < item.x + gameConfig.itemSize && player.x + gameConfig.playerWidth > item.x && player.y < item.y + gameConfig.itemSize && player.y + gameConfig.playerHeight > item.y) {
                    let itemValue = gameConfig.scorePerItem;
                    if (item.type === 'feather') itemValue *= 1.5; else if (item.type === 'jade') itemValue *= 2.5; // Jade vale más
                    score += Math.floor(itemValue);
                    items.splice(index, 1);
                    checkLevelUp();
                }
            });
            // Move & Remove Obstacles & Check Collision
            obstacles.forEach((obstacle, index) => {
                obstacle.x -= obstacle.speed;
                if (obstacle.x < -gameConfig.obstacleWidth) obstacles.splice(index, 1);
                if (player.x < obstacle.x + gameConfig.obstacleWidth && player.x + gameConfig.playerWidth > obstacle.x && player.y < obstacle.y + gameConfig.obstacleHeight && player.y + gameConfig.playerHeight > obstacle.y) {
                    score = Math.max(0, score - gameConfig.scoreLostOnHit);
                    obstacles.splice(index, 1);
                }
            });
            loadingScoreDisplay.textContent = `Ofrendas: ${score} | Nivel: ${level}`;
        }
        function checkLevelUp() { /* ... (igual que antes, solo cambia texto log) */
            const nextLevelThreshold = level * gameConfig.levelUpScore;
            if (score >= nextLevelThreshold) {
                level++;
                currentObstacleSpeed = Math.min(gameConfig.obstacleMaxSpeed*1.5, gameConfig.obstacleMinSpeed + (level-1)*gameConfig.maxSpeedIncreasePerLevel);
                currentItemSpeed = currentObstacleSpeed * gameConfig.itemSpeedMultiplier;
                currentObstacleSpawnRate = Math.min(0.06, gameConfig.spawnRateObstacles + (level-1)*gameConfig.maxSpawnRateIncreasePerLevel);
                currentItemSpawnRate = Math.min(0.07, gameConfig.spawnRateItems + (level-1)*gameConfig.maxSpawnRateIncreasePerLevel);
                console.log(`Aztec Level Up! Lvl: ${level}, Speed: ${currentObstacleSpeed.toFixed(2)}, Spawn: ${currentObstacleSpawnRate.toFixed(4)}`);
                gameCanvas.style.borderColor = ['#FFD700', '#40E0D0', '#B22222'][level % 3];
                setTimeout(() => { gameCanvas.style.borderColor = 'var(--color-secondary)'; }, 300);
            }
        }

        function drawGame() { /* ... (Dibuja elementos aztecas) */
             if (!isGameRunning || !gameCtx) return;
             // Clear Canvas
             gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
             // Background
             const grad = gameCtx.createLinearGradient(0, 0, 0, gameCanvas.height);
             grad.addColorStop(0, '#F0E68C'); // Khaki (cielo atardecer)
             grad.addColorStop(1, '#CD853F'); // Peru (tierra)
             gameCtx.fillStyle = grad;
             gameCtx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

             // Draw Player (simple rect, color cambia)
             gameCtx.fillStyle = player.color;
             gameCtx.fillRect(player.x, player.y, gameConfig.playerWidth, gameConfig.playerHeight);
             // Simple penacho
             gameCtx.fillStyle = '#32CD32'; // LimeGreen
             gameCtx.fillRect(player.x + gameConfig.playerWidth * 0.4, player.y - 10, 5, 15);

             // Draw Items
             items.forEach(item => {
                 if (item.type === 'maize') { // Mazorca amarilla
                     gameCtx.fillStyle = '#FFD700'; gameCtx.fillRect(item.x, item.y, gameConfig.itemSize * 0.6, gameConfig.itemSize);
                 } else if (item.type === 'feather') { // Pluma verde
                     gameCtx.fillStyle = '#32CD32'; gameCtx.beginPath(); gameCtx.moveTo(item.x, item.y); gameCtx.quadraticCurveTo(item.x + gameConfig.itemSize / 2, item.y + gameConfig.itemSize * 1.5, item.x + gameConfig.itemSize, item.y); gameCtx.closePath(); gameCtx.fill();
                 } else { // Jade (círculo verde)
                     gameCtx.fillStyle = '#2E8B57'; gameCtx.beginPath(); gameCtx.arc(item.x + gameConfig.itemSize / 2, item.y + gameConfig.itemSize / 2, gameConfig.itemSize / 2, 0, Math.PI * 2); gameCtx.fill();
                 }
             });
             // Draw Obstacles
             obstacles.forEach(obstacle => {
                 if (obstacle.type === 'obsidian') { // Fragmento negro
                     gameCtx.fillStyle = '#1C1C1C'; gameCtx.beginPath(); gameCtx.moveTo(obstacle.x, obstacle.y); gameCtx.lineTo(obstacle.x + gameConfig.obstacleWidth, obstacle.y + gameConfig.obstacleHeight / 2); gameCtx.lineTo(obstacle.x, obstacle.y + gameConfig.obstacleHeight); gameCtx.closePath(); gameCtx.fill();
                 } else { // Cráneo blanco
                     gameCtx.fillStyle = '#FFFFFF'; gameCtx.fillRect(obstacle.x, obstacle.y, gameConfig.obstacleWidth, gameConfig.obstacleHeight);
                     gameCtx.fillStyle = '#000000'; // Ojos/nariz
                     gameCtx.fillRect(obstacle.x + 5, obstacle.y + 5, 5, 5); gameCtx.fillRect(obstacle.x + gameConfig.obstacleWidth - 10, obstacle.y + 5, 5, 5); gameCtx.fillRect(obstacle.x + gameConfig.obstacleWidth / 2 - 3, obstacle.y + 10, 6, 6);
                 }
             });
         }

        function gameLoop() { /* ... (igual) */ if(!isGameRunning)return;updateGame();drawGame();gameLoopId=requestAnimationFrame(gameLoop);}
        function startGameLoop() { /* ... (igual) */ if(isGameRunning)return;console.log("Starting Aztec Game Loop");isGameRunning=true;resetGame();document.addEventListener('keydown',handleKeyDown);document.addEventListener('keyup',handleKeyUp);gameLoopId=requestAnimationFrame(gameLoop);modalLoadingIndicator.classList.add('active');gameCanvas.style.display='block';}
        function stopGameLoop() { /* ... (igual) */ if(!isGameRunning)return;console.log("Stopping Aztec Game Loop");isGameRunning=false;if(gameLoopId){cancelAnimationFrame(gameLoopId);gameLoopId=null;}document.removeEventListener('keydown',handleKeyDown);document.removeEventListener('keyup',handleKeyUp);}

        // ========== NEW: AD FILTER FUNCTION ==========
        function filterAds(rawText) {
            if (!rawText) return '';
            const lines = rawText.split('\n');
            const filteredLines = lines.filter(line => {
                // Check against each pattern
                for (const pattern of adPatterns) {
                    if (pattern.test(line)) {
                        console.log("Ad Filtered Line:", line.substring(0, 50) + "..."); // Log filtered line (optional)
                        return false; // Exclude this line
                    }
                }
                 // Keep line if no pattern matched
                 return true;
             });

             // Adicional: eliminar múltiples saltos de línea seguidos que puedan quedar
             let cleanedText = filteredLines.join('\n');
             cleanedText = cleanedText.replace(/\n\s*\n\s*\n+/g, '\n\n'); // Replace 3+ newlines with 2

             return cleanedText.trim();
         }

        // ========== API FUNCTIONS ========== (Igual, solo cambia nombre de contexto)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             // Usa currentTopicTitle para el contexto del chat
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Eres un experto en religión azteca respondiendo preguntas sobre '${currentTopicTitle}'. Sé conciso y relevante al tema.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             // ... resto de la función fetchTextFromApi (sin cambios funcionales)
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores están experimentando mucho tráfico. Por favor, intenta de nuevo en unos segundos.`);
                 const text = await response.text();
                 if (!text || text.trim().length < (isChat ? 10 : 500)) throw new Error("La respuesta de la IA fue demasiado corta o vacía. Intenta de nuevo.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId); console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión.`);
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
         }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Error interno: Contexto del tema no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(aztecReligionThemes) || "mitología azteca";
             const specificPrompt = `Genera 40 términos específicos (dioses, mitos, rituales, conceptos) sobre ${randomTheme} en la religión azteca.`;
             console.log("Generating 40 titles with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                  .then(text => {
                      const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150 && !/^[\[\(]/.test(line) && !/^\d+\s/.test(line)).slice(0, 40);
                      if (titles.length < 15) throw new Error("La IA no generó suficientes términos válidos.");
                      return titles;
                  });
         }
         function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 896, height: 640, nologo: true }; // Ratio más cercano a códice
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Aztec ceremony";
            // Prompt adaptado a estilo azteca
            const enhancedPrompt = `Aztec codex style illustration OR stone carving relief depicting '${safePromptText}'. Use traditional colors (red ochre, turquoise, gold, black, white). Geometric patterns, feathers, hieroglyphs, iconography related to the theme. Symbolic representation, flat perspective.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "photorealistic, photograph, 3D render, modern style, realistic human figures, multiple images, collage, text, words, labels, signature, watermark, blurry, low quality";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
         }


        // ========== Text Formatting Function ========== (sin cambios funcionales)
        function formatExplanationText(rawText){ if(!rawText)return'';let formatted=rawText.trim();formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1');formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('−','-');return`${base}<sup>${cleanExponent}</sup>`;});formatted=formatted.replace(/\\rightarrow/g,'&rarr;');formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>');const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0);formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block;let content=block.replace(/\n/g,' ');return`<p>${content}</p>`;}).join('');return formatted;}

        // ========== MODAL, FULLSCREEN, CHAT FUNCTIONS ========== (Sin cambios funcionales, solo contexto)
        function showModal() { /* ... (igual) */ storyModal.classList.add('active');document.body.style.overflow='hidden'; }
        function hideModal() { /* ... (igual) */ stopGameLoop();storyModal.classList.remove('active');if(!imageFullscreenOverlay.classList.contains('active')){document.body.style.overflow='';}modalTextArea.scrollTop=0;resetModalState();}
        function resetModalState() { /* ... (igual, usa currentTopicTitle) */ stopGameLoop();modalLoadingIndicator.classList.remove('active');modalStoryContentArea.classList.remove('visible');modalStoryContentArea.classList.add('content-hidden');modalError.classList.add('content-hidden');modalTitle.textContent='';modalContent.innerHTML='';modalErrorMessage.textContent='';chatHistory.innerHTML='';chatInput.value='';chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;currentTopicTitle=null;hideFullscreenImage();}
        function showFullscreenImage(imgSrc){ /* ... (igual) */ if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden';}
        function hideFullscreenImage(){ /* ... (igual) */ if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src='';}
        function addChatMessage(message, sender){ /* ... (igual) */ const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        function addChatError(message){ /* ... (igual) */ const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        async function handleSendMessage(){ /* ... (igual) */ const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Error IA: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}}

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title) { const div=document.createElement('div');div.className='title-item';div.textContent=title;div.setAttribute('data-title',title);div.addEventListener('click',()=>handleTitleClick(title));return div; }
        function displayTitles(titles) { /* ... (igual) */ if(!titleListContainer||!titlesLoading)return;const sortedTitles=titles.sort((a,b)=>a.localeCompare(b));titleListContainer.innerHTML='';titlesLoading.style.display='none';if(sortedTitles.length===0){titleListContainer.innerHTML='<p class="text-gray-500 col-span-full text-center font-sans">» No hay temas disponibles. ¡Intenta generar más! «</p>';return;}sortedTitles.forEach(title=>titleListContainer.appendChild(createTitleItem(title)));console.log(`Displayed ${sortedTitles.length} titles.`);}
        function appendTitles(newTitles) { /* ... (igual) */ if(!titleListContainer||!newTitles||newTitles.length===0)return;console.log(`Appending ${newTitles.length} new titles.`);const existingTitles=new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item=>item.dataset.title));let addedCount=0;newTitles.forEach(title=>{if(!existingTitles.has(title)){titleListContainer.appendChild(createTitleItem(title));addedCount++;}});console.log(`Successfully added ${addedCount} unique titles.`);filterTitles(searchInput.value);}

        // *** MODIFIED: handleTitleClick to include ad filtering ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // Set context for chat
            chatHistory.innerHTML = '';

            // Start Loading & Game
            modalLoadingIndicator.classList.add('active');
            startGameLoop();

            try {
                // Fetch text (no await yet)
                const explanationPromise = fetchExplanationText(title);

                // Fetch image URL
                const imageUrl = createPollinationsImageUrl(title);

                // Await text fetching
                const rawExplanationText = await explanationPromise;

                // *** FILTER ADS ***
                const adFilteredText = filterAds(rawExplanationText);

                // Stop Game & Show Content
                stopGameLoop();
                modalLoadingIndicator.classList.remove('active');
                modalStoryContentArea.classList.add('visible');
                modalStoryContentArea.classList.remove('content-hidden');

                // Process and display filtered text
                const formattedExplanation = formatExplanationText(adFilteredText); // Use filtered text
                modalContent.innerHTML = formattedExplanation;
                modalTextArea.scrollTop = 0;

                // Image Handling (same as before)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-landmark placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Generando representación visual...</p>`; // Icono Landmark/Pirámide
                modalContent.appendChild(placeholderDiv);

                if (imageUrl) {
                    const imgElement = document.createElement('img');
                    imgElement.className = 'final-image';
                    imgElement.alt = `Representación de ${title}`;
                    imgElement.style.display = 'none';
                    imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                    imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al cargar imagen.</p>`; };
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                    placeholderDiv.innerHTML = `<i class="fas fa-ban placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo generar URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                stopGameLoop();
                modalLoadingIndicator.classList.remove('active');
                modalStoryContentArea.classList.add('visible');
                modalStoryContentArea.classList.remove('content-hidden');
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el tema.";
                modalError.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() { /* ... (igual, solo cambia texto botón) */
             if(!generateMoreBtn||!generateMoreSpinner||!generateMoreContainer)return;generateMoreBtn.disabled=true;generateMoreBtn.innerHTML='<i class="fas fa-sync-alt mr-2 animate-spin"></i> Descifrando Jeroglíficos...';try{const newTitles=await fetchGeneratedTitles();if(newTitles&&newTitles.length>0){appendTitles(newTitles);}else{alert("No se pudieron revelar más conocimientos ahora.");}}catch(error){console.error("Failed title generation:",error);alert(`Error al generar conocimientos: ${error.message}`);}finally{generateMoreBtn.disabled=false;generateMoreBtn.innerHTML='<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Revelar 40 Nuevos Conocimientos';}
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) { /* ... (igual) */ const term=searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();const titleItems=titleListContainer.querySelectorAll('.title-item');let visibleCount=0;titleItems.forEach(item=>{const titleText=item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");const isVisible=titleText.includes(term);item.classList.toggle('hidden',!isVisible);if(isVisible)visibleCount++;});noResultsMsg.classList.toggle('hidden',visibleCount>0||titleItems.length===0);}

        // ========== INITIALIZATION ==========
        function initApp() { /* ... (igual) */ if(!titleListContainer||!storyModal||!modalCloseBtn||!generateMoreBtn||!titlesLoading||!searchInput||!noResultsMsg||!chatInput||!chatSendBtn||!imageFullscreenOverlay||!fullscreenCloseBtn||!gameCanvas||!loadingScoreDisplay){console.error("Initialization failed: Missing essential elements.");document.body.innerHTML='<p style="color:red;font-size:1.5em;text-align:center;padding-top:3em;">Error Fatal: Faltan componentes de la interfaz.</p>';return;}modalCloseBtn.addEventListener('click',hideModal);storyModal.addEventListener('click',(event)=>{if(event.target===storyModal)hideModal();});generateMoreBtn.addEventListener('click',handleGenerateMoreTitles);searchInput.addEventListener('input',(event)=>filterTitles(event.target.value));searchInput.addEventListener('keypress',(event)=>{if(event.key==='Enter')event.preventDefault();});chatSendBtn.addEventListener('click',handleSendMessage);chatInput.addEventListener('keypress',(event)=>{if(event.key==='Enter')handleSendMessage();});imageFullscreenOverlay.addEventListener('click',hideFullscreenImage);fullscreenCloseBtn.addEventListener('click',(event)=>{event.stopPropagation();hideFullscreenImage();});displayTitles(predefinedTitles);noResultsMsg.classList.add('hidden');}
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>