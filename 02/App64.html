<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glosario de Derecho Internacional Humanitario (DIH)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para DIH --- */
        :root {
            --color-primary: #0d47a1; /* Azul Oscuro (seriedad, ley) */
            --color-secondary: #c62828; /* Rojo Oscuro (humanitario, cruz roja - abstracto) */
            --color-background: #eceff1; /* Gris muy claro */
            --color-text: #263238; /* Gris oscuro azulado */
            --color-text-muted: #546e7a;
            --color-modal-bg: #ffffff;
            --color-border: #cfd8dc;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 5px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.6; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; } /* Serif para títulos -> más formal */
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Lato', sans-serif; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #e3f2fd; /* Light blue hover */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #0b3a87; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #90a4ae; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(38, 50, 56, 0.85); /* Darker overlay */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            min-height: 300px; /* <<--- ALTURA MÍNIMA AÑADIDA */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #b0bec5; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.5rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #90a4ae; color: #ffffff; }
        #modal-title { color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1.5rem; font-size: 1.8rem; line-height: 1.3; }
        #modal-content { line-height: 1.75; color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 15px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content::-webkit-scrollbar { width: 9px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: bold; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        #modal-content .formula { text-align: center; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 1.1em; padding: 0.8em; margin: 1.2em 0; border: 1px solid var(--color-border); background-color: #f5f5f5; border-radius: var(--border-radius); overflow-x: auto; white-space: nowrap; }
        #modal-content .formula sub, #modal-content .formula sup { font-size: 0.8em; line-height: 0; position: relative; vertical-align: baseline; }
        #modal-content .formula sub { top: 0.5em; }
        #modal-content .formula sup { top: -0.5em; }
        #modal-image-container { width: 100%; height: 250px; background-color: #cfd8dc; border-radius: var(--border-radius); overflow: hidden; display: none; align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; margin-top: 1.5rem; }
        #modal-image-container.visible { display: flex; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 3rem; color: #78909c; display: none; }
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid #b0bec5; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.2rem; font-family: 'Lato'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #ffcdd2; color: #c62828; padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #ef9a9a; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-4 flex justify-center items-center">
             <div class="flex items-center text-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-balance-scale-left mr-3"></i>
                     Glosario de DIH
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Entendiendo el Derecho en la Guerra</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto">Explora los términos clave del Derecho Internacional Humanitario (DIH) con definiciones detalladas generadas por IA. Selecciona un concepto para empezar.</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-book-open text-red-700 mr-2"></i>
                 Términos Fundamentales
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Consultando archivos...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Términos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Elaborando definición...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                 </div>
                  <!-- Image Container (Initially Hidden) -->
                 <div id="modal-image-container">
                     <div class="spinner"></div>
                      <i class="fas fa-gavel placeholder-icon"></i>
                     <img id="modal-image" alt="Visualización conceptual abstracta del término DIH" />
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-700 py-6 mt-12 border-t border-gray-300">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Definiciones generadas por IA con fines informativos y educativos sobre DIH. Este contenido no constituye asesoramiento legal.</p>
              <p class="mt-1">Consulte siempre fuentes oficiales y expertos en DIH para aplicaciones prácticas.</p>
              <p class="mt-2">© 2025 Glosario DIH</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Principios Fundamentales
            "¿Qué es el Derecho Internacional Humanitario (DIH)?", "Principio de Distinción: Civiles vs. Combatientes", "Principio de Proporcionalidad en el Ataque", "Principio de Necesidad Militar", "Principio de Humanidad", "Principio de Precaución en el Ataque", "Cláusula Martens: ¿Qué establece?", "Relación entre DIH y Derechos Humanos", "Fuentes del DIH (Convenios, Costumbre, Principios)", "Ius ad bellum vs. Ius in bello",
            // Tipos de Conflictos Armados
            "Conflicto Armado Internacional (CAI): Definición y Características", "Conflicto Armado No Internacional (CANI): Definición y Características", "Umbral de Aplicación del DIH en CANI", "Situaciones de Violencia Interna que NO alcanzan el umbral de CANI", "Guerra de Liberación Nacional como CAI", "Ocupación Beligerante: Definición y Régimen Jurídico", "Aplicabilidad del DIH a Nuevas Formas de Guerra (Ciberguerra, Drones)",
            // Personas Protegidas
            "¿Quiénes son considerados Civiles?", "Protección General de la Población Civil", "Objetos Civiles y su Protección", "Ataques Indiscriminados: ¿Qué son?", "¿Qué es la Participación Directa en las Hostilidades (PDH)?", "Pérdida de Protección Civil por PDH", "Definición de Combatiente", "Estatuto de Prisionero de Guerra (PdG)", "Trato debido a los Prisioneros de Guerra", "Derechos y Obligaciones de los Prisioneros de Guerra", "Internamiento de Civiles: Condiciones", "Protección de los Heridos y Enfermos", "Protección de los Náufragos", "Búsqueda y Recogida de Heridos, Enfermos y Náufragos", "Personal Sanitario y Religioso: Estatuto y Protección", "Unidades y Medios de Transporte Sanitario: Protección", "Emblemas Protectores (Cruz Roja, Media Luna Roja, Cristal Rojo)", "Uso Indebido de los Emblemas Protectores", "Protección de las Mujeres en Conflictos Armados", "Protección de los Niños en Conflictos Armados", "Reclutamiento y Utilización de Niños Soldado", "Personas Desaparecidas y Derecho de Familiares a Saber", "Restos Mortales: Trato y Gestión", "Personas Privadas de Libertad (Distintas a PdG)", "Refugiados en el Contexto del DIH", "Desplazados Internos en el Contexto del DIH", "Personal Humanitario y su Protección",
            // Medios y Métodos de Guerra
            "Prohibición General de Causar Males Superfluos o Sufrimientos Innecesarios", "Armas Prohibidas Específicamente (Balas Explosivas, Armas Químicas, Biológicas, Láser Cegadoras)", "Minas Antipersonal: Prohibición (Convención de Ottawa)", "Municiones en Racimo: Restricciones y Prohibiciones (Convención de Oslo)", "Armas Incendiarias: Limitaciones de Uso", "Restos Explosivos de Guerra (REG): Obligaciones", "Métodos de Guerra Prohibidos: Perfídia", "Prohibición de Dar Orden de No Dar Cuartel", "Uso Indebido de Banderas, Insignias y Uniformes", "Toma de Rehenes: Prohibición Absoluta", "Escudos Humanos: Prohibición", "Pillaje: Prohibición", "Destrucción Injustificada de Bienes del Adversario", "Ataques contra Bienes Indispensables para la Supervivencia Civil", "Protección del Medio Ambiente Natural en Conflictos Armados", "Obras e Instalaciones que Contienen Fuerzas Peligrosas (Presas, Diques, Centrales Nucleares)", "Bienes Culturales: Protección General y Especial", "Señalización de Bienes Culturales", "Asedio y Bloqueo como Métodos de Guerra", "Inanición de la Población Civil como Método de Guerra", "Guerra Naval: Normas Específicas", "Guerra Aérea: Normas Específicas", "Zona Desmilitarizada", "Zona Neutralizada", "Localidades No Defendidas",
            // Implementación y Cumplimiento
            "Obligación de Respetar y Hacer Respetar el DIH", "Difusión del DIH", "Formación de las Fuerzas Armadas en DIH", "Asesores Jurídicos en las Fuerzas Armadas", "Legislación Nacional de Aplicación del DIH", "Potencias Protectoras: Función y Designación", "El Comité Internacional de la Cruz Roja (CICR): Mandato y Rol", "Sustitutos de las Potencias Protectoras", "Investigación de Presuntas Violaciones del DIH", "Comisión Internacional Humanitaria de Encuesta", "Represión de las Violaciones del DIH", "Infracciones Graves de los Convenios de Ginebra", "Crímenes de Guerra: Definición y Tipos", "Jurisdicción Universal sobre Crímenes de Guerra", "Responsabilidad Penal Individual por Crímenes de Guerra", "Responsabilidad del Mando o del Superior", "Defensas ante Cargos por Crímenes de Guerra (Órdenes Superiores, Necesidad Militar)", "Crímenes contra la Humanidad (Relación con DIH)", "Genocidio (Relación con DIH)", "La Corte Penal Internacional (CPI): Competencia sobre Crímenes de Guerra", "Tribunales Penales Internacionales Ad Hoc (TPIY, TPIR)", "Tribunales Mixtos o Híbridos", "Amnistías y su Limitación frente a Crímenes Internacionales", "Reparaciones a las Víctimas de Violaciones del DIH",
            // Conceptos Relacionados y Específicos
            "Neutralidad en el DIH", "Alto el Fuego vs. Armisticio vs. Acuerdo de Paz", "Capitulación", "Derecho de Visita e Inspección (Guerra Naval)", "Contrabando de Guerra", "Represalias en DIH: Condiciones y Limitaciones", "Estado de Necesidad vs. Necesidad Militar", "Inteligencia Artificial y Armas Autónomas en DIH", "Protección de Datos en Contextos Humanitarios", "Acción Humanitaria: Principios (Humanidad, Imparcialidad, Neutralidad, Independencia)", "Acceso Humanitario: Consentimiento y Obstáculos", "DIH y Operaciones de Mantenimiento de la Paz (ONU)", "Terrorismo y DIH: ¿Cómo se relacionan?", "Empresas Militares y de Seguridad Privadas (EMSP) y el DIH",
            // Tratados y Orígenes
            "Los Convenios de Ginebra de 1949 (I, II, III, IV)", "Artículo 3 Común a los Convenios de Ginebra", "Protocolo Adicional I de 1977 (Conflictos Armados Internacionales)", "Protocolo Adicional II de 1977 (Conflictos Armados No Internacionales)", "Protocolo Adicional III de 2005 (Emblema Adicional)", "Las Convenciones de La Haya de 1899 y 1907", "Convención sobre Ciertas Armas Convencionales (CCAC) y sus Protocolos", "Estatuto de Roma de la Corte Penal Internacional", "Orígenes del DIH: Henry Dunant y la Batalla de Solferino", "El Papel de la Costumbre Internacional en el DIH", "¿Es el DIH Realmente Efectivo?", "Desafíos Actuales para el DIH"
             // Añadir más títulos aquí manualmente o confiar en "Generar Más" para complementar
        ];
        const dihThemes = [
            "principios fundamentales del DIH", "personas protegidas por el DIH", "bienes protegidos por el DIH",
            "métodos de guerra prohibidos", "armas prohibidas o restringidas", "tipos de conflictos armados",
            "implementación del DIH", "represión de violaciones del DIH", "crímenes de guerra",
            "el rol del CICR", "los Convenios de Ginebra", "los Protocolos Adicionales",
            "protección de grupos vulnerables (niños, mujeres)", "ocupación beligerante",
            "el estatuto de combatiente y prisionero de guerra", "la cláusula Martens",
            "relación entre DIH y Derechos Humanos", "nuevos desafíos para el DIH (ciberguerra, drones)",
            "acción humanitaria y DIH", "neutralidad", "derecho consuetudinario humanitario"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un experto jurista y académico especializado en Derecho Internacional Humanitario (DIH). Tu tarea es definir y explicar términos clave del DIH de forma exhaustiva, precisa, clara y estructurada para un público amplio (estudiantes, profesionales no especializados, público general interesado). Utiliza un lenguaje formal pero accesible, cita (de forma general, sin necesidad de notas al pie) los instrumentos jurídicos relevantes (Convenios de Ginebra, Protocolos Adicionales, costumbre, etc.) cuando sea pertinente. Incluye ejemplos hipotéticos o históricos (sin tomar partido político) para ilustrar los conceptos. Estructura la explicación con lógica, usando párrafos claros y subtítulos (con markdown #, ##, ###) para organizar la información. El objetivo es una definición detallada y completa de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente término o concepto del DIH:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un glosario. Genera exactamente 15 términos o preguntas clave sobre Derecho Internacional Humanitario (DIH), adecuados para ser explicados detalladamente. Devuelve *solo* la lista de términos/preguntas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // --- Variable to hold the current scroll listener ---
        let currentScrollHandler = null;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) {
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo más tarde o con otro término.`);
                 throw new Error(`Error de comunicación con la API: ${error.message}`);
             }
        }
        async function fetchExplanationText(conceptTitle) {
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de")) {
                   throw new Error("La IA no pudo generar una explicación adecuada o suficientemente detallada para este término.");
               }
             return text;
         }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(dihThemes) || "conceptos clave del DIH";
             const specificPrompt = `Genera 15 términos o preguntas clave sobre ${randomTheme}`;
             console.log("Generating titles with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150);
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de términos.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "international humanitarian law concept abstract";
             const enhancedPrompt = `Abstract conceptual art representing '${safePromptText}'. Symbolic, minimalist style focusing on themes of law, protection, humanity, neutrality, or conflict resolution. Use elements like scales, shields, doves, balanced shapes, interconnected lines, abstract red cross/crescent motif. Avoid realistic depictions.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, graphs, charts, diagrams, people, soldiers, weapons, guns, tanks, planes, blood, gore, violence, injury, death, suffering, specific flags, national symbols, political figures, realistic photo, map, specific location, court room, judge, gavel realistic";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }

        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll
            console.log("Scroll set to 0 on hideModal");
            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
                console.log("Scroll listener removed on hideModal.");
            }
            resetModalState();
        }

        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.classList.remove('visible');
             modalImageContainer.style.display = 'none';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
            if (!titleListContainer || !titlesLoading) return;
            const shuffledTitles = shuffleArray([...titles]);
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay términos disponibles.</p>'; return; }
            shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalImageContainer.style.display = 'none';
            modalImageContainer.classList.remove('visible');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
            }

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalContent.scrollTop = 0; // Reset scroll after content visible
                console.log("Scroll set to 0 after content visible");

                // Prepare image (hidden)
                modalImageSpinner.style.display = 'block';
                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL:", title);
                     modalImageSpinner.style.display = 'none';
                     modalImagePlaceholder.style.display = 'block';
                 }

                // Setup scroll listener for conditional image visibility
                const scrollBuffer = 20;
                currentScrollHandler = () => {
                    const isScrollable = modalContent.scrollHeight > modalContent.clientHeight;
                    const isAtBottom = (modalContent.scrollTop + modalContent.clientHeight) >= (modalContent.scrollHeight - scrollBuffer);

                    if (!isScrollable || isAtBottom) {
                         if (!modalImageContainer.classList.contains('visible')) {
                             console.log(`Showing image. Scrollable: ${isScrollable}, At Bottom: ${isAtBottom}`);
                             modalImageContainer.classList.add('visible');
                             modalImageContainer.style.display = 'flex';
                         }
                         if ((isScrollable || !isScrollable) && currentScrollHandler) { // Remove if at bottom OR if never scrollable
                            modalContent.removeEventListener('scroll', currentScrollHandler);
                            currentScrollHandler = null;
                            console.log("Scroll listener removed.");
                         }
                     }
                };
                modalContent.addEventListener('scroll', currentScrollHandler);
                console.log("Scroll listener added.");
                setTimeout(currentScrollHandler, 150); // Initial check

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = '';
                 if (currentScrollHandler) {
                    modalContent.removeEventListener('scroll', currentScrollHandler);
                    currentScrollHandler = null;
                 }
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block';
                 } else {
                     alert("No se pudieron generar nuevos términos en este momento.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar términos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Términos';
             }
         }


        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p>Error crítico inicializando la aplicación.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>