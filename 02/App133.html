<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Orden Mundial 2030 - Análisis Prospectivo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes - Más sobrias/digitales -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&family=Aldrich&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para NWO 2030 --- */
        :root {
            --color-primary: #ff8c00; /* Naranja Oscuro/Ámbar (Precaución/Alerta) */
            --color-secondary: #00aaff; /* Azul Digital Claro (Tecnología) */
            --color-tertiary: #e53e3e; /* Rojo (Énfasis/Crítico - uso MUY moderado) */
            --color-background: #1a202c; /* Gris Muy Oscuro/Casi Negro Azulado */
            --color-modal-bg: #2d3748; /* Gris Oscuro */
            --color-text: #e2e8f0; /* Gris Muy Claro */
            --color-text-muted: #a0aec0; /* Gris Medio */
            --color-border: #4a5568; /* Borde Gris Medio-Oscuro */
            --color-error-bg: #451a1a; /* Fondo error rojo muy oscuro */
            --color-error-text: #fed7d7; /* Texto error claro */
            --color-error-border: #c53030; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(255, 140, 0, 0.08);
            --shadow-md: 0 4px 6px -1px rgba(255, 140, 0, 0.1), 0 2px 4px -2px rgba(255, 140, 0, 0.08);
            --shadow-lg: 0 0 20px -5px rgba(255, 140, 0, 0.15), 0 8px 10px -6px rgba(255, 140, 0, 0.1);
            --border-radius: 2px; /* Bordes más rectos */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Roboto Condensed', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 300; /* background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%234A5568" fill-opacity="0.07"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); */ /* Optional subtle background grid */ }
        h1, h2, h3, h4, .logo { font-family: 'Aldrich', sans-serif; font-weight: 400; /* Aldrich es a menudo solo 400 */ letter-spacing: 0.5px; text-transform: uppercase; }
        .logo { color: var(--color-primary); text-shadow: 0 0 6px rgba(255, 140, 0, 0.5); }
        h1.page-title { color: var(--color-primary); font-weight: 400; text-shadow: 0 0 4px rgba(255, 140, 0, 0.4); }
        h2.section-title { color: var(--color-text); border-bottom: 1px solid var(--color-primary); padding-bottom: 0.5rem; display: inline-block; font-weight: 400; }
        #modal-title { color: var(--color-primary); font-weight: 400; text-shadow: 0 0 2px rgba(255, 140, 0, 0.3); }
        .navbar { background-color: rgba(26, 32, 44, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #2d3748; color: var(--color-text); box-shadow: inset 0 1px 2px rgba(0,0,0,0.2); transition: var(--transition-normal); font-family: 'Roboto Condensed'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(255, 140, 0, 0.3); outline: none; background-color: #1a202c; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1rem 1.2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); min-height: 60px; font-family: 'Roboto Condensed'; font-size: 0.95rem; border-left: 2px solid var(--color-border); }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #1a202c; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-background); padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Aldrich', sans-serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-transform: uppercase; letter-spacing: 1px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #e67e00; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { /* Similar a antes, ajustar overlay */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 32, 44, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-top: 3px solid var(--color-primary); /* Énfasis arriba */
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 1000px; /* Ligeramente más ancho */
            width: 96%;
            max-height: 90vh;
            min-height: 450px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; transition: var(--transition-normal); z-index: 60; padding: 5px; line-height: 1; }
        .modal-close-btn:hover { color: var(--color-primary); transform: rotate(90deg); }
        #modal-title { font-size: 1.7rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 6px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: normal; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Aldrich', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 400; text-transform: uppercase; }
        #modal-content h1 { font-size: 1.4em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.1em; color: var(--color-text-muted); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; font-style: italic; text-transform: none; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: opacity 0.3s ease; opacity: 0.9; }
        #modal-content .final-image:hover { opacity: 1; box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid var(--color-border); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; opacity: 0.7; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* Más altura para chat */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #1a202c; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.5; font-size: 0.9rem; font-family: 'Roboto Condensed'; }
        .user-message { background-color: var(--color-primary); color: var(--color-background); margin-left: auto; text-align: left; font-weight: 400; box-shadow: var(--shadow-sm); }
        .ai-message { background-color: #4a5568; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.85em; padding: 0.3rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #1a202c; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Roboto Condensed'; font-size: 0.9rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 2px rgba(0, 170, 255, 0.2); }
        #chat-send-btn { padding: 0.7rem 1rem; background-color: var(--color-secondary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #0090dd; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { /* Similar a antes */ text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 32, 44, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.2rem; font-family: 'Aldrich'; text-transform: uppercase; letter-spacing: 1px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.1rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Roboto Condensed'; font-size: 0.95rem;}
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { /* Similar a antes */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(15, 20, 30, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 1px solid var(--color-border); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { /* Similar a antes */ position: absolute; top: 15px; right: 20px; background: rgba(45, 55, 72, 0.7); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-globe-americas mr-3"></i> <!-- Icono globo -->
                     NWO 2030 // Análisis
                 </h1>
             </div>
             <span class="text-xs text-gray-500 font-sans tracking-wider">Plataforma de Análisis Prospectivo Global</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Escenarios Globales Hacia 2030</h1>
             <p class="text-lg text-gray-400 mb-8 max-w-3xl mx-auto font-light">Exploración de tendencias geopolíticas, tecnológicas y socioeconómicas que podrían configurar la próxima década.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar tema o concepto clave...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-folder-open text-amber-500 mr-2"></i> <!-- Icono carpeta -->
                 Índice Temático
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando vectores de análisis...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">// No se encontraron coincidencias para los parámetros de búsqueda //</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Cargar Vectores Adicionales
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Procesando Información...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                    <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-2 text-center font-aldrich border-b border-gray-600 pb-1">Análisis Adicional</h3>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                         <p class="text-xs text-gray-500 text-center p-4">Inicia una consulta sobre este tema específico...</p>
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Consulta sobre [tema actual]...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada Conceptual">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-800 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-xs">
              <p>Esta plataforma utiliza IA para explorar y analizar posibles tendencias y escenarios futuros basados en información pública y conceptos especulativos.</p>
              <p class="mt-1">El contenido generado no constituye una predicción definitiva ni una afirmación de hechos. Se recomienda el análisis crítico y la consulta de fuentes diversas.</p>
              <p class="mt-2">© 2030 Horizon Scanning Initiative [HSI]</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Gobernanza Global y Geopolítica
            "Agenda 2030: Objetivos de Desarrollo Sostenible (ODS)", "El Gran Reinicio (Great Reset): Concepto y Críticas", "Foro Económico Mundial (WEF): Influencia y Agenda", "Rol de las Naciones Unidas (ONU) en 2030", "Organización Mundial de la Salud (OMS): Poder y Tratados", "Gobernanza Global vs. Soberanía Nacional", "Surgimiento de Bloques de Poder Regional (BRICS+, UE, AUKUS)", "Declive de la Hegemonía Estadounidense: Escenarios", "Ascenso de China: Impacto Global", "El Futuro de la Unión Europea", "Tratados Internacionales y Pérdida de Soberanía", "Tribunales Internacionales y Justicia Global", "Migración Global: Políticas y Control", "Ciudades Globales Inteligentes (Smart Cities): Visión y Control", "Estado Profundo (Deep State): Teorías y Evidencias", "Grupos de Poder Supranacionales (Bilderberg, Trilateral)", "Desarme Global vs. Remilitarización", "El Papel de las ONGs en la Gobernanza Global", "Diplomacia Digital y Ciber-influencia", "Guerras Híbridas y Conflicto Asimétrico",
            // Economía y Finanzas
            "Monedas Digitales de Banco Central (CBDC): Implementación", "CBDC: Potencial de Control y Vigilancia", "Hacia una Sociedad Sin Efectivo (Cashless Society)", "Sistema de Crédito Social: Modelo Chino y Expansión", "Renta Básica Universal (RBU): Viabilidad y Control", "Impacto de la Automatización en el Empleo", "Cuarta Revolución Industrial: Implicaciones Sociales", "Tokenización de Activos y Propiedad", "Mercados de Carbono y Créditos Sociales/Ambientales", "Colapso del Sistema Financiero Tradicional: Escenarios", "Deuda Global y Control Financiero (FMI, Banco Mundial)", "El Futuro del Trabajo: Gig Economy y Precariedad", "Concentración Corporativa Global (Megacorporaciones)", "Control de Recursos Naturales Estratégicos", "Geoingeniería y Control Climático: Aspectos Económicos", "Economía Circular: Oportunidad o Control?", "Impuestos Globales y Armonización Fiscal", "Paraísos Fiscales y Flujos Financieros Ilícitos", "Finanzas Descentralizadas (DeFi) vs. Control Centralizado", "Impacto Económico de Pandemias Futuras",
            // Tecnología y Control
            "Inteligencia Artificial (IA) y Gobernanza Algorítmica", "Superinteligencia Artificial: Riesgos Existenciales", "Vigilancia Masiva Estatal y Corporativa", "Reconocimiento Facial y Biometría Masiva", "Identidad Digital Universal: Beneficios y Pelgos", "Pasaportes Digitales (Salud, Viajes, Acceso)", "Internet de las Cosas (IoT) y Red de Vigilancia Total", "Control y Censura de Internet (Splinternet)", "Computación Cuántica: Impacto en Criptografía y Seguridad", "Transhumanismo: Mejora Humana vs. Deshumanización", "Interfaces Cerebro-Computadora (BCI): Potencial y Ética", "Edición Genética (CRISPR) y Diseño Humano", "Realidad Aumentada/Virtual (Metaverso) y Control Social", "Drones Autónomos de Vigilancia y Combate", "Robótica Avanzada y Reemplazo Laboral", "Control Predictivo del Comportamiento (Predictive Policing)", "Armas Autónomas Letales (LAWS)", "Tecnologías de Control Mental (Investigación y Rumores)", "Red 5G/6G: Capacidades y Preocupaciones", "Manipulación de Información y Deepfakes",
            // Sociedad, Cultura y Control Mental
            "Ingeniería Social y Modificación del Comportamiento", "Propaganda y Guerra Psicológica (Psyops)", "Control de la Narrativa Mediática (Mainstream Media)", "Cultura de la Cancelación y Control del Discurso", "Erosión de la Privacidad y la Autonomía Individual", "Vigilancia del Pensamiento (Thought Policing)", "Educación Estandarizada Global y Adoctrinamiento", "Salud Pública como Mecanismo de Control", "Mandatos y Restricciones de Movilidad", "Impacto Psicológico de la Vigilancia Constante", "Atomización Social y Destrucción Comunitaria", "Movimientos Sociales Controlados o Infiltrados", "Religión y Espiritualidad en el Nuevo Orden", "El Futuro de la Familia Tradicional", "Control Poblacional: Teorías y Métodos", "Alimentación Sintética y Control Alimentario", "Normalización de la Vigilancia y el Control", "Generación de Miedo y Crisis Perpetua", "Impacto en las Libertades Civiles (Expresión, Reunión)", "Desensibilización a la Violencia y al Control",
            // Medio Ambiente y Recursos
            "Narrativa del Cambio Climático como Herramienta de Control", "Impuestos Verdes y Restricciones Ambientales", "Geoingeniería: Proyectos y Peligros", "Control del Agua y Recursos Hídricos", "Escasez Artificial de Recursos", "Transición Energética Forzada: Ganadores y Perdedores", "Biodiversidad y Control Genético de Especies", "Restricción de la Propiedad Privada de la Tierra", "Zonas de Exclusión y Control de Acceso (15-Minute Cities)", "Impacto Ambiental de la Tecnología Avanzada (Minería de Datos, IA)", "Monitoreo Satelital Ambiental y Control", "Mercantilización de la Naturaleza",
            // Resistencia y Alternativas
            "Descentralización Tecnológica (Blockchain, Web3)", "Criptomonedas como Alternativa a CBDCs", "Movimientos por la Soberanía Individual y Nacional", "Comunidades Autosuficientes y Off-Grid", "Preservación del Efectivo y la Privacidad Financiera", "Activismo Digital y Contra-Información", "Redes de Comunicación Seguras y Cifradas", "Educación Alternativa y Pensamiento Crítico", "Desobediencia Civil Pacífica", "Fortalecimiento de Comunidades Locales", "Defensa de las Libertades Fundamentales", "Tecnologías de Código Abierto y Hardware Libre", "Auditoría Ciudadana del Poder", "Periodismo Independiente y Verificación de Hechos", "Espiritualidad y Resiliencia Interior",
            // Añadir más según la necesidad...
        ];
        const nwoThemes = [ // Temas para el botón "Generar Más"
            "gobernanza global", "CBDCs y economía digital", "vigilancia masiva", "inteligencia artificial y control", "identidad digital", "Agenda 2030", "Gran Reseteo", "transhumanismo", "control de la información", "soberanía nacional vs globalismo", "crédito social", "smart cities", "cambio climático y control", "descentralización como resistencia", "privacidad en 2030", "poder corporativo global", "tratados internacionales", "movimientos sociales", "tecnologías emergentes", "geoingeniería", "renta básica universal", "futuro del trabajo", "control de recursos"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un analista geopolítico y futurista imparcial y objetivo. Tu tarea es analizar en profundidad el concepto, evento o tecnología especulativa proporcionado en relación con las tendencias globales hacia 2030 y las narrativas sobre un 'Nuevo Orden Mundial'. Presenta diferentes perspectivas: los argumentos a favor o la visión oficial/proponente, las críticas o preocupaciones principales, los posibles mecanismos de implementación o funcionamiento, los actores clave involucrados (reales o supuestos), y las implicaciones potenciales para la sociedad, la economía y las libertades individuales. Basa tu análisis en información públicamente discutida y escenarios prospectivos, indicando claramente cuándo se trata de especulación o teoría. Evita el lenguaje alarmista o conspirativo extremo, buscando un análisis equilibrado y crítico. El objetivo es un informe detallado de aproximadamente 1200-1300 palabras sobre el siguiente tema:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat, prompt se ajusta dinámicamente
            model: "mistral-tiny", // Modelo ágil para chat
             systemPrompt: "Eres un asistente de IA especializado únicamente en el tema específico que se está discutiendo actualmente sobre tendencias globales hacia 2030. Responde preguntas de seguimiento que profundicen en ese tema, aclaren puntos, exploren conexiones o discutan implicaciones específicas mencionadas. Sé conciso, objetivo y mantente estrictamente dentro del tema en cuestión.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de temas conciso para un análisis prospectivo global hacia 2030. Genera exactamente 15 conceptos clave, tecnologías emergentes, políticas propuestas, eventos potenciales o preguntas críticas relacionadas con la gobernanza global, la economía digital, el control tecnológico y los cambios sociales. Devuelve *solo* la lista de temas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (iguales que la versión anterior)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Renombrado para claridad

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            // *** USA EL SYSTEM PROMPT DINÁMICO PARA CHAT ***
            const systemPromptToUse = isChat && currentTopicTitle
                ? `Eres un asistente de IA especializado únicamente en el tema '${currentTopicTitle}' relacionado con tendencias globales 2030. Responde preguntas de seguimiento sobre sus detalles, implicaciones o conexiones mencionadas en el análisis principal. Sé objetivo y conciso.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            // Seed sólo para el texto principal, no para chat
            if (config.seed && !isChat && Math.random() < 0.5) params.append('seed', Math.floor(Math.random() * 10000));
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    // *** MENSAJE DE ERROR AMIGABLE ***
                    throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, por favor intenta en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("unable to provide") ) {
                    throw new Error("La IA no pudo generar una respuesta adecuada para esta consulta. Intenta reformular o elige otro tema.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La solicitud a la IA tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                }
                // Propaga el error (ya debería ser amigable si vino del !response.ok o de la validación de texto)
                throw new Error(error.message || "Ocurrió un error inesperado al contactar los sistemas de análisis.");
            }
        }
        // Wrappers para claridad
        async function fetchExplanationText(topicTitle) {
            return fetchTextFromApi(topicTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentTopicTitle) throw new Error("Error interno: Contexto de análisis no establecido para la consulta.");
            // Añadir el contexto al prompt del usuario puede ayudar a la IA
            const contextualQuery = `En el contexto de '${currentTopicTitle}', ${userQuery}`;
            return fetchTextFromApi(contextualQuery, chatApiConfig, true); // true indica que es chat
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(nwoThemes) || "tendencias globales 2030";
            const specificPrompt = `Genera 15 temas clave o preguntas críticas sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150); // Un poco más largo mínimo
                     if (titles.length < 5) throw new Error("La IA no generó suficientes vectores de análisis nuevos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 550, nologo: true }; // Ajustar aspect ratio si se desea
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "global trends abstract concept";
             // Prompt ENFOCADO en simbolismo/abstracción
             const enhancedPrompt = `Abstract conceptual artwork symbolizing '${safePromptText}'. Themes: global control, surveillance, technology, data streams, network, future society. Use a dark, atmospheric, slightly dystopian or mysterious style. Colors: deep blues, greys, amber/orange accents. Avoid literal representations, people, text, logos. Focus on mood and symbolism. Cinematic, intricate detail.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "photorealistic, people, faces, text, words, letters, logo, brand, diagram, chart, map, flag, cheerful, bright, optimistic, simple, illustration, cartoon";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios significativos, ya maneja formatos básicos)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            // Limpieza básica adicional
            formatted = formatted.replace(/\[\^?\d+\^?\]/g, ''); // Remover citas tipo [1], [^2^]
            formatted = formatted.replace(/<br\s*\/?>/gi, '\n'); // Convertir <br> a saltos de línea para procesar párrafos

            // Markdown básico (ya implementado)
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Conversión a párrafos HTML (más robusta)
            const blocks = formatted.split(/\n\s*\n+/); // Separar por uno o más saltos de línea dobles
            formatted = blocks
                .map(block => block.trim()) // Quitar espacios extra de cada bloque
                .filter(block => block.length > 0) // Filtrar bloques vacíos
                .map(block => {
                    // Si ya es un encabezado HTML o fórmula, dejarlo como está
                    if (block.match(/^<h[1-4]>.*<\/h[1-4]>$/) || block.match(/^<p class="formula">.*<\/p>$/)) {
                        return block;
                    }
                    // Si es una lista (empieza con *, -, o número.), formatearla (básico)
                    if (block.match(/^[\*\-]\s/) || block.match(/^\d+\.\s/)) {
                         const listItems = block.split('\n').map(item => item.trim().replace(/^[\*\-\d\.]+\s*/, '')).filter(item => item.length > 0);
                         const listTag = block.match(/^\d+\.\s/) ? 'ol' : 'ul';
                         return `<${listTag}>${listItems.map(item => `<li>${item}</li>`).join('')}</${listTag}>`;
                    }
                    // Convertir saltos de línea simples DENTRO de un bloque a espacios (para flujo de texto)
                    let content = block.replace(/\s*\n\s*/g, ' ');
                    // Envolver el bloque en <p>
                    return `<p>${content}</p>`;
                })
                .join('\n'); // Unir bloques procesados

            return formatted;
        }


        // ========== MODAL FUNCTIONS ========== (sin cambios estructurales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '<p class="text-xs text-gray-500 text-center p-4">Inicia una consulta sobre este tema específico...</p>'; // Reset prompt
             chatInput.value = '';
             chatInput.placeholder = 'Consulta sobre [tema actual]...'; // Reset placeholder
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null; // Limpia el contexto
             // Ocultar fullscreen
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios estructurales)
        function addChatMessage(message, sender) {
            if (sender === 'user' && chatHistory.querySelector('p.text-gray-500')) {
                 chatHistory.innerHTML = ''; // Clear initial prompt message on first user message
             }
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            // Basic Markdown
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Convertir saltos de línea de la IA en <br> para mejor formato
            if (sender === 'ai') {
                 message = message.replace(/\n/g, '<br>');
             }
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             if (chatHistory.querySelector('p.text-gray-500')) { chatHistory.innerHTML = ''; } // Clear prompt
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = `// ${message} //`;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentTopicTitle) return;

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(error.message || "Error en la consulta de análisis adicional.");
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ========== (sin cambios estructurales)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar alfabéticamente para consistencia inicial
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">// No hay vectores de análisis disponibles //</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
             console.log(`Displayed ${sortedTitles.length} initial titles.`);
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Appended ${addedCount} new titles.`);
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // *** SET CONTEXT ***
            chatInput.placeholder = `Consulta sobre ${title}...`; // Update chat placeholder
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // 1. Fetch and display text
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Show area AFTER text is ready
                modalLoadingIndicator.style.display = 'none'; // Hide loading AFTER text is ready

                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is visible
                console.log("Scroll reset after text content loaded.");

                // 2. Prepare image placeholder and start image fetch (in parallel conceptually)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-project-diagram placeholder-icon"></i> <!-- Icono diagrama/concepto -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Add placeholder at the end

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none'; // Hidden until loaded

                imgElement.onload = () => {
                    console.log("Conceptual image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading conceptual image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">// Fallo en la visualización //</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    // Append the image element itself to modalContent
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">// Error al generar URL visual //</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none'; // Ensure loading is hidden on error
                modalErrorMessage.textContent = error.message || "// Error desconocido al cargar el análisis //";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = ''; // Clear partial content
                chatSection.classList.add('content-hidden'); // Hide chat on main error
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> BUSCANDO NUEVOS VECTORES...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("// No se pudieron obtener vectores adicionales en este momento. //"); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`// Error al generar vectores: ${error.message} //`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Cargar Vectores Adicionales';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Ocultar si hay resultados o si la lista está vacía (inicial)
         }

        // ========== INITIALIZATION ========== (sin cambios estructurales)
        function initApp() {
            // Check essential elements
             const essentialElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, modalTextArea, modalContent, modalLoadingIndicator, modalStoryContentArea, modalError, chatHistory, chatLoadingIndicator, fullscreenImage];
             if (essentialElements.some(el => !el)) {
                 console.error("Initialization failed: Missing essential elements. Check IDs.");
                 document.body.innerHTML = '<p style="color: #e53e3e; font-size: 1.5em; text-align: center; padding-top: 3em;">// ERROR CRÍTICO DE INTERFAZ: Componentes esenciales no encontrados. Recargue la aplicación. //</p>';
                 return;
             }

            // Event listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden'); // Ensure hidden initially
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>