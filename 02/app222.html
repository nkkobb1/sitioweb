<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webs Educativas e Interesantes - Explora y Aprende</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y modernas -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Webs Educativas --- */
        :root {
            --color-primary: #3b82f6; /* Azul Principal (Enlaces, Confianza) */
            --color-secondary: #10b981; /* Verde (Aprendizaje, Crecimiento) */
            --color-tertiary: #f97316; /* Naranja (Creatividad, Atención - uso moderado) */
            --color-background: #f8fafc; /* Blanco Hueso / Gris Muy Claro */
            --color-text: #1f2937; /* Gris Muy Oscuro (Casi Negro) */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro */
            --color-border: #e5e7eb; /* Borde Gris Claro */
            --color-error-bg: #fef2f2; /* Fondo error rojo muy claro */
            --color-error-text: #dc2626; /* Texto error rojo */
            --color-error-border: #fecaca; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 8px; /* Bordes más redondeados, amigables */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Poppins', sans-serif; font-weight: 600; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 600; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Nunito'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Poppins'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #eff6ff; /* Azul muy claro hover */ border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #2563eb; box-shadow: var(--shadow-md); transform: scale(1.02); }
        #generate-more-btn:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px; /* Para acomodar el juego de carga */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #f3f4f6; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área Principal de Contenido (Texto + Imagen) */
        #modal-content-area { flex-grow: 1; min-height: 0; /* Para scroll */ overflow-y: auto; padding-right: 10px; /* Espacio scrollbar */
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; /* Padding interno del texto */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-secondary); font-style: italic; } /* Énfasis verde */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Poppins', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 600; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: #059669; } /* Verde secundario para H3 */
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; font-weight: 600;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(209, 213, 219, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Pantalla de Carga con Juego */
        #modal-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); display: flex; /* Usa flex */ flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); padding: 2rem; }
        #loading-game-container { display: none; /* Oculto por defecto */ width: 100%; height: 250px; /* Altura fija para el juego */ background-color: #e0f2fe; /* Fondo azul claro para el área de juego */ border: 2px dashed var(--color-primary); border-radius: var(--border-radius); position: relative; cursor: crosshair; overflow: hidden; margin-bottom: 1.5rem; }
        #loading-target { width: 40px; height: 40px; background-color: var(--color-tertiary); /* Naranja */ border-radius: 50%; position: absolute; transition: top 0.15s ease-out, left 0.15s ease-out; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white; box-shadow: var(--shadow-sm); }
        #loading-target:hover { transform: scale(1.1); background-color: #ea580c; }
        #loading-game-score { font-size: 1.4rem; font-weight: 700; color: var(--color-primary); font-family: 'Poppins'; }
        #loading-instructions { font-size: 1rem; color: var(--color-text-muted); margin-top: 0.5rem; }
        /* Spinner original (se oculta cuando el juego está activo) */
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin-bottom: 1.5rem; }
        #modal-loading-text { font-weight: 600; color: var(--color-text); font-size: 1.3rem; font-family: 'Poppins'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Nunito'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-modal-bg); border-radius: 4px; box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-globe-americas mr-3 text-blue-500"></i> <!-- Icono globo -->
                     Webs para Aprender
                 </h1>
             </div>
             <span class="text-sm text-gray-500 font-sans tracking-wider">» Descubre Recursos Online «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora el Conocimiento Online</h1>
             <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto font-light">Encuentra sitios web fascinantes y educativos para expandir tus horizontes. ¡Busca, selecciona y aprende!</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar sitio web o tema (ej. 'historia', 'programación')...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-stream text-green-500 mr-2"></i> <!-- Icono lista/stream -->
                 Catálogo de Recursos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando catálogo inicial...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No se encontraron sitios que coincidan con tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir 40 Sitios Más
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator (con juego) -->
             <div id="modal-loading">
                 <!-- Spinner (se oculta si el juego está activo) -->
                 <div class="loading-spinner-modal"></div>
                 <p id="modal-loading-text">Cargando información...</p>

                 <!-- Mini-Juego de Carga -->
                 <div id="loading-game-container">
                     <div id="loading-target"><i class="fas fa-crosshairs"></i></div>
                 </div>
                 <div id="loading-game-score" class="content-hidden">Puntos: 0</div>
                 <p id="loading-instructions" class="content-hidden">¡Haz clic en el círculo naranja mientras esperas!</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Descripciones generadas por IA con fines informativos y de descubrimiento.</p>
              <p class="mt-1">Visita los sitios web para obtener información completa y actualizada. Verifica siempre la fiabilidad.</p>
              <p class="mt-2">© 2025 Explorador Web Educativo</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Aprendizaje General y MOOCs
            "Khan Academy", "Coursera", "edX", "FutureLearn", "Udemy", "Skillshare", "LinkedIn Learning (Lynda)", "MasterClass", "Brilliant.org (STEM interactivo)", "Wikipedia", "Wikiversity", "OpenLearn (The Open University)", "Academic Earth", "Class Central (Agregador MOOC)", "Saylor Academy", "Google Arts & Culture", "TED Talks / TED-Ed", "Internet Archive (Wayback Machine, Libros, etc.)", "Project Gutenberg (Libros gratuitos)", "LibriVox (Audiolibros gratuitos)",
            // Ciencia y Tecnología
            "NASA (Sitio principal y sub-sitios)", "National Geographic", "Smithsonian Institution", "Scientific American", "Nature Journal", "Science Magazine", "HowStuffWorks", "Physics Classroom", "PhET Interactive Simulations (Ciencia/Matemáticas)", "BioInteractive (HHMI)", "Periodic Videos (Universidad de Nottingham)", "Zooniverse (Ciencia ciudadana)", "Space.com", "Ars Technica (Sección Ciencia)", "Quanta Magazine", "IFLScience", "MinutePhysics (YouTube Channel - related)", "Veritasium (YouTube Channel - related)", "SciShow (YouTube Channel - related)", "World Science Festival",
            // Programación y Desarrollo
            "Stack Overflow", "GitHub (Explorar Proyectos / Aprender)", "freeCodeCamp", "Codecademy", "MDN Web Docs (Mozilla)", "W3Schools", "HackerRank", "LeetCode", "Codewars", "Scrimba (Cursos interactivos)", "The Odin Project", "CSS-Tricks", "Smashing Magazine", "Dev.to", "Google Developers", "Microsoft Learn", "Exercism", "Glitch", "Repl.it (Ahora Replit)", "CodingBat (Java/Python Practice)",
            // Idiomas
            "Duolingo", "Babbel", "Memrise", "Busuu", "italki (Tutores)", "Forvo (Pronunciación)", "Linguee (Diccionario contextual)", "Tatoeba (Frases de ejemplo)", "Anki (Flashcards SRS)", "Readlang (Leer y traducir)", "Google Translate", "DeepL Translator", "BBC Languages (Archivo)", "Mango Languages", "Clozemaster (Gamificación)",
            // Matemáticas
            "WolframAlpha (Motor de conocimiento computacional)", "Desmos (Calculadora gráfica)", "Art of Problem Solving (AoPS)", "Math is Fun", "BetterExplained", "3Blue1Brown (YouTube Channel - related)", "Numberphile (YouTube Channel - related)", "PatrickJMT (Tutoriales de matemáticas)", "Paul's Online Math Notes", "GeoGebra",
            // Historia y Humanidades
            "History.com", "National Archives (USA)", "British Library Online", "Europeana", "World History Encyclopedia", "Crash Course (YouTube Channel - related)", "Perseus Digital Library (Clásicos)", "Stanford Encyclopedia of Philosophy", "LibGuides Community", "Digital Public Library of America (DPLA)", "Big Think", "Aeon Magazine", "The Atlantic (Sección Ideas)", "HistoryExtra (BBC History Magazine)", "Fordham University History Sourcebooks",
            // Arte, Diseño y Música
            "Behance (Portafolios creativos)", "Dribbble (Diseño)", "Adobe Color", "Canva (Diseño fácil)", "Google Fonts", "Unsplash (Fotos gratuitas)", "Pexels (Fotos/Videos gratuitos)", "Pixabay (Fotos/Videos gratuitos)", "Musopen (Música clásica gratuita)", "IMSLP Petrucci Music Library (Partituras)", "Open Culture (Recursos culturales gratuitos)", "The MET Museum Online", "Louvre Online Tour", "Tate Kids", "Skillshare (Cursos creativos)",
            // Noticias y Verificación de Hechos
            "Reuters", "Associated Press (AP)", "BBC News", "The New York Times", "The Guardian", "NPR (National Public Radio)", "FactCheck.org", "Snopes", "PolitiFact", "AllSides (Perspectivas de noticias)", "ProPublica (Periodismo de investigación)", "Wikipedia (Current Events Portal)", "The Conversation (Artículos por académicos)", "Axios (Noticias concisas)", "Ground News (Comparador de cobertura)",
            // General Knowledge & Curiosidades
            "Mental Floss", "Atlas Obscura", "Wait But Why", "Vsauce (YouTube Channel - related)", "SmarterEveryDay (YouTube Channel - related)", "Today I Found Out", "Listverse", "Instructables (DIY Proyectos)", "Lifehacker", "MakeUseOf (MUO)", "How-To Geek", "Snopes (Leyendas urbanas)", "Guinness World Records", "Reddit (Subreddits educativos como r/explainlikeimfive, r/AskHistorians, r/science)", "Quora",
            // Otros Recursos Útiles / Niche
            "Wayback Machine (Internet Archive)", "CamelCamelCamel (Seguimiento precios Amazon)", "PrivacyTools.io", "Terms of Service; Didn't Read (ToS;DR)", "Down for Everyone or Just Me?", "Internet Live Stats", "Flightradar24 (Seguimiento vuelos)", "MarineTraffic (Seguimiento barcos)", "Citymapper (Planificación transporte)", "Radio Garden (Radios del mundo)", "PublicWWW (Búsqueda código fuente web)", "BuiltWith (Tecnologías web)", "SimilarWeb (Análisis tráfico web)", "Ninite (Instalador rápido apps Windows)", "AlternativeTo (Alternativas software/web)",
            // Meta-topics (para IA Generadora)
            "Mejores Plataformas MOOC 2024", "Sitios para aprender ciencia de forma interactiva", "Recursos gratuitos para aprender a programar", "Webs para practicar idiomas con hablantes nativos", "Enciclopedias online fiables", "Archivos digitales de historia mundial", "Comunidades online para desarrolladores", "Sitios de noticias con diferentes perspectivas políticas", "Webs para descubrir música nueva", "Plataformas de cursos de diseño gráfico", "Simuladores de física online", "Recursos para aprender matemáticas avanzadas gratis", "Portales de ciencia ciudadana", "Webs de verificación de hechos (fact-checking)", "Bibliotecas digitales de libros clásicos", "Museos con tours virtuales", "Sitios para aprender sobre finanzas personales", "Recursos educativos para niños", "Webs con tutoriales DIY", "Herramientas online para estudiantes", "Agregadores de noticias científicas", "Plataformas para encontrar tutores online", "Sitios para aprender un nuevo hobby", "Webs de fotografía de alta calidad gratuita", "Recursos para mejorar la escritura", "Comunidades de debate intelectual online"
        ];
        const websiteThemes = [ // Temas para 'Generate More'
            "aprendizaje online", "cursos MOOC", "ciencia popular", "noticias tecnológicas", "programación web", "desarrollo de software", "aprendizaje de idiomas", "matemáticas interactivas", "historia mundial", "recursos de humanidades", "arte y diseño digital", "música clásica online", "verificación de hechos", "noticias internacionales", "conocimiento general", "curiosidades científicas", "proyectos DIY", "habilidades digitales", "educación gratuita", "bibliotecas digitales", "museos virtuales", "ciencia ciudadana", "herramientas de productividad online", "plataformas de escritura", "recursos para estudiantes", "fotografía de stock gratuita", "aprendizaje de hobbies", "finanzas personales online"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un curador experto y crítico de recursos online. Tu tarea es reseñar el sitio web o tema educativo indicado. Describe de forma clara y objetiva: El propósito principal del sitio/tema, el tipo de contenido que ofrece (artículos, videos, cursos, herramientas, etc.), la audiencia objetivo (principiantes, expertos, niños, etc.), la usabilidad y diseño general, sus puntos fuertes (calidad, gratuidad, interactividad), posibles debilidades (publicidad, sesgo, contenido desactualizado), y si es relevante, su modelo de negocio (gratuito, freemium, suscripción). Proporciona un resumen equilibrado y útil para alguien que decide si usar el recurso. Extensión aproximada: 1200-1300 palabras. Basa tu reseña únicamente en el siguiente sitio web o tema:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
             // *** SOLICITA 40 TÍTULOS ***
             systemPrompt: "Actúa como un generador de ideas conciso para un catálogo de recursos web. Genera exactamente 40 nombres de sitios web educativos o interesantes, o temas generales de aprendizaje online. Prioriza la diversidad de temas (ciencia, arte, historia, tech, idiomas, etc.). Devuelve *solo* la lista de nombres/temas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo para generar 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalLoadingSpinner = modalLoadingIndicator.querySelector('.loading-spinner-modal'); // Spinner original
        const modalLoadingText = document.getElementById('modal-loading-text'); // Texto "Cargando..."
        const modalStoryContentAreaWrapper = document.getElementById('modal-story-content-area'); // Wrapper principal del contenido modal
        const modalTextArea = document.getElementById('modal-content-area'); // Área de texto y imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div para el texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Loading Game Elements
        const gameContainer = document.getElementById('loading-game-container');
        const gameTarget = document.getElementById('loading-target');
        const gameScoreDisplay = document.getElementById('loading-game-score');
        const gameInstructions = document.getElementById('loading-instructions');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State & Game Variables ==========
        let gameInterval = null;
        let gameScore = 0;
        const GAME_INTERVAL_MS = 850; // Velocidad del juego (más bajo = más rápido)

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) {
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     // *** MENSAJE DE ERROR AMIGABLE ***
                     throw new Error(`(Error ${response.status}) Nuestros servidores parecen estar ocupados ahora mismo. Por favor, inténtalo de nuevo en unos momentos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Quizás el tema sea muy específico.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o el servidor podría estar lento. Intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(websiteThemes) || "sitios web educativos variados";
            const specificPrompt = `Genera 40 nombres/temas de sitios web interesantes o educativos sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 10) throw new Error("La IA no generó suficientes ideas esta vez."); // Ajustado el umbral
                     // *** RETORNA HASTA 40 ***
                     return titles.slice(0, 40);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "online learning concept";
             // Prompt para imagen conceptual, NO screenshot
             const enhancedPrompt = `Abstract digital art representing the concept of '${safePromptText}'. Focus on learning, knowledge, internet, connection, discovery. Use a bright and clean color palette (blues, greens, whites, maybe orange accents). Avoid text, logos, UI elements, website screenshots. Symbolic, modern, slightly minimalist.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, letters, logo, UI, website screenshot, interface, button, menu, URL, address bar, photograph, realistic image, cluttered, dark, messy, signature, watermark";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             // Reset loading indicator to default (spinner)
             stopLoadingGame(); // Asegura que el juego se detenga si estaba activo
             modalLoadingIndicator.style.display = 'flex'; // Mostrar contenedor de carga
             modalLoadingSpinner.style.display = 'block'; // Mostrar spinner
             modalLoadingText.style.display = 'block'; // Mostrar texto "Cargando..."
             gameContainer.style.display = 'none'; // Ocultar juego
             gameScoreDisplay.classList.add('content-hidden'); // Ocultar marcador
             gameInstructions.classList.add('content-hidden'); // Ocultar instrucciones

             modalStoryContentAreaWrapper.classList.add('content-hidden'); // Ocultar contenido principal
             modalError.classList.add('content-hidden'); // Ocultar error
             modalTitle.textContent = '';
             modalContent.innerHTML = ''; // Limpia texto e imagen
             modalErrorMessage.textContent = '';

             hideFullscreenImage(); // Asegura que la imagen ampliada se oculte
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== LOADING GAME FUNCTIONS ==========
        function moveTarget() {
            if (!gameContainer || !gameTarget) return;
            const containerWidth = gameContainer.offsetWidth;
            const containerHeight = gameContainer.offsetHeight;
            const targetSize = gameTarget.offsetWidth; // Asume width=height

            const maxX = containerWidth - targetSize;
            const maxY = containerHeight - targetSize;

            const newX = Math.random() * maxX;
            const newY = Math.random() * maxY;

            gameTarget.style.left = `${newX}px`;
            gameTarget.style.top = `${newY}px`;

            // Cambiar icono o color ligeramente (opcional)
            const icons = ['fa-crosshairs', 'fa-dot-circle', 'fa-bullseye', 'fa-star'];
            gameTarget.innerHTML = `<i class="fas ${getRandomElement(icons)}"></i>`;
        }

        function handleTargetClick() {
            if (gameInterval === null) return; // No sumar puntos si el juego no está activo
            gameScore++;
            gameScoreDisplay.textContent = `Puntos: ${gameScore}`;
            // Mover inmediatamente al hacer clic para feedback instantáneo
            moveTarget();
             // Reiniciar el intervalo para que el tiempo empiece desde el clic
             clearInterval(gameInterval);
             gameInterval = setInterval(moveTarget, GAME_INTERVAL_MS);
        }

        function startLoadingGame() {
            console.log("Starting loading game...");
             if (!modalLoadingIndicator || !modalLoadingSpinner || !modalLoadingText || !gameContainer || !gameTarget || !gameScoreDisplay || !gameInstructions) {
                 console.error("Cannot start game, elements missing");
                 return;
             }
            // Ocultar loading normal, mostrar juego
            modalLoadingSpinner.style.display = 'none';
            modalLoadingText.style.display = 'none';
            gameContainer.style.display = 'block';
            gameScoreDisplay.classList.remove('content-hidden');
            gameInstructions.classList.remove('content-hidden');

            gameScore = 0;
            gameScoreDisplay.textContent = `Puntos: ${gameScore}`;

            // Añadir listener al target
            gameTarget.addEventListener('click', handleTargetClick);

            // Posición inicial y empezar intervalo
            moveTarget();
            if (gameInterval) clearInterval(gameInterval); // Limpiar intervalo anterior si existe
            gameInterval = setInterval(moveTarget, GAME_INTERVAL_MS);
        }

        function stopLoadingGame() {
            console.log("Stopping loading game...");
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
             if (gameTarget) {
                // Quitar listener para evitar errores/leaks
                gameTarget.removeEventListener('click', handleTargetClick);
             }
             // Ocultar elementos del juego (se hará visible el contenido o el error)
             if (gameContainer) gameContainer.style.display = 'none';
             if (gameScoreDisplay) gameScoreDisplay.classList.add('content-hidden');
             if (gameInstructions) gameInstructions.classList.add('content-hidden');
        }


        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar alfabéticamente ignorando mayúsculas/minúsculas
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">No hay sitios en el catálogo inicial.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => {
                 if (!existingTitles.has(title)) {
                     titleListContainer.appendChild(createTitleItem(title));
                     addedCount++;
                 }
             });
             console.log(`Added ${addedCount} new unique titles.`);
             filterTitles(searchInput.value); // Re-aplicar filtro
         }

        // *** MODIFIED: handleTitleClick to integrate loading game ***
        async function handleTitleClick(title) {
            resetModalState(); // Resetea todo, incluyendo parar juego anterior
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = ''; // Limpiar contenido anterior
            modalError.classList.add('content-hidden'); // Ocultar error

            // *** INICIAR JUEGO DE CARGA ***
            startLoadingGame();

            try {
                // Hacer la llamada a la API MIENTRAS el juego corre
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // *** DETENER JUEGO Y MOSTRAR CONTENIDO ***
                stopLoadingGame();
                modalLoadingIndicator.style.display = 'none'; // Ocultar área de carga completa

                modalContent.innerHTML = formattedExplanation; // Poner texto
                modalStoryContentAreaWrapper.classList.remove('content-hidden'); // Mostrar área de contenido

                modalTextArea.scrollTop = 0; // Reset scroll
                console.log("Scroll set to 0 after content visible");

                // Preparar y añadir placeholder de imagen DENTRO de modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i> <!-- Icono imagen -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando imagen conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Crear y añadir elemento imagen (empieza a cargar)
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none'; // Oculta hasta cargar

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove(); // Quitar placeholder
                    imgElement.style.display = 'block'; // Mostrar imagen
                    imgElement.addEventListener('click', () => {
                        showFullscreenImage(imgElement.src);
                    });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo cargar la imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Añadir img al final del contenido
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                // *** DETENER JUEGO Y MOSTRAR ERROR ***
                stopLoadingGame();
                modalLoadingIndicator.style.display = 'none'; // Ocultar área de carga

                modalErrorMessage.textContent = error.message || "Error desconocido al cargar datos.";
                modalError.classList.remove('content-hidden');
                modalStoryContentAreaWrapper.classList.remove('content-hidden'); // Mostrar área (ahora mostrará el error)
                modalContent.innerHTML = ''; // Limpiar por si acaso
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             // *** TEXTO ACTUALIZADO PARA 40 ***
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando 40 más...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más sitios en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar más sitios: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // *** TEXTO ACTUALIZADO PARA 40 ***
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir 40 Sitios Más';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check all essential elements, including game elements
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !imageFullscreenOverlay || !fullscreenCloseBtn || !gameContainer || !gameTarget || !gameScoreDisplay || !gameInstructions || !modalLoadingIndicator) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error crítico: Faltan componentes de la interfaz. Recarga la página o contacta soporte.</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>