<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desmitificando la Historia y la Ciencia - IA</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fonts: Playfair Display for Headings, Lato for body -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #3b82f6; /* Scholarly Blue */
            --color-secondary: #a16207; /* Old Gold / Brown */
            --color-background: #f8fafc; /* Off-white / Very Light Gray */
            --color-text: #1f2937; /* Dark Gray */
            --color-text-muted: #6b7280; /* Medium Gray */
            --color-modal-bg: #ffffff; /* White */
            --color-border: #d1d5db; /* Light Gray Border */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --border-radius: 6px;
            --transition-normal: all 0.2s ease-in-out;
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
             /* Subtle paper texture */
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAACQAAAAAQAAAJAAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAADKgAwAEAAAAAQAAADIAAAAAwqfxNAAAAAlwSFlzAAALEwAACxMBAJqcGAAAAcJJREFUaAXt1r1qAkEUxvFz7z5BwUqxtbbqVxB/gJ+QsBUsvXRRsLD0DywsLCxoLdQCtk7aSwQbGwtbN7c7t9tzzOzMU3A/OPN9M/OdGcb/IYgQdUJKgcVo4R8wBfM7LPG9zB2EMGD4J0wRF5Y1zQ0AGyv4+F8A/xV6m52Q6oAt6/F2uOAmABvj+AGbA/xqdBAb8DGY0xT51kDgR2D69vV3O7YDsC0P/wPA1vN3QJZAZ3b/B+B+nkW7wD1o3QGbm4E1wCq0AbA1f/8G4Bxd3iC7A1agfQe8H94VfAPqgCszuAH4b9wKPAE27gC7A1bgega/C/cSfAPmjAPbBM8H/N/gC7AW7QAcA3sDPQNeAFu3APgGTAMnAPmg3QA8A6YA+KcDbAPsDPQD+ApMAXuA1mgA3j0P0FwA/gEzAOy1QvEc+A00gNnAEdYAdjQgEvABOAJGAC9AD4AXYB1gAR4AtwBQwA3wAuwBbABHwBHQAfwAOgArwAzQBVwBHYAB0AFMwAvgARADfAAjAApQAWKgA1wA/QAPQBfgAtABVODs0A60gHjwBDCwDxDvAAbA2UDgT2AG+LdC4FdgDtjz+K+s0B+9A59/AgAmsAzEP79h6AAAAABJRU5ErkJggg==');
        }

        h1, h2.page-title, .logo {
            font-family: 'Playfair Display', serif;
            color: var(--color-primary);
        }
         h2.section-title {
             font-family: 'Playfair Display', serif;
             color: var(--color-secondary);
             border-bottom: 1px solid var(--color-border);
             padding-bottom: 0.5rem;
             display: inline-block;
         }

        .navbar {
            background-color: white;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 20;
            border-bottom: 1px solid var(--color-border);
        }

        /* Title List Styling */
        #title-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.25rem;
        }

        .title-item {
            background-color: white;
            padding: 1rem 1.25rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: var(--transition-normal);
            text-align: left;
            font-weight: 600;
            color: var(--color-text);
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            min-height: 65px;
        }
        .title-item:before { /* Icon before title */
             content: "\f05a"; /* FontAwesome info circle */
             font-family: "Font Awesome 6 Free";
             font-weight: 900;
             margin-right: 0.75rem;
             color: var(--color-primary);
             opacity: 0.8;
        }

        .title-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }
         .title-item:hover:before {
             opacity: 1;
         }

        /* Generate More Button */
        #generate-more-btn {
             grid-column: 1 / -1;
             background-color: var(--color-primary);
             color: white;
             padding: 0.6rem 1.2rem;
             border: none;
             border-radius: var(--border-radius);
             font-family: 'Lato', sans-serif;
             font-weight: bold;
             cursor: pointer;
             transition: var(--transition-normal);
             margin-top: 1.5rem;
        }
        #generate-more-btn:hover:not(:disabled) {
             background-color: #2563eb; /* Darker Blue */
             box-shadow: var(--shadow-sm);
        }
        #generate-more-btn:disabled {
             background-color: #9ca3af; /* Gray */
             cursor: not-allowed;
             opacity: 0.7;
        }
         #generate-more-btn .fa-sync-alt {
             color: white;
         }


        /* Modal Styling */
        #story-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(31, 41, 55, 0.8); /* Dark Gray Overlay */
            display: none; align-items: center; justify-content: center;
            z-index: 50; padding: 1rem;
        }
        #story-modal.active { display: flex; }

        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-border);
            padding: 1.5rem 2rem;
            max-width: 700px; width: 95%;
            max-height: 90vh; overflow: hidden; /* Main wrapper doesn't scroll */
            position: relative; box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column;
        }

        .modal-close-btn {
            position: absolute; top: 10px; right: 10px;
            background: var(--color-border); border: none;
            border-radius: 50%; width: 30px; height: 30px;
            font-size: 1.2rem; color: var(--color-text-muted);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: var(--transition-normal); z-index: 10;
        }
        .modal-close-btn:hover { background-color: #e5e7eb; color: var(--color-text); }

        /* --- Modal Content Order & SCROLL FIX --- */
        #modal-title {
             font-family: 'Playfair Display', serif;
             color: var(--color-primary);
             text-align: center; margin-bottom: 1.25rem;
             font-size: 1.75rem; /* Slightly larger */
             flex-shrink: 0;
        }

        #modal-content { /* Text container */
            line-height: 1.65; color: var(--color-text);
            white-space: pre-wrap;
            overflow-y: auto;      /* <<< Scroll applied HERE */
            margin-bottom: 1.5rem; padding-right: 10px;
            flex-grow: 1;          /* <<< Takes available space */
            min-height: 100px;     /* <<< Ensure minimum height for scroll */
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) var(--color-border);
        }
         /* Webkit Scrollbar */
         #modal-content::-webkit-scrollbar { width: 8px; }
         #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
         #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: 4px; border: 2px solid var(--color-border); }
         #modal-content p:not(:last-child) { margin-bottom: 1em; }


        #modal-image-container { /* Image container (AFTER TEXT) */
            width: 100%; height: 180px; /* Smaller height */
            background-color: #e5e7eb; /* Light gray background */
            border-radius: var(--border-radius); overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--color-border);
            flex-shrink: 0;
        }
         #modal-image-container img {
            width: 100%; height: 100%; object-fit: contain; /* Contain might be better */
            display: none; filter: sepia(20%); opacity: 0.9;
         }
         #modal-image-container .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); width: 30px; height: 30px;
            border-radius: 50%; border-left-color: var(--color-primary);
            animation: spin 1s linear infinite; display: none;
         }
         #modal-image-container .placeholder-icon {
             font-size: 2.5rem; color: var(--color-text-muted); display: none;
         }


        /* Loading Indicator */
        #modal-loading {
            text-align: center; padding: 3rem 0;
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--color-modal-bg); display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 5; border-radius: var(--border-radius);
        }
        .loading-spinner-modal {
            width: 50px; height: 50px;
            border: 5px solid var(--color-border); border-top-color: var(--color-primary);
            border-radius: 50%; animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.1rem; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Error message styling */
        .error-msg {
            background-color: #fef2f2; /* Light Red */
            color: #991b1b; /* Dark Red */
            padding: 1rem; border-radius: var(--border-radius);
            border: 1px solid #fecaca; /* Red border */
            margin-top: 1rem; text-align: center; flex-shrink: 0;
        }
         .error-msg i { margin-right: 0.5rem; }

         .content-hidden { display: none; }

    </style>
</head>
<body>
    <!-- Header/Navbar -->
    <nav class="navbar mb-10">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <h1 class="logo text-2xl sm:text-3xl">
                    <i class="fas fa-book-open-reader mr-2"></i> Desmitificando
                </h1>
            </div>
            <!-- No extra nav items -->
        </div>
    </nav>

    <!-- Main content -->
    <main class="container mx-auto px-4 pb-16">
        <!-- Hero section -->
        <section class="mb-12 text-center">
            <h1 class="page-title text-5xl sm:text-6xl mb-4">Verdades Ocultas, Mitos Rotos</h1>
            <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Explora errores históricos y científicos comunes. Haz clic para descubrir la explicación real.</p>
        </section>

        <!-- Title List Container -->
        <section class="mb-10">
            <h2 class="section-title text-3xl sm:text-4xl mb-6 text-center mx-auto">
                <i class="fas fa-search-plus text-blue-500 mr-2"></i>
                Mitos a Examen
            </h2>
            <div id="title-list">
                 <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Consultando los anales...</p>
            </div>
            <div id="generate-more-container" class="text-center mt-8">
                <button id="generate-more-btn">
                     <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                    Descubrir Más Mitos
                 </button>
            </div>
        </section>

    </main>

    <!-- Story Modal -->
    <div id="story-modal">
        <div class="modal-content-wrapper">
            <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
            <div id="modal-loading">
                <div class="loading-spinner-modal"></div>
                <p>Investigando...</p>
            </div>

            <!-- Content Area (Flex container) -->
            <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                <h2 id="modal-title" class="text-2xl md:text-3xl"></h2>
                <!-- Text Content (Scrollable) -->
                <div id="modal-content" class="text-base md:text-lg">
                    <!-- Explanation text will be placed here -->
                </div>
                 <!-- Image Container (Fixed height, at bottom) -->
                <div id="modal-image-container">
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <img id="modal-image" alt="Ilustración conceptual" />
                </div>
                 <!-- Error Display Area (Only shown on error) -->
                <div id="modal-error" class="error-msg content-hidden">
                     <i class="fas fa-exclamation-circle"></i>
                     <span id="modal-error-message"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-100 text-gray-600 py-5 mt-12 border-t border-gray-200">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>Explicaciones generadas por IA basadas en conocimiento común. Siempre verifica fuentes expertas para información crítica.</p>
            <p class="mt-1">© 2025 Desmitificando</p>
        </div>
    </footer>

    <script>
        // ========== CONFIG & DATA ==========

        // --- Expanded Historical/Scientific Myth Titles (Ensuring > 150) ---
        const predefinedTitles = [
            "El Mito de los Cascos con Cuernos Vikingos", "¿Eran los Vikingos solo Bárbaros Saqueadores?",
            "¿Descubrió Colón América Realmente?", "La Tierra Plana: Un Mito Medieval Persistente",
            "¿Se Bañaba la Gente en la Edad Media?", "El Derecho de Pernada: ¿Realidad o Ficción?",
            "Los Cinturones de Castidad Medievales", "La Quema de Brujas: ¿Solo en la Edad Media?",
            "Nerón y el Incendio de Roma: ¿Tocando la Lira?", "Los Gladiadores Siempre Morían en la Arena",
            "Vomitorios Romanos: ¿Para Vomitar Comida?", "Cleopatra y su Belleza Legendaria (¿Solo Egipcia?)",
            "El Caballo de Troya: ¿Literalmente un Caballo?", "Espartanos: ¿Solo Guerreros Sin Cultura?",
            "La Gran Muralla China: ¿Visible desde la Luna?", "Napoleón Bonaparte: ¿Realmente Era Tan Bajo?",
            "María Antonieta y el 'Que Coman Pasteles'", "Einstein Reprobó Matemáticas en la Escuela",
            "El Cerebro: ¿Solo Usamos el 10%?", "La Memoria del Pez Dorado: ¿Solo 3 Segundos?",
            "Los Lemmings y el Suicidio Masivo", "Los Murciélagos Son Ciegos",
            "Las Avestruces Esconden la Cabeza en la Arena", "El Rayo Nunca Cae Dos Veces en el Mismo Lugar",
            "El Agua Gira Diferente en Cada Hemisferio", "El Efecto Invernadero es Siempre Malo",
            "Las Estaciones se Deben a la Cercanía al Sol", "La Luna Tiene un Lado Oscuro Permanente",
            "Hay Sonido en el Espacio (en las Películas)", "Los Agujeros Negros lo Absorben Todo Cercano",
            "La Evolución Significa que Venimos 'del Mono'", "El Hombre de Neandertal Era Bruto y Tonto",
            "Los Dinosaurios Convivieron con los Humanos", "El Azúcar Causa Hiperactividad en Niños",
            "El Chicle Tarda 7 Años en Digerirse", "Crujir los Dedos Causa Artritis",
            "Leer con Poca Luz Daña la Vista Permanentemente", "El Pelo y las Uñas Crecen Después de Morir",
            "Las Vacunas Causan Autismo", "La Homeopatía Funciona Más Allá del Placebo",
            "Diferentes Zonas de la Lengua para Cada Sabor", "Solo Hay 5 Sentidos Humanos",
            "La Sangre Desoxigenada Es Azul", "El Estrés Vuelve el Pelo Canoso Rápidamente",
            "Los Tiburones Pueden Oler Sangre a Kilómetros", "Los Camaleones Cambian de Color para Camuflarse",
            "Las Abejas Mueren Siempre Después de Picar", "Las Jirafas Duermen Solo 30 Minutos al Día",
            "Los Perros Ven en Blanco y Negro", "Los Gatos Siempre Caen de Pie",
            "La Gran Pirámide Fue Construida por Esclavos", "Los Jeroglíficos Egipcios Eran Solo Pictogramas",
            "El Arca de Noé: ¿Literalmente Todos los Animales?", "El Diluvio Universal Cubrió Toda la Tierra",
            "La Torre de Babel y el Origen de los Idiomas", "El Rey Arturo y los Caballeros de la Mesa Redonda",
            "Robin Hood: ¿Existió Realmente?", "Guillermo Tell y la Manzana", "Pocahontas y John Smith: ¿Romance Histórico?",
            "El Monstruo del Lago Ness: ¿Un Plesiosaurio?", "Bigfoot/Sasquatch: ¿Pruebas Concluyentes?",
            "El Triángulo de las Bermudas: ¿Zona Paranormal?", "El Área 51 y los OVNIs Capturados",
            "El Experimento Filadelfia: ¿Invisibilidad y Teletransporte?", "Los Illuminati Controlan el Mundo",
            "El Hombre Llegó a la Luna: ¿Montaje?", "El Calentamiento Global No Existe o No es Humano",
            "Los Alimentos Orgánicos Son Siempre Más Saludables", "El Gluten Es Malo para Todos",
            "La Desintoxicación (Detox) Elimina Toxinas Reales", "El Microondas Destruye los Nutrientes",
            "Comer de Noche Engorda Más", "El Desayuno Es la Comida Más Importante Sí o Sí",
            "Se Necesitan 8 Vasos de Agua al Día Exactamente", "La Vitamina C Previene el Resfriado Común",
            "El Efecto Mozart: ¿Música Clásica = Bebés Genios?", "Los Videojuegos Causan Violencia Directamente",
            "Las Personas Creativas Usan Más el Hemisferio Derecho", "Los Estilos de Aprendizaje (Visual, Auditivo...) Son Fijos",
            "La Grafología Puede Revelar tu Personalidad", "La Astrología Predice el Futuro o la Personalidad",
            "Los Fantasmas y Espíritus Existen (¿Evidencia?)", "La Ouija Contacta con los Muertos",
            "Las Líneas de Nazca Fueron Hechas por Alienígenas", "Stonehenge: ¿Construido por Druidas?",
            "Las Estatuas Moai de Isla de Pascua (¿Cómo se movieron?)", "Atlántida: ¿Una Civilización Perdida Real?",
            "El Dorado: ¿La Ciudad de Oro Existió?", "La Fuente de la Juventud",
            "Los Zombis Son Científicamente Posibles", "Los Vampiros Pueden Existir Biológicamente",
            "La Alquimia Podía Transmutar Plomo en Oro", "La Generación Espontánea de la Vida",
            "El Éter Luminífero por Donde Viaja la Luz", "El Modelo Atómico de 'Pastel de Pasas'",
            "La Frenología: Forma del Cráneo y Personalidad", "La Eugenesia Como Ciencia Válida",
            "El Racismo Científico y sus Bases Erróneas", "El Creacionismo Como Teoría Científica",
            "La Tierra Tiene Solo 6000 Años", "Las Mujeres Son Menos Lógicas que los Hombres",
            "Los Hombres No Pueden Hacer Varias Cosas a la Vez", "Los Gatos Negros Traen Mala Suerte",
            "Romper un Espejo: 7 Años de Mala Suerte", "Pasar Bajo una Escalera Trae Desgracia",
            "El Viernes 13 es un Día Maldito", "Tocar Madera Evita la Mala Suerte",
            "Walt Disney Está Criogenizado", "Paul McCartney Murió y Fue Reemplazado",
            "El Monstruo de Frankenstein se Llamaba Frankenstein", "Sherlock Holmes Dijo 'Elemental, mi querido Watson'",
            "Los Lemmings de Disney y el Acantilado", "Las 'Fake News' Son un Fenómeno Nuevo",
            "Internet Es Completamente Anónimo", "Borrar Archivos los Elimina Permanentemente",
            "Solo los Humanos Usan Herramientas", "Los Animales Actúan Solo por Instinto",
            "Las Plantas No Sienten Ni se Comunican", "El Efecto Placebo Es Solo 'Mental'",
            "La Hipnosis Puede Recuperar Recuerdos Exactos", "Las Personas con Múltiple Personalidad Son Comunes",
            "La Esquizofrenia Implica Múltiples Personalidades", "La Depresión Es Solo Tristeza o Debilidad",
            "La Adicción Es Falta de Voluntad", "Los Rayos Gamma Crearon a Hulk",
            "La Radiactividad Siempre Te Hace Brillar", "Se Puede Sobrevivir a una Explosión Nuclear en un Frigorífico",
            "El Sonido de un Disparo Silenciado ('Pew')", "Se Puede Hablar Después de un Disparo Letal",
            "Las Espadas Medievales Eran Extremadamente Pesadas", "Los Samuráis Seguían un Código Bushido Inflexible",
            "Los Piratas Enterraban Tesoros Marcados con 'X'", "Los Piratas Usaban Garfios y Patas de Palo Comúnmente",
            "Marco Polo Introdujo la Pasta en Italia desde China", "Las Brujas de Salem Realmente Volaban en Escobas",
            "Benjamin Franklin Descubrió la Electricidad con una Cometa", "George Washington Tenía Dientes de Madera",
            "Van Gogh se Cortó Toda la Oreja por Amor", "Los Humanos Primitivos Vivían en Cuevas Principalmente",
            "El 'Eslabón Perdido' Aún No Se Ha Encontrado", "La Selección Natural Siempre Lleva a la Perfección"
        ];

        // --- NEW: Topics for varied title generation ---
        const topicThemes = [
            "la historia antigua", "la Edad Media", "la ciencia popular", "el cuerpo humano",
            "el reino animal", "el espacio y astronomía", "la psicología", "la tecnología",
            "mitos modernos y leyendas urbanas", "inventos y descubrimientos", "personajes históricos",
            "geografía y exploración", "arte y cultura", "biología y evolución", "física y química",
            "salud y medicina", "comida y nutrición", "eventos históricos clave", "criptozoología",
            "pseudociencia", "el lenguaje", "el clima", "dinosaurios", "Egipto antiguo", "Roma antigua",
            "Grecia antigua", "los vikingos", "piratas", "la Segunda Guerra Mundial", "la Guerra Fría"
        ];


        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un divulgador experto en historia y ciencia. Tu tarea es desmentir mitos o explicar errores históricos/científicos comunes de forma clara, concisa (aprox. 150-300 palabras) y rigurosa, pero accesible para un público general. Cita la creencia popular y luego explica por qué es incorrecta, aportando la información veraz o el matiz necesario. Escribe una explicación basada únicamente en el siguiente título/mito:",
            timeoutSeconds: 45
        };

         const titleGenerationConfig = {
             model: "mistral",
             systemPrompt: "Actúa como un generador de ideas conciso. Genera exactamente 15 títulos cortos que representen mitos populares, errores históricos comunes o preguntas frecuentes sobre ciencia e historia (ej: 'El mito de X', '¿Es verdad que Y?', 'La falacia de Z'). Devuelve *solo* la lista de títulos, uno por línea, sin numeración ni texto adicional.",
             // prompt set dynamically
             timeoutSeconds: 30,
             // seed set dynamically
         };

        // ========== DOM ELEMENTS ==========
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');


        // ========== API FUNCTIONS ==========

        async function fetchTextFromApi(prompt, config) {
            const encodedPrompt = encodeURIComponent(prompt);
            const encodedSystem = encodeURIComponent(config.systemPrompt);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}): ${url}`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
            }
        }

        async function fetchExplanationText(title) { // Renamed for clarity
             const text = await fetchTextFromApi(title, textApiConfig);
              if (text.trim().length < 50 || text.toLowerCase().includes("cannot fulfill")) {
                  throw new Error("La IA no pudo generar una explicación adecuada para este tema.");
              }
             return text;
        }

        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(topicThemes) || "historia y ciencia";
            const specificPrompt = `Genera 15 títulos de mitos o errores comunes sobre ${randomTheme}`;
            console.log("Generating titles with prompt:", specificPrompt);

            const configForThisRequest = { ...titleGenerationConfig, seed: Date.now() }; // Use timestamp as seed

            const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
            const titles = text.split('\n')
                               .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                               .filter(line => line.length > 5 && line.length < 120); // Adjusted length filter
            if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de títulos.");
            return titles.slice(0, 15);
        }

        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Date.now(), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "historical misconception";
            // Image styles suited for the theme
            const styleKeywords = [
                 "old parchment diagram style", "stylized historical illustration", "conceptual infographic art",
                 "vintage textbook illustration", "symbolic representation", "schematic drawing", "allegorical painting style"
            ];
             const randomStyle = getRandomElement(styleKeywords);
            const enhancedPrompt = `${randomStyle} illustrating the concept or debunking the myth '${safePromptText}'`;

            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, letters, writing, labels, realistic photo, photograph, person posing, watermark, signature, chart, graph";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }


        // ========== MODAL FUNCTIONS ==========
        function showModal() { if(storyModal) storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { if(storyModal) storyModal.classList.remove('active'); document.body.style.overflow = ''; resetModalState(); }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.textContent = '';
             modalContent.scrollTop = 0;
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.style.display = 'flex'; // Show container for spinner/placeholder
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length, ri; while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }

         function createTitleItem(title) {
            const div = document.createElement('div'); div.className = 'title-item';
            div.textContent = title; div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title)); return div;
        }

        function displayTitles(titles) {
            if (!titleListContainer || !titlesLoading) return;
            const shuffledTitles = shuffleArray([...titles]);
            titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none';
            if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay mitos disponibles.</p>'; return; }
            shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
        }

         function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        async function handleTitleClick(title) {
            resetModalState(); showModal();
            modalTitle.textContent = title;
            modalContent.textContent = ''; // Clear previous content
            modalImageContainer.style.display = 'none'; // Hide image area initially
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // 1. Fetch Explanation Text FIRST
                const explanationText = await fetchExplanationText(title);

                // 2. Display Text & Prepare for Image
                modalLoadingIndicator.style.display = 'none';
                modalContent.textContent = explanationText; // Display the explanation
                modalStoryContentArea.classList.remove('content-hidden'); // Show content area NOW
                modalImageContainer.style.display = 'flex'; // Show image container (for spinner)
                modalImageSpinner.style.display = 'block';

                // 3. Fetch and Display Image (AFTER text is shown)
                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => {
                         modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none';
                         modalImage.style.display = 'block';
                     };
                     modalImage.onerror = () => {
                         console.error("Error loading image for:", title);
                         modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block';
                         modalImage.style.display = 'none';
                     };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL for:", title);
                     modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block';
                 }
            } catch (error) {
                console.error("Failed to display explanation:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalImageContainer.style.display = 'none'; // Hide image area on text error
                modalContent.textContent = ''; // Clear content area
            }
        }

         async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más...';

             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se pudieron generar nuevas ideas en este momento."); }
             } catch (error) {
                 console.error("Failed to generate more titles:", error);
                 alert(`Error al generar más mitos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Mitos';
             }
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) {
                 console.error("Initialization failed: Critical elements missing.");
                 document.body.innerHTML = '<p style="padding: 2rem; text-align: center; color: red;">Error crítico al cargar la página.</p>'; return;
            }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles); // Display initial shuffled list
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>