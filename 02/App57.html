<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glosario Jurídico Avanzado</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #1e3a8a; /* Dark Blue */
            --color-secondary: #4b5563; /* Cool Gray */
            --color-background: #f9fafb; /* Very Light Gray */
            --color-text: #1f2937; /* Dark Gray */
            --color-text-muted: #6b7280; /* Medium Gray */
            --color-modal-bg: #ffffff;
            --color-border: #d1d5db; /* Light Gray Border */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 4px; /* Slightly sharper radius */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); }
        h1, h2, h3, h4, .logo { font-family: 'Lora', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-size: 0.95rem; }
        .title-item i { color: var(--color-secondary); margin-right: 0.75rem; width: 1.2em; text-align: center;}
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); }
        .title-item:hover i { color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1d4ed8; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem; max-width: 900px; width: 95%; max-height: 90vh; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; border-top: 4px solid var(--color-primary); }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e5e7eb; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.4rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #d1d5db; color: var(--color-text); }
        #modal-title { font-family: 'Lora', serif; color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; font-size: 1.6rem; font-weight: bold;}
        #modal-content { font-family: 'Nunito', sans-serif; line-height: 1.75; color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 15px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content::-webkit-scrollbar { width: 8px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Lora', serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 600; }
        #modal-content h1 { font-size: 1.3em; }
        #modal-content h2 { font-size: 1.2em; }
        #modal-content h3 { font-size: 1.1em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; }
        #modal-content .formula { /* Keep formula styling in case needed */ text-align: center; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 1.1em; padding: 0.8em; margin: 1.2em 0; border: 1px solid var(--color-border); background-color: #f9fafb; border-radius: var(--border-radius); overflow-x: auto; white-space: nowrap; }
        #modal-content .formula sub, #modal-content .formula sup { font-size: 0.8em; line-height: 0; position: relative; vertical-align: baseline; }
        #modal-content .formula sub { top: 0.5em; }
        #modal-content .formula sup { top: -0.5em; }
        #modal-image-container { width: 100%; height: 220px; background-color: #f3f4f6; border-radius: var(--border-radius); overflow: hidden; display: none; /* Start hidden */ align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; margin-top: 1rem; }
        #modal-image-container.visible { display: flex; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 2.5rem; color: var(--color-border); display: none; }
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: var(--border-radius); border: 1px solid #fecaca; margin-top: 1rem; text-align: center; flex-shrink: 0; }
        .error-msg i { margin-right: 0.5rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-3 flex justify-center items-center">
             <div class="flex items-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-gavel mr-2"></i> Glosario Jurídico Avanzado
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Descifrando el Derecho</h1>
             <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Explora la complejidad jurídica con definiciones detalladas por IA. Selecciona un término para profundizar.</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-balance-scale text-blue-800 mr-2"></i>
                 Términos a Deliberar
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Consultando la doctrina...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Términos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Analizando jurisprudencia...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) -->
                 <div id="modal-content" class="text-base">
                     <!-- Explanation text (HTML) goes here -->
                 </div>
                  <!-- Image Container (Initially Hidden) -->
                 <div id="modal-image-container">
                     <div class="spinner"></div>
                     <i class="fas fa-landmark placeholder-icon"></i> <!-- Placeholder icon -->
                     <img id="modal-image" alt="Visualización conceptual del término jurídico" />
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-5 mt-12 border-t border-gray-200">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Definiciones generadas por IA con fines informativos y educativos. El derecho es complejo y requiere asesoramiento profesional cualificado.</p>
              <p class="mt-1">© 2025 Glosario Jurídico Avanzado</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
             // Constitucional y Derechos Humanos
            "Amicus curiae", "Control de convencionalidad", "Bloque de constitucionalidad", "Habeas Data", "Acción de tutela (o Amparo)", "Mandamus", "Certiorari", "Judicial Review (Control de Constitucionalidad)", "Supremacía Constitucional", "Separación de Poderes", "Frenos y Contrapesos (Checks and Balances)", "Federalismo vs. Centralismo", "Derechos Fundamentales de Primera Generación", "Derechos Económicos, Sociales y Culturales (DESC)", "Derechos de Tercera Generación (Colectivos)", "Principio de Proporcionalidad", "Test de Razonabilidad", "Estado de Excepción (o Emergencia)", "Suspensión de Garantías", "Debido Proceso Sustantivo", "Debido Proceso Procesal", "Cláusula de Igual Protección (Equal Protection)", "Acciones Afirmativas", "Standing (Legitimación Procesal Activa)", "Mootness (Sustracción de Materia)", "Ripeness (Madurez de la Causa)", "Cosa Juzgada Constitucional", "Efectos Inter Pares vs. Erga Omnes", "Sentencias Estructurales", "Mutación Constitucional", "Poder Constituyente Originario y Derivado", "Neoconstitucionalismo", "Garantismo Jurídico", "Activismo Judicial vs. Deferencia Judicial", "Interpretación Conforme", "Objeción de Conciencia", "Libertad de Expresión y sus Límites", "Derecho a la Intimidad vs. Interés Público", "Habeas Corpus", "Writ of Prohibition", "Bill of Attainder", "Cláusula del Debido Proceso", "Eminent Domain (Expropiación Forzosa)", "Derecho a la consulta previa (pueblos indígenas)", "Justicia Transicional",
             // Derecho Civil (Obligaciones y Contratos)
            "Obligaciones de Dar, Hacer y No Hacer", "Obligaciones Solidarias y Mancomunadas", "Obligaciones Alternativas y Facultativas", "Novación", "Compensación", "Confusión", "Remisión de Deuda", "Prescripción Extintiva", "Caducidad", "Condición Resolutoria Tácita", "Pacto Comisorio Calificado", "Teoría de la Imprevisión (Rebus sic stantibus)", "Lesión Enorme", "Enriquecimiento sin Causa (Actio in rem verso)", "Abuso del Derecho", "Buena Fe Objetiva y Subjetiva", "Autonomía de la Voluntad y sus Límites", "Contratos de Adhesión", "Cláusulas Abusivas", "Interpretación de los Contratos (Reglas)", "Simulación Absoluta y Relativa", "Fraude Pauliano (Acción Revocatoria)", "Responsabilidad Precontractual (Culpa in contrahendo)", "Oferta y Aceptación (Formación del Consentimiento)", "Vicios del Consentimiento (Error, Fuerza, Dolo)", "Objeto Lícito y Causa Lícita", "Promesa de Contrato (Contrato Preliminar)", "Contrato de Compraventa: Pactos Accesorios", "Arras (Penitenciales, Confirmatorias)", "Saneamiento por Evicción", "Saneamiento por Vicios Redhibitorios (Ocultos)", "Contrato de Arrendamiento: Obligaciones", "Contrato de Mandato: Representación", "Mandato sin Representación (Comisión)", "Contrato de Mutuo (Préstamo de Consumo)", "Contrato de Comodato (Préstamo de Uso)", "Contrato de Depósito (Regular e Irregular)", "Contrato de Fianza", "Contrato de Transacción", "Contrato de Sociedad Civil", "Contrato Aleatorio (Renta Vitalicia, Juego)", "Cuasicontratos (Agencia Oficiosa, Pago de lo no debido)", "Responsabilidad Civil Contractual", "Incumplimiento Contractual: Remedios", "Cláusula Penal", "Indexación (Corrección Monetaria)", "Teoría de los Riesgos",
             // Derecho Civil (Bienes y Reales)
            "Dominio o Propiedad", "Modos de Adquirir el Dominio (Ocupación, Accesión, Tradición, Sucesión, Prescripción)", "Tradición (Entrega)", "Prescripción Adquisitiva (Usucapión)", "Posesión Regular e Irregular", "Mera Tenencia", "Acciones Posesorias (Querellas)", "Acción Reivindicatoria", "Limitaciones al Dominio (Usufructo, Uso, Habitación, Servidumbres)", "Usufructo", "Servidumbres Activas y Pasivas", "Propiedad Horizontal (Condominio)", "Comunidad o Copropiedad", "Acción de Partición", "Bienes Muebles e Inmuebles", "Bienes Corporales e Incorporales", "Bienes Fungibles y No Fungibles", "Derechos Reales vs. Derechos Personales", "Hipoteca", "Prenda (con y sin desplazamiento)", "Registro de la Propiedad Inmobiliaria", "Tercerías (Dominio, Posesión, Pago)", "Patrimonio Familiar", "Bien de Familia", "Adverse Possession (Equivalente en Common Law)", "Easement (Servidumbre en Common Law)", "Covenant (Pacto Restrictivo sobre Inmuebles)", "Bailment (Depósito/Comodato en Common Law)", "Trust (Fideicomiso)", "Constructive Trust / Resulting Trust", "Rule Against Perpetuities (Regla contra Perpetuidades)", "Propiedad Intelectual: Derechos de Autor y Conexos", "Propiedad Industrial: Patentes, Marcas, Diseños",
             // Derecho Penal
            "Teoría del Delito (Tipicidad, Antijuridicidad, Culpabilidad)", "Tipo Penal Objetivo y Subjetivo", "Dolo (Directo, Eventual)", "Culpa (Consciente, Inconsciente)", "Preterintención", "Error de Tipo y Error de Prohibición", "Causas de Justificación (Legítima Defensa, Estado de Necesidad, Cumplimiento de Deber)", "Causas de Inculpabilidad (Inimputabilidad, Coacción, Miedo Insuperable)", "Iter Criminis (Camino del Delito: Ideación, Preparación, Ejecución, Consumación)", "Tentativa (Idónea, Inidónea)", "Desistimiento y Arrepentimiento Activo", "Autoría y Participación (Coautoría, Complicidad, Inducción)", "Concurso de Delitos (Real, Ideal, Medial)", "Delito Continuado", "Circunstancias Modificatorias (Atenuantes, Agravantes)", "Teoría de la Pena (Retribución, Prevención General/Especial)", "Individualización de la Pena", "Sustitutivos Penales (Suspensión Condicional, Libertad Vigilada)", "Medidas de Seguridad", "Non Bis In Idem (Ne bis in idem)", "Principio de Legalidad Penal (Nullum crimen, nulla poena sine lege)", "Ley Penal en Blanco", "Tipos Penales Abiertos", "Delitos de Omisión (Propia, Impropia)", "Posición de Garante", "Delitos contra la Vida (Homicidio, Asesinato)", "Delitos contra la Libertad Sexual", "Delitos contra el Patrimonio (Robo, Hurto, Estafa, Apropiación Indebida)", "Delitos Societarios", "Delitos contra la Administración Pública (Cohecho, Malversación, Prevaricación)", "Lavado de Activos (Blanqueo de Capitales)", "Criminal Compliance", "Mens Rea (Elemento Mental - Common Law)", "Actus Reus (Elemento Físico - Common Law)", "Strict Liability Offenses (Responsabilidad Objetiva Penal)", "Insanity Defense (Defensa por Enajenación Mental)", "Duress (Coacción - Common Law)", "Entrapment (Provocación Policial)", "Double Jeopardy (Equivalente a Non Bis In Idem)", "Nolle Prosequi (Decisión de no Perseguir Penalmente)", "Malum in se vs. Malum prohibitum", "Doli incapax (Incapacidad de Dolo en Menores)",
             // Derecho Procesal
            "Jurisdicción y Competencia", "Competencia Objetiva, Funcional y Territorial", "Actos Procesales (Nulidad, Convalidación)", "Plazos Procesales (Perentorios, No Perentorios)", "Notificaciones Judiciales", "Demanda y Contestación", "Excepciones Procesales (Dilatorias, Perentorias)", "Litispendencia", "Acumulación de Autos", "Prueba: Objeto, Carga y Valoración", "Medios de Prueba (Testifical, Documental, Pericial, Confesión, Inspección)", "Prueba Ilícita", "Teoría del Fruto del Árbol Envenenado", "Indicios y Presunciones", "Sana Crítica (Valoración Prueba)", "Medidas Cautelares (Provisorias)", "Embargo Preventivo, Secuestro", "Prohibición de Celebrar Actos y Contratos", "Recursos Procesales (Reposición, Apelación, Casación, Queja)", "Efecto Devolutivo y Suspensivo", "Recurso de Casación en la Forma y en el Fondo", "Recurso de Nulidad (Penal)", "Procedimiento Ordinario, Sumario, Ejecutivo", "Juicio Ejecutivo: Título Ejecutivo", "Tercerías en Juicio Ejecutivo", "Arbitraje (Derecho, Equidad, Técnico)", "Laudo Arbitral", "Mediación y Conciliación", "Procedimientos Concursales (Quiebra, Reorganización)", "Jurisdicción Voluntaria", "Subpoena duces tecum (Requerimiento de Documentos)", "Voir Dire (Selección del Jurado)", "Hearsay Rule and Exceptions (Regla de Oídas y Excepciones)", "Best Evidence Rule (Regla de la Mejor Prueba)", "Chain of Custody (Cadena de Custodia)", "Ex Parte Communication", "In Rem Jurisdiction (Competencia sobre la Cosa)", "Lis Pendens (Aviso de Juicio Pendiente)", "Res Ipsa Loquitur (La cosa habla por sí misma)", "Forum Non Conveniens", "Conflict of Laws (Derecho Internacional Privado)", "Letters Rogatory (Comisión Rogatoria)", "Extradition", "Discovery (Etapa de Descubrimiento de Pruebas - Common Law)", "Motion for Summary Judgment (Solicitud de Fallo Sumario)", "Burden of Proof (Carga de la Prueba)", "Standard of Proof (Estándar Probatorio)", "Prima Facie Case", "De Novo Review (Revisión Completa)", "Stare Decisis (Mantener lo Decidido)", "Ratio Decidendi vs. Obiter Dictum",
             // Derecho Comercial y Societario
            "Actos de Comercio", "Comerciante: Estatuto Jurídico", "Sociedad Colectiva, Comanditaria, Responsabilidad Limitada, Anónima", "Sociedad por Acciones Simplificada (SAS)", "Órganos Sociales (Junta, Directorio, Gerencia)", "Derechos y Obligaciones de los Socios/Accionistas", "Aumento y Disminución de Capital", "Disolución y Liquidación de Sociedades", "Fusión y Escisión de Sociedades", "Grupos de Empresas (Holding)", "Levantamiento del Velo Corporativo (Piercing the Corporate Veil)", "Acción Derivada (Derivative Action)", "Deber de Lealtad y Diligencia de Administradores (Fiduciary Duty)", "Títulos Valores (Letra de Cambio, Pagaré, Cheque)", "Endoso", "Aval", "Protesto", "Contratos Mercantiles (Compraventa, Suministro, Agencia, Distribución, Franquicia)", "Contrato de Seguro", "Contrato de Transporte (Terrestre, Marítimo, Aéreo)", "Derecho Marítimo (Avería Gruesa, Conocimiento de Embarque)", "Derecho Aeronáutico", "Competencia Desleal", "Libre Competencia (Derecho Antimonopolio)", "Marcas Comerciales y Patentes (Protección)", "Contratos Electrónicos", "Firma Electrónica", "Lex Mercatoria", "Incoterms", "Joint Venture", "Underwriting", "Leasing (Arrendamiento Financiero)", "Factoring", "Securitización (Titulización)", "Mercado de Valores", "Oferta Pública de Adquisición (OPA)", "Insider Trading (Uso de Información Privilegiada)",
             // Derecho Internacional y Filosofía
            "Fuentes del Derecho Internacional (Tratados, Costumbre, Principios Generales)", "Sujetos del Derecho Internacional (Estados, Organizaciones Internacionales)", "Reconocimiento de Estados y Gobiernos", "Soberanía Estatal e Inmunidad", "Responsabilidad Internacional del Estado", "Solución Pacífica de Controversias (Negociación, Mediación, Arbitraje, Arreglo Judicial)", "Corte Internacional de Justicia (CIJ)", "Derecho de los Tratados (Convención de Viena)", "Reservas a los Tratados", "Ius Cogens (Normas Imperativas)", "Derecho Internacional Humanitario (Convenios de Ginebra)", "Corte Penal Internacional (CPI)", "Derecho del Mar (CONVEMAR)", "Derecho Espacial", "Derecho Internacional de los Derechos Humanos", "Sistemas Regionales de DDHH (Europeo, Interamericano, Africano)", "Asilo y Refugio", "Nacionalidad (Ius Soli, Ius Sanguinis)", "Apátridas", "Act of State Doctrine", "Filosofía del Derecho: Positivismo Jurídico", "Iusnaturalismo", "Realismo Jurídico (Americano, Escandinavo)", "Teoría Crítica del Derecho", "Estudios de Género y Derecho", "Análisis Económico del Derecho", "Teoría de la Argumentación Jurídica", "Hermenéutica Jurídica", "Justicia Distributiva vs. Justicia Correctiva", "Teorías de la Justicia (Rawls, Nozick, Sen)", "Derecho y Moral: Relación", "Desobediencia Civil", "Lagunas del Derecho (Anomia)", "Antinomias Jurídicas"
        ];
        const legalThemes = [ // Temas para generar más títulos
            "derecho constitucional comparado avanzado", "teoría general del proceso y litigación compleja", "obligaciones y contratos en derecho internacional privado", "derecho penal económico y compliance", "responsabilidad del Estado y control administrativo", "propiedad intelectual en la era digital", "arbitraje comercial internacional", "derecho internacional de los derechos humanos", "filosofía política y teoría de la justicia", "derecho societario y gobierno corporativo", "derecho de la competencia y regulación económica", "derecho ambiental internacional", "teoría de la interpretación y argumentación jurídica", "procedimientos concursales y reestructuración", "derecho de familia y sucesiones internacional", "derecho laboral colectivo y negociación", "tributación internacional", "derecho del ciberespacio", "neuroderecho y ética", "derecho deportivo internacional"
        ];
        const textApiConfig = {
            model: "mistral", // O considera "openai" si necesitas aún más detalle
            systemPrompt: "Eres un jurista experto y un excelente catedrático. Tu tarea es definir y explicar términos jurídicos complejos de forma exhaustiva, precisa y clara, asumiendo que el lector tiene una base jurídica pero busca profundizar en ese concepto específico. Detalla su significado, contexto normativo y doctrinal, posibles interpretaciones, implicaciones prácticas, jurisprudencia relevante (si es aplicable de forma general o ejemplar) y relación con otros conceptos. Evita la simplificación excesiva. Estructura la explicación con rigor académico, usando párrafos bien desarrollados y subtítulos (usando markdown #, ##, ###, ####) para organizar la información. El objetivo es una explicación detallada y completa de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente término o concepto legal:",
            timeoutSeconds: 150 // Ampliado el tiempo de espera
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un glosario legal avanzado. Genera exactamente 15 términos jurídicos específicos y complejos, o preguntas doctrinales avanzadas, adecuados para ser explicados en detalle. Devuelve *solo* la lista de términos/preguntas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 45 // Un poco más de tiempo por si acaso
        };

        // ========== DOM ELEMENTS ========== (sin cambios)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // --- Variable to hold the current scroll listener ---
        let currentScrollHandler = null;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) {
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`); // Log less verbose URL
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo.`);
                 throw new Error(`Error de comunicación con la API: ${error.message}`);
             }
         }
        async function fetchExplanationText(conceptTitle) {
            console.log(`Fetching explanation for: ${conceptTitle}`);
            const text = await fetchTextFromApi(conceptTitle, textApiConfig);
            // Check length relative to target
            if (text.trim().length < 800 || text.toLowerCase().includes("no puedo cumplir") || text.toLowerCase().includes("cannot fulfill")) { // Adjusted minimum length check
                 console.warn(`Generated text for "${conceptTitle}" seems too short (${text.trim().length} chars).`);
                 // Optionally throw error or just return the short text
                 // throw new Error("La IA no pudo generar una explicación suficientemente detallada.");
            }
            return text;
         }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(legalThemes) || "teoría general del derecho";
             const specificPrompt = `Genera 15 términos jurídicos específicos y complejos o preguntas doctrinales avanzadas sobre ${randomTheme}`;
             console.log("Generating concepts with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150); // Adjusted length filter
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes términos nuevos.");
             console.log("Generated new titles:", titles);
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "legal concept abstract structure";
             // More abstract prompt focusing on structure, complexity, relationships
             const enhancedPrompt = `Abstract conceptual visualization representing the complexity and structure related to the legal term '${safePromptText}', minimalist, geometric, focus on balance, relationships, or foundational principles, deep blue and grey palette`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Stronger negative prompt against literal legal symbols or text
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, equations, graphs, charts, diagrams, person, people, gavel, judge hammer, scales of justice, lady justice, courthouse, law book, documents, quill, pen, signature, realistic photo, specific objects, clear symbols, illustration, drawing";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url.substring(0, 200), "...");
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) {
             if (!rawText) return '';
            let formatted = rawText.trim();
            // LaTeX-like (less likely but keep just in case)
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             // Markdown
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Paragraphs
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, '<br>'); // Keep single newlines as <br> within paragraphs
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Scroll reset logic included)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }

        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll on hide
            console.log("Scroll set to 0 on hideModal");
            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
                console.log("Scroll listener removed on hideModal.");
            }
            resetModalState();
        }

        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             // ScrollTop reset is now primarily in hideModal and handleTitleClick
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.classList.remove('visible');
             modalImageContainer.style.display = 'none';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }

        // Add icon to title item
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // Add a default icon, can be refined later if needed
            const icon = document.createElement('i');
            icon.className = 'fas fa-book-open fa-fw'; // General legal book icon
            div.appendChild(icon);
            const textSpan = document.createElement('span');
            textSpan.textContent = title;
            div.appendChild(textSpan);
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }

        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]);
             titleListContainer.innerHTML = ''; // Clear previous or loading
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay términos disponibles.</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }

        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalImageContainer.style.display = 'none';
            modalImageContainer.classList.remove('visible');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
            }

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;

                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.scrollTop = 0; // <<<--- RESET SCROLL HERE ---<<<
                console.log("Scroll set to 0 after content visible");

                // Prepare image loading (hidden)
                modalImageSpinner.style.display = 'block';
                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL:", title);
                     modalImageSpinner.style.display = 'none';
                     modalImagePlaceholder.style.display = 'block';
                 }

                // Setup Scroll Listener
                const scrollBuffer = 20; // Increased buffer slightly for longer text
                currentScrollHandler = () => {
                    if (modalContent.scrollHeight <= modalContent.clientHeight) {
                         console.log("Content fits, showing image.");
                         modalImageContainer.classList.add('visible');
                         modalImageContainer.style.display = 'flex';
                         modalContent.removeEventListener('scroll', currentScrollHandler);
                         currentScrollHandler = null;
                    } else if ((modalContent.scrollTop + modalContent.clientHeight) >= (modalContent.scrollHeight - scrollBuffer)) {
                        console.log("Scroll end reached, showing image.");
                        modalImageContainer.classList.add('visible');
                        modalImageContainer.style.display = 'flex';
                        modalContent.removeEventListener('scroll', currentScrollHandler);
                        currentScrollHandler = null;
                        console.log("Scroll listener removed after showing image.");
                    }
                };
                modalContent.addEventListener('scroll', currentScrollHandler);
                console.log("Scroll listener added.");
                // Initial check
                setTimeout(currentScrollHandler, 150); // Longer delay before initial check

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error al procesar el término: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = '';
                 if (currentScrollHandler) {
                    modalContent.removeEventListener('scroll', currentScrollHandler);
                    currentScrollHandler = null;
                 }
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Investigando...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; // Hide button container temporarily
                     appendTitles(newTitles);
                     // Re-append the button container *after* the new titles
                     if (titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block'; // Show button container again
                 } else {
                     alert("No se pudieron generar nuevos términos en este momento.");
                 }
             } catch (error) { console.error("Failed title generation:", error); alert(`Error al generar términos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Térmnos'; // Reset button text
             }
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Initialization failed: Critical elements missing."); document.body.innerHTML = '<p>Error crítico al inicializar la página.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            // Display the substantial list of predefined titles
            displayTitles(predefinedTitles);
            console.log(`App Initialized. ${predefinedTitles.length} predefined titles loaded.`);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>