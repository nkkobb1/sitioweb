<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecos de Poe - Cuentos de la Oscuridad</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Góticas/Clásicas -->
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,700;1,400&family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Ecos de Poe --- */
        :root {
            --color-primary: #6a0dad; /* Morado Oscuro Intenso */
            --color-secondary: #8b0000; /* Rojo Sangre Oscuro (uso moderado) */
            --color-tertiary: #483d8b; /* Azul Pizarra Oscuro */
            --color-background: #1a1a1a; /* Negro Carbón / Gris muy oscuro */
            --color-text: #e8e6e3; /* Blanco Hueso / Pergamino claro */
            --color-text-muted: #a1a1a1; /* Gris medio */
            --color-modal-bg: #2d2d2d; /* Gris Oscuro para modal */
            --color-border: #444444; /* Borde Gris más oscuro */
            --color-error-bg: #4d1212; /* Fondo error rojo muy oscuro */
            --color-error-text: #fecaca; /* Texto error claro */
            --color-error-border: #b91c1c; /* Borde error rojo oscuro */

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.6), 0 4px 6px -4px rgba(0, 0, 0, 0.5);
            --border-radius: 4px;
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'EB Garamond', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400; background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"%3E%3Cg fill-rule="evenodd"%3E%3Cg fill="%23333" fill-opacity="0.1"%3E%3Cpath d="M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM10 40h1.41l-1.41-1.41V40zM8.59 40l-2.83-2.83 1.41-1.41L8.59 40H10v-1.41zM40 1.41l-1.41 1.41-2.83-2.83L40 0v1.41zM40 10v1.41l-1.41-1.41H40zM40 8.59l-1.41 1.41-2.83-2.83L40 8.59V10zM1.41 0l1.41 1.41L0 2.83V0h1.41zM0 10h1.41L0 11.41V10zM0 8.59l1.41 1.41L0 11.41V8.59z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); /* Sutil textura */ }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel Decorative', serif; font-weight: 700; letter-spacing: 1.5px; }
        .logo { color: var(--color-primary); text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 1px 1px 5px rgba(106, 13, 173, 0.5); }
        h2.section-title { color: var(--color-text); border-bottom: 1px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; margin-bottom: 1.5rem !important;}
        #modal-title { color: var(--color-primary); font-weight: 700; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); font-size: 1.7rem; } /* Ajuste tamaño */
        .navbar { background-color: rgba(26, 26, 26, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 3rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(45, 45, 45, 0.8); color: var(--color-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); transition: var(--transition-normal); font-family: 'EB Garamond', serif; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(106, 13, 173, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'EB Garamond', serif; font-size: 1.05rem; border-left: 4px solid transparent; position: relative; overflow: hidden; }
        .title-item::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(106, 13, 173, 0.2), transparent); transition: left 0.4s ease; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); border-color: var(--color-primary); color: var(--color-primary); background-color: #383838; border-left-color: var(--color-primary); }
        .title-item:hover::before { left: 100%; }
        #generate-more-btn { grid-column: 1 / -1; background: var(--color-primary); color: var(--color-text); padding: 0.9rem 1.8rem; border: 1px solid var(--color-tertiary); border-radius: var(--border-radius); font-family: 'Cinzel Decorative', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; letter-spacing: 1px; text-shadow: 1px 1px 2px #000; }
        #generate-more-btn:hover:not(:disabled) { background-color: var(--color-secondary); border-color: var(--color-primary); box-shadow: var(--shadow-md); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; text-shadow: none; }
        #generate-more-btn .fa-sync-alt { } /* Spinner takes button color */

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.95); /* Overlay oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.8rem 2.2rem;
            max-width: 1000px; /* Ligeramente más ancho */
            width: 96%;
            max-height: 90vh;
            min-height: 450px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: var(--color-text); transform: rotate(90deg); box-shadow: 0 0 8px var(--color-secondary); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.4; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; margin-bottom: 1.2rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(68, 68, 68, 0.7);
        }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(68, 68, 68, 0.7); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-size: 1.1rem; /* Texto ligeramente más grande */ }
        #modal-content p { margin-bottom: 1.5em; text-indent: 1.5em; /* Sangría Poe */ }
        #modal-content p:first-of-type { text-indent: 0; } /* Sin sangría en el primer párrafo */
        #modal-content strong { color: var(--color-primary); font-weight: 700; font-style: italic;}
        #modal-content em { color: var(--color-text); font-style: italic; border-bottom: 1px dotted var(--color-text-muted); /* Énfasis sutil */ }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel Decorative', serif; margin-top: 2.5em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 400; letter-spacing: 1px; text-indent: 0 !important; /* Sin sangría en títulos */ }
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 3rem auto 1.5rem auto; border: 2px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; filter: grayscale(30%) sepia(20%); opacity: 0.9; }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: 0 0 20px rgba(106, 13, 173, 0.4); filter: grayscale(0%) sepia(0%); opacity: 1; }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); border: 1px dashed var(--color-border); padding: 1rem; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(68, 68, 68, 0.8); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1.2s linear infinite; margin-bottom: 1rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; opacity: 0.7; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1.2rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* Un poco más de altura */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(26, 26, 26, 0.8); scroll-behavior: smooth; font-size: 0.95rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(68, 68, 68, 0.7);
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(68, 68, 68, 0.7); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; }
        .user-message { background-color: var(--color-tertiary); color: var(--color-text); margin-left: auto; text-align: left; /* User left align for readability */ font-weight: 400;}
        .ai-message { background-color: #444444; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; font-style: italic; /* AI more narrative */ }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #383838; color: var(--color-text); border-radius: var(--border-radius); font-family: 'EB Garamond', serif; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); background-color: #444; }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: var(--color-text); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #8a3fdc; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-style: italic; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 26, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.3s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.4rem; font-family: 'Cinzel Decorative'; text-shadow: 1px 1px 3px #000; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'EB Garamond', serif; font-size: 1.1rem; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-border); box-shadow: var(--shadow-lg); filter: grayscale(10%) sepia(10%); /* Subtle effect even fullscreen */ }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 42px; height: 42px; font-size: 1.9rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); opacity: 0.8; }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-text); transform: scale(1.1); opacity: 1; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-12">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-crow mr-3"></i> <!-- Icono cuervo -->
                     Ecos de Poe
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Cuentos de la Oscuridad Interior «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-14 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-6">Susurros de la Noche Eterna</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light italic">Adéntrate en abismos donde la razón flaquea y la sombra del cuervo jamás se aparta. Elige un título, si osas...</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-12 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar por título o palabra clave...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-dead text-purple-400 mr-2"></i> <!-- Icono libro muerto -->
                 Fragmentos Recuperados
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans italic">Recuperando manuscritos olvidados...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans italic">» Ningún fragmento corresponde a vuestra búsqueda... por ahora «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Invocar Más Relatos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Desenterrando el Manuscrito...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image and placeholder will be appended here via JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                      <h4 class="text-center text-sm font-semibold text-gray-400 mb-2 font-sans tracking-wide">Consultar al Narrador</h4>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> El narrador medita vuestra pregunta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Interrogad sobre este relato...">
                         <button id="chat-send-btn" aria-label="Enviar Pregunta">
                             <i class="fas fa-feather-alt"></i> <!-- Icono pluma -->
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Ilustración Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-black text-gray-600 py-6 mt-12 border-t border-gray-800 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Estos relatos son creaciones ficticias generadas por IA, inspiradas en el estilo inmortal de Edgar Allan Poe.</p>
              <p class="mt-1">Que la oscuridad os sea leve.</p>
              <p class="mt-2">© MMDCCLXXVII Archivos del Cuervo</p> <!-- Año gótico :) -->
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Títulos muy exhaustivos inspirados en Poe (400+)
            // Obsesión y Locura
            "El Corazón Revelador del Relojero", "La Sombra que Ríe en el Espejo", "El Retrato Inacabado de Elara", "La Manía del Taxidermista", "El Susurro Persistente del Empapelado", "La Confesión Escrita en Polvo", "El Coleccionista de Lágrimas", "La Música Prohibida de Roderick", "El Autómata que Amó Demasiado", "La Mirada Vacía de la Muñeca", "Los Ojos que Vigilan desde el Cuadro", "La Fiebre del Oro Negro", "El Secreto del Escultor de Gárgolas", "La Danza Macabra de los Hilos", "El Último Pensamiento de un Hombre Cuerdo", "Las Voces en la Concha Marina", "El Reflejo que No Era Mío", "La Obsesión por la Simetría Perfecta", "El Laberinto Mental del Cartógrafo", "La Sonrisa Congelada de Ligeia", "El Perfume Embriagador de la Muerte", "La Fijación por el Número Trece", "El Jardín de las Plantas Carnívoras", "La Risa Ahogada en la Almohada", "El Eco de un Grito Silenciado", "La Persecución de la Mariposa Negra", "El Hombre que Contaba Latidos", "La Locura Heredada de los Blackwood", "El Pacto con la Propia Sombra", "La Sed Insaciable de Conocimiento Prohibido",
            // Muerte y Decadencia
            "Más Allá del Velo de Annabel", "La Cripta Olvidada de los Montresor", "El Último Suspiro de la Casa Usher", "La Podredumbre Dulce de la Orquídea Negra", "El Polvo de Huesos en la Copa de Vino", "La Lenta Agonía del Roble Centenario", "El Cadáver en el Péndulo", "La Descomposición de la Belleza", "El Moho que Devoró la Biblioteca", "La Máscara de la Muerte Roja Revisitada", "Cenizas al Viento Marino", "El Festín de los Gusanos", "La Pálida Dama del Cementerio Bruma", "El Río Estigia en el Sótano", "La Calavera Sonriente en el Escritorio", "El Jardín donde Nada Florece", "La Estatua Erosionada por Lágrimas Ácidas", "El Tapiz Deshilachado del Tiempo", "La Última Voluntad del Conde Pútrido", "El Esqueleto en el Armario de Caoba", "La Marcha Fúnebre del Silencio", "El Olor a Tumba Abierta", "La Telaraña sobre el Laúd Roto", "El Legado de Polvo y Olvido", "La Muerte Lenta del Lago Esmeralda", "El Epitafio Borrado por la Lluvia", "La Carroña bajo la Luna Pálida", "El Libro Encuadernado en Piel Humana", "El Banquete Interrumpido por la Parca", "La Flor Marchita en el Ojal",
            // Entierro Prematuro y Claustrofobia
            "El Ataúd con Forro de Terciopelo", "Despertar Bajo Tierra", "La Tumba Demasiado Estrecha", "El Sonido de la Pala Arriba", "El Aire Viciado de la Cripta Sellada", "Atrapado entre Paredes que se Mueven", "El Último Clavo en la Tapa", "La Oscuridad Infinita del Nicho", "Sin Espacio para Gritar", "El Reloj de Arena en la Tumba", "La Pesadilla de Ser Emparedado Vivo", "La Losa que No Cedía", "El Crujido de Raíces Cercanas", "La Compañía de los Huesos", "El Eco de mi Propio Corazón", "La Claustrofobia del Alma", "La Cripta Inundada", "El Laberinto Subterráneo sin Salida", "El Miedo a los Espacios Cerrados", "El Silencio Opresivo del Sarcófago", "La Llave Perdida de la Catacumba", "Respirando Polvo y Desesperación", "El Gusano como Única Compañía", "La Luz que Nunca Llegó", "El Arañazo Final en la Madera", "Condenado a la Oscuridad Eterna", "El Peso de la Tierra Sobre Mí", "La Falsa Muerte y el Verdadero Horror", "El Espejo Dentro del Ataúd", "El Último Aliento Robado",
            // Lo Sobrenatural Ambiguo y el Terror Psicológico
            "La Visita Nocturna del Cuervo de Ébano", "El Gato Negro de la Conciencia", "La Sombra con Ojos Rojos", "El Ser en el Umbral", "La Presencia en la Habitación Vacía", "El Manuscrito Hallado en una Botella Rota", "El Doble que Me Acecha", "La Llamada desde el Otro Lado del Espejo", "El Vórtice en el Fondo del Vaso", "La Casa que Respira", "El Retorno Inesperado de Morella", "El Juramento Roto y su Consecuencia Espectral", "La Niebla que Susurra Nombres", "El Retrato que Envejece por Mí", "La Melodía Fantasma del Violín", "El Corazón que Late Fuera del Cuerpo", "La Maldición de la Sangre Antigua", "El Encuentro con el Hombre Pálido", "La Ciudad Sumergida en la Locura", "El Demonio de la Perversidad", "La Advertencia del Péndulo", "El Reloj que Marca la Hora de la Muerte", "La Sensación de Ser Observado", "El Horror sin Nombre", "La Puerta que Nunca Debió Abrirse", "El Pacto Involuntario", "La Criatura de la Tormenta", "El Destino Escrito en las Estrellas Negras", "La Metamorfosis Inexplicable", "El Abismo que Devuelve la Mirada",
            // Venganza y Culpa
            "El Barril de Amontillado: La Secuela", "La Venganza Servida Fría en la Morgue", "El Eco de la Traición en la Mansión", "La Deuda de Sangre de los Valdemar", "El Fantasma Acusador", "La Mancha que No Desaparece", "El Peso del Secreto Inconfesable", "La Justicia Poética del Cuervo", "Enterrado con mi Enemigo", "El Regalo Envenenado", "La Confesión Forzada por la Culpa", "El Ojo que Todo lo Ve (y Juzga)", "La Venganza del Hombre Emparedado", "El Círculo de Odio Infinito", "La Maldición del Último Deseo", "Pagarás por lo que Hiciste, Lenore", "La Sombra del Remordimiento", "El Juicio Final en el Corazón", "La Cicatriz del Alma", "El Pasado que Regresa para Cobrar", "La Redención Imposible", "El Precio de la Traición", "La Danza de la Culpa y el Castigo", "El Espectro de la Víctima", "La Espiral Descendente de la Conciencia Culpable", "La Mentira que Devoró al Mentiroso", "El Secreto Familiar Sangriento", "La Venganza Escrita en Sangre", "Atormentado por el Recuerdo", "El Silencio Cómplice",
            // Lugares Tenebrosos
            "La Isla del Doctor Moreau (Estilo Poe)", "El Sanatorio de Blackwood Pines", "La Mansión sobre el Acantilado Nebuloso", "El Faro Solitario de la Desesperación", "La Cabaña en el Corazón del Bosque Prohibido", "El Callejón Sin Retorno", "La Biblioteca de los Libros Malditos", "El Teatro Abandonado de las Marionetas Vivas", "El Cementerio Marino de Barcos Fantasma", "Las Catacumbas Bajo la Ciudad Olvidada", "El Pantano de las Luces Fatuas", "La Torre del Reloj Detenido", "El Ático Lleno de Secretos", "El Sótano Húmedo y Frío", "La Habitación Sellada Durante un Siglo", "El Jardín de Estatuas que Lloran", "El Puente de los Suspiros Eternos", "La Posada Donde Nadie Duerme", "El Orfanato de los Niños Pálidos", "La Mina de Sal Negra", "El Laberinto de Setos Sangrientos", "La Catedral Profanada", "El Observatorio de las Estrellas Muertas", "La Aldea Devorada por la Niebla", "El Pozo de los Lamentos", "La Vía Férrea Hacia Ninguna Parte", "El Mercado Negro de Almas", "La Galería de los Retratos Acusadores", "La Cripta Familiar de los Usher", "El Bosque Susurrante",
            // Otros Temas Poeanos
            "La Belleza Mortal de Ligeia II", "El Enigma de la Carta Robada (Otra Vez)", "La Ciencia Prohibida del Dr. Tarr y el Prof. Fether", "Un Descenso al Maelström Interior", "La Verdad en el Fondo del Barril", "El Escarabajo de Oro y la Maldición", "La Filosofía del Mobiliario Macabro", "El Ángel de lo Bizarro", "El Poder de las Palabras (Oscuras)", "El Hombre de la Multitud Solitaria", "Conversación con una Momia Despierta", "El Sistema del Engaño Perfecto", "La Impaciencia del Corazón", "El Demonio en el Campanario (Reimaginado)", "La Semana de los Tres Domingos Negros", "El Cuento Mil y Dos de Scheherazade (Versión Poe)", "El Dominio de Arnheim Oscuro", "El Engaño del Globo Terráqueo", "El Misterio de Marie Rogêt (Resuelto Macabramente)", "El Coloquio de Monos y Una (Siniestro)", "Von Kempelen y su Descubrimiento Mortal", "Nunca Apuestes tu Cabeza al Diablo (Consecuencias)", "El Rey Peste (Coronado de Nuevo)", "Silencio - Una Fábula Oscura", "Sombra - Una Parábola Tenebrosa", "El Aliento Perdido", "Bon-Bon y el Diablo", "El Duque de L'Omelette (Fatal)", "Cuatro Bestias en Una (Más Oscuras)", "La Cita Asignada (Final Trágico)",

            // Continuación para llegar a 400+
            "La Melancolía del Cuarto Carmesí", "El Último Baile de Madeline", "Bajo la Sombra del Campanario", "El Espejismo en el Desierto del Alma", "La Carta Jamás Enviada a Lenore", "El Secreto del Agua Estancada", "La Máscara de Hierro del Silencio", "El Autómata Roto", "La Canción Olvidada del Laúd", "El Rostro en la Ventana Escarchada", "El Frío Abrazo de la Estatua", "La Paradoja del Tiempo Detenido", "El Eco en la Casa Vacía", "La Daga Ceremonial Ensangrentada", "El Libro que Nadie Podía Leer", "La Niebla Púrpura del Ocaso", "El Último Viaje del 'Nautilus' Maldito", "El Perfume Letal de la Dama Pálida", "El Juego de Ajedrez con la Muerte", "La Ciudad Construida Sobre Huesos", "El Murmullo del Mar en la Calavera", "La Sonrisa del Retrato Quebrado", "El Legado del Alquimista Loco", "La Telaraña de Plata bajo la Luna", "El Viento que Gime en la Chimenea", "La Cerradura Quebrada", "El Refugio en la Tormenta Interior", "La Flor de Lis Negra", "El Diario Inacabado", "La Mirada Hipnótica de la Serpiente", "El Silbido en la Oscuridad", "La Promesa Rota al Atardecer", "El Jardín Petrificado", "La Lágrima de Cristal Negro", "El Laberinto de Espejos Rotos", "La Caricia Helada del Fantasma", "El Relicario Que Contenía un Corazón", "La Sombra Alargada del Pasado", "El Festín Interrumpido", "La Danza Solitaria de Eleonora", "El Último Acorde del Órgano", "La Huella Imborrable", "El Secreto del Tapiz Rasgado", "La Noche Eterna del Solsticio de Invierno", "El Velo Nupcial Ensangrentado", "La Jaula Dorada del Alma", "El Puente Hacia el Olvido", "La Carcajada en la Mansión Silenciosa", "El Retorno del Marinero Fantasma", "La Maldición del Faro Ciego", "El Ojo de Vidrio del Profeta", "La Cripta Bajo el Sauce Llorón", "El Engaño de la Calma Aparente", "La Fiebre Escarlata", "El Hombre que Perdió su Sombra", "La Colección de Máscaras Fúnebres", "El Secreto del Reloj de Arena Vacío", "La Presencia Detrás de la Cortina", "El Último Deseo Concedido por el Diablo", "La Tinta Simpática de la Locura", "El Reflejo Invertido", "La Ciudad bajo el Lago Helado", "El Murmullo de las Paredes", "La Belleza Quebrada", "El Cáliz Envenenado", "La Partitura Diabólica", "El Eco de Pasos que No Existen", "La Muñeca de Porcelana Que Llora Sangre", "El Secreto de la Habitación Azul", "La Noche de los Muertos Vivientes (Estilo Poe)", "El Retrato que Sangra", "La Maldición de la Perla Negra", "El Laberinto de la Culpa", "La Cuerda de Ahorcado como Marcapáginas", "El Silencio Antes del Grito", "La Visión en el Ópalo Nublado", "El Candado Oxidado del Corazón", "La Melodía que Enloquece", "El Doble en el Daguerrotipo", "La Última Cena Solitaria", "El Gato que Sabía Demasiado", "La Venganza del Relojero Ciego", "El Susurro del Viento entre las Tumbas", "La Llama Negra de la Vela Eterna", "El Secreto del Jardín de Hiedra Venenosa", "La Risa del Ahorcado", "El Libro de las Sombras", "La Mujer Emparedada", "El Espejo que Robaba Almas", "La Última Página del Diario Prohibido", "El Baile de los Esqueletos", "La Casa en la Colina Embrujada (Versión Poe)", "El Corazón Enterrado Bajo el Árbol Torcido", "La Maldición de la Máscara Sonriente", "El Secreto del Lago Sin Fondo", "La Sombra que Danza Sola", "El Último Invierno de Roderick Usher", "La Dama de las Camelias Negras", "El Fantasma en la Máquina de Escribir", "La Confesión del Sepulturero", "El Vino Añejo de la Venganza", "La Criatura Bajo las Escaleras", "El Retrato Viviente", "La Caja de Música Silenciosa", "El Secreto del Ático Polvoriento", "La Noche de la Tormenta Perfecta", "El Hombre que Hablaba con los Cuervos", "La Última Visita de Lenore", "El Laberinto de Huesos", "La Melancolía Eterna", "El Pacto Sellado con Sangre", "La Visión en el Vitral Roto", "El Silencio de la Cripta Inundada", "La Venganza del Gato Emparedado", "El Legado Maldito de los Fortunato", "La Belleza Marchita de Berenice"
            // ... y así sucesivamente, combinando elementos y temas.
        ];
        const poeThemes = [
            "locura y obsesión", "muerte y decadencia", "entierro prematuro", "terror psicológico", "lo sobrenatural ambiguo", "la muerte de una mujer hermosa", "venganza y culpa", "lugares góticos", "el doble (doppelgänger)", "la perversidad", "el paso inexorable del tiempo", "la fragilidad de la razón", "secretos oscuros", "atmósferas opresivas", "narradores no fiables", "simbolismo animal (cuervo, gato negro)", "la belleza macabra", "pactos siniestros", "maldiciones familiares", "estados alterados de conciencia"
        ];
        const textApiConfig = { // Para generación del cuento
            model: "mistral", // O un modelo más potente si está disponible y se prefiere
            systemPrompt: "Actúa como si fueses Edgar Allan Poe reencarnado, o un maestro imitador de su estilo. Debes escribir un cuento corto de terror gótico, de aproximadamente 1200-1300 palabras, inspirado EXCLUSIVAMENTE en el título proporcionado. Emplea un lenguaje rico, ornamentado y arcaico. Construye una atmósfera opresiva y melancólica. Explora temas como la locura, la muerte, la obsesión, la culpa, el entierro prematuro, o lo sobrenatural ambiguo. Utiliza frases largas y complejas, un vocabulario preciso y evocador, y enfócate en el terror psicológico y la desintegración de la mente del narrador (que a menudo no es fiable). Evita clichés modernos de terror. El cuento debe desarrollarse lógicamente a partir del título y mantener la coherencia estilística de Poe hasta el final. Basa tu cuento únicamente en este título:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Más rápido para chat
            systemPrompt: "Actúa como un erudito literario versado en la obra y estilo de Edgar Allan Poe, o como el propio narrador del cuento recién leído (adopta su tono). Responde preguntas sobre el cuento específico titulado '[TITULO_AQUI]' que acabas de 'presentar'. Analiza sus temas, simbolismos, personajes, o decisiones estilísticas, siempre manteniendo el tono apropiado (erudito o narrador Poe-esco) y enfocándote estrictamente en el contenido y estilo de ESE cuento. Sé elocuente pero relativamente conciso.",
            timeoutSeconds: 50 // Menor timeout
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Genera exactamente 15 títulos nuevos y originales para cuentos de terror gótico al más puro estilo de Edgar Allan Poe. Los títulos deben ser evocadores, atmosféricos y sugerir temas como la locura, la muerte, la obsesión, lugares lúgubres o lo sobrenatural. Usa sustantivos y adjetivos impactantes. Devuelve *solo* la lista de títulos, uno por línea, sin números, guiones ni explicaciones.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales, solo nombres si acaso)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Área scrollable de texto+imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div del texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            // *** Actualiza dinámicamente el system prompt del chat ***
            const systemPromptToUse = isChat && currentStoryTitle
                 ? config.systemPrompt.replace('[TITULO_AQUI]', currentStoryTitle)
                 : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}, Title: ${isChat ? currentStoryTitle : 'N/A'}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores tiemblan bajo el peso del tráfico arcano. Por favor, intentad de nuevo en unos instantes.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0 || text.toLowerCase().includes("cannot fulfill request") || text.toLowerCase().includes("unable to generate")) {
                    throw new Error("Las musas oscuras guardan silencio por ahora. La IA no pudo generar una respuesta adecuada.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión con el éter se ha demorado demasiado (>${config.timeoutSeconds}s). Verificad vuestra conexión o aguardad a que las estrellas sean propicias.`);
                }
                throw new Error(error.message || "Un horror sin nombre ha impedido la comunicación con la IA.");
            }
        }
        async function fetchStoryText(storyTitle) {
            return fetchTextFromApi(storyTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentStoryTitle) throw new Error("Error interno: El contexto del relato se ha perdido en las sombras.");
            // Asegúrate de que el prompt para el chat incluya la pregunta del usuario
            const chatPrompt = `Considerando el cuento '${currentStoryTitle}', responde a la siguiente pregunta del lector: ${userQuery}`;
            return fetchTextFromApi(chatPrompt, chatApiConfig, true); // true indica que es chat
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(poeThemes) || "terror gótico general";
            const specificPrompt = `Genera 15 títulos de cuentos góticos al estilo Poe, sobre el tema de: ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La inspiración macabra es esquiva; no se generaron suficientes títulos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "gothic horror illustration";
            // Prompt más específico para estilo Poe
            const enhancedPrompt = `Dark, atmospheric, gothic illustration inspired by the Edgar Allan Poe story concept '${safePromptText}'. Style of Gustave Doré, Harry Clarke, or gloomy Victorian engravings. Focus on shadow, mood, decay, psychological horror elements. Muted colors (blacks, greys, deep purples, dark reds). Avoid bright colors, modern elements, text, labels.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "photorealistic, photograph, cheerful, happy, bright colors, sunshine, text, words, labels, letters, title, caption, diagram, chart, modern clothing, technology, UI, watermark, signature, multiple images, collage";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (Potencialmente útil para IA que use markdown)
        function formatStoryText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            // Quitar posibles indicadores de formato de IA que no queremos
            formatted = formatted.replace(/^```[\s\S]*?```$/gm, ''); // Bloques de código
            formatted = formatted.replace(/^>\s+/gm, ''); // Citas de bloque
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); // MathJax \text
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); // Subíndices
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); // Superíndices
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); // Flecha
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); // Fórmulas (poco probable)
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); // H4
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); // H3
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); // H2
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');   // H1
            // Negrita y Cursiva (Markdown estándar)
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Párrafos: Separados por doble salto de línea.
            // Asumimos que la IA generará párrafos así.
            const paragraphs = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = paragraphs.map(p => {
                // Si ya es un encabezado o fórmula, dejarlo como está
                if (p.startsWith('<h') || p.startsWith('<p class="formula">')) return p;
                // Limpiar saltos de línea internos dentro de un párrafo (convertir a espacio)
                const content = p.replace(/\n/g, ' ').trim();
                return `<p>${content}</p>`; // Envuelve en etiqueta <p>
            }).join('');

            return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            // Reset scroll del área de contenido modal
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = ''; // Limpia texto e imagen
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null; // Limpia contexto
             hideFullscreenImage(); // Asegura que overlay esté oculto
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            // Formato básico para respuesta de IA
            if (sender === 'ai') {
                message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            }
            msgDiv.innerHTML = message; // Usar innerHTML para formato
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentStoryTitle) return;

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                // fetchChatResponse ya usa el prompt contextualizado
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error del Narrador: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar alfabéticamente puede romper un poco la inmersión, quizás mantener el orden original o aleatorio?
             // const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); // Opcional
             const shuffledTitles = shuffleArray([...titles]); // Mostrar en orden aleatorio
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center italic">» Los archivos están vacíos... por ahora «</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             // Añadir solo los nuevos, quizás al principio o al final
             const trulyNewTitles = newTitles.filter(title => !existingTitles.has(title));
             trulyNewTitles.forEach(title => {
                 // Decidir si añadir al principio o al final
                 // titleListContainer.appendChild(createTitleItem(title)); // Añadir al final
                 titleListContainer.insertBefore(createTitleItem(title), titleListContainer.firstChild); // Añadir al principio
             });
             filterTitles(searchInput.value); // Reaplicar filtro
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawStoryText = await fetchStoryText(title);
                const formattedStory = formatStoryText(rawStoryText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedStory; // Poner texto primero
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset scroll DESPUÉS de poner contenido
                console.log("Scroll set to 0 after content visible");

                // Preparar placeholder DENTRO de modalContent
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-palette placeholder-icon"></i> <!-- Icono paleta/arte -->
                    <p style="font-size: 0.9em; margin-top: 0.5rem; font-style: italic;">Evocando la ilustración...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Añadir placeholder al final del texto

                // Crear elemento imagen
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración inspirada en ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => {
                        showFullscreenImage(imgElement.src);
                    });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-skull-crossbones placeholder-icon"></i><p style="font-size:0.9em;margin-top:0.5rem;font-style:italic;">La visión artística se ha desvanecido.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Añadir imagen al final del contenido
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon"></i><p style="font-size:0.9em;margin-top:0.5rem;font-style:italic;">Error al conjurar la imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Un horror indecible ha ocurrido al cargar el relato.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = ''; // Limpiar
                chatSection.classList.add('content-hidden'); // Ocultar chat si hay error principal
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando a las Musas Oscuras...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Las musas guardan silencio por ahora."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al invocar relatos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Invocar Más Relatos';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Chequeo robusto de elementos esenciales
             const essentialElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, modalTextArea, modalContent, modalLoadingIndicator, modalStoryContentArea, chatHistory, chatLoadingIndicator];
             if (essentialElements.some(el => !el)) {
                console.error("Initialization failed: Missing one or more essential DOM elements.");
                document.body.innerHTML = '<p style="color: #8b0000; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: EB Garamond, serif;">++ ERROR FATAL ++ La estructura misma de esta morada digital se ha corrompido. Faltan componentes esenciales. ++</p>';
                return;
             }

            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            // Fullscreen listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Carga inicial
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>