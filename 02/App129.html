<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enciclopedia Canina - Razas de Perros</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Amigables y Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Enciclopedia Canina --- */
        :root {
            --color-primary: #8fbc8f; /* Verde Musgo Suave */
            --color-secondary: #f0e68c; /* Caqui Claro (Arena) */
            --color-tertiary: #add8e6; /* Azul Claro (Cielo) */
            --color-background: #fdfcf9; /* Blanco Roto / Crema muy claro */
            --color-text: #4a4a4a; /* Gris Oscuro Suave */
            --color-text-muted: #7a7a7a; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro */
            --color-border: #e0e0e0; /* Borde Gris Claro */
            --color-error-bg: #fff0f0; /* Fondo error rosa muy claro */
            --color-error-text: #c0392b; /* Texto error rojo oscuro */
            --color-error-border: #f5b7b1; /* Borde error rosa claro */

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
            --border-radius: 8px; /* Bordes m√°s redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Poppins', sans-serif; font-weight: 700; }
        .logo { color: #556b2f; } /* Verde Oliva Oscuro para logo */
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700;}
        #modal-title { color: #556b2f; font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Nunito'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(143, 188, 143, 0.3); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 500; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Poppins'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: #556b2f; background-color: #f5fbf5; /* Verde muy claro */ border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Poppins', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #7aaa7a; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: #cccccc; color: #888888; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(74, 74, 74, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--color-border);
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #f0f0f0; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* √Årea de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: #556b2f; font-weight: 700; }
        #modal-content em { color: var(--color-primary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Poppins', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 500; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: #6b8e23; } /* Verde oliva m√°s claro */
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(224, 224, 224, 0.8); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-primary); } /* Icono tem√°tico */

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; background-color: #fafafa; /* Fondo ligeramente diferente */ border-radius: 0 0 var(--border-radius) var(--border-radius); }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fdfdfd; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: #a9a9a9 var(--color-border); /* Scrollbar gris */
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: #a9a9a9; border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 1rem; border-radius: 15px; /* Bordes m√°s suaves */ max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-tertiary); color: #333; margin-left: auto; text-align: left; border-bottom-right-radius: 3px;} /* Esquina diferente */
        .ai-message { background-color: #e9f5e9; /* Verde muy p√°lido */ color: var(--color-text); margin-right: auto; text-align: left; border-bottom-left-radius: 3px;}
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; padding: 0 0.8rem 0.5rem 0.8rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #ffffff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Nunito'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(143, 188, 143, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #7aaa7a; }
        #chat-send-btn:disabled { background-color: #cccccc; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid #e0e0e0; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 500; color: var(--color-text); font-size: 1.3rem; font-family: 'Poppins'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Nunito'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(50, 50, 50, 0.9); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid white; border-radius: 4px; box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: white; color: #333; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-dog mr-3 text-yellow-800"></i> <!-- Icono perro -->
                     Enciclopedia Canina
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">¬ª Todo sobre Razas de Perros ¬´</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Descubre el Mundo Canino</h1>
             <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto font-light">Explora cientos de razas de perros, aprende sobre sus cuidados, historia y temperamento. Encuentra tu compa√±ero ideal.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar raza o tema (ej: Labrador, cuidados, hipoalerg√©nico)...">
             <i class="fas fa-search fa-paw"></i> <!-- Icono huella/b√∫squeda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-green-700 mr-2"></i> <!-- Icono libro -->
                 √çndice de Razas y Temas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando listado de razas...</p>
                  <!-- Los .title-item se a√±adir√°n aqu√≠ -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">üêæ No encontramos razas o temas que coincidan con tu b√∫squeda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir M√°s Razas y Temas
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Consultando informaci√≥n canina...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se a√±adir√°n aqu√≠ v√≠a JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Pensando en perros...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta raza...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada de la Raza">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Informaci√≥n generada por IA basada en datos generales sobre razas caninas. Consulta siempre a un veterinario o experto para decisiones importantes.</p>
              <p class="mt-1">Las caracter√≠sticas de un perro individual pueden variar.</p>
              <p class="mt-2">¬© 2025 Enciclopedia Canina Interactiva</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Grupos FCI (como referencia y temas)
            "Grupo 1: Perros de Pastor y Perros Boyeros (excepto Boyeros Suizos)",
            "Grupo 2: Perros Tipo Pinscher y Schnauzer - Molosoides - Perros Tipo Monta√±a y Boyeros Suizos",
            "Grupo 3: Terriers",
            "Grupo 4: Teckels (Dachshunds)",
            "Grupo 5: Perros Tipo Spitz y Tipo Primitivo",
            "Grupo 6: Perros Tipo Sabueso, Perros de Rastro y Razas Semejantes",
            "Grupo 7: Perros de Muestra (Pointing Dogs)",
            "Grupo 8: Perros Cobradores de Caza - Perros Levantadores de Caza - Perros de Agua",
            "Grupo 9: Perros de Compa√±√≠a",
            "Grupo 10: Lebreles (Sighthounds)",

            // Razas Populares y Comunes (Lista Amplia)
            "Labrador Retriever", "Pastor Alem√°n", "Golden Retriever", "Bulldog Franc√©s", "Bulldog Ingl√©s", "Caniche (Poodle - todos los tama√±os)", "Beagle", "Rottweiler", "Teckel (Dachshund)", "Pointer Alem√°n de Pelo Corto (GSP)", "Pembroke Welsh Corgi", "Pastor Australiano", "Yorkshire Terrier", "Boxer", "Siberian Husky", "Doberman Pinscher", "Gran Dan√©s", "Schnauzer Miniatura", "Shih Tzu", "Boston Terrier", "Pomerania", "Havanese", "Bernese Mountain Dog (Boyero de Berna)", "Pastor de Shetland (Sheltie)", "Brittany Spaniel", "Cocker Spaniel Ingl√©s", "Cocker Spaniel Americano", "Springer Spaniel Ingl√©s", "Vizsla", "Pug (Carlino)", "Chihuahua", "Maltese (Bich√≥n Malt√©s)", "West Highland White Terrier (Westie)", "Bich√≥n Fris√©", "Collie (Rough y Smooth)", "Border Collie", "Basset Hound", "Akita Inu", "Akita Americano", "Shiba Inu", "Weimaraner", "Terranova (Newfoundland)", "San Bernardo", "Dogo de Burdeos", "Bullmastiff", "Mast√≠n Ingl√©s", "Rhodesian Ridgeback", "Galgo Ingl√©s (Greyhound)", "Whippet", "Galgo Italiano", "Jack Russell Terrier", "Parson Russell Terrier", "Scottish Terrier (Scottie)", "Cairn Terrier", "Bull Terrier", "Staffordshire Bull Terrier (Staffy)", "American Staffordshire Terrier (Amstaff)", "Airedale Terrier", "Irish Wolfhound (Lobero Irland√©s)", "Scottish Deerhound", "Borzoi (Galgo Ruso)", "Saluki", "Galgo Afgano", "Alaskan Malamute", "Samoyedo", "Chow Chow", "Keeshond", "Perro de Agua Espa√±ol", "Perro de Agua Portugu√©s", "Lagotto Romagnolo", "Setter Irland√©s", "Setter Ingl√©s", "Gordon Setter", "Pointer Ingl√©s", "Bloodhound (Perro de San Huberto)", "Basenji", "D√°lmata", "Pinscher Miniatura", "Pinscher Alem√°n", "Schnauzer Est√°ndar", "Schnauzer Gigante", "Papillon", "Phal√®ne", "Cavalier King Charles Spaniel", "King Charles Spaniel", "Pekin√©s", "Chin Japon√©s", "Lhasa Apso", "Tibetan Spaniel", "Tibetan Terrier", "Mast√≠n Tibetano", "Shar Pei", "Perro sin pelo del Per√∫", "Xoloitzcuintle (Perro sin pelo Mexicano)", "Crestado Chino",

            // Razas Menos Comunes pero Reconocidas (Ampliando la lista)
            "Affenpinscher", "American Eskimo Dog", "American Foxhound", "English Foxhound", "Harrier", "Otterhound", "Petit Basset Griffon Vend√©en", "Grand Basset Griffon Vend√©en", "Black and Tan Coonhound", "Bluetick Coonhound", "Redbone Coonhound", "Plott Hound", "Treeing Walker Coonhound", "Wirehaired Pointing Griffon", "Spinone Italiano", "Braco Alem√°n de Pelo Duro (German Wirehaired Pointer)", "Braco H√∫ngaro de Pelo Duro", "Pudelpointer", "German Longhaired Pointer", "Large Munsterlander", "Small Munsterlander", "Clumber Spaniel", "Field Spaniel", "Sussex Spaniel", "Welsh Springer Spaniel", "Irish Water Spaniel", "American Water Spaniel", "Boykin Spaniel", "Curly-Coated Retriever", "Flat-Coated Retriever", "Chesapeake Bay Retriever", "Nova Scotia Duck Tolling Retriever", "Entlebucher Mountain Dog", "Appenzeller Sennenhund", "Greater Swiss Mountain Dog (Gran Boyero Suizo)", "Leonberger", "Hovawart", "Landseer", "Mast√≠n Napolitano", "Mast√≠n Espa√±ol", "Mast√≠n del Pirineo", "Perro de Monta√±a de los Pirineos (Great Pyrenees)", "Kuvasz", "Komondor", "Puli", "Pumi", "Mudi", "Pastor Belga (Groenendael, Laekenois, Malinois, Tervueren)", "Pastor Holand√©s", "Pastor de Beauce (Beauceron)", "Pastor de Brie (Briard)", "Pastor Picardo", "Border Terrier", "Lakeland Terrier", "Welsh Terrier", "Smooth Fox Terrier", "Wire Fox Terrier", "Irish Terrier", "Kerry Blue Terrier", "Soft Coated Wheaten Terrier", "Bedlington Terrier", "Manchester Terrier", "Dandie Dinmont Terrier", "Skye Terrier", "Sealyham Terrier", "Australian Terrier", "Cesky Terrier (Terrier Checo)", "Norfolk Terrier", "Norwich Terrier", "Glen of Imaal Terrier", "Staffordshire Terrier Americano (Pit Bull Terrier - Nota: Ambig√ºedad con Amstaff)", "Rat Terrier", "Miniature Bull Terrier", "Silky Terrier", "Toy Fox Terrier", "English Toy Spaniel", "Brussels Griffon (Grif√≥n de Bruselas)", "Australian Silky Terrier", "Affenpinscher", "Cirneco dell'Etna", "Podenco Ibicenco", "Podenco Canario", "Podenco Portugu√©s", "Pharaoh Hound (Perro del Fara√≥n)", "Perro Pastor Polaco de las Llanuras (PON)", "Pastor Bergamasco", "Pastor de Maremma y Abruzos", "Pastor Eslovaco (Slovensk√Ω ƒåuvaƒç)", "Pastor Polaco de Podhale (Tatra)", "Pastor Catal√°n (Gos d'Atura Catal√†)", "Perro de Castro Laboreiro", "Perro de la Sierra de la Estrela", "Rafeiro do Alentejo", "Perro Fila Brasile√±o", "Dogo Argentino", "Tosa Inu", "Broholmer", "Dogo Canario (Presa Canario)", "Cane Corso (Mast√≠n Italiano)", "Perro Pastor de Anatolia (Kangal)", "Perro Pastor del C√°ucaso", "Perro Pastor de Asia Central (Alabai)", "Boerboel", "Thai Ridgeback", "Jindo Coreano", "Kai Ken", "Kishu Ken", "Hokkaido", "Shikoku", "Norbottenspets", "Perro de Osos de Carelia", "Laika de Siberia Occidental", "Laika de Siberia Oriental", "Laika Ruso-Europeo", "Spitz Finland√©s", "Spitz Alem√°n (Klein, Mittel, Gross, Wolfspitz/Keeshond, Zwergspitz/Pomeranian)", "Spitz Japon√©s", "Volpino Italiano", "Eurasier", "Elkhound Noruego (Cazador de Alces Noruego)", "Swedish Vallhund (Perro de los Visigodos)", "Icelandic Sheepdog (Perro de Pastor Island√©s)", "Norwegian Lundehund", "Finnish Lapphund", "Swedish Lapphund", "Lapponian Herder",

            // Temas Generales sobre Perros
            "Historia de la domesticaci√≥n del perro", "Clasificaci√≥n de las razas caninas (FCI, AKC)", "C√≥mo elegir la raza de perro adecuada para ti", "Consideraciones antes de adoptar un perro", "Cuidados b√°sicos del cachorro", "Alimentaci√≥n canina: Pienso vs. BARF vs. Comida casera", "Necesidades de ejercicio seg√∫n la raza", "Entrenamiento b√°sico de obediencia", "Socializaci√≥n del perro: importancia y m√©todos", "Problemas de comportamiento comunes y c√≥mo abordarlos", "Salud canina: Vacunaci√≥n y desparasitaci√≥n", "Enfermedades hereditarias comunes en ciertas razas", "Primeros auxilios para perros", "La importancia del juego en los perros", "Viajar con tu perro: Consejos y normativas", "Perros de trabajo: Tipos y funciones (polic√≠a, rescate, terapia, asistencia)", "Perros de caza: Categor√≠as y habilidades", "Perros de compa√±√≠a: Caracter√≠sticas y necesidades", "Perros potencialmente peligrosos (PPP): Legislaci√≥n y manejo responsable", "El lenguaje corporal canino: C√≥mo entender a tu perro", "Aseo e higiene canina: Ba√±o, cepillado, corte de u√±as", "Beneficios de tener un perro", "El v√≠nculo humano-animal", "Perros senior: Cuidados especiales", "Diferencias entre perros de raza pura y mestizos", "El mundo de las exposiciones caninas", "Deportes caninos (Agility, Canicross, Obediencia, etc.)", "Razas hipoalerg√©nicas: Mitos y realidades", "¬øCu√°les son las razas consideradas m√°s inteligentes?", "Razas de perros m√°s adecuadas para vivir en apartamentos", "Razas con mayor nivel de energ√≠a", "Razas de perros m√°s tranquilas", "Perros guardianes: Mejores razas", "Perros falderos: Origen y caracter√≠sticas", "Adaptaci√≥n de un perro adulto adoptado", "C√≥mo presentar un nuevo perro a mascotas existentes", "Gen√©tica canina b√°sica", "El olfato canino: Un superpoder", "La audici√≥n en los perros", "Visi√≥n canina: ¬øC√≥mo ven el mundo?", "Mitos comunes sobre perros y razas", "Terapias asistidas con animales (perros)", "El impacto de los perros en la salud mental humana", "Organizaciones caninas internacionales y nacionales", "Est√°ndares de raza: ¬øQu√© son y para qu√© sirven?", "Cruces de dise√±o (Labradoodle, Goldendoodle, etc.): Pros y contras", "La controversia de las razas braquic√©falas", "Conservaci√≥n de razas caninas aut√≥ctonas", "El perro en la cultura y el arte", "Figuras caninas famosas en la historia y la ficci√≥n",
             // Agrega m√°s seg√∫n sea necesario para alcanzar la meta...
        ];
        const dogBreedThemes = [ // Temas para 'Generar M√°s'
            "razas de perros peque√±os", "razas de perros grandes", "perros de caza", "terriers", "perros n√≥rdicos", "perros pastores", "boyeros", "molosos", "perros de compa√±√≠a", "lebreles", "perros de agua", "razas hipoalerg√©nicas", "perros para familias", "perros guardianes", "razas de perros inteligentes", "perros con poca necesidad de ejercicio", "perros con mucha energ√≠a", "cuidados del cachorro", "entrenamiento canino", "salud del perro", "historia de razas espec√≠ficas", "perros de trabajo", "razas raras", "perros mestizos", "adopci√≥n responsable"
        ];
        const textApiConfig = { // Para descripci√≥n principal
            model: "mistral",
            systemPrompt: "Eres un experto cin√≥logo y enciclopedista canino. Tu tarea es proporcionar una descripci√≥n detallada, precisa y completa sobre la raza de perro o tema canino indicado. Para razas, cubre: Origen e historia, apariencia general (tama√±o, peso, pelaje, colores), temperamento y personalidad, nivel de energ√≠a y necesidades de ejercicio, requisitos de aseo, salud (problemas comunes, esperanza de vida), idoneidad como mascota (para familias, ni√±os, otros animales), y necesidades de entrenamiento y socializaci√≥n. Para temas generales, ofrece una explicaci√≥n clara y bien estructurada. Utiliza un lenguaje accesible pero informativo. El objetivo es un art√≠culo enciclop√©dico de aproximadamente 1200-1300 palabras. Basa tu respuesta √∫nicamente en la siguiente raza o tema:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo r√°pido para chat
            systemPrompt: "Act√∫a como un asistente experto en la raza de perro que se est√° mostrando actualmente. Responde preguntas espec√≠ficas sobre sus caracter√≠sticas, cuidados, temperamento, o detalles mencionados en la descripci√≥n principal. S√© conciso, amigable y relevante a la raza en cuesti√≥n.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Act√∫a como un generador de ideas conciso para una enciclopedia canina. Genera exactamente 15 nombres de razas de perros (comunes o raras) o temas relacionados con el cuidado, comportamiento o historia canina. Devuelve *solo* la lista de nombres/temas, uno por l√≠nea. No incluyas n√∫meros, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (sin cambios estructurales, solo IDs)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        // ... (resto de elementos sin cambios en nombres)
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentBreedTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentBreedTitle
                 ? `Eres un asistente experto en la raza de perro llamada '${currentBreedTitle}'. Responde preguntas espec√≠ficas sobre sus caracter√≠sticas, cuidados, temperamento, o detalles mencionados en la descripci√≥n principal. S√© conciso, amigable y relevante a esta raza.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     // *** MENSAJE DE ERROR AMIGABLE ***
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tr√°fico en este momento, por favor intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La IA no pudo generar una respuesta. Intenta reformular la pregunta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexi√≥n tard√≥ demasiado (>${config.timeoutSeconds}s). Parece haber un problema de red, int√©ntalo m√°s tarde.`);
                 }
                 throw new Error(error.message || "Lo sentimos, ocurri√≥ un error inesperado al contactar con nuestro sistema.");
             }
        }
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentBreedTitle) throw new Error("Error interno: No se estableci√≥ la raza para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(dogBreedThemes) || "razas de perros variadas";
            const specificPrompt = `Genera 15 nombres de razas de perros o temas sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas nuevas.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             // Limpia el prompt para que sea solo la raza o concepto principal
             let cleanPrompt = promptText.split('(')[0].trim(); // Quita par√©ntesis
             cleanPrompt = cleanPrompt.replace(/Grupo \d+: /i, '').trim(); // Quita "Grupo X:"
             const safePromptText = typeof cleanPrompt === 'string' && cleanPrompt.trim() !== '' ? cleanPrompt : "dog";

             // Prompt mejorado para fotos de perros
             const enhancedPrompt = `High-quality photograph of a purebred ${safePromptText} dog, characteristic pose, natural lighting, clear focus on the dog's features, typical breed environment (park, home, outdoors). Single dog.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Negativos para evitar texto, dibujos, etc.
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple dogs, collage, illustration, drawing, sketch, cartoon, unrealistic, deformed, blurry, low quality, human hand, leash unless necessary";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (la misma funci√≥n de antes) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-‚àí]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('‚àí', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL, FULLSCREEN, CHAT FUNCTIONS ==========
        // (Estas funciones son pr√°cticamente id√©nticas a la versi√≥n anterior,
        // solo se asegura que usen `currentBreedTitle` para el contexto del chat
        // y que los textos internos sean apropiados)

        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentBreedTitle = null; // Limpia contexto
             hideFullscreenImage();
        }
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = `üê∂ Oops! ${message}`; // A√±ade un toque tem√°tico
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentBreedTitle) return; // Verifica contexto

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(error.message); // Muestra el error amigable de la API
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar alfab√©ticamente para mejor navegaci√≥n
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">üêæ No hay razas cargadas.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             // Reordenar todo alfab√©ticamente despu√©s de a√±adir puede ser pesado,
             // pero mantiene el orden. Alternativa: solo a√±adir al final y filtrar.
             // Por simplicidad, solo a√±adimos y filtramos:
             filterTitles(searchInput.value);
         }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentBreedTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-bone placeholder-icon"></i> <!-- Icono hueso -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Buscando foto de la raza...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Foto de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-camera placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo cargar la foto.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title); // Usa el t√≠tulo para generar la URL
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al crear URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message; // Mostrar error amigable
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || generateMoreBtn.disabled) return;
             const buttonText = generateMoreBtn.innerHTML; // Guardar texto original
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando m√°s...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("üêæ No encontramos m√°s razas o temas por ahora."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar: ${error.message}`); // Mostrar error amigable
             } finally {
                 generateMoreBtn.disabled = false;
                 // Restaurar texto original (sin el spinner si estaba oculto)
                 generateMoreBtn.innerHTML = buttonText.replace(/<i class="fas fa-sync-alt mr-2 animate-spin.*?"><\/i>/, '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>');
             }
         }

         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || searchTerm.trim() === ''); // Ocultar si hay resultados O si no hay b√∫squeda
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check for essential elements
             const essentialElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn];
             if (essentialElements.some(el => !el)) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: #c0392b; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Cr√≠tico: No se pudo inicializar la interfaz. Faltan componentes esenciales.</p>';
                 return;
             }

            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>