<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía de Abdomen para Hombres - Ejercicios y Rutinas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Limpias y Modernas -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Fitness (Abdomen Hombres) --- */
        :root {
            --color-primary: #2563eb; /* Azul Enérgico */
            --color-secondary: #10b981; /* Verde Esmeralda (Accent) */
            --color-tertiary: #f97316; /* Naranja Vibrante (Accent 2) */
            --color-background: #f3f4f6; /* Gris Muy Claro */
            --color-text: #1f2937; /* Gris Oscuro */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco */
            --color-border: #d1d5db; /* Borde Gris Claro */
            --color-error-bg: #fef2f2; /* Fondo error rojo muy claro */
            --color-error-text: #b91c1c; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Open Sans', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #eff6ff; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1d4ed8; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { /* Overlay */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); /* Gris oscuro traslúcido */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { /* Contenedor del modal */
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px; width: 95%;
            max-height: 90vh; min-height: 450px; /* Más alto para chat */
            overflow: hidden; position: relative; box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column;
        }
        .modal-close-btn { /* Botón cerrar */ position: absolute; top: 10px; right: 10px; background: #e5e7eb; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área Contenido Principal (Texto + Imagen) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-modal-bg); }
        #modal-content { padding: 0 5px; /* Texto */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: normal; font-weight: 600;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        /* Imagen Final y Placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(107, 114, 128, 0.2); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) #e5e7eb;
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: #e5e7eb; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; border-bottom-right-radius: 0;}
        .ai-message { background-color: #e5e7eb; color: var(--color-text); margin-right: auto; text-align: left; border-bottom-left-radius: 0;}
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem;}
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #1d4ed8; }
        #chat-send-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator & Mini-Game */
        #modal-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); text-align: center; padding: 2rem; }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #e5e7eb; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.2rem; font-family: 'Roboto'; margin-bottom: 1.5rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Mini-Game Styles */
        #loading-minigame { display: none; /* Hidden by default */ width: 80%; max-width: 300px; height: 150px; background-color: #e0f2fe; /* Light blue background */ border: 2px dashed var(--color-primary); border-radius: var(--border-radius); position: relative; overflow: hidden; margin-top: 1rem; }
        #minigame-instructions { font-size: 0.9em; color: var(--color-text-muted); margin-bottom: 0.5rem; font-weight: 400; }
        #minigame-target { position: absolute; width: 35px; height: 35px; background-color: var(--color-tertiary); border-radius: 50%; cursor: pointer; transition: all 0.1s ease-out; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); }
        #minigame-target i { color: white; font-size: 1.2em; }
        #minigame-target:active { transform: scale(0.9); }
        #minigame-score-display { font-size: 1em; color: var(--color-primary); font-weight: 700; margin-top: 0.5rem; }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Open Sans'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.95); /* Dark overlay */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); background-color: white; /* Background for potentially transparent diagrams */ }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-dumbbell mr-3 text-blue-600"></i>
                     Guía de Abdomen
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-semibold">Ejercicios y Rutinas para Hombres</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Define Tu Core</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora ejercicios efectivos, rutinas y consejos para fortalecer y marcar tu abdomen. ¡Encuentra tu próximo reto!</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar ejercicio, rutina o concepto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-list-check text-blue-600 mr-2"></i>
                 Catálogo de Ejercicios y Temas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Cargando ejercicios...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden">No se encontraron ejercicios o temas para tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Cargar 40 Más
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator & Mini-Game -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Preparando información...</p>
                 <!-- Mini-Game Area -->
                 <div id="loading-minigame">
                    <div id="minigame-instructions">¡Juega mientras esperas!</div>
                    <div id="minigame-target"><i class="fas fa-dumbbell"></i></div>
                    <div id="minigame-score-display">Puntos: <span id="minigame-score">0</span></div>
                 </div>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image placeholder/image goes here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al entrenador...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este ejercicio...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-800 text-gray-400 py-6 mt-12">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>La información es generada por IA y tiene fines educativos. Consulta siempre a un profesional de la salud o entrenador certificado antes de iniciar cualquier rutina de ejercicios.</p>
              <p class="mt-1">Los resultados varían según la persona, la dieta y la constancia.</p>
              <p class="mt-2">© 2025 Guía de Abdomen</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Ejercicios Clásicos y Variaciones
            "Crunch Abdominal Clásico", "Crunch Inverso (Reverse Crunch)", "Crunch con Piernas Elevadas", "Crunch Oblicuo (Oblique Crunch)", "Crunch en Bicicleta (Bicycle Crunch)", "Crunch con Cable en Polea Alta", "Crunch en Máquina Específica", "Sit-up Tradicional (Precauciones)", "Sit-up Declinado", "Frog Crunch", "V-Ups (Navajas)", "Tuck Crunch (Encogimientos Agrupados)", "Starfish Crunch (Crunch Estrella)",
            // Planchas y Variaciones
            "Plancha Frontal (Plank)", "Plancha Lateral (Side Plank)", "Plancha con Elevación de Brazo/Pierna", "Plancha Dinámica (Commando Plank)", "Plancha Spiderman", "Plancha con Rotación (Plank Jacks)", "Plancha Inversa (Reverse Plank)", "Plancha Larga (Long Lever Plank)", "Plancha RKC (Tensión Máxima)", "Plancha sobre Fitball", "Plancha con Deslizadores (Sliders)", "Side Plank Dips (Descensos Laterales)",
            // Elevaciones de Piernas y Variaciones
            "Elevación de Piernas Tumbado (Lying Leg Raise)", "Elevación de Piernas Colgado (Hanging Leg Raise)", "Elevación de Rodillas Colgado (Hanging Knee Raise)", "Elevación de Piernas en Silla Romana", "Flutter Kicks (Patadas de Natación)", "Scissor Kicks (Tijeras)", "Dragon Flag (Bandera del Dragón - Avanzado)", "Windshield Wipers Tumbado", "Windshield Wipers Colgado", "Garhammer Raise",
            // Rotaciones y Oblicuos
            "Russian Twist (Giro Ruso)", "Russian Twist con Peso", "Woodchoppers con Cable/Banda (Leñador)", "Side Bends con Mancuerna (Flexión Lateral)", "Landmine Twist (Giro con Barra)", "Cable Rotations (Rotaciones con Cable)", "Medicine Ball Rotational Throws (Lanzamientos Rotacionales)", "Saxon Side Bend", "Oblique V-Up",
            // Anti-Rotación / Anti-Extensión / Estabilidad Core
            "Pallof Press (Press Pallof)", "Bird Dog (Pájaro-Perro)", "Dead Bug (Bicho Muerto)", "Body Saw (Sierra Corporal)", "Stir the Pot (Remover la Olla con Fitball)", "Farmer's Walk (Paseo del Granjero)", "Suitcase Carry (Paseo Maleta)", "Ab Wheel Rollout (Rueda Abdominal)", "Hollow Body Hold (Posición Hueca)", "Loaded Carries (Transportes con Carga)",
            // Ejercicios con Equipamiento
            "Ab Crunch en Máquina", "Captain's Chair Leg Raise", "Cable Crunch Arrodillado", "Ejercicio Abdominal en Banco Declinado", "Uso del Fitball para Abdominales", "Ejercicios con Bandas de Resistencia para Core", "Abdominales con Rueda (Ab Wheel)", "Ejercicios con Kettlebell para Core", "TRX Suspension Training para Abdomen", "Uso de Deslizadores (Sliders) para Core",
            // Rutinas y Programación
            "Rutina de Abdomen para Principiantes (Bodyweight)", "Rutina Intermedia de Abdomen (con Peso Ligero)", "Rutina Avanzada de Abdomen (Alta Intensidad)", "Rutina Enfocada en Oblicuos", "Rutina para Abdomen Inferior", "Circuito de Abdominales (Estilo HIIT)", "¿Cuántos Días a la Semana Entrenar Abdomen?", "Frecuencia vs Intensidad en Entrenamiento Abdominal", "Cómo Integrar Abdominales en tu Rutina General", "Ejemplo de Semana de Entrenamiento con Foco Abdominal", "Progresión en Ejercicios Abdominales",
            // Conceptos y Teoría
            "Anatomía del Core: Recto Abdominal, Oblicuos, Transverso", "Importancia del Músculo Transverso Abdominal", "Diferencia entre Core y Abdominales", "Respiración Diafragmática y 'Bracing' Abdominal", "Errores Comunes al Hacer Abdominales", "Cómo Evitar Dolor de Cuello en Crunches", "El Mito de la Reducción de Grasa Localizada (Spot Reduction)", "Dieta para Conseguir Abdominales Marcados", "Porcentaje de Grasa Corporal y Visibilidad Abdominal", "La Conexión Mente-Músculo en Abdominales", "Calentamiento Específico para Abdomen", "Estiramientos para la Zona Abdominal", "Función del Core en Levantamientos Pesados (Sentadilla, Peso Muerto)", "Abdominales Hipopresivos: ¿Qué son y para qué sirven?", "Estabilidad Lumbar y Salud de la Espalda",
            // Preguntas Frecuentes
            "¿Son necesarios los abdominales para tener un core fuerte?", "¿Los abdominales ayudan a perder barriga?", "¿Qué ejercicio es mejor para el 'six-pack'?", "¿Puedo entrenar abdomen todos los días?", "¿Cuánto tiempo tardan en verse los resultados?", "¿Necesito peso para entrenar abdomen?", "¿Son malos los 'sit-ups' para la espalda?", "¿Cómo activo más los oblicuos?", "¿Qué hacer si siento dolor lumbar?", "¿Es mejor hacer muchas repeticiones o pocas con peso?", "Diferencia entre Crunch y Sit-up", "¿Cómo hacer la plancha correctamente?", "¿Son efectivos los cinturones vibradores?", "¿Qué comer antes y después de entrenar abdomen?", "¿Cómo mejorar la resistencia en planchas?",
             // Añadir más conceptos generales o específicos si se desea
            "Periodización del Entrenamiento Abdominal", "Abdominales Isométricos vs Dinámicos", "El Rol de la Genética en la Forma Abdominal", "Impacto del Estrés (Cortisol) en la Grasa Abdominal", "Hidratación y Definición Abdominal", "Suplementos Útiles para la Definición (Contexto General)", "Descanso y Recuperación Muscular Abdominal", "Variaciones de Plancha para Mayor Desafío", "Ejercicios Abdominales de Pie", "Cómo Usar el Foam Roller para el Core", "Evaluación de la Fuerza del Core", "Prevención de Lesiones en Entrenamiento Abdominal", "Ejercicios Abdominales Post-Lesión (con Supervisión)", "Adaptación de Ejercicios Abdominales con Limitaciones Físicas"
        ];
        const exerciseThemes = [ // Temas para generar más títulos
            "ejercicios abdominales específicos", "variaciones de plancha", "ejercicios para oblicuos", "core stability",
            "abdomen inferior", "entrenamiento con peso para abs", "rutinas de abdomen", "errores comunes en abs",
            "dieta para definición abdominal", "anatomía del core", "ejercicios abdominales en casa", "abdominales para principiantes",
            "abdominales avanzados", "importancia del transverso", "prevención dolor lumbar", "abdominales colgado",
            "ejercicios anti-rotación", "calentamiento para abdomen", "frecuencia entrenamiento abs", "ejercicios con fitball"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un entrenador personal certificado (CPT) y especialista en acondicionamiento físico masculino, con énfasis en el entrenamiento del core y abdominal. Tu tarea es explicar de forma clara, detallada y segura el ejercicio, rutina o concepto abdominal indicado. Incluye: Músculos principales trabajados, descripción paso a paso de la ejecución correcta, errores comunes a evitar, consejos para maximizar la efectividad, posibles variaciones (más fáciles/difíciles), y consideraciones de seguridad. Usa un lenguaje motivador pero realista. El objetivo es una guía completa de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tema:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúa como un asistente de entrenador personal. Responde preguntas específicas sobre el ejercicio o concepto abdominal que se está mostrando actualmente. Céntrate en detalles de forma, variaciones, o dudas relacionadas. Sé conciso y da consejos prácticos y seguros.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // *** SOLICITANDO 40 TÍTULOS ***
            systemPrompt: "Actúa como un generador de ideas conciso para una guía de fitness abdominal masculino. Genera exactamente 40 nombres de ejercicios, rutinas, conceptos de entrenamiento o preguntas frecuentes sobre abdominales y core para hombres. Devuelve *solo* la lista, uno por línea. Sin números, guiones, introducciones o despedidas.",
            timeoutSeconds: 60 // Aumentar ligeramente por si necesita más tiempo para 40
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que la versión anterior, añadiendo los del minijuego)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Mini-Game Elements
        const loadingMinigameArea = document.getElementById('loading-minigame');
        const minigameTarget = document.getElementById('minigame-target');
        const minigameScoreDisplay = document.getElementById('minigame-score');

        // ========== State & Game Variables ==========
        let currentExerciseTitle = null; // Contexto para chat
        let minigameInterval = null;
        let minigameScore = 0;
        let isGameRunning = false;

        // ========== API FUNCTIONS ==========
        // fetchTextFromApi, fetchExplanationText, fetchChatResponse (sin cambios funcionales, sólo prompts)
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentExerciseTitle
                ? `Eres un asistente de entrenador personal. Responde preguntas específicas sobre el ejercicio/concepto '${currentExerciseTitle}'. Céntrate en forma, variaciones, dudas. Sé conciso y seguro.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text (Chat: ${isChat}): ${url.substring(0, 150)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico ahora. Inténtalo en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta reformular.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentExerciseTitle) throw new Error("Error interno: Contexto del ejercicio no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }

        // *** MODIFIED: fetchGeneratedTitles to handle 40 ***
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(exerciseThemes) || "ejercicios abdominales generales";
            // El systemPrompt ya pide 40.
            const specificPrompt = `Genera 40 ítems (ejercicios, rutinas, conceptos, preguntas) sobre ${randomTheme} para hombres.`;
             console.log("Generating 40 titles with prompt:", specificPrompt);
             // Usa la función genérica fetchTextFromApi
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                  .then(text => {
                      const titles = text.split('\n')
                                        .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                        .filter(line => line.length > 5 && line.length < 150);
                      if (titles.length < 10) { // Pedimos 40, esperamos al menos 10
                           console.warn(`API devolvió ${titles.length} títulos, se esperaban ~40.`);
                           if (titles.length === 0) throw new Error("La IA no generó ideas de ejercicios.");
                      }
                      // Devolver hasta 40, incluso si la API da más o menos
                      return titles.slice(0, 40);
                  });
        }

        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 700, height: 500, nologo: true }; // Ajustar tamaño si se prefiere
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "core strength concept";
            // Prompt enfocado en ilustración de forma o concepto, evitar texto/diagramas complejos
            const enhancedPrompt = `Clean illustration or stylized diagram showing the form for the exercise '${safePromptText}', or a conceptual image of core muscle activation. Focus on clarity and anatomy (simplified). Avoid text, labels, numbers, arrows, photorealism. Fitness illustration style.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, arrows, numbers, complex diagram, graph, chart, watermark, signature, multiple exercises, gym background clutter, realistic photo";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (show/hide/reset sin cambios estructurales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            stopMinigame(); // Asegurarse de parar el juego al cerrar
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             stopMinigame(); // Parar juego en reset
             modalLoadingIndicator.style.display = 'flex'; // Mostrar loading por defecto
             loadingMinigameArea.style.display = 'none'; // Ocultar juego por defecto
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentExerciseTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Entrenador IA: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== MINI-GAME FUNCTIONS ==========
        function moveTarget() {
            if (!loadingMinigameArea || !minigameTarget) return;
            const areaRect = loadingMinigameArea.getBoundingClientRect();
            const targetRect = minigameTarget.getBoundingClientRect();
            const maxX = areaRect.width - targetRect.width;
            const maxY = areaRect.height - targetRect.height;
            const randomX = Math.max(0, Math.floor(Math.random() * maxX));
            const randomY = Math.max(0, Math.floor(Math.random() * maxY));
            minigameTarget.style.left = `${randomX}px`;
            minigameTarget.style.top = `${randomY}px`;
        }
        function handleTargetClick() {
            if (!isGameRunning) return;
            minigameScore++;
            minigameScoreDisplay.textContent = minigameScore;
            moveTarget(); // Mover inmediatamente al hacer clic
        }
        function startMinigame() {
            if (!loadingMinigameArea || !minigameTarget || isGameRunning) return;
            console.log("Starting Minigame");
            isGameRunning = true;
            minigameScore = 0;
            minigameScoreDisplay.textContent = minigameScore;
            loadingMinigameArea.style.display = 'block'; // Mostrar área del juego
            moveTarget(); // Posición inicial
            minigameTarget.addEventListener('click', handleTargetClick);
            // Mover el objetivo cada cierto tiempo si no se ha hecho clic
            minigameInterval = setInterval(moveTarget, 1300); // Mover cada 1.3 segundos
        }
        function stopMinigame() {
            if (!isGameRunning) return;
            console.log("Stopping Minigame. Final Score:", minigameScore);
            isGameRunning = false;
            clearInterval(minigameInterval);
            minigameInterval = null;
            if (minigameTarget) {
                minigameTarget.removeEventListener('click', handleTargetClick);
            }
            if(loadingMinigameArea) {
                 loadingMinigameArea.style.display = 'none'; // Ocultar área del juego
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay ejercicios disponibles.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
            if (!titleListContainer || !newTitles || newTitles.length === 0) return;
            const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
            let addedCount = 0;
            newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
            console.log(`Added ${addedCount} new titles.`);
            filterTitles(searchInput.value); // Re-apply filter
        }

        // *** MODIFIED: handleTitleClick to integrate Minigame start/stop ***
        async function handleTitleClick(title) {
            resetModalState(); // Resetea todo, incluyendo parar juego si estaba corriendo
            showModal();
            modalTitle.textContent = title;
            currentExerciseTitle = title; // Chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; // Asegurar que el loading se vea
            startMinigame(); // *** INICIAR MINIJUEGO AQUÍ ***

            try {
                const rawExplanationText = await fetchExplanationText(title);
                stopMinigame(); // *** PARAR MINIJUEGO ANTES DE MOSTRAR CONTENIDO ***
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none'; // Ocultar loading
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;
                console.log("Scroll reset after content visible");

                // Placeholder y carga de imagen (igual que antes)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Cargando ilustración...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Ilustración no disponible.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL imagen.</p>`; }

            } catch (error) {
                stopMinigame(); // *** PARAR MINIJUEGO TAMBIÉN EN CASO DE ERROR ***
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none'; // Ocultar loading
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar datos.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Mostrar área para ver error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Ya pide 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más ejercicios en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar ejercicios: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Texto del botón ya dice "Cargar 40 Más" en HTML
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Cargar 40 Más';
             }
         }

        // Search Filter Function (con normalización)
        function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Verificar todos los elementos necesarios
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !loadingMinigameArea || !minigameTarget || !minigameScoreDisplay) {
                console.error("Initialization failed: Missing essential UI elements (incl. minigame).");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Faltan componentes de la interfaz. Recarga la página.</p>';
                return;
             }
            // Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Carga inicial
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>