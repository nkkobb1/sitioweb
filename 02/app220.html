<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsicoGuía Interactiva - Patologías y Conceptos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y profesionales -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para PsicoGuía --- */
        :root {
            --color-primary: #3b82f6; /* Azul Medio (Calma, Confianza) */
            --color-secondary: #10b981; /* Verde Esmeralda (Salud, Equilibrio) */
            --color-tertiary: #f97316; /* Naranja Suave (Calidez, Apoyo - usar con moderación) */
            --color-background: #f8fafc; /* Blanco Hueso / Gris Muy Claro */
            --color-text: #1f2937; /* Gris Oscuro Casi Negro */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro Modal */
            --color-border: #e5e7eb; /* Borde Gris Claro */
            --color-error-bg: #fff1f2; /* Fondo error rosa muy claro */
            --color-error-text: #be123c; /* Texto error rojo oscuro */
            --color-error-border: #fecdd3; /* Borde error rosa claro */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px; /* Bordes suaves */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Lato', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Nunito'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alineado a la izquierda */ font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Nunito'; font-size: 0.95rem; line-height: 1.4; }
        .title-item i { margin-right: 0.7rem; color: var(--color-primary); width: 1.2em; text-align: center; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #eff6ff; /* Azul muy claro hover */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-secondary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #059669; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #d1d5db; color: #6b7280; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.85); /* Overlay oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Más altura para chat y contenido */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e5e7eb; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Lato', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(209, 213, 219, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem;}
        .user-message { background-color: var(--color-primary); color: #fff; margin-left: auto; text-align: left; /* Mensajes usuario a la derecha pero texto a la izquierda */ }
        .ai-message { background-color: #f3f4f6; color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        .ai-disclaimer { font-size: 0.8em; color: var(--color-text-muted); margin-top: 0.5rem; font-style: italic; display: block; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Nunito'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: #fff; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #2563eb; }
        #chat-send-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator with Minigame */
        #modal-loading { text-align: center; padding: 2rem 1rem; /* Menos padding vertical */ position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); display: none; /* Empieza oculto */ flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #modal-loading.active { display: flex; } /* Clase para mostrar */
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1rem auto; flex-shrink: 0; }
        #modal-loading p.loading-text { font-weight: 600; color: var(--color-text); font-size: 1.2rem; font-family: 'Lato'; margin-bottom: 1.5rem; flex-shrink: 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Minigame Styles */
        #loading-game-container { width: 90%; max-width: 350px; height: 180px; background-color: #eef2ff; /* Fondo azul muy claro */ border: 1px dashed var(--color-primary); border-radius: var(--border-radius); position: relative; overflow: hidden; cursor: pointer; margin-top: 1rem; flex-shrink: 0; }
        .game-circle { width: 25px; height: 25px; background-color: var(--color-secondary); /* Círculos verdes */ border-radius: 50%; position: absolute; transition: transform 0.1s ease-out, opacity 0.3s ease-in; opacity: 0.9; box-shadow: var(--shadow-sm); }
        .game-circle.clicked { transform: scale(0.1); opacity: 0; }
        #game-score { font-size: 1rem; font-weight: 600; color: var(--color-primary); margin-top: 0.8rem; font-family: 'Lato'; flex-shrink: 0; }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Nunito'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); box-shadow: var(--shadow-lg); background-color: #fff; /* Fondo blanco por si la imagen es transparente */ }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: #fff; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-brain mr-3 text-blue-500"></i> <!-- Icono cerebro -->
                     PsicoGuía Interactiva
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">» Patologías y Conceptos Psicológicos «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explorando la Mente Humana</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Una guía informativa sobre diversas patologías y conceptos psicológicos. Selecciona un tema o busca para aprender más.</p>
             <p class="text-sm text-red-700 font-semibold max-w-3xl mx-auto">** Importante: Esta herramienta es solo para fines informativos y educativos. No sustituye el diagnóstico o consejo de un profesional de la salud mental cualificado. **</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar patología, concepto, terapia...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-medical text-blue-500 mr-2"></i> <!-- Icono libro médico -->
                 Índice Temático
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando índice de temas...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron temas que coincidan con la búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Más Temas (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p class="loading-text">Obteniendo información detallada...</p>
                 <!-- Minigame Area -->
                 <div id="loading-game-container">
                     <!-- Circles will be added here by JS -->
                 </div>
                 <div id="game-score">Puntos: 0</div>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder added here via JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este tema...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-circle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p class="font-semibold text-red-700">Descargo de Responsabilidad Importante:</p>
              <p>La información presentada aquí es generada por IA con fines educativos y de referencia general sobre psicología. <strong>No constituye consejo médico ni psicológico profesional, ni debe usarse para autodiagnóstico.</strong></p>
              <p class="mt-1">Si tienes preocupaciones sobre tu salud mental, consulta a un profesional cualificado.</p>
              <p class="mt-2">© 2024 PsicoGuía Interactiva</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
             // Trastornos de Ansiedad
            "Trastorno de Ansiedad Generalizada (TAG)", "Trastorno de Pánico", "Agorafobia", "Fobia Específica", "Trastorno de Ansiedad Social (Fobia Social)", "Mutismo Selectivo", "Trastorno de Ansiedad por Separación", "Ataque de Pánico (Descripción)", "Mecanismos de la Ansiedad", "Terapias para la Ansiedad",
            // Trastornos Depresivos
            "Trastorno Depresivo Mayor (Depresión Clínica)", "Trastorno Depresivo Persistente (Distimia)", "Trastorno Disfórico Premenstrual", "Trastorno de Desregulación Disruptiva del Estado de Ánimo (Niños)", "Depresión Posparto", "Depresión Atípica", "Depresión Melancólica", "Depresión Psicótica", "Ideación Suicida y Prevención", "Neurobiología de la Depresión", "Tratamientos para la Depresión (Terapia y Fármacos)",
            // Trastorno Bipolar y Relacionados
            "Trastorno Bipolar I", "Trastorno Bipolar II", "Trastorno Ciclotímico", "Episodio Maníaco", "Episodio Hipomaníaco", "Episodio Depresivo Bipolar", "Tratamiento del Trastorno Bipolar (Estabilizadores)", "Manejo de Crisis Bipolares",
            // Espectro de la Esquizofrenia y Otros Trastornos Psicóticos
            "Esquizofrenia", "Trastorno Esquizotípico (Personalidad)", "Trastorno Delirante", "Trastorno Psicótico Breve", "Trastorno Esquizofreniforme", "Trastorno Esquizoafectivo", "Psicosis Inducida por Sustancias/Medicamentos", "Síntomas Positivos de la Psicosis (Delirios, Alucinaciones)", "Síntomas Negativos de la Psicosis (Alogia, Abulia)", "Síntomas Cognitivos de la Esquizofrenia", "Tratamiento Antipsicótico", "Rehabilitación Psicosocial",
            // Trastornos Obsesivo-Compulsivos y Relacionados
            "Trastorno Obsesivo-Compulsivo (TOC)", "Trastorno Dismórfico Corporal", "Trastorno de Acumulación", "Tricotilomanía (Trastorno de arrancarse el cabello)", "Trastorno de Excoriación (Dermatilomanía)", "Obsesiones (Definición y Tipos)", "Compulsiones (Definición y Tipos)", "Terapia de Exposición con Prevención de Respuesta (EPR)",
            // Trastornos Relacionados con Traumas y Estresores
            "Trastorno de Estrés Postraumático (TEPT)", "Trastorno de Estrés Agudo", "Trastornos Adaptativos", "Trastorno Reactivo del Apego", "Trastorno de Relación Social Desinhibida", "Trauma Complejo (C-PTSD)", "Resiliencia Psicológica", "Terapias Centradas en el Trauma (EMDR, TCC-TF)",
            // Trastornos Disociativos
            "Trastorno de Identidad Disociativo (TID)", "Amnesia Disociativa (Incluye Fuga Disociativa)", "Trastorno de Despersonalización/Desrealización", "Disociación (Concepto General)",
            // Síntomas Somáticos y Trastornos Relacionados
            "Trastorno de Síntomas Somáticos", "Trastorno de Ansiedad por Enfermedad (Hipocondría)", "Trastorno de Conversión (Trastorno de Síntomas Neurológicos Funcionales)", "Factores Psicológicos que Afectan a Otras Afecciones Médicas", "Trastorno Facticio (Síndrome de Munchausen)", "Simulación (Malingering - No es un trastorno)",
            // Trastornos de la Conducta Alimentaria y de la Ingesta de Alimentos
            "Anorexia Nerviosa", "Bulimia Nerviosa", "Trastorno de Atracones", "Pica", "Trastorno de Rumiación", "Trastorno de Evitación/Restricción de la Ingesta de Alimentos", "Imagen Corporal y TCA", "Tratamiento Multidisciplinar de TCA",
            // Trastornos de la Excreción
            "Enuresis", "Encopresis",
            // Trastornos del Sueño-Vigilia
            "Trastorno de Insomnio", "Trastorno de Hipersomnia", "Narcolepsia", "Apnea/Hipopnea Obstructiva del Sueño", "Apnea Central del Sueño", "Trastorno del Ritmo Circadiano Sueño-Vigilia", "Parasomnias (Sonambulismo, Terrores Nocturnos)", "Trastorno de Conducta del Sueño REM", "Síndrome de las Piernas Inquietas", "Higiene del Sueño",
            // Disfunciones Sexuales
            "Eyaculación Retardada", "Trastorno Eréctil", "Trastorno Orgásmico Femenino", "Trastorno del Interés/Excitación Sexual Femenino", "Trastorno de Dolor Genito-Pélvico/Penetración", "Trastorno de Deseo Sexual Hipoactivo Masculino", "Eyaculación Prematura", "Disfunción Sexual Inducida por Sustancias/Medicamentos",
            // Disforia de Género
            "Disforia de Género en Niños", "Disforia de Género en Adolescentes y Adultos", "Proceso de Transición de Género",
            // Trastornos Disruptivos, del Control de los Impulsos y de la Conducta
            "Trastorno Negativista Desafiante (TND)", "Trastorno Explosivo Intermitente", "Trastorno de la Conducta", "Trastorno de la Personalidad Antisocial (Relacionado)", "Piromanía", "Cleptomanía",
            // Trastornos Relacionados con Sustancias y Trastornos Adictivos
            "Trastornos por Consumo de Alcohol", "Trastornos por Consumo de Cannabis", "Trastornos por Consumo de Fenciclidina", "Trastornos por Consumo de Otros Alucinógenos", "Trastornos por Consumo de Inhalantes", "Trastornos por Consumo de Opioides", "Trastornos por Consumo de Sedantes, Hipnóticos o Ansiolíticos", "Trastornos por Consumo de Estimulantes (Anfetamina, Cocaína)", "Trastornos por Consumo de Tabaco", "Otros Trastornos por Consumo de Sustancias", "Trastorno por Juego (Ludopatía)", "Adicción Conductual (Concepto)", "Síndrome de Abstinencia", "Tolerancia a Sustancias", "Desintoxicación", "Programas de Rehabilitación",
            // Trastornos Neurocognitivos
            "Delirium", "Trastorno Neurocognitivo Mayor (Demencia)", "Trastorno Neurocognitivo Leve", "Trastorno Neurocognitivo debido a Enfermedad de Alzheimer", "Trastorno Neurocognitivo Frontotemporal", "Trastorno Neurocognitivo con Cuerpos de Lewy", "Trastorno Neurocognitivo Vascular", "Trastorno Neurocognitivo debido a Traumatismo Cerebral", "Trastorno Neurocognitivo Inducido por Sustancias/Medicamentos", "Trastorno Neurocognitivo debido a Infección por VIH", "Trastorno Neurocognitivo debido a Enfermedad por Priones", "Trastorno Neurocognitivo debido a Enfermedad de Parkinson", "Trastorno Neurocognitivo debido a Enfermedad de Huntington", "Evaluación Neuropsicológica",
            // Trastornos de la Personalidad - Grupo A (Raros/Excéntricos)
            "Trastorno de la Personalidad Paranoide", "Trastorno de la Personalidad Esquizoide", "Trastorno de la Personalidad Esquizotípica",
            // Trastornos de la Personalidad - Grupo B (Dramáticos/Emocionales/Erráticos)
            "Trastorno de la Personalidad Antisocial", "Trastorno Límite de la Personalidad (TLP / Borderline)", "Trastorno de la Personalidad Histriónica", "Trastorno de la Personalidad Narcisista",
            // Trastornos de la Personalidad - Grupo C (Ansiosos/Temerosos)
            "Trastorno de la Personalidad Evitativa", "Trastorno de la Personalidad Dependiente", "Trastorno de la Personalidad Obsesivo-Compulsiva (TOCP - diferente de TOC)",
            // Trastornos del Neurodesarrollo
            "Discapacidad Intelectual (Trastorno del Desarrollo Intelectual)", "Retraso Global del Desarrollo", "Trastornos de la Comunicación (Lenguaje, Habla, Fluidez, Social)", "Trastorno del Espectro Autista (TEA)", "Trastorno por Déficit de Atención con Hiperactividad (TDAH)", "Trastorno Específico del Aprendizaje (Dislexia, Discalculia, Disgrafía)", "Trastornos Motores (Desarrollo de la Coordinación, Movimientos Estereotipados, Tics, Tourette)",
            // Trastornos Parafílicos
            "Trastorno de Voyeurismo", "Trastorno de Exhibicionismo", "Trastorno de Froteurismo", "Trastorno de Masoquismo Sexual", "Trastorno de Sadismo Sexual", "Trastorno de Pedofilia", "Trastorno de Fetichismo", "Trastorno de Travestismo",
            // Conceptos Generales y Terapias
            "Manual Diagnóstico y Estadístico (DSM-5)", "Clasificación Internacional de Enfermedades (CIE-11)", "Diagnóstico Diferencial", "Comorbilidad", "Etiología de los Trastornos Mentales (Bio-Psico-Social)", "Neurotransmisores y Psicopatología (Serotonina, Dopamina, GABA)", "Genética y Trastornos Mentales", "Factores Ambientales en Psicopatología", "Estigma en Salud Mental", "Psicoterapia (Generalidades)", "Terapia Cognitivo-Conductual (TCC)", "Terapia Dialéctica Conductual (TDC)", "Terapia de Aceptación y Compromiso (ACT)", "Terapias Psicodinámicas", "Terapia Interpersonal", "Terapia Familiar Sistémica", "Terapia de Grupo", "Psicofarmacología (Generalidades)", "Antidepresivos (ISRS, IRSN, Tricíclicos, IMAO)", "Ansiolíticos (Benzodiacepinas, Buspirona)", "Estabilizadores del Ánimo (Litio, Anticonvulsivos)", "Antipsicóticos (Típicos y Atípicos)", "Estimulantes (Para TDAH)", "Salud Mental y Bienestar", "Mindfulness y Salud Mental", "Prevención en Salud Mental", "Derechos del Paciente en Salud Mental", "Evaluación Psicológica", "Tests Psicométricos", "Entrevista Clínica", "Historia Clínica en Psicología", "El Rol del Psicólogo Clínico", "El Rol del Psiquiatra",
            // Añadir muchos más... El objetivo es ser exhaustivo.
        ];
        const psychologyThemes = [
            "trastornos de ansiedad", "trastornos depresivos", "trastorno bipolar", "esquizofrenia y psicosis", "trastornos de personalidad", "TOC y relacionados", "trauma y estrés", "trastornos alimentarios", "trastornos del neurodesarrollo (TDAH, TEA)", "adicciones y consumo de sustancias", "trastornos del sueño", "demencias y trastornos neurocognitivos", "terapias psicológicas (TCC, TDC, etc.)", "psicofarmacología", "conceptos de diagnóstico (DSM, CIE)", "neurobiología de trastornos mentales", "salud mental infantil y adolescente", "estigma y salud mental", "prevención en psicología", "evaluación psicológica"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un experto en psicología clínica y psicopatología, similar a un catedrático o autor de manuales diagnósticos. Tu tarea es proporcionar una descripción detallada, precisa, objetiva y empática sobre la patología, concepto o terapia psicológica indicada. Debes basarte en criterios reconocidos (como los del DSM-5 o CIE-11, aunque sin citarlos explícitamente a menos que sea el tema). Incluye: definición clara, criterios diagnósticos principales (sintomatología), epidemiología (prevalencia, edad de inicio, curso), etiología (factores biológicos, psicológicos, sociales conocidos o teorizados), diagnóstico diferencial clave, opciones de tratamiento basadas en evidencia (psicoterapia, farmacoterapia si aplica) y pronóstico general. Usa un lenguaje formal pero accesible. **Crucial: Incluye siempre al final un descargo de responsabilidad indicando que esta información es educativa y no reemplaza una evaluación profesional.** El objetivo es un texto de 1200-1300 palabras.",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúa como un asistente informativo sobre psicología. Responde preguntas de seguimiento sobre el tema específico (patología, concepto, terapia) que se está mostrando, basándote en la información general proporcionada o conocimiento estándar. Sé conciso, claro y empático. **Recuerda siempre al usuario que esto no es un diagnóstico ni consejo profesional y debe consultar a un experto para preocupaciones personales.**",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas para una enciclopedia de psicología. Genera exactamente 40 nombres específicos de patologías psicológicas (DSM/CIE), conceptos clave, o tipos de terapia relevantes para la salud mental. Devuelve *solo* la lista, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentar ligeramente por pedir más títulos
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, añadiendo los del juego)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Ahora el contenedor del loader Y juego
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const gameContainer = document.getElementById('loading-game-container');
        const gameScoreDisplay = document.getElementById('game-score');

        // ========== State Variables ==========
        let currentConceptTitle = null; // Contexto para chat
        let gameIntervalId = null;     // ID para el intervalo de aparición de círculos
        let gameTimeouts = [];         // Array para guardar los timeouts de desaparición
        let gameScore = 0;             // Puntuación del minijuego
        let isGameActive = false;      // Flag para controlar el estado del juego

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentConceptTitle
                ? `Actúa como un asistente informativo sobre psicología. Responde preguntas de seguimiento sobre '${currentConceptTitle}', basándote en conocimiento estándar. Sé conciso, claro y empático. **Recuerda siempre al usuario que esto no es un diagnóstico ni consejo profesional y debe consultar a un experto.**`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                     // *** MENSAJE DE ERROR AMIGABLE MEJORADO ***
                     throw new Error(`(Error ${response.status}) Nuestros sistemas están procesando muchas solicitudes ahora mismo. Por favor, inténtalo de nuevo en un momento.`);
                }
                const text = await response.text();
                 // Añadir verificación de respuesta corta o inútil
                 if (!text || text.trim().length < 100 || text.toLowerCase().includes("no puedo proporcionar información") || text.toLowerCase().includes("as an ai")) {
                    throw new Error("La IA no pudo generar una respuesta útil o detallada sobre este tema específico.");
                 }
                console.log(`API Response received (${text.length} chars)`);
                 // Adjuntar descargo de responsabilidad si no está ya (para descripción principal)
                 const disclaimer = "--- \n**Descargo de Responsabilidad:** Esta información es solo para fines educativos y no sustituye el consejo o diagnóstico de un profesional de la salud mental cualificado.";
                 if (!isChat && !text.includes("Descargo de Responsabilidad")) {
                    return text + "\n\n" + disclaimer;
                 }
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La solicitud tardó demasiado (>${config.timeoutSeconds}s). La conexión puede ser lenta o los servidores están ocupados. Intenta de nuevo.`);
                }
                 // Asegurarse que el mensaje sea amigable
                throw new Error(error.message.includes("Error") ? error.message : "Ocurrió un problema al obtener la información. Por favor, intenta más tarde.");
            }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) {
            if (!currentConceptTitle) throw new Error("Error interno: No se ha establecido el contexto del tema para el chat.");
             // Añadir el disclaimer explícitamente en la respuesta del chat también
             const response = await fetchTextFromApi(userQuery, chatApiConfig, true);
             const disclaimer = "<br><em class='ai-disclaimer'>Recuerda: soy una IA informativa, consulta a un profesional para asesoramiento personal.</em>";
             return response + disclaimer;
        }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(psychologyThemes) || "conceptos generales de psicología";
             const specificPrompt = `Genera 40 nombres específicos de patologías psicológicas (DSM/CIE), conceptos clave, o tipos de terapia relevantes sobre ${randomTheme}`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 10) throw new Error("La IA no generó suficientes ideas de temas."); // Aumentar umbral
                     return titles.slice(0, 40); // Asegurar que devuelve hasta 40
                 });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 700, height: 500, nologo: true }; // Ajustar tamaño si se quiere
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "concepto psicológico abstracto";
             // Prompt enfocado en lo abstracto/simbólico
             const enhancedPrompt = `Abstract conceptual art representing the psychological concept '${safePromptText}'. Symbolic, non-literal visualization. Use calm or neutral color palettes (blues, greens, grays, soft pastels). Focus on shapes, textures, light, connections, thought patterns. Avoid depicting human figures, faces, suffering, pills, brains unless highly stylized and abstract. Clean, minimalist or ethereal style.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, diagram, chart, graph, realistic human figure, suffering, crying, pills, medication, brain illustration, medical equipment, cluttered, photorealistic, watermark, signature, multiple images";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (igual que antes) */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Formateo de párrafos y listas (simple)
             formatted = formatted.replace(/^\s*-\s+/gm, '<li>'); // Convertir guiones a li
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 if (block.startsWith('<li>')) {
                     // Si empieza con li, asumimos que es una lista y envolvemos
                     // (esto es simplista, no maneja listas anidadas bien)
                     return `<ul>${block.replace(/<li>/g, '<li>').split('\n').filter(li => li.trim()).map(li => li.trim().endsWith('</li>') ? li : li + '</li>').join('')}</ul>`;
                 }
                 let content = block.replace(/\n/g, ' ');
                 return `<p>${content}</p>`;
             }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            resetModalState();
            stopGame(); // Asegurarse de que el juego se detiene al cerrar modal
        }
        function resetModalState() {
             modalLoadingIndicator.classList.remove('active'); // Ocultar loader (se activará si es necesario)
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentConceptTitle = null;
             hideFullscreenImage();
             // Reset game state visually
             if (gameContainer) gameContainer.innerHTML = '';
             if (gameScoreDisplay) gameScoreDisplay.textContent = 'Puntos: 0';
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (igual que antes) */
             if (!imageFullscreenOverlay || !fullscreenImage) return;
             fullscreenImage.src = imgSrc;
             imageFullscreenOverlay.classList.add('active');
             document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() { /* ... (igual que antes) */
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios, excepto añadir disclaimer en fetch)
        function addChatMessage(message, sender) { /* ... (igual que antes) */
             const msgDiv = document.createElement('div');
             msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
             // Simple Markdown-like formatting
             message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
             // Handle potential disclaimer span
             message = message.replace(/<br><em class='ai-disclaimer'>.*?<\/em>/g, (match) => match); // Keep disclaimer HTML safe
             msgDiv.innerHTML = message;
             chatHistory.appendChild(msgDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        function addChatError(message) { /* ... (igual que antes) */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        async function handleSendMessage() { /* ... (igual que antes) */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
         }

        // ========== MINIGAME FUNCTIONS ==========
        function startGame() {
            if (!gameContainer || !gameScoreDisplay || isGameActive) return;
            console.log("Starting minigame...");
            isGameActive = true;
            gameScore = 0;
            gameScoreDisplay.textContent = 'Puntos: 0';
            gameContainer.innerHTML = ''; // Clear previous circles
            gameTimeouts = []; // Clear old timeouts

            // Spawn circles interval
            gameIntervalId = setInterval(() => {
                if (!isGameActive) return; // Stop if game deactivated
                const circle = document.createElement('div');
                circle.classList.add('game-circle');

                // Random position within the container
                const containerRect = gameContainer.getBoundingClientRect();
                const maxLeft = containerRect.width - 25; // 25 is circle width
                const maxTop = containerRect.height - 25; // 25 is circle height
                circle.style.left = `${Math.random() * maxLeft}px`;
                circle.style.top = `${Math.random() * maxTop}px`;

                 // Click listener for the circle
                 circle.addEventListener('click', handleCircleClick);

                gameContainer.appendChild(circle);

                // Set timeout to remove the circle after a short time
                const timeoutId = setTimeout(() => {
                    if (circle.parentNode) { // Check if not already removed by click
                        circle.remove();
                    }
                }, 1800 + Math.random() * 1000); // Circle lifespan: 1.8 - 2.8 seconds
                gameTimeouts.push(timeoutId);

            }, 600); // Spawn rate: new circle every 600ms
        }

        function handleCircleClick(event) {
             if (!isGameActive) return;
             const circle = event.target;
             if (!circle.classList.contains('game-circle') || circle.classList.contains('clicked')) return;

             circle.classList.add('clicked');
             gameScore++;
             gameScoreDisplay.textContent = `Puntos: ${gameScore}`;

             // Remove the element after animation (optional, CSS handles visual disappearance)
             setTimeout(() => {
                 if (circle.parentNode) circle.remove();
             }, 300); // Matches CSS transition duration

             event.stopPropagation(); // Prevent clicks bubbling up if needed
        }

        function stopGame() {
            if (!isGameActive) return;
            console.log("Stopping minigame...");
            isGameActive = false;
            clearInterval(gameIntervalId);
            gameIntervalId = null;
            // Clear all pending removal timeouts
            gameTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
            gameTimeouts = [];
            // Optionally clear remaining circles immediately
            if (gameContainer) gameContainer.innerHTML = '';
             // Hide the loader container which holds the game
             modalLoadingIndicator.classList.remove('active');
        }


        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) {
             const div = document.createElement('div');
             div.className = 'title-item';
             // Add a simple icon based on keyword (example)
             let iconClass = 'fa-lightbulb'; // Default
             if (title.toLowerCase().includes('trastorno')) iconClass = 'fa-notes-medical';
             if (title.toLowerCase().includes('terapia')) iconClass = 'fa-comments';
             if (title.toLowerCase().includes('ansiedad')) iconClass = 'fa-wind';
             if (title.toLowerCase().includes('depresi')) iconClass = 'fa-cloud-rain';
             if (title.toLowerCase().includes('personalidad')) iconClass = 'fa-user-cog';
              if (title.toLowerCase().includes('esquizo') || title.toLowerCase().includes('psicóti')) iconClass = 'fa-eye';
             div.innerHTML = `<i class="fas ${iconClass}"></i><span>${title}</span>`;
             div.setAttribute('data-title', title);
             div.addEventListener('click', () => handleTitleClick(title));
             return div;
         }
        function displayTitles(titles) { /* ... (igual que antes, usa createTitleItem con icono) */
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay temas disponibles en el índice «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... (igual que antes) */
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to start/stop game ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentConceptTitle = title;
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');

            // *** START LOADING & GAME ***
            modalLoadingIndicator.classList.add('active'); // Show loader/game container
            startGame();

            try {
                const rawExplanationText = await fetchExplanationText(title);
                // *** STOP GAME on Success (before showing content) ***
                stopGame(); // Stops intervals and hides loader via class removal

                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-palette placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización abstracta...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización abstracta de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => {
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`; }

            } catch (error) {
                 // *** STOP GAME on Error ***
                 stopGame(); // Stops intervals and hides loader via class removal

                console.error("Failed display:", error);
                modalErrorMessage.textContent = error.message || "Ocurrió un error desconocido al cargar la información.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles to request 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más temas...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Function now requests 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más temas en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar temas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Temas (40)';
             }
         }

         // Search Filter Function (sin cambios)
         function filterTitles(searchTerm) { /* ... (igual que antes, usa normalize) */
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // ... (Check all required elements exist, including game elements)
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalLoadingIndicator || !gameContainer || !gameScoreDisplay) {
                 console.error("Initialization failed: Missing essential UI or Game elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Faltan componentes de la interfaz. Recarga la página.</p>';
                 return;
             }
            // Event Listeners (Modal, Generate More, Search, Chat, Fullscreen Image)
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>