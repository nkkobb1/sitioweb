<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía Avanzada de Supervivencia - Enciclopedia Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Robustas y Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Supervivencia Avanzada --- */
        :root {
            --color-primary: #386641; /* Verde Bosque Oscuro */
            --color-secondary: #BC5D2E; /* Naranja Terracota/Óxido */
            --color-tertiary: #6B7280; /* Gris Piedra */
            --color-background: #f4f1ea; /* Beige/Hueso Claro */
            --color-text: #44403c; /* Marrón/Gris Muy Oscuro */
            --color-text-muted: #6a6765; /* Gris/Marrón Medio */
            --color-modal-bg: #ffffff; /* Blanco Limpio */
            --color-border: #d6d3d1; /* Piedra Claro / Gris Suave */
            --color-error-bg: #fde8e8; /* Rojo muy pálido */
            --color-error-text: #991b1b; /* Rojo oscuro */
            --color-error-border: #ef4444; /* Rojo estándar */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.07);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 6px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Oswald', sans-serif; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700;}
        #modal-title { color: var(--color-secondary); font-weight: 700; text-transform: uppercase; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(56, 102, 65, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alineación izquierda para mejor lectura de títulos largos */ font-weight: 700; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 70px; font-family: 'Lato', sans-serif; font-size: 0.95rem; line-height: 1.4; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-primary); background-color: #fdfbf6; border-left-color: var(--color-secondary); }
        .title-item i { margin-right: 0.8rem; color: var(--color-primary); min-width: 1.2em; text-align: center; opacity: 0.8; } /* Iconos opcionales en títulos */
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-secondary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Oswald', sans-serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-transform: uppercase; }
        #generate-more-btn:hover:not(:disabled) { background-color: #a14e26; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: var(--color-text-muted); color: var(--color-background); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(68, 64, 60, 0.9); /* Overlay marrón/gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Más altura para contenido y chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 400;}
        #modal-content ul, #modal-content ol { margin-left: 1.5em; margin-bottom: 1.2em; }
        #modal-content li { margin-bottom: 0.6em; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Oswald', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; text-transform: uppercase; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        #modal-content .warning { background-color: #fffbeb; border-left: 4px solid #facc15; padding: 0.8rem 1rem; margin: 1.5rem 0; color: #ca8a04; font-size: 0.95em; }
        #modal-content .warning strong { color: #b45309; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(107, 114, 128, 0.3); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-primary); } /* Icono de supervivencia */

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; /* Fondo muy claro para chat */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95em; }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; /* Keep left for readability */ font-weight: 400; }
        .ai-message { background-color: #e5e7eb; /* Gris claro AI */ color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(56, 102, 65, 0.15); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #2b5234; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-primary); font-size: 1.4rem; font-family: 'Oswald'; text-transform: uppercase; letter-spacing: 1px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 700; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(68, 64, 60, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); box-shadow: var(--shadow-lg); background-color: white; /* Fondo blanco por si la imagen tiene transparencia */ }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-compass mr-3"></i> <!-- Icono brújula -->
                     Supervivencia Avanzada
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Enciclopedia Interactiva «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Domina el Entorno</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora técnicas y conocimientos esenciales para afrontar situaciones límite. Prepárate para lo inesperado.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar técnica o concepto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-green-700 mr-2"></i> <!-- Icono libro abierto -->
                 Índice de Conocimientos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando base de datos de supervivencia...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron técnicas para los parámetros indicados «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Buscar Nuevos Conocimientos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Consultando Experto...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                      <h4 class="text-sm font-semibold text-gray-600 mb-2 text-center uppercase tracking-wider">Consulta al Experto</h4>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta técnica...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Ilustración Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-600 py-6 mt-12 border-t border-gray-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos y de referencia sobre supervivencia avanzada.</p>
              <p class="mt-1 font-bold">Advertencia: La supervivencia real requiere práctica, juicio y adaptación. No intente técnicas peligrosas sin entrenamiento adecuado.</p>
              <p class="mt-2">© 2025 Guía Avanzada de Supervivencia</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Refugio Avanzado
            "Construcción de Refugio Debris Hut de Largo Plazo", "Técnicas de Construcción de Quinzhee vs. Igloo", "Excavación de Refugios Subterráneos (Ventajas y Riesgos)", "Selección Avanzada de Sitio para Refugio (Microclimas, Peligros)", "Técnicas de Camuflaje para Refugios", "Impermeabilización de Refugios Naturales", "Aislamiento Térmico con Materiales Naturales", "Construcción de Refugios Elevados (Anti-animales/Inundación)", "Refugios de Nieve: Zanja y Techo Inclinado", "Refugios en Acantilados/Cuevas: Seguridad y Modificación", "Estructuras de Refugio con Tarpologías Avanzadas", "Refugios Semi-permanentes con Muros de Piedra/Adobe", "Ventilación y Manejo de Humo en Refugios Cerrados", "Defensa Perimetral Básica para Refugios", "Refugios Urbanos Improvisados (Edificios Abandonados)",
            // Agua Avanzada
            "Construcción de Destilador Solar de Alto Rendimiento", "Uso de Bolsas de Transpiración en Diferentes Plantas", "Identificación y Acceso a Filtraciones en Roca", "Construcción de Filtro Bio-Arena Detallado", "Fabricación de Carbón Activado para Filtración", "Purificación Química: Pros y Contras (Yodo, Cloro, Dióxido de Cloro)", "Técnicas Avanzadas para Encontrar Agua en Desiertos", "Métodos Primitivos de Desalinización (Evaporación/Condensación)", "Recolección de Rocío a Gran Escala", "Derretimiento Eficiente de Nieve/Hielo para Agua Potable", "Identificación de Fuentes de Agua Contaminadas (Química/Biológica)", "Construcción de Pozo Somero (Gypsy Well)", "Transporte y Almacenamiento de Agua Improvisado", "Evaluación de la Potabilidad del Agua (Indicadores)", "Rehidratación Oral Avanzada (Sales Caseras)",
            // Fuego Avanzado
            "Perfeccionamiento de Técnicas de Fuego por Fricción (Arco, Mano)", "Construcción y Uso del Pistón de Fuego", "Métodos Químicos Seguros para Iniciar Fuego (Permanganato, Glicerina)", "Uso de Lentes de Hielo y Botellas de Agua para Fuego", "Técnicas para Conservar y Transportar Brasas (Banco de Carbón)", "Tipos de Configuraciones de Fuego (Lay) y sus Usos", "Estrategias Avanzadas para Iniciar Fuego en Clima Húmedo/Lluvioso", "Selección y Procesamiento de Yesca Fina y Gruesa", "Creación de Extensiones de Yesca (amadou, char cloth casero)", "Uso de Baterías y Lana de Acero para Fuego", "Encendido de Fuego con Pedernal y Acero (Técnica Correcta)", "Manejo Seguro del Fuego en Diferentes Entornos", "Señales de Humo Efectivas (Color, Intermitencia)", "Cocina sobre Fuego sin Utensilios Modernos", "Extinción Segura y Completa de Fogatas",
            // Comida - Forrajeo Avanzado
            "Aplicación Detallada del Test Universal de Comestibilidad", "Identificación Segura de Plantas Comestibles Clave (Ejemplos Conceptuales)", "Procesamiento de Bellotas y Otras Plantas Tóxicas para Consumo", "Forrajeo y Preparación Segura de Insectos Comestibles", "Principios Avanzados de Identificación de Hongos (¡Alto Riesgo!)", "Recolección y Uso de Algas y Plantas Marinas Comestibles", "Identificación y Uso de Plantas Medicinales Comunes (Básico)", "Técnicas de Cosecha Sostenible de Plantas Silvestres", "Conservación Primitiva de Alimentos Vegetales (Secado, Ahumado)", "Forrajeo en Entornos Urbanos (Riesgos y Oportunidades)", "Identificación de Árboles Comestibles (Savia, Corteza Interna)", "Uso de Guías de Campo y Conocimiento Local", "Riesgos del Forrajeo: Plantas Venenosas Similares", "Creación de un Diario de Forrajeo", "Nutrición en Supervivencia: Balanceando la Dieta Silvestre",
            // Comida - Caza/Pesca/Trampeo Avanzado
            "Construcción de Lazos con Gatillos Sensibles (Figura 4, Paiute)", "Diseño y Construcción de Trampas de Caída Muerta (Deadfalls)", "Fabricación de Anzuelos Primitivos (Hueso, Madera, Espina)", "Construcción de Redes de Pesca con Fibras Naturales", "Técnicas de Pesca con Lanza Improvisada", "Construcción y Uso de Trampas de Embudo para Peces/Animales Pequeños", "Principios de Rastreo de Animales (Huellas, Señales)", "Técnicas de Acecho y Acercamiento Sigiloso", "Despiece Básico de Animales en el Campo", "Métodos Primitivos de Conservación de Carne (Secado, Ahumado, Salado)", "Caza con Arco y Flecha Primitivos (Construcción Básica)", "Uso de Trampas de Caja (Box Traps)", "Pesca con Sedal de Mano Improvisado", "Limpieza y Cocina Segura de Caza/Pesca", "Consideraciones Éticas y Legales de la Caza/Trampeo",
            // Navegación Avanzada
            "Navegación Celestial Diurna (Método del Reloj, Sombras)", "Navegación Celestial Nocturna (Estrella Polar, Cruz del Sur, Fases Lunares)", "Uso Avanzado de Mapa y Brújula (Declinación Magnética, Resección, Triangulación)", "Interpretación Detallada de Mapas Topográficos (Curvas de Nivel, Relieve)", "Navegación por Indicios Naturales (Vegetación, Viento, Nieve)", "Estrategias para Navegar Sin Brújula (Método del Sol y la Sombra)", "Creación de Mapas Mentales y Croquis del Terreno", "Uso de Altímetro para Navegación", "Navegación en Condiciones de Baja Visibilidad (Niebla, Noche)", "Estimación de Distancias y Tiempos de Marcha", "Orientación en Entornos Urbanos Degradados", "Uso de GPS (Limitaciones y Alternativas)", "Conceptos de Geocaching Aplicados a Supervivencia", "Planificación de Rutas Seguras y Eficientes", "Relocalización Tras Perderse (Estrategias)",
            // Primeros Auxilios Avanzados
            "Manejo Avanzado de Hemorragias Graves (Torniquetes: Uso Correcto y Riesgos, Puntos de Presión)", "Evaluación y Manejo de Fracturas y Luxaciones (Inmovilización)", "Tratamiento Avanzado de Hipotermia (Recalentamiento Activo/Pasivo)", "Tratamiento Avanzado de Hipertermia y Golpe de Calor", "Identificación y Tratamiento de Mordeduras/Picaduras Venenosas (Serpientes, Insectos)", "Manejo de Quemaduras Graves en Entornos Remotos", "Improvisación de Suministros Médicos (Vendajes, Férulas)", "Uso Cauteloso de Remedios Naturales (Plantas Medicinales Básicas)", "Prevención y Tratamiento de Enfermedades Transmitidas por Agua/Insectos", "Manejo de Shock Anafiláctico (Si se dispone de Epinefrina)", "Extracción Segura de Objetos Empalados", "RCP y Manejo de Vía Aérea en Entornos Remotos", "Evaluación Primaria y Secundaria del Paciente (ABCDE)", "Higiene y Saneamiento en Campamentos de Supervivencia", "Creación de un Botiquín de Primeros Auxilios Improvisado",
            // Señalización Avanzada
            "Diseño y Construcción de Señales Tierra-Aire Internacionales", "Técnicas Efectivas de Señalización con Espejo", "Construcción de Señales de Humo para Máxima Visibilidad (Día)", "Construcción de Señales de Fuego para Visibilidad Nocturna", "Uso de Silbatos de Señalización (Códigos)", "Creación de Señales Visuales con Ropa/Materiales de Colores Vivos", "Uso de Linternas para Señalización (Código Morse Básico)", "Conceptos de Radiobalizas de Emergencia (PLB, EPIRB)", "Señalización Sonora Improvisada (Golpear Objetos)", "Marcaje de Rutas para Rescatadores", "Preparación de Zonas de Aterrizaje para Helicópteros (Básico)", "Uso de Reflectores Improvisados", "Señalización en Entornos Urbanos", "Camuflaje vs. Señalización: Cuándo Usar Cada Uno", "Protocolos de Comunicación con Equipos de Rescate",
            // Herramientas, Equipo y Nudos Avanzados
            "Principios Básicos de Flintknapping (Tallado de Piedra)", "Fabricación de Cordaje Resistente con Fibras Naturales (Ortiga, Agave)", "Improvisación de Contenedores (Corteza, Bambú, Piel)", "Mantenimiento Avanzado de Cuchillos y Hachas en el Campo", "Afilado de Herramientas con Piedras Naturales", "Nudos Esenciales Avanzados (Prusik, Blake's Hitch, Alpine Butterfly)", "Aplicaciones Prácticas de Nudos (Refugio, Trampas, Escalada)", "Construcción de Herramientas Primitivas (Pala, Mazo, Aguja)", "Reparación de Ropa y Equipo con Materiales Naturales/Improvisados", "Selección y Modificación de un Cuchillo de Supervivencia", "Uso Seguro y Mantenimiento de la Sierra de Cadena de Mano", "Improvisación de Mochilas y Sistemas de Transporte", "Construcción de Escaleras de Cuerda Improvisadas", "Fabricación de Pegamento Natural (Resina de Pino)", "Creación de un Kit de Supervivencia EDC (Every Day Carry) Avanzado",
            // Mentalidad y Psicología Avanzada
            "Manejo Avanzado del Miedo, Pánico y Estrés Agudo", "Estrategias para Mantener la Moral Individual y Grupal a Largo Plazo", "Principios de Liderazgo Efectivo en Situaciones de Crisis", "Dinámicas de Grupo en Supervivencia (Conflicto, Cooperación)", "Efectos Psicológicos del Aislamiento Prolongado", "La Regla de Tres en Supervivencia (Prioridades Mentales)", "Desarrollo de la Resiliencia Mental", "Técnicas de Visualización y Ensayo Mental", "Manejo de la Incertidumbre y la Ambigüedad", "Cómo Combatir la Fatiga y el Agotamiento Mental", "El Papel de la Esperanza y la Determinación", "Toma de Decisiones Bajo Presión Extrema", "Adaptabilidad y Flexibilidad Cognitiva", "Manejo del Duelo y la Pérdida en Supervivencia", "Preparación Mental Previa a la Situación (Simulación)",
            // Entornos Específicos - Avanzado
            "Supervivencia Avanzada en Desiertos Extremos (Agua, Calor, Navegación)", "Técnicas Avanzadas de Supervivencia Invernal (Frío Extremo, Avalanchas)", "Supervivencia en Selvas Densas (Humedad, Insectos, Orientación)", "Supervivencia Urbana Avanzada (Recursos Ocultos, Seguridad, 'Hombre Gris')", "Supervivencia Costera y Marina Avanzada (Mareas, Recursos Marinos, Desalinización)", "Supervivencia en Alta Montaña (Mal de Altura, Terreno Escarpado)", "Supervivencia en Pantanos y Ciénagas", "Adaptación a Cambios Climáticos Repentinos", "Supervivencia Tras Desastres Naturales (Terremotos, Inundaciones, Incendios)", "Interacción Segura con la Fauna Peligrosa Específica del Entorno", "Construcción de Balsas y Embarcaciones Improvisadas", "Supervivencia en Vehículo Aislado", "Técnicas de Cruce de Ríos Seguras", "Navegación y Supervivencia Subterránea (Cuevas)", "Supervivencia a Largo Plazo en Entorno Natural Aislado",
            // Defensa Personal y Seguridad Avanzada
            "Principios de Disuasión de Animales Peligrosos", "Conciencia Situacional Extrema (Observación, Anticipación)", "Fabricación y Uso de Armas Defensivas Primitivas (Lanza, Garrote)", "Estrategias de Seguridad para Campamentos Grupales", "Técnicas de Camuflaje y Ocultación Personal", "Principios de Escape y Evasión (Movimiento Sigiloso)", "Conceptos de Contrarastreo", "Identificación de Amenazas Humanas Potenciales", "Estrategias de Defensa en Entornos Urbanos Degradados", "Uso de Señuelos y Tácticas de Distracción", "Fortificación Básica de Posiciones Temporales", "Comunicación Sigilosa en Grupo", "Defensa Contra Ataques Nocturnos (Animales/Humanos)", "Interpretación del Lenguaje Corporal Animal", "Evaluación de Riesgos y Amenazas del Entorno",
             // Planificación y Preparación Avanzada
            "Creación de un Plan de Evacuación Familiar Detallado (BUG OUT)", "Ensamblaje de una Mochila de Evacuación (BOB) de 72h Avanzada", "Conceptos de Preparación a Largo Plazo (INCH Bag - I'm Never Coming Home)", "Almacenamiento Seguro y Rotación de Alimentos y Agua a Largo Plazo", "Evaluación de Riesgos Personales y Familiares (Amenazas Probables)", "Desarrollo de Habilidades Prácticas (Práctica Constante)", "Creación de Redes de Apoyo Mutuo (Prepper Groups)", "Obtención de Inteligencia y Monitoreo de Situaciones", "Seguridad de la Información Personal en Tiempos de Crisis (OPSEC)", "Planificación Financiera para Emergencias", "Mantenimiento de la Condición Física para Supervivencia", "Aspectos Legales de la Preparación y la Autodefensa", "Documentación Esencial para Emergencias (Copias Físicas y Digitales)", "Planes de Comunicación Alternativos (Radioafición, Satelital)", "Simulacros y Puesta a Prueba de Planes y Equipo",
            // Temas Misceláneos Avanzados
            "Interpretación Avanzada de Patrones Climáticos Naturales", "Construcción de Trampas para Aves", "Técnicas de Escalada Improvisada (Básica y Peligrosa)", "Conservación de Munición y Armas de Fuego en Entornos Hostiles", "Reparación de Equipos Electrónicos Básicos (Radio, GPS)", "Generación de Electricidad Improvisada (Básica)", "Higiene Dental Primitiva", "Manejo de Residuos en Campamentos a Largo Plazo", "Orientación Astronómica Avanzada (Uso de Constelaciones Menores)", "Fabricación de Ropa y Calzado Improvisado", "Técnicas de Natación y Supervivencia Acuática", "Manejo de Cadáveres en Situaciones de Supervivencia (Sanidad)", "Trueque y Economía en un Mundo Post-Colapso (Conceptual)", "Construcción de Ahumadores Eficientes", "Uso de Animales de Carga Improvisados"
            // ... (Potencialmente más títulos generados dinámicamente)
        ];
        const survivalThemes = [
            "construcción de refugios avanzados", "obtención y purificación de agua", "técnicas de fuego primitivas y modernas", "identificación de plantas comestibles", "trampeo y caza menor", "navegación sin tecnología", "primeros auxilios en zonas remotas", "señalización para rescate", "fabricación de herramientas y cuerdas", "psicología de la supervivencia", "supervivencia en clima frío extremo", "supervivencia en desiertos áridos", "supervivencia en selva tropical", "supervivencia urbana post-desastre", "supervivencia costera y marina", "nudos esenciales para supervivencia", "seguridad y defensa personal en supervivencia", "preparación y planificación para emergencias", "conservación de alimentos primitiva", "rastreo de animales", "escape y evasión", "conocimientos de meteorología práctica", "supervivencia en altitud"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un instructor experto en supervivencia avanzada (estilo SERE / guía de montaña con décadas de experiencia). Tu tarea es explicar detalladamente la técnica, concepto o habilidad de supervivencia indicada. Proporciona instrucciones paso a paso claras, enfatiza los principios subyacentes, incluye advertencias de seguridad cruciales, menciona variaciones según el entorno, y discute los pros y contras o limitaciones. Usa un lenguaje directo, práctico y autoritario, pero también didáctico. El objetivo es una guía exhaustiva y práctica de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tema de supervivencia avanzada:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente experto en supervivencia, enfocado únicamente en la técnica o concepto que se está mostrando ([TEMA ACTUAL]). Responde preguntas específicas sobre sus pasos, materiales, riesgos, o aplicaciones prácticas en diferentes escenarios. Sé conciso, preciso y prioriza la seguridad en tus respuestas.", // El placeholder será reemplazado dinámicamente
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia de supervivencia avanzada. Genera exactamente 15 nombres de técnicas específicas, conceptos complejos o habilidades prácticas de supervivencia en entornos salvajes o post-desastre. Deben sonar prácticos y avanzados. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        // (Identicos a la versión anterior, solo verificar que los IDs coincidan)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Contenedor de texto e imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div para el texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentSurvivalTopic = null; // Renombrado para claridad

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             // *** USA EL SYSTEM PROMPT DINÁMICO PARA CHAT ***
             const systemPromptToUse = isChat && currentSurvivalTopic
                 ? `Actúa como un asistente experto en supervivencia, enfocado únicamente en la técnica o concepto llamado '${currentSurvivalTopic}'. Responde preguntas específicas sobre sus pasos, materiales, riesgos, o aplicaciones prácticas en diferentes escenarios. Sé conciso, preciso y prioriza la seguridad en tus respuestas.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     // *** MENSAJE DE ERROR AMIGABLE ***
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, por favor intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta del experto llegó vacía. Intenta reformular la pregunta o seleccionar otro tema.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con el servidor tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar al experto en supervivencia.");
             }
        }
        async function fetchExplanationText(topicTitle) {
             // Podríamos añadir lógica aquí para asegurar que la IA devuelva texto útil
             const text = await fetchTextFromApi(topicTitle, textApiConfig, false);
             if (text.toLowerCase().includes("no puedo proporcionar información") || text.toLowerCase().includes("no tengo conocimiento") || text.length < 500) {
                 // Considerar si la IA rechaza el tema o da respuesta muy corta
                 // throw new Error("El experto no pudo proporcionar detalles suficientes sobre este tema específico.");
             }
             return text;
        }
        async function fetchChatResponse(userQuery) {
            if (!currentSurvivalTopic) throw new Error("Error interno: No se ha establecido el tema de supervivencia para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(survivalThemes) || "técnicas de supervivencia variadas";
            const specificPrompt = `Genera 15 técnicas o conceptos específicos y avanzados sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n')
                        .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                        .filter(line => line.length > 10 && line.length < 150); // Filtro más estricto
                     if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de técnicas nuevas.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "wilderness survival scene";
             // Prompt enfocado en ilustración clara o concepto visual
             const enhancedPrompt = `Clear illustration or conceptual visualization of the survival technique or concept: '${safePromptText}'. Focus on the action, materials, or environment described. Natural setting (forest, desert, snow, coast as appropriate). Avoid text, labels, diagrams with text. Realistic or detailed illustrative style.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram with writing, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, cartoon, abstract art, blurry, low quality, photorealistic person's face unless essential";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText) {
             if (!rawText) return '';
             let formatted = rawText.trim();
             // Markdown básico y reemplazos específicos de supervivencia
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Negrita
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');     // Cursiva

             // Encabezados
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); // H4
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); // H3
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); // H2
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');   // H1 (Menos probable que la IA lo use)

             // Listas (simplificado, asume buen formato de la IA)
             formatted = formatted.replace(/^\s*[-*+]\s+(.*)$/gm, '<li>$1</li>');
             // Envuelve bloques de <li> en <ul> ( heurística simple)
             formatted = formatted.replace(/^(<li>.*<\/li>\s*)+/gm, (match) => `<ul>\n${match}</ul>\n`);
             // Para listas numeradas (similar heurística)
             formatted = formatted.replace(/^\s*\d+\.\s+(.*)$/gm, '<li>$1</li>');
             formatted = formatted.replace(/^(<li>.*<\/li>\s*)+/gm, (match) => {
                // Evita doble envolvimiento si ya está en <ul>
                if (match.includes('<ul>') || match.includes('<ol>')) return match;
                return `<ol>\n${match}</ol>\n`;
             });


             // Párrafos y saltos de línea
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 // Si ya es un encabezado, lista o bloque especial, dejarlo como está
                 if (block.match(/^<(h[1-4]|ul|ol|li|div|p)/)) return block;
                 // Añadir clase 'warning' si el párrafo empieza con ADVERTENCIA:, ¡CUIDADO!, etc.
                 if (block.match(/^(ADVERTENCIA|¡CUIDADO!|IMPORTANTE|RIESGO|PELIGRO):/i)) {
                     return `<p class="warning">${block.replace(/^(ADVERTENCIA|¡CUIDADO!|IMPORTANTE|RIESGO|PELIGRO):\s*/i, '<strong>$1:</strong> ')}</p>`;
                 }
                 // Convertir el resto en párrafos normales, reemplazando saltos internos con espacio
                 let content = block.replace(/\n/g, ' ');
                 return `<p>${content}</p>`;
             }).join('\n'); // Unir con salto de línea para mantener separación lógica en HTML

             return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0; // Reset scroll del área de texto
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentSurvivalTopic = null; // Limpiar contexto
             hideFullscreenImage(); // Asegurar que la imagen ampliada se oculte
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (Sin cambios lógicos, solo contexto)
        function addChatMessage(message, sender) { /* ... */ const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */
            const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error Experto: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // Intenta asignar un icono basado en palabras clave (opcional, mejora visual)
            let iconClass = 'fa-question-circle'; // Icono por defecto
            const lowerTitle = title.toLowerCase();
            if (lowerTitle.includes('refugio') || lowerTitle.includes('shelter') || lowerTitle.includes('hut') || lowerTitle.includes('cave')) iconClass = 'fa-campground';
            else if (lowerTitle.includes('agua') || lowerTitle.includes('water') || lowerTitle.includes('purifica') || lowerTitle.includes('hidratación')) iconClass = 'fa-tint';
            else if (lowerTitle.includes('fuego') || lowerTitle.includes('fire') || lowerTitle.includes('yesca') || lowerTitle.includes('brasa')) iconClass = 'fa-fire';
            else if (lowerTitle.includes('comida') || lowerTitle.includes('food') || lowerTitle.includes('forrajeo') || lowerTitle.includes('caza') || lowerTitle.includes('pesca') || lowerTitle.includes('trampa')) iconClass = 'fa-utensils';
            else if (lowerTitle.includes('navegación') || lowerTitle.includes('navigation') || lowerTitle.includes('mapa') || lowerTitle.includes('brújula') || lowerTitle.includes('orientación')) iconClass = 'fa-compass';
            else if (lowerTitle.includes('nudo') || lowerTitle.includes('knot') || lowerTitle.includes('cuerda')) iconClass = 'fa-code-branch'; // O un icono más específico si existe
            else if (lowerTitle.includes('médic') || lowerTitle.includes('herida') || lowerTitle.includes('first aid') || lowerTitle.includes('salud')) iconClass = 'fa-briefcase-medical';
            else if (lowerTitle.includes('señal') || lowerTitle.includes('signal') || lowerTitle.includes('rescate')) iconClass = 'fa-bullhorn';
            else if (lowerTitle.includes('herramienta') || lowerTitle.includes('tool') || lowerTitle.includes('cuchillo') || lowerTitle.includes('equipo')) iconClass = 'fa-tools';
            else if (lowerTitle.includes('mental') || lowerTitle.includes('psicología') || lowerTitle.includes('miedo') || lowerTitle.includes('estrés')) iconClass = 'fa-brain';
            else if (lowerTitle.includes('clima') || lowerTitle.includes('frío') || lowerTitle.includes('calor') || lowerTitle.includes('desierto') || lowerTitle.includes('nieve') || lowerTitle.includes('selva')) iconClass = 'fa-cloud-sun-rain';
            else if (lowerTitle.includes('defensa') || lowerTitle.includes('seguridad') || lowerTitle.includes('animal') || lowerTitle.includes('escape')) iconClass = 'fa-shield-alt';
             else if (lowerTitle.includes('plan') || lowerTitle.includes('prepara') || lowerTitle.includes('kit') || lowerTitle.includes('mochila')) iconClass = 'fa-clipboard-list';

            div.innerHTML = `<i class="fas ${iconClass}"></i> ${title}`; // Añadir icono
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar por relevancia o categoría podría ser mejor que alfabético aquí, pero alfabético es más simple
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay conocimientos disponibles en la base de datos «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             const uniqueNewTitles = newTitles.filter(title => !existingTitles.has(title));
             uniqueNewTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick to set survival topic context ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentSurvivalTopic = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i> <!-- Icono imagen genérico -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando ilustración...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Añadir al final del texto

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Ilustración no disponible.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de ilustración.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la información.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                // Opcional: ocultar chat si falla carga principal
                // chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se encontraron nuevos conocimientos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar conocimientos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Buscar Nuevos Conocimientos';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Verificar todos los elementos esenciales
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalTextArea) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">ERROR CRÍTICO: Fallo al cargar componentes de la interfaz. Recarga la página o contacta soporte.</p>';
                 return;
             }
            // Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            console.log(`Inicializados ${predefinedTitles.length} títulos de supervivencia.`);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>