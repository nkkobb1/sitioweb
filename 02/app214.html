<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethical Hacking Compendium - Interactive Guide</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fonts: Technical/Monospaced + Sans Serif -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Ethical Hacking --- */
        :root {
            --color-primary: #00ffab; /* Verde Menta Neón */
            --color-secondary: #00bfff; /* Azul Eléctrico Claro */
            --color-tertiary: #f0f0f0; /* Blanco Hueso (Texto Principal) */
            --color-background: #0d1117; /* Negro/Gris Muy Oscuro GitHub-like */
            --color-text: var(--color-tertiary);
            --color-text-muted: #8b949e; /* Gris Claro GitHub-like */
            --color-modal-bg: #161b22; /* Gris Oscuro Azulado GitHub-like */
            --color-border: #30363d; /* Borde Gris Oscuro GitHub-like */
            --color-error-bg: #2e1515; /* Fondo error rojo muy oscuro */
            --color-error-text: #ffa1a1; /* Texto error rojo claro */
            --color-error-border: #f85149; /* Borde error rojo GitHub-like */

            --shadow-sm: 0 1px 2px 0 rgba(0, 255, 171, 0.08);
            --shadow-md: 0 4px 6px -1px rgba(0, 255, 171, 0.1), 0 2px 4px -2px rgba(0, 255, 171, 0.08);
            --shadow-lg: 0 0 20px -5px rgba(0, 255, 171, 0.15), 0 8px 10px -6px rgba(0, 255, 171, 0.1);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Exo 2', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Exo 2', sans-serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 6px rgba(0, 255, 171, 0.5); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-tertiary); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 600;}
        #modal-title { color: var(--color-primary); font-weight: 600; text-shadow: 0 0 4px rgba(0, 255, 171, 0.4); }
        .navbar { background-color: rgba(13, 17, 23, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #0d1117; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Roboto Mono', monospace; }
        #search-input::placeholder { color: var(--color-text-muted); font-family: 'Exo 2', sans-serif; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 255, 171, 0.2); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.1rem 0.9rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-tertiary); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 60px; font-family: 'Roboto Mono', monospace; font-size: 0.9rem; line-height: 1.4; position: relative; overflow: hidden; }
        .title-item::before { content: ">_"; /* Prompt-like element */ position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--color-primary); opacity: 0.7; font-weight: 500; transition: opacity 0.2s ease; }
        .title-item span { padding-left: 28px; /* Space for prompt */ }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #1f2937; }
        .title-item:hover::before { opacity: 1; }

        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-background); padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Exo 2', sans-serif; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 1.8rem; letter-spacing: 0.5px; text-shadow: none; }
        #generate-more-btn:hover:not(:disabled) { background-color: #00e699; box-shadow: var(--shadow-md); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { } /* Spinner color inherited */

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(13, 17, 23, 0.92); backdrop-filter: blur(3px); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px; /* Slightly wider for potential code snippets */
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Increased height */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg); box-shadow: 0 0 8px var(--color-primary); }
        #modal-title { font-size: 1.7rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; font-family: 'Roboto Mono', monospace; }

        /* Area de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 8px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 7px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }

        #modal-content { padding: 0 5px; font-family: 'Exo 2', sans-serif; font-weight: 300; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content code { font-family: 'Roboto Mono', monospace; background-color: #20252c; padding: 0.1em 0.4em; border-radius: 3px; font-size: 0.9em; color: var(--color-text); border: 1px solid var(--color-border); }
        #modal-content pre { font-family: 'Roboto Mono', monospace; background-color: #0d1117; padding: 1em; border-radius: var(--border-radius); overflow-x: auto; border: 1px solid var(--color-border); margin: 1.5em 0; font-size: 0.9em; line-height: 1.5; }
        #modal-content pre code { background-color: transparent; padding: 0; border: none; } /* Reset code inside pre */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Exo 2', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 600;}
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: 0 0 12px rgba(0, 255, 171, 0.15); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); font-family: 'Roboto Mono', monospace; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(48, 54, 61, 0.8); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* Slightly taller chat */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.7rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #0d1117; font-family: 'Roboto Mono', monospace; font-size: 0.9em; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--color-primary); color: var(--color-background); margin-left: auto; text-align: left; font-weight: 500;} /* Left align user text for mono */
        .ai-message { background-color: #21262d; color: var(--color-tertiary); margin-right: auto; text-align: left; }
        .ai-message strong { color: var(--color-primary); } /* Highlight AI emphasis */
        .ai-message em { color: var(--color-secondary); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #1c2128; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Roboto Mono', monospace; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); background-color: #21262d; }
        #chat-send-btn { padding: 0.7rem 1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #00e699; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Roboto Mono', monospace; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(13, 17, 23, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.1s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 500; color: var(--color-primary); font-size: 1.2rem; font-family: 'Roboto Mono'; text-shadow: 0 0 5px var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Exo 2'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(13, 17, 23, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-shield-alt mr-3"></i> <!-- Icono escudo -->
                     Ethical Hacking Compendium
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-mono tracking-wider">// Interactive Guide</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora el Mundo del Hacking Ético</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Navega por conceptos, técnicas y herramientas clave utilizadas en ciberseguridad ofensiva y defensiva. Selecciona un tema para análisis detallado.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar término, herramienta o técnica...">
             <i class="fas fa-terminal fa-search"></i> <!-- Icono terminal/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book text-cyan-400 mr-2"></i> <!-- Icono libro/base de datos -->
                 Índice de Conocimiento
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-mono">Accediendo a la base de datos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-mono">// No se encontraron coincidencias</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Solicitar Más Intel
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Compilando Información...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <h3 class="text-sm font-semibold text-gray-400 mb-2 text-center font-mono">// Preguntas sobre: <span id="chat-context-title" class="text-primary"></span></h3>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Analizando consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Query >">
                         <button id="chat-send-btn" aria-label="Enviar Consulta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-black text-gray-500 py-6 mt-12 border-t border-gray-800 font-mono">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos sobre ciberseguridad.</p>
              <p class="mt-1">El uso indebido de esta información es ilegal y no ético. Úsala responsablemente.</p>
              <p class="mt-2">// Ethical Hacking Compendium v1.0</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Fundamentos y Metodologías
            "¿Qué es el Hacking Ético?", "Fases del Pentesting (Pruebas de Penetración)", "Reconocimiento (Reconnaissance)", "Escaneo (Scanning)", "Obtención de Acceso (Gaining Access)", "Mantenimiento de Acceso (Maintaining Access)", "Limpieza de Huellas (Covering Tracks)", "Tipos de Pentesting (Caja Negra, Blanca, Gris)", "Marco Legal y Ético del Hacking", "Normativa de Protección de Datos (GDPR, LOPD)", "Modelo OSI", "Modelo TCP/IP", "Conceptos de Redes (IP, Subnetting, DNS, DHCP)", "Criptografía Básica (Hashing, Simétrica, Asimétrica)", "Infraestructura de Clave Pública (PKI)", "Estándares de Seguridad (ISO 27001, NIST)", "Evaluación de Vulnerabilidades vs. Pentesting", "Inteligencia de Amenazas (Threat Intelligence)", "Modelado de Amenazas (Threat Modeling)", "Análisis de Riesgos de Seguridad", "Red Team vs. Blue Team vs. Purple Team", "OWASP Top 10 Vulnerabilidades Web", "Marco MITRE ATT&CK", "Cyber Kill Chain", "Gestión de Identidad y Acceso (IAM)",
            // Reconocimiento y Escaneo
            "Reconocimiento Pasivo", "Reconocimiento Activo", "OSINT (Open Source Intelligence)", "Google Dorking", "Herramientas OSINT (theHarvester, Maltego, Shodan)", "Escaneo de Puertos (Port Scanning)", "Tipos de Escaneo Nmap (SYN, TCP Connect, UDP, Xmas)", "Nmap Scripting Engine (NSE)", "Identificación de Servicios y Versiones (Nmap)", "Escaneo de Vulnerabilidades", "Nessus", "OpenVAS", "Nikto (Escáner Web)", "Dirb / Dirbuster (Descubrimiento de directorios)", "Enum4linux (Enumeración SMB)", "Sniffing de Red", "Wireshark (Análisis de paquetes)", "Tcpdump", "ARP Spoofing / ARP Poisoning", "DNS Spoofing", "Ingeniería Social: Principios", "Tipos de Ataques de Ingeniería Social (Phishing, Vishing, Smishing)",
            // Obtención de Acceso (Explotación)
            "Explotación de Vulnerabilidades", "Metasploit Framework: Conceptos", "Msfvenom (Generación de Payloads)", "Meterpreter (Shell Avanzada)", "Búsqueda de Exploits (SearchSploit, Exploit-DB)", "Buffer Overflow: Conceptos", "Stack Overflow", "Heap Overflow", "Format String Vulnerability", "Inyección SQL (SQLi)", "Tipos de SQLi (In-band, Blind, Out-of-band)", "SQLMap (Herramienta SQLi)", "Cross-Site Scripting (XSS)", "Tipos de XSS (Reflejado, Almacenado, DOM-based)", "Cross-Site Request Forgery (CSRF)", "Server-Side Request Forgery (SSRF)", "Inyección de Comandos (Command Injection)", "Path Traversal / Directory Traversal", "Inclusión de Ficheros Locales (LFI)", "Inclusión de Ficheros Remotos (RFI)", "Deserialización Insegura", "XML External Entity (XXE)", "Ataques de Contraseña", "Fuerza Bruta", "Ataques de Diccionario", "Password Spraying", "Pass the Hash (PtH)", "John the Ripper (Crackeador)", "Hydra (Crackeador Online)", "Hashcat (Crackeador GPU)", "Explotación de Servicios (FTP, SSH, SMB, Telnet)", "Vulnerabilidades Web Comunes (Más allá de OWASP)", "Ataques a APIs (REST, SOAP)", "Ataques a Sistemas de Autenticación (OAuth, SAML)",
            // Hacking de Sistemas Windows
            "Enumeración de Sistemas Windows", "Escalada de Privilegios en Windows", "Kernel Exploits (Windows)", "Servicios mal configurados (Windows)", "DLL Hijacking", "UAC Bypass", "Credenciales Almacenadas (SAM, LSASS)", "Mimikatz", "Golden Ticket Attack", "Silver Ticket Attack", "BloodHound (Análisis Active Directory)", "PowerShell para Pentesters (PowerSploit, Empire)", "Windows Management Instrumentation (WMI) Hacking", "Registro de Windows Hacking", "Group Policy Objects (GPO) Hacking",
            // Hacking de Sistemas Linux/Unix
            "Enumeración de Sistemas Linux", "Escalada de Privilegios en Linux", "Kernel Exploits (Linux)", "SUID/GUID Binaries", "Cron Jobs mal configurados", "Permisos de Ficheros Débiles", "sudo Misconfigurations", "Capabilities (Linux)", "Path Variable Hijacking", "Shared Library Injection", "Explotación de Servicios (NFS, etc.)", "Docker Escape", "Kubernetes Hacking", "Shell Scripting para Pentesters",
            // Hacking de Redes Inalámbricas (Wireless)
            "Fundamentos de Redes WiFi (802.11)", "WEP, WPA, WPA2, WPA3", "Modo Monitor (Monitor Mode)", "Aircrack-ng Suite", "Airodump-ng (Captura)", "Aireplay-ng (Ataques)", "Aircrack-ng (Crackeo)", "Ataques a WEP", "Ataques a WPA/WPA2 PSK (Handshake)", "Ataques Evil Twin", "Ataques de Desautenticación", "WPS (Wi-Fi Protected Setup) Attacks (Pixie Dust)", "Bluetooth Hacking (Bluejacking, Bluesnarfing)",
            // Hacking Web Avanzado
            "Web Shells", "Server-Side Template Injection (SSTI)", "HTTP Request Smuggling", "Web Cache Poisoning", "Insecure Direct Object References (IDOR)", "Race Conditions en Web", "WebSockets Hacking", "GraphQL Hacking", "Content Security Policy (CSP) Bypass", "Subdomain Takeover", "Burp Suite: Funciones Avanzadas (Intruder, Repeater, Sequencer)", "OWASP ZAP (Alternativa a Burp)", "Browser Exploitation Framework (BeEF)",
            // Mantenimiento de Acceso y Post-Explotación
            "Persistencia en Sistemas Windows", "Persistencia en Sistemas Linux", "Creación de Backdoors", "Rootkits", "Pivoting y Movimiento Lateral", "Exfiltración de Datos", "Command and Control (C2) Frameworks (Cobalt Strike, Empire)", "Técnicas de Evasión de Antivirus", "Evasión de Firewalls", "Evasión de IDS/IPS", "Técnicas Anti-Forenses",
            // Hacking Móvil
            "Plataformas Móviles (Android, iOS)", "Rooting (Android) / Jailbreaking (iOS)", "Análisis Estático de Apps Móviles", "Análisis Dinámico de Apps Móviles (Drozer, Frida)", "Vulnerabilidades Comunes en Apps Móviles (OWASP Mobile Top 10)", "Interceptación de Tráfico Móvil", "Ataques a Componentes de Apps (Intents, Activities)",
            // Hacking de Nube (Cloud)
            "Conceptos de Seguridad en la Nube (AWS, Azure, GCP)", "Enumeración de Servicios Cloud", "Bucket Misconfigurations (S3, Azure Blob)", "Serverless (Lambda/Functions) Hacking", "Metadata Service Exploitation", "IAM Misconfigurations (Cloud)", "CloudFormation/Terraform Security", "Pacu (Framework AWS Hacking)",
            // Hacking de IoT (Internet de las Cosas)
            "Arquitectura de Sistemas IoT", "Protocolos IoT (MQTT, CoAP, Zigbee, Z-Wave)", "Hardware Hacking Básico (UART, JTAG)", "Firmware Analysis", "Reversing Firmware", "Ataques a Interfaces Web de IoT", "Default Credentials (IoT)", "Shodan para IoT",
            // Ingeniería Inversa y Análisis de Malware
            "Conceptos de Ingeniería Inversa", "Ensamblador (x86/x64, ARM)", "Desensambladores (IDA Pro, Ghidra, Radare2)", "Depuradores (GDB, OllyDbg, x64dbg)", "Análisis Estático de Malware", "Análisis Dinámico de Malware (Sandboxing, Cuckoo)", "Ofuscación y Packing de Malware", "Técnicas Anti-Análisis (Anti-VM, Anti-Debug)", "Tipos de Malware (Virus, Gusano, Troyano, Ransomware, Spyware)",
            // Criptografía Aplicada y Ataques
            "Ataques a Cifrados Débiles", "Padding Oracle Attack", "Ataques a Implementaciones TLS/SSL", "Ataques a Hashes (Colisiones, Rainbow Tables)", "Esteganografía", "Steghide (Herramienta Esteganografía)",
            // Defensa y Hardening (Perspectiva del Hacker)
            "Hardening de Sistemas Operativos", "Configuración Segura de Servidores Web", "Web Application Firewalls (WAF)", "Intrusion Detection Systems (IDS)", "Intrusion Prevention Systems (IPS)", "Security Information and Event Management (SIEM)", "Análisis de Logs", "Honeypots", "Sandboxing", "Principio de Menor Privilegio", "Segmentación de Red",
            // Herramientas y Distribuciones
            "Kali Linux", "Parrot OS", "BlackArch Linux", "Python para Pentesters", "Bash Scripting", "Go para Pentesters", "Docker para Pentesters", "Git para Seguridad", "Virtualización (VMware, VirtualBox)",
            // Certificaciones y Carrera
            "Certified Ethical Hacker (CEH)", "Offensive Security Certified Professional (OSCP)", "CompTIA PenTest+", "GIAC Penetration Tester (GPEN)", "Certified Information Systems Security Professional (CISSP)", "Carrera Profesional en Ciberseguridad Ofensiva",
            // Vulnerabilidades Famosas (Ejemplos)
            "Heartbleed (OpenSSL)", "Shellshock (Bash)", "Log4Shell (Log4j)", "EternalBlue (SMB)", "BlueKeep (RDP)",
            // Conceptos Emergentes
            "Hacking de IA/ML", "Seguridad en Blockchain", "Hacking Cuántico (Teórico)", "Automatización en Pentesting",
        ];
        const ethicalHackingThemes = [
            "pentesting methodologies", "network scanning tools", "web vulnerability scanners", "exploitation frameworks", "password cracking techniques", "wireless hacking tools", "social engineering tactics", "Windows privilege escalation", "Linux privilege escalation", "Active Directory hacking", "cloud security hacking (AWS/Azure/GCP)", "mobile application hacking", "IoT device hacking", "malware analysis techniques", "reverse engineering tools", "cryptography attacks", "OSINT techniques", "firewall evasion", "IDS/IPS bypass", "post-exploitation techniques", "data exfiltration methods", "command and control frameworks", "OWASP Top 10", "MITRE ATT&CK framework", "red teaming operations", "blue teaming tools", "threat modeling", "vulnerability assessment tools", "secure coding principles from hacker view", "container security (Docker/Kubernetes)"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un experto senior en ciberseguridad y hacking ético con amplia experiencia práctica y docente. Describe el concepto, herramienta o técnica de hacking ético indicada de manera detallada, precisa y objetiva. Incluye: Definición clara, cómo funciona (mecanismo técnico simplificado si aplica), para qué se usa en hacking ético (propósito/objetivo), herramientas comunes asociadas, posibles contramedidas o mitigaciones, y consideraciones éticas/legales relevantes. Usa un lenguaje técnico pero accesible. El objetivo es una explicación exhaustiva de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente término:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat, system prompt se sobreescribe
            model: "mistral-tiny", // Modelo más rápido para chat
             systemPrompt: "Actúa como un asistente experto en ciberseguridad, enfocado únicamente en el concepto o herramienta de hacking ético que se está mostrando. Responde preguntas de seguimiento sobre sus detalles técnicos, uso práctico, riesgos o defensas relacionadas. Sé conciso, preciso y mantente estrictamente dentro del tema actual.",
            timeoutSeconds: 50 // Timeout ligeramente mayor para chat potencialmente más técnico
        };
        const titleGenerationConfig = { // MODIFIED: Generate 40 titles
            model: "mistral",
            systemPrompt: "Actúa como un generador de términos técnicos concisos para una base de datos de hacking ético. Genera exactamente 40 nombres específicos de herramientas, técnicas, vulnerabilidades, conceptos o metodologías relevantes en ciberseguridad ofensiva/defensiva. Devuelve *solo* la lista de términos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Increased timeout for generating more titles
        };

        // ========== DOM ELEMENTS ==========
        // (Identical to previous version, just ensure all are selected correctly)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const chatContextTitle = document.getElementById('chat-context-title'); // Added for clarity in chat
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Renamed for clarity

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Eres un asistente experto en ciberseguridad, enfocado únicamente en el concepto o herramienta de hacking ético llamado '${currentTopicTitle}'. Responde preguntas de seguimiento sobre sus detalles técnicos, uso práctico, riesgos o defensas relacionadas. Sé conciso, preciso y mantente estrictamente dentro del tema actual.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}, Timeout: ${config.timeoutSeconds}s): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, intenta en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o seleccionar otro tema.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La solicitud a la IA tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(topicTitle) {
             return fetchTextFromApi(topicTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
             if (!currentTopicTitle) throw new Error("Error interno: No se ha establecido el contexto del tema para el chat.");
             return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        // *** MODIFIED: fetchGeneratedTitles to get 40 ***
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(ethicalHackingThemes) || "hacking ético general";
            const specificPrompt = `Genera 40 términos específicos (herramientas, técnicas, conceptos) sobre ${randomTheme}`;
            console.log("Generating 40 titles with prompt:", specificPrompt);
            // Usa la función genérica fetchTextFromApi con la config específica
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n')
                                       .map(line => line.replace(/^[-\d.\s*]+/, '').trim()) // Clean up list markers
                                       .filter(line => line.length > 3 && line.length < 150); // Basic sanity check
                     // Ensure we got a decent number, maybe not exactly 40 but close
                     if (titles.length < 20) { // Adjusted threshold
                          console.warn(`API generated fewer titles than expected (${titles.length}/40)`);
                          if (titles.length < 5) throw new Error("La IA no generó suficientes términos nuevos.");
                     }
                     console.log(`Generated ${titles.length} new titles.`);
                     return titles.slice(0, 40); // Return up to 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "ethical hacking concept";
             // Enhanced prompt for abstract cyber/digital theme
             const enhancedPrompt = `Abstract digital art representing the ethical hacking concept '${safePromptText}'. Focus on cybersecurity, data streams, network connections, circuits, binary code patterns, abstract shapes. Use dark background with green, cyan, or blue neon accents. Avoid text, logos, diagrams, real people, servers. Conceptual, minimalist, technological.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, letters, labels, titles, captions, graphs, charts, diagrams, user interface, realistic photograph, person, figure, server rack, computer screen, logo, watermark, signature, map, flag, messy, cluttered, blurry";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ==========
        // Added basic support for ``` code blocks -> <pre><code>
        function formatExplanationText(rawText) {
             if (!rawText) return '';
             let formatted = rawText.trim();

             // Handle ``` code blocks first
             formatted = formatted.replace(/```(\w*)\n([\s\S]*?)\n```/g, (match, lang, code) => {
                 // Basic escaping for HTML within code, though ideally handled by syntax highlighter later
                 const escapedCode = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                 return `<pre><code class="language-${lang || 'plaintext'}">${escapedCode.trim()}</code></pre>`;
             });
              // Handle inline `code`
             formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

             // Standard formatting (Headers, Bold, Italic, etc.) - apply AFTER code block handling
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

             // Paragraph handling (split by double newline, ignore if already inside <pre>)
             const blocks = formatted.split(/\n\s*\n/);
             formatted = blocks.map(block => {
                 const trimmedBlock = block.trim();
                 if (trimmedBlock.length === 0) return '';
                 // If it's already a formatted block (header, pre), keep it
                 if (/^<(h[1-4]|pre|ul|ol|blockquote)/.test(trimmedBlock)) {
                     return trimmedBlock;
                 }
                 // Convert simple list markers (* or -) to <li>, needs wrapping in <ul> later maybe? Basic for now.
                 if (/^[\*\-]\s+/.test(trimmedBlock)) {
                    // Basic conversion, doesn't handle nested lists well
                    return '<ul>' + trimmedBlock.split('\n').map(item => `<li>${item.replace(/^[\*\-]\s+/, '').trim()}</li>`).join('') + '</ul>';
                 }
                 // Otherwise, wrap in <p>, replace single newlines with space within paragraph
                 return `<p>${trimmedBlock.replace(/(?<!\n)\n(?!\n)/g, ' ')}</p>`;
             }).join('');

             // Simple cleanup for potential multiple consecutive <ul> tags
             formatted = formatted.replace(/<\/ul>\s*<ul>/g, '');

             return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Identical structure)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null; // Clear chat context
             if(chatContextTitle) chatContextTitle.textContent = ''; // Clear context display
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Identical)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (Added context display)
        function addChatMessage(message, sender) { /* ... */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            // Basic Markdown to HTML
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                             .replace(/\*(.*?)\*/g, '<em>$1</em>')
                             .replace(/`([^`]+)`/g, '<code>$1</code>');
            // Simple link detection (basic)
            message = message.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-secondary hover:underline">$1</a>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... */
            const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... */
            const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); }
        }

        // ========== UI & EVENT HANDLERS ========== (Identical structure)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        // Modified createTitleItem for prompt style
        function createTitleItem(title) {
             const div = document.createElement('div');
             div.className = 'title-item';
             // div.textContent = title; // Text added inside span now
             const span = document.createElement('span');
             span.textContent = title;
             div.appendChild(span);
             div.setAttribute('data-title', title);
             div.addEventListener('click', () => handleTitleClick(title));
             return div;
        }
        function displayTitles(titles) { /* ... */
             if (!titleListContainer || !titlesLoading) return;
             // Keep alphabetical sort
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-mono">// No hay datos disponibles</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... */
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Appended ${addedCount} new unique titles.`);
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // SET CHAT CONTEXT
            if (chatContextTitle) chatContextTitle.textContent = title; // Display context in chat area
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset text area scroll
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-project-diagram placeholder-icon"></i> <!-- Icono Diagrama/Concepto -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">// Fallo al cargar visualización</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">// Error URL imagen</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la información.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 items ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Solicitando Intel...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // This now fetches 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más términos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar términos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Solicitar Más Intel';
             }
         }

         // Search Filter Function (with normalization)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Hide if results OR no titles at all
         }

        // ========== INITIALIZATION ========== (Identical structure)
        function initApp() {
            // Ensure all elements exist
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !chatContextTitle) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: #f85149; font-family: monospace; font-size: 1.5em; text-align: center; padding-top: 3em;">!! KERNEL PANIC: UI Elements Missing !! - Unable to initialize interface.</p>';
                return;
             }
            // Add listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            console.log("Ethical Hacking Compendium Initialized.");
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>