<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glosario de Derecho Laboral Sencillo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Derecho Laboral --- */
        :root {
            --color-primary: #1d4ed8; /* Azul Profesional */
            --color-secondary: #0d9488; /* Teal como acento */
            --color-background: #f8fafc; /* Fondo claro */
            --color-text: #1f2937; /* Texto oscuro */
            --color-text-muted: #6b7280; /* Texto gris */
            --color-modal-bg: #ffffff;
            --color-border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); }
        h1, h2, h3, h4, .logo { font-family: 'Quicksand', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1e40af; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.8); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem; max-width: 850px; width: 95%; max-height: 90vh; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e5e7eb; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.4rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #d1d5db; color: var(--color-text); }
        #modal-title { color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; }
        #modal-content { line-height: 1.7; color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 10px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content::-webkit-scrollbar { width: 8px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.2em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Quicksand', sans-serif; margin-top: 1.8em; margin-bottom: 0.8em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.3em; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.2em; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-secondary); }
        #modal-content .formula { text-align: center; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 1.1em; padding: 0.8em; margin: 1.2em 0; border: 1px solid var(--color-border); background-color: #f9fafb; border-radius: var(--border-radius); overflow-x: auto; white-space: nowrap; }
        #modal-content .formula sub, #modal-content .formula sup { font-size: 0.8em; line-height: 0; position: relative; vertical-align: baseline; }
        #modal-content .formula sub { top: 0.5em; }
        #modal-content .formula sup { top: -0.5em; }
        #modal-image-container { width: 100%; height: 220px; background-color: #f3f4f6; border-radius: var(--border-radius); overflow: hidden; display: none; /* Start hidden */ align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; margin-top: 1rem; }
        #modal-image-container.visible { display: flex; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 2.5rem; color: var(--color-border); display: none; }
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: var(--border-radius); border: 1px solid #fecaca; margin-top: 1rem; text-align: center; flex-shrink: 0; }
        .error-msg i { margin-right: 0.5rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-3 flex justify-center items-center">
             <div class="flex items-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-gavel mr-2"></i> Glosario de Derecho Laboral
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Entendiendo tus Derechos y Deberes</h1>
             <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Explicaciones claras de términos laborales clave generadas por IA. ¡Selecciona un término!</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-file-contract text-teal-600 mr-2"></i>
                 Términos a Consultar
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Buscando cláusulas...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Términos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Interpretando término...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                 </div>
                  <!-- Image Container (Initially Hidden) -->
                 <div id="modal-image-container">
                     <div class="spinner"></div>
                     <i class="fas fa-balance-scale-left placeholder-icon"></i> <!-- Placeholder icon -->
                     <img id="modal-image" alt="Visualización abstracta del concepto legal" />
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-circle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-5 mt-12 border-t border-gray-200">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA con fines informativos. No sustituyen el asesoramiento legal profesional.</p>
              <p class="mt-1">© 2025 Glosario Laboral Sencillo</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        // --- Ampliando la lista de títulos (Objetivo 400, ejemplo con ~200) ---
        const predefinedTitles = [
            // Contratación
            "¿Qué es un Contrato de Trabajo?", "Contrato Indefinido", "Contrato Temporal", "Contrato por Obra o Servicio Determinado", "Contrato Eventual por Circunstancias de la Producción", "Contrato de Interinidad", "Contrato en Prácticas", "Contrato para la Formación y el Aprendizaje", "Contrato a Tiempo Parcial", "Contrato Fijo-Discontinuo", "Período de Prueba", "Pacto de No Competencia", "Pacto de Permanencia", "Pacto de Exclusividad", "Subcontratación Laboral", "Cesión Ilegal de Trabajadores", "Empresas de Trabajo Temporal (ETT)", "El Precontrato de Trabajo", "Requisitos Formales del Contrato", "Nulidad del Contrato", "¿Qué es el Objeto del Contrato?", "¿Qué es la Causa del Contrato?", "Capacidad para Contratar", "Contratación de Extranjeros", "Contrato de Alta Dirección",
            // Salario y Prestaciones
            "¿Qué es el Salario?", "Salario Base", "Complementos Salariales (Personales, Puesto, Cantidad/Calidad)", "Pagas Extraordinarias (Verano, Navidad)", "Salario en Especie", "Recibo de Salarios (Nómina)", "Salario Mínimo Interprofesional (SMI)", "Horas Extraordinarias", "Plus de Nocturnidad", "Plus de Peligrosidad/Toxicidad/Penosidad", "Plus de Disponibilidad", "Dietas y Gastos de Viaje", "Anticipos Salariales", "Embargo de Salario", "Fondo de Garantía Salarial (FOGASA)", "Indemnizaciones Laborales", "Prestaciones de la Seguridad Social", "Prestación por Incapacidad Temporal (Baja Médica)", "Prestación por Maternidad/Paternidad", "Prestación por Desempleo (Paro)", "Jubilación", "Cotización a la Seguridad Social", "Base de Cotización", "Tipo de Cotización",
            // Jornada Laboral y Tiempo de Trabajo
            "Jornada Laboral Ordinaria", "Jornada Máxima Legal", "Distribución Irregular de la Jornada", "Trabajo a Turnos", "Trabajo Nocturno", "Descanso Semanal", "Descanso Diario (Entre Jornadas)", "Descanso Durante la Jornada (Bocadillo)", "Horario de Trabajo", "Calendario Laboral", "Registro de Jornada", "Flexibilidad Horaria", "Reducción de Jornada (por Guarda Legal, etc.)", "Teletrabajo / Trabajo a Distancia", "Disponibilidad Horaria", "Permisos Retribuidos (Matrimonio, Nacimiento, Fallecimiento, etc.)", "Permiso de Lactancia", "Horas Complementarias (Contrato a Tiempo Parcial)",
            // Descansos y Vacaciones
            "Vacaciones Anuales Retribuidas", "Fijación del Periodo de Vacaciones", "Duración de las Vacaciones", "¿Se pueden pagar las vacaciones no disfrutadas?", "Interrupción de las Vacaciones (por IT, etc.)", "Días Festivos (Fiestas Laborales)", "Descanso Semanal Acumulado",
            // Modificación, Suspensión y Extinción del Contrato
            "Modificación Sustancial de las Condiciones de Trabajo (MSCT)", "Movilidad Geográfica (Traslado)", "Movilidad Funcional", "Suspensión del Contrato de Trabajo (Causas)", "Excedencia Voluntaria", "Excedencia Forzosa", "Excedencia por Cuidado de Hijos/Familiares", "Extinción del Contrato de Trabajo", "Dimisión del Trabajador", "Mutuo Acuerdo entre las Partes", "Causas Objetivas de Extinción", "Despido Disciplinario", "Causas del Despido Disciplinario", "Procedimiento del Despido Disciplinario", "Carta de Despido", "Calificación del Despido (Procedente, Improcedente, Nulo)", "Despido Colectivo (ERE de Extinción)", "Despido por Causas Económicas, Técnicas, Organizativas o de Producción (ETOP)", "Impugnación del Despido", "Acto de Conciliación Laboral (SMAC)", "Demanda Judicial por Despido", "Salarios de Tramitación", "Readmisión del Trabajador", "Indemnización por Despido Improcedente", "Indemnización por Despido Objetivo", "Finiquito: Concepto y Cálculo", "Certificado de Empresa",
            // Derechos y Deberes Laborales
            "Derecho al Trabajo", "Derecho a la Libre Sindicación", "Derecho a la Huelga", "Derecho a la Negociación Colectiva", "Derecho a la Ocupación Efectiva", "Derecho a la Promoción y Formación Profesional", "Derecho a la Integridad Física y Política de Seguridad y Salud", "Derecho a la Intimidad y Dignidad", "Derecho a la Desconexión Digital", "Protección frente al Acoso Laboral (Mobbing)", "Protección frente al Acoso Sexual y por Razón de Sexo", "Igualdad de Trato y No Discriminación", "Deber de Buena Fe Contractual", "Deber de Diligencia", "Deber de Obediencia (Dentro de límites)", "Deber de Contribuir a la Mejora de la Productividad", "Deberes en Materia de Prevención de Riesgos Laborales",
            // Derechos Colectivos y Representación
            "Sindicatos: ¿Qué son y para qué sirven?", "Afiliación Sindical", "Secciones Sindicales", "Delegados Sindicales", "Comités de Empresa", "Delegados de Personal", "Elecciones Sindicales", "Representación Unitaria vs. Sindical", "Convenio Colectivo: Concepto y Eficacia", "Negociación de Convenios Colectivos", "Contenido del Convenio Colectivo", "Impugnación de Convenios Colectivos", "Descuelgue Salarial (Inaplicación de Convenio)", "Conflicto Colectivo", "Huelga: Concepto y Tipos", "Procedimiento de Huelga", "Servicios Mínimos en Huelga", "Esquirolaje", "Cierre Patronal (Lock-out)",
            // Seguridad Social y Prevención
            "Sistema de la Seguridad Social", "Régimen General y Regímenes Especiales", "Afiliación y Alta en la Seguridad Social", "Baja en la Seguridad Social", "Incapacidad Permanente (Grados)", "Accidente de Trabajo", "Enfermedad Profesional", "Mutuas Colaboradoras con la Seguridad Social", "Prevención de Riesgos Laborales (PRL)", "Evaluación de Riesgos", "Plan de Prevención", "Equipos de Protección Individual (EPI)", "Vigilancia de la Salud", "Comité de Seguridad y Salud", "Delegados de Prevención", "Recargo de Prestaciones por Falta de Medidas de Seguridad",
            // Procedimiento Laboral e Inspección
            "Jurisdicción Social", "Juzgados de lo Social", "Tribunales Superiores de Justicia (Sala Social)", "Tribunal Supremo (Sala Social)", "Procedimiento Ordinario Laboral", "Procedimiento por Despido", "Proceso Monitorio Laboral", "Recursos Laborales (Suplicación, Casación)", "Ejecución de Sentencias Laborales", "Inspección de Trabajo y Seguridad Social (ITSS)", "Acta de Infracción", "Acta de Liquidación de Cuotas", "Sanciones Administrativas Laborales", "Libro de Visitas (Electrónico)",
            // Otros Conceptos
            "Estatuto de los Trabajadores", "Fuentes del Derecho Laboral", "Principio Pro Operario", "Condición Más Beneficiosa", "Prescripción y Caducidad de Acciones Laborales", "Grupo Profesional", "Categoría Profesional", "Antigüedad en la Empresa", "Cláusula de Consolidación de Nivel", "Salario a Comisión", "Stock Options (Opciones sobre Acciones)", "Plan de Pensiones de Empleo", "Seguro de Convenio", "Derecho Laboral Internacional", "Carta Social Europea", "Organización Internacional del Trabajo (OIT)"
             // ... (Continuar añadiendo hasta ~400)
        ];
        const laborLawThemes = [
            "tipos de contratos laborales", "cálculo de nóminas", "jornada y horarios", "vacaciones y permisos", "modificación de condiciones laborales", "suspensión del contrato", "tipos de despido", "indemnizaciones", "derechos fundamentales del trabajador", "representación sindical", "convenios colectivos", "seguridad social y prestaciones", "prevención de riesgos laborales", "procedimiento judicial laboral", "actuación de la inspección de trabajo", "derechos de la mujer trabajadora", "trabajo a distancia", "contratación temporal", "negociación colectiva", "derecho a la huelga", "seguridad y salud laboral", "despido colectivo y ERE", "FOGASA", "régimen de autónomos (comparativa básica)", "movilidad geográfica y funcional"
        ];
        // --- Aumentando longitud y timeout ---
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un experto en Derecho Laboral español y un excelente comunicador. Tu tarea es explicar de forma muy clara, sencilla, precisa y detallada UN ÚNICO término o concepto de derecho laboral proporcionado, como si lo explicaras a un trabajador, empleador o estudiante que necesita entenderlo bien (similar a una entrada de glosario muy completa o un artículo divulgativo introductorio). Usa lenguaje accesible, evita la jerga legal excesiva (o explícala muy bien si es imprescindible), utiliza ejemplos prácticos y analogías si es posible. Estructura la explicación con párrafos claros y, si ayuda, sub-títulos (usando markdown #, ##, ### o ####). El objetivo es una explicación exhaustiva y fácil de entender de unas 1200-1300 palabras. Céntrate EXCLUSIVAMENTE en el concepto proporcionado:",
            timeoutSeconds: 150 // Aumentado
        };
        const titleGenerationConfig = { model: "mistral", systemPrompt: "Actúa como un generador de ideas conciso. Genera exactamente 15 términos o conceptos clave sobre Derecho Laboral español, adecuados para ser explicados de forma sencilla. Devuelve *solo* la lista de términos/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.", timeoutSeconds: 30 };

        // ========== DOM ELEMENTS ========== (sin cambios)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // --- Variable para el listener de scroll (sin cambios) ---
        let currentScrollHandler = null;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) { /* ... (sin cambios) ... */
            const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url}`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
             }
        }
        async function fetchExplanationText(conceptTitle) { /* ... (sin cambios - usa textApiConfig actualizado) ... */
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              // Ajustar la comprobación de longitud mínima si se espera texto más largo
              if (text.trim().length < 1000 || text.toLowerCase().includes("cannot fulfill")) {
                   throw new Error("La IA no pudo generar una explicación suficientemente detallada para este término.");
               }
             return text;
        }
        async function fetchGeneratedTitles() { /* ... (sin cambios - usa titleGenerationConfig actualizado) ... */
            const randomTheme = getRandomElement(laborLawThemes) || "conceptos laborales básicos";
             const specificPrompt = `Genera 15 términos o conceptos clave sobre ${randomTheme} en Derecho Laboral español`;
             console.log("Generating concepts with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 120);
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de términos.");
             return titles.slice(0, 15);
        }
        // --- Actualizando prompt de imagen ---
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "labor law concept abstract";
            // Prompt enfocado en abstracción, justicia, acuerdo, trabajo
            const enhancedPrompt = `Abstract visualization representing the legal or work concept of '${safePromptText}', minimalist style, symbolic, focusing on balance, agreement, rights, or process, professional aesthetic`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            // Negative prompt más estricto para evitar elementos no deseados
            const negativePrompt = "text, words, writing, letters, numbers, paragraphs, paragraphs of text, specific legal documents, law book, code book, gavel, scales of justice drawing, courtroom, judge, lawyer, people, person, faces, signatures, form, contract text, money, coins, bills, company logo, building, office interior, computer screen, specific objects, realistic photo, handwriting, chart, graph, diagram";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (exactamente igual que la versión anterior) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (sin cambios en la lógica, solo el reset del scroll ya está fijo)
        function showModal() { /* ... */ if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { /* ... */
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll on hide
            console.log("Scroll set to 0 on hideModal");
            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
                console.log("Scroll listener removed on hideModal.");
            }
            resetModalState();
         }
        function resetModalState() { /* ... */
            if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             // ScrollTop is handled in hideModal and handleTitleClick
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.classList.remove('visible');
             modalImageContainer.style.display = 'none';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (sin cambios en la lógica, scroll y visibilidad de imagen ya están fijos)
        function getRandomElement(arr) { /* ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... */
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]); // Shuffle initial list too
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay términos disponibles.</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        async function handleTitleClick(title) { /* ... (Exactamente la misma lógica que la versión anterior para scroll/imagen) ... */
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalImageContainer.style.display = 'none';
            modalImageContainer.classList.remove('visible');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
            }

            try {
                const rawExplanationText = await fetchExplanationText(title); // Usa config actualizada
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;

                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.scrollTop = 0; // <<<--- RESET SCROLL HERE
                console.log("Scroll set to 0 after content visible");

                modalImageSpinner.style.display = 'block';
                const imageUrl = createPollinationsImageUrl(title); // Usa prompt actualizado
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL:", title);
                     modalImageSpinner.style.display = 'none';
                     modalImagePlaceholder.style.display = 'block';
                 }

                const scrollBuffer = 15;
                currentScrollHandler = () => {
                    if (modalContent.scrollHeight <= modalContent.clientHeight) {
                         console.log("Content fits, showing image immediately.");
                         modalImageContainer.classList.add('visible');
                         modalImageContainer.style.display = 'flex';
                         modalContent.removeEventListener('scroll', currentScrollHandler);
                         currentScrollHandler = null;
                    } else if ((modalContent.scrollTop + modalContent.clientHeight) >= (modalContent.scrollHeight - scrollBuffer)) {
                        console.log("Scroll end reached, showing image.");
                        modalImageContainer.classList.add('visible');
                        modalImageContainer.style.display = 'flex';
                        modalContent.removeEventListener('scroll', currentScrollHandler);
                        currentScrollHandler = null;
                        console.log("Scroll listener removed after showing image.");
                    }
                };
                modalContent.addEventListener('scroll', currentScrollHandler);
                console.log("Scroll listener added.");
                setTimeout(currentScrollHandler, 100);

            } catch (error) {
                console.error("Failed to display explanation:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error al cargar: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = '';

                 if (currentScrollHandler) {
                    modalContent.removeEventListener('scroll', currentScrollHandler);
                    currentScrollHandler = null;
                 }
            }
        }

        async function handleGenerateMoreTitles() { /* ... (sin cambios en lógica, usa config actualizada) ... */
            if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             // Actualizar texto del botón
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Usa config actualizada
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se pudieron generar nuevos términos en este momento."); }
             } catch (error) { console.error("Failed generation:", error); alert(`Error: ${error.message}`);
             } finally { generateMoreBtn.disabled = false; // Restaurar texto original del botón
                generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Términos';
             }
        }

        // ========== INITIALIZATION ========== (sin cambios)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p>Error crítico inicializando la aplicación.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles); // Muestra la lista inicial (barajada)
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>