<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercenarios Robóticos Interplanetarios - Base de Datos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Técnicas/Sci-Fi -->
    <link href="https://fonts.googleapis.com/css2?family=Aldrich&family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Mercenarios Robóticos --- */
        :root {
            --color-primary: #ff8c00; /* Naranja Intenso (Advertencia/Energía) */
            --color-secondary: #00aaff; /* Cian Claro (Tech/Interfaz) */
            --color-tertiary: #f0f0f0; /* Blanco Hueso (Texto Principal) */
            --color-background: #0d1117; /* Negro/Gris Muy Oscuro (GitHub Dark) */
            --color-background-alt: #161b22; /* Gris Oscuro Alternativo */
            --color-modal-bg: #1c2128; /* Fondo Modal más oscuro */
            --color-text: var(--color-tertiary);
            --color-text-muted: #8b949e; /* Gris Medio */
            --color-border: #30363d; /* Borde Gris */
            --color-error-bg: #4d1212;
            --color-error-text: #fca5a5;
            --color-error-border: #ef4444;

            --shadow-sm: 0 1px 2px 0 rgba(255, 140, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(255, 140, 0, 0.15), 0 2px 4px -2px rgba(255, 140, 0, 0.1);
            --shadow-lg: 0 0 25px -5px rgba(255, 140, 0, 0.25), 0 8px 10px -6px rgba(255, 140, 0, 0.2);
            --border-radius: 4px; /* Ligeramente redondeado */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Roboto Condensed', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Aldrich', sans-serif; font-weight: 400; /* Aldrich es naturally bold */ letter-spacing: 1.5px; text-transform: uppercase; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 400; text-shadow: 0 0 6px rgba(255, 140, 0, 0.8); }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 400; }
        #modal-title { color: var(--color-primary); font-weight: 400; text-shadow: 0 0 4px rgba(255, 140, 0, 0.6); }
        .navbar { background-color: rgba(22, 27, 34, 0.85); backdrop-filter: blur(8px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 3rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3.2rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1.05rem; background-color: var(--color-background-alt); color: var(--color-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); transition: var(--transition-normal); font-family: 'Roboto Condensed'; letter-spacing: 0.5px; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(255, 140, 0, 0.3), inset 0 1px 3px rgba(0,0,0,0.3); outline: none; background-color: #21262d; }
        #search-container .fa-search { position: absolute; left: 1.1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.2rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 75px; font-family: 'Roboto Condensed'; font-size: 1.05rem; letter-spacing: 0.5px; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-5px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #21262d; border-left-color: var(--color-primary); }
        .title-item i { font-size: 1.3em; margin-bottom: 0.5rem; color: var(--color-secondary); transition: color 0.2s ease;}
        .title-item:hover i { color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(60deg, var(--color-primary), #ffae42); color: var(--color-background); padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Aldrich', sans-serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; letter-spacing: 1.5px; text-shadow: none; text-transform: uppercase; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(60deg, #ffae42, var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(13, 17, 23, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-top: 3px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.8rem 2.2rem;
            max-width: 1000px; /* Slightly wider */
            width: 96%;
            max-height: 92vh;
            min-height: 450px; /* Taller for game/chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg); box-shadow: 0 0 12px var(--color-primary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Area de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; margin-bottom: 1.2rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Aldrich', sans-serif; margin-top: 2.4em; margin-bottom: 1.2em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 400; letter-spacing: 1px; text-transform: uppercase;}
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-primary); }
        #modal-content h4 { font-size: 1.15em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 3rem auto 1rem auto; border: 2px solid var(--color-border); border-radius: var(--border-radius); box-shadow: 0 0 18px rgba(0, 170, 255, 0.2); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 25px rgba(0, 170, 255, 0.4); border-color: var(--color-secondary); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 3rem auto 1rem auto; color: var(--color-text-muted); border: 1px dashed var(--color-border); padding: 1rem; border-radius: var(--border-radius); }
        #modal-content .image-placeholder .spinner { border: 4px solid var(--color-border); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-text-muted); margin-bottom: 0.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 2px solid var(--color-border); padding-top: 1.2rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: var(--color-background-alt); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.55; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: var(--color-background); margin-left: auto; text-align: left; font-weight: 700; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); }
        .ai-message { background-color: #30363d; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.3rem; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: var(--color-background-alt); color: var(--color-text); border-radius: var(--border-radius); font-family: 'Roboto Condensed'; font-size: 1rem; letter-spacing: 0.5px; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); background-color: #21262d; }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-secondary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #00bfff; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; color: var(--color-secondary); }

        /* Loading Modal Content (Spinner + Minigame) */
        #modal-loading { text-align: center; padding: 2rem 1rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(28, 33, 40, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 7px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.3s linear infinite; margin-bottom: 1rem; }
        #modal-loading p#loading-text { font-weight: 400; color: var(--color-text); font-size: 1.4rem; font-family: 'Aldrich'; text-shadow: 0 0 6px var(--color-primary); margin-bottom: 1.5rem; } /* Added ID */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Minigame Styles --- */
        #loading-minigame { display: none; /* Hidden by default */ flex-direction: column; align-items: center; margin-top: 1rem; width: 100%; max-width: 400px; padding: 1.5rem; background-color: var(--color-background-alt); border: 1px solid var(--color-border); border-radius: var(--border-radius); }
        #minigame-instructions { font-size: 1rem; color: var(--color-text-muted); margin-bottom: 1.2rem; font-family: 'Roboto Condensed'; text-align: center; }
        #minigame-display { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; }
        .minigame-button { width: 50px; height: 50px; border: 2px solid var(--color-border); border-radius: var(--border-radius); background-color: #30363d; cursor: pointer; transition: all 0.15s ease; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--color-text-muted); }
        .minigame-button:hover:not(.active):not(.error):not(.correct):not(:disabled) { background-color: #40464d; border-color: var(--color-text-muted); } /* Added :not(:disabled) */
        .minigame-button:disabled { opacity: 0.6; cursor: not-allowed; } /* Style for disabled buttons */
        .minigame-button.active { background-color: var(--color-secondary); border-color: var(--color-secondary); box-shadow: 0 0 10px var(--color-secondary); color: var(--color-background); animation: pulse 0.7s infinite alternate; }
        .minigame-button.correct { background-color: #1f7a44; border-color: #2ea043; color: var(--color-tertiary); }
        .minigame-button.error { background-color: var(--color-error-bg); border-color: var(--color-error-border); color: var(--color-error-text); animation: shake 0.5s; }
        #minigame-status { font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; height: 2em; /* Reserve space */ text-align: center; }
        #minigame-status.success { color: #2ea043; } /* Verde éxito */
        #minigame-status.failure { color: var(--color-error-text); }
        #minigame-reset-btn { background-color: var(--color-border); color: var(--color-text-muted); border: none; padding: 0.6rem 1.2rem; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-family: 'Roboto Condensed'; font-size: 0.9rem; margin-top: 0.5rem; text-transform: uppercase; }
        #minigame-reset-btn:hover:not(:disabled) { background-color: #40464d; color: var(--color-text); }
        #minigame-reset-btn:disabled { background-color: #21262d; color: #555; cursor: not-allowed; opacity: 0.7;}
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.08); opacity: 0.85; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        /* --- End Minigame Styles --- */

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.8rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Roboto Condensed'; letter-spacing: 0.5px; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(13, 17, 23, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-secondary); box-shadow: 0 0 30px rgba(0, 170, 255, 0.3); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-background); transform: scale(1.1) rotate(90deg); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-12">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-robot mr-3"></i> <!-- Icono Robot -->
                     MercRob Interstellar
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">// ARCHIVOS DE CORPORACIÓN //</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-14 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-6">Base de Datos de Unidades y Contratos</h1>
             <p class="text-xl text-gray-300 mb-9 max-w-4xl mx-auto font-light">Acceso autorizado a perfiles de unidades mercenarias robóticas, análisis de corporaciones, historial de conflictos e inteligencia de teatros de operaciones interplanetarios.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-12 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar Unidad, Corporación, Planeta...">
             <i class="fas fa-crosshairs fa-search"></i> <!-- Icono mira -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-10 text-center mx-auto">
                 <i class="fas fa-folder-open text-orange-500 mr-2"></i> <!-- Icono carpeta -->
                 ÍNDICE DE DOSSIERS
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">// Estableciendo conexión segura con Archivos Centrales... //</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-6 hidden font-sans">// Negativo. No hay coincidencias para los parámetros de búsqueda. //</p>
             <div id="generate-more-container" class="text-center mt-10">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Solicitar +40 Dossiers
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar Dossier">&times;</button>

             <!-- Loading Indicator Area (Spinner + Minigame) -->
             <div id="modal-loading">
                 <!-- Spinner (optional, can be hidden when game is active) -->
                 <div class="loading-spinner-modal"></div>
                 <p id="loading-text">ACCEDIENDO AL DOSSIER...</p> <!-- Added ID -->

                 <!-- Minigame Container -->
                 <div id="loading-minigame">
                     <p id="minigame-instructions">Descifrando encriptación... Repite la secuencia:</p>
                     <div id="minigame-display">
                         <!-- Buttons will be added here by JS -->
                     </div>
                     <div id="minigame-status"></div>
                     <button id="minigame-reset-btn">REINICIAR PROTOCOLO</button> <!-- Text updated -->
                 </div>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                        <div class="ai-message" style="font-style: italic; color: var(--color-text-muted);">// Canal Táctico Abierto: Realice consultas sobre este dossier. //</div>
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> // Procesando consulta... //
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Consulta táctica...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Visualización Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-black text-gray-600 py-6 mt-16 border-t border-gray-800 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>// Base de datos generada por IA con fines ilustrativos sobre conceptos de ciencia ficción militar. //</p>
              <p class="mt-1">// Las unidades, corporaciones y conflictos descritos son ficticios. //</p>
              <p class="mt-2">// MercRob Interstellar - Secure Archives Division © 2488 //</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [/* Massive list from previous step - Omitted for brevity */
            // Corporaciones Mercenarias
            "Aegis Dynamics Security Solutions", "Titan Heavy Industries (Warfare Division)", "CyberRonin Collective", "Starlight Ventures Mercenary Corps", "Goliath Forge Robotics", "NovaForce Security", "Ronin Mechanized Brigade", "Orion Defense Conglomerate", "Black Iron Sentinels", "Serpentis Corp Tactical", "Crimson Guard Robotics", "Hyperion Vanguard", "Zero Point Security", "Argus Panoptes Solutions", "Wyvern Military Contractors", "Chimera Advanced Systems", "Void Hounds Mercenary Guild", "Apex Predator Robotics", "Iron Wolf Legion", "Cerberus Security Initiative", "Phoenix Battalion Reborn", "Manticore Tactical Group", "Raptor Dynamics", "Gorgon Defense Matrix", "Juggernaut Heavy Assets", "Spectre Operations", "Silver Shield Mercenaries", "Quantum Leap Security", "Dire Wolf Contracts", "Colossus Engineering", "Hoplite Armored Services", "Centurion Robotics", "Valkyrie Aviation & Ground", "Zenith Star Security", "Omega Protocol Inc.",
            // Unidades Roboticas (Infanteria/Asalto)
            "Modelo 'Legionario' (Infantería Estándar)", "Unidad 'Myrmidon' (Asalto Pesado)", "Droide 'Hoplita' (Línea Principal)", "Serie 'Reaper' (Combate Cercano)", "Clase 'Gladiador' (Armamento Variable)", "Bot 'Berserker' (Carga Suicida Controlada)", "Unidad 'Phalanx' (Defensa con Escudo)", "Autómata 'Centurión' (Comando de Escuadra)", "Modelo 'Praetoriano' (Guardia de Élite)", "Droide 'Velite' (Hostigador Ligero)", "Clase 'Secutor' (Anti-Infantería)", "Unidad 'Immortal' (Regenerativa)", "Bot 'Marauder' (Emboscada)", "Autómata 'Vindicator' (Supresión de Fuego)", "Modelo 'Crusader' (Asalto Fortificado)", "Droide 'Punisher' (Armamento Pesado Integrado)", "Clase 'Enforcer' (Control de Disturbios)", "Unidad 'Stalker' (Acechador Sigiloso)", "Bot 'Ravager' (Demolición)", "Autómata 'Warden' (Defensa Estática)",
            // Unidades Roboticas (Pesadas/Soporte)
            "Plataforma 'Behemoth' (Artillería Móvil)", "Mech 'Colossus' (Asalto Superpesado)", "Tanque Drone 'Rhino' (Blindado)", "Unidad 'Goliath' (Transporte Armado)", "Clase 'Atlas' (Soporte Logístico)", "Plataforma 'Juggernaut' (Rompe Líneas)", "Mech 'Ares' (Comando de Batalla)", "Tanque 'Mammoth' (Defensa Principal)", "Unidad 'Hephaestus' (Ingeniería de Combate)", "Clase 'Aegis' (Generador de Escudo Móvil)", "Plataforma 'Cyclops' (Sensor/Observación Avanzada)", "Mech 'Zeus' (Armamento Energético Pesado)", "Tanque 'Scorpion' (Anti-Vehicular)", "Unidad 'Vulcan' (Reparación de Campo)", "Clase 'Chronos' (Guerra Electrónica Pesada)", "Plataforma 'Hydra' (Lanzamisiles Múltiple)", "Mech 'Odin' (Asalto Orbital/Atmosférico)", "Tanque 'Leviathan' (Anfibio/Submarino)", "Unidad 'Prometheus' (Control de Drones)", "Clase 'Argus' (Defensa Puntual Avanzada)",
            // Unidades Roboticas (Especialistas/Drones)
            "Unidad 'Spectre' (Infiltración y Sabotaje)", "Droide 'Chameleon' (Camuflaje Activo)", "Clase 'Nemesis' (Francotirador Robótico)", "Bot 'Viper' (Asesinato Sigiloso)", "Autómata 'Oracle' (Hacker/Inteligencia)", "Unidad 'Asclepius' (Médico de Campo)", "Droide 'Pathfinder' (Reconocimiento Avanzado)", "Clase 'Wraith' (Guerra Psicológica Holográfica)", "Bot 'Gremlin' (Sabotaje Electrónico)", "Autómata 'Technomancer' (Control de Sistemas)", "Enjambre 'Locust' (Drones de Ataque Ligeros)", "Drone 'Harpy' (Reconocimiento Aéreo Rápido)", "Clase 'Siren' (Señuelo/Interferencia)", "Drone 'Observer' (Vigilancia de Largo Alcance)", "Enjambre 'Midas' (Drones de Reparación/Construcción)", "Drone 'Banshee' (Ataque Sónico)", "Clase 'Phantom' (Transporte Sigiloso Personal)", "Drone 'Guardian' (Defensa Personalizada)", "Enjambre 'Scarab' (Drones de Demolición Pequeños)", "Drone 'Arachne' (Trampas/Telarañas Tácticas)",
            // Armamento Robótico Específico
            "Cañón de Plasma 'Obliterator' K-7", "Rifle Gauss 'Rail-Driver' XG-9", "Láser Pesado 'Sunbeam' HLC-5", "Ametralladora Rotatoria 'Hellfire' MG-12", "Lanzamisiles 'Swarm' MRLS-20", "Escopeta de Energía 'Thunderclap' ES-4", "Rifle de Pulso Electromagnético 'Disruptor' EMP-R3", "Cañón Sónico 'Banshee' SC-8", "Cuchilla de Monofilamento 'Zero-Edge'", "Martillo Cinético 'Titan's Fist'", "Lanzagranadas Criogénico 'Frostbite' GL-C6", "Proyector de Partículas 'Void Ray' PB-1", "Sistema de Misiles Inteligentes 'Seeker' S-99", "Cañón Automático 'Devastator' AC-40mm", "Lanzallamas de Plasma 'Inferno' PFT-2", "Espada de Energía 'Ion Sabre'", "Cañón de Iones Pesado 'Ionizer' HC-11", "Rifle de Agujas 'Neuro-Stinger' NR-7", "Mortero Táctico de Plasma 'Meteor' TPM-4", "Sistema de Defensa Puntual 'Guardian' ADS",
            // Sistemas Defensivos y de Soporte
            "Generador de Escudo Personal 'Aegis MK.V'", "Blindaje Reactivo 'Rhino-Hide' Clase 7", "Sistema de Camuflaje Termo-Óptico 'Mirage'", "Interfaz Neuronal Táctica 'Synapse Link'", "Matriz de Auto-Reparación Nanítica 'Rejuvenator'", "Propulsores Gravíticos de Maniobra 'Zephyr'", "Módulo de Guerra Electrónica 'Jammerhead'", "Sistema de Soporte Vital Autónomo 'Life-Pod'", "Unidad de Despliegue Rápido Orbital 'Drop-Claw'", "Bahía de Munición/Energía Expandida 'Deep Pocket'", "Sensor Multi-Espectral Avanzado 'Argus Eye'", "Sistema de Contramedidas 'Flareburst' ECM", "Generador de Campo de Estasis Táctico", "Potenciador de Enlace de Datos de Enjambre", "Módulo de Reparación Remota 'Field Surgeon'", "Sistema de Apoyo de Fuego Orbital 'Skyhammer'", "Baliza de Señuelo Holográfico 'Doppelganger'", "Interfaz de Control de Fuego Predictivo IA", "Amortiguadores de Impacto Cinético 'Absorber'", "Red de Comunicaciones Segura Cuántica 'Nexus'",
            // Conflictos y Teatros Notables
            "La Guerra de Secesión de Cygnus X-1", "El Asedio de Neo-Verdún en Proxima Centauri b", "La Purga de los Cultos Biomecánicos de Kepler-186f", "Operación 'Dust Devil' en las Dunas de Arrakis II", "La Rebelión de las Minas de Titanio en Gliese 581g", "El Conflicto Fronterizo del Cúmulo de Hydra", "La Caída de la Fortaleza Orbital 'Sky-Bastion'", "Incursiones Piratas en el Cinturón de Kuiper Exterior", "Guerra Corporativa por los Yacimientos de Helio-3 de Júpiter", "La Defensa del Arca Estelar 'Genesis' contra los Devoradores", "Operación 'Nightfall' en la Luna Eterna de Xylos", "El Incidente del Agujero de Gusano de Tau Ceti", "La Guerra de los Mil Soles (Sector Gamma)", "Batalla por los Artefactos Precursores en el Sistema Trappist-1", "La Pacificación de los Páramos Tóxicos de Hades Prime", "Escaramuzas en las Ciudades Flotantes de Nimbus IV", "El Bloqueo del Puerto Espacial de Elysium", "La Insurrección de los Sintéticos en Alpha Centauri", "Operación 'Icebreaker' en la Luna Europa", "La Gran Cruzada Robótica (Evento Histórico/Mítico)",
            // Tipos de Contratos y Miscelánea
            "Contrato de Asesinatos de Alto Perfil (HVT)", "Misión de Escolta VIP Interplanetaria", "Operación de Recuperación de Datos/Tecnología", "Defensa de Instalaciones Críticas (Bases/Refinerías)", "Supresión de Fuerzas Insurgentes/Rebeldes", "Misión de Sabotaje Industrial/Militar", "Operación de Interdicción de Rutas Comerciales", "Contrato de Seguridad Corporativa a Largo Plazo", "Exploración Armada de Sectores Peligrosos", "Exterminación de Fauna Xenomorfa Hostil", "Misión de Demolición Estructural", "Captura y Extracción de Personal Clave", "Operación de Bandera Falsa", "Arbitraje Armado de Disputas Planetarias", "Aplicación de Zonas de Exclusión Aérea/Espacial", "El Código Mercenario (Conjunto de reglas no escritas)", "Mercados Negros de Armamento Robótico", "Implantes Cibernéticos para Pilotos de Mechs", "IA Tácticas y sus Peligros", "Consecuencias Legales de Operaciones Mercenarias",
        ];
        const mercThemes = ["corporaciones mercenarias robóticas", "unidades de infantería robótica", "mechas de combate pesados", "drones militares autónomos", "robots especialistas (francotirador, médico, hacker)", "armamento de energía futurista", "cañones de plasma y láser", "railguns y armas gauss", "sistemas de escudo y blindaje robótico", "camuflaje activo y sigilo robótico", "guerra electrónica robótica", "conflictos interplanetarios", "guerras corporativas", "planetas hostiles", "contratos mercenarios (asesinato, escolta, defensa)", "inteligencia artificial militar", "historia de la guerra robótica", "tácticas de combate robótico", "facciones y clientes de mercenarios", "ética mercenaria y robótica", "naves de desembarco robóticas", "logística mercenaria", "mercados negros de tecnología militar", "famosos comandantes mercenarios (IA o cyborg)"];
        const textApiConfig = { model: "mistral", systemPrompt: "Eres 'ARCHON', un Analista de Inteligencia Militar especializado en Fuerzas Mercenarias Robóticas Interplanetarias. Tu tarea es compilar un dossier detallado y objetivo sobre la corporación, unidad, conflicto o tecnología indicada. Incluye: Origen/Historia, Capacidades Operativas (armamento, defensa, movilidad, especialización), Despliegues Notables/Historial de Combate, Debilidades Conocidas/Vulnerabilidades Tácticas, Afiliación/Clientes Comunes, Costo Estimado de Contratación/Adquisición, y una Evaluación de Amenaza/Eficacia general. Usa terminología militar/sci-fi precisa y un tono profesional de informe de inteligencia. Extensión objetivo: 1200-1300 palabras. Dossier sobre:", timeoutSeconds: 150 };
        const chatApiConfig = { model: "mistral-tiny", systemPrompt: "Actúa como 'TAC-AI', un asistente táctico en tiempo real. Tu conocimiento se limita ESTRICTAMENTE al dossier actualmente abierto sobre [TEMA]. Responde preguntas específicas sobre sus características, rendimiento en combate, comparativas básicas (si se mencionan en el dossier), o implicaciones tácticas. Sé conciso, directo y usa jerga militar apropiada. No especules más allá de la información del dossier.", timeoutSeconds: 45 };
        const titleGenerationConfig = { model: "mistral", systemPrompt: "Eres un generador de nombres en clave y designaciones para una base de datos militar de mercenarios robóticos. Genera exactamente 40 nombres únicos y evocadores para corporaciones, unidades robóticas (infantería, pesada, especialista, drone), armas, sistemas, conflictos o planetas relevantes a mercenarios robóticos interplanetarios. Devuelve *solo* la lista de nombres/designaciones, uno por línea. Sin números, guiones, introducciones o comentarios.", timeoutSeconds: 60 };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const loadingText = document.getElementById('loading-text');
        const loadingSpinner = modalLoadingIndicator.querySelector('.loading-spinner-modal');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameContainer = document.getElementById('loading-minigame');
        const minigameInstructions = document.getElementById('minigame-instructions');
        const minigameDisplay = document.getElementById('minigame-display');
        const minigameStatus = document.getElementById('minigame-status');
        const minigameResetBtn = document.getElementById('minigame-reset-btn');

        // ========== State Variables ==========
        let currentMercenaryTopic = null;
        let minigame = { active: false, sequence: [], playerSequence: [], buttons: [], timeoutId: null, listenersAttached: false };
        let apiFetchController = null;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             apiFetchController = new AbortController();
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentMercenaryTopic
                 ? `Actúa como 'TAC-AI', un asistente táctico en tiempo real. Tu conocimiento se limita ESTRICTAMENTE al dossier actualmente abierto sobre '${currentMercenaryTopic}'. Responde preguntas específicas sobre sus características, rendimiento en combate, comparativas básicas (si se mencionan en el dossier), o implicaciones tácticas. Sé conciso, directo y usa jerga militar apropiada. No especules más allá de la información del dossier.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 250)}...`);
             const timeoutId = setTimeout(() => { if (apiFetchController) apiFetchController.abort(); }, config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: apiFetchController.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) { throw new Error(`(Error ${response.status}) // Fallo de conexión con Archivos Centrales. Intente de nuevo en breve. //`); }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) { throw new Error("// La transmisión de datos resultó vacía. Posible corrupción o falta de datos. //"); }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') { throw new Error(`// Tiempo de conexión excedido (>${config.timeoutSeconds}s). Red inestable o servidor sobrecargado. //`); }
                 throw new Error(error.message || "// Error desconocido durante la adquisición de datos. //");
             } finally { apiFetchController = null; }
         }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentMercenaryTopic) throw new Error("// Error de Contexto: Dossier no especificado para consulta táctica. //"); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(mercThemes) || "mercenarios robóticos generales";
             const specificPrompt = `Genera 40 nombres/designaciones únicas para ${randomTheme}`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                  .then(text => {
                      const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 4 && line.length < 100);
                      if (titles.length < 10) throw new Error("// La IA no generó suficientes designaciones nuevas. //");
                      return titles.slice(0, 40);
                  });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 960, height: 640, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "robotic mercenary unit concept art";
             const enhancedPrompt = `Detailed concept art for '${safePromptText}', robotic mercenary in an interplanetary war setting. Gritty sci-fi aesthetic, focus on functional design, visible weaponry or tools, maybe slight battle damage. Dramatic lighting, atmospheric background (alien planet, spaceship interior, battlefield). Avoid text, labels.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, logo, insignia, simple background, clean, pristine, cartoon, anime, illustration, drawing, sketch, low quality, blurry, multiple robots, UI elements";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText) { if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted; }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
             if (apiFetchController) { console.log("Aborting API fetch due to modal close."); apiFetchController.abort(); apiFetchController = null; }
            resetModalState();
        }
        function resetModalState() {
             stopMinigame();
             modalLoadingIndicator.style.display = 'flex';
             loadingSpinner.style.display = 'block';
             loadingText.textContent = 'ACCEDIENDO AL DOSSIER...';
             minigameContainer.style.display = 'none';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '<div class="ai-message" style="font-style: italic; color: var(--color-text-muted);">// Canal Táctico Abierto: Realice consultas sobre este dossier. //</div>';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentMercenaryTopic = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ==========
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender) { const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== MINIGAME FUNCTIONS ==========
        function setupMinigame(difficulty = 4) {
            console.log("Setting up minigame...");
            minigame.active = true;
            minigame.sequence = [];
            minigame.playerSequence = [];
            minigameDisplay.innerHTML = '';
            minigame.buttons = [];
            minigameStatus.textContent = '';
            minigameStatus.className = 'minigame-status';
            minigameInstructions.textContent = "// Autenticación Requerida: Repite la secuencia de activación //";
            minigameResetBtn.disabled = true; // Disable reset initially

            for (let i = 0; i < difficulty; i++) {
                 const button = document.createElement('button');
                 button.className = 'minigame-button';
                 button.dataset.index = i;
                 const icons = ['fa-key', 'fa-terminal', 'fa-lock', 'fa-unlock', 'fa-fingerprint', 'fa-wifi', 'fa-satellite-dish', 'fa-microchip'];
                 button.innerHTML = `<i class="fas ${icons[i % icons.length]}"></i>`;
                 minigameDisplay.appendChild(button);
                 minigame.buttons.push(button);
             }

            for (let i = 0; i < difficulty; i++) {
                minigame.sequence.push(Math.floor(Math.random() * minigame.buttons.length));
            }

            if (!minigame.listenersAttached) {
                 minigameDisplay.addEventListener('click', handleMinigameButtonClick);
                 minigameResetBtn.addEventListener('click', resetMinigame); // Attach listener ONCE
                 minigame.listenersAttached = true;
                 console.log("Minigame listeners attached.");
             }

            disableSequenceButtons(); // Only disable sequence buttons
            setTimeout(() => showSequence(), 1000);
        }

        function showSequence() {
            if (!minigame.active) return;
            let i = 0;
            function showNext() {
                if (!minigame.active) return; // Check again in case stopped during sequence
                // Before starting the next flash, ensure buttons are disabled visually
                disableSequenceButtons();
                minigameResetBtn.disabled = true; // Keep reset disabled during sequence display

                if (i >= minigame.sequence.length) {
                    enableMinigameInput(); // Enable all buttons (sequence + reset) after sequence shown
                    minigameInstructions.textContent = "// Su Turno: Introduzca la secuencia //";
                    return;
                }

                const buttonIndex = minigame.sequence[i];
                if (buttonIndex >= 0 && buttonIndex < minigame.buttons.length) {
                    const button = minigame.buttons[buttonIndex];
                    button.classList.add('active');
                    // Ensure it's visually enabled during flash if needed, though disableSequenceButtons runs before
                    button.disabled = false;

                    minigame.timeoutId = setTimeout(() => {
                        if (button) button.classList.remove('active');
                        i++;
                        // Brief pause before next flash
                        minigame.timeoutId = setTimeout(showNext, 350); // Time between flashes
                    }, 600); // How long flash stays on
                } else {
                    console.error("Invalid button index in sequence:", buttonIndex);
                    // Skip this step or handle error
                    i++;
                    setTimeout(showNext, 50); // Quickly move to next
                }
            }
            showNext();
        }

        function handleMinigameButtonClick(event) {
            const button = event.target.closest('.minigame-button'); // Get button even if icon is clicked
            if (!minigame.active || !button || button.disabled) {
                 return; // Ignore if not active, not a button, or disabled
            }

            const clickedIndex = parseInt(button.dataset.index);
            minigame.playerSequence.push(clickedIndex);

            const currentStep = minigame.playerSequence.length - 1;

            // Check if correct step
            if (minigame.sequence[currentStep] === clickedIndex) {
                button.classList.add('correct');
                setTimeout(() => button.classList.remove('correct'), 300);
                minigameStatus.textContent = '';
                minigameStatus.className = 'minigame-status';

                // Check if sequence complete
                if (minigame.playerSequence.length === minigame.sequence.length) {
                    minigameStatus.textContent = "// Acceso Concedido //";
                    minigameStatus.classList.add('success');
                    disableSequenceButtons(); // Disable sequence buttons
                    minigameResetBtn.disabled = true; // Also disable reset on success (game won)
                }
            } else {
                // Incorrect step
                button.classList.add('error');
                minigameStatus.textContent = "// Secuencia Incorrecta - Acceso Denegado //";
                minigameStatus.classList.add('failure');
                disableSequenceButtons(); // Disable sequence buttons on failure
                minigameResetBtn.disabled = false; // *** KEEP RESET BUTTON ENABLED on failure ***
                setTimeout(() => button.classList.remove('error'), 500); // Remove error style after shake
            }
        }

        // Disables only the sequence buttons
        function disableSequenceButtons() {
            minigame.buttons.forEach(btn => btn.disabled = true);
        }

        // Enables sequence buttons AND the reset button
        function enableMinigameInput() {
            minigame.buttons.forEach(btn => btn.disabled = false);
            minigameResetBtn.disabled = false; // Explicitly enable reset button
            console.log("Minigame Input Enabled (Sequence + Reset)");
        }

        function resetMinigame() {
            console.log("Resetting minigame...");
            if (!minigame.active) {
                console.log("Minigame not active, cannot reset.");
                return; // Don't reset if not active
            }
            if (minigame.timeoutId) {
                clearTimeout(minigame.timeoutId);
                minigame.timeoutId = null;
            }
            minigame.playerSequence = [];
             minigame.buttons.forEach(btn => {
                 btn.className = 'minigame-button';
                 btn.disabled = false; // Make sure they are enabled before setup potentially disables them
             });
            minigameStatus.textContent = '';
            minigameStatus.className = 'minigame-status';
            // Restart the game setup
            setupMinigame(minigame.sequence.length || 4); // Use previous difficulty or default
        }

        function stopMinigame() {
             console.log("Stopping minigame.");
             minigame.active = false;
             if (minigame.timeoutId) {
                 clearTimeout(minigame.timeoutId);
                 minigame.timeoutId = null;
             }
             minigameContainer.style.display = 'none';
             // Ensure buttons are visually reset if game stops abruptly
              minigame.buttons.forEach(btn => {
                  btn.className = 'minigame-button';
                  btn.disabled = true; // Ensure they are disabled when game hides
              });
              minigameResetBtn.disabled = true; // Ensure reset is disabled too
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) {
            const div = document.createElement('div'); div.className = 'title-item'; div.setAttribute('data-title', title);
            let iconClass = 'fa-file-alt'; const lowerTitle = title.toLowerCase();
            if (lowerTitle.includes('corp') || lowerTitle.includes('industries') || lowerTitle.includes('security') || lowerTitle.includes('dynamics') || lowerTitle.includes('solutions') || lowerTitle.includes('guild') || lowerTitle.includes('group') || lowerTitle.includes('inc')) iconClass = 'fa-building';
            else if (lowerTitle.includes('unit') || lowerTitle.includes('model') || lowerTitle.includes('class') || lowerTitle.includes('droid') || lowerTitle.includes('bot') || lowerTitle.includes('mech') || lowerTitle.includes('autómata') || lowerTitle.includes('plataforma') || lowerTitle.includes('serie')) iconClass = 'fa-robot';
            else if (lowerTitle.includes('weapon') || lowerTitle.includes('rifle') || lowerTitle.includes('cannon') || lowerTitle.includes('laser') || lowerTitle.includes('plasma') || lowerTitle.includes('sword') || lowerTitle.includes('saber') || lowerTitle.includes('gauss') || lowerTitle.includes('gun') || lowerTitle.includes('blade') || lowerTitle.includes('hammer') || lowerTitle.includes('launcher') || lowerTitle.includes('beam') || lowerTitle.includes('mortar')) iconClass = 'fa-crosshairs';
            else if (lowerTitle.includes('shield') || lowerTitle.includes('armor') || lowerTitle.includes('defense') || lowerTitle.includes('aegis') || lowerTitle.includes('warden')) iconClass = 'fa-shield-alt';
            else if (lowerTitle.includes('war') || lowerTitle.includes('conflict') || lowerTitle.includes('siege') || lowerTitle.includes('battle') || lowerTitle.includes('purge') || lowerTitle.includes('rebellion') || lowerTitle.includes('incident') || lowerTitle.includes('operation') || lowerTitle.includes('incursion')) iconClass = 'fa-skull-crossbones';
            else if (lowerTitle.includes('planet') || lowerTitle.includes('system') || lowerTitle.includes('sector') || lowerTitle.includes('moon') || lowerTitle.includes('star') || lowerTitle.includes('cluster') || lowerTitle.includes('belt') || lowerTitle.includes('centauri') || lowerTitle.includes('kepler') || lowerTitle.includes('gliese') || lowerTitle.includes('tau ceti') || lowerTitle.includes('trappist')) iconClass = 'fa-globe-americas';
            else if (lowerTitle.includes('drone') || lowerTitle.includes('swarm') || lowerTitle.includes('enjambre')) iconClass = 'fa-paper-plane';
            else if (lowerTitle.includes('contract') || lowerTitle.includes('mission') || lowerTitle.includes('escort') || lowerTitle.includes('retrieval') || lowerTitle.includes('suppression') || lowerTitle.includes('sabotage') || lowerTitle.includes('interdiction')) iconClass = 'fa-file-contract';
            div.innerHTML = `<i class="fas ${iconClass}"></i><span>${title}</span>`;
            div.addEventListener('click', () => handleTitleClick(title)); return div;
        }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">// No hay dossiers disponibles en este sector. //</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        async function handleTitleClick(title) {
            resetModalState(); showModal(); modalTitle.textContent = title; currentMercenaryTopic = title; modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; loadingSpinner.style.display = 'none'; minigameContainer.style.display = 'flex'; loadingText.textContent = '// Iniciando Desencriptación... //';

            setupMinigame(); // Start game

            let explanationData = null; let fetchError = null;
            try { explanationData = await fetchExplanationText(title); }
            catch (error) { console.error("Failed display:", error); fetchError = error; }

            stopMinigame(); // Stop game after fetch attempt
            loadingSpinner.style.display = 'block'; loadingText.textContent = 'CARGANDO DATOS...'; minigameContainer.style.display = 'none';

            await new Promise(resolve => setTimeout(resolve, 300)); // Smooth transition

            modalLoadingIndicator.style.display = 'none';

            if (fetchError) {
                modalErrorMessage.textContent = fetchError.message || "// Error desconocido al cargar dossier. //";
                modalError.classList.remove('content-hidden'); modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = ''; chatSection.style.display = 'none';
            } else if (explanationData) {
                const formattedExplanation = formatExplanationText(explanationData);
                modalContent.innerHTML = formattedExplanation; modalStoryContentArea.classList.remove('content-hidden');
                chatSection.style.display = 'flex'; modalTextArea.scrollTop = 0; console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div'); placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.9em; margin-top: 0.5rem;">// Procesando Visualización Táctica... //</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img'); imgElement.className = 'final-image'; imgElement.alt = `Visualización táctica de ${title}`; imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.9em;margin-top:0.5rem;">// Fallo en la Visualización. //</p>`; };
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.9em;margin-top:0.5rem;">// Error de Enlace Visual. //</p>`; }
            } else {
                 modalErrorMessage.textContent = "// Error inesperado: No se recibieron datos ni error. //";
                 modalError.classList.remove('content-hidden'); modalStoryContentArea.classList.remove('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Solicitando Archivos...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("// No se pudieron recuperar más dossiers en este momento. Archivos pueden estar corruptos o inaccesibles. //"); }
             } catch (error) { console.error("Failed title generation:", error); alert(`// Error al solicitar dossiers: ${error.message} //`); }
             finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Solicitar +40 Dossiers'; }
         }

        function filterTitles(searchTerm) { const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); const titleItems = titleListContainer.querySelectorAll('.title-item'); let visibleCount = 0; titleItems.forEach(item => { const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const isVisible = titleText.includes(term); item.classList.toggle('hidden', !isVisible); if (isVisible) visibleCount++; }); noResultsMsg.classList.toggle('hidden', visibleCount > 0); }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameContainer || !minigameResetBtn) { // Added minigameResetBtn check
                console.error("Initialization failed: Missing essential UI components.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">++ CRITICAL FAILURE: Interfaz de Usuario Corrupta. Imposible Cargar Base de Datos. ++</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            // Minigame listeners are attached in setupMinigame

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>