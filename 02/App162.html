<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Compendium - Mundos Imaginarios</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Sci-Fi / Cósmicas -->
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Mundos Imaginarios --- */
        :root {
            --color-primary: #60a5fa; /* Azul Cielo Claro */
            --color-secondary: #f472b6; /* Rosa Nebulosa */
            --color-tertiary: #facc15; /* Amarillo Estrella/Oro */
            --color-background: #050a1a; /* Azul Muy Muy Oscuro (Espacio Profundo) */
            --color-text: #e5e7eb; /* Gris Muy Claro / Blanco Hueso */
            --color-text-muted: #9ca3af; /* Gris Medio */
            --color-modal-bg: #111827; /* Azul/Gris Oscuro */
            --color-border: #374151; /* Borde Gris Azulado */
            --color-error-bg: #2b101d; /* Fondo error púrpura oscuro */
            --color-error-text: #fbcfe8; /* Texto error rosa claro */
            --color-error-border: #e11d48; /* Borde error fucsia */

            --shadow-sm: 0 1px 2px 0 rgba(96, 165, 250, 0.15);
            --shadow-md: 0 4px 6px -1px rgba(96, 165, 250, 0.2), 0 2px 4px -2px rgba(96, 165, 250, 0.15);
            --shadow-lg: 0 0 25px -5px rgba(96, 165, 250, 0.3), 0 8px 10px -6px rgba(96, 165, 250, 0.2);
            --border-radius: 4px; /* Bordes ligeramente más suaves */
            --transition-normal: all 0.25s ease-in-out;

            /* Fondo sutil de estrellas (opcional) */
            /* body::before {
                content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle fill="%23374151" cx="10" cy="10" r="0.5"/><circle fill="%23374151" cx="30" cy="40" r="0.3"/><circle fill="%23374151" cx="70" cy="20" r="0.6"/><circle fill="%23374151" cx="90" cy="60" r="0.4"/><circle fill="%23374151" cx="50" cy="80" r="0.5"/></svg>');
                background-repeat: repeat; opacity: 0.1; z-index: -1;
            } */
        }
        body { font-family: 'Exo 2', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Audiowide', cursive; font-weight: 400; letter-spacing: 1.5px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px rgba(96, 165, 250, 0.7); }
        h1.page-title { color: var(--color-primary); font-weight: 400; text-shadow: 0 0 8px rgba(96, 165, 250, 0.6); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 400; }
        #modal-title { color: var(--color-primary); font-weight: 400; text-shadow: 0 0 5px rgba(96, 165, 250, 0.5); }
        .navbar { background-color: rgba(5, 10, 26, 0.85); backdrop-filter: blur(8px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(17, 24, 39, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Exo 2'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3); outline: none; background-color: #111827; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Exo 2'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-secondary); background-color: #1f2937; border-left-color: var(--color-secondary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: var(--color-background); padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Audiowide', cursive; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: none; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(5, 10, 26, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: var(--color-background); transform: rotate(-180deg) scale(1.1); box-shadow: 0 0 10px var(--color-secondary); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(55, 65, 81, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(55, 65, 81, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Audiowide', cursive; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: 0 0 15px rgba(96, 165, 250, 0.3); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 25px rgba(96, 165, 250, 0.5); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(55, 65, 81, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.8rem; color: var(--color-primary); opacity: 0.7; }

        /* Chat Section */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(5, 10, 26, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(55, 65, 81, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(55, 65, 81, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--color-tertiary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #374151; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #1f2937; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Exo 2'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #3b82f6; } /* Azul más oscuro */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading y Error */
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(5, 10, 26, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.4rem; font-family: 'Audiowide'; text-shadow: 0 0 8px var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Exo 2'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(5, 10, 26, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-globe-americas mr-3 transform -rotate-12"></i> <!-- Icono planeta -->
                     Cosmic Compendium
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Explorador de Mundos Imaginarios «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Descubre Universos Desconocidos</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Navega por la base de datos galáctica. Analiza planetas ficticios: desde mundos terraformados hasta anomalías cósmicas.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar planeta o sistema estelar...">
             <i class="fas fa-satellite-dish fa-search"></i> <!-- Icono antena/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-star text-yellow-400 mr-2"></i> <!-- Icono estrella -->
                 Registros Estelares
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Accediendo a los archivos de la Flota Estelar...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún registro coincide con los parámetros de búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Nuevos Sectores
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Estableciendo Enlace...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <h3 class="text-lg font-semibold mb-2 text-center text-gray-400 font-sans flex-shrink-0 border-b border-gray-700 pb-1">Consulta a la Base de Datos</h3>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este mundo...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Datos generados por IA para la simulación de exploración galáctica.</p>
              <p class="mt-1">Los mundos descritos son ficticios y creados con fines de entretenimiento e inspiración.</p>
              <p class="mt-2">© 2458 Archivos de la Federación Unida de Planetas</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
             // Tierras y Super-Tierras
             "Aethelgard Prime", "Nova Terra", "Veridian VI", "Gaia Secundus", "Tellus Major", "Eden VII", "Sanctuary", "Havenworld", "Viridis Prime", "Arboria", "Genesis II", "Promised Land IV", "Midgard Station", "Kobol", "Caprica", "Terra Nova Alpha", "Kepler-186f Analogue", "Gliese 581g Simulant", "Earth II", "New Canaan",
             // Mundos Desérticos
             "Arrakis", "Tatooine Prime", "Jakku Minor", "Kharak", "Geonosis Replica", "Osiris IV", "Amonkhet", "Helios III (Scorched)", "Dustbowl V", "Sandtrap VII", "The Crimson Waste", "Barren Hope", "Cinder Rift", "Mirage", "Shifting Sands", "Dune World Alpha", "Ignis Deserta", "Solitude", "Endless Dunes", "Broken Land",
             // Mundos Selváticos / Boscosos
             "Endor Moon", "Kashyyyk", "Yavin IV", "Felucia", "Dagobah System", "Catachan Prime", "Viridian Maze", "Emerald Deep", "Canopy", "Rootworld", "Fungal Sprawl", "Bio-Lumin", "Whispering Woods", "Primal Heart", "Verdant Chain", "Jungle Spire", "Overgrowth", "Symbiotic Sphere", "Living Labyrinth", "Chloros V",
             // Mundos Helados / Criogénicos
             "Hoth", "Rhen Var", "Ilum", "Tau Volantis Simulant", "Glacius IV", "Icebound", "Frostfell", "Winter's Kiss", "Permafrost Prime", "Snowdrift", "Cryo-Core", "The Frozen Heart", "Avalanche", "Hoarfrost Reach", "Shiverwind", "Subzero", "Glacial Drift", "Rimeworld", "Cold Snap", "Absolute Zero",
             // Mundos Volcánicos / Ígneos
             "Mustafar", "Sullust", "Pyralia", "Char", "Nokturne", "Inferno VII", "Magmar", "Cinderfall", "Forge World Alpha", "Lavaflow", "Ashen Crown", "Molten Core", "Obsidian Plains", "Searing Chain", "Vulcanis Rex", "Hellscape", "The Great Caldera", "Sootheim", "Ember", "Igneous Prime",
             // Mundos Acuáticos / Oceánicos
             "Kamino", "Manaan", "Mon Cala", "Aquatica Secundus", "Oceanus XI", "Water's Edge", "Deep Blue", "Marinus Prime", "Hydrosphere", "Abyssal Realm", "Coral Maze", "Tidal Lock", "Endless Sea", "Aqua Sigma", "Neptunia", "Poseidon's Realm", "Hydro-Core", "The Great Swell", "Liquid Sky", "Pelagic Drift",
             // Gigantes Gaseosos y Variantes
             "Bespin", "Yavin Prime", "Jupiter Analogue", "Saturnia Gloriosa", "Helios Beta (Hot Jupiter)", "Maelstrom IX", "Neptune's Fury", "Stormwall", "Cloud City Prime", "Gas Giant Delta", "Ringed Wonder", "Ammonia Skies", "Metallic Hydrogen Core", "Brown Dwarf Companion", "Sub-Giant Kappa", "Azure Sphere", "Crimson Band", "Emerald Haze", "The Great Eye", "Whispering Winds",
             // Mundos Cristalinos / Minerales
             "Crystallis Omega", "Mineralis IV", "Geode Prime", "The Shardlands", "Quartz Vein", "Diamond Core", "Gemstone Cluster", "Crystal Spire", "Silicate Realm", "Prismatica", "Facet", "Mineral Maze", "Ore Belt World", "Crystalline Matrix", "Resonant Peaks", "Vitreus", "Adamantine Heart", "Jewel of the Void", "Crystal Forest", "Geode Hollow",
             // Mundos Artificiales / Constructos
             "Cybertron", "The Borg Collective Sphere", "Dyson Sphere Fragment", "Ringworld Segment", "Stanford Torus Habitat", "O'Neill Cylinder Colony", "The Great Mechanism", "Forge Star", "Ark Ship Remnant", "Habitat Ring Omega", "Machine World Prime", "Network Hub VII", "Clockwork Planet", "Automated Core", "Construct Alpha", "Orbital Frame", "Synth-World", "The Grid", "Data Haven", "Core Command",
             // Mundos Exóticos / Anómalos
             "Phasia (Dimensional Shift)", "Lux Aeterna (Energy)", "Yggdrasil Minor (Living Planet)", "Pandora (Avatar)", "Xen", "Ego the Living Planet Simulant", "Chaos Realm Shard", "Void Touched", "Temporal Anomaly Zone", "Gravity Well Prime", "Sentient Ocean Solaris", "Fungal Network Mind", "Bio-Mechanical Hybrid", "Pocket Dimension Access", "Thought Sphere", "Echo World", "Impossible Geometry", "Warp Infested", "Dreamscape", "Null Zone",
             // Lunas Habitables o Notables
             "Pandora (Moon of Polyphemus)", "Yavin 4 (Moon of Yavin)", "Endor Sanctuary Moon", "Titan Analogue (Hydrocarbon Lakes)", "Europa Secundus (Subsurface Ocean)", "Io Prime (Volcanic Moon)", "Triton Simulant (Cryovolcanic)", "Luna Terraformed", "Shepherd Moon Alpha (Ring Maintainer)", "Captured Asteroid Base", "Garden Moonlet", "Observation Post Luna", "Mining Moon Zeta", "Refugee Moon Delta", "Binary Moon System", "Tidal Locked Moon", "Resort Moon Paradise", "Training Ground Moon", "Library Moon Archive", "Smuggler's Moon",
             // Planetas con Características Únicas
             "Xylos Binary (Binary Suns)", "Tilted Axis VII (Extreme Seasons)", "The Ringed Desert (Desert with Rings)", "Echoing Chasm Planet (Vast Canyons)", "Sentinels' Graveyard (Ancient Ruins)", "Floating Islands of Aethel", "Sky River World", "Hollow World Interior", "Magnetic Pole Anomaly", "Radioactive Jungle", "Silicon Based Life World", "Planet-Wide Storm System", "Asteroid Impact Remnant", "Tidally Locked Duo (Planet-Moon)", "Rogue Planet Drifting", "Artificial Sun World", "Nebula Core Planet", "Geothermal Vent Ecosystem", "Singing Crystal Caves", "Telepathic Flora World",
             // Nombres Genéricos / Clasificatorios (para llenar)
             "Terrestrial Planet Candidate 7", "Gas Giant Prospect Sigma", "Ice World Anomaly K-19", "Volcanic Moonlet Epsilon", "Desert Planet XR-3", "Jungle World Biosphere Project", "Ocean Planet Survey Zone", "Exotic Matter Candidate Alpha", "Artificial Construct Designation 774", "Habitable Moon Beta-Gamma System", "Super-Earth Prospect T-800", "Chthonian Planet Remnant Zeta", "Carbon Planet Candidate", "Iron Planet Core Sample 9", "Helium-3 Rich Gas Giant", "Water World Delta Quadrant", "Silicon Desert Gamma", "Ammonia World Prospect", "Methane Lake Moonlet", "Irradiated Terra Prime",
             // Más Variaciones
             "New Alexandria", "Port Royal V", "Acheron LV-426", "Reach Analogue", "Harvest Minor", "Trantor Secundus", "Terminus Est", "Hyperion Cantos World", "Aria T'Loak Prime", "Citadel Station World", "Omega Nebula Outpost", "Heleus Cluster Anomaly", "Andromeda Initiative Target", "Prothean Ruin World", "Collector Base Remnant", "Geth Consensus Hub", "Quarian Migrant Fleet Anchorage", "Krogan Homeworld Simulant", "Asari Republic Capital", "Turian Hierarchy Outpost", "Salarian Union Research World", "Batarian Hegemony Fringe", "Volus Protectorate Trade Hub", "Elcor Diplomatic Center", "Hanar Illuminated Primacy", "Drell Training Grounds", "Vorcha Scavenger World", "Yahg Containment Zone", "Leviathan Enclave", "Rachni Nestworld", "Zerg Overmind Core", "Protoss Aiur Analogue", "Tyranid Hive Fleet Target", "Necron Tomb World Proxy", "Ork WAAAGH! World", "Aeldari Craftworld Remnant", "Drukhari Commorragh Shard", "T'au Sept World", "Imperium Agri-World", "Imperium Forge World", "Imperium Hive World", "Imperium Shrine World", "Imperium Death World", "Chaos Daemon World", "Cadia Stand-In", "Macragge Simulant", "Fenrisian Ice World", "Nocturne's Embrace", "Baal Secundus", "Medusa V Campaign Zone", "Armageddon Prime", "Vraksian Citadel", "Tanith First-and-Only Memorial", "Gorkamorka Scrap World",
             // Combinaciones Adicionales
             "Aqua-Ignis Paradox", "Ferro-Gelida Contradiction", "Silica-Veridian Symbiosis", "Cryo-Volcanic Moonlet", "Desert-Ocean Binary", "Jungle-Ice Cap World", "Techno-Organic Sphere", "Crystal-Gas Hybrid", "Living Metal Planetoid", "Sentient Storm Giant", "Bio-Luminescent Ocean World", "Floating Crystal Forests", "Subterranean Jungle Network", "Sky-Island Archipelago", "Planetoid Chain System", "Ruined Ringworld Habitat", "Dyson Swarm Core", "Matrioshka Brain Candidate", "Shifting Labyrinth Planet", "Temporal Echo Chamber", "Gravity Wave Nexus", "Void Kraken Nest", "Starlight Forge", "Nebula Nursery World", "Dark Energy Reservoir", "Exotic Particle Fountain", "Cosmic String Anchor", "Interdimensional Rift Zone", "Ancient Ones Prison", "Celestial Orrery Core", "Star Eater Remnant", "Genesis Device Target", "Reality Buffer Zone", "Thoughtform Manifestation Zone", "Akashic Record Library", "World Turtle Back", "Elemental Plane Access", "Hyperspace Beacon Prime", "Quantum Foam Stabilizer", "Zero-Point Energy Vent", "Möbius Strip World", "Klein Bottle Habitat", "Tesseract Vault", "Conceptual Space Anchor", "Narrativium Core World", "Pattern Screamer Echo", "Meme Virus Origin"
        ];
        const imaginaryPlanetThemes = [
            "planetas terrestres", "super-tierras habitables", "mundos desérticos", "planetas selváticos", "mundos helados", "planetas volcánicos", "mundos oceánicos", "gigantes gaseosos", "planetas con anillos", "hot jupiters", "mundos tormentosos", "planetas cristalinos", "mundos artificiales", "constructos estelares", "planetas vivientes", "mundos energéticos", "planetas dimensionales", "lunas habitables", "lunas volcánicas", "lunas con océano subsuperficial", "planetas en sistemas binarios", "planetas con ruinas antiguas", "mundos con vida exótica", "planetas con características geológicas únicas", "planetas rebeldes (rogue planets)", "mundos terraformados", "planetas post-apocalípticos", "planetas biblioteca", "mundos prisión", "planetas fortaleza"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un xenógrafo y astro-cartógrafo experto de la Flota Estelar, compilando la base de datos galáctica 'Cosmic Compendium'. Describe el planeta ficticio proporcionado con gran detalle, precisión científica (dentro de la ficción) y un toque narrativo. Incluye: Nombre y Designación, Sistema Estelar (nombre, tipo de estrella/s, posición), Clasificación Planetaria (ej. Super-Tierra, Mini-Neptuno, Mundo Anillo), Datos Orbitales y Físicos (periodo, tamaño, gravedad, atmósfera, temperatura), Geografía/Astrográfica (continentes, océanos, características únicas como cañones inmensos, bosques cristalinos, tormentas perpetuas, anillos complejos), Biosfera (si existe: ecosistemas dominantes, formas de vida notables, nivel de inteligencia si aplica), Recursos Principales, Peligros Conocidos (ambientales, biológicos), y una 'Entrada del Diario del Capitán' o 'Fragmento de Lore' que añada intriga o contexto histórico/cultural. Apunta a 1200-1300 palabras. Basa tu informe exclusivamente en el siguiente registro planetario:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúa como la interfaz IA de la base de datos 'Cosmic Compendium', especializada únicamente en el planeta '{currentPlanetName}'. Responde preguntas de seguimiento sobre sus características específicas (geografía, atmósfera, vida, etc.), datos técnicos, o detalles mencionados en el registro principal. Sé precisa, concisa y mantente estrictamente dentro del contexto de {currentPlanetName}.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Genera exactamente 15 nombres evocadores y únicos para planetas ficticios destinados a una base de datos galáctica. Busca diversidad en tipos (terrestre, gaseoso, exótico, luna, artificial) y conceptos (ej. Veridian VI, Crystallis Omega, Maelstrom IX, Habitat Ring Delta). Devuelve *solo* la lista de nombres, uno por línea. Sin números, guiones, introducciones ni conclusiones.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales, solo IDs si se renombraron)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentPlanetName = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentPlanetName
                 ? `Actúa como la interfaz IA de la base de datos 'Cosmic Compendium', especializada únicamente en el planeta '${currentPlanetName}'. Responde preguntas de seguimiento sobre sus características específicas (geografía, atmósfera, vida, etc.), datos técnicos, o detalles mencionados en el registro principal. Sé precisa, concisa y mantente estrictamente dentro del contexto de ${currentPlanetName}.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     // *** MENSAJE DE ERROR AMIGABLE TEMÁTICO ***
                     throw new Error(`(Error ${response.status}) Señal Perdida: Detectada fuerte interferencia cósmica o sobrecarga del servidor. Por favor, intente establecer enlace de nuevo en unos momentos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("Transmisión Recibida Vacía: La IA no devolvió datos. Intente reformular la consulta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`Conexión Expirada (>${config.timeoutSeconds}s): Imposible mantener el enlace subespacial. Revise su conexión o intente más tarde.`);
                 }
                 throw new Error(error.message || "Anomalía Desconocida: Ocurrió un error inesperado al contactar la base de datos central.");
             }
        }
        async function fetchExplanationText(planetName) { return fetchTextFromApi(planetName, textApiConfig, false); }
        async function fetchChatResponse(userQuery) {
            if (!currentPlanetName) throw new Error("Error de Contexto: No se ha especificado el registro planetario para la consulta.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(imaginaryPlanetThemes) || "planetas ficticios variados";
            const specificPrompt = `Genera 15 nombres/designaciones únicas de planetas o lunas basados en el concepto: ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 100); // Ajustar longitud si es necesario
                     if (titles.length < 5) throw new Error("La IA no pudo generar suficientes designaciones nuevas.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 1024, height: 576, nologo: true }; // Aspecto más panorámico
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "distant alien planet landscape";
             const enhancedPrompt = `Digital painting of the alien planet '${safePromptText}'. Focus on atmosphere, unique geological features (e.g., crystal spires, lava rivers, massive rings, strange clouds, floating islands, bioluminescent flora), alien landscape. Cinematic view from low orbit or surface. Evocative lighting. Style: cosmic sci-fi art.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, Earth-like features, simple background, cartoon, drawing, sketch, human figures, spaceship unless part of concept";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (identical to previous version) ... */
             if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL, FULLSCREEN, CHAT FUNCTIONS ==========
        // (Estas funciones son estructuralmente idénticas a la versión anterior:
        // showModal, hideModal, resetModalState,
        // showFullscreenImage, hideFullscreenImage,
        // addChatMessage, addChatError, handleSendMessage)
        // Solo asegúrate de que `resetModalState` limpia `currentPlanetName`.
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
         function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentPlanetName = null; // <<< Limpiar contexto
             hideFullscreenImage(); // <<< Asegurar que se cierra
         }
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }
        function addChatMessage(message, sender) { /* ... (identical) ... */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        function addChatError(message) { /* ... (identical) ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        async function handleSendMessage() { /* ... (identical logic, uses fetchChatResponse) ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error Base Datos: ${error.message}`); // Error temático
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
         }


        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar alfabéticamente para navegación consistente
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» No hay registros estelares disponibles en este sector «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-aplicar filtro
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentPlanetName = title; // <<< SET CHAT CONTEXT
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Placeholder de imagen
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-meteor placeholder-icon"></i> <!-- Icono temático -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando Escaneo Visual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Elemento imagen
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-user-secret placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Escaneo Visual Fallido.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-ban placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL Visual.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Fallo Crítico al Cargar Datos Planetarios.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Escaneando Sectores Adyacentes...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se detectaron nuevos registros planetarios en este escaneo."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error de Escaneo: ${error.message}`); // Error temático
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Nuevos Sectores';
             }
         }

         // *** Search Filter Function (con normalización para tildes) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check essential elements exist
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: #f87171; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: monospace;">*** ALERTA: Fallo en la Inicialización del Sistema de Navegación - Componentes Faltantes ***</p>';
                 return;
             }
             // Add Listeners
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Initial Load
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>