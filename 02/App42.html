<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ciencia Sencilla - Conceptos de Biología</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos (sin cambios respecto a la versión anterior) --- */
        :root {
            --color-primary: #2563eb; --color-secondary: #10b981; --color-background: #f9fafb;
            --color-text: #1f2937; --color-text-muted: #6b7280; --color-modal-bg: #ffffff;
            --color-border: #e5e7eb; --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px; --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); }
        h1, h2, h3, .logo { font-family: 'Quicksand', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1d4ed8; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.75); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem; max-width: 850px; width: 95%; max-height: 90vh; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e5e7eb; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.4rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #d1d5db; color: var(--color-text); }
        #modal-title { color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; }
        #modal-content { line-height: 1.7; color: var(--color-text); white-space: normal; /* Changed from pre-wrap for <p> tags */ overflow-y: auto; margin-bottom: 1.5rem; padding: 0 10px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content::-webkit-scrollbar { width: 8px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.2em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; } /* Ensure strong is bold */
        #modal-content em { color: var(--color-secondary); font-style: italic; } /* Ensure em is italic */
        #modal-content h3, #modal-content h4 { font-family: 'Quicksand', sans-serif; font-size: 1.2em; margin-top: 1.5em; margin-bottom: 0.6em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.2em;}
        #modal-image-container { width: 100%; height: 220px; background-color: #f3f4f6; border-radius: var(--border-radius); overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 2.5rem; color: var(--color-border); display: none; }
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: var(--border-radius); border: 1px solid #fecaca; margin-top: 1rem; text-align: center; flex-shrink: 0; }
        .error-msg i { margin-right: 0.5rem; }
        .content-hidden { display: none; }

    </style>
</head>
<body>
    <!-- Header/Navbar -->
    <nav class="navbar mb-8">
        <div class="container mx-auto px-4 py-3 flex justify-center items-center">
            <div class="flex items-center">
                <h1 class="logo text-2xl sm:text-3xl">
                    <i class="fas fa-dna mr-2"></i> Ciencia Sencilla: Biología
                </h1>
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <main class="container mx-auto px-4 pb-16">
        <!-- Hero section -->
        <section class="mb-12 text-center">
            <h1 class="page-title text-4xl sm:text-5xl mb-4">Descubre los Secretos de la Vida</h1>
            <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Explora conceptos de biología explicados de forma clara y sencilla por nuestra IA. ¡Haz clic en un tema!</p>
        </section>

        <!-- Title List Container -->
        <section class="mb-10">
            <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                <i class="fas fa-flask text-green-500 mr-2"></i>
                Conceptos a Explorar
            </h2>
            <div id="title-list">
                 <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Cargando conceptos...</p>
            </div>
            <div id="generate-more-container" class="text-center mt-8">
                <button id="generate-more-btn">
                     <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                    Generar Más Conceptos
                 </button>
            </div>
        </section>

    </main>

    <!-- Story Modal -->
    <div id="story-modal">
        <div class="modal-content-wrapper">
            <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

            <!-- Loading Indicator -->
            <div id="modal-loading">
                <div class="loading-spinner-modal"></div>
                <p>Generando explicación...</p>
            </div>

            <!-- Content Area -->
            <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                <!-- Text Content (Scrollable) -->
                <div id="modal-content" class="text-base md:text-lg">
                    <!-- Explanation text will be placed here using innerHTML -->
                </div>
                 <!-- Image Container (Fixed height, at bottom) -->
                <div id="modal-image-container">
                    <div class="spinner"></div>
                    <i class="fas fa-atom placeholder-icon"></i> <!-- Placeholder icon -->
                    <img id="modal-image" alt="Ilustración del concepto" />
                </div>
                 <!-- Error Display Area -->
                <div id="modal-error" class="error-msg content-hidden">
                     <i class="fas fa-exclamation-circle"></i> <!-- Changed icon -->
                     <span id="modal-error-message"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-100 text-gray-600 py-5 mt-12 border-t border-gray-200">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>Explicaciones generadas por IA con fines educativos. Siempre consulta fuentes expertas para información crítica.</p>
            <p class="mt-1">© 2025 Ciencia Sencilla</p>
        </div>
    </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [ /* --- Lista de títulos de biología (igual que antes, >150) --- */
            "¿Qué es una Célula?", "Células Procariotas vs. Eucariotas", "La Membrana Celular: El Guardián", "El Núcleo: Centro de Control Celular", "Mitocondrias: Las Centrales Energéticas", "Cloroplastos y Fotosíntesis", "Ribosomas: Fábricas de Proteínas", "Retículo Endoplasmático: Red de Transporte", "Aparato de Golgi: Empaquetador Celular", "Lisosomas: Reciclaje Celular", "El Citoesqueleto: Soporte y Movimiento", "La Pared Celular en Plantas y Bacterias", "¿Qué es el ADN?", "La Estructura de Doble Hélice del ADN", "Genes: Unidades de Herencia", "Cromosomas: Empaquetando el ADN", "Replicación del ADN: Haciendo Copias", "Transcripción: Del ADN al ARN", "Traducción: Del ARN a la Proteína", "Mutaciones Genéticas y sus Tipos", "¿Qué es el ARN?", "Tipos de ARN (ARNm, ARNt, ARNr)", "El Código Genético Universal", "Ingeniería Genética Básica", "¿Qué es la Evolución?", "La Selección Natural de Darwin", "Adaptación al Medio Ambiente", "Evidencias de la Evolución (Fósiles, Anatomía)", "Especiación: Creando Nuevas Especies", "Árboles Filogenéticos: Relaciones Evolutivas", "Evolución Humana Simplificada", "La Deriva Genética y sus Efectos", "El Flujo Génico entre Poblaciones", "La Teoría Sintética de la Evolución", "La Fotosíntesis: Luz a Energía Química", "Reactivos y Productos de la Fotosíntesis", "La Importancia de la Fotosíntesis para la Vida", "Respiración Celular: Liberando Energía", "Respiración Aeróbica vs. Anaeróbica", "El Ciclo de Krebs Simplificado", "La Cadena de Transporte de Electrones", "ATP: La Moneda Energética Celular", "Fermentación Láctica y Alcohólica", "¿Qué es un Ecosistema?", "Factores Bióticos y Abióticos", "Cadenas y Redes Tróficas", "Productores, Consumidores y Descomponedores", "Niveles Tróficos y Flujo de Energía", "Ciclos Biogeoquímicos (Carbono, Agua, Nitrógeno)", "Sucesión Ecológica: Cambios en el Ecosistema", "Tipos de Biomas Terrestres", "Tipos de Ecosistemas Acuáticos", "Relaciones Interespecíficas (Mutualismo, Comensalismo, Parasitismo)", "Competencia por Recursos", "Depredación y Estrategias de Defensa", "Biodiversidad: La Variedad de la Vida", "Amenazas a la Biodiversidad", "Conservación de Especies y Ecosistemas", "Clasificación de los Seres Vivos", "Los Cinco Reinos (o Dominios)", "Características de las Bacterias (Monera)", "Características de los Protoctistas", "Características de los Hongos", "Características de las Plantas", "Características de los Animales", "Virus: ¿Vivos o No Vivos?", "El Sistema Nervioso Humano: Comunicación Rápida", "Neuronas: Las Células del Cerebro", "El Cerebro y sus Partes Principales", "Sistema Nervioso Central vs. Periférico", "Los Sentidos: Vista, Oído, Olfato, Gusto, Tacto", "El Sistema Endocrino: Hormonas", "Glándulas Principales (Tiroides, Páncreas, Suprarrenales)", "La Función de la Insulina y el Glucagón", "Hormonas del Estrés (Adrenalina, Cortisol)", "El Sistema Circulatorio: Transporte Sanguíneo", "El Corazón: La Bomba Muscular", "Arterias, Venas y Capilares", "Componentes de la Sangre (Glóbulos Rojos/Blancos, Plaquetas)", "Grupos Sanguíneos Básicos (ABO)", "El Sistema Respiratorio: Intercambio de Gases", "Pulmones: Órganos de la Respiración", "Inhalación y Exhalación", "Transporte de Oxígeno en la Sangre", "El Sistema Digestivo: Procesando Alimentos", "Boca, Esófago y Estómago", "Intestino Delgado y Absorción de Nutrientes", "Intestino Grueso y Eliminación", "Hígado y Páncreas en la Digestión", "Enzimas Digestivas: Ayudantes Químicos", "El Sistema Excretor: Limpieza Corporal", "Riñones: Filtros de la Sangre", "Formación de la Orina", "El Sistema Inmunológico: Defensa del Cuerpo", "Inmunidad Innata vs. Adaptativa", "Anticuerpos y Antígenos", "Vacunas: Preparando las Defensas", "Alergias y Enfermedades Autoinmunes", "El Sistema Musculoesquelético: Soporte y Movimiento", "Huesos y Esqueleto", "Articulaciones: Conexiones Óseas", "Músculos Esqueléticos, Lisos y Cardíacos", "Contracción Muscular Simplificada", "Reproducción Asexual vs. Sexual", "Mitosis: División Celular para Crecer", "Meiosis: División Celular para la Reproducción", "Fecundación: Unión de Gametos", "Desarrollo Embrionario Básico", "Genética Mendeliana: Leyes de la Herencia", "Alelos Dominantes y Recesivos", "Genotipo vs. Fenotipo", "Cuadros de Punnett Simplificados", "Herencia Ligada al Sexo", "Enfermedades Genéticas Comunes", "Biotecnología: Usos en Medicina y Agricultura", "Organismos Genéticamente Modificados (OGM)", "Terapia Génica: Posibilidades y Desafíos", "Clonación: ¿Qué es y Cómo Funciona?", "Células Madre: Potencial Regenerativo", "El Proyecto Genoma Humano", "Microbiología: El Mundo Invisible", "Bacterias Beneficiososas y Perjudiciales", "Antibióticos y Resistencia Bacteriana", "Hongos Microscópicos (Levaduras, Mohos)", "Protistas: Diversidad Microscópica", "Ecología Microbiana", "Botánica: El Estudio de las Plantas", "Plantas Vasculares vs. No Vasculares", "Angiospermas (Plantas con Flor) vs. Gimnospermas", "Partes de una Flor y Polinización", "Frutos y Dispersión de Semillas", "Adaptaciones de las Plantas (Desierto, Agua)", "Zoología: El Estudio de los Animales", "Invertebrados vs. Vertebrados", "Grupos Principales de Invertebrados (Insectos, Arácnidos, Moluscos)", "Grupos Principales de Vertebrados (Peces, Anfibios, Reptiles, Aves, Mamíferos)", "Adaptaciones Animales (Camuflaje, Mimetismo)", "Comportamiento Animal Básico (Instinto, Aprendizaje)", "Migración Animal", "Hibernación y Estivación", "Comunicación Animal", "Homeostasis: Manteniendo el Equilibrio Interno", "Regulación de la Temperatura Corporal", "Regulación del Agua y Sales", "El Ciclo Celular y su Regulación", "Cáncer: División Celular Descontrolada", "Apoptosis: Muerte Celular Programada", "Metabolismo: Reacciones Químicas de la Vida", "Anabolismo y Catabolismo", "Enzimas: Catalizadores Biológicos", "Bioenergética: Flujo de Energía en Sistemas Vivos", "Principios Básicos de la Taxonomía", "Nomenclatura Binomial de Linneo"
        ];
        const biologyThemes = [ /* --- Lista de temas de biología (igual que antes) --- */
            "la célula y sus orgánulos", "el ADN y la genética", "la evolución y selección natural", "la fotosíntesis y respiración celular", "los ecosistemas y la ecología", "el cuerpo humano y sus sistemas", "la clasificación de los seres vivos", "la microbiología", "la botánica", "la zoología", "la biotecnología", "la herencia mendeliana", "las relaciones entre especies", "las adaptaciones al medio", "los ciclos biogeoquímicos", "el sistema inmunológico", "la reproducción celular y de organismos", "el metabolismo", "la homeostasis", "las enfermedades genéticas", "la conservación de la biodiversidad", "la estructura de las proteínas", "el comportamiento animal", "los virus", "los hongos", "los protoctistas", "la historia de la biología"
        ];
        const textApiConfig = { model: "mistral", systemPrompt: "Eres un excelente comunicador científico especializado en biología. Tu tarea es explicar conceptos biológicos complejos de forma muy clara, sencilla y detallada para un público general o estudiantes (similar a un artículo de divulgación introductorio). Utiliza analogías simples, ejemplos cotidianos y evita la jerga excesiva. Estructura la explicación con claridad usando párrafos y ocasionalmente sub-títulos (usando markdown como ### o ####). El objetivo es una explicación completa y fácil de entender de unas 700-800 palabras. Basa tu explicación únicamente en el siguiente concepto:", timeoutSeconds: 100 }; // Increased timeout
        const titleGenerationConfig = { model: "mistral", systemPrompt: "Actúa como un generador de ideas conciso. Genera exactamente 15 conceptos o preguntas clave sobre biología, adecuados para ser explicados de forma sencilla. Devuelve *solo* la lista de conceptos/preguntas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.", timeoutSeconds: 30 };

        // ========== DOM ELEMENTS ========== (sin cambios)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ========== (sin cambios en la lógica central)
        async function fetchTextFromApi(prompt, config) { /* ... igual que antes ... */
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url}`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
             }
        }
        async function fetchExplanationText(conceptTitle) { /* ... igual que antes ... */
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              if (text.trim().length < 400 || text.toLowerCase().includes("cannot fulfill")) { // Keep basic check
                  throw new Error("La IA no pudo generar una explicación adecuada para este concepto.");
              }
             return text;
        }
        async function fetchGeneratedTitles() { /* ... igual que antes ... */
             const randomTheme = getRandomElement(biologyThemes) || "conceptos básicos";
             const specificPrompt = `Genera 15 conceptos o preguntas clave sobre ${randomTheme} en biología`;
             console.log("Generating concepts with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 120);
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de conceptos.");
             return titles.slice(0, 15);
        }
        function createPollinationsImageUrl(promptText, options = {}) { /* ... igual que antes, con prompt negativo anti-texto ... */
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "biology concept";
             const enhancedPrompt = `Simple clear scientific illustration or diagram explaining the concept of '${safePromptText}', educational visual, clean background, vector style if appropriate, focus on clarity`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, chart labels, graph labels, infographic text, signature, watermark, realistic photo, complex background, people, person"; // Added people/person
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
        }


        // ========== NEW: Text Formatting Function ==========
        /**
         * Converts simple Markdown-like syntax in the raw text to HTML.
         * Handles: #### Heading, ### Heading, **bold**, *italic*, paragraphs.
         * @param {string} rawText - The text from the API.
         * @returns {string} - HTML formatted string.
         */
        function formatExplanationText(rawText) {
            if (!rawText) return '';

            let formatted = rawText.trim();

            // 1. Handle Headings (multiline mode)
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');

            // 2. Handle Bold (**) - Must be done before italics
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // 3. Handle Italics (*)
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // 4. Handle Paragraphs (split by double newline)
            // Filter empty strings resulting from multiple newlines
            const paragraphs = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);

            formatted = paragraphs.map(p => {
                // If the line is already a heading we created, don't wrap it in <p>
                if (p.startsWith('<h3') || p.startsWith('<h4')) {
                    return p;
                }
                // Otherwise, wrap in <p> and replace single newlines within with <br>
                return `<p>${p.replace(/\n/g, '<br>')}</p>`;
            }).join(''); // Join paragraphs back together

            return formatted;
        }


        // ========== MODAL FUNCTIONS ========== (sin cambios)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { if(!storyModal) return; storyModal.classList.remove('active'); document.body.style.overflow = ''; resetModalState(); }
        function resetModalState() { /* ... igual que antes ... */
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = ''; // Clear innerHTML now
             modalContent.scrollTop = 0;
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.style.display = 'flex';
             modalErrorMessage.textContent = '';
        }


        // ========== UI & EVENT HANDLERS ========== (sin cambios en helpers)
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... igual que antes ... */
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]);
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay conceptos disponibles.</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
        }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }


        /**
         * Handles clicking on a title/concept. Fetches and displays the explanation & image.
         * NOW USES formatExplanationText and innerHTML.
         */
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = ''; // Clear previous content
            modalImageContainer.style.display = 'none';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // 1. Fetch Explanation Text
                const rawExplanationText = await fetchExplanationText(title);

                // **** NEW: Format the text ****
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // 2. Display Formatted Text FIRST
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation; // Use innerHTML
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'flex';
                modalImageSpinner.style.display = 'block';

                // 3. Fetch and Display Image AFTER text is shown
                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => {
                         modalImageSpinner.style.display = 'none';
                         modalImagePlaceholder.style.display = 'none';
                         modalImage.style.display = 'block';
                     };
                     modalImage.onerror = () => {
                         console.error("Error loading image for concept:", title);
                         modalImageSpinner.style.display = 'none';
                         modalImagePlaceholder.style.display = 'block';
                         modalImage.style.display = 'none';
                     };
                     modalImage.src = imageUrl;
                 } else {
                     console.error("Could not create image URL for concept:", title);
                     modalImageSpinner.style.display = 'none';
                     modalImagePlaceholder.style.display = 'block';
                 }

            } catch (error) {
                // Handle errors (same as before)
                console.error("Failed to display explanation:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = ''; // Clear innerHTML on error
            }
        }

        // handleGenerateMoreTitles (sin cambios)
        async function handleGenerateMoreTitles() { /* ... igual que antes ... */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Cargando...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se pudieron generar nuevos conceptos en este momento."); }
             } catch (error) {
                 console.error("Failed to generate more concepts:", error);
                 alert(`Error al generar más conceptos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Conceptos';
             }
         }

        // ========== INITIALIZATION ========== (sin cambios)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) {
                 console.error("Initialization failed: Critical elements missing.");
                 document.body.innerHTML = '<p style="padding: 2rem; text-align: center; color: red;">Error crítico al cargar la página.</p>';
                 return;
            }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>