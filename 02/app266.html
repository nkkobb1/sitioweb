<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Supe Database - Vought Leaks</title> <!-- Themed Title -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Impactantes / Corporativas -->
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Roboto+Condensed:wght@400;700&family=Teko:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para "The Boys" Theme --- */
        :root {
            --color-primary: #e50914; /* Rojo Sangre / Netflix Red */
            --color-secondary: #00529b; /* Azul Vought Corporativo */
            --color-tertiary: #f5f5f1; /* Blanco Hueso (Texto Principal) */
            --color-background: #141414; /* Negro/Gris Muy Oscuro */
            --color-background-alt: #1f1f1f; /* Gris ligeramente más claro */
            --color-text: var(--color-tertiary);
            --color-text-muted: #a0a0a0; /* Gris medio */
            --color-modal-bg: #1a1a1a; /* Fondo Modal */
            --color-border: #333333; /* Borde Gris Oscuro */
            --color-error-bg: #4d0f0f; /* Fondo error rojo oscuro */
            --color-error-text: #fecaca;
            --color-error-border: var(--color-primary);

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.5);
            --shadow-md: 0 4px 8px -1px rgba(0, 0, 0, 0.6), 0 2px 6px -2px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 10px 20px -5px rgba(0, 0, 0, 0.7), 0 8px 15px -6px rgba(0, 0, 0, 0.6);
            --shadow-inset: inset 0 2px 4px 0 rgba(0,0,0,0.3);
            --border-radius: 2px; /* Bordes más rectos/afilados */
            --transition-normal: all 0.2s ease-in-out;
        }
        /* Estilo base con textura sutil (opcional) */
        /* body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url('data:image/svg+xml,...'); opacity: 0.05; z-index: -1; } */
        body { font-family: 'Roboto Condensed', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Anton', sans-serif; /* O 'Teko' */ font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
        .logo { color: var(--color-primary); text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }
        h1.page-title { color: var(--color-tertiary); font-weight: 600; text-shadow: 1px 1px 2px var(--color-primary); }
        h2.section-title { color: var(--color-tertiary); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 600; }
        #modal-title { color: var(--color-primary); font-weight: 600; font-family: 'Anton', sans-serif; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .navbar { background-color: rgba(20, 20, 20, 0.9); /* Fondo casi opaco */ backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-background-alt); color: var(--color-text); box-shadow: var(--shadow-inset); transition: var(--transition-normal); font-family: 'Roboto Condensed'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(229, 9, 20, 0.4), var(--shadow-inset); outline: none; background-color: #2a2a2a; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 700; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Roboto Condensed', sans-serif; font-size: 0.95rem; text-transform: uppercase; border-left: 4px solid var(--color-secondary); /* Borde azul Vought */ }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #252525; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: var(--color-primary); color: var(--color-tertiary); padding: 0.8rem 1.6rem; border: 1px solid #a0000b; border-radius: var(--border-radius); font-family: 'Anton', sans-serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1.5px; text-transform: uppercase; box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { background: #ff1a28; border-color: var(--color-primary); box-shadow: var(--shadow-md); transform: scale(1.01); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; border-color: #555; }
        #generate-more-btn .fa-sync-alt { /* Spinner styling not needed if text changes */ }

        #story-modal { /* Mismos estilos base que antes */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(20, 20, 20, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-top: 5px solid var(--color-primary); /* Borde superior rojo */
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px; width: 95%; max-height: 90vh; min-height: 500px; /* Más altura para juego+chat */
            overflow: hidden; position: relative; box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 8px; right: 8px; background: var(--color-border); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-tertiary); transform: rotate(90deg); }
        #modal-title { font-size: 2.1rem; text-align: center; margin-bottom: 1rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.2; }

        /* Área Principal Modal (Contenido + Chat) */
        #modal-story-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; /* Oculta overflow aquí, gestionado por hijos */ }

        /* Área Scrollable (Texto + Imagen) */
        #modal-content-area { flex-grow: 1; min-height: 0; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(51, 51, 51, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(51, 51, 51, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid #111; }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Teko', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-tertiary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase;}
        #modal-content h1 { font-size: 1.6em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen Final y Placeholder */
        #modal-content .final-image { display: block; max-width: 90%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: 0 0 15px rgba(229, 9, 20, 0.5); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(51, 51, 51, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }
        #modal-content .image-placeholder p { font-size: 0.85em; margin-top: 0.5rem; font-family: 'Roboto Condensed'; }

        /* --- Loading Indicator con Mini-Juego --- */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--color-modal-bg); /* Fondo oscuro */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius);
            padding: 1rem;
        }
        #loading-game-canvas {
            width: 80%; /* Ajustar según necesidad */
            max-width: 500px;
            height: 150px; /* Altura fija para el juego */
            background-color: #2a2a2a; /* Fondo del canvas */
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            cursor: pointer; /* Indica que se puede interactuar */
            display: block; /* Importante para el canvas */
        }
        #modal-loading p.loading-text { /* Texto debajo del juego */
            font-weight: 700; color: var(--color-text-muted); font-size: 1.1rem;
            font-family: 'Roboto Condensed'; text-align: center;
            margin-top: 0.5rem;
        }
        #game-instructions { font-size: 0.9em; color: var(--color-text-muted); margin-top: 0.5rem; }
        #game-score { position: absolute; top: 10px; right: 20px; font-family: 'Teko', sans-serif; font-size: 1.5rem; color: var(--color-primary); }
        #game-over-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Anton', sans-serif; font-size: 2rem; color: var(--color-primary); text-shadow: 1px 1px 2px black; text-align: center; display: none; }
        #game-over-message span { font-size: 0.7em; display: block; color: var(--color-text-muted); font-family: 'Roboto Condensed'; text-transform: none; letter-spacing: 0; }

        /* --- Fin Estilos Loading --- */

        /* Chat Section Styles (Sin cambios mayores de estructura) */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: auto; /* Empuja al fondo */ flex-shrink: 0; display: flex; flex-direction: column; max-height: 200px; /* Altura del chat */ background-color: var(--color-modal-bg); /* Asegura fondo */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: var(--color-background-alt); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(51, 51, 51, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(51, 51, 51, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.45; font-size: 0.9rem; }
        .user-message { background-color: var(--color-secondary); color: var(--color-tertiary); margin-left: auto; text-align: left; box-shadow: var(--shadow-sm); }
        .ai-message { background-color: #333; color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.85em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #2a2a2a; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Roboto Condensed'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-secondary); color: var(--color-tertiary); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #006ad1; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Error Msg & Hidden Class */
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1rem 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1rem; text-align: center; flex-shrink: 0; font-weight: 700; font-family: 'Roboto Condensed'; font-size: 0.95rem; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-text); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { /* Sin cambios mayores */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(20, 20, 20, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 1rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 15px; right: 20px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-tertiary); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-bolt mr-2"></i> <!-- Icono Rayo -->
                     THE SUPE DATABASE
                 </h1>
             </div>
             <span class="text-xs text-gray-400 font-sans tracking-wider uppercase">» Vought Internal Files - Leaked «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-10 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Exposing Vought's Assets</h1>
             <p class="text-lg text-gray-300 mb-8 max-w-3xl mx-auto font-light">Classified profiles, Compound V data, corporate secrets. The truth about "heroes". Access responsibly.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Search Supe profile, Vought project, or keyword...">
             <i class="fas fa-user-secret fa-search"></i> <!-- Icono espía/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-folder-open text-red-600 mr-2"></i>
                 Classified Dossiers
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Decrypting Vought Network Access...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» No matching files found in the database. Check parameters. «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <!-- Texto cambiará con JS -->
                     Request More Intel Leaks (40)
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator con Mini-Juego -->
             <div id="modal-loading">
                 <canvas id="loading-game-canvas" width="500" height="150"></canvas>
                 <p class="loading-text">ACCESSING FILE... MAINTAIN CONNECTION</p>
                 <p id="game-instructions" class="text-xs">Press SPACE or TAP to Jump</p>
                 <div id="game-score">SCORE: 0</div>
                 <div id="game-over-message">CONNECTION LOST!<br><span>Tap/Space to Retry</span></div>
             </div>

             <!-- Content Area Wrapper (Texto + Chat) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Vought AI analyzing query...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Ask about this dossier...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Dossier">
      </div>

      <!-- Footer -->
      <footer class="bg-black text-gray-600 py-5 mt-12 border-t border-gray-800 font-sans">
          <div class="container mx-auto px-4 text-center text-xs">
              <p>DISCLAIMER: Information is AI-generated based on the themes of "The Boys". Fictional content for entertainment.</p>
              <p class="mt-1">Vought International and its affiliates are fictional entities. Do not attempt to replicate Compound V.</p>
              <p class="mt-2">© Classified Year - The Boys Info Network</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // The Seven & Associates
            "Homelander: Profile & Psych Evaluation", "Queen Maeve: Combat Analysis & Vulnerabilities", "Starlight: Power Evolution & Vought PR Strategy", "A-Train: Speed Metrics & Compound V Dependency", "The Deep: Aquatic Abilities & Public Image Rehab", "Black Noir (Current Gen): Skills & Known History", "Stormfront: History & Ideological Analysis (CLASSIFIED)", "Translucent: Invisibility Mechanics & Weaknesses", "Lamplighter: Pyrokinesis & History with The Boys",
            // The Boys & Allies
            "Billy Butcher: Profile & Anti-Supe Tactics", "Hughie Campbell: Tech Skills & Temp V Effects", "Mother's Milk (MM): History & Compulsions", "Frenchie: Weaponry & Chemistry Expertise", "Kimiko Miyashiro (The Female): Regeneration & Trauma Analysis", "Grace Mallory: CIA Background & Origins of The Boys", "Colonel Sanders (Comic Origin - Adaptation Needed)", "Legend (Informant): Profile & Network", "Annie January (Starlight - Double Agent Role)",
            // Payback & Older Supes
            "Soldier Boy: History, Powers & PTSD Analysis", "Crimson Countess: Powers & Relationship Dynamics", "Gunpowder: Ballistic Abilities & Political Leanings", "Swatto: Flight & Insect Control (?)", "Mind-Droid (Concept/Comic): AI & Psychic Link", "Eagle the Archer: Skills & Public Persona", "Tek Knight (Concept/Mentioned): Tech Suit & Compulsions", "Liberty (Stormfront's Original Alias)", "The TNT Twins",
            // Vought International
            "Vought International: Corporate History & Structure", "Stan Edgar: Leadership Style & Objectives", "Madelyn Stillwell: Management Tactics & Relationship with Homelander", "Ashley Barrett: PR Head & Crisis Management", "The Seven Tower: Architecture & Security", "Vought News Network (VNN): Propaganda Analysis", "American Hero Theme Park: Operations & Incidents", "Global Wellness Center (Church of the Collective Front)", "Vought Studios: 'Dawn of the Seven' Production", "Vought Pharmaceutical: Compound V R&D", "Vought Response Teams: Equipment & Protocols", "Vought Legal Department: Supe Lawsuits & Settlements", "Vought Stock (VGT): Market Performance & Controversies", "Project Lighthouse (Supe Detection/Tracking)",
            // Compound V
            "Compound V: Origins & Frederick Vought's Research", "Compound V: Effects on Adults vs. Infants", "Temporary Compound V (V24): Effects & Risks", "Compound V Side Effects: Known Cases & Long-Term Issues", "Vought's Control & Distribution of Compound V", "Black Market Compound V: Sources & Quality", "Ethical Implications of Compound V", "Genetic Predisposition for Supe Powers", "Compound V Stabilizers & Boosters (Theories)", "Withdrawal Symptoms from Compound V / V24",
            // Other Supes (Known & Potential Concepts)
            "Popclaw: Retractable Claws & Addiction Issues", "Shockwave: A-Train's Rival", "Doppelganger: Shapeshifting Abilities", "Gecko: Limb Regeneration (for profit)", "Blindspot: Daredevil Parody & Abilities", "Mesmer: Telepathy/Mind Reading (Limited)", "Naqib (Comic Supe - Adaptation): Explosive Powers", "Termite: Size Manipulation", "Blue Hawk: Aggressive Policing Allegory", "[Concept] Hydrokinetic Supe (Water Control)", "[Concept] Sonic Scream Supe", "[Concept] Technopath (Machine Control)", "[Concept] Density Shifter (Intangibility/Invulnerability)", "[Concept] Emotion Manipulator (Pheromones/Psychic)", "[Concept] Gravity Manipulator", "[Concept] Cryokinetic Supe (Ice Powers)", "[Concept] Minor Healing Factor Supe (with drawbacks)", "[Concept] Light Manipulation Supe (Illusions/Lasers)", "[Concept] Probability Manipulator (Luck-based)", "[Concept] Biological Toxin Supe", "[Concept] Metal Manipulator (Magneto Parody)", "[Concept] Plant Control Supe (Swamp Thing Parody)", "[Concept] Elasticity Supe (Mr. Fantastic Parody)", "[Concept] Enhanced Senses Supe (Tracking)", "[Concept] Portal Creation Supe (Limited)",
            // Groups & Events
            "The Boys (Group): History & Mission", "Payback (Group): History & Downfall", "The Seven (Group): Team Dynamics & PR", "Church of the Collective: Cult Analysis", "Believe Expo: Vought PR Event", "Sage Grove Center: Experiments & Breach", "The Herogasm Event (Comic/Show Adaptation)", "Anti-Supe Protests & Movements", "Collateral Damage Incidents (Major Events)", "Supe Terrorist Incidents (Alleged/Real)", "Vought's 'Supe Aid' Programs (PR Stunts)",
            // Themes & Concepts
            "Supe Celebrity Culture & Endorsements", "Corporate Control vs. Government Oversight", "Public Perception Manipulation by Vought", "The Cost & Downsides of Superpowers", "Addiction (Compound V, Fame, Power)", "Moral Corruption in Supes & Handlers", "Supe Worship & Fan Culture", "Weaponization of Superpowers", "Supe Registration Act (Hypothetical Debate)", "Supe Containment Facilities (The Asylum)", "Power Classification Systems (Vought Internal)", "Supe Weaknesses Database (Vought/Boys)", "Collateral Damage Claims Process", "The Nature of 'Heroism' in The Boys Universe", "Media Spin & Fake News (VNN)", "Exploitation of Supes by Vought", "Racism & Bigotry within Supe Ranks", "Sexual Misconduct Allegations against Supes", "Mental Health Issues in Supes", "Generational Differences in Supes (Soldier Boy vs. Homelander)", "The 'American Dream' vs. Supe Reality",
            // Locations
            "Seven Tower (Detailed Layout?)", "Vought International HQ", "The Boys' Hideout (Various)", "Madelyn Stillwell's Residence", "Believe Expo Center", "Sage Grove Psychiatric Hospital", "Red River Institute (Adoptive Agency)", "Starlight's Childhood Home (Iowa)", "The Flatiron Building (Vought NYC)",
            // Add ~200 more diverse titles following these patterns
            // ... (Continue adding specific scenarios, minor characters, tech, Vought divisions, ethical dilemmas, etc.)
            "Homelander's Public Approval Ratings Analysis", "Queen Maeve's 'Brave Maeve' Product Line", "Starlight's Music Career & Vought Control", "A-Train's 'A-Train Energy Drink' Campaign", "The Deep's 'Ocean Conservation' PR Stunts", "Black Noir's Allergy (Tree Nuts)", "Stan Edgar's Replacement Strategy", "Ashley Barrett's Anxiety & Coping Mechanisms", "Butcher's Laser Baby Incident Analysis", "Hughie's Trauma Post-Robin", "MM's OCD & Supe Connection", "Frenchie's Past with Lamplighter", "Kimiko's Sign Language Development", "Mallory's Motivation & Regrets", "Soldier Boy's Reaction to Modern Culture", "Crimson Countess's Chimp Sanctuary", "Gunpowder's NRA Affiliation", "Vought's Supe Talent Scouting Program", "Vought Board of Directors Profile", "Vought's Influence on US Politics", "Vought's International Operations (Non-US Supes?)", "Compound V Effects on Animals", "Failed Compound V Experiments", "Alternative Power Sources for Supes (Theories)", "Psychological Profiles of Minor Supes", "Supe Fight Club Rumors", "Underground Supe Communities", "Vought Employee Non-Disclosure Agreements", "Vought Whistleblower Protection (or Lack Thereof)", "The 'Dawn of the Seven' Movie Script Analysis", "Vought's Handling of Supe Retirements", "Supe Insurance Policies & Premiums", "The Economics of Supe Collateral Damage", "Public Opinion Polls on Supe Regulation", "Fan Theories about Black Noir's Identity", "Analysis of Vought's Marketing Strategies", "Comparison: Vought vs. Real-World Corporations", "The Role of Religion in the Supe World (Church of Collective)", "Media Portrayals of The Boys (In-Universe)", "Supe Training Facilities & Methods", "Vought's Internal Security Protocols", "Counter-Supe Weaponry Development (Boys/CIA)", "The Future of Compound V (Vought's Plans)", "Potential Spinoff Supes/Teams (Vought Concepts)", "Analysis of Homelander's Mother Complex", "Maeve's Relationship with Elena", "Starlight's Crisis of Faith", "A-Train's Fear of Obsolescence", "The Deep's Search for Belonging", "Butcher's Vendetta: Origins & Escalation", "Hughie's Moral Compass Evolution", "MM's Relationship with his Daughter", "Frenchie & Kimiko's Bond Analysis", "Soldier Boy's Definition of Masculinity", "Stan Edgar's Views on Superpowers", "Vought's Contingency Plans for Rogue Supes", // Keep going...
        ];
        const theBoysThemes = [ // For title generation
            "corrupt superheroes", "Vought International", "Compound V secrets", "The Seven members", "The Boys team", "anti-Supe sentiment", "Supe weaknesses", "Vought PR scandals", "celebrity Supe culture", "collateral damage incidents", "Payback team history", "Soldier Boy analysis", "Homelander psychology", "Starlight's journey", "Butcher's vendetta", "Temporary V effects", "Supe experimentation", "corporate espionage Vought", "Supe registration debate", "ethical dilemmas superpowers", "Vought News Network propaganda", "minor Supe profiles", "Church of the Collective", "Herogasm event", "Supe mental health", "black market Compound V", "Frederick Vought's legacy", "government oversight of Supes", "Supe containment failures"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "You are a jaded, cynical analyst who has gained access to classified Vought International files and informant networks similar to 'The Boys'. Your task is to provide a detailed, realistic, and often critical dossier on the requested Supe, Vought entity, or concept. Focus on powers (and their often-unpleasant realities/limitations), psychological flaws, corporate manipulation, known incidents (including collateral damage), PR spin vs. reality, weaknesses, and potential threats. Adopt a tone that is informative but distrustful of the official narrative. Aim for ~1200-1300 words. Base your report *only* on the following dossier subject:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Faster for chat
             systemPrompt: "Act as a Vought AI assistant (like the one The Deep talks to, but less pathetic) OR a grizzled informant (switch based on context). You ONLY have access to the currently displayed dossier subject. Answer follow-up questions concisely about that specific Supe/topic. If asked about something else, state 'That information is outside the current file parameters.' or 'I ain't got intel on that right now.'",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // *** Generate 40 Titles ***
            model: "mistral",
            systemPrompt: "Act as an intel compiler leaking Vought data snippets. Generate exactly 40 distinct and specific dossier titles (Supe names, Vought projects, events, concepts) related to the dark, corporate-controlled superhero world of 'The Boys'. Use evocative and sometimes cynical phrasing. Return *only* the list, one title per line. No numbers, intros, or explanations.",
            timeoutSeconds: 60 // Slightly more time for more titles
        };

        // ========== DOM ELEMENTS ==========
        // (Same as previous, plus game elements)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        // Modal Elements
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Now contains the game
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Game Elements
        const gameCanvas = document.getElementById('loading-game-canvas');
        const gameCtx = gameCanvas.getContext('2d');
        const gameScoreDisplay = document.getElementById('game-score');
        const gameOverMessage = document.getElementById('game-over-message');

        // ========== State Variables ==========
        let currentSupeTitle = null; // For chat context
        let gameLoopId = null;
        let isGameRunning = false;
        let gameInstance = null; // To hold game state

        // ========== API FUNCTIONS ==========
        // fetchTextFromApi, fetchExplanationText, fetchChatResponse, fetchGeneratedTitles, createPollinationsImageUrl
        // (Largely unchanged from previous version, BUT fetchGeneratedTitles needs to handle 40 titles)
        // ... (Keep the robust fetchTextFromApi with error handling and dynamic system prompt for chat)
        async function fetchTextFromApi(prompt, config, isChat = false) { /* ... */
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentSupeTitle
                 ? `Act as a Vought AI assistant or informant regarding ONLY '${currentSupeTitle}'. Answer concisely. State if the query is outside the current file.` // Dynamic prompt
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching API (${config.model}, Chat: ${isChat}): ${url.substring(0, 150)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Code ${response.status}) Vought servers overloaded or signal jammed. Try again later.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("Intel transmission corrupted (empty response). Try again.");
                 console.log(`API Response OK (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`Connection timed out (>${config.timeoutSeconds}s). Network unstable.`);
                 throw new Error(error.message || "Unknown network error during intel extraction.");
             }
        }
        async function fetchExplanationText(conceptTitle) { /* ... same wrapper */
             return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) { /* ... same wrapper */
             if (!currentSupeTitle) throw new Error("CRITICAL ERROR: Dossier context lost.");
             return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() { // *** Fetch 40 ***
             const randomTheme = getRandomElement(theBoysThemes) || "general Vought intel";
             const specificPrompt = `Generate 40 distinct dossier titles about ${randomTheme} (The Boys universe)`;
             console.log("Generating 40 titles with prompt:", specificPrompt);
             // Use the generic fetchTextFromApi
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                  .then(text => {
                      const titles = text.split('\n')
                                         .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                         .filter(line => line.length > 8 && line.length < 150); // Filter reasonably
                      if (titles.length < 20) throw new Error("Intel leak insufficient. Received too few dossier titles."); // Expect at least half
                      console.log(`Generated ${titles.length} titles.`);
                      return titles.slice(0, 40); // Return up to 40
                  });
        }
        function createPollinationsImageUrl(promptText, options = {}) { /* ... */
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Vought Supe concept art";
             // Prompt for "The Boys" aesthetic
             const enhancedPrompt = `Gritty, realistic concept art for '${safePromptText}' in the style of The Boys tv show. Focus on character design, powers visual effects, or corporate setting. Dark, cinematic lighting. Avoid cartoonish elements, avoid text.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, label, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, cartoon, anime, illustration, drawing, sketch, multiple images, collage, bright colors, happy atmosphere";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText) { /* ... same robust function */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' '); // Replace inner newlines with space for paragraph flow
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { /* ... same */ storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { /* ... same, ensures game stops */
            storyModal.classList.remove('active');
            stopLoadingGame(); // Ensure game stops if modal is closed
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() { /* ... same, includes game reset */
             modalLoadingIndicator.style.display = 'flex'; // Show loading area (with game canvas)
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false;
             currentSupeTitle = null;
             hideFullscreenImage();
             resetLoadingGameVisuals(); // Reset game score display etc.
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ==========
        function showFullscreenImage(imgSrc) { /* ... same */
             if (!imageFullscreenOverlay || !fullscreenImage) return;
             fullscreenImage.src = imgSrc;
             imageFullscreenOverlay.classList.add('active');
             document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() { /* ... same */
             if (!imageFullscreenOverlay) return;
             imageFullscreenOverlay.classList.remove('active');
             // Only restore scroll if main modal is ALSO closed
             if (!storyModal.classList.contains('active')) {
                  document.body.style.overflow = '';
             }
             fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ==========
        // addChatMessage, addChatError, handleSendMessage
        // (Unchanged from previous version)
        function addChatMessage(message, sender) { /* ... */
             const msgDiv = document.createElement('div');
             msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
             message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
             msgDiv.innerHTML = message;
             chatHistory.appendChild(msgDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... */
             const userQuery = chatInput.value.trim();
             if (!userQuery || chatSendBtn.disabled || !currentSupeTitle) return;
             addChatMessage(userQuery, 'user');
             chatInput.value = '';
             chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block';
             try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); }
             catch (error) { console.error("Chat Error:", error); addChatError(`AI Error: ${error.message}`); }
             finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); }
        }

        // ========== LOADING SCREEN MINI-GAME ==========
        const GAME_CONFIG = {
            GRAVITY: 0.6, JUMP_FORCE: -10, SPEED: 4, OBSTACLE_INTERVAL: 80,
            PLAYER_WIDTH: 30, PLAYER_HEIGHT: 50, PLAYER_COLOR: '#f5f5f1', // Off-white silhouette
            OBSTACLE_MIN_WIDTH: 20, OBSTACLE_MAX_WIDTH: 40,
            OBSTACLE_MIN_HEIGHT: 30, OBSTACLE_MAX_HEIGHT: 60,
            OBSTACLE_COLOR: '#e50914', // Red obstacles
            GROUND_Y: gameCanvas.height - 20, // Ground position
            BACKGROUND_COLOR: '#2a2a2a', // Canvas background
            CITY_COLOR: '#1a1a1a' // Darker city silhouette color
        };

        class Player {
            constructor(ctx) { this.ctx = ctx; this.x = 50; this.y = GAME_CONFIG.GROUND_Y - GAME_CONFIG.PLAYER_HEIGHT; this.width = GAME_CONFIG.PLAYER_WIDTH; this.height = GAME_CONFIG.PLAYER_HEIGHT; this.velocityY = 0; this.onGround = true; }
            jump() { if (this.onGround) { this.velocityY = GAME_CONFIG.JUMP_FORCE; this.onGround = false; } }
            update() { this.velocityY += GAME_CONFIG.GRAVITY; this.y += this.velocityY; if (this.y >= GAME_CONFIG.GROUND_Y - this.height) { this.y = GAME_CONFIG.GROUND_Y - this.height; this.velocityY = 0; this.onGround = true; } }
            draw() { this.ctx.fillStyle = GAME_CONFIG.PLAYER_COLOR; this.ctx.fillRect(this.x, this.y, this.width, this.height); /* Add simple running animation later? */ }
        }
        class Obstacle {
            constructor(ctx, x) { this.ctx = ctx; this.x = x; this.width = Math.random() * (GAME_CONFIG.OBSTACLE_MAX_WIDTH - GAME_CONFIG.OBSTACLE_MIN_WIDTH) + GAME_CONFIG.OBSTACLE_MIN_WIDTH; this.height = Math.random() * (GAME_CONFIG.OBSTACLE_MAX_HEIGHT - GAME_CONFIG.OBSTACLE_MIN_HEIGHT) + GAME_CONFIG.OBSTACLE_MIN_HEIGHT; this.y = GAME_CONFIG.GROUND_Y - this.height; this.isVoughtLogo = Math.random() > 0.7; /* 30% chance Vought logo */ }
            update() { this.x -= GAME_CONFIG.SPEED; }
            draw() {
                if (this.isVoughtLogo) { // Draw a simple 'V'
                     this.ctx.fillStyle = GAME_CONFIG.OBSTACLE_COLOR; // Vought Blue? No, let's keep obstacles red for danger
                     this.ctx.font = `${this.height * 1.2}px Anton`; // Use Anton font for V
                     this.ctx.textAlign = 'center';
                     this.ctx.fillText('V', this.x + this.width / 2, this.y + this.height * 0.9);
                } else { // Draw rectangle debris
                    this.ctx.fillStyle = GAME_CONFIG.OBSTACLE_COLOR;
                    this.ctx.fillRect(this.x, this.y, this.width, this.height);
                }
             }
            isVisible() { return this.x + this.width > 0; }
        }
        // Simple Parallax Background
        let backgroundOffset = 0;
        function drawBackground(ctx, width, height) {
            ctx.fillStyle = GAME_CONFIG.BACKGROUND_COLOR; // Clear canvas
            ctx.fillRect(0, 0, width, height);

             // Parallax City Silhouette (very basic)
            ctx.fillStyle = GAME_CONFIG.CITY_COLOR;
            const skylineHeight = 50;
            const buildingWidth = 30;
            const gap = 10;
            const totalPatternWidth = (buildingWidth + gap) * 10; // Example pattern width

            backgroundOffset -= GAME_CONFIG.SPEED * 0.3; // Slower scroll
            if (backgroundOffset <= -totalPatternWidth) { backgroundOffset = 0; }

            for (let i = -1; i < Math.ceil(width / (buildingWidth + gap)) + 1; i++) {
                 const buildingHeight = Math.random() * (skylineHeight - 10) + 10;
                 const xPos = backgroundOffset + i * (buildingWidth + gap);
                 ctx.fillRect(xPos, GAME_CONFIG.GROUND_Y - buildingHeight, buildingWidth, buildingHeight);
             }

             // Ground Line
            ctx.fillStyle = '#333'; // Darker ground
            ctx.fillRect(0, GAME_CONFIG.GROUND_Y, width, height - GAME_CONFIG.GROUND_Y);
        }

        function initGame() {
            console.log("Initializing Mini-Game...");
            return {
                player: new Player(gameCtx), obstacles: [], score: 0, frameCount: 0, isGameOver: false,
            };
        }
        function gameLoop() {
            if (!isGameRunning || !gameInstance) return;

            gameInstance.frameCount++;
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            drawBackground(gameCtx, gameCanvas.width, gameCanvas.height); // Draw parallax background

            // Obstacle Handling
            if (gameInstance.frameCount % GAME_CONFIG.OBSTACLE_INTERVAL === 0) {
                gameInstance.obstacles.push(new Obstacle(gameCtx, gameCanvas.width));
            }
            gameInstance.obstacles = gameInstance.obstacles.filter(o => o.isVisible());
            gameInstance.obstacles.forEach(o => { o.update(); o.draw(); });

            // Player Handling
            gameInstance.player.update();
            gameInstance.player.draw();

            // Collision Detection
            for (let obstacle of gameInstance.obstacles) {
                const p = gameInstance.player;
                if (p.x < obstacle.x + obstacle.width && p.x + p.width > obstacle.x &&
                    p.y < obstacle.y + obstacle.height && p.y + p.height > obstacle.y) {
                    gameOver();
                    return; // Stop loop on game over
                }
            }

            // Score Update
            gameInstance.score++;
            gameScoreDisplay.textContent = `SCORE: ${gameInstance.score}`;

            gameLoopId = requestAnimationFrame(gameLoop);
        }
        function startGame() {
            if (isGameRunning) return;
            console.log("Starting Mini-Game...");
            gameInstance = initGame();
            isGameRunning = true;
            gameOverMessage.style.display = 'none'; // Hide game over message
            gameLoopId = requestAnimationFrame(gameLoop);
            // Add listener for jump (only when game starts)
            document.addEventListener('keydown', handleGameInput);
            gameCanvas.addEventListener('click', handleGameInput);
            gameCanvas.addEventListener('touchstart', handleGameInput);
        }
        function stopGame() {
            if (!isGameRunning) return;
            console.log("Stopping Mini-Game...");
            isGameRunning = false;
            cancelAnimationFrame(gameLoopId);
            gameLoopId = null;
            // Remove listeners
            document.removeEventListener('keydown', handleGameInput);
            gameCanvas.removeEventListener('click', handleGameInput);
            gameCanvas.removeEventListener('touchstart', handleGameInput);
        }
        function gameOver() {
            console.log("Game Over!");
            stopGame(); // Stop the animation loop but keep listeners for retry
            gameInstance.isGameOver = true;
            gameOverMessage.style.display = 'block';
             // Add retry listeners
             document.addEventListener('keydown', handleRetryInput, { once: true }); // Listen only once
             gameCanvas.addEventListener('click', handleRetryInput, { once: true });
             gameCanvas.addEventListener('touchstart', handleRetryInput, { once: true });
        }
        function resetLoadingGameVisuals() {
             gameScoreDisplay.textContent = `SCORE: 0`;
             gameOverMessage.style.display = 'none';
             // Optionally clear the canvas too
             if (gameCtx) {
                 gameCtx.fillStyle = GAME_CONFIG.BACKGROUND_COLOR;
                 gameCtx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
                 gameCtx.fillStyle = '#555';
                 gameCtx.font = '14px Roboto Condensed';
                 gameCtx.textAlign = 'center';
                 // ctx.fillText("Waiting for connection...", gameCanvas.width / 2, gameCanvas.height / 2);
             }
        }
        function handleGameInput(event) {
             if (!isGameRunning) return;
             // Jump on Spacebar press or canvas click/tap
             if (event.code === 'Space' || event.type === 'click' || event.type === 'touchstart') {
                 event.preventDefault(); // Prevent space scrolling page
                 if(gameInstance && gameInstance.player) {
                     gameInstance.player.jump();
                 }
             }
         }
         function handleRetryInput(event){
             if (event.code === 'Space' || event.type === 'click' || event.type === 'touchstart') {
                 event.preventDefault();
                 console.log("Retrying game...");
                 // Ensure old listeners are removed before starting again (though {once: true} helps)
                 document.removeEventListener('keydown', handleRetryInput);
                 gameCanvas.removeEventListener('click', handleRetryInput);
                 gameCanvas.removeEventListener('touchstart', handleRetryInput);
                 startGame(); // Restart the game
             }
         }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { /* ... same */ return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... same */ let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { /* ... same */ const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... same */
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» No intel files found in database. «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... same */
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick to integrate game start/stop ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = "ACCESSING: " + title; // More thematic title
            currentSupeTitle = title;
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; // Show loading area
            startGame(); // *** START THE MINI-GAME ***

            try {
                const rawExplanationText = await fetchExplanationText(title);
                stopGame(); // *** STOP GAME on successful fetch (before showing content) ***
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none'; // Hide loading area
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;

                // Image Placeholder & Loading (within modalContent)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p>Loading Visual Confirmation...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visual Dossier: ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p>Visual Feed Corrupted.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p>Image Render Failed.</p>`; }

            } catch (error) {
                console.error("Failed Dossier Access:", error);
                stopGame(); // *** STOP GAME on error ***
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Unknown error accessing Vought servers.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 count ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.textContent = 'DECRYPTING MORE FILES...'; // Thematic text
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Further intel leaks blocked or corrupted."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Data Extraction Failed: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.textContent = 'Request More Intel Leaks (40)';
             }
         }

         // *** Search Filter Function (with normalization) ***
         function filterTitles(searchTerm) { /* ... same robust filter */
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check all essential elements, including game canvas
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !gameCanvas || !gameScoreDisplay || !gameOverMessage) {
                console.error("Initialization failed: Missing essential UI or Game elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">** SYSTEM CORRUPTION - UI MODULES FAILED TO LOAD **</p>';
                return;
             }
            // Event Listeners (Modal, Generate More, Search, Chat, Fullscreen Image)
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial Display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            resetLoadingGameVisuals(); // Ensure game area looks right initially
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>