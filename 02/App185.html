<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Narrativa Experimental - Laboratorio de Formas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y modernas, con opción a algo más 'arty' para títulos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Narrativa Experimental --- */
        :root {
            --color-primary: #8A2BE2; /* Violeta Azulado Intenso */
            --color-secondary: #FFD700; /* Dorado (uso muy moderado para acentos) */
            --color-tertiary: #4682B4; /* Azul Acero */
            --color-background: #fdfdfd; /* Blanco Roto / Muy Claro */
            --color-text: #2d3748; /* Gris Oscuro */
            --color-text-muted: #718096; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro */
            --color-border: #e2e8f0; /* Borde Gris Claro */
            --color-error-bg: #fff5f5; /* Fondo error rosa muy claro */
            --color-error-text: #c53030; /* Texto error rojo oscuro */
            --color-error-border: #fc8181; /* Borde error rojo claro */

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.07), 0 1px 2px 0 rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 4px;
            --transition-normal: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); /* Suave ease-out */
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Playfair Display', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Inter'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.15); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alinear a la izquierda */ font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; /* Flex para alinear ícono si se añade */ align-items: center; min-height: 65px; font-family: 'Inter'; font-size: 0.95rem; line-height: 1.4; }
        /* Icono opcional antes del texto */
        .title-item::before { content: '\f054'; /* FontAwesome right arrow or similar */ font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-right: 0.7rem; color: var(--color-primary); opacity: 0.6; transition: var(--transition-normal); }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f8f4ff; /* Lavanda muy claro */ }
        .title-item:hover::before { opacity: 1; transform: translateX(2px); }

        /* Modal Styles */
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(45, 55, 72, 0.85); /* Overlay gris */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Content Area (Text + Image + Chat) */
        #modal-story-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; /* Important: Overflow managed by children */ }

        /* Scrollable Text Area */
        #modal-content-area { flex-grow: 1; /* Takes available space */ overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-size: 1.05rem; /* Slightly larger font */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Playfair Display', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Image Styles */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(226, 232, 240, 0.8); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: auto; /* Pushes chat to bottom */ flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; background-color: #f9fafb; /* Slightly different bg for chat area */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fff; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.55; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: #fff; margin-left: auto; text-align: left; font-weight: 400; border-bottom-right-radius: 0; }
        .ai-message { background-color: #eef2ff; /* Light Indigo background */ color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; border: 1px solid #e0e7ff; border-bottom-left-radius: 0;}
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; padding: 0 0.5rem 0.5rem 0.5rem; /* Padding around input/button */ }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Inter'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.1); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: #fff; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #7a1dc9; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading & Error Styles */
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-primary); font-size: 1.4rem; font-family: 'Playfair Display'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Inter'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 15, 31, 0.96); /* Darker overlay */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: 0 0 30px rgba(138, 43, 226, 0.3); border-radius: 2px; }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: #fff; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-pen-nib mr-3 text-blue-400"></i> <!-- Icono pluma -->
                     Narrativa Experimental
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wide">Laboratorio de Formas y Estructuras</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explorando los Límites</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Sumérgete en técnicas narrativas que desafían la convención. Selecciona un concepto para analizar su forma, función y potencial creativo.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar técnica o concepto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-drafting-compass text-purple-500 mr-2"></i> <!-- Icono compás/diseño -->
                 Índice de Técnicas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando catálogo de experimentos narrativos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Ninguna técnica coincide con la búsqueda «</p>
             <!-- "Generate More" button removed -->
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Analizando Estructura...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom) -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando archivos...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta técnica...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Conceptual Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Análisis generados por IA con fines educativos y de exploración literaria.</p>
              <p class="mt-1">Las interpretaciones y ejemplos pueden variar. Fomenta tu propia lectura crítica.</p>
              <p class="mt-2">© 2024 Laboratorio de Formas Narrativas</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Manipulación del Tiempo y Estructura
            "Narrativa No Lineal: Principios y Efectos", "Cronología Inversa: Contar Hacia Atrás", "Narrativa Fragmentada: Mosaicos de Significado", "Estructura Modular: Bloques Recombinables", "Historias Paralelas / Contrapunto Narrativo", "Tiempo Subjetivo vs. Tiempo Objetivo", "Flashbacks y Flashforwards como Estructura", "Anacronismo Deliberado", "Narrativa en Espiral / Circular", "Tiempo Elíptico: Lo No Contado", "Estructura de 'Matrioska' (Historia dentro de Historia)", "Ritmo Acelerado/Desacelerado Extremo", "Narrativa Simultánea: Múltiples Eventos a la Vez", "Efecto Rashomon: Múltiples Versiones del Mismo Evento", "Narrativa Palindrómica", "Estructura Basada en Algoritmos", "Hipertexto y Narrativa No Secuencial", "Narrativa como Bucle Temporal", "Finales Abiertos / Múltiples Finales", "Estructura Basada en Patrones Matemáticos (Ej. Fibonacci)", "Narrativa Polifónica: Múltiples Hilos Convergentes", "Tiempo Condicional ('What If...')", "Estructura en Espejo", "Narrativa Centrifuga (Expansión desde un punto)", "Narrativa Centripeta (Convergencia hacia un punto)", "Intercalación de Tiempos Narrativos", "Uso del Tiempo Presente Histórico", "Manipulación de la Duración Narrativa", "Estructura de Red o Rizoma", "Narrativa Basada en el Azar",

            // Punto de Vista y Voz Narrativa
            "Narrador No Fiable: Engañando al Lector", "Stream of Consciousness (Fluir de Conciencia)", "Monólogo Interior Directo vs. Indirecto", "Segunda Persona Narrativa ('Tú')", "Primera Persona del Plural ('Nosotros')", "Narrador Omnisciente Limitado Intrusivo", "Cambio Constante de Punto de Vista", "Narrador como Personaje Activo", "Voz Colectiva / Coro", "Narrador Múltiple (Estilo Faulkner)", "Punto de Vista Caleidoscópico", "Narrador Testigo vs. Protagonista", "Distancia Narrativa Variable", "Perspectiva Animal o Inhumana", "Narrador que Desafía su Propia Narración", "Voz Despersonalizada / Clínica", "Narrador Infantil No Fiable", "Narrador con Amnesia o Percepción Alterada", "Focalización Múltiple", "Voz Narrativa Fragmentada", "Silencio Narrativo como Voz", "Uso del Discurso Indirecto Libre", "Interpelación Directa al Lector", "Narrador que Miente Conscientemente", "Narrador que Oculta Información", "Punto de Vista Cero (Totalmente Externo)", "Voz Metanarrativa", "Narrador Quebrantado / Inconsistente", "Perspectiva Múltiple No Convergente", "Narrador como Entidad Abstracta",

            // Metaficción y Autoconciencia
            "Metaficción: La Historia Consciente de Sí Misma", "Ruptura de la Cuarta Pared", "El Autor como Personaje", "Comentario Explícito sobre el Proceso de Escritura", "Intertextualidad Extrema", "Parodia y Pastiche como Metaficción", "La Novela Dentro de la Novela", "Personajes Conscientes de ser Ficción", "Juegos con las Convenciones del Género", "Notas al Pie Metanarrativas", "Referencias a la Construcción del Texto", "Diálogo entre Autor y Personaje", "Uso de Documentos Falsos (Pseudo-Documental)", "Crítica Literaria Dentro de la Ficción", "El Lector como Personaje Implícito/Explícito", "Reflexión sobre la Naturaleza de la Ficción", "Metaficción Historiográfica", "Desmitificación del Proceso Creativo", "Finales Falsos o Alternativos Comentados", "Juegos con la Tipografía como Meta-Comentario", "Uso de Índices o Apéndices Ficticios", "La 'Mise en Abyme' Narrativa", "Autoconciencia Lingüística", "Metaficción y Humor", "Debate Filosófico Dentro de la Narrativa", "Cuestionamiento de la Autoridad Autorial", "El Papel del Azar en la Creación (Comentado)", "Ficción sobre la Creación de Ficción", "Narrativa que se Autocorrige", "La Biblioteca Infinita (Concepto Borgesiano)",

            // Lenguaje y Estilo
            "Prosa Poética: Límites Difusos", "Minimalismo Extremo: La Elipsis como Protagonista", "Maximalismo: Exuberancia y Detalle Obsesivo", "Juegos de Palabras y Calambures Estructurales", "Neologismos y Lenguaje Inventado", "Sintaxis Fragmentada o Disruptiva", "Puntuación No Convencional", "Uso Extensivo de la Repetición y Variación", "Tipografía como Elemento Narrativo (Concretismo)", "Lenguaje Coloquial Elevado a Arte", "Mímesis Fonética Extrema (Dialectos)", "Corriente Léxica (Asociación libre de palabras)", "Lenguaje Técnico o Científico en Contextos Inusuales", "Desfamiliarización (Ostranenie) del Lenguaje", "Estilo Indirecto Libre Expandido", "Políglotismo Narrativo", "Alteración de la Gramática Normativa", "Uso de Jerga o Argot Específico", "Cadencia y Ritmo como Elemento Central", "Lenguaje Visual / Descripción Abstracta", "Minimalismo Semántico", "Abundancia de Metáforas Inusuales", "Lenguaje Anti-Literario Deliberado", "Párrafos de una Sola Frase / Frases de un Solo Párrafo", "Elisión de Verbos o Sujetos", "Estilo Telegráfico", "Enumeraciones Caóticas (Estilo Whitman)", "Lenguaje Sonoro / Aliteración Extrema", "Palíndromos y Anagramas en la Prosa", "Escritura Automática (Surrealismo)",

            // Técnicas Mixtas y de Género
            "Collage Narrativo: Uniendo Fragmentos Diversos", "Técnica del Cut-Up (Burroughs)", "Ficción Epistolar Moderna (Emails, Chats)", "Narrativa Gráfica Experimental", "Ergodismo: El Texto que Exige Esfuerzo Físico (House of Leaves)", "Ficción Interactiva / Elige tu Propia Aventura", "Incorporación de Elementos Visuales (Fotos, Dibujos)", "Falsa Autobiografía / Autoficción Extrema", "Diario Ficticio No Fiable", "Narrativa Transmedia", "Mezcla Radical de Géneros", "Realismo Mágico Llevado al Límite Formal", "Ciencia Ficción 'New Wave' (Enfoque en Forma)", "Fábula o Alegoría Deconstruida", "Novela en Verso Libre", "Teatro del Absurdo en Prosa", "Documental Ficcionalizado (Docuficción)", "Ensayo Narrativo Experimental", "Biografía Ficticia de Personajes Reales", "Guion Cinematográfico como Prosa", "Narrativa Basada en Listas", "Uso de Partituras Musicales o Sonido", "Ficción Hiperrealista Fragmentada", "Poesía Concreta Narrativa", "Crónica Roja Estilizada", "Manifiesto Ficcionalizado", "Recetario Narrativo", "Atlas Geográfico Ficticio", "Entrevista Ficticia como Narrativa", "Instrucciones o Manuales como Relato",

            // Oulipo y Escritura con Restricciones
            "Oulipo: Taller de Literatura Potencial", "Lipograma: Escribir Sin una Letra", "Restricción del Vocabulario", "La Bola de Nieve (Palabras/Letras Crecientes)", "S+7 / N+7 (Sustitución Sistemática de Palabras)", "Restricciones Métricas en Prosa", "Restricciones Fonéticas", "Uso Exclusivo de Ciertas Formas Gramaticales", "Construcción Basada en Algoritmos Oulipianos", "El Prisionero (Restricción de Letras con 'Palos')", "Homosintaxis (Imitar Estructura de Otro Texto)", "Matriz de Restricciones Cruzadas", "Palíndromo de Palabras o Frases", "Definiciones Restrictivas", "Combinatoria y Permutación Narrativa", "Restricciones Temáticas Autoimpuestas", "La 'Belle Absente' (Evitar una Palabra Clave)", "Estructura Fija Impuesta (Ej. Soneto en Prosa)", "Restricciones Numéricas (Longitud de Párrafos/Frases)", "Traducción Homofónica", "Anticipación Plagiarista (Estilo Oulipo)", "Creación de Formas Literarias Nuevas (Oulipo)", "Restricciones de Tiempo de Escritura", "Uso de Dados o Azar Controlado (Oulipo)", "Restricciones Tipográficas Autoimpuestas", "El 'Logo-Rallye' (Incluir Palabras Dadas)", "Metro Definicional", "Literatura Booleana", "La Bibliothéque de Babel (Combinatoria Total)",

            // Surrealismo, Absurdismo y Otros
            "Lógica Onírica en la Narrativa", "Yuxtaposición Surrealista de Imágenes", "Automatismo Psíquico en la Escritura", "Humor Absurdo y Sin Sentido", "Situaciones Grotescas o Inexplicables", "Personajes Irracionales o Inconsistentes", "Diálogos Ilógicos o Inconexos", "Objetos Animados / Personificación Extrema", "Realidad Distorsionada / Alucinatoria", "Cadáver Exquisito Narrativo", "Teatro del Absurdo: Influencia en Prosa", "Sátira Existencial", "Paranoia y Alienación como Tema Central", "Transformaciones Físicas Inexplicables (Kafka)", "Ambientes Opresivos e Irreales", "El Azar como Fuerza Narrativa (Absurdo)", "Lenguaje como Juego (Absurdo)", "Crítica Social a través del Absurdo", "Finales Anti-Climáticos o Inconclusos (Absurdo)", "Motivaciones Inescrutables de los Personajes", "Fusión de lo Cómico y lo Trágico (Surreal/Absurdo)", "Paisajes Mentales Externalizados", "Narrativa como Performance del Lenguaje", "Desafío a la Causalidad Lógica", "El Silencio y el Vacío como Elementos", "Rechazo de la Psicología Tradicional del Personaje", "Exploración del Inconsciente Colectivo", "Mito Personal / Simbología Privada", "Influencia del Dadaísmo en la Narrativa", "Humor Negro y Macabro",

            // Conceptos Teóricos y Críticos
            "La Muerte del Autor (Barthes) y sus Implicaciones Narrativas", "Teoría del Rizoma (Deleuze & Guattari) en Ficción", "El Simulacro (Baudrillard) y la Narrativa", "La 'Obra Abierta' (Umberto Eco)", "Diferencia y Repetición en la Estructura Narrativa", "Intertextualidad como Práctica Consciente", "El Palimpsesto Narrativo", "Deconstrucción y Narrativa", "Postmodernismo Literario: Características Clave", "El Rol del Lector en la Narrativa Experimental", "Narrativa y Trauma: Formas Fragmentadas", "Estudios de Género y Experimentación Formal", "Post-colonialismo y Ruptura de Formas Occidentales", "La Política de la Forma Experimental", "Materialidad del Texto: Más Allá del Significado", "Narrativa Digital y Nuevos Medios", "El Concepto de 'Escritura Femenina' (Cixous)", "El 'Pacto Autobiográfico' (Lejeune) Roto", "La Noción de 'Juego' (Wittgenstein) en la Literatura", "Fenomenología y Descripción Narrativa", "El 'Anti-héroe' en la Narrativa Moderna/Experimental", "Crítica a la Representación Realista", "La Relación entre Vanguardia Artística y Literaria", "El Futuro de la Narrativa Experimental", "Estética de la Dificultad / Hermetismo", "El Valor Cognitivo de la Experimentación Formal", "Narrativa y Conciencia Ecológica (Eco-crítica experimental)", "El Archivo como Forma Narrativa", "La 'Pataphysique' y la Literatura"

            // Añadir más si es necesario para asegurar la exhaustividad
        ];
        // No more 'themes' needed as we removed the 'generate more' button
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un teórico literario y crítico especializado en narrativa contemporánea y experimental. Tu tarea es analizar y explicar la técnica o concepto narrativo indicado. Detalla su definición, origen (si es relevante, autores/movimientos clave), cómo funciona estructural o estilísticamente, qué efectos busca generar en el lector (cognitivos, emocionales, estéticos), ejemplos (pueden ser de obras reales o hipotéticos para ilustrar), y posibles desafíos o consideraciones para un escritor que la emplee. Ofrece una visión profunda y académica, pero accesible. Extensión objetivo: 1200-1300 palabras. Basa tu análisis exclusivamente en la siguiente técnica o concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúa como un asistente académico especializado únicamente en la técnica narrativa que se está discutiendo. Responde preguntas de seguimiento sobre sus matices, aplicaciones, autores relacionados, o comparaciones con otras técnicas. Sé preciso, conciso y mantén un tono académico.",
            timeoutSeconds: 45
        };
        // No titleGenerationConfig needed

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        // const generateMoreContainer = document.getElementById('generate-more-container'); // REMOVED
        // const generateMoreBtn = document.getElementById('generate-more-btn'); // REMOVED
        // const generateMoreSpinner = generateMoreBtn.querySelector('i'); // REMOVED
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTechniqueTitle = null; // Context for chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTechniqueTitle
                 ? `Eres un asistente académico especializado únicamente en la técnica narrativa llamada '${currentTechniqueTitle}'. Responde preguntas de seguimiento sobre sus matices, aplicaciones, autores relacionados, o comparaciones con otras técnicas. Sé preciso, conciso y mantén un tono académico.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores pueden estar experimentando alto tráfico. Por favor, inténtalo de nuevo en unos momentos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular tu consulta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión excedió el tiempo límite (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar los servidores de análisis.");
             }
        }
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentTechniqueTitle) throw new Error("Error interno: No se estableció el contexto de la técnica para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        // fetchGeneratedTitles function removed
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "abstract literary concept";
             // Updated prompt for abstract/conceptual visuals
             const enhancedPrompt = `Abstract conceptual art representing the narrative technique '${safePromptText}'. Focus on form, structure, language disruption, fragmentation, non-linearity, stream of consciousness, metafiction concepts. Use minimalist or complex abstract style. Color palette inspired by thought, ink, paper, digital glitch (e.g., monochrome with violet or blue accents, muted tones). Avoid literal scenes, characters, or text labels.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, graphs, charts, diagrams, realistic photograph, specific book cover, identifiable author portrait, simple shapes, logo, watermark, signature";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (Same as before)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            // Basic Markdown/format cleanup
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Paragraph conversion
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' '); // Replace internal newlines with space
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Same as before)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTechniqueTitle = null; // Reset chat context
             hideFullscreenImage(); // Ensure fullscreen is closed
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Same as before)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (Same as before)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        // getRandomElement, shuffleArray removed as not needed for generating titles anymore
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); // Sort alphabetically
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay técnicas listadas en el catálogo «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        // appendTitles function removed

        // *** handleTitleClick MODIFIED slightly for context variable name ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTechniqueTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-lightbulb placeholder-icon"></i> <!-- Icono idea/concepto -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el análisis.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // handleGenerateMoreTitles function removed

        // *** Search Filter Function (Same as before, using normalize) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Update check to remove generateMoreBtn
            if (!titleListContainer || !storyModal || !modalCloseBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Fallo al inicializar componentes de la interfaz.</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener REMOVED
            // generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>