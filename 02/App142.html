<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guerras y Batallas de la Historia - Enciclopedia Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Históricas/Académicas -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Guerras y Batallas --- */
        :root {
            --color-primary: #8B4513; /* Marrón (SaddleBrown - Tierra, Madera) */
            --color-secondary: #B8860B; /* Dorado Oscuro (DarkGoldenrod - Valor, Antigüedad) */
            --color-tertiary: #800000; /* Rojo Oscuro (Maroon - Conflicto, Sangre) */
            --color-background: #fdf6e3; /* Crema/Pergamino Claro (Solarized Light) */
            --color-text: #3a3a3a; /* Gris Muy Oscuro (Casi Negro) */
            --color-text-muted: #657b83; /* Gris Azulado Desaturado */
            --color-modal-bg: #f5f0e1; /* Crema ligeramente más oscuro que el fondo */
            --color-border: #d3c0a5; /* Borde Marrón Claro/Arena */
            --color-error-bg: #fde8e8; /* Fondo error rosa pálido */
            --color-error-text: #9b2c2c; /* Texto error rojo oscuro */
            --color-error-border: #f56565; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.07);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-tertiary); font-weight: 700; }
        h2.section-title { color: var(--color-primary); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-tertiary); font-weight: 700; }
        .navbar { background-color: rgba(245, 240, 225, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.2); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: #fff; padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alineación izquierda para nombres largos */ font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px) scale(1.01); box-shadow: var(--shadow-md); border-color: var(--color-border); color: var(--color-primary); background-color: #fefbf3; border-left-color: var(--color-secondary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; text-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(58, 58, 58, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 980px; /* Un poco más ancho para texto histórico */
            width: 95%;
            max-height: 90vh;
            min-height: 450px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); box-shadow: 0 0 8px var(--color-primary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid var(--color-modal-bg); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; text-align: justify; /* Justificar texto histórico */ }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; font-weight: 400; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 3rem auto 1.5rem auto; border: 2px solid var(--color-secondary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid var(--color-border); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1.2s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 260px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(253, 246, 227, 0.6); /* Fondo chat ligeramente más claro */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; font-family: 'Lato'; }
        .user-message { background-color: var(--color-secondary); color: white; margin-left: auto; text-align: right; font-weight: 400; box-shadow: var(--shadow-sm); }
        .ai-message { background-color: #e8e0c9; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; border: 1px solid var(--color-border); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #a0522d; } /* Sienna */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Lato';}
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(253, 246, 227, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 7px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.3s linear infinite; margin: 0 auto 1.8rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-primary); font-size: 1.4rem; font-family: 'Merriweather'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.8rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(40, 40, 40, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-secondary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-shield-alt mr-3 text-yellow-700"></i> <!-- Icono escudo -->
                     Guerras y Batallas
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-serif italic">» Una Crónica Interactiva «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora los Conflictos de la Historia</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Navega por los anales del tiempo y descubre los detalles de las guerras y batallas que moldearon el mundo.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar guerra, batalla o periodo...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll text-yellow-800 mr-2"></i> <!-- Icono pergamino -->
                 Índice Cronológico y Temático
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-600 col-span-full text-center text-lg font-serif">Consultando los archivos históricos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-600 col-span-full text-center text-lg mt-4 hidden font-serif">» No se encontraron registros para esa consulta «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Conflictos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Recopilando Información...</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image placeholder/final image appended here -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando al historiador...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este evento...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Evento Histórico">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-700 py-6 mt-12 border-t border-gray-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con propósitos educativos y de referencia sobre historia militar.</p>
              <p class="mt-1">Verifica siempre datos cruciales con fuentes académicas reconocidas.</p>
              <p class="mt-2">© [Año Actual] Crónicas Bélicas Interactivas</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Antigüedad - Egipto y Mesopotamia
            "Batalla de Megido (c. 1457 a.C.)", "Batalla de Qadesh (c. 1274 a.C.)", "Conquistas de Sargón de Acad", "Guerra entre Lagash y Umma", "Caída de Nínive (612 a.C.)", "Guerras Neoasirias",
            // Antigüedad - Grecia
            "Guerra de Troya (Legendaria/Edad del Bronce)", "Guerras Médicas", "Batalla de Maratón (490 a.C.)", "Batalla de las Termópilas (480 a.C.)", "Batalla de Salamina (480 a.C.)", "Batalla de Platea (479 a.C.)", "Guerra del Peloponeso", "Expedición a Sicilia", "Batalla de Egospótamos (405 a.C.)", "Guerra de Corinto", "Batalla de Leuctra (371 a.C.)", "Ascenso de Macedonia (Filipo II)", "Batalla de Queronea (338 a.C.)", "Conquistas de Alejandro Magno", "Batalla del Gránico (334 a.C.)", "Batalla de Issos (333 a.C.)", "Sitio de Tiro (332 a.C.)", "Batalla de Gaugamela (331 a.C.)", "Batalla del Hidaspes (326 a.C.)", "Guerras de los Diádocos", "Batalla de Ipsos (301 a.C.)", "Liga Aquea vs Liga Etolia", "Guerra Cretense",
            // Antigüedad - Roma (República)
            "Guerras Latinas", "Guerras Samnitas", "Batalla de las Horcas Caudinas", "Guerras Pírricas", "Batalla de Benevento (275 a.C.)", "Primera Guerra Púnica", "Batalla de Milas (260 a.C.)", "Batalla de las Islas Egadas (241 a.C.)", "Segunda Guerra Púnica", "Batalla del Tesino (218 a.C.)", "Batalla de Trebia (218 a.C.)", "Batalla del Lago Trasimeno (217 a.C.)", "Batalla de Cannas (216 a.C.)", "Batalla de Zama (202 a.C.)", "Guerras Macedónicas", "Batalla de Cinoscéfalos (197 a.C.)", "Batalla de Magnesia (190 a.C.)", "Batalla de Pidna (168 a.C.)", "Tercera Guerra Púnica", "Destrucción de Cartago (146 a.C.)", "Destrucción de Corinto (146 a.C.)", "Guerra de Numancia", "Guerras Serviles (Espartaco)", "Guerra Cimbria", "Batalla de Aquae Sextiae (102 a.C.)", "Batalla de Vercelae (101 a.C.)", "Guerra Social (Italia)", "Primera Guerra Civil Romana (Mario vs Sila)", "Guerras Mitridáticas", "Conquista de las Galias (Julio César)", "Batalla de Alesia (52 a.C.)", "Segunda Guerra Civil Romana (César vs Pompeyo)", "Batalla de Farsalia (48 a.C.)", "Batalla de Tapso (46 a.C.)", "Batalla de Munda (45 a.C.)", "Tercera Guerra Civil Romana (Libertadores vs Triunviros)", "Batalla de Filipos (42 a.C.)", "Cuarta Guerra Civil Romana (Octavio vs Antonio)", "Batalla de Actium (31 a.C.)",
            // Antigüedad - Roma (Imperio)
            "Conquista Romana de Britania", "Rebelión de Boudica", "Guerras Judeo-Romanas", "Sitio de Masada (73-74 d.C.)", "Guerras Dacias (Trajano)", "Guerras Marcomanas (Marco Aurelio)", "Crisis del Siglo III", "Batalla de Edesa (260 d.C.)", "Reformas militares de Diocleciano y Constantino", "Batalla del Puente Milvio (312 d.C.)", "Batalla de Adrianópolis (378 d.C.)", "Saqueo de Roma (410) por los Visigodos", "Batalla de los Campos Cataláunicos (451 d.C.)", "Saqueo de Roma (455) por los Vándalos", "Caída del Imperio Romano de Occidente (476 d.C.)",
            // Antigüedad - Asia y otros
            "Guerra de los Reinos Combatientes (China)", "Unificación de China por Qin Shi Huang", "Guerras Han-Xiongnu", "Rebelión de los Turbantes Amarillos", "Período de los Tres Reinos (China)", "Batalla de los Acantilados Rojos (208 d.C.)", "Imperio Maurya (India)", "Guerras Gupta (India)", "Imperio Parto vs Roma", "Batalla de Carras (53 a.C.)", "Imperio Sasánida vs Roma/Bizancio", "Guerra Anastasiana", "Guerra Ibérica", "Guerra Lázica",
            // Edad Media - Temprana
            "Conquistas Musulmanas", "Batalla de Yarmuk (636)", "Batalla de al-Qadisiyya (636)", "Sitio de Constantinopla (674-678)", "Batalla de Guadalete (711)", "Batalla de Poitiers/Tours (732)", "Guerras de Carlomagno", "Invasiones Vikingas", "Gran Ejército Pagano", "Batalla de Edington (878)", "Guerras Búlgaro-Bizantinas", "Batalla de Kleidion (1014)", "Conquista Normanda de Inglaterra", "Batalla de Stamford Bridge (1066)", "Batalla de Hastings (1066)",
            // Edad Media - Alta y Plena
            "Las Cruzadas (General)", "Primera Cruzada", "Sitio de Nicea (1097)", "Sitio de Antioquía (1097-1098)", "Sitio de Jerusalén (1099)", "Batalla de Hattin (1187)", "Tercera Cruzada", "Sitio de Acre (1189-1191)", "Batalla de Arsuf (1191)", "Cuarta Cruzada", "Saqueo de Constantinopla (1204)", "Cruzada Albigense", "Reconquista Española (General)", "Batalla de Las Navas de Tolosa (1212)", "Conquistas Mongolas (Genghis Khan, etc.)", "Batalla del río Kalka (1223)", "Batalla de Legnica (1241)", "Batalla de Mohi (1241)", "Batalla de Ain Yalut (1260)", "Guerra de los Cien Años (General)", "Batalla de Crécy (1346)", "Batalla de Poitiers (1356)", "Batalla de Agincourt (1415)", "Sitio de Orleans (1428-1429)", "Batalla de Castillon (1453)", "Guerra de las Dos Rosas (Inglaterra)", "Batalla de Bosworth Field (1485)", "Guerras Husitas", "Caída de Constantinopla (1453)",
            // Edad Moderna - Siglos XVI-XVII
            "Guerras Italianas", "Batalla de Pavía (1525)", "Saqueo de Roma (1527)", "Guerras de Religión de Francia", "Matanza de San Bartolomé (1572)", "Guerra de los Ochenta Años (Independencia Holandesa)", "Sitio de Leiden (1573-1574)", "Guerra Anglo-Española (Armada Invencible)", "Derrota de la Armada Invencible (1588)", "Guerra de los Treinta Años", "Batalla de la Montaña Blanca (1620)", "Batalla de Lützen (1632)", "Batalla de Nördlingen (1634)", "Batalla de Rocroi (1643)", "Paz de Westfalia (1648)", "Guerra Civil Inglesa", "Batalla de Naseby (1645)", "Guerras Anglo-Holandesas", "Gran Guerra Turca", "Sitio de Viena (1683)", "Batalla de Zenta (1697)",
            // Edad Moderna - Siglo XVIII
            "Guerra de Sucesión Española", "Batalla de Blenheim (1704)", "Batalla de Almansa (1707)", "Batalla de Poltava (1709)", "Gran Guerra del Norte", "Guerra de Sucesión Austriaca", "Batalla de Fontenoy (1745)", "Guerra de los Siete Años (Considerada la 1ª Guerra Mundial)", "Batalla de Plassey (1757)", "Batalla de Quebec (1759)", "Guerra de Independencia de EEUU", "Batalla de Saratoga (1777)", "Batalla de Yorktown (1781)", "Revolución Francesa (Fase bélica)", "Guerras Revolucionarias Francesas", "Batalla de Valmy (1792)", "Batalla de Jemappes (1792)", "Batalla del Nilo (1798)",
            // Era Napoleónica
            "Guerras Napoleónicas (General)", "Batalla de Marengo (1800)", "Batalla de Trafalgar (1805)", "Batalla de Austerlitz (1805)", "Batalla de Jena-Auerstedt (1806)", "Batalla de Eylau (1807)", "Batalla de Friedland (1807)", "Guerra de la Independencia Española (Peninsular War)", "Batalla de Bailén (1808)", "Batalla de Wagram (1809)", "Invasión Napoleónica de Rusia (1812)", "Batalla de Borodinó (1812)", "Batalla de Leipzig (Batalla de las Naciones) (1813)", "Campaña de los Seis Días (1814)", "Los Cien Días", "Batalla de Waterloo (1815)",
            // Siglo XIX (Post-Napoleón)
            "Guerras de Independencia Hispanoamericanas", "Batalla de Ayacucho (1824)", "Guerra de Independencia Griega", "Batalla de Navarino (1827)", "Guerras del Opio (China)", "Guerras Carlistas (España)", "Guerra de Crimea", "Batalla de Balaclava (Carga Ligera) (1854)", "Sitio de Sebastopol (1854-1855)", "Rebelión de la India de 1857 (Sepoy Mutiny)", "Guerras de la Unificación Italiana (Risorgimento)", "Batalla de Solferino (1859)", "Guerra Civil Estadounidense", "Batalla de Gettysburg (1863)", "Batalla de Vicksburg (1863)", "Marcha de Sherman hacia el Mar", "Rendición de Appomattox (1865)", "Guerra Austro-Prusiana", "Batalla de Sadowa/Königgrätz (1866)", "Guerra Franco-Prusiana", "Batalla de Sedán (1870)", "Sitio de París (1870-1871)", "Guerra del Pacífico (Chile, Perú, Bolivia)", "Batalla de Iquique (1879)", "Batalla de Arica (1880)", "Guerras Zulúes", "Batalla de Isandlwana (1879)", "Batalla de Rorke's Drift (1879)", "Guerras Bóer", "Guerra Ruso-Japonesa", "Batalla de Tsushima (1905)",
            // Guerras Mundiales y Entreguerras
            "Primera Guerra Mundial (General)", "Batalla del Marne (1914)", "Batalla de Tannenberg (1914)", "Batalla de Galípoli (1915)", "Batalla de Verdún (1916)", "Batalla del Somme (1916)", "Batalla de Jutlandia (1916)", "Ofensiva Brusilov (1916)", "Batalla de Passchendaele (1917)", "Ofensiva de Primavera (Ludendorff) (1918)", "Ofensiva de los Cien Días (1918)", "Revolución Rusa y Guerra Civil Rusa", "Guerra Polaco-Soviética", "Batalla de Varsovia (1920)", "Guerra Civil Española", "Batalla de Madrid", "Batalla del Ebro", "Bombardeo de Guernica", "Segunda Guerra Ítalo-Etíope", "Segunda Guerra Sino-Japonesa", "Masacre de Nankín",
            // Segunda Guerra Mundial - Europa y África
            "Segunda Guerra Mundial (General - Europa)", "Invasión de Polonia (1939)", "Guerra de Invierno (Finlandia vs URSS)", "Batalla de Francia (1940)", "Evacuación de Dunkerque", "Batalla de Inglaterra (1940)", "Guerra del Desierto (Norte de África)", "Batalla de El Alamein (1942)", "Operación Barbarroja (Invasión de la URSS) (1941)", "Batalla de Moscú (1941)", "Sitio de Leningrado", "Batalla de Stalingrado (1942-1943)", "Batalla de Kursk (1943)", "Operación Torch (Desembarco Aliado en África)", "Campaña de Italia", "Batalla de Montecassino", "Desembarco de Normandía (Día D) (1944)", "Operación Bagration (1944)", "Operación Market Garden (1944)", "Batalla de las Ardenas (1944-1945)", "Batalla de Berlín (1945)",
            // Segunda Guerra Mundial - Pacífico y Asia
            "Segunda Guerra Mundial (General - Pacífico)", "Ataque a Pearl Harbor (1941)", "Batalla de Singapur (1942)", "Batalla del Mar del Coral (1942)", "Batalla de Midway (1942)", "Campaña de Guadalcanal (1942-1943)", "Batalla del Golfo de Leyte (1944)", "Batalla de Iwo Jima (1945)", "Batalla de Okinawa (1945)", "Bombardeos Atómicos de Hiroshima y Nagasaki (1945)", "Campaña de Birmania",
            // Guerra Fría y Post-Guerra Fría
            "Guerra Civil China (Fase final)", "Guerra de Corea", "Batalla del Embalse de Chosin", "Desembarco de Incheon", "Primera Guerra de Indochina", "Batalla de Dien Bien Phu (1954)", "Crisis de Suez (1956)", "Revolución Húngara de 1956", "Guerra de Vietnam", "Ofensiva del Tet (1968)", "Caída de Saigón (1975)", "Guerra de los Seis Días (1967)", "Guerra de Yom Kipur (1973)", "Invasión Soviética de Afganistán", "Guerra Irán-Irak", "Guerra de las Malvinas/Falklands (1982)", "Invasión de Granada (1983)", "Invasión de Panamá (1989)", "Guerra del Golfo (1990-1991)", "Operación Tormenta del Desierto", "Guerras Yugoslavas", "Sitio de Sarajevo", "Masacre de Srebrenica", "Guerra de Bosnia", "Guerra de Kosovo", "Guerra Civil Ruandesa (Genocidio)", "Primera Guerra del Congo", "Segunda Guerra del Congo",
            // Siglo XXI
            "Guerra de Afganistán (2001-2021)", "Guerra de Irak (2003-2011)", "Segunda Batalla de Faluya (2004)", "Guerra del Líbano de 2006", "Guerra Civil Siria", "Batalla de Alepo (Siria)", "Intervención militar en Libia (2011)", "Guerra de Donbás (Ucrania, 2014-)", "Guerra Civil Yemení (2015-)", "Guerra de Nagorno-Karabaj (2020)", "Invasión Rusa de Ucrania (2022-)", "Batalla de Kiev (2022)", "Batalla de Mariúpol (2022)", "Batalla de Bajmut",
            // Conceptos y Tipos de Guerra
            "Guerra de Guerrillas", "Guerra Asimétrica", "Guerra Total", "Guerra Fría (Concepto)", "Guerra Nuclear (Concepto)", "Guerra Química/Biológica", "Guerra Cibernética", "Guerra de Desgaste", "Blitzkrieg (Guerra Relámpago)", "Guerra de Trincheras", "Guerra Naval (Tácticas)", "Guerra Anfibia", "Guerra de Asedio", "Revolución Militar", "Mercenarios en la Historia", "Niños Soldado", "Crímenes de Guerra", "Tratados de Paz Significativos", "Impacto de la Tecnología en la Guerra", "Logística Militar a través de la Historia", "El Papel de la Propaganda en la Guerra", "Estrategia y Táctica Militar", "Moral y Psicología en Combate",
        ];
        const historicalConflictThemes = [ // Temas para "Generar Más"
            "batallas de la antigüedad clásica", "guerras civiles romanas", "las cruzadas", "guerra de los cien años",
            "conquistas mongolas", "guerras de religión europeas", "guerra de los treinta años", "guerras napoleónicas",
            "unificación alemana e italiana", "guerra civil estadounidense", "colonialismo y guerras imperiales",
            "primera guerra mundial (frente occidental)", "primera guerra mundial (frente oriental)", "guerra civil rusa",
            "guerra civil española", "segunda guerra mundial (frente europeo)", "segunda guerra mundial (frente del pacífico)",
            "guerra fría (conflictos proxy)", "guerra de corea", "guerra de vietnam", "conflictos árabe-israelíes",
            "guerras de descolonización", "guerras yugoslavas", "conflictos en el Cáucaso", "guerra contra el terrorismo",
            "batallas navales famosas", "grandes asedios de la historia", "guerras civiles en Asia", "guerras civiles en África",
            "revoluciones armadas", "conflictos fronterizos modernos"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral", // Puedes probar otros modelos si Mistral no da buenos resultados históricos
            systemPrompt: "Eres un historiador militar experto y catedrático, especializado en el análisis detallado de conflictos bélicos. Describe la guerra, batalla o evento militar indicado de forma rigurosa y académica. Incluye: Contexto histórico (causas, periodo), beligerantes principales y sus líderes, objetivos estratégicos, desarrollo clave del conflicto/batalla (fases, tácticas importantes, puntos de inflexión), tecnologías o armamentos relevantes, resultado y consecuencias (políticas, sociales, militares), cifras estimadas (bajas, si hay datos fiables), y su significado histórico general. Utiliza un lenguaje formal, objetivo y preciso. El objetivo es un análisis detallado de aproximadamente 1200-1300 palabras. Basa tu análisis únicamente en el siguiente evento histórico:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente de historiador militar, especializado únicamente en el evento (guerra o batalla) que se está visualizando. Responde preguntas de seguimiento sobre detalles específicos, personajes, tácticas, consecuencias o aspectos mencionados en la descripción principal. Sé preciso, conciso y mantente estrictamente dentro del contexto del evento histórico actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de índices para una enciclopedia de historia militar. Genera exactamente 15 nombres de guerras, batallas, campañas militares o conflictos significativos de diferentes épocas y regiones de la historia mundial. Devuelve *solo* la lista de nombres/eventos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        // (Identicos a la versión anterior, asegurándose de que todos existen)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Área scrollable texto+imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div para texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentEventTitle = null; // Guarda el contexto histórico actual para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             // Dynamic System Prompt for Chat
             const systemPromptToUse = isChat && currentEventTitle
                 ? `Actúa como un asistente de historiador militar, especializado únicamente en el evento '${currentEventTitle}'. Responde preguntas de seguimiento sobre detalles específicos, personajes, tácticas, consecuencias o aspectos mencionados en la descripción principal. Sé preciso, conciso y mantente estrictamente dentro del contexto del evento histórico actual.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, por favor intenta en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o seleccionar otro evento.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(eventTitle) {
            return fetchTextFromApi(eventTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentEventTitle) throw new Error("Error interno: No se ha establecido el contexto histórico para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(historicalConflictThemes) || "guerras importantes de la historia";
            const specificPrompt = `Genera 15 nombres de guerras, batallas o conflictos relacionados con ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de eventos históricos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a Historia
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 550, nologo: true }; // Ratio más panorámico
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "historical battle scene";
            // Prompt enfocado en arte/ilustración histórica
            const enhancedPrompt = `Historical painting, dramatic illustration, or conceptual artwork representing the '${safePromptText}'. Focus on the era's atmosphere, key elements (soldiers, terrain, ships, key moment). Style: classical painting, historical illustration, epic cinematic. Avoid text, labels, maps, diagrams.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, graphs, charts, diagrams, map, flag, modern elements, photograph, 3D render, cartoon, watermark, signature, blurry, low quality, multiple panels";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            // No esperamos fórmulas matemáticas complejas aquí, así que simplificamos
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); // Títulos H1 dentro del texto
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Negrita
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');     // Cursiva

            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h')) return block; // Dejar encabezados como están
                let content = block.replace(/\n/g, ' '); // Reemplazar saltos internos con espacio
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0; // Reset scroll del área de texto
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentEventTitle = null; // Reset chat context
             hideFullscreenImage(); // Asegurar que la imagen ampliada se cierre
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios lógicos)
        function addChatMessage(message, sender) { /* ... */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        // No es necesario shuffle si ordenamos alfabéticamente
        // function shuffleArray(array) { /* ... */ }
        function createTitleItem(title) { /* ... */
            const div = document.createElement('div');
            div.className = 'title-item';
            div.textContent = title;
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar alfabéticamente para facilitar la búsqueda visual
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-600 col-span-full text-center font-serif">» No hay eventos históricos registrados. «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             const uniqueNewTitles = newTitles.filter(title => !existingTitles.has(title));
             // Añadir y luego reordenar todo alfabéticamente? O solo añadir al final?
             // Opción 1: Añadir al final y re-aplicar filtro
             uniqueNewTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
             filterTitles(searchInput.value);
             // Opción 2: Reconstruir toda la lista ordenada (puede ser más lento si hay muchos ítems)
             /*
             const allTitles = Array.from(titleListContainer.querySelectorAll('.title-item'))
                                   .map(item => item.dataset.title)
                                   .concat(uniqueNewTitles)
                                   .sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             displayTitles(allTitles);
             filterTitles(searchInput.value); // Reaplicar filtro
             */
         }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentEventTitle = title; // SET CHAT CONTEXT
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation; // Add text
                modalStoryContentArea.classList.remove('content-hidden'); // Show content area

                modalTextArea.scrollTop = 0; // Reset scroll for the text area
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder INSIDE modalContent (at the end)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-landmark placeholder-icon"></i> <!-- Icono histórico -->
                    <p style="font-size: 0.8em; margin-top: 0.8rem;">Generando representación visual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación visual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.8rem;">No se pudo cargar la imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append image to the text content
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.8rem;">Error al generar URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el evento.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden'); // Ocultar chat si falla la carga principal
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando en los archivos...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se encontraron más conflictos relevantes en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar más conflictos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Conflictos';
             }
         }

        // Search Filter Function - Incluye normalización para tildes/mayúsculas
        function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Oculta si hay resultados o si la lista está vacía inicialmente
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check essential elements
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalTextArea) {
                console.error("Initialization failed: Missing essential UI elements.");
                document.body.innerHTML = '<p style="color: #800000; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: serif;">Error Crítico: No se pudieron inicializar los componentes de la crónica.</p>';
                return;
             }
            // Event listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Set current year in footer dynamically
            const currentYear = new Date().getFullYear();
            const footerText = document.querySelector("footer p:last-child");
            if (footerText) {
                footerText.textContent = `© ${currentYear} Crónicas Bélicas Interactivas`;
            }

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>