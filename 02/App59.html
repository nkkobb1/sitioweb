<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glosario Jurídico - Derecho Penal</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Derecho Penal --- */
        :root {
            --color-primary: #1e3a8a; /* Azul Oscuro (Seriedad) */
            --color-secondary: #4b5563; /* Gris (Neutralidad) */
            --color-background: #f8f9fa; /* Blanco Hueso/Gris muy claro */
            --color-text: #1f2937; /* Gris Oscuro (Texto Principal) */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff;
            --color-border: #dee2e6; /* Borde más definido */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 4px; /* Bordes más rectos */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); }
        /* Usar Merriweather para títulos para dar un toque clásico/formal */
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alinear a la izquierda para términos legales */ font-weight: 400; font-family: 'Lato', sans-serif; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 60px; }
        .title-item i { margin-right: 0.75rem; color: var(--color-secondary); width: 18px; text-align: center;}
        .title-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); }
        .title-item:hover i { color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1e40af; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem 2rem; max-width: 900px; width: 95%; max-height: 90vh; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e5e7eb; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1.3rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #d1d5db; color: var(--color-text); }
        #modal-title { font-family: 'Merriweather', serif; color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; font-size: 1.6rem; border-bottom: 1px solid var(--color-border); padding-bottom: 1rem; }
        /* Ajustar estilos del contenido modal */
        #modal-content { font-family: 'Lato', sans-serif; line-height: 1.8; color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 10px; flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); font-size: 1rem; /* Tamaño base texto */ }
        #modal-content::-webkit-scrollbar { width: 8px; }
        #modal-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid #f1f1f1; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: bold; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.2em; color: #1e3a8a; } /* Subtítulos también en azul */
        #modal-content h4 { font-size: 1.1em; color: var(--color-secondary); border-bottom: none; } /* H4 más sutil */
        /* Estilo para fórmulas (menos común aquí, pero mantenido) */
        #modal-content .formula { text-align: center; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 1em; padding: 0.8em; margin: 1.2em 0; border: 1px solid var(--color-border); background-color: #f8f9fa; border-radius: var(--border-radius); overflow-x: auto; white-space: nowrap; }
        #modal-content .formula sub, #modal-content .formula sup { font-size: 0.8em; line-height: 0; position: relative; vertical-align: baseline; }
        #modal-content .formula sub { top: 0.5em; }
        #modal-content .formula sup { top: -0.5em; }
        /* Contenedor de imagen (igual lógica, icono diferente) */
        #modal-image-container { width: 100%; height: 240px; background-color: #e9ecef; border-radius: var(--border-radius); overflow: hidden; display: none; /* Start hidden */ align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; margin-top: 1rem; }
        #modal-image-container.visible { display: flex; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 3rem; color: var(--color-border); display: none; }
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-family: 'Lato', sans-serif; font-weight: 600; color: var(--color-text); font-size: 1.1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #f8d7da; color: #721c24; padding: 1rem; border-radius: var(--border-radius); border: 1px solid #f5c6cb; margin-top: 1rem; text-align: center; flex-shrink: 0; }
        .error-msg i { margin-right: 0.5rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
    <!-- Header/Navbar -->
    <nav class="navbar mb-10">
        <div class="container mx-auto px-4 py-4 flex justify-center items-center">
            <div class="flex items-center">
                <h1 class="logo text-2xl sm:text-3xl">
                    <i class="fas fa-balance-scale-right mr-3"></i> Glosario Jurídico Penal
                </h1>
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <main class="container mx-auto px-4 pb-16">
        <!-- Hero section -->
        <section class="mb-12 text-center">
            <h1 class="page-title text-4xl sm:text-5xl mb-4">Entendiendo el Derecho Penal</h1>
            <p class="text-xl text-gray-600 mb-8 max-w-4xl mx-auto">Definiciones claras y concisas de los conceptos fundamentales del Derecho Penal, generadas por IA para facilitar su comprensión. Selecciona un término.</p>
        </section>

        <!-- Title List Container -->
        <section class="mb-10">
            <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                <i class="fas fa-gavel text-gray-600 mr-2"></i>
                Términos a Definir
            </h2>
            <div id="title-list">
                 <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Consultando códigos...</p>
                 <!-- Title items will be injected here -->
            </div>
            <div id="generate-more-container" class="text-center mt-10">
                <button id="generate-more-btn">
                     <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                    Generar Más Términos
                 </button>
            </div>
        </section>

    </main>

    <!-- Explanation Modal -->
    <div id="story-modal">
        <div class="modal-content-wrapper">
            <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

            <!-- Loading Indicator -->
            <div id="modal-loading">
                <div class="loading-spinner-modal"></div>
                <p>Analizando definición...</p>
            </div>

            <!-- Content Area -->
            <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                <!-- Text Content (Scrollable) -->
                <div id="modal-content" class="text-base">
                    <!-- Explanation text (HTML) goes here -->
                </div>
                 <!-- Image Container (Initially Hidden) -->
                <div id="modal-image-container">
                    <div class="spinner"></div>
                    <i class="fas fa-landmark placeholder-icon"></i> <!-- Placeholder icon (e.g., courthouse) -->
                    <img id="modal-image" alt="Visualización abstracta del concepto legal" />
                </div>
                 <!-- Error Display Area -->
                <div id="modal-error" class="error-msg content-hidden">
                     <i class="fas fa-exclamation-triangle"></i>
                     <span id="modal-error-message"></span>
                 </div>
            </div>
         </div>
     </div>

     <!-- Footer -->
     <footer class="bg-gray-100 text-gray-600 py-5 mt-12 border-t border-gray-200">
         <div class="container mx-auto px-4 text-center text-sm">
             <p>Definiciones generadas por IA como herramienta introductoria. El Derecho Penal es complejo y requiere estudio profundo y consulta profesional.</p>
             <p class="mt-1">© 2025 Glosario Jurídico Penal</p>
         </div>
     </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [ // Ampliada a ~400 términos
            "Acción Penal", "Acusación", "Agravantes", "Alevosía", "Allanamiento de Morada", "Amenazas", "Amnistía", "Antijuridicidad", "Apelación", "Apropiación Indebida", "Archivo (de la causa)", "Arresto Domiciliario", "Asesinato", "Asistencia Letrada", "Atenuantes", "Audiencia Preliminar", "Audiencia Pública", "Autoría (Directa, Mediata)", "Auto de Procesamiento", "Beneficios Penitenciarios", "Bien Jurídico Protegido", "Blanqueo de Capitales", "Buena Fe", "Calumnia", "Capacidad de Culpabilidad", "Carga de la Prueba", "Casación", "Causa de Justificación", "Causa de Inimputabilidad", "Citación Judicial", "Coacción", "Coautoría", "Cohecho (Activo, Pasivo)", "Comiso", "Competencia (Judicial)", "Cómplice", "Concurso de Delitos (Real, Ideal, Medial)", "Concurso de Leyes", "Condena Condicional", "Confesión", "Consentimiento del Ofendido", "Consumación del Delito", "Contrabando", "Cooperador Necesario", "Corrupción", "Cosa Juzgada", "Costas Procesales", "Criminalidad Organizada", "Cuerpo del Delito", "Culpa (Negligencia, Imprudencia)", "Culpabilidad", "Custodia", "Daños", "Declaración del Imputado/Acusado", "Decomiso", "Defensa (Material, Técnica)", "Defensa Propia (Legítima Defensa)", "Delación Premiada", "Delito", "Delito Continuado", "Delito de Comisión por Omisión", "Delito de Cuello Blanco", "Delito de Flagrancia", "Delito de Lesa Humanidad", "Delito de Mano Propia", "Delito de Mera Actividad", "Delito de Odio", "Delito de Omisión (Propia, Impropia)", "Delito de Peligro (Concreto, Abstracto)", "Delito de Resultado", "Delito Doloso", "Delito Fiscal", "Delito Imposible (Tentativa Inidónea)", "Delito Informático", "Delito Leve (Falta)", "Delito Político", "Delito Preterintencional", "Delito Privado", "Delito Propio", "Delito Público", "Delito Semipúblico", "Delito Societario", "Denegación de Auxilio", "Denuncia", "Derecho a la Intimidad", "Derecho a la Presunción de Inocencia", "Derecho a No Declarar Contra Sí Mismo", "Derecho a un Juicio Justo", "Derecho de Defensa", "Derecho Penal del Enemigo", "Derecho Penal Internacional", "Derecho Procesal Penal", "Desacato", "Descubrimiento y Revelación de Secretos", "Desistimiento (en la tentativa)", "Desobediencia", "Detención Ilegal", "Detención Preventiva", "Diligencias Previas", "Diligencias Urgentes", "Dolo (Directo, Eventual)", "Domicilio", "Duda Razonable (In dubio pro reo)", "Encubrimiento", "Engaño", "Ensañamiento", "Error de Prohibición", "Error de Tipo", "Escritos de Calificación (Acusación y Defensa)", "Espionaje", "Estado de Necesidad", "Estafa", "Estragos", "Excarcelación", "Excusas Absolutorias", "Exención de Responsabilidad Penal", "Exhorto", "Extinción de la Responsabilidad Penal", "Extorsión", "Extradición", "Falsedad Documental", "Falso Testimonio", "Fianza", "Fiscalía (Ministerio Público)", "Flagrancia", "Fraude", "Fuerza Mayor", "Funcionario Público", "Genocidio", "Grados de Participación", "Grados del Delito (Consumado, Tentativa)", "Habeas Corpus", "Hecho Punible", "Homicidio (Simple, Calificado)", "Hurto (Simple, Agravado)", "Imparcialidad Judicial", "Impedimento", "Imposición de Penas", "Imprescriptibilidad", "Imprudencia (Grave, Leve)", "Imputabilidad", "Imputado", "Incomparecencia", "Incomunicación", "Incongruencia (en sentencia)", "Indemnización de Perjuicios", "Indications Racionales de Criminalidad", "Indulto", "Inhabilitación (Absoluta, Especial)", "Inimputabilidad", "Injuria", "Inmediación (Principio Procesal)", "Inmunidad", "Instigador", "Instrucción (Fase Procesal)", "Insulto", "Intercepción de Comunicaciones", "Interés Superior del Menor", "Interpretación de la Ley Penal", "Interrogatorio", "Intimidación", "Inviolabilidad del Domicilio", "Iter Criminis (Camino del Delito)", "Juez de Garantías", "Juez de Instrucción", "Juez de Paz", "Juez Natural", "Juicio Abreviado", "Juicio de Faltas", "Juicio Oral", "Juicio por Jurado", "Jurisdicción", "Jurisprudencia", "Justicia Restaurativa", "Legalidad (Principio de)", "Legítima Defensa", "Lesiones (Graves, Leves)", "Levantamiento del Cadáver", "Ley Orgánica", "Ley Penal en Blanco", "Ley Penal Especial", "Libertad Condicional", "Libertad Provisional", "Libertad Vigilada", "Lugar del Delito", "Malos Tratos", "Malversación de Caudales Públicos", "Mandamiento Judicial", "Manifestación", "Medidas Cautelares (Personales, Reales)", "Medidas de Seguridad", "Medidas Paternofiliales", "Mediación Penal", "Menor de Edad Penal", "Ministerio Fiscal", "Motivación de las Resoluciones Judiciales", "Multa", "Negligencia", "Ne bis in idem (Non bis in idem)", "Notificación", "Nulidad (Procesal)", "Objeto del Delito", "Obligación de Declarar", "Obstrucción a la Justicia", "Ofendido", "Omisión del Deber de Socorro", "Oralidad (Principio Procesal)", "Orden de Alejamiento", "Orden de Protección", "Organización Criminal", "Parte Civil", "Participación (Autoría, Complicidad, Inducción)", "Peculado", "Pena", "Pena Accesoria", "Pena Capital (Pena de Muerte)", "Pena de Localización Permanente", "Pena de Prisión", "Pena Pecuniaria", "Penalidad", "Pericia (Prueba Pericial)", "Perito", "Perjurio", "Permiso Penitenciario", "Persecución Penal", "Persona Jurídica (Responsabilidad Penal)", "Pertenencia a Grupo Criminal", "Plazo Razonable", "Plenos Poderes", "Pluralidad de Intervinientes", "Poder Judicial", "Policía Judicial", "Política Criminal", "Polígrafo", "Porte Ilegal de Armas", "Premeditación", "Prescripción (del Delito, de la Pena)", "Presunción de Inocencia", "Prevaricación (Judicial, Administrativa)", "Principio Acusatorio", "Principio de Culpabilidad", "Principio de Igualdad", "Principio de Intervención Mínima", "Principio de Irretroactividad", "Principio de Legalidad Penal", "Principio de Lesividad (Ofensividad)", "Principio de Oportunidad", "Principio de Proporcionalidad", "Principio de Publicidad", "Principio In Dubio Pro Reo", "Prisión Permanente Revisable", "Prisión Preventiva", "Privación de Libertad", "Procedimiento Abreviado", "Procedimiento Ordinario", "Procesado", "Proceso Debido", "Prohibición de Acercamiento", "Prohibición de Comunicación", "Prohibición de Residir en Ciertos Lugares", "Prohibición de Salir del Territorio Nacional", "Pronunciamiento sobre Costas", "Proporcionalidad de la Pena", "Proposición de Prueba", "Prórroga de Competencia", "Protección de Testigos", "Prostitución", "Provocación al Delito", "Prueba (Documental, Testifical, Pericial, Indiciaria)", "Prueba Anticipada", "Prueba Ilícita", "Prueba Preconstituida", "Publicidad del Juicio", "Puesta a Disposición Judicial", "Punto Final (Ley de)", "Querella", "Querellante", "Rebeldía", "Receptación", "Reclusión", "Reconocimiento en Rueda", "Reconocimiento Médico Forense", "Reconstrucción de Hechos", "Recurso de Amparo", "Recurso de Apelación", "Recurso de Casación", "Recurso de Queja", "Recurso de Reforma", "Recurso de Súplica", "Recusación", "Redención de Penas por el Trabajo", "Registro Domiciliario", "Registro Personal", "Reglas de Exclusión Probatoria", "Rehabilitación", "Reincidencia", "Relación de Causalidad", "Remisión Condicional de la Pena", "Reparación del Daño", "Representación (Legal)", "Requisa", "Resarcimiento", "Reserva de Ley", "Resistencia a la Autoridad", "Resolución Judicial (Auto, Sentencia)", "Responsabilidad Civil Derivada del Delito", "Responsabilidad Penal", "Responsabilidad Penal de Menores", "Responsabilidad Penal de Personas Jurídicas", "Retención", "Retroactividad (de la Ley Penal Favorable)", "Revisión de Sentencia Firme", "Robo (con Fuerza, con Violencia o Intimidación)", "Rueda de Reconocimiento", "Salud Pública (Delitos contra)", "Sanción", "Secreto de Sumario", "Secuestro", "Sedition", "Segunda Instancia", "Seguridad Colectiva", "Seguridad Vial (Delitos contra)", "Sentencia (Absolutoria, Condenatoria)", "Sentencia Firme", "Simulación de Delito", "Sistema Penitenciario", "Soborno", "Sobreseimiento (Libre, Provisional)", "Societas delinquere non potest", "Subrogación", "Subtipo Agravado / Atenuado", "Sujeto Activo / Pasivo del Delito", "Sumario", "Suspensión de la Ejecución de la Pena", "Sustracción de Menores", "Taxatividad Penal", "Tenencia Ilícita de Armas", "Tentativa (Acabada, Inacabada)", "Tercer Grado Penitenciario", "Territorialidad (Principio de)", "Testifical (Prueba)", "Testigo", "Testigo Protegido", "Tiempo del Delito", "Tipicidad", "Tipo Penal", "Titularidad del Bien Jurídico", "Tortura", "Trabajos en Beneficio de la Comunidad", "Tracto Sucesivo", "Tráfico de Drogas", "Tráfico de Influencias", "Traición", "Trámite de Audiencia", "Tratados Internacionales", "Tribunal", "Tribunal Constitucional", "Tribunal del Jurado", "Tribunal Supremo", "Tutela Judicial Efectiva", "Ultima Ratio (Derecho Penal como)", "Unidad de Acto", "Us Puniendi (Derecho a Castigar del Estado)", "Usura", "Utilidad de la Pena", "Validez de la Ley Penal", "Valoración de la Prueba", "Vandalismo", "Vehículo (Hurto/Robo de Uso)", "Veredicto", "Víctima", "Victimología", "Violación", "Violación de Domicilio", "Violencia de Género", "Violencia Doméstica", "Vista Oral", "Voto Particular", "Vulnerabilidad", "Zona de Exclusión"
        ];
        const lawThemes = [ // Temas para generación
            "principios fundamentales del derecho penal", "teoría general del delito", "formas de autoría y participación", "circunstancias modificativas de la responsabilidad", "delitos contra la vida y la integridad física", "delitos contra el patrimonio", "delitos contra la libertad", "delitos contra el honor", "delitos contra la administración pública", "derecho procesal penal básico", "fases del proceso penal", "tipos de penas", "medidas de seguridad", "derecho penitenciario", "delitos económicos", "delitos societarios", "responsabilidad penal de menores", "responsabilidad penal de personas jurídicas", "delitos contra la seguridad vial", "delitos informáticos", "derecho penal internacional", "violencia de género", "delitos contra la salud pública", "pruebas en el proceso penal", "recursos en el proceso penal", "extinción de la responsabilidad penal"
        ];
        // CONFIGURACIÓN DE API AMPLIADA
        const textApiConfig = {
            model: "mistral", // O el modelo que prefieras/funcione mejor
            systemPrompt: "Eres un jurista experto en Derecho Penal y un excelente divulgador. Tu tarea es definir y explicar conceptos y términos de Derecho Penal de forma muy clara, precisa, estructurada y detallada para estudiantes de derecho o público interesado. Utiliza lenguaje jurídico apropiado pero explica los tecnicismos. Si es posible, menciona principios relacionados o incluye ejemplos hipotéticos muy breves y sencillos para ilustrar. Estructura la explicación lógicamente usando párrafos y sub-títulos (usando markdown como #, ##, ### o ####). El objetivo es una definición/explicación completa y rigurosa pero comprensible de unas 1200-1300 palabras. Basa tu explicación únicamente en el siguiente término/concepto:",
            timeoutSeconds: 150 // Mayor tiempo de espera
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso. Genera exactamente 15 términos o conceptos clave sobre Derecho Penal, adecuados para ser definidos en un glosario. Devuelve *solo* la lista de términos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 45 // Un poco más de tiempo si la generación es compleja
        };

        // ========== DOM ELEMENTS ========== (sin cambios)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // --- Variable para el listener de scroll (sin cambios) ---
        let currentScrollHandler = null;

        // ========== API FUNCTIONS ========== (sin cambios en lógica, solo usa nuevas configs)
        async function fetchTextFromApi(prompt, config) {
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 150)}...`); // Log recortado
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 // Validación de longitud mínima AUMENTADA
                 if (config === textApiConfig && text.trim().length < 900) {
                     console.warn(`Respuesta corta (${text.trim().length} chars), podría ser insuficiente.`);
                     // Opcional: throw new Error("La explicación generada es demasiado corta.");
                 }
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
             }
         }
        async function fetchExplanationText(conceptTitle) {
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              if (text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo ayudarte con eso")) { // Añadir checks por si la IA se niega
                   throw new Error("La IA no pudo generar una explicación adecuada para este término.");
               }
             return text;
         }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(lawThemes) || "teoría general del delito";
             const specificPrompt = `Genera 15 términos o conceptos clave sobre ${randomTheme} en Derecho Penal`;
             console.log("Generating concepts with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 100); // Ajustar filtro si es necesario
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de términos.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "legal concept abstract";
             // Prompt de imagen enfocado en abstracción legal/justicia
             const enhancedPrompt = `Abstract conceptual visualization related to the legal or justice concept of '${safePromptText}', symbolic representation, minimalist style, focus on balance, structure, rules, or conflict resolution, serious tone`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Negative prompt para evitar elementos no deseados
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, equations, charts, graphs, diagrams, specific legal symbols like gavels or scales unless highly stylized, documents, books, papers, person, people, courtroom interior, realistic photo, specific flags, police, handcuffs, prison bars";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url.substring(0, 200) + '...'); // Log recortado
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−])\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); // Corregido: Acepta signo +/-
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Lógica de scroll y listener intacta)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll on hide
            console.log("Scroll set to 0 on hideModal");
            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
                console.log("Scroll listener removed on hideModal.");
            }
            resetModalState();
        }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.classList.remove('visible');
             modalImageContainer.style.display = 'none';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (Lógica de scroll y listener intacta)
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        // Añadir icono a los items de título
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // Añadir un icono genérico o basado en alguna categoría si fuese posible
            const icon = document.createElement('i');
            icon.className = 'fas fa-book-open'; // Icono genérico para término
            div.appendChild(icon);
            const textSpan = document.createElement('span');
            textSpan.textContent = title;
            div.appendChild(textSpan);
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }
        function displayTitles(titles) {
            if (!titleListContainer || !titlesLoading) return;
            const shuffledTitles = shuffleArray([...titles]);
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay términos disponibles.</p>'; return; }
            shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        async function handleTitleClick(title) { // Lógica de scroll reset y listener intacta
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalImageContainer.style.display = 'none';
            modalImageContainer.classList.remove('visible');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
            }

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.scrollTop = 0; // <<<--- RESET SCROLL HERE
                console.log("Scroll set to 0 after content visible");

                modalImageSpinner.style.display = 'block';
                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                     modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                     modalImage.src = imageUrl;
                 } else { console.error("Could not create image URL:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; }

                const scrollBuffer = 20; // Umbral para mostrar imagen
                currentScrollHandler = () => {
                    if (modalContent.scrollHeight <= modalContent.clientHeight + 5) { // +5 para margen de error
                         console.log("Content fits, showing image immediately.");
                         modalImageContainer.classList.add('visible');
                         modalImageContainer.style.display = 'flex';
                         modalContent.removeEventListener('scroll', currentScrollHandler);
                         currentScrollHandler = null;
                    } else if ((modalContent.scrollTop + modalContent.clientHeight) >= (modalContent.scrollHeight - scrollBuffer)) {
                        console.log("Scroll end reached, showing image.");
                        modalImageContainer.classList.add('visible');
                        modalImageContainer.style.display = 'flex';
                        modalContent.removeEventListener('scroll', currentScrollHandler);
                        currentScrollHandler = null;
                        console.log("Scroll listener removed after showing image.");
                    }
                };
                modalContent.addEventListener('scroll', currentScrollHandler);
                console.log("Scroll listener added.");
                 setTimeout(currentScrollHandler, 150); // Check inicial

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error al cargar definición: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalImageContainer.style.display = 'none';
                modalContent.innerHTML = '';
                 if (currentScrollHandler) {
                    modalContent.removeEventListener('scroll', currentScrollHandler);
                    currentScrollHandler = null;
                 }
            }
        }

        async function handleGenerateMoreTitles() { // Sin cambios en lógica
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se pudieron generar nuevos términos en este momento."); }
             } catch (error) { console.error("Failed generation:", error); alert(`Error al generar términos: ${error.message}`);
             } finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Términos'; }
         }

        // ========== INITIALIZATION ========== (sin cambios)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p>Error crítico al inicializar la aplicación.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles); // Carga los 400 títulos iniciales
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>