<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conceptos de Dinero - Guía Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Profesionales/Limpias -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Conceptos de Dinero --- */
        :root {
            --color-primary: #16a34a; /* Verde (Crecimiento, Dinero) */
            --color-secondary: #ca8a04; /* Dorado/Mostaza (Valor, Riqueza) */
            --color-tertiary: #2563eb; /* Azul (Confianza, Estabilidad) */
            --color-background: #f8fafc; /* Blanco Hueso / Gris muy claro */
            --color-text: #334155; /* Gris Oscuro Azulado */
            --color-text-muted: #64748b;
            --color-modal-bg: #ffffff; /* Blanco puro para modal */
            --color-border: #e2e8f0; /* Borde gris claro */
            --color-error-bg: #fff1f2; /* Fondo error rosa claro */
            --color-error-text: #be123c; /* Texto error rojo oscuro */
            --color-error-border: #fecdd3; /* Borde error rosa */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 500; } /* Menos bold */
        #modal-title { color: var(--color-tertiary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alinear a la izquierda */ font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f0fdf4; border-left-color: var(--color-primary); }
        .title-item i { margin-right: 0.8rem; color: var(--color-secondary); width: 18px; text-align: center; transition: color 0.2s ease; } /* Icono antes del texto */
        .title-item:hover i { color: var(--color-primary); }

        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #15803d; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(51, 65, 85, 0.85); /* Overlay gris azulado */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Más altura para chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e2e8f0; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.5rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; line-height: 1.7; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-tertiary); font-weight: 700; }
        #modal-content em { color: var(--color-primary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 500; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-md);}
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; background-color: #f9fafb; border-radius: 0 0 var(--border-radius) var(--border-radius); padding: 1rem 1.5rem; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fff; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-tertiary); color: #fff; margin-left: auto; text-align: left; } /* User message blue */
        .ai-message { background-color: #e5e7eb; color: var(--color-text); margin-right: auto; text-align: left; } /* AI message gray */
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.15); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #15803d; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 500; color: var(--color-text); font-size: 1.2rem; font-family: 'Roboto'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(25, 25, 25, 0.92); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-secondary); box-shadow: var(--shadow-lg); border-radius: 4px; }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: white; color: var(--color-primary); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-coins mr-2 text-yellow-500"></i> <!-- Icono monedas -->
                     Conceptos Financieros
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">Guía Interactiva</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Explora el Mundo del Dinero</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Desde conceptos básicos hasta estrategias de inversión complejas. Selecciona un tema o busca para aprender más.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar concepto (ej: inflación, acción, presupuesto)...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-600 mr-2"></i> <!-- Icono libro -->
                 Glosario de Términos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando conceptos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No se encontraron conceptos que coincidan con tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Conceptos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Consultando Información...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom) -->
                 <div id="chat-section">
                     <h3 class="text-sm font-semibold text-gray-600 mb-2 text-center">¿Preguntas sobre "<span id="chat-context-title">este concepto</span>"?</h3>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando consulta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Escribe tu pregunta aquí...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos. No constituye asesoramiento financiero.</p>
              <p class="mt-1">Consulta siempre con un profesional antes de tomar decisiones financieras.</p>
              <p class="mt-2">© 2025 Guía Financiera Interactiva</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // -- Fundamentos --
            "¿Qué es el Dinero?", "Funciones del Dinero (Medio de cambio, Unidad de cuenta, Depósito de valor)", "Tipos de Dinero (Mercancía, Fiat, Fiduciario, Electrónico)", "Moneda vs Divisa", "Trueque y sus limitaciones", "Historia del Dinero (Resumen)", "Valor del Dinero en el Tiempo (TVM)", "Coste de Oportunidad", "Escasez Económica", "Utilidad y Valor",
            // -- Finanzas Personales --
            "Presupuesto Personal", "Ahorro", "Fondo de Emergencia", "Deuda (Buena vs Mala)", "Tarjeta de Crédito", "Tarjeta de Débito", "Puntuación de Crédito (Credit Score)", "Informe de Crédito", "Préstamo Personal", "Préstamo Estudiantil", "Hipoteca", "Refinanciamiento", "Interés Simple", "Interés Compuesto", "Regla del 72", "Planificación Financiera", "Metas Financieras (Corto, Mediano, Largo Plazo)", "Patrimonio Neto (Net Worth)", "Flujo de Caja Personal (Cash Flow)", "Seguro de Vida", "Seguro de Salud", "Seguro de Automóvil", "Seguro de Hogar", "Impuestos sobre la Renta", "Impuestos sobre las Ventas (IVA/Sales Tax)", "Impuesto sobre Bienes Inmuebles (Property Tax)", "Planificación de la Jubilación", "Cuenta de Jubilación Individual (IRA - Tradicional y Roth)", "Plan 401(k) / Planes de Pensiones", "Anualidades", "Testamento y Planificación Patrimonial", "Educación Financiera (Financial Literacy)", "Estafas Financieras Comunes", "Protección contra el Robo de Identidad", "Donaciones y Filantropía", "Minimalismo Financiero", "Independencia Financiera (FIRE Movement)",
            // -- Inversión (Básico) --
            "¿Qué es Invertir?", "Riesgo vs Rendimiento", "Tolerancia al Riesgo", "Diversificación", "Asignación de Activos (Asset Allocation)", "Acciones (Stocks)", "Bonos (Bonds)", "Fondos Mutuos (Mutual Funds)", "Fondos Cotizados (ETFs)", "Bienes Raíces (Real Estate)", "Materias Primas (Commodities)", "Mercado Primario vs Mercado Secundario", "Bolsa de Valores (Stock Exchange)", "Broker (Corredor de Bolsa)", "Dividendos", "Ganancias de Capital (Capital Gains)", "Interés", "Horizonte de Inversión", "Inversión Pasiva vs Activa", "Índice Bursátil (Stock Market Index - S&P 500, Dow Jones, IBEX 35, etc.)", "Mercado Alcista (Bull Market)", "Mercado Bajista (Bear Market)", "Volatilidad", "Inversión a Largo Plazo", "Promedio del Costo en Dólares (Dollar-Cost Averaging - DCA)", "Reinversión de Dividendos (DRIP)", "Robo-Advisors",
            // -- Inversión (Avanzado) --
            "Análisis Fundamental", "Análisis Técnico", "Valor Intrínseco", "Ratio Precio/Beneficio (P/E Ratio)", "Ratio Precio/Valor Contable (P/B Ratio)", "Capitalización de Mercado (Market Cap)", "Acciones de Crecimiento vs Valor (Growth vs Value Stocks)", "Acciones de Pequeña, Mediana y Gran Capitalización", "Bonos del Gobierno vs Corporativos", "Bonos Basura (Junk Bonds)", "Fondos Indexados", "Fondos de Cobertura (Hedge Funds)", "Capital Privado (Private Equity)", "Capital Riesgo (Venture Capital)", "Derivados Financieros", "Opciones (Calls y Puts)", "Futuros", "Swaps", "Venta en Corto (Short Selling)", "Arbitraje", "Inversión Inmobiliaria (Directa vs REITs)", "Crowdfunding Inmobiliario", "Inversión en Metales Preciosos (Oro, Plata)", "Inversión en Arte y Coleccionables", "Inversión de Impacto / ESG (Ambiental, Social y Gobernanza)", "Inversión Temática", "Trading de Alta Frecuencia (HFT)", "Finanzas Conductuales (Behavioral Finance)", "Eventos del Cisne Negro (Black Swan Events)",
            // -- Criptomonedas y Blockchain --
            "¿Qué es Blockchain?", "Criptomoneda", "Bitcoin (BTC)", "Ethereum (ETH)", "Altcoins", "Stablecoins (Monedas Estables)", "Tokens (Fungibles y No Fungibles)", "Tokens No Fungibles (NFTs)", "Minería de Criptomonedas (Proof-of-Work)", "Staking (Proof-of-Stake)", "Billetera de Criptomonedas (Wallet)", "Clave Pública y Privada", "Intercambio de Criptomonedas (Crypto Exchange)", "Finanzas Descentralizadas (DeFi)", "Contratos Inteligentes (Smart Contracts)", "Oferta Inicial de Monedas (ICO)", "Oferta Inicial de Intercambio (IEO)", "Organización Autónoma Descentralizada (DAO)", "Halving de Bitcoin", "Volatilidad de las Criptomonedas", "Regulación de Criptomonedas", "El Futuro de las Criptomonedas", "Web3", "Metaverso y Economía Virtual",
            // -- Economía (Macro) --
            "Macroeconomía vs Microeconomía", "Producto Interior Bruto (PIB / GDP)", "PIB Nominal vs Real", "PIB per cápita", "Crecimiento Económico", "Ciclo Económico (Expansión, Pico, Recesión, Depresión, Valle, Recuperación)", "Inflación", "Deflación", "Estanflación", "Hiperinflación", "Índice de Precios al Consumidor (IPC / CPI)", "Tasa de Interés", "Política Monetaria", "Banco Central (Ej: Reserva Federal, BCE)", "Tasa de Fondos Federales (Fed Funds Rate)", "Operaciones de Mercado Abierto", "Requisitos de Reserva Bancaria", "Tasa de Descuento", "Política Fiscal", "Gasto Público", "Impuestos", "Déficit Presupuestario", "Deuda Pública", "Oferta y Demanda Agregada", "Desempleo (Tasa de Desempleo)", "Tipos de Desempleo (Friccional, Estructural, Cíclico)", "Curva de Phillips", "Comercio Internacional", "Balanza de Pagos", "Tipo de Cambio", "Aranceles", "Globalización", "Ventaja Comparativa", "Indicadores Económicos Adelantados, Coincidentes y Retrasados", "Política Económica", "Escuelas de Pensamiento Económico (Clásica, Keynesiana, Monetarista, Austriaca)",
            // -- Economía (Micro) --
            "Microeconomía", "Ley de la Oferta", "Ley de la Demanda", "Equilibrio de Mercado", "Elasticidad Precio de la Demanda", "Elasticidad Precio de la Oferta", "Excedente del Consumidor", "Excedente del Productor", "Costos de Producción (Fijos, Variables, Totales, Marginales)", "Economías de Escala", "Estructuras de Mercado", "Competencia Perfecta", "Monopolio", "Oligopolio", "Competencia Monopolística", "Externalidades (Positivas y Negativas)", "Bienes Públicos", "Teoría de Juegos", "Información Asimétrica", "Selección Adversa", "Riesgo Moral",
            // -- Banca y Sistema Financiero --
            "Sistema Financiero", "Intermediarios Financieros", "Banca Comercial", "Banca de Inversión", "Cooperativas de Crédito (Credit Unions)", "Banca Central (Funciones)", "Regulación Bancaria (Basilea III, Dodd-Frank)", "Cuenta Corriente", "Cuenta de Ahorros", "Certificado de Depósito (CD)", "Cajero Automático (ATM)", "Banca Online", "Banca Móvil", "Transferencias Bancarias (ACH, Wire)", "SWIFT (Sistema de Pagos Internacionales)", "Préstamos y Créditos Bancarios", "Reserva Fraccionaria", "Multiplicador Bancario", "Crisis Financiera (Ej: 2008)", "Fintech (Tecnología Financiera)", "Neobancos", "Pagos Digitales (PayPal, Stripe, etc.)", "Préstamos Peer-to-Peer (P2P Lending)",
            // -- Negocios y Finanzas Corporativas --
            "Empresa (Tipos: Sole Proprietorship, Partnership, LLC, Corporation)", "Ingresos (Revenue)", "Beneficio (Profit) vs Ganancia", "Pérdida (Loss)", "Costos (COGS, Operativos)", "Activos (Assets)", "Pasivos (Liabilities)", "Patrimonio Neto (Equity)", "Estado de Flujo de Efectivo (Cash Flow Statement)", "Balance General (Balance Sheet)", "Estado de Resultados (Income Statement / P&L)", "Contabilidad", "Principios de Contabilidad Generalmente Aceptados (GAAP)", "Normas Internacionales de Información Financiera (NIIF / IFRS)", "Auditoría", "Valoración de Empresas", "Oferta Pública Inicial (IPO)", "Fusiones y Adquisiciones (M&A)", "Bonos Corporativos", "Financiación Empresarial (Deuda vs Equity)", "Presupuesto de Capital", "Retorno de la Inversión (ROI)", "Punto de Equilibrio (Break-Even Point)", "Responsabilidad Social Corporativa (RSC)",
            // -- Historia y Teoría --
            "La Escuela Austriaca de Economía", "Keynesianismo", "Monetarismo (Milton Friedman)", "Marxismo y Crítica al Capitalismo", "Teoría del Valor-Trabajo", "Teoría de la Utilidad Marginal", "El Patrón Oro", "Acuerdos de Bretton Woods", "La Mano Invisible (Adam Smith)", "Destrucción Creativa (Schumpeter)", "Teoría Cuantitativa del Dinero", "Burbujas Económicas (Historia)", "Grandes Depresiones y Recesiones Históricas",
            // -- Conceptos Sociales y Éticos --
            "Desigualdad de Ingresos", "Desigualdad de Riqueza", "Pobreza (Absoluta vs Relativa)", "Índice de Gini", "Microfinanzas", "Inversión Socialmente Responsable (ISR)", "Finanzas Sostenibles", "Economía Circular", "Renta Básica Universal (RBU)", "Impuestos Progresivos vs Regresivos", "Paraísos Fiscales", "Lavado de Dinero", "Ética en las Finanzas", "El Futuro del Trabajo y la Economía"
        ];
        const moneyThemes = [ // Para el botón "Generar Más"
            "conceptos básicos de economía", "finanzas personales", "tipos de inversión", "mercados financieros", "acciones y bonos", "fondos de inversión", "bienes raíces", "criptomonedas", "blockchain", "DeFi", "NFT", "macroeconomía", "inflación y tasas de interés", "política monetaria y fiscal", "banca y sistema financiero", "fintech", "préstamos e hipotecas", "seguros", "impuestos", "planificación de la jubilación", "historia del dinero", "finanzas corporativas", "contabilidad básica", "valoración de empresas", "economía conductual", "desigualdad económica", "globalización financiera", "comercio internacional"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un experto financiero y economista didáctico. Tu tarea es explicar el concepto financiero o económico proporcionado de forma clara, completa y objetiva. Detalla su definición, cómo funciona, su importancia, ejemplos relevantes, ventajas y desventajas o riesgos asociados. Si es pertinente, incluye un breve contexto histórico. Utiliza un lenguaje accesible pero preciso. El objetivo es una explicación detallada de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Modelo más rápido para chat
            systemPrompt: "Actúa como un asistente financiero IA especializado únicamente en el concepto que se está mostrando actualmente. Responde preguntas de seguimiento sobre sus características, aplicaciones, o detalles mencionados en la explicación principal. Sé conciso, preciso y mantente enfocado en el tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una guía financiera. Genera exactamente 15 nombres de conceptos, términos o preguntas relevantes relacionadas con el dinero, las finanzas, la inversión o la economía. Cubre una variedad de áreas (básico, personal, inversión, macro, etc.). Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Scrollable area for text+image
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const chatContextTitle = document.getElementById('chat-context-title'); // Span to show current topic in chat header
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentConceptTitle = null; // Context for the chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentConceptTitle
                ? `Eres un asistente financiero IA especializado únicamente en el concepto llamado '${currentConceptTitle}'. Responde preguntas de seguimiento sobre sus características, aplicaciones, o detalles mencionados en la explicación principal. Sé conciso, preciso y mantente enfocado en el tema actual.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    // *** FRIENDLY ERROR MESSAGE ***
                    throw new Error(`(Error ${response.status}) Nuestros servidores parecen estar ocupados en este momento. Por favor, inténtalo de nuevo en unos instantes.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Quizás intenta reformular la pregunta o el concepto.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    // *** FRIENDLY ERROR MESSAGE ***
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Podría ser un problema de red o del servidor. Intenta de nuevo más tarde.`);
                }
                // Propagate error (likely already friendly)
                throw new Error(error.message || "Ocurrió un error inesperado al contactar con el servicio de IA.");
            }
        }
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentConceptTitle) throw new Error("Error interno: No se estableció el contexto financiero para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(moneyThemes) || "finanzas generales";
            const specificPrompt = `Genera 15 conceptos o preguntas sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de conceptos financieros.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "abstract financial concept";
            // Prompt ENFOCADO en simbolismo, evitar texto/gráficos literales
            const enhancedPrompt = `Conceptual illustration representing '${safePromptText}'. Abstract, symbolic, financial theme. Use elements like growth (plants, abstract upward trends), connection (networks), value (geometric shapes, light), data (patterns), security (shields, locks abstractly). Avoid text, labels, currency symbols, complex charts, realistic people. Professional, clean aesthetic.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, graphs, charts, diagrams, specific currency symbols ($ € £), realistic people, messy, cluttered, photorealistic, signature, watermark";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (No changes needed)
        function formatExplanationText(rawText) {
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula" style="text-align:center; margin: 1em 0; font-family: monospace;">$1</p>'); // Centered formula
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 // Handle bullet points better (simple version)
                 if (block.match(/^(\s*(\*|\-|\+)\s+)/)) {
                     return '<ul>' + block.split('\n').map(item => '<li>' + item.replace(/^\s*(\*|\-|\+)\s+/, '') + '</li>').join('') + '</ul>';
                 }
                  // Handle numbered lists better (simple version)
                 if (block.match(/^(\s*\d+\.\s+)/)) {
                      return '<ol>' + block.split('\n').map(item => '<li>' + item.replace(/^\s*\d+\.\s+/, '') + '</li>').join('') + '</ol>';
                 }
                 let content = block.replace(/\n/g, ' ');
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
          }

        // ========== MODAL FUNCTIONS ========== (No changes needed)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentConceptTitle = null;
             chatContextTitle.textContent = "este concepto"; // Reset chat context title
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (No changes needed)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (No changes needed)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                // *** FRIENDLY ERROR MESSAGE ***
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // Add an icon based on keywords (simple example)
            let iconClass = 'fa-question-circle'; // Default
            const lowerTitle = title.toLowerCase();
            if (lowerTitle.includes('inver') || lowerTitle.includes('stock') || lowerTitle.includes('acción') || lowerTitle.includes('bono') || lowerTitle.includes('etf') || lowerTitle.includes('market') || lowerTitle.includes('mercado')) iconClass = 'fa-chart-line';
            else if (lowerTitle.includes('presupuesto') || lowerTitle.includes('ahorro') || lowerTitle.includes('jubilación') || lowerTitle.includes('personal')) iconClass = 'fa-piggy-bank';
            else if (lowerTitle.includes('banco') || lowerTitle.includes('crédito') || lowerTitle.includes('hipoteca') || lowerTitle.includes('préstamo')) iconClass = 'fa-university';
            else if (lowerTitle.includes('impuesto') || lowerTitle.includes('tax')) iconClass = 'fa-file-invoice-dollar';
            else if (lowerTitle.includes('crypto') || lowerTitle.includes('bitcoin') || lowerTitle.includes('blockchain')) iconClass = 'fa-bitcoin'; // Using fab for brands
            else if (lowerTitle.includes('economía') || lowerTitle.includes('gdp') || lowerTitle.includes('pib') || lowerTitle.includes('inflación')) iconClass = 'fa-globe-americas';
            else if (lowerTitle.includes('seguro') || lowerTitle.includes('insurance')) iconClass = 'fa-shield-alt';

            div.innerHTML = `<i class="fas ${iconClass}"></i><span>${title}</span>`; // Wrap text in span
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">No hay conceptos disponibles.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentConceptTitle = title; // Set chat context
            chatContextTitle.textContent = title; // Update chat header title
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando imagen conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon" style="color:var(--color-error-text)"></i><p style="font-size:0.8em;margin-top:0.5rem; color:var(--color-error-text)">No se pudo cargar la imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                // *** FRIENDLY ERROR MESSAGE ***
                modalErrorMessage.textContent = error.message || "Ocurrió un error al cargar la información de este concepto.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más conceptos...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más conceptos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 // *** FRIENDLY ERROR MESSAGE ***
                 alert(`Error al generar conceptos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Conceptos';
             }
         }

         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check for all essential elements
            const essentialElements = [
                 titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading,
                 searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay,
                 fullscreenCloseBtn, modalLoadingIndicator, modalStoryContentArea, modalTextArea,
                 modalTitle, modalContent, modalError, modalErrorMessage, chatSection,
                 chatHistory, chatLoadingIndicator, chatContextTitle, fullscreenImage
            ];
            if (essentialElements.some(el => !el)) {
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Faltan componentes esenciales de la página. La aplicación no puede iniciarse.</p>';
                 return;
             }

            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>