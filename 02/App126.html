<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aves de Toda la Historia - Enciclopedia Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Naturales/Clásicas -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Noto+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Aves --- */
        :root {
            --color-primary: #228B22; /* Verde Bosque */
            --color-secondary: #87CEEB; /* Azul Cielo */
            --color-tertiary: #A0522D; /* Marrón Siena (para detalles) */
            --color-background: #f8f9fa; /* Blanco Hueso / Muy Claro */
            --color-text: #343a40; /* Gris Oscuro Casi Negro */
            --color-text-muted: #6c757d; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco */
            --color-border: #dee2e6; /* Borde Gris Claro */
            --color-error-bg: #f8d7da; /* Fondo error rosado claro */
            --color-error-text: #721c24; /* Texto error rojo oscuro */
            --color-error-border: #f5c6cb; /* Borde error rosa */

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.07), 0 1px 2px 0 rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            --border-radius: 6px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Noto Sans', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Noto Sans'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(34, 139, 34, 0.15); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Noto Sans'; font-size: 0.95rem; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f0fff0; /* Verde muy pálido */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: none; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1A681A; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: var(--color-text-muted); color: #e9ecef; cursor: not-allowed; opacity: 0.8; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(52, 58, 64, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e9ecef; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; } /* Mantener itálica */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid #e9ecef; padding-bottom: 0.5em; font-weight: 700;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.08); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary); } /* Icono azul cielo */

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f8f9fa; /* Fondo chat claro */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95em; }
        .user-message { background-color: var(--color-secondary); color: var(--color-text); /* Texto oscuro sobre azul claro */ margin-left: auto; text-align: left; /* Alineación izquierda para mensajes largos */ }
        .ai-message { background-color: #e9ecef; /* Gris claro */ color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Noto Sans'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(34, 139, 34, 0.1); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: #fff; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #1A681A; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-primary); font-size: 1.3rem; font-family: 'Merriweather'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Noto Sans'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-text); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(52, 58, 64, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-secondary); box-shadow: var(--shadow-lg); background-color: var(--color-modal-bg); /* Fondo por si la imagen es transparente */ }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-feather-alt mr-3 text-green-700"></i> <!-- Icono Pluma -->
                     Aves de la Historia
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Enciclopedia Interactiva «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora el Mundo Aviano</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre la increíble diversidad de aves, desde los gigantes extintos hasta los diminutos colibríes actuales. Busca o selecciona un ave para aprender más.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar ave (actual o extinta)...">
              <i class="fas fa-binoculars fa-search"></i> <!-- Icono Binoculares/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-500 mr-2"></i> <!-- Icono Libro -->
                 Índice de Especies
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los registros ornitológicos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Ninguna especie encontrada con esos criterios «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Especies
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Cargando Ficha...</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando al experto...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta ave...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Ave">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos y de divulgación sobre ornitología y paleontología aviar.</p>
              <p class="mt-1">Verifica siempre datos específicos con fuentes académicas reconocidas.</p>
              <p class="mt-2">© 2025 Enciclopedia Aviar Interactiva</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Aves Icónicas Actuales
            "Águila Real", "Águila Calva", "Halcón Peregrino", "Búho Nival", "Búho Real", "Lechuza Común", "Pingüino Emperador", "Pingüino Rey", "Pingüino de Magallanes", "Colibrí Pico Espada", "Colibrí Abeja Cubano", "Colibrí Gigante", "Pavo Real Común", "Flamenco Común", "Flamenco Chileno", "Cisne Común", "Ganso Canadiense", "Pato Mandarín", "Pelícano Pardo", "Albatros Viajero", "Cóndor Andino", "Cóndor Californiano", "Loro Gris Africano (Yaco)", "Guacamayo Azul y Amarillo", "Guacamayo Escarlata", "Cacatúa Ninfa (Carolina)", "Cacatúa Galah", "Tucán Toco", "Martín Pescador Común", "Pájaro Carpintero Real", "Gorrión Común", "Jilguero Europeo", "Canario Silvestre", "Pinzón de Darwin (Geospiza magnirostris)", "Mirlo Común", "Petirrojo Europeo", "Azulejo de las Montañas", "Cardenal Rojo", "Cuervo Común", "Urraca Común", "Paloma Bravía", "Gaviota Argéntea", "Frailecillo Atlántico", "Avutarda Común", "Grulla Común", "Cigüeña Blanca", "Garza Real", "Kiwi Común", "Emú Común", "Avestruz", "Casuario Común", "Ñandú Común", "Secretario (Ave)", "Ave Lira Soberbia", "Ave del Paraíso de Raggi", "Quetzal Resplandeciente", "Hoatzín", "Kakapo", "Quebrantahuesos", "Picozapato", "Cormorán Grande", "Somormujo Lavanco", "Alca Común", "Charrán Ártico", "Correcaminos Grande",
            // Aves Extintas Icónicas y Significativas
            "Archaeopteryx lithographica", "Hesperornis regalis", "Ichthyornis dispar", "Confuciusornis sanctus", "Enantiornithes (Grupo Extinto)", "Phorusrhacos longissimus (Ave del Terror)", "Titanis walleri (Ave del Terror)", "Kelenken guillermoi (Ave del Terror)", "Gastornis gigantea (Diatryma)", "Moa Gigante (Dinornis)", "Ave Elefante (Aepyornis maximus)", "Dodo (Raphus cucullatus)", "Solitario de Rodrigues (Pezophaps solitaria)", "Alca Gigante (Pinguinus impennis)", "Paloma Migratoria (Ectopistes migratorius)", "Cotorra de Carolina (Conuropsis carolinensis)", "Águila de Haast (Hieraaetus moorei)", "Pato del Labrador (Camptorhynchus labradorius)", "Ostrero Unicolor Canario (Haematopus meadewaldoi)", "Caracara de Guadalupe (Caracara lutosa)", "Eider de Steller Spectabilis (Extinto en Atlántico)", "Mielero de Kauai (Moho braccatus)", "'Ō'ō de Hawái (Moho nobilis)", "Pelagornis sandersi (Ave con mayor envergadura conocida)", "Argentavis magnificens (Ave voladora más pesada)", "Osteodontornis (Pelagornítido)", "Sylviornis neocaledoniae (Megápodo gigante)", "Genyornis newtoni (Dromornítido)", "Bullockornis planei (Dromornítido)", "Dromornis stirtoni (Dromornítido)", "Megalapteryx didinus (Moa pequeño)", "Anomalopteryx didiformis (Moa pequeño)", "Pachyornis elephantopus (Moa robusto)", "Emeus crassus (Moa oriental)", "Stephens Island Wren (Xenicus lyalli - Extinción por gato)", "Guacamayo Cubano (Ara tricolor)", "Chochín de Todos los Santos (Troglodytes Bauri)", "Geranoaetus fragilis (Águila fósil)", "Teratornis merriami (Teratornítido)", "Cathartornis gracilis (Teratornítido)",
            // Grupos y Conceptos
            "Evolución de las Aves desde los Dinosaurios", "Origen del Vuelo en las Aves", "Adaptaciones de las Aves Rapaces", "Migración de las Aves", "Aves Marinas y sus Adaptaciones", "Aves No Voladoras (Ratites)", "El Canto de las Aves: Comunicación y Territorio", "Nidificación y Cuidado Parental en Aves", "Aves Endémicas de Islas", "Impacto Humano en la Extinción de Aves", "Conservación de Aves Amenazadas", "Anatomía Comparada: Archaeopteryx vs Ave Moderna", "Paleognathae vs Neognathae", "Passeriformes (Pájaros Cantores)", "Psittaciformes (Loros y Cacatúas)", "Falconiformes (Halcones y Caracaras)", "Strigiformes (Búhos y Lechuzas)", "Anseriformes (Patos, Gansos, Cisnes)", "Charadriiformes (Gaviotas, Limícolas, Alcas)", "Piciformes (Pájaros Carpinteros, Tucanes)", "Galliformes (Gallinas, Pavos, Faisanes)", "Sphenisciformes (Pingüinos)", "Procellariiformes (Albatros, Petreles)", "Pelecaniformes (Pelícanos, Cormoranes, Garzas)", "Columbiformes (Palomas)", "Caprimulgiformes (Chotacabras, Vencejos)", "Aves del Mesozoico", "Aves del Cenozoico", "Diversificación de las Aves después del K-Pg", "Aves de la Antártida", "Aves del Ártico", "Aves del Desierto", "Aves de la Selva Tropical", "Aves de Montaña", "Registro Fósil de las Aves",
            // Más especies para alcanzar un buen número...
            "Colimbo Grande", "Zampullín Común", "Falaropo Picofino", "Avoceta Común", "Cigüeñuela Común", "Ostrero Común", "Chorlitejo Patinegro", "Archibebe Común", "Zarapito Real", "Aguja Colipinta", "Correlimos Común", "Combatiente (Ave)", "Ganga Ibérica", "Ortega (Ave)", "Faisán Común", "Perdiz Roja", "Codorniz Común", "Lagópodo Alpino", "Urogallo Común", "Pito Real", "Pico Picapinos", "Torcecuello", "Vencejo Común", "Abubilla", "Abejaruco Europeo", "Carraca Europea", "Cuco Común", "Críalo Europeo", "Autillo Europeo", "Mochuelo Europeo", "Cárabo Común", "Chotacabras Gris", "Golondrina Común", "Avión Común", "Bisbita Común", "Lavandera Blanca", "Acentor Común", "Chochín Común", "Curruca Capirotada", "Mosquitero Común", "Papamoscas Gris", "Carbonero Común", "Herrerillo Común", "Mito (Ave)", "Trepador Azul", "Agateador Común", "Oropéndola Europea", "Alcaudón Real", "Estornino Pinto", "Arrendajo Euroasiático", "Graja (Ave)", "Chova Piquirroja", "Verderón Común", "Verdecillo", "Lugano (Ave)", "Pardillo Común", "Pinzón Vulgar", "Camachuelo Común", "Piquituerto Común", "Escribano Montesino", "Triguero (Ave)", "Colibrí de Ana", "Colibrí rufo", "Picaflor de Arica", "Picaflor de Juan Fernández", "Tángara Azuleja", "Tángara de Lentejuelas", "Saltarín de Cola Larga", "Manakin de Corona Azul", "Cotinga Nívea", "Gallo de las Rocas Peruano", "Pájaro Paraguas Longuipéndulo", "Ermitaño Barbudo", "Jacamar de Cola Rufa", "Momoto Común", "Trogón Coliblanco", "Carpinterito de Pecho Punteado", "Hormiguero de Zeledón", "Tiranolete Silbador", "Pitajo Rojo", "Pitangus sulphuratus (Benteveo)", "Tyrannus melancholicus (Sirirí Común)", "Vireo de Ojos Rojos", "Golondrina de Horquilla", "Cucarachero Común", "Sinsonte Tropical", "Zorzal Pardo", "Perlita Tropical", "Reinita Amarilla", "Reinita Trepadora", "Mielero Verde", "Semillero Brincador", "Pinzón Amarillo Azafrán", "Tangara Helecho", "Ibis Escarlata", "Espátula Rosada", "Jabirú", "Garceta Grande", "Garcilla Bueyera", "Avetoro Común", "Anhinga Americana", "Pato Cuchara Común", "Porrón Europeo", "Serreta Mediana", "Suirirí Cariblanco", "Tero Común", "Becasina Común", "Gallineta Común", "Focha Común", "Rascón Europeo", "Calamón Común", "Turpial de Baltimore", "Zanate Mexicano", "Chipe de Cabeza Negra", "Junco Ojioscuro", "Alondra Cornuda"
            // ... (Esta lista es extensa pero puede crecer más con 'Generar Más')
        ];
        const birdThemes = [
            "aves rapaces diurnas", "aves rapaces nocturnas", "aves marinas", "aves acuáticas de agua dulce", "pájaros cantores (passeriformes)", "aves no voladoras (ratites)", "aves extintas del Pleistoceno", "aves extintas del Holoceno", "aves del Mesozoico", "primeras aves con plumas verdaderas", "aves de la familia de los loros (Psittacidae)", "colibríes (Trochilidae)", "aves del paraíso (Paradisaeidae)", "pingüinos (Spheniscidae)", "tucanes (Ramphastidae)", "pájaros carpinteros (Picidae)", "aves migratorias de larga distancia", "aves endémicas de Madagascar", "aves endémicas de Nueva Zelanda", "aves endémicas de Sudamérica", "aves de ambientes áridos", "aves de alta montaña", "el origen de las plumas", "evolución del pico en las aves", "conservación de aves en peligro crítico"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un experto ornitólogo y paleontólogo de renombre mundial. Tu tarea es proporcionar una ficha detallada y rigurosa sobre el ave (actual o extinta) indicada. Incluye: Nombre científico y común, clasificación taxonómica básica (orden, familia), descripción física (tamaño, plumaje distintivo, características únicas), distribución geográfica y hábitat (actuales o pasados), dieta, comportamiento (social, reproductivo, vocalizaciones si aplica), época de existencia (para extintas, e.g., Cretácico Superior, Pleistoceno), estado de conservación (para actuales, según IUCN), posible causa de extinción (si aplica), e importancia evolutiva o ecológica. Utiliza un lenguaje claro, científico pero accesible. El objetivo es un texto completo de aproximadamente 1200-1300 palabras. Basa tu descripción únicamente en la siguiente ave:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúa como un asistente experto en la ave específica que se está mostrando. Responde preguntas adicionales sobre sus características, comportamiento, hábitat, historia evolutiva o estado de conservación, basándote en el conocimiento general sobre esa especie. Sé preciso y mantente enfocado en el ave en cuestión.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia de aves. Genera exactamente 15 nombres de especies de aves (actuales o extintas, pueden ser comunes o interesantes) o conceptos relevantes sobre aves (e.g., 'Migración transatlántica', 'Dimorfismo sexual en aves'). Devuelve *solo* la lista de nombres/conceptos, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Identical structure, potentially adjusted IDs if needed, but not required here)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Div que contiene título y texto+imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div específico para el texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentBirdTitle = null; // Renamed for clarity

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             // Dynamic system prompt for chat
             const systemPromptToUse = isChat && currentBirdTitle
                 ? `Eres un asistente experto específicamente en el ave llamada '${currentBirdTitle}'. Responde preguntas de seguimiento sobre sus características, comportamiento, hábitat, historia evolutiva o estado de conservación. Sé preciso y mantente enfocado en esta ave.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores pueden estar experimentando mucho tráfico ahora mismo. Por favor, inténtalo de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o inténtalo más tarde.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado contactando la IA.");
             }
        }
        async function fetchExplanationText(birdTitle) { // Renamed parameter
            return fetchTextFromApi(birdTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentBirdTitle) throw new Error("Error interno: No se ha seleccionado un ave para consultar.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(birdThemes) || "aves diversas";
            const specificPrompt = `Genera 15 nombres de especies de aves (actuales o extintas) o conceptos sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de especies.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "diverse bird species";
             // Prompt enfocado en la ilustración del ave
             const enhancedPrompt = `Detailed illustration or artistic depiction of the bird '${safePromptText}'. Show it in its natural habitat (forest, water, plains, prehistoric landscape if applicable). Focus on realistic or scientifically-informed representation of its plumage, size, and key features. Natural lighting.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Negative prompt crucial para evitar texto/diagramas
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, scientific illustration labels, species name written, human, person, multiple different species together, cage, unnatural background, blurry, low quality, watermark, signature";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (No changes needed)
        function formatExplanationText(rawText) { /* ... (same as before) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (No changes needed)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentBirdTitle = null; // Reset bird context
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (No changes needed)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (No changes needed, uses currentBirdTitle)
        function addChatMessage(message, sender) { /* ... (same as before) ... */
             const msgDiv = document.createElement('div');
             msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
             message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
             msgDiv.innerHTML = message;
             chatHistory.appendChild(msgDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... (same as before) ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... (same as before, calls fetchChatResponse) ... */
             const userQuery = chatInput.value.trim();
             if (!userQuery || chatSendBtn.disabled) return;
             addChatMessage(userQuery, 'user');
             chatInput.value = '';
             chatSendBtn.disabled = true;
             chatLoadingIndicator.style.display = 'block';
             try {
                 const aiResponse = await fetchChatResponse(userQuery);
                 addChatMessage(aiResponse, 'ai');
             } catch (error) {
                 console.error("Chat Error:", error);
                 addChatError(`Error IA: ${error.message}`);
             } finally {
                 chatLoadingIndicator.style.display = 'none';
                 chatSendBtn.disabled = false;
                 chatInput.focus();
             }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { // Sort alphabetically
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' })); // Spanish locale sort
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay especies en los registros «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { // Add new titles, avoid duplicates, re-filter
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let added = false;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); added = true; } });
             if (added) { filterTitles(searchInput.value); } // Only re-filter if something was actually added
         }

        // *** MODIFIED: handleTitleClick sets currentBirdTitle ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentBirdTitle = title; // *** SET BIRD CONTEXT FOR CHAT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is potentially visible
                console.log("Scroll set to 0 after content visible");

                // Image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando ilustración...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Ilustración no disponible.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la ficha."; // Friendly message
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() { // Uses friendly errors
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando registros...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron encontrar más especies en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar más especies: ${error.message}`); // Friendly message
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Especies';
             }
         }

         // *** Search Filter Function (with accent normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Show if no results OR if list is empty initially
         }

        // ========== INITIALIZATION ========== (No changes needed)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Fallo al cargar componentes de la interfaz.</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden'); // Start hidden
            // Initial check in case predefinedTitles is empty
             if (predefinedTitles.length === 0) {
                  titlesLoading.style.display = 'none';
                   noResultsMsg.classList.remove('hidden');
                   noResultsMsg.textContent = '» No hay especies cargadas inicialmente. Intenta generar más. «';
             }
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>