<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBZ x One Piece: Historias Crossover</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Energéticas (Ejemplo: Bangers para títulos, Poppins para cuerpo) -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Fusión DBZ x OP --- */
        :root {
            --color-primary: #FF8C00; /* Naranja DB */
            --color-secondary: #1E90FF; /* Azul OP/DB */
            --color-tertiary: #FFD700; /* Amarillo SSJ/Sombrero Paja */
            --color-accent: #DC143C; /* Rojo Luffy */
            --color-background: #f0f8ff; /* Azul Cielo muy claro / Blanco */
            --color-text: #2c3e50; /* Gris Azulado Oscuro */
            --color-text-muted: #7f8c8d; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Modal */
            --color-border: #bdc3c7; /* Borde Gris Claro */
            --color-error-bg: #ffebee; /* Fondo error rojo muy claro */
            --color-error-text: #c62828; /* Texto error rojo oscuro */
            --color-error-border: #ef9a9a; /* Borde error rojo claro */

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.15);
            --border-radius: 8px; /* Bordes más redondeados y amigables */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400;
               background-image: linear-gradient(rgba(240, 248, 255, 0.95), rgba(240, 248, 255, 0.95)),
                                 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23a7d8ff' fill-opacity='0.1'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
               background-attachment: fixed;
        }
        h1, h2, h3, h4, .logo { font-family: 'Bangers', cursive; letter-spacing: 1.5px; }
        .logo { color: var(--color-primary); text-shadow: 2px 2px 0px #000, -2px -2px 0px #000, 2px -2px 0px #000, -2px 2px 0px #000, 3px 3px 5px rgba(0,0,0,0.5); /* Contorno + sombra */ }
        .logo .op-part { color: var(--color-accent); } /* Rojo para parte OP */
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        h2.section-title { color: var(--color-secondary); border-bottom: 3px dashed var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-accent); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 2px solid var(--color-primary); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.2rem 0.8rem 3rem; border: 2px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Poppins'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 4px rgba(255, 140, 0, 0.2); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .title-item { background: linear-gradient(135deg, #ffffff 60%, var(--color-tertiary) 150%); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Poppins'; font-size: 0.95rem; position: relative; overflow: hidden; }
        .title-item::before { /* Efecto hover */ content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 140, 0, 0.3), transparent); transition: left 0.4s ease; }
        .title-item:hover { transform: translateY(-5px) scale(1.02); box-shadow: var(--shadow-lg); border-color: var(--color-primary); color: var(--color-primary); }
        .title-item:hover::before { left: 100%; }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-accent)); color: white; padding: 1rem 1.8rem; border: none; border-radius: 50px; /* Botón redondeado */ font-family: 'Bangers', cursive; font-size: 1.3rem; letter-spacing: 2px; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.4); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-accent), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.88); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 3px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 500px; /* Más alto para juego y chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-primary); border: 2px solid white; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .modal-close-btn:hover { background-color: var(--color-accent); transform: rotate(180deg) scale(1.1); box-shadow: 0 0 10px var(--color-accent); }
        #modal-title { font-size: 2.2rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        #modal-story-content-area { /* Contenedor principal dentro del modal */
            flex-grow: 1; min-height: 0; /* Para que funcione el flexbox scroll */
            display: none; /* Oculto hasta que cargue */
            flex-direction: column;
        }
        #modal-story-content-area.visible { display: flex; }

        /* Área de Contenido (Texto + Imagen) */
        #modal-content-area {
            flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: #eef; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid #eef; }

        #modal-content { padding: 0 5px; font-size: 1.05rem; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 600;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Bangers', cursive; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-secondary); border-bottom: 2px dotted var(--color-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 1px;}
        #modal-content h1 { font-size: 1.6em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-accent); }
        #modal-content h4 { font-size: 1.15em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 3px solid var(--color-tertiary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 15px var(--color-tertiary); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 5px solid rgba(189, 195, 199, 0.5); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 2px dashed var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* Un poco más alto */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f8f9fa; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) #e9ecef;
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: #e9ecef; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; box-shadow: var(--shadow-sm); }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; font-weight: 600;}
        .ai-message { background-color: var(--color-secondary); color: white; margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: 20px; font-family: 'Poppins'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-primary); color: white; border: none; border-radius: 50%; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1rem; flex-shrink: 0; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-accent); transform: scale(1.1); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; transform: none; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Screen & Minigame */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, rgba(30, 144, 255, 0.95) 0%, rgba(255, 140, 0, 0.95) 100%);
            display: none; /* Oculto inicialmente */
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius); /* Match modal */
            padding: 2rem;
            color: white;
            text-align: center;
        }
        #modal-loading.active { display: flex; } /* Mostrar cuando carga */
        #loading-game-canvas {
            border: 3px solid var(--color-tertiary);
            background-color: #000; /* Fondo negro para el juego */
            max-width: 90%;
            max-height: 60%; /* Ajustar según sea necesario */
            aspect-ratio: 16 / 9; /* Opcional: mantener proporción */
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            margin-bottom: 1rem; /* Espacio debajo del canvas */
            display: block; /* Evitar espacio extra debajo */
        }
        #loading-instructions { font-size: 0.9rem; margin-top: 0.5rem; font-family: 'Poppins'; }
        #loading-score { font-size: 1.5rem; font-family: 'Bangers'; margin-top: 0.5rem; text-shadow: 1px 1px 2px #000; }
        .loading-spinner-modal { /* Spinner como fallback o si el canvas falla */
            width: 60px; height: 60px; border: 6px solid rgba(255,255,255,0.3); border-top-color: var(--color-tertiary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Poppins'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.92); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 4px solid var(--color-tertiary); box-shadow: 0 0 30px var(--color-tertiary); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 2px solid var(--color-tertiary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-tertiary); color: #333; transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-4xl sm:text-5xl">
                     <i class="fas fa-dragon mr-2 text-orange-500"></i> <!-- Icono Dragón -->
                     DBZ <span class="op-part">x OP</span> <!-- 'x OP' en rojo -->
                     <i class="fas fa-skull-crossbones ml-2 text-red-600"></i> <!-- Icono Pirata -->
                 </h1>
             </div>
             <span class="text-md text-gray-700 font-semibold font-sans tracking-wide">» ¡Historias Crossover Épicas! «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Universos Fusionados</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">¡Imagina los encuentros más inesperados! Elige un escenario o busca tu crossover soñado entre los Saiyajin y los Piratas.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar (Ej: Goku vs Kaido, Nami Bulma, Haki Ki...)">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-500 mr-2"></i>
                 Escenarios Posibles
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Buscando fragmentos de universos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún escenario coincide con tu búsqueda interdimensional «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     ¡Generar 40 Nuevos Crossovers!
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <canvas id="loading-game-canvas" width="640" height="360">Tu navegador no soporta Canvas.</canvas>
                 <p id="loading-instructions">¡Espera un momento! Juega mientras cargamos... (Usa ↑ / ↓)</p>
                 <p id="loading-score">Puntuación: 0 | Nivel: 1</p>
                 <!-- Fallback spinner si el canvas no carga o falla JS -->
                 <div class="loading-spinner-modal content-hidden"></div>
             </div>

             <!-- Content Area Wrapper (Initially Hidden) -->
             <div id="modal-story-content-area">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image and placeholder added via JS -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Analizando...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="¿Qué pasa después? Pregunta aquí...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gradient-to-r from-blue-100 to-orange-100 text-gray-600 py-6 mt-12 border-t-2 border-gray-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias generadas por IA, fusionando los mundos de Dragon Ball y One Piece para tu entretenimiento.</p>
              <p class="mt-1">Creado por fans, para fans. Dragon Ball © Akira Toriyama/Shueisha/Toei Animation. One Piece © Eiichiro Oda/Shueisha/Toei Animation.</p>
              <p class="mt-2">© 2025 Crossover Chronicles</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Encuentros Iniciales y Comparaciones
            "Goku Aterriza en el Thousand Sunny", "Luffy se Cuela en el Torneo de las Artes Marciales", "Zoro Desafía a Vegeta a un Duelo de Espadas (y se pierde)", "Sanji Intenta Cocinar para Bills y Whis", "Nami Intenta Robar las Bolas de Dragón", "Bulma y Franky: Competición de Inventores Locos", "Piccolo Medita en Raftel", "Chopper Intenta Curar a un Saiyajin Herido", "Usopp Cuenta Historias Exageradas a Goten y Trunks", "Brook le Pide Ver las Bragas a Androide 18", "Robin Investiga los Poneglyphs con Dende", "Krilin se Une a la Tripulación de Sombrero de Paja por Accidente", "Yamcha es Derrotado por... ¿un Den Den Mushi?", "Ten Shin Han Abre un Dojo en Wano", "Gohan Académico Estudia la Historia del Siglo Vacío", "Vegeta se Enfurece con la Estupidez de Luffy", "La Primera Reacción de Goku al Ver una Fruta del Diablo", "Comparación de Fuerza: Super Saiyan vs Gear Fourth", "Análisis: Ki vs Haki (Observación, Armadura, Rey)", "Debate: ¿Quién come más, Goku o Luffy?",

            // Conflictos y Peleas Épicas
            "Goku y Luffy vs Kaido (Forma Dragón)", "Vegeta y Zoro vs Almirante Kizaru", "Gohan Definitivo vs Rob Lucci (Despertar)", "Piccolo y Sanji vs Queen y King", "Trunks del Futuro vs Katakuri", "Gotenks vs Perospero", "Androides 17 y 18 vs Seraphim Pacifistas", "Krilin, Yamcha y Ten vs Miembros del CP9", "Fuerzas Especiales Ginyu vs Comandantes de Big Mom", "Cell Perfecto vs Los Tres Almirantes (Pre-Timeskip)", "Super Buu (Gohan Absorbido) vs Barbanegra (Dos Frutas)", "Kid Buu Desatado en Marineford", "Frieza (Forma Golden) Intenta Conquistar Whole Cake Island", "Cooler se Enfrenta a Shanks", "Broly (DBS) vs Barbablanca (Prime)", "Jiren el Gris vs Monkey D. Dragon", "Hit Intenta Asesinar a un Tenryuubito", "Zamasu Fusionado Intenta 'Purificar' el Mundo de One Piece", "Baby Vegeta Infecta a los Shichibukai", "Super Androide 13 vs Franky Shogun",

            // Aventuras y Misiones Conjuntas
            "Los Guerreros Z Buscan el One Piece", "Los Sombrero de Paja Buscan las Bolas de Dragón", "Misión: Recuperar una Fruta del Diablo Robada por Pilaf", "Viaje a Namek en el Thousand Sunny", "Entrenamiento en la Habitación del Tiempo: Luffy, Zoro y Sanji", "Bulma Construye un Radar de Road Poneglyphs", "Defendiendo Fishman Island de un Ataque del Ejército de Frieza", "Escapando de Impel Down con la Ayuda de Goku (Teletransportación)", "Detener a Doflamingo con un Kamehameha Padre-Hijo (Goku/Gohan + Luffy)", "Encontrar una Semilla Senzu para Salvar a Ace", "Navegando por el Nuevo Mundo con la Cápsula Corp", "La Fusión (Metamoru) de Goku y Luffy: ¿Goffy?", "La Fusión (Potara) de Vegeta y Zoro: ¿Vegoro?", "Reuniendo las Bolas de Dragón para Revivir a Barbablanca", "Investigando los Orígenes Comunes de Saiyajins y la 'Voluntad de D'",

            // Objetos y Poderes Cruzados
            "¿Qué Pasaría si Luffy Comiera una Semilla Senzu?", "¿Podría el Haki del Rey Intimidar a un Super Saiyan?", "Usando las Bolas de Dragón para Quitar una Maldición de Fruta del Diablo", "Zoro Cortando un Ataque de Ki", "Sanji Usando Sky Walk para Esquivar Disparos Láser", "Nami Usando el Clima-Tact con Técnicas de Ki", "Franky Mejorando su Cuerpo con Tecnología de la Capsule Corp", "Chopper Creando una Rumble Ball con Efectos de Ki", "Robin Usando su Fruta para Imitar la Técnica de Múltiples Brazos de Ten Shin Han", "Brook Usando su Alma para Luchar contra Fantasmas de Buu", "Un Usuario de Haki de Observación Intentando Predecir la Teletransportación", "El Veneno de Magellan vs la Resistencia Saiyajin", "La Fruta Ope Ope no Mi Usada en un Androide", "Kizaru (Luz) vs la Velocidad de Dyspo", "Controlando a un Ozaru con Haki del Rey",

            // Escenarios "What If" y Divertidos
            "What If: Goku fuera criado por Garp", "What If: Luffy encontrara una Bola de Dragón de niño", "What If: Vegeta se uniera a los Piratas de Barbablanca", "What If: Zoro fuera entrenado por Piccolo", "What If: Sanji aprendiera el Kaioken", "What If: Nami tuviera un Scouter", "What If: Bulma comiera la Fruta Gomu Gomu", "What If: Chopper se transformara en Ozaru", "El Banquete Definitivo: Cocina de Sanji y Comida de Capsule Corp", "Una Carrera: El Sunny Volador vs la Nube Kinton", "Competencia de Inventos: Franky vs Dr. Brief vs Dr. Gero", "Concurso de Gags: Arale Norimaki vs Buggy el Payaso", "Intercambio de Ropa: Goku con Chaleco Rojo, Luffy con Gi Naranja", "Reacciones de los Personajes de OP al Poder de Pelea de los Z Fighters", "Reacciones de los Z Fighters a las Recompensas de los Piratas",

            // Villanos Combinados y Amenazas Mayores
            "La Alianza Pirata de Frieza y Crocodile", "Doflamingo Controlando a los Saiyajins con su Fruta", "Big Mom Intentando Añadir a Shenron a su Colección de Almas", "Kaido Buscando la Inmortalidad con las Bolas de Dragón", "Barbanegra Intentando Robar el Poder de un Super Saiyan Dios", "Akainu vs la Tiranía de Frieza", "El Gobierno Mundial Intenta Replicar a los Androides", "Eneru se Encuentra con Bills", "Moria Revive a Raditz y Nappa como Zombies", "La Patrulla Roja Intenta Conquistar el East Blue", "Los Dragones Malignos Aparecen en el Nuevo Mundo", "Majin Vegeta se Enfrenta a los Almirantes en Marineford", "El Plan de Zamasu para Erradicar a los Usuarios de Frutas del Diablo", "Los Demonios del Frío (Raza de Frieza) vs los Lunarianos", "Una Invasión Combinada de Saiyajins y Piratas a la Tierra",
            // Y muchos más... La clave es mezclar personajes, poderes, lugares y situaciones.
        ];
        const crossoverThemes = [ // Para generar más títulos
            "Goku y Luffy", "Vegeta y Zoro", "Piccolo y Sanji", "Bulma y Nami", "Trunks y Robin", "Gohan y Law", "Krilin y Usopp", "Androides y Pacifistas", "Frieza y Doflamingo", "Cell y Crocodile", "Buu y Big Mom", "Kaido y Broly", "Bills y Shanks", "Ki vs Haki", "Super Saiyan vs Gear Fourth/Fifth", "Frutas del Diablo y Técnicas Z", "Bolas de Dragón y One Piece", "Namek y Wano", "Torneo de Poder y Guerra de Marineford", "Capsule Corp y Thousand Sunny", "Viaje Espacial y Grand Line", "Tenryuubito y Freezer Force", "Gobierno Mundial y Patrulla Roja", "Yonko vs Guerreros Z", "Shichibukai y Androides", "Supernovas y Saiyajins", "Entrenamiento Cruzado", "Fusiones Inesperadas", "Objetos Mágicos Combinados", "Villanos Aliados", "Escenarios What If", "Batallas de Comida Épicas", "Tecnología vs Poder Bruto", "Secretos del Siglo Vacío y Origen Saiyajin"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un talentoso escritor de fanfiction especializado en crear crossovers épicos entre Dragon Ball y One Piece. Tu tarea es escribir una historia corta (aproximadamente 1200-1300 palabras) basada en el título/escenario proporcionado. Captura fielmente las personalidades, diálogos y estilos de lucha de los personajes de ambos universos. Describe vívidamente la acción, la interacción y cómo los sistemas de poder (Ki, Haki, Frutas del Diablo) chocan o se complementan. Haz que la fusión de mundos sea creíble dentro de la fantasía. Enfócate en crear una narrativa emocionante y entretenida basada *exclusivamente* en el siguiente escenario:",
            timeoutSeconds: 180 // Un poco más de tiempo por si la historia es compleja
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Más rápido para chat
            systemPrompt: "Actúa como un asistente de guionista para la historia crossover de Dragon Ball y One Piece que se está mostrando. Responde preguntas sobre posibles continuaciones, interacciones de personajes no exploradas, detalles del mundo fusionado o consecuencias de los eventos descritos en *esa historia específica*. Sé creativo y mantente dentro del contexto del crossover actual.",
            timeoutSeconds: 50
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de ideas para fanfictions crossover entre Dragon Ball y One Piece. Genera exactamente 40 títulos o escenarios intrigantes y específicos que mezclen personajes, lugares, poderes u objetos de ambos universos. Devuelve *solo* la lista, un ítem por línea, sin números, guiones, introducciones ni conclusiones.",
            timeoutSeconds: 60 // Más tiempo para generar 40 ideas
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, pero añadiendo el canvas y elementos del juego)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Contenedor del juego/spinner
        const modalStoryContentArea = document.getElementById('modal-story-content-area'); // Wrapper del contenido cargado
        const modalTextArea = document.getElementById('modal-content-area'); // Área de texto+imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div del texto
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Loading Game Elements
        const gameCanvas = document.getElementById('loading-game-canvas');
        const gameCtx = gameCanvas.getContext('2d');
        const loadingInstructions = document.getElementById('loading-instructions');
        const loadingScoreDisplay = document.getElementById('loading-score');

        // ========== State Variables ==========
        let currentStoryTitle = null;
        let gameLoopId = null; // Para controlar el requestAnimationFrame
        let isGameRunning = false;

        // ========== MINIGAME VARIABLES & LOGIC ==========
        const gameConfig = {
            playerWidth: 40, playerHeight: 50, playerSpeed: 5, playerColor: 'orange', // Goku color inicial
            itemSize: 20, itemSpeedMultiplier: 1, // Items caen/vuelan más lento que obstáculos
            obstacleWidth: 50, obstacleHeight: 30, obstacleMinSpeed: 3, obstacleMaxSpeed: 6,
            spawnRateItems: 0.015, // Probabilidad por frame
            spawnRateObstacles: 0.01,
            scorePerItem: 10, scoreLostOnHit: 25,
            levelUpScore: 150, // Puntos para subir de nivel
            maxSpeedIncreasePerLevel: 0.5,
            maxSpawnRateIncreasePerLevel: 0.002,
        };

        let player = { x: 50, y: gameCanvas.height / 2 - gameConfig.playerHeight / 2 };
        let items = []; // {x, y, type: 'db' | 'meat'}
        let obstacles = []; // {x, y, speed, type: 'marine' | 'rr'}
        let score = 0;
        let level = 1;
        let currentObstacleSpeed = gameConfig.obstacleMinSpeed;
        let currentItemSpeed = gameConfig.obstacleMinSpeed * gameConfig.itemSpeedMultiplier;
        let currentObstacleSpawnRate = gameConfig.spawnRateObstacles;
        let currentItemSpawnRate = gameConfig.spawnRateItems;
        let keysPressed = {};

        function resetGame() {
            player.y = gameCanvas.height / 2 - gameConfig.playerHeight / 2;
            items = [];
            obstacles = [];
            score = 0;
            level = 1;
            currentObstacleSpeed = gameConfig.obstacleMinSpeed;
            currentItemSpeed = gameConfig.obstacleMinSpeed * gameConfig.itemSpeedMultiplier;
            currentObstacleSpawnRate = gameConfig.spawnRateObstacles;
            currentItemSpawnRate = gameConfig.spawnRateItems;
            keysPressed = {};
            loadingScoreDisplay.textContent = `Puntuación: 0 | Nivel: 1`;
            console.log("Game Reset");
        }

        function handleKeyDown(e) {
            keysPressed[e.key] = true;
            // Prevenir scroll de página con flechas
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
            }
        }
        function handleKeyUp(e) {
            keysPressed[e.key] = false;
        }

        function updateGame() {
            if (!isGameRunning) return;

            // Player Movement
            if (keysPressed['ArrowUp'] && player.y > 0) {
                player.y -= gameConfig.playerSpeed;
            }
            if (keysPressed['ArrowDown'] && player.y < gameCanvas.height - gameConfig.playerHeight) {
                player.y += gameConfig.playerSpeed;
            }
             // Cambiar color/sprite de jugador (simple)
             player.color = (level % 2 === 0) ? 'red' : 'orange'; // Alterna Luffy/Goku color

            // Spawn Items
            if (Math.random() < currentItemSpawnRate) {
                items.push({
                    x: gameCanvas.width,
                    y: Math.random() * (gameCanvas.height - gameConfig.itemSize),
                    type: Math.random() < 0.3 ? 'db' : 'meat' // Más carne que DBs
                });
            }

            // Spawn Obstacles
            if (Math.random() < currentObstacleSpawnRate) {
                obstacles.push({
                    x: gameCanvas.width,
                    y: Math.random() * (gameCanvas.height - gameConfig.obstacleHeight),
                    speed: currentObstacleSpeed + (Math.random() * (gameConfig.obstacleMaxSpeed - gameConfig.obstacleMinSpeed)),
                    type: Math.random() < 0.5 ? 'marine' : 'rr' // Mitad/Mitad
                });
            }

            // Move & Remove Items
            items.forEach((item, index) => {
                item.x -= currentItemSpeed;
                if (item.x < -gameConfig.itemSize) {
                    items.splice(index, 1);
                }
                // Collision with Player
                if (player.x < item.x + gameConfig.itemSize &&
                    player.x + gameConfig.playerWidth > item.x &&
                    player.y < item.y + gameConfig.itemSize &&
                    player.y + gameConfig.playerHeight > item.y) {
                    score += gameConfig.scorePerItem * (item.type === 'db' ? 3 : 1); // DBs valen más
                    items.splice(index, 1);
                    checkLevelUp();
                }
            });

            // Move & Remove Obstacles
            obstacles.forEach((obstacle, index) => {
                obstacle.x -= obstacle.speed;
                if (obstacle.x < -gameConfig.obstacleWidth) {
                    obstacles.splice(index, 1);
                }
                // Collision with Player
                if (player.x < obstacle.x + gameConfig.obstacleWidth &&
                    player.x + gameConfig.playerWidth > obstacle.x &&
                    player.y < obstacle.y + gameConfig.obstacleHeight &&
                    player.y + gameConfig.playerHeight > obstacle.y) {
                    score = Math.max(0, score - gameConfig.scoreLostOnHit); // No negativo
                    obstacles.splice(index, 1); // Remove obstacle on hit
                    // Podría añadirse un efecto visual/sonido simple aquí
                }
            });

             loadingScoreDisplay.textContent = `Puntuación: ${score} | Nivel: ${level}`;
        }

        function checkLevelUp() {
            const nextLevelThreshold = level * gameConfig.levelUpScore;
            if (score >= nextLevelThreshold) {
                level++;
                currentObstacleSpeed = Math.min(gameConfig.obstacleMaxSpeed * 1.5, gameConfig.obstacleMinSpeed + (level - 1) * gameConfig.maxSpeedIncreasePerLevel); // Aumenta velocidad base
                currentItemSpeed = currentObstacleSpeed * gameConfig.itemSpeedMultiplier;
                currentObstacleSpawnRate = Math.min(0.05, gameConfig.spawnRateObstacles + (level - 1) * gameConfig.maxSpawnRateIncreasePerLevel); // Aumenta spawn rate
                currentItemSpawnRate = Math.min(0.06, gameConfig.spawnRateItems + (level - 1) * gameConfig.maxSpawnRateIncreasePerLevel);
                console.log(`Level Up! Level: ${level}, Speed: ${currentObstacleSpeed.toFixed(2)}, Spawn: ${currentObstacleSpawnRate.toFixed(4)}`);
                 // Efecto visual simple al subir nivel
                 gameCanvas.style.borderColor = ['#FFD700', '#00FFFF', '#FF00FF'][level % 3]; // Cambia color borde
                 setTimeout(() => { gameCanvas.style.borderColor = 'var(--color-tertiary)'; }, 300);
            }
        }

        function drawGame() {
            if (!isGameRunning || !gameCtx) return;

            // Clear Canvas
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

             // Background (simple gradient or image)
             const grad = gameCtx.createLinearGradient(0, 0, 0, gameCanvas.height);
             grad.addColorStop(0, '#87CEEB'); // Sky blue
             grad.addColorStop(1, '#ADD8E6'); // Lighter blue
             gameCtx.fillStyle = grad;
             gameCtx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

            // Draw Player (simple rect)
            gameCtx.fillStyle = player.color; // Usa el color dinámico
            gameCtx.fillRect(player.x, player.y, gameConfig.playerWidth, gameConfig.playerHeight);
             // Simple "face"
             gameCtx.fillStyle = 'white';
             gameCtx.fillRect(player.x + gameConfig.playerWidth * 0.6, player.y + gameConfig.playerHeight * 0.2, 5, 5);


            // Draw Items
            items.forEach(item => {
                gameCtx.fillStyle = item.type === 'db' ? 'orange' : '#D2691E'; // Naranja (DB) o Marrón (Carne)
                 if (item.type === 'db') { // Dibuja círculo para DB
                     gameCtx.beginPath();
                     gameCtx.arc(item.x + gameConfig.itemSize / 2, item.y + gameConfig.itemSize / 2, gameConfig.itemSize / 2, 0, Math.PI * 2);
                     gameCtx.fill();
                     // Estrella simple (opcional)
                     gameCtx.fillStyle = 'red';
                     gameCtx.fillRect(item.x + gameConfig.itemSize*0.4, item.y + gameConfig.itemSize*0.4, 4, 4)
                 } else { // Dibuja forma de 'carne' simple
                     gameCtx.fillRect(item.x, item.y, gameConfig.itemSize, gameConfig.itemSize * 0.7);
                     gameCtx.fillStyle = 'white'; // Hueso
                     gameCtx.fillRect(item.x + gameConfig.itemSize * 0.4, item.y - gameConfig.itemSize * 0.1, gameConfig.itemSize * 0.2, gameConfig.itemSize * 1.2);
                 }
            });

            // Draw Obstacles
            obstacles.forEach(obstacle => {
                gameCtx.fillStyle = obstacle.type === 'marine' ? '#4682B4' : '#A0522D'; // Azul acero (Marine) o Marrón (RR)
                gameCtx.fillRect(obstacle.x, obstacle.y, gameConfig.obstacleWidth, gameConfig.obstacleHeight);
                 // Símbolo simple
                 gameCtx.fillStyle = 'white';
                 gameCtx.font = '12px Arial';
                 gameCtx.fillText(obstacle.type === 'marine' ? 'M' : 'RR', obstacle.x + 5, obstacle.y + gameConfig.obstacleHeight * 0.7);
            });
        }

        function gameLoop() {
            if (!isGameRunning) return;
            updateGame();
            drawGame();
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function startGameLoop() {
            if (isGameRunning) return; // Ya está corriendo
            console.log("Starting Game Loop");
            isGameRunning = true;
            resetGame(); // Reinicia el estado del juego cada vez
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            gameLoopId = requestAnimationFrame(gameLoop);
            modalLoadingIndicator.classList.add('active'); // Asegura que el contenedor esté visible
            gameCanvas.style.display = 'block'; // Muestra el canvas
        }

        function stopGameLoop() {
            if (!isGameRunning) return; // Ya está parado
            console.log("Stopping Game Loop");
            isGameRunning = false;
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
                gameLoopId = null;
            }
            document.removeEventListener('keydown', handleKeyDown);
            document.removeEventListener('keyup', handleKeyUp);
            // No ocultar el modalLoadingIndicator aquí, se hace al mostrar contenido/error
            // gameCanvas.style.display = 'none'; // Oculta el canvas
        }


        // ========== API FUNCTIONS ========== (Adaptadas para nuevo contexto y generar 40)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `Eres un asistente de guionista para la historia crossover '${currentStoryTitle}'. Responde preguntas sobre posibles continuaciones, interacciones o detalles relacionados *específicamente con esa historia*.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             // Seed sólo para la historia principal y generación de títulos
             if (config.seed && !isChat) params.append('seed', config.seed);
             // Opcional: Añadir 'max_tokens' si la API lo soporta, para asegurar longitud
             // params.append('max_tokens', '2500'); // Ajustar según API

             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores están experimentando mucho tráfico. Por favor, intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length < (isChat ? 10 : 500)) { // Mínimo más alto para historia
                     throw new Error("La respuesta de la IA fue demasiado corta o vacía. Intenta de nuevo o con otro escenario.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
         }

        async function fetchExplanationText(conceptTitle) {
             return fetchTextFromApi(conceptTitle, textApiConfig, false);
         }
        async function fetchChatResponse(userQuery) {
             if (!currentStoryTitle) throw new Error("Error interno: No se ha establecido el contexto de la historia para el chat.");
             return fetchTextFromApi(userQuery, chatApiConfig, true);
         }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(crossoverThemes) || "crossover DBZ One Piece";
             const specificPrompt = `Genera 40 ideas/títulos de historias crossover entre Dragon Ball y One Piece, enfocadas en ${randomTheme}`;
             console.log("Generating 40 titles with prompt:", specificPrompt);
             // Añadir seed para variedad entre llamadas
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                  .then(text => {
                      // Procesamiento más robusto para 40 líneas
                      const titles = text.split('\n')
                                         .map(line => line.replace(/^[-\d.\s*]+/, '').trim()) // Limpia inicio de línea
                                         .filter(line => line.length > 10 && line.length < 200 && !line.toLowerCase().includes("aquí tienes") && !line.toLowerCase().includes("lista de ideas")) // Filtra líneas inválidas/intros
                                         .slice(0, 40); // Asegura máximo 40
                      if (titles.length < 15) { // Exigir un mínimo razonable
                          console.warn("Generated fewer titles than expected:", titles.length);
                          throw new Error("La IA no generó suficientes ideas de crossovers válidas.");
                      }
                      return titles;
                  });
         }

        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 1024, height: 576, nologo: true }; // 16:9 aspect ratio
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Goku and Luffy fighting together";
            // Prompt más específico para el estilo fusión
            const enhancedPrompt = `Epic anime concept art, dynamic angle, style blending Dragon Ball Z and One Piece, capturing the scene: '${safePromptText}'. Vibrant colors, energy effects, dramatic lighting.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, logo, watermark, signature, multiple panels, collage, bad anatomy, deformed, blurry, low quality, simple background, photorealistic";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
         }

        // ========== Text Formatting Function ========== (Sin cambios)
        function formatExplanationText(rawText){ /* ... */ if(!rawText)return'';let formatted=rawText.trim();formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1');formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('−','-');return`${base}<sup>${cleanExponent}</sup>`;});formatted=formatted.replace(/\\rightarrow/g,'&rarr;');formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>');const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0);formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block;let content=block.replace(/\n/g,' ');return`<p>${content}</p>`;}).join('');return formatted;}

        // ========== MODAL FUNCTIONS ========== (Integrando inicio/parada del juego)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            stopGameLoop(); // Asegura que el juego se detenga al cerrar
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             stopGameLoop(); // Detener juego si estaba activo
             modalLoadingIndicator.classList.remove('active'); // Ocultar loading/game screen
             modalStoryContentArea.classList.remove('visible'); // Ocultar contenido principal
             modalStoryContentArea.classList.add('content-hidden'); // Compatibilidad
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios)
        function showFullscreenImage(imgSrc){if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden';}
        function hideFullscreenImage(){if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src='';}

        // ========== CHAT FUNCTIONS ========== (Sin cambios funcionales)
        function addChatMessage(message, sender) { /* ... */ const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        function addChatError(message){ /* ... */ const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        async function handleSendMessage(){const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Error IA: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}}

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        // function shuffleArray(array){...} // No se usa activamente, pero puede dejarse
        function createTitleItem(title) { const div=document.createElement('div');div.className='title-item';div.textContent=title;div.setAttribute('data-title',title);div.addEventListener('click',()=>handleTitleClick(title));return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar por relevancia o dejar aleatorio? Alfabético puede ser bueno.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = ''; // Limpiar antes de añadir
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay escenarios disponibles. ¡Intenta generar más! «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
             console.log(`Displayed ${sortedTitles.length} titles.`);
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             console.log(`Appending ${newTitles.length} new titles.`);
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => {
                 if (!existingTitles.has(title)) {
                     titleListContainer.appendChild(createTitleItem(title));
                     addedCount++;
                 }
             });
             console.log(`Successfully added ${addedCount} unique titles.`);
             // Re-aplicar filtro actual si existe
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to manage game start/stop ***
        async function handleTitleClick(title) {
            resetModalState(); // Limpia todo, incluyendo parar juego si estaba corriendo
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // Establece contexto para chat
            chatHistory.innerHTML = ''; // Limpiar chat anterior

            // *** START LOADING & GAME ***
            modalLoadingIndicator.classList.add('active'); // Mostrar pantalla de carga
            startGameLoop(); // Iniciar el minijuego

            try {
                // Fetch story in parallel (no await here yet)
                const storyPromise = fetchExplanationText(title);

                // Fetch image URL (quicker usually)
                const imageUrl = createPollinationsImageUrl(title);

                // Await story completion
                const rawExplanationText = await storyPromise;

                 // *** STOP GAME & SHOW CONTENT ***
                 stopGameLoop();
                 modalLoadingIndicator.classList.remove('active'); // Ocultar pantalla de carga/juego
                 modalStoryContentArea.classList.add('visible'); // Mostrar área de contenido
                 modalStoryContentArea.classList.remove('content-hidden');

                // Process and display story
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalContent.innerHTML = formattedExplanation;
                modalTextArea.scrollTop = 0; // Reset scroll

                // Image Handling (similar to before, pero después de parar juego)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando imagen del crossover...</p>`;
                modalContent.appendChild(placeholderDiv);

                if (imageUrl) {
                    const imgElement = document.createElement('img');
                    imgElement.className = 'final-image';
                    imgElement.alt = `Ilustración de ${title}`;
                    imgElement.style.display = 'none';
                    imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                    imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al cargar imagen.</p>`; };
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                    placeholderDiv.innerHTML = `<i class="fas fa-ban placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo generar URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                // *** STOP GAME & SHOW ERROR ***
                stopGameLoop();
                modalLoadingIndicator.classList.remove('active'); // Ocultar pantalla de carga/juego
                modalStoryContentArea.classList.add('visible'); // Mostrar área de contenido para ver error
                modalStoryContentArea.classList.remove('content-hidden');

                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la historia.";
                modalError.classList.remove('content-hidden');
                modalContent.innerHTML = ''; // Limpiar contenido parcial
                chatSection.classList.add('content-hidden'); // Ocultar chat si falla carga principal
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando en el Multiverso...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Ya pide 40
                 if (newTitles && newTitles.length > 0) {
                     appendTitles(newTitles);
                 } else {
                     alert("No se pudieron generar más escenarios ahora mismo.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error generando escenarios: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                  // Texto original del botón
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> ¡Generar 40 Nuevos Crossovers!';
             }
         }

         // *** Search Filter Function (con normalización para acentos) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Ocultar si hay resultados O si no hay títulos en absoluto
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check essential elements, including game canvas
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !gameCanvas || !loadingScoreDisplay) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡ERROR DE FUSIÓN! Faltan componentes vitales de la página.</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>