<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recetario Avanzado del Chef Casero</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes: Lato/Merriweather + Fuente Script para el logo -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Merriweather:wght@400;700&family=Satisfy&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Recetas Avanzadas --- */
        :root {
            --color-primary: #a0522d; /* Sienna (Terracota/Marrón Cálido) */
            --color-secondary: #daa520; /* Goldenrod (Dorado/Mostaza) */
            --color-background: #fffaf0; /* FloralWhite (Crema muy claro) */
            --color-text: #5d4037; /* Brown darken-2 (Marrón oscuro) */
            --color-text-muted: #a1887f; /* Brown lighten-1 */
            --color-modal-bg: #fdf5e6; /* OldLace (Blanco roto cálido) */
            --color-border: #d7ccc8; /* Brown lighten-3 (Borde suave) */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.08);
            --shadow-md: 0 3px 5px -1px rgb(0 0 0 / 0.1), 0 2px 3px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 8px 12px -3px rgb(0 0 0 / 0.15), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 5px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; }
        /* Logo con fuente script */
        h1.logo { font-family: 'Satisfy', cursive; font-weight: normal; color: var(--color-primary); font-size: 2.8rem; /* Ajustar tamaño según sea necesario */ }
        h1.page-title, h2.section-title, #modal-title { font-family: 'Merriweather', serif; font-weight: 700; }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        #modal-title { color: var(--color-primary); }
        .navbar { background-color: rgba(253, 245, 230, 0.9); /* Modal BG con transparencia */ backdrop-filter: blur(4px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }

        /* --- Search Input Styling --- */
        #search-container { margin-bottom: 2rem; position: relative; }
        #search-input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.7rem; /* Padding left for icon */
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-normal);
            background-color: var(--color-modal-bg); /* Fondo ligeramente distinto */
        }
        #search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(160, 82, 45, 0.2); /* Sombra con color primario */
        }
        #search-container .fa-search {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-muted);
            pointer-events: none;
        }

        /* --- Title List Styling (Recipe Cards) --- */
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.5rem; }
        .title-item {
            background-color: var(--color-modal-bg);
            padding: 1.5rem 1.2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: var(--transition-normal);
            text-align: center;
            font-weight: 600;
            color: var(--color-text);
            border: 1px solid var(--color-border);
            display: flex;
            flex-direction: column; /* Para icono arriba, texto abajo */
            align-items: center;
            justify-content: center;
            min-height: 90px; /* Un poco más alto */
            font-family: 'Lato', sans-serif;
        }
         .title-item i { /* Icono opcional dentro del item */
            font-size: 1.5rem;
            color: var(--color-secondary);
            margin-bottom: 0.6rem;
        }
        .title-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
            color: var(--color-primary);
            background-color: #fff8e1; /* Amarillo muy pálido hover */
        }
        .title-item:hover i { color: var(--color-primary); }

        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #8b4513; box-shadow: var(--shadow-sm); } /* SaddleBrown */
        #generate-more-btn:disabled { background-color: #bc8f8f; cursor: not-allowed; opacity: 0.8; } /* RosyBrown */
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(93, 64, 55, 0.88); /* Brown darken-3 overlay */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 2rem 2.5rem;
            max-width: 980px; /* Más ancho para recetas */
            width: 95%;
            max-height: 90vh;
            min-height: 400px; /* Más altura mínima */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--color-border);
        }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: #e0e0e0; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: #757575; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #bdbdbd; color: #000; }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.8rem; flex-shrink: 0; padding: 0 1.5rem; line-height: 1.35; }
        #modal-content { /* Scrollable content area */
            line-height: 1.8; /* Más interlineado */
            color: var(--color-text);
            white-space: normal;
            overflow-y: auto;
            padding: 0 20px 2rem 20px; /* Más padding */
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content::-webkit-scrollbar { width: 10px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: #8b4513; font-style: italic; } /* Énfasis en marrón oscuro */
        #modal-content ul, #modal-content ol { margin-left: 2rem; margin-bottom: 1.4em; }
        #modal-content li { margin-bottom: 0.6em; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: bold; }
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.45em; }
        #modal-content h3 { font-size: 1.3em; color: #8b4513; } /* Darker primary */
        #modal-content h4 { font-size: 1.15em; color: var(--color-text-muted); border-bottom: none;}

        /* --- Image within Content Styling --- */
        #modal-content .final-image { display: block; max-width: 75%; /* Más pequeña para recetas */ height: auto; margin: 2.5rem auto 1.5rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; /* Más alto */ margin: 2.5rem auto 1.5rem auto; color: var(--color-text-muted); text-align: center; background-color: #f5f5f5; border: 1px dashed var(--color-border); border-radius: var(--border-radius); padding: 1rem; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3.5rem; margin-bottom: 0.5rem;}

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(253, 245, 230, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 7px solid #d7ccc8; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.3rem; font-family: 'Lato'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #ffebee; color: #c62828; padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #ef9a9a; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
        #no-results-message { text-align: center; color: var(--color-text-muted); padding: 2rem; grid-column: 1 / -1; font-style: italic; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-3 flex justify-center items-center"> <!-- Menos padding vertical -->
             <div class="flex items-center text-center">
                  <!-- Usando un ícono de chef o utensilios -->
                 <i class="fas fa-hat-chef text-4xl mr-4" style="color: var(--color-secondary);"></i>
                 <h1 class="logo">Chef Casero Pro</h1>
                 <i class="fas fa-utensils text-4xl ml-4" style="color: var(--color-secondary);"></i>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-10 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Eleva tu Cocina Casera</h1>
             <p class="text-xl text-gray-700 mb-6 max-w-3xl mx-auto">Domina técnicas complejas y prepara platos extraordinarios. Busca una receta o técnica, o explora nuestras sugerencias de alta cocina.</p>
             <!-- Search Input -->
             <div id="search-container" class="max-w-2xl mx-auto">
                 <i class="fas fa-search"></i>
                 <input type="text" id="search-input" placeholder="Buscar receta, técnica o ingrediente clave...">
             </div>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-book-open text-brown-700 mr-2"></i> <!-- Icono libro -->
                 Recetas y Técnicas Destacadas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Consultando el recetario...</p>
                  <!-- No results message will be injected here by JS -->
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Buscar Más Recetas
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Preparando receta...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - Image appended here -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Recipe text (HTML) goes here -->
                     <!-- Image and placeholder will be appended here by JS -->
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Preparando receta...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - Image appended here -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Recipe text (HTML) goes here -->
                     <!-- Image and placeholder will be appended here by JS -->
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-300">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Recetas y técnicas generadas por IA para inspirar a cocineros caseros avanzados.</p>
              <p class="mt-1">Adapta las recetas a tu gusto y equipo. ¡La práctica hace al maestro!</p>
              <p class="mt-2">© 2025 Chef Casero Pro</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Técnicas Francesas Clásicas
            "Dominar la Salsa Béchamel y sus Derivadas (Mornay, Soubise)", "Salsa Velouté: Base para Salsas Blancas de Ave y Pescado", "Salsa Española (Demi-glace Casera): El Fundamento Oscuro", "Salsa Holandesa Perfecta: Emulsión y Temperatura", "Salsa Bearnesa: La Hermana Estragonada de la Holandesa", "Técnica del Confit: Pato, Cerdo o Ajo", "Clarificación de Mantequilla (Ghee Casero)", "Preparación de un Fondo Oscuro de Res o Ternera (Stock)", "Preparación de un Fondo Claro de Ave o Pescado (Fumet)", "Técnica Sous-Vide para Carnes Rojas: Precisión y Terneza", "Técnica Sous-Vide para Pescados Delicados", "Gratinado Perfecto: Dauphinoise vs. Pommes Boulangère", "Soufflé Salado de Queso: El Arte del Aire", "Soufflé Dulce de Chocolate o Frutas: Ligereza y Sabor", "Pâté en Croûte: Construcción y Horneado", "Terrina de Campaña (Pâté de Campagne) Casera", "Galantina de Ave: Deshuesado y Relleno", "Boeuf Bourguignon Tradicional: Estofado Lento", "Coq au Vin Auténtico: Pollo al Vino Tinto", "Cassoulet Clásico: Frijoles, Pato y Salchichas", "Blanquette de Veau (Ternera en Salsa Blanca)", "Navarin de Cordero Primaveral", "Sole Meunière: Técnica y Sencillez", "Brandada de Bacalao: Emulsión y Textura", "Quenelles de Lucio en Salsa Nantua", "Vol-au-vent Caseros: Hojaldre y Rellenos Clásicos", "Tournedos Rossini: Solomillo, Foie y Trufa", "Magret de Pato con Salsa de Naranja (Canard à l'Orange)", "Ratatouille Clásico: Cocción Separada de Vegetales", "Tarta Tatin de Manzana: Caramelo y Hojaldre", "Crème Brûlée Perfecta: Textura y Caramelo", "Mousse de Chocolate Clásica: Aireación y Textura", "Clafoutis de Cerezas (o Frutas de Temporada)", "Paris-Brest: Masa Choux y Crema Praliné", "Éclairs Perfectos: Forma y Relleno", "Profiteroles con Salsa de Chocolate Caliente", "Macarons Franceses: Merengue y Ganache", "Madeleines Esponjosas: El Secreto de la 'Panza'", "Canelés de Bordeaux: Exterior Crujiente, Interior Tierno", "Tarta Bourdaloue (Peras y Crema de Almendras)",
            // Panadería y Pastelería Avanzada
            "Masa Madre (Sourdough): Creación y Mantenimiento desde Cero", "Pan de Masa Madre Básico: Amasado, Fermentación y Horneado", "Pan Integral de Masa Madre con Semillas", "Pan de Centeno Estilo Nórdico con Masa Madre", "Baguette Tradicional Francesa: Amasado, Formado y Greñado", "Ciabatta Italiana: Alta Hidratación y Alveolos", "Focaccia con Poolish: Textura y Sabor", "Pan Brioche Clásico: Enriquecido con Mantequilla y Huevo", "Panettone Casero: Fermentación Lenta y Frutas Confitadas", "Stollen Alemán Navideño", "Masa de Hojaldre Clásica (Pâte Feuilletée): Laminado y Vueltas", "Hojaldre Invertido: Técnica y Ventajas", "Croissants Caseros: Laminado de Mantequilla y Levadura", "Pain au Chocolat Casero", "Masa Danesa (Danish Pastry): Variedad de Formas y Rellenos", "Masa Choux (Pâte à Choux): Base para Éclairs, Profiteroles, Gougères", "Pasta Filo Casera: Estirado Fino", "Baklava Tradicional: Capas de Filo, Nueces y Almíbar", "Strudel de Manzana Vienés con Masa Estirada a Mano", "Entremet Moderno: Capas, Texturas y Glaseado Espejo", "Opera Cake: Capas de Bizcocho, Café y Ganache", "Tarta Fraisier: Fresas, Crema Mousseline y Genoise", "Selva Negra Auténtica (Schwarzwälder Kirschtorte)", "Sacher Torte Vienesa: Chocolate y Mermelada de Albaricoque", "Tiramisú Clásico Italiano: Savoiardi Caseros", "Cheesecake Estilo New York Horneado Perfecto", "Cheesecake Japonés Esponjoso (Soufflé Cheesecake)", "Dacquoise de Almendra o Avellana", "Bizcocho Genovés Ligero (Genoise)", "Bizcocho Sacher (Sachermasse)", "Merengue Italiano Estable: Almíbar Caliente", "Merengue Suizo Brillante: Baño María", "Crema Pastelera Clásica y sus Variantes (Diplomat, Chiboust)", "Crema Inglesa (Crème Anglaise) Perfecta", "Crema de Mantequilla (Buttercream) Suiza o Italiana", "Ganache Montada Ligera", "Caramelo Salado Casero: Punto y Textura", "Praliné de Avellanas o Almendras Casero", "Decoraciones de Chocolate: Templado y Formas", "Glaseado Espejo (Mirror Glaze) Brillante", "Pasta de Goma para Flores y Modelado", "Fondant Casero de Nubes (Malvavisco)", "Trabajo con Isomalt: Decoraciones Transparentes",
            // Cocina Italiana Avanzada
            "Pasta Fresca al Huevo desde Cero: Amasado y Estirado", "Pasta Fresca de Sémola (Sin Huevo): Orecchiette, Cavatelli", "Ravioli Caseros: Rellenos y Sellado Perfecto", "Tortellini in Brodo: Relleno Tradicional y Caldo", "Agnolotti del Plin (Piamonte)", "Lasagna alla Bolognese Tradicional (con Ragú y Béchamel)", "Risotto Perfecto: Tostado, Caldo y Mantecatura (Ej. ai Funghi Porcini)", "Risotto alla Milanese (con Azafrán y Tuétano)", "Osso Buco alla Milanese con Gremolata", "Saltimbocca alla Romana: Ternera, Prosciutto y Salvia", "Vitello Tonnato: Ternera Fría con Salsa de Atún", "Arancini Sicilianos: Bolas de Risotto Rellenas", "Polenta Cremosa vs. Polenta Firme (a la Parrilla)", "Gnocchi di Patate Ligeros: El Secreto", "Pesto Genovese Auténtico (con Mortero)", "Ragú alla Bolognese Cocinado a Fuego Lento", "Salsa Amatriciana vs. Salsa Carbonara (Guanciale)", "Fritto Misto di Mare: Fritura Perfecta", "Caponata Siciliana: Berenjenas Agridulces", "Parmigiana di Melanzane (Berenjenas a la Parmesana)", "Bistecca alla Fiorentina: Corte y Cocción", "Porchetta Asada Casera: Deshuesado y Enrollado", "Cacciucco alla Livornese (Sopa de Pescado Toscana)", "Cannoli Sicilianos: Tubos Crujientes y Ricotta Dulce", "Panna Cotta Perfecta: Textura y Gelatina", "Zuppa Inglese: Capas de Crema y Bizcocho", "Semifreddo Italiano: Textura Helada sin Máquina",
            // Cocina Española Avanzada
            "Paella Valenciana Auténtica (a Leña si es posible)", "Arroz Negro con Alioli Casero", "Arroz a Banda", "Fideuà de Marisco", "Zarzuela de Mariscos", "Suquet de Peix (Guiso de Pescado Catalán)", "Marmitako de Bonito (Guiso Vasco)", "Bacalao al Pil Pil: Emulsión de Ajo y Aceite", "Kokotxas de Merluza en Salsa Verde", "Merluza a la Koskera", "Percebes Gallegos: Cocción Perfecta (si se encuentran)", "Pulpo a Feira (Pulpo a la Gallega): Cocción y Aliño", "Fabada Asturiana Tradicional", "Cocido Madrileño en Tres Vuelcos", "Callos a la Madrileña", "Rabo de Toro Estofado", "Cochinillo Asado Estilo Segoviano: Piel Crujiente", "Cordero Asado Estilo Castellano", "Chuletillas de Cordero al Sarmiento", "Pisto Manchego Tradicional", "Escalivada Catalana: Asado de Verduras", "Gazpacho Andaluz Clásico vs. Salmorejo Cordobés", "Ajoblanco Malagueño con Uvas", "Tortilla Española Jugosa: El Punto Perfecto", "Croquetas Caseras Cremosas (Jamón, Pollo, Bacalao)", "Gambas al Ajillo Chispeantes", "Calamares a la Romana (Fritura Ligera)", "Boquerones en Vinagre Caseros", "Empanada Gallega (Atún, Carne, Zamburiñas)", "Tarta de Santiago: Almendra y Tradición", "Crema Catalana Quemada", "Leche Frita", "Torrijas de Semana Santa", "Flan de Huevo Casero Perfecto", "Tocino de Cielo",
            // Cocina Asiática Avanzada (Ejemplos)
            "Ramen Casero Completo: Caldo Tonkotsu o Shoyu, Chashu, Huevo Ajitama", "Sushi y Sashimi: Corte de Pescado, Preparación de Arroz y Enrollado (Makis, Nigiris)", "Tempura Japonesa Ligera y Crujiente", "Okonomiyaki Japonés (Estilo Osaka o Hiroshima)", "Gyoza Japonesas Caseras: Relleno y Pliegues", "Katsudon (Cuenco de Arroz con Cerdo Empanado)", "Unadon (Cuenco de Arroz con Anguila a la Parrilla)", "Pato Pekín Casero: Secado de Piel y Asado", "Dim Sum Variado Casero (Har Gow, Siu Mai, Char Siu Bao)", "Mapo Tofu Sichuan Auténtico (Picante y Adormecedor)", "Pollo Kung Pao (Gong Bao) Tradicional", "Cerdo Char Siu (Asado Chino) Casero", "Sopa Pho Vietnamita Completa: Caldo de Huesos y Especias", "Bánh Xèo Vietnamita (Crepe Crujiente)", "Rollitos de Verano Vietnamitas (Gỏi Cuốn) con Salsa de Cacahuete", "Curry Verde Tailandés desde Cero (Pasta de Curry Casera)", "Curry Massaman Tailandés Complejo", "Tom Yum Goong (Sopa Picante de Gambas) Auténtica", "Pad See Ew Tailandés (Fideos Anchos Salteados)", "Mango Sticky Rice Tailandés", "Kimchi Coreano Casero: Fermentación Larga", "Bibimbap Coreano Completo con Gochujang", "Bulgogi Coreano Marinado y a la Parrilla", "Japchae Coreano (Fideos de Boniato Salteados)", "Pollo Frito Coreano Doble Fritura", "Biryani de Cordero o Pollo (Estilo Hyderabadi)", "Curry de Pescado Goan", "Pollo Tikka Masala Auténtico (vs. Butter Chicken)", "Rogan Josh Cachemir", "Dal Makhani (Lentejas Negras Cremosas)", "Samosas Caseras Perfectas: Masa y Relleno", "Pan Naan Casero en Sartén o Tandoor (si se tiene)", "Gulab Jamun Casero", "Kulfi (Helado Indio)",
            // Técnicas de Conservación y Fermentación Avanzada
            "Chucrut Casero (Sauerkraut): Fermentación Láctica", "Pepinillos Fermentados (Estilo Kosher Dill)", "Kombucha Casera: Preparación del SCOBY y Segunda Fermentación", "Kéfir de Agua o Leche Casero", "Vinagre Casero (de Vino, Manzana)", "Mostaza Casera Fermentada", "Salsa Picante Fermentada (Tipo Sriracha o Tabasco Casero)", "Miso Casero (Fermentación Larga)", "Tempeh Casero desde Frijol de Soja", "Vegetales en Escabeche Complejo (Italiano, Español)", "Conservas Caseras Seguras: Esterilización y Envasado al Vacío (Frutas, Tomates)", "Mermeladas y Confituras con Pectina Natural o Añadida", "Frutas Confitadas Caseras (Naranja, Limón, Calabaza)", "Licor de Hierbas o Frutas Casero (Ej. Limoncello, Pacharán)", "Charcutería Básica: Curado de Panceta (Bacon Casero)", "Salchichas Frescas Caseras: Embutido y Condimento", "Pastrami Casero: Curado, Ahumado y Cocción",
            // Otros Platos y Técnicas Avanzadas
            "Cocina Molecular Básica en Casa: Esferificación Directa e Inversa (Caviar Falso)", "Espumas Ligeras con Sifón (de Patata, Remolacha)", "Aires con Lecitina de Soja", "Gelatinas Calientes con Agar-Agar", "Cocción a Baja Temperatura (sin Sous-Vide): Horno o Baño María Controlado", "Ahumado en Frío Casero (Salmón, Queso)", "Ahumado en Caliente Casero (Costillas, Pollo)", "Helados Caseros con Base de Crema Inglesa (sin máquina)", "Sorbete de Frutas Naturales Perfecto", "Decoración de Platos Avanzada: Técnicas de Emplatado", "Maridaje Básico de Vinos y Comida", "Extracción de Zumos y Clarificación para Consomés", "Trabajo con Hojas de Gelatina vs. Gelatina en Polvo", "Uso de Espesantes Modernos (Xantana, Goma Guar)", "Cocina con Flores Comestibles", "Preparación de Casquería Fina (Mollejas, Hígado de Ternera)", "Cocina con Caza Menor (Conejo, Perdiz)", "Risotto Negro de Sepia", "Bullabesa Marsellesa Auténtica", "Wellington de Solomillo Perfecto", "Cordero en Costra de Hierbas", "Pastel de Pastor (Shepherd's Pie) vs. Cottage Pie Elevado", "Tarta de Limón y Merengue Italiana Perfecta", "Pavlova Crujiente por Fuera, Tierna por Dentro", "Babà al Ron Napolitano", "Zuger Kirschtorte (Tarta Suiza de Kirsch)", "Dobos Torte Húngara (Capas Finas y Caramelo)", "Linzer Torte Austriaca (Masa de Avellana y Mermelada)", "Princesstårta Sueca (Mazapán Verde)", "Empanadas Argentinas de Carne Cortada a Cuchillo", "Mole Poblano Mexicano Complejo", "Chiles en Nogada Mexicanos", "Ceviche Peruano Clásico vs. Nikkei", "Ají de Gallina Peruano Cremoso", "Lomo Saltado Peruano", "Causa Limeña Rellena", "Anticuchos de Corazón Peruanos", "Feijoada Brasileña Completa", "Moqueca de Peixe Baiana (Guiso Brasileño de Pescado)", "Pão de Queijo Brasileño (Pan de Queso)", "Arepas Rellenas Venezolanas/Colombianas (con rellenos complejos)", "Sancocho de Gallina Colombiano/Panameño", "Cuscús Marroquí con Siete Verduras", "Tajine de Cordero con Ciruelas y Almendras", "Pastilla Marroquí (Hojaldre de Pollo y Almendras)"
        ];
        const recipeThemes = [ // Temas para generar más títulos
            "técnicas de cocina francesa clásica", "panadería con masa madre (sourdough)", "pastelería con masas laminadas (hojaldre, croissant)",
            "recetas italianas regionales complejas", "técnicas de pasta fresca rellena", "cocina española tradicional avanzada",
            "fermentación casera (kimchi, kombucha, chucrut)", "técnicas de sous-vide", "pastelería europea clásica (Sacher, Selva Negra, Opera)",
            "cocina asiática auténtica (ramen, curry casero, dim sum)", "ahumado casero en frío y caliente", "charcutería casera básica (paté, terrina, bacon)",
            "cocina molecular para principiantes en casa", "heladería artesanal casera", "conservas y encurtidos gourmet",
            "recetas de caza menor", "platos complejos de cocción lenta", "técnicas de decoración de tartas avanzadas",
            "cocina latinoamericana elaborada (mole, feijoada)", "recetas con casquería fina", "maridaje de vinos para cocineros",
            "emplatado y presentación de platos", "técnicas de emulsión (holandesa, mayonesa casera)", "trabajo con chocolate (templado, ganache)"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un chef experimentado y escritor culinario especializado en cocina casera avanzada y técnicas profesionales adaptadas al hogar. Tu tarea es describir la siguiente receta o técnica compleja de forma exhaustiva, didáctica y motivadora para cocineros caseros ambiciosos. Incluye: una introducción sobre el plato/técnica, su origen o contexto; lista detallada de ingredientes (con posibles sustituciones); equipo especializado necesario (si aplica); instrucciones paso a paso MUY detalladas, enfatizando los puntos críticos, técnicas específicas (amasado, laminado, emulsión, cocción, fermentación, etc.) y posibles errores a evitar; consejos para la mise en place; sugerencias de presentación y maridaje (si aplica); y notas sobre variaciones o cómo adaptar la receta. Usa un lenguaje preciso pero alentador. El objetivo es un texto de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en la siguiente receta o técnica:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un recetario de cocina avanzada. Genera exactamente 15 títulos de recetas complejas, técnicas culinarias específicas o conceptos de pastelería/panadería desafiantes, adecuados para una explicación detallada para cocineros caseros experimentados. Prioriza procesos multi-paso, ingredientes menos comunes o técnicas que requieran precisión. Devuelve *solo* la lista de títulos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Igual que versión Colombia)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        let noResultsMessageElement = null;

        // ========== API FUNCTIONS ========== (Sin cambios en la lógica central)
        async function fetchTextFromApi(prompt, config) { /* ... */
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo.`);
                 throw new Error(`Error de comunicación con la API: ${error.message}`);
             }
         }
        async function fetchExplanationText(conceptTitle) { /* ... */
            const text = await fetchTextFromApi(conceptTitle, textApiConfig);
             if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de")) {
                  throw new Error("La IA no pudo generar una receta/explicación adecuada o suficientemente detallada para este término.");
              }
            return text;
        }
        async function fetchGeneratedTitles() { /* ... */
            const randomTheme = getRandomElement(recipeThemes) || "técnicas culinarias avanzadas";
            const specificPrompt = `Genera 15 títulos de recetas o técnicas sobre ${randomTheme}`;
            console.log("Generating titles with prompt:", specificPrompt);
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
            // Filter generated titles slightly more strictly for recipes
            const titles = text.split('\n')
                              .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                              .filter(line => line.length > 10 && line.length < 150 && !line.toLowerCase().startsWith("generar") && !line.toLowerCase().includes("lista de") && !line.toLowerCase().includes("aquí tienes"));
            if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de recetas.");
            return titles.slice(0, 15);
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a RECETAS
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 700, height: 525, nologo: true }; // Slightly smaller aspect ratio maybe
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText.split(':')[0].trim() : "plato gourmet casero"; // Clean up title a bit
            // Prompt ENFOCADO en la comida final, bien presentada
            const enhancedPrompt = `Professional food photography capturing the finished dish: '${safePromptText}'. Focus on perfect plating, textures, vibrant colors, dramatic lighting, appetizing details. Shallow depth of field. Gourmet home cooking style.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, writing, recipe book, kitchen counter, messy background, hands, people, cartoon, illustration, drawing, sketch, diagram, ugly food, poorly lit, multiple dishes";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();

            // --- Basic Markdown & Formatting ---
            // Headers (keep simple, maybe adjust later if needed)
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');

            // Bold and Italic
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // --- List Handling (More Robust) ---
            // Unordered Lists (lines starting with * or -)
            formatted = formatted.replace(/^\s*[-*+]\s+(.*)$/gm, '<li>$1</li>');
            formatted = formatted.replace(/<\/li>\n<li>/gm, '</li><li>'); // Compact list items
            formatted = formatted.replace(/(<li>.*<\/li>)/gs, (match) => `<ul>\n${match}\n</ul>`); // Wrap consecutive LIs in UL
             formatted = formatted.replace(/<\/ul>\n<ul>/gm, ''); // Merge adjacent ULs

            // Ordered Lists (lines starting with number.)
            formatted = formatted.replace(/^\s*\d+\.\s+(.*)$/gm, '<li class="ordered">$1</li>'); // Use a class temporarily
             formatted = formatted.replace(/<\/li>\n<li class="ordered">/gm, '</li><li class="ordered">'); // Compact list items
             formatted = formatted.replace(/(<li class="ordered">.*<\/li>)/gs, (match) => `<ol>\n${match}\n</ol>`); // Wrap consecutive LIs in OL
             formatted = formatted.replace(/<\/ol>\n<ol>/gm, ''); // Merge adjacent OLs
             formatted = formatted.replace(/ class="ordered"/g, ''); // Remove temporary class

            // --- Paragraph Handling ---
            const blocks = formatted.split(/\n\s*\n/); // Split by blank lines
            formatted = blocks.map(block => {
                 block = block.trim();
                 if (!block) return '';
                 // Keep existing HTML blocks (headers, lists)
                 if (block.startsWith('<h') || block.startsWith('<ul') || block.startsWith('<ol')) {
                     return block;
                 }
                 // Wrap remaining blocks in <p>, converting single newlines to <br>
                 return `<p>${block.replace(/\n/g, '<br>')}</p>`;
             }).filter(block => block.length > 0).join('\n'); // Join with newline for readability in source

             // Final cleanup: Remove potential empty paragraphs generated
             formatted = formatted.replace(/<p>\s*<\/p>/g, '');

             return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Igual que versión anterior)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (Search logic same as Colombia)
        function getRandomElement(arr) { /* ... */ return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // --- Add Icon based on keywords (Optional Enhancement) ---
            let iconClass = 'fa-utensils'; // Default
            const lowerTitle = title.toLowerCase();
            if (lowerTitle.includes('pan') || lowerTitle.includes('masa madre') || lowerTitle.includes('hojaldre') || lowerTitle.includes('croissant') || lowerTitle.includes('brioche') || lowerTitle.includes('baguette')) iconClass = 'fa-bread-slice';
            else if (lowerTitle.includes('pastel') || lowerTitle.includes('tarta') || lowerTitle.includes('macaron') || lowerTitle.includes('éclair') || lowerTitle.includes('soufflé') || lowerTitle.includes('mousse') || lowerTitle.includes('crema') || lowerTitle.includes('helado') || lowerTitle.includes('postre')) iconClass = 'fa-birthday-cake'; // fa-ice-cream
            else if (lowerTitle.includes('salsa') || lowerTitle.includes('fondo') || lowerTitle.includes('emulsión')) iconClass = 'fa-mortar-pestle';
            else if (lowerTitle.includes('fermenta') || lowerTitle.includes('kimchi') || lowerTitle.includes('kombucha') || lowerTitle.includes('chucrut')) iconClass = 'fa-wine-bottle'; // fa-vial
            else if (lowerTitle.includes('ahumado') || lowerTitle.includes('curado') || lowerTitle.includes('charcutería') || lowerTitle.includes('pâté')) iconClass = 'fa-smoking';
            else if (lowerTitle.includes('sushi') || lowerTitle.includes('pescado') || lowerTitle.includes('marisco') || lowerTitle.includes('ceviche')) iconClass = 'fa-fish';
             else if (lowerTitle.includes('pato') || lowerTitle.includes('pollo') || lowerTitle.includes('ave')) iconClass = 'fa-drumstick-bite'; // Chicken leg
            div.innerHTML = `<i class="fas ${iconClass}"></i><span>${title}</span>`; // Add icon and text
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
         }

        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]);
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) {
                 showNoResultsMessage("No hay recetas iniciales disponibles.");
                 return;
             }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
             filterTitles(); // Apply current search filter
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const searchTerm = searchInput.value.toLowerCase().trim();
             newTitles.forEach(title => {
                 const item = createTitleItem(title);
                 if (searchTerm === '' || title.toLowerCase().includes(searchTerm)) {
                     item.style.display = 'flex';
                 } else {
                     item.style.display = 'none';
                 }
                 titleListContainer.appendChild(item);
             });
             checkIfAnyResultsVisible();
         }
        function filterTitles() {
             if (!searchInput || !titleListContainer) return;
             const searchTerm = searchInput.value.toLowerCase().trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const title = item.getAttribute('data-title').toLowerCase(); // Search on original title
                 if (title.includes(searchTerm)) {
                     item.style.display = 'flex';
                     visibleCount++;
                 } else {
                     item.style.display = 'none';
                 }
             });
             updateNoResultsMessage(visibleCount);
         }
        function updateNoResultsMessage(visibleCount) {
             if (!titleListContainer) return;
             if (noResultsMessageElement) {
                 noResultsMessageElement.remove();
                 noResultsMessageElement = null;
             }
             if (visibleCount === 0 && titleListContainer.children.length > 0 && titlesLoading.style.display === 'none') {
                  showNoResultsMessage(`No se encontraron recetas para "${searchInput.value}"`);
             }
        }
        function showNoResultsMessage(message) {
             if (noResultsMessageElement || !titleListContainer) return;
             noResultsMessageElement = document.createElement('p');
             noResultsMessageElement.id = 'no-results-message';
             noResultsMessageElement.textContent = message;
             titleListContainer.appendChild(noResultsMessageElement);
        }
         function checkIfAnyResultsVisible() {
             const visibleItems = titleListContainer.querySelectorAll('.title-item[style*="display: flex"]');
             updateNoResultsMessage(visibleItems.length);
         }

        // *** MODIFIED: handleTitleClick (Image logic same) ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText); // Use the enhanced formatter

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalContent.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // --- Image Handling (Append after text) ---
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-camera placeholder-icon"></i> <!-- Icono cámara -->
                    <p style="font-size: 0.9em; margin-top: 0.5rem;">Emplatando imagen...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Plato terminado: ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-image-slash placeholder-icon"></i> <!-- Icono error imagen -->
                        <p style="font-size: 0.9em; margin-top: 0.5rem;">Error al cargar la imagen.</p>
                    `;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle placeholder-icon"></i>
                        <p style="font-size: 0.9em; margin-top: 0.5rem;">Error al generar URL de imagen.</p>
                    `;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
            }
        }

        async function handleGenerateMoreTitles() { // (Thematic text changes)
             if (!generateMoreBtn || !generateMoreContainer) return;
             const spinner = generateMoreBtn.querySelector('i');
             generateMoreBtn.disabled = true;
             if(spinner) spinner.classList.remove('hidden');
             generateMoreBtn.childNodes[generateMoreBtn.childNodes.length - 1].nodeValue = " Cocinando ideas..."; // Thematic

             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block';
                 } else {
                     alert("No se encontraron más ideas de recetas en este momento.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar recetas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 if(spinner) spinner.classList.add('hidden');
                 generateMoreBtn.childNodes[generateMoreBtn.childNodes.length - 1].nodeValue = " Buscar Más Recetas"; // Thematic
                 checkIfAnyResultsVisible();
             }
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput) { console.error("Init fail."); document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡Desastre en la Cocina! Error crítico al iniciar el recetario.</p>'; return; } // Thematic error
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            searchInput.addEventListener('input', filterTitles);
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>