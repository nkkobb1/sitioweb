<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hábitos Financieros: Riqueza vs Pobreza - Análisis Comparativo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Profesionales -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados: Hábitos Financieros --- */
        :root {
            --color-primary: #1d4ed8; /* Azul Fuerte (Confianza, Estabilidad) */
            --color-secondary: #ca8a04; /* Dorado Oscuro (Riqueza, Valor) - Uso moderado */
            --color-tertiary: #16a34a; /* Verde (Crecimiento, Positivo) */
            --color-background: #f8fafc; /* Blanco Hueso / Gris muy claro */
            --color-text: #1f2937; /* Gris Muy Oscuro */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco */
            --color-border: #e5e7eb; /* Borde Gris Claro */
            --color-error-bg: #fef2f2; /* Fondo error rojo claro */
            --color-error-text: #991b1b; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px; /* Bordes redondeados suaves */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Poppins', sans-serif; font-weight: 600; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 600; }
        #modal-title { color: var(--color-primary); font-weight: 600; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Inter'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 500; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Inter'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #eff6ff; /* Azul muy claro */ border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Poppins', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1e3a8a; /* Azul más oscuro */ box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Asegurar espacio para juego y contenido */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e5e7eb; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 1.7rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.4; }

        #modal-story-content-area { /* Contiene texto+imagen Y error */
            flex-grow: 1; min-height: 0; /* Crucial para flexbox scroll */
            display: flex; flex-direction: column;
            position: relative; /* Para posicionar error */
        }
        #modal-content-scroll-wrapper { /* Nuevo wrapper para scroll de texto+imagen */
            overflow-y: auto; flex-grow: 1; padding-right: 10px; /* Espacio scrollbar */
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-scroll-wrapper::-webkit-scrollbar { width: 8px; }
        #modal-content-scroll-wrapper::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-scroll-wrapper::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px 1rem 5px; } /* Padding interno del texto */
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-tertiary); font-style: normal; font-weight: 500; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Poppins', sans-serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 500; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; }
        /* Imagen y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); text-align: center;}
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(200, 200, 200, 0.6); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }

        /* Loading Screen & Minigame */
        #modal-loading { text-align: center; padding: 2rem 1rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: none; /* Oculto inicialmente */ flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #modal-loading.active { display: flex; } /* Mostrar cuando carga */
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p.loading-text { font-weight: 500; color: var(--color-text); font-size: 1.2rem; font-family: 'Poppins'; margin-bottom: 1.5rem; }
        #loading-minigame { width: 90%; max-width: 350px; height: 180px; background-color: #eef2ff; border: 2px dashed var(--color-primary); border-radius: var(--border-radius); position: relative; overflow: hidden; cursor: crosshair; margin-top: 1rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        #minigame-target { width: 40px; height: 40px; background-color: var(--color-tertiary); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1); cursor: pointer; transition: transform 0.1s ease, background-color 0.1s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; }
        #minigame-target i { color: white; font-size: 1.2rem; }
        #minigame-target:active { transform: translate(-50%, -50%) scale(0.9); background-color: #15803d; } /* Feedback click */
        #minigame-info { margin-top: 0.8rem; font-size: 0.95rem; color: var(--color-text-muted); }
        #minigame-score { font-weight: 600; color: var(--color-primary); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Error Msg: Posicionado abajo, dentro del area principal */
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1rem 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); text-align: center; font-weight: 500; font-family: 'Inter'; margin: 1rem 0; /* Añade margen superior/inferior */ flex-shrink: 0; /* No debe crecer */ }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay (sin cambios) */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(30, 41, 55, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-chart-line mr-3 text-green-600"></i> <!-- Icono gráfico -->
                     Hábitos Financieros
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wide">» Análisis Comparativo «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Diferencias Clave: Hábitos de Riqueza vs. Pobreza</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora los patrones de comportamiento, mentalidades y estrategias que distinguen la acumulación de riqueza de la permanencia en la pobreza. Basado en observaciones y estudios populares.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar hábito o mentalidad...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-list-ul text-blue-600 mr-2"></i> <!-- Icono lista -->
                 Índice de Hábitos Comparados
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando análisis de hábitos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún hábito coincide con los parámetros de búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar +40 Comparativas Adicionales
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p class="loading-text">Analizando datos... Mientras esperas:</p>
                 <!-- Minigame Area -->
                 <div id="loading-minigame">
                     <div id="minigame-target"><i class="fas fa-dollar-sign"></i></div> <!-- Target -->
                 </div>
                 <div id="minigame-info">Puntuación: <span id="minigame-score">0</span></div>
             </div>

             <!-- Content Area Wrapper (Text/Image Scroll + Error) -->
             <div id="modal-story-content-area" class="content-hidden">
                 <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Scrollable Text/Image Wrapper -->
                 <div id="modal-content-scroll-wrapper">
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay (sin cambios) -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Análisis comparativo de hábitos basado en observaciones populares (p.ej., Tom Corley) y principios de desarrollo personal.</p>
              <p class="mt-1">Esta información es general y no garantiza resultados financieros. No sustituye el asesoramiento profesional.</p>
              <p class="mt-1"><strong>Importante:</strong> Los hábitos son tendencias, no destinos. Evita generalizaciones y estereotipos.</p>
              <p class="mt-2">© 2025 Análisis de Hábitos</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Mindset & Creencias
            "Mentalidad de Abundancia vs. Mentalidad de Escasez", "Enfoque en Oportunidades vs. Enfoque en Obstáculos", "Creencia en el Crecimiento Personal vs. Creencias Fijas", "Responsabilidad Personal vs. Victimización/Culpa Externa", "Optimismo Realista vs. Pesimismo/Cinismo", "Visión a Largo Plazo vs. Gratificación Instantánea", "Proactividad vs. Reactividad ante la Vida", "Apertura al Cambio vs. Resistencia al Cambio", "Definición de Riqueza: Holística vs. Meramente Monetaria", "Relación con el Dinero: Herramienta vs. Fuente de Estrés/Tabú", "Aceptación del Fracaso como Aprendizaje vs. Evitación del Fracaso", "Creencia en la Propia Capacidad (Autoeficacia) vs. Duda Constante", "Generosidad y Contribución vs. Enfoque Exclusivo en Uno Mismo", "Comparación Social: Inspiración vs. Envidia/Resentimiento", "Pensamiento Crítico vs. Aceptación Pasiva de Información",
            // Metas y Planificación
            "Establecimiento de Metas Claras (SMART) vs. Metas Vagas/Inexistentes", "Planificación Diaria/Semanal vs. Improvisación Constante", "Revisión Periódica de Metas vs. Establecer y Olvidar", "Priorización de Tareas (Urgente/Importante) vs. Falta de Priorización", "Visualización del Éxito vs. Falta de Visión Futura", "Desglose de Metas Grandes en Pasos Pequeños vs. Sentirse Abrumado", "Enfoque en Metas Propias vs. Vivir según Expectativas Ajenas", "Presupuesto Personal/Familiar Detallado vs. Gasto sin Control", "Planificación Financiera a Largo Plazo (Jubilación, etc.) vs. Vivir al Día", "Establecimiento de Hitos y Celebración vs. Falta de Reconocimiento del Progreso",
            // Aprendizaje y Desarrollo
            "Lectura Diaria (No Ficción, Desarrollo) vs. Lectura Ocasional/Entretenimiento", "Búsqueda Activa de Conocimiento vs. Aprendizaje Pasivo/Formal Únicamente", "Inversión en Educación Propia (Cursos, Talleres) vs. Gasto Visto como Innecesario", "Búsqueda de Mentores/Consejeros vs. Intentar Todo Solo", "Aprender de los Errores (Propios y Ajenos) vs. Repetir Errores", "Mantenerse Actualizado en su Campo/Industria vs. Estancamiento Profesional", "Desarrollo de Nuevas Habilidades vs. Conformidad con Habilidades Actuales", "Escucha Activa vs. Interrumpir/Esperar para Hablar", "Solicitar Feedback Constructivo vs. Evitar/Rechazar Críticas", "Curiosidad Intelectual vs. Falta de Interés por Aprender",
            // Trabajo y Carrera
            "Ir Más Allá de lo Esperado (Extra Mile) vs. Cumplir lo Mínimo", "Enfoque en Aportar Valor vs. Enfoque en el Salario Únicamente", "Búsqueda de Múltiples Fuentes de Ingresos vs. Dependencia de una Única Fuente", "Emprendimiento/Intraemprendimiento vs. Mentalidad de Empleado Pasivo", "Persistencia ante Dificultades Laborales vs. Renuncia Fácil", "Gestión Eficaz del Tiempo Laboral (Bloques, etc.) vs. Procrastinación/Distracciones", "Networking Estratégico y Genuino vs. Networking Nulo o Superficial", "Desarrollo de una Marca Personal vs. Anonimato Profesional", "Negociación de Salario/Condiciones vs. Aceptación Pasiva", "Pasión por el Trabajo vs. Verlo Solo como Obligación",
            // Gestión del Dinero
            "Ahorro Sistemático (Págate a ti mismo primero) vs. Ahorro si Sobra", "Inversión Temprana y Constante vs. Postergación/Miedo a Invertir", "Conocimiento Financiero (Educación Financiera) vs. Ignorancia/Desinterés", "Manejo Estratégico de Deudas vs. Acumulación de Deuda de Consumo", "Fondo de Emergencia Sólido vs. Inexistente/Insuficiente", "Seguros Adecuados (Salud, Vida, etc.) vs. Falta de Protección", "Comparar Precios y Buscar Ofertas vs. Compra Impulsiva/Sin Investigación", "Evitar Compras para Impresionar a Otros vs. Gasto por Estatus", "Uso Consciente del Crédito vs. Abuso del Crédito", "Planificación Fiscal vs. Desconocimiento/Desinterés por Impuestos", "Enseñar Hábitos Financieros a los Hijos vs. Falta de Educación Financiera Familiar",
            // Salud y Bienestar
            "Ejercicio Físico Regular vs. Sedentarismo", "Alimentación Saludable y Equilibrada vs. Comida Rápida/Procesada Frecuente", "Sueño Suficiente y Reparador vs. Falta de Sueño Crónica", "Manejo del Estrés (Meditación, Hobbies) vs. Estrés Crónico sin Gestión", "Revisiones Médicas Preventivas vs. Visitar al Médico Solo por Enfermedad", "Cuidado de la Salud Mental vs. Estigma/Desatención", "Limitar Consumo de Alcohol/Sustancias vs. Abuso", "Hidratación Adecuada vs. Deshidratación/Refrescos Azucarados", "Tiempo de Descanso y Desconexión vs. Trabajo Constante/Burnout", "Entorno Físico Ordenado y Limpio vs. Desorden",
            // Relaciones y Networking
            "Asociarse con Personas Positivas y Exitosas vs. Entorno Negativo/Tóxico", "Construir Relaciones a Largo Plazo vs. Relaciones Superficiales/Transaccionales", "Ofrecer Ayuda Genuina a Otros vs. Enfoque en Recibir Únicamente", "Comunicación Asertiva y Respetuosa vs. Comunicación Agresiva/Pasiva", "Establecer Límites Saludables vs. Dificultad para Decir No", "Resolver Conflictos de Forma Constructiva vs. Evitación/Escalada de Conflictos", "Participación en Grupos/Comunidades vs. Aislamiento Social", "Recordar Nombres y Detalles vs. Olvido Frecuente", "Expresar Gratitud vs. Dar por Sentado", "Elegir un Cónyuge/Pareja con Metas Similares vs. Disparidad de Valores",
            // Uso del Tiempo
            "Limitar Tiempo en Redes Sociales/TV vs. Consumo Excesivo", "Tiempo Dedicado a Actividades Productivas/Creativas vs. Ocio Pasivo Constante", "Voluntariado/Contribución Comunitaria vs. Falta de Implicación Social", "Tiempo de Calidad con la Familia vs. Presencia Física sin Conexión", "Aprovechar Tiempos Muertos (Viajes, Esperas) vs. Desperdicio de Tiempo", "Decir 'No' a Compromisos No Alineados vs. Sobrecarga de Obligaciones", "Levantarse Temprano vs. Dormir Hasta Tarde sin Propósito", "Bloques de Tiempo para Trabajo Profundo vs. Multitarea Constante", "Evaluar Retorno de Inversión del Tiempo vs. Gasto de Tiempo sin Conciencia", "Reducción de Reuniones Improductivas vs. Participación Pasiva",
            // Otros Hábitos
            "Mantener la Palabra Dada (Integridad) vs. Promesas Incumplidas", "Vestir Apropiadamente para la Ocasión vs. Descuido en la Imagen", "Puntualidad vs. Impuntualidad Crónica", "Organización del Espacio Físico y Digital vs. Caos y Desorden", "Actitud de Gratitud Diaria vs. Queja Constante", "Moderación en General vs. Excesos Frecuentes", "Autocontrol y Disciplina vs. Impulsividad", "Cuidado del Medio Ambiente vs. Desinterés Ecológico", "Pensamiento a Largo Plazo en Decisiones vs. Enfoque Cortoplacista", "Filantropía y Donaciones (si es posible) vs. Falta de Contribución"
            // ... (Se pueden añadir muchísimos más matices)
        ];
        const habitThemes = [
            "mentalidad financiera", "establecimiento de metas", "hábitos de aprendizaje", "gestión del tiempo",
            "administración del dinero", "ahorro e inversión", "hábitos de trabajo", "networking y relaciones",
            "salud y bienestar", "manejo del fracaso", "toma de decisiones", "riesgo y recompensa",
            "hábitos de lectura", "proactividad vs reactividad", "gratificación diferida", "desarrollo personal",
            "múltiples fuentes de ingresos", "presupuesto y control de gastos", "educación financiera", "hábitos de consumo"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un analista de comportamiento financiero y desarrollo personal, estilo Tom Corley o similar. Tu tarea es comparar y contrastar de forma objetiva e informativa el hábito o mentalidad específica indicada en el título, describiendo cómo se manifiesta comúnmente en personas que tienden a acumular riqueza versus aquellas que tienden a permanecer en la pobreza, basándote en observaciones populares y estudios de patrones de comportamiento. NO emitas juicios morales ni uses lenguaje determinista. Enfatiza que son tendencias, no reglas absolutas. Describe el 'hábito rico', el 'hábito pobre' correspondiente, sus posibles consecuencias lógicas y ejemplos prácticos. Evita estereotipos simplistas. Sé detallado y proporciona un análisis matizado de aproximadamente 1200-1300 palabras.",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Genera exactamente 40 ideas concisas que comparen hábitos, mentalidades o estrategias financieras/vitales comúnmente contrastadas entre patrones asociados a la riqueza y la pobreza (Ej: 'Lectura Diaria: Hábito Rico vs. Hábito Pobre', 'Mentalidad de Inversión vs. Mentalidad de Gasto'). Usa un formato comparativo claro. Devuelve *solo* la lista, una idea por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo para generar 40
        };
        const imageApiConfig = {
            systemPrompt: "Crea una imagen conceptual abstracta que represente visualmente el contraste descrito en el prompt. Enfócate en simbolismo, color y composición para transmitir la idea (ej: crecimiento vs estancamiento, claridad vs confusión, construcción vs deterioro). Evita figuras humanas literales, dinero, texto o elementos demasiado obvios. Estilo artístico, evocador.",
            timeoutSeconds: 90
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalContentScrollWrapper = document.getElementById('modal-content-scroll-wrapper');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Minigame Elements
        const loadingMinigameArea = document.getElementById('loading-minigame');
        const minigameTarget = document.getElementById('minigame-target');
        const minigameScoreDisplay = document.getElementById('minigame-score');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let minigameInterval = null;
        let minigameScore = 0;
        let apiCallController = null; // To abort fetch if modal is closed early

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) {
             // Abort previous call if any
             if (apiCallController) {
                 apiCallController.abort();
                 console.log("Previous API call aborted.");
             }
             apiCallController = new AbortController();

             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);

             // No timeout here, using AbortController signal directly
             try {
                 const response = await fetch(url, { signal: apiCallController.signal });

                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores pueden estar experimentando mucho tráfico. Por favor, inténtalo de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Inténtalo de nuevo.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 if (error.name === 'AbortError') {
                     console.log('API Fetch aborted by user.');
                     throw new Error("Carga cancelada."); // Specific message for cancellation
                 }
                 console.error("API Fetch Error:", error);
                 // Propagate friendly or specific error messages
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             } finally {
                 apiCallController = null; // Clear controller after fetch completes or fails
             }
        }
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(habitThemes) || "hábitos financieros generales";
            const specificPrompt = `Genera 40 comparativas de hábitos/mentalidades sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150);
                     if (titles.length < 15) throw new Error("La IA no generó suficientes comparativas."); // Expecting less than 40 maybe
                     return titles; // Return all generated, even if less than 40
                 });
        }
         function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "contraste entre mentalidad de abundancia y escasez";
             // Usar un system prompt genérico para la imagen, ya que adaptar por título es complejo y puede fallar
             const conceptualPrompt = `Abstract conceptual art representing the core contrast in '${safePromptText}'. Focus on symbolism, mood, color (e.g., growth/decay, light/dark, order/chaos). Avoid literal people, money, text. Evocative and artistic.`;
             const escapedPrompt = encodeURIComponent(conceptualPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, literal human figures, stacks of cash";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MINIGAME FUNCTIONS ==========
        function startGame() {
            if (!loadingMinigameArea || !minigameTarget || !minigameScoreDisplay) return;
            minigameScore = 0;
            minigameScoreDisplay.textContent = minigameScore;
            loadingMinigameArea.style.display = 'block'; // Asegurarse que el area del juego sea visible
            modalLoadingIndicator.classList.add('active'); // Asegurar que toda la pantalla de carga esté activa

            moveTarget(); // Posición inicial
            minigameTarget.addEventListener('click', handleTargetClick);

            // Iniciar intervalo para mover el objetivo
            clearInterval(minigameInterval); // Limpiar intervalo anterior si existe
            minigameInterval = setInterval(moveTarget, 1200); // Mover cada 1.2 segundos
            console.log("Minigame started");
        }

        function stopGame() {
            if (!loadingMinigameArea || !minigameTarget) return;
            clearInterval(minigameInterval);
            minigameTarget.removeEventListener('click', handleTargetClick);
            loadingMinigameArea.style.display = 'none'; // Ocultar área del juego
            // No ocultar modalLoadingIndicator aquí, se oculta cuando llega el contenido
            console.log("Minigame stopped");
        }

        function handleTargetClick() {
            minigameScore++;
            minigameScoreDisplay.textContent = minigameScore;
            moveTarget(); // Mover inmediatamente al hacer clic

            // Reiniciar el intervalo para que no se mueva justo después del clic
            clearInterval(minigameInterval);
            minigameInterval = setInterval(moveTarget, 1200);
        }

        function moveTarget() {
            if (!loadingMinigameArea || !minigameTarget) return;
            const areaWidth = loadingMinigameArea.offsetWidth;
            const areaHeight = loadingMinigameArea.offsetHeight;
            const targetWidth = minigameTarget.offsetWidth;
            const targetHeight = minigameTarget.offsetHeight;

            // Calcular posición aleatoria asegurando que el target quede DENTRO del área
            const randomX = Math.random() * (areaWidth - targetWidth);
            const randomY = Math.random() * (areaHeight - targetHeight);

            minigameTarget.style.left = `${randomX}px`;
            minigameTarget.style.top = `${randomY}px`;
        }


        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
             // *** ABORT API CALL IF IT'S RUNNING ***
             if (apiCallController) {
                 apiCallController.abort();
                 console.log("API call aborted due to modal close.");
             }
             stopGame(); // Asegurarse de detener el juego al cerrar
             storyModal.classList.remove('active');
             if (!imageFullscreenOverlay.classList.contains('active')) {
                 document.body.style.overflow = '';
             }
             modalContentScrollWrapper.scrollTop = 0; // Reset scroll del contenedor
             console.log("Scroll set to 0 on hideModal");
             resetModalState();
         }
        function resetModalState() {
             modalLoadingIndicator.classList.remove('active'); // Ocultar loading/game por defecto
             modalStoryContentArea.classList.add('content-hidden'); // Ocultar contenido
             modalError.classList.add('content-hidden'); // Ocultar error
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             stopGame(); // Asegurarse que el juego esté detenido
             hideFullscreenImage();
         }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay comparativas disponibles «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Reaplicar filtro
         }

        // *** MODIFIED: handleTitleClick to integrate minigame ***
        async function handleTitleClick(title) {
            resetModalState(); // Limpia todo, incluyendo detener juego anterior si lo hubiera
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = ''; // Asegurar limpieza
            modalError.classList.add('content-hidden'); // Ocultar error

            // *** START LOADING & MINIGAME ***
            modalLoadingIndicator.classList.add('active');
            startGame();

            try {
                const rawExplanationText = await fetchExplanationText(title);

                // *** STOP MINIGAME, HIDE LOADING, SHOW CONTENT ***
                stopGame();
                modalLoadingIndicator.classList.remove('active');

                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalContent.innerHTML = formattedExplanation; // Poner texto
                modalStoryContentArea.classList.remove('content-hidden'); // Mostrar área de contenido

                modalContentScrollWrapper.scrollTop = 0; // Reset scroll DESPUÉS de que el contenido es visible
                console.log("Scroll set to 0 after content visible");

                // Preparar placeholder de imagen DENTRO de modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-palette placeholder-icon"></i> <!-- Icono arte/concepto -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Crear y añadir elemento imagen (empieza a cargar)
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de: ${title}`;
                imgElement.style.display = 'none'; // Oculta hasta cargar

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove(); // Quitar placeholder
                    imgElement.style.display = 'block'; // Mostrar imagen
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); // Añadir click listener
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-image-slash placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">No se pudo cargar la visualización.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title); // Usa el título para el prompt de imagen
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Añadir img al final del contenido
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                // *** STOP GAME & HIDE LOADING on error too ***
                stopGame();
                modalLoadingIndicator.classList.remove('active');

                // Mostrar el área de contenido para poder ver el error
                modalStoryContentArea.classList.remove('content-hidden');
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el análisis.";
                modalError.classList.remove('content-hidden');
                modalContent.innerHTML = ''; // Limpiar en caso de error
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más comparativas...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Ya pide 40 en la config
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más comparativas en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar comparativas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Actualizar texto del botón para reflejar que genera 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar +40 Comparativas Adicionales';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !imageFullscreenOverlay || !fullscreenCloseBtn || !loadingMinigameArea || !minigameTarget) {
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Faltan componentes esenciales de la interfaz.</p>';
                 return;
              }
             // Modal listeners
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

             // Title generation listener
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

             // Search listener
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

             // Fullscreen image listeners
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Initial display
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
             loadingMinigameArea.style.display = 'none'; // Asegurar que el juego esté oculto al inicio
         }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>