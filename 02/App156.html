<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía de Supervivencia - Nivel Intermedio</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Sturdy/Readable -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Guía de Supervivencia --- */
        :root {
            --color-primary: #228B22; /* Verde Bosque */
            --color-secondary: #D2691E; /* Marrón Chocolate (uso moderado) */
            --color-tertiary: #FF8C00; /* Naranja Oscuro (énfasis/alerta) */
            --color-background: #f5f5f5; /* Blanco Hueso / Gris muy claro */
            --color-text: #333333; /* Gris Oscuro (casi negro) */
            --color-text-muted: #666666; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco */
            --color-border: #d1d5db; /* Borde Gris Claro */
            --color-error-bg: #fff5f5; /* Fondo error rojo muy claro */
            --color-error-text: #c53030; /* Texto error rojo oscuro */
            --color-error-border: #fca5a5; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto Slab', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700;}
        #modal-title { color: var(--color-secondary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #ffffff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(34, 139, 34, 0.2); outline: none; background-color: #ffffff; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Align text left for longer titles */ font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: flex-start; /* Align icon left */ min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; line-height: 1.4; }
        .title-item i { margin-right: 0.8rem; color: var(--color-primary); width: 1.2em; text-align: center;} /* Icon styling */
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f0fff0; } /* Honeydew hover */
        .title-item:hover i { color: var(--color-primary); }

        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto Slab', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #1E701E; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: #a3a3a3; color: #e5e5e5; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(51, 51, 51, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e5e7eb; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 700; }
        #modal-content em { color: var(--color-primary); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto Slab', serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid #e5e5e5; padding-bottom: 0.4em; font-weight: 700;}
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(209, 213, 219, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; /* Gris muy claro */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: #ffffff; margin-left: auto; text-align: left; font-weight: 400;}
        .ai-message { background-color: #e5e7eb; /* Gris claro */ color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #ffffff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: #ffffff; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #1E701E; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.2rem; font-family: 'Roboto Slab'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-text); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(51, 51, 51, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); background-color: white; /* Fondo blanco por si la imagen tiene transparencia */ }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-compass mr-3 text-green-600"></i> <!-- Icono Brújula -->
                     Guía de Supervivencia
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Nivel Intermedio «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Domina Técnicas Esenciales</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora conceptos y habilidades prácticas para desenvolverte con confianza en la naturaleza. Prepárate para ir más allá de lo básico.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar técnica o concepto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-green-700 mr-2"></i> <!-- Icono libro abierto -->
                 Índice de Habilidades
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando técnicas...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron técnicas para tu búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Más Técnicas
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Cargando Información...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                         <p class="chat-message ai-message" style="font-style: italic; font-size: 0.9em;">Pregúntame sobre esta técnica específica.</p>
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Pensando...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Escribe tu duda aquí...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos. La supervivencia real requiere práctica y precaución.</p>
              <p class="mt-1">Consulta siempre fuentes expertas y regulaciones locales antes de aplicar técnicas en la naturaleza.</p>
              <p class="mt-2">© 2025 Guía Práctica de Supervivencia</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
             // SHELTER
             "Construir un Refugio Debris Hut Aislante", "Técnicas de Impermeabilización para Refugios Naturales", "Selección Estratégica de un Sitio para Acampar Seguro",
             "Principios de Termorregulación en Refugios", "Construir una Cama Elevada del Suelo Frío/Húmedo", "Refugio Lean-To Mejorado con Paredes Laterales",
             "Improvisar un Refugio con Lona o Poncho (A-Frame, Tubo)", "Uso de Nieve para Construir un Quinzhee o Cueva de Nieve", "Identificar y Utilizar Refugios Naturales (Cuevas, Aleros)",
             "Ventilación Adecuada en Refugios Cerrados", "Construir un Reflector de Calor para Fuego", "Refugio de Trinchera para Viento Fuerte",
             // WATER
             "Construir un Filtro de Agua por Gravedad (Capas)", "Método SODIS (Desinfección Solar del Agua)", "Identificar Indicadores de Agua en Climas Secos",
             "Uso Efectivo de Tabletas Potabilizadoras", "Recolectar Agua de Rocío con Trampas", "Destilación Solar Básica (Pozo Solar)",
             "Encontrar Agua en Plantas (Bambú, Vides - con precaución)", "Derretir Nieve o Hielo para Agua Potable", "Evaluar la Claridad y Olor del Agua Fuente",
             "Pre-filtrado de Agua Turbia (Tela, Musgo)", "Hervir Agua: Tiempo y Altitud", "Purificación Química (Yodo/Cloro): Dosis y Tiempos",
             // FIRE
             "Dominar el Encendido con Ferrocerio (Ferro Rod)", "Crear Yesca Efectiva con Materiales Naturales y Artificiales", "Principios del Taladro de Arco (Bow Drill): Componentes y Técnica",
             "Mantener el Fuego en Condiciones Húmedas o Ventosas", "Conservar el Fuego Durante la Noche (Brasas)", "Encender Fuego con Lupa o Lente",
             "Método del Arado de Fuego (Fire Plow)", "Técnica de Fuego por Fricción con Bambú", "Construir una Plataforma Seca para el Fuego",
             "Tipos de Configuraciones de Fuego (Tipí, Cabaña, Estrella)", "Seguridad con el Fuego: Limpiar Área, Tener Agua/Tierra Cerca", "Señales de Humo Controladas",
             // FOOD (Intermediate)
             "Construir y Colocar Trampas Simples (Lazo Colgante, Lazo de Resorte)", "Trampa de Peso Muerto (Figura 4, Paiute)", "Pesca con Anzuelos y Líneas Improvisadas",
             "Técnicas de Pesca Pasiva (Nansas Improvisadas)", "Principios del Ahumado Ligero para Conservar Carne/Pescado", "Secado de Carne o Frutas al Sol/Aire",
             "Prueba Universal de Comestibilidad (Con Extrema Precaución y Conocimiento)", "Identificar 5-10 Plantas Comestibles Comunes de tu Región", "Cocinar sobre Piedras Calientes o en un Horno de Tierra Básico",
             "Evitar Plantas Tóxicas Comunes (Hiedra Venenosa, etc.)", "Recolectar Insectos Comestibles (Hormigas, Saltamontes - preparación)", "Pesca con Arpón Improvisado (Aguas Claras)",
             // NAVIGATION
             "Orientación con Mapa Topográfico y Brújula", "Tomar y Seguir un Rumbo (Azimut)", "Comprensión de la Declinación Magnética",
             "Uso del Método del Reloj y el Sol para Dirección", "Orientación Nocturna con Estrellas (Polaris, Cruz del Sur)", "Estimación de Distancias (Pasos, Apariencia)",
             "Lectura de Contornos del Mapa Topográfico", "Navegación por Características del Terreno (Terrain Association)", "Identificar Signos Naturales de Dirección (Musgo, Viento)",
             "Marcar un Sendero de Forma Segura y Reversible", "Qué Hacer si Estás Perdido (STOP: Stop, Think, Observe, Plan)", "Uso Básico de un GPS (Waypoints, Rutas)",
             // FIRST AID
             "Inmovilización de Fracturas y Esguinces (Férulas Improvisadas)", "Tratamiento de Hipotermia Leve a Moderada", "Reconocimiento y Manejo del Golpe de Calor y Agotamiento por Calor",
             "Limpieza y Vendaje de Heridas (Irrigación, Apósitos)", "Manejo Efectivo de Ampollas", "Prevención y Tratamiento de Pie de Trinchera",
             "Identificación y Primeros Auxilios para Mordeduras de Serpiente Comunes (Región)", "Tratamiento de Picaduras de Insectos y Reacciones Alérgicas Leves", "Extracción Segura de Garrapatas",
             "Manejo de Quemaduras Leves a Moderadas", "Construir una Camilla Improvisada", "Prioridades en Primeros Auxilios (ABC: Airway, Breathing, Circulation)",
             // TOOLS & KNOTS
             "Manejo Seguro y Mantenimiento Básico del Cuchillo", "Técnica de Batonear Madera con Cuchillo", "Hacer Feathersticks para Encender Fuego",
             "Nudos Esenciales: As de Guía (Bowline), Vuelta de Escota, Ballestrinque (Clove Hitch)", "Nudos Esenciales: Nudo Tensor (Taut-line Hitch), Pescador Doble", "Nudos Esenciales: Prusik, Margarita",
             "Improvisar Cordaje con Fibras Naturales (Corteza, Raíces)", "Fabricar Herramientas de Excavación Simples (Palo Afilado)", "Afilar un Cuchillo con Piedras Naturales",
             "Uso Seguro del Hacha o Machete (Si se lleva)", "Reparación Básica de Equipo (Ropa, Mochila)", "Construir un Trípode o Estructura Simple con Nudos",
             // SIGNALING
             "Uso Efectivo de un Espejo de Señales", "Señales Tierra-Aire Estándar (V, X)", "Regla de Tres para Señalización (Sonido, Luz, Humo)",
             "Construir un Fuego de Señalización de Humo Denso", "Uso de Silbato para Señales de Emergencia (Código SOS)", "Colocar Marcadores Visibles en el Terreno",
             "Uso de Linterna para Señales SOS", "Cómo Incrementar la Visibilidad desde el Aire", "Comunicaciones por Radio Básicas (Si se tiene)",
             // MINDSET & MISC
             "La Regla de Tres en Supervivencia (Aire, Refugio, Agua, Comida)", "Mentalidad de Supervivencia: Mantener la Calma y Actitud Positiva (PMA)", "Evaluación de Riesgos en Entorno Salvaje",
             "Conservación de Energía y Ritmo", "Importancia de la Observación del Entorno", "Kit de Supervivencia Personalizado: Contenido Esencial",
             "Adaptación a Diferentes Entornos (Bosque Templado, Desierto Básico, Costa)", "Manejo del Miedo y el Pánico", "Priorización de Tareas en una Emergencia",
             "Dejar un Plan de Ruta Antes de Salir", "Interacción Segura con Fauna Salvaje (Prevención)", "Higiene Básica en el Campo",
             // Consider Adding More Specifics / Regional Variations via "Generate More"
         ];
        const survivalThemes = [
             "técnicas de refugio improvisado", "métodos de purificación de agua", "habilidades de encendido de fuego por fricción", "trampas para animales pequeños", "navegación con mapa y brújula",
             "primeros auxilios en la naturaleza", "nudos esenciales de supervivencia", "señalización para rescate", "mentalidad de supervivencia", "obtención de comida silvestre",
             "supervivencia en clima frío", "supervivencia en clima cálido/desértico", "supervivencia costera", "uso de herramientas de corte", "identificación de plantas útiles",
             "recolección de agua de lluvia y rocío", "manejo de hipotermia", "tratamiento de quemaduras", "orientación por medios naturales", "construcción de herramientas improvisadas"
         ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un experimentado instructor de supervivencia y guía de naturaleza. Tu especialidad cubre entornos templados principalmente, pero comprendes principios generales aplicables a otros biomas. Explica el consejo o concepto de supervivencia solicitado de manera clara, práctica y, cuando sea aplicable, paso a paso. Enfatiza las precauciones de seguridad, los materiales necesarios (si los hay), posibles dificultades y la razón subyacente de por qué funciona la técnica. Proporciona aproximadamente 1200-1300 palabras de consejo accionable para alguien con experiencia básica en exteriores, centrándote en habilidades de nivel intermedio. Basa tu explicación únicamente en el siguiente consejo/concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un útil asistente de instructor de supervivencia. El usuario está aprendiendo actualmente sobre '[CURRENT_TIP_TITLE]'. Responde preguntas de seguimiento específicas sobre esta técnica, ofreciendo aclaraciones, consideraciones alternativas o recordatorios de seguridad relacionados *únicamente* con '[CURRENT_TIP_TITLE]'. Sé conciso y práctico.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Genera exactamente 15 consejos o conceptos de supervivencia específicos y accionables, adecuados para alguien con conocimientos básicos de outdoor (dificultad media). Enfócate en refugio, agua, fuego, comida, navegación, primeros auxilios o habilidades esenciales. Ejemplos: 'Filtración de agua improvisada', 'Colocar una trampa de lazo simple', 'Usar un rumbo de brújula'. Devuelve *solo* la lista de consejos, uno por línea. Sin números, introducciones ni extras.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        // ... (Identical to previous version: searchInput, titleListContainer, etc.)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTipTitle = null; // Context for chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTipTitle
                 ? `Actúa como un útil asistente de instructor de supervivencia. El usuario está aprendiendo actualmente sobre '${currentTipTitle}'. Responde preguntas de seguimiento específicas sobre esta técnica, ofreciendo aclaraciones, consideraciones alternativas o recordatorios de seguridad relacionados *únicamente* con '${currentTipTitle}'. Sé conciso y práctico.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     // Friendly error message
                     throw new Error(`(Error ${response.status}) Nuestros sistemas están algo ocupados ahora. Por favor, inténtalo de nuevo en unos momentos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta del asistente llegó vacía. Intenta reformular la pregunta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Verifica tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado contactando al asistente.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTipTitle) throw new Error("Error interno: No se ha establecido el contexto del consejo para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(survivalThemes) || "habilidades generales de supervivencia";
             const specificPrompt = `Genera 15 consejos/conceptos de supervivencia de nivel medio sobre ${randomTheme}`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("El asistente no pudo generar suficientes ideas de técnicas.");
                     return titles.slice(0, 15);
                 });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "wilderness survival concept";
             // Focus on illustrating the CONCEPT, not a diagram
             const enhancedPrompt = `Illustrative scene or key element related to the survival concept: '${safePromptText}'. Focus on natural environment (forest, field, water source), a key tool (knife, compass, fire starting kit, shelter structure), or the result (purified water, built shelter, signal fire smoke). Natural lighting, slightly rugged or practical feel. Avoid text, diagrams, labels, multiple panels. Cinematic, realistic or semi-realistic painting style.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, cartoon, drawing, sketch, abstract, unrealistic colors, person clearly visible unless essential";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (Identical to previous version)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); // Quitar \text{}
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); // Subíndices
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); // Superíndices
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); // Flecha
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); // Fórmulas (si las hubiera)
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); // H4
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); // H3
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); // H2
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');   // H1
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Negrita
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');     // Cursiva
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, ' '); // Reemplaza saltos internos con espacio
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
          }

        // ========== MODAL FUNCTIONS ========== (Identical logic)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '<p class="chat-message ai-message" style="font-style: italic; font-size: 0.9em;">Pregúntame sobre esta técnica específica.</p>'; // Reset chat with prompt
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTipTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Identical logic)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (Identical logic)
        function addChatMessage(message, sender) {
             const msgDiv = document.createElement('div');
             msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
             // Basic Markdown
             message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
             msgDiv.innerHTML = message;
             // Remove initial prompt if it's still there
             const initialPrompt = chatHistory.querySelector('p[style*="italic"]');
             if (initialPrompt) initialPrompt.remove();
             chatHistory.appendChild(msgDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        function addChatError(message) { /* ... identical */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        async function handleSendMessage() { /* ... identical */
             const userQuery = chatInput.value.trim();
             if (!userQuery || chatSendBtn.disabled) return;
             addChatMessage(userQuery, 'user');
             chatInput.value = '';
             chatSendBtn.disabled = true;
             chatLoadingIndicator.style.display = 'block';
             try {
                 const aiResponse = await fetchChatResponse(userQuery);
                 addChatMessage(aiResponse, 'ai');
             } catch (error) {
                 console.error("Chat Error:", error);
                 addChatError(`Error Asistente: ${error.message}`);
             } finally {
                 chatLoadingIndicator.style.display = 'none';
                 chatSendBtn.disabled = false;
                 chatInput.focus();
             }
         }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... identical */ let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        // *** Modified createTitleItem to add icon based on category ***
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            div.setAttribute('data-title', title);

            // Add icon based on keywords (simple heuristic)
            let iconClass = 'fa-question-circle'; // Default
            const lowerTitle = title.toLowerCase();
            if (lowerTitle.includes('refugio') || lowerTitle.includes('shelter') || lowerTitle.includes('campamento') || lowerTitle.includes('tarp') || lowerTitle.includes('poncho') || lowerTitle.includes('quinzhee') || lowerTitle.includes('cueva')) iconClass = 'fa-campground';
            else if (lowerTitle.includes('agua') || lowerTitle.includes('water') || lowerTitle.includes('filter') || lowerTitle.includes('filtro') || lowerTitle.includes('purif') || lowerTitle.includes('hervir') || lowerTitle.includes('sodis') || lowerTitle.includes('rocío')) iconClass = 'fa-tint'; // fa-water is pro
            else if (lowerTitle.includes('fuego') || lowerTitle.includes('fire') || lowerTitle.includes('yesca') || lowerTitle.includes('ferro') || lowerTitle.includes('bow drill') || lowerTitle.includes('fricción') || lowerTitle.includes('brasa')) iconClass = 'fa-fire';
            else if (lowerTitle.includes('comida') || lowerTitle.includes('food') || lowerTitle.includes('trampa') || lowerTitle.includes('snare') || lowerTitle.includes('pesca') || lowerTitle.includes('fishing') || lowerTitle.includes('foraging') || lowerTitle.includes('planta') || lowerTitle.includes('insecto') || lowerTitle.includes('carne') || lowerTitle.includes('ahumado')) iconClass = 'fa-utensils';
            else if (lowerTitle.includes('navega') || lowerTitle.includes('navigation') || lowerTitle.includes('mapa') || lowerTitle.includes('brújula') || lowerTitle.includes('compass') || lowerTitle.includes('estrella') || lowerTitle.includes('sol') || lowerTitle.includes('rumbo') || lowerTitle.includes('azimut') || lowerTitle.includes('perdido')) iconClass = 'fa-compass'; // fa-map-signs is pro
            else if (lowerTitle.includes('auxilio') || lowerTitle.includes('first aid') || lowerTitle.includes('herida') || lowerTitle.includes('fractura') || lowerTitle.includes('hipotermia') || lowerTitle.includes('calor') || lowerTitle.includes('quemadura') || lowerTitle.includes('mordedura') || lowerTitle.includes('picadura') || lowerTitle.includes('ampolla')) iconClass = 'fa-first-aid';
            else if (lowerTitle.includes('nudo') || lowerTitle.includes('knot') || lowerTitle.includes('cuchillo') || lowerTitle.includes('knife') || lowerTitle.includes('herramienta') || lowerTitle.includes('tool') || lowerTitle.includes('hacha') || lowerTitle.includes('machete') || lowerTitle.includes('cordaje')) iconClass = 'fa-tools';
            else if (lowerTitle.includes('señal') || lowerTitle.includes('signal') || lowerTitle.includes('espejo') || lowerTitle.includes('humo') || lowerTitle.includes('silbato') || lowerTitle.includes('rescate')) iconClass = 'fa-bullhorn';
            else if (lowerTitle.includes('mental') || lowerTitle.includes('mindset') || lowerTitle.includes('regla de tres') || lowerTitle.includes('riesgo') || lowerTitle.includes('pánico') || lowerTitle.includes('kit')) iconClass = 'fa-brain';

            const icon = document.createElement('i');
            icon.className = `fas ${iconClass}`;
            div.appendChild(icon);

            const textSpan = document.createElement('span');
            textSpan.textContent = title;
            div.appendChild(textSpan);

            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }
        function displayTitles(titles) { /* ... identical logic, uses new createTitleItem */
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay técnicas disponibles en este momento «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... identical logic, uses new createTitleItem */
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick (Identical logic, just placeholder icon change) ***
        async function handleTitleClick(title) { /* ... identical core logic ... */
             resetModalState();
             showModal();
             modalTitle.textContent = title;
             currentTipTitle = title; // Set chat context
             modalContent.innerHTML = '';
             modalError.classList.add('content-hidden');
             modalLoadingIndicator.style.display = 'flex';

             try {
                 const rawExplanationText = await fetchExplanationText(title);
                 const formattedExplanation = formatExplanationText(rawExplanationText);

                 modalLoadingIndicator.style.display = 'none';
                 modalContent.innerHTML = formattedExplanation;
                 modalStoryContentArea.classList.remove('content-hidden');

                 modalTextArea.scrollTop = 0; // Reset scroll AFTER content is visible
                 console.log("Scroll set to 0 after content visible");

                 // Image placeholder
                 const placeholderDiv = document.createElement('div');
                 placeholderDiv.className = 'image-placeholder';
                 placeholderDiv.innerHTML = `
                     <div class="spinner"></div>
                     <i class="fas fa-image placeholder-icon"></i> <!-- Generic image icon -->
                     <p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando ilustración...</p>
                 `;
                 modalContent.appendChild(placeholderDiv);

                 // Image element
                 const imgElement = document.createElement('img');
                 imgElement.className = 'final-image';
                 imgElement.alt = `Ilustración conceptual de ${title}`;
                 imgElement.style.display = 'none';

                 imgElement.onload = () => {
                     console.log("Image loaded successfully.");
                     placeholderDiv.remove();
                     imgElement.style.display = 'block';
                     imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); // Add click for fullscreen
                 };
                 imgElement.onerror = () => {
                     console.error("Error loading image for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Ilustración no disponible.</p>`;
                 };

                 const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     imgElement.src = imageUrl;
                     modalContent.appendChild(imgElement);
                 } else {
                      console.error("Could not create image URL for:", title);
                      placeholderDiv.innerHTML = `<i class="fas fa-times-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL.</p>`;
                 }

             } catch (error) {
                 console.error("Failed display:", error);
                 modalLoadingIndicator.style.display = 'none';
                 modalErrorMessage.textContent = error.message || "Error desconocido al cargar la información."; // Use friendly error
                 modalError.classList.remove('content-hidden');
                 modalStoryContentArea.classList.remove('content-hidden');
                 modalContent.innerHTML = '';
                 chatSection.classList.add('content-hidden');
             }
         }

        async function handleGenerateMoreTitles() { /* ... identical logic, changed button text */
              if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
              generateMoreBtn.disabled = true;
              generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más...';
              try {
                  const newTitles = await fetchGeneratedTitles();
                  if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                  else { alert("No se pudieron encontrar más técnicas en este momento."); }
              } catch (error) {
                  console.error("Failed title generation:", error);
                  alert(`Error al buscar técnicas: ${error.message}`); // Friendly error
              } finally {
                  generateMoreBtn.disabled = false;
                  generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Técnicas';
              }
          }

         // *** Search Filter Function (Identical logic, includes normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (Identical logic)
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡Error Crítico! No se cargaron los componentes de la guía.</p>';
                 return;
              }
             // Modal listeners
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             // Title generation listener
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             // Search listener
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             // Chat listeners
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             // Fullscreen image listeners
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
             // Initial display
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
         }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>