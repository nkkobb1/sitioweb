<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Origami Fácil - Tutoriales Interactivos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y amigables -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&family=Source+Sans+Pro:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Origami Fácil --- */
        :root {
            --color-primary: #4a90e2; /* Azul suave */
            --color-secondary: #f5a623; /* Naranja cálido (acento) */
            --color-tertiary: #7ed321; /* Verde hoja (acento) */
            --color-background: #fdfbf7; /* Blanco Hueso / Papel claro */
            --color-text: #4a4a4a; /* Gris oscuro suave */
            --color-text-muted: #9b9b9b; /* Gris medio */
            --color-modal-bg: #ffffff; /* Blanco puro */
            --color-border: #e6e6e6; /* Borde gris muy claro */
            --color-error-bg: #fff0f0; /* Fondo error rosa pálido */
            --color-error-text: #d0021b; /* Texto error rojo */
            --color-error-border: #f5a6a6; /* Borde error rosa */

            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
            --border-radius: 6px; /* Bordes redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        /* Optional: Subtle paper texture background */
        /* body { background-image: url('path/to/light-paper-texture.png'); } */

        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Nunito', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: white; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); }
        #search-input::placeholder { color: var(--color-text-muted); font-weight: 300; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); outline: none; background-color: white; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-size: 1rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-border); border-left-color: var(--color-primary); color: var(--color-primary); background-color: #f8faff; }
        #generate-more-btn { grid-column: 1 / -1; background: var(--color-primary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #3a7bc8; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background: #b8b8b8; color: #f0f0f0; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(74, 74, 74, 0.8); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 900px; /* Slightly narrower for text focus */
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Ensure enough height */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #f0f0f0; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Area de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; } /* Emphasis color */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Nunito', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700;}
        #modal-content h1 { font-size: 1.4em; } /* Usually won't appear if AI follows prompt */
        #modal-content h2 { font-size: 1.25em; /* Step headers? */ }
        #modal-content h3 { font-size: 1.1em; color: var(--color-secondary); /* Sub-steps or tips? */ }
        #modal-content h4 { font-size: 1.0em; color: var(--color-text-muted); border-bottom: none; font-weight: 600; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(200, 200, 200, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: #cccccc; } /* Softer placeholder icon */

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 230px; /* Slightly reduced height */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.7rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9f9f9; /* Light grey bg */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: 15px; /* Bubble style */ max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; border-bottom-right-radius: 3px; }
        .ai-message { background-color: #eef0f1; /* Light grey bubble */ color: var(--color-text); margin-right: auto; text-align: left; border-bottom-left-radius: 3px; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.3rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Nunito'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.15); }
        #chat-send-btn { padding: 0.7rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #3a7bc8; }
        #chat-send-btn:disabled { background-color: #cccccc; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #e0e0e0; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.2rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-size: 0.95rem; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 90%; max-height: 90%; object-fit: contain; border: none; box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: rgba(255, 255, 255, 0.8); border: 1px solid #ccc; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: white; color: var(--color-primary); transform: scale(1.1); box-shadow: var(--shadow-sm); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-dove mr-3 text-blue-400"></i> <!-- Icono Grulla -->
                     Origami Fácil
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">Tutoriales Interactivos Paso a Paso</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Descubre el Arte de Plegar Papel</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Aprende a crear figuras increíbles con nuestras guías sencillas. ¡Selecciona un modelo y empieza a plegar!</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar modelo (ej: grulla, barco, caja)...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-shapes text-green-500 mr-2"></i> <!-- Icono formas -->
                 Modelos para Empezar
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando modelos disponibles...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No encontramos modelos con ese nombre. ¡Intenta otra búsqueda!</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Buscar Más Ideas Simples
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Preparando el tutorial...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                    <p class="text-sm font-semibold text-gray-600 mb-2 text-center">¿Necesitas ayuda con este modelo?</p>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Pensando...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Escribe tu pregunta aquí...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-circle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Modelo de Origami">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Instrucciones generadas por IA para facilitar el aprendizaje del origami básico.</p>
              <p class="mt-1">¡La práctica y la paciencia son clave! Disfruta el proceso de plegado.</p>
              <p class="mt-2">© 2024 Origami Fácil</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Animales Clásicos
            "Grulla de Papel Tradicional (Pájaro de la Paz)", "Rana Saltarina Sencilla", "Pez Básico", "Mariposa Simple", "Perro (Cara Sencilla)", "Gato (Cara Sencilla)", "Cisne Elegante", "Zorro Astuto (Cara)", "Pingüino Básico", "Pajarito Simple", "Conejo Fácil (Cara)", "Ratón Pequeño", "Cerdo Amistoso (Cara)", "Elefante Sencillo", "Murciélago de Halloween", "Cangrejo de Papel", "Caballo Sencillo (Cabeza)", "Búho Sabio (Simple)", "Serpiente Enrollada", "Ballena Azul Simple",
            // Objetos y Vehículos
            "Barco de Papel Clásico (Que flota)", "Avión de Papel Dardero", "Avión de Papel Planeador", "Caja Masu Simple", "Caja Masu con Tapa", "Sombrero de Samurai (Kabuto)", "Vaso de Papel Funcional", "Casa de Papel con Tejado", "Corazón de Origami Plano", "Corazón de Origami Inflado", "Estrella de la Suerte Pequeña", "Estrella Ninja Simple (Shuriken de 4 puntas)", "Pajarita (Molinillo de Viento)", "Portarretratos Simple", "Sobre Sencillo", "Cohete Espacial Básico", "Coche de Carreras Simple", "Lápiz de Papel", "Barco de Vela", "Helicóptero Simple",
            // Flores y Plantas
            "Flor de Tulipán Simple", "Hoja de Árbol Sencilla", "Flor de Lirio Básica", "Flor de 4 Pétalos Fácil", "Flor Kusudama (Módulo individual)", "Bambú Sencillo", "Árbol de Navidad Simple", "Calabaza de Halloween Plana", "Seta / Hongo", "Trébol de 4 Hojas",
            // Figuras Geométricas y Bases
            "Cubo Simple (Modular Básico)", "Pirámide de Base Cuadrada", "Base Cuadrada (Base Preliminar)", "Base Cometa", "Base Pájaro", "Base Pez", "Base Rana", "Base Blintz", "Forma de Diamante / Rombo", "Hexágono a partir de un Cuadrado", "Triángulo Equilátero",
            // Pliegues Fundamentales
            "Pliegue Valle (Valley Fold)", "Pliegue Montaña (Mountain Fold)", "Doblez Invertido Interior (Inside Reverse Fold)", "Doblez Invertido Exterior (Outside Reverse Fold)", "Doblez Oreja de Conejo (Rabbit Ear Fold)", "Doblez Pétalo (Petal Fold)", "Doblez Hundido (Sink Fold) - Básico", "Doblez en Z (Z-Fold)", "Doblez de Libro", "Doblez de Armario", "Doblez Aplastado (Squash Fold)", "Doblez Giratorio (Swivel Fold) - Básico",
            // Consejos y Técnicas Básicas
            "Cómo Leer Diagramas de Origami (Símbolos Comunes)", "Elegir el Papel Adecuado para Principiantes", "Tipos de Papel para Origami", "Cómo Hacer Pliegues Precisos y Limpios", "Usar una Plegadora (Bone Folder)", "Cortar un Cuadrado Perfecto de Papel Rectangular", "Consejos para Principiantes en Origami", "Beneficios de Practicar Origami", "Historia Breve del Origami", "Origami para Niños: Primeros Pasos", "Decorar tus Modelos de Origami", "Resolver Problemas Comunes al Plegar", "La Importancia de la Simetría", "Practicar la Paciencia en Origami", "Regalar Figuras de Origami",
            // Mini Proyectos
            "Móvil de Grullas Sencillo", "Marcapáginas de Esquina (Corazón)", "Marcapáginas de Esquina (Monstruo)", "Guirnalda de Estrellas Simple", "Tarjeta de Felicitación con Origami", "Decoración para Lápices (Animalitos)", "Juego de Tres en Raya de Papel", "Marioneta de Dedo Simple (Animal)", "Posavasos Cuadrado Simple",
            // Más Figuras Simples (Ampliando)
            "Camisa de Papel", "Vestido Simple", "Pantalones Cortos", "Zapato / Bota Simple", "Fantasma de Halloween", "Calavera Simple (Plana)", "Helado de Papel", "Fruta Simple (Manzana/Pera Plana)", "Sol Sonriente", "Luna Creciente", "Nube Esponjosa", "Montaña Nevada", "Tienda de Campaña", "Farolillo Chino Simple", "Abanico Plegable", "Cámara de Fotos Simple", "Teléfono Móvil Básico", "Llave Inglesa de Papel", "Martillo Simple", "Ancla de Barco", "Timón de Barco", "Gafas Divertidas", "Bigote de Papel", "Lazo / Moño Decorativo", "Copa / Trofeo Simple", "Medalla Olímpica de Papel", "Escudo Heráldico Simple", "Espada de Juguete Simple", "Varita Mágica", "Corona de Rey/Reina", "Dinosaurio Simple (Brontosaurio)", "Pato de Goma", "Tortuga Marina", "Caracol con Concha", "Mariquita (Ladybug)", "Escarabajo Simple", "Libélula Básica", "Saltamontes Simple", "Paloma Mensajera", "Águila Sencilla (Cabeza)", "Loro Colorido (Simple)", "Ardilla Juguetona", "Oso Simple (Cara)", "Koala Tierno", "Panda Gigante (Cara)", "Mono Travieso (Cara)", "León Valiente (Cara)"
            // Esta lista es bastante exhaustiva para nivel básico. "Generar Más" puede refinar o sugerir variaciones.
        ];
        const origamiThemes = [
            "animales de origami fáciles", "objetos de papel", "figuras de origami para niños", "aviones de papel", "barcos de papel", "cajas de origami", "flores de papel simples", "corazones de origami", "estrellas de origami", "bases de origami", "pliegues fundamentales", "técnicas de origami para principiantes", "origami decorativo", "origami funcional", "historia del origami", "papel para origami", "diagramas de origami", "origami modular básico", "origami divertido"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un instructor de origami amable, paciente y muy claro. Tu tarea es guiar a un principiante paso a paso para crear el modelo de origami especificado. Proporciona instrucciones numeradas, muy detalladas y fáciles de seguir para cada pliegue. Usa lenguaje sencillo y evita jerga compleja sin explicarla. Describe cómo debería verse el papel después de cada paso importante. Incluye consejos útiles, posibles errores comunes y cómo evitarlos. Si es relevante, menciona brevemente el origen o uso de la figura. El objetivo es un tutorial completo y alentador de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente modelo o técnica de origami:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat, system prompt se sobreescribe
            model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúa como un asistente de origami servicial y paciente. Estás ayudando a alguien que está plegando el modelo [MODEL_NAME]. Responde preguntas específicas sobre los pasos, los pliegues o cualquier dificultad que tenga con este modelo en particular. Sé claro, conciso y enfocado en resolver la duda sobre el modelo actual.", // [MODEL_NAME] se reemplazará dinámicamente
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para tutoriales de origami de nivel principiante. Genera exactamente 15 nombres de modelos de origami muy simples, técnicas de plegado fundamentales o consejos básicos para principiantes. Devuelve *solo* la lista de nombres/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Div que contiene el texto y la imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div específico para el texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentModelTitle = null; // Para el contexto del chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);

             let systemPromptToUse = config.systemPrompt;
             if (isChat && currentModelTitle) {
                 // Reemplaza el placeholder en el system prompt del chat
                 systemPromptToUse = config.systemPrompt.replace('[MODEL_NAME]', currentModelTitle);
             }
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             // Seed no es relevante para instrucciones paso a paso o chat
             // if (config.seed && !isChat) params.append('seed', config.seed);

             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     // *** MENSAJE DE ERROR AMIGABLE ***
                     throw new Error(`(Código ${response.status}) Parece que nuestros servidores están un poco ocupados ahora mismo. ¿Podrías intentarlo de nuevo en unos segundos?`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length < 50) { // Un umbral mínimo para evitar respuestas vacías o inútiles
                     throw new Error("La respuesta de la IA fue muy corta o vacía. Quizás no pudo generar el tutorial para este modelo.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     // *** MENSAJE DE ERROR AMIGABLE ***
                     throw new Error(`La conexión tardó demasiado (más de ${config.timeoutSeconds}s). Por favor, revisa tu internet e inténtalo más tarde.`);
                 }
                 // Propaga el error (ya debería ser amigable)
                 throw new Error(error.message || "¡Uy! Algo salió mal al intentar contactar con nuestro asistente de plegado.");
             }
        }
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentModelTitle) throw new Error("Error interno: No sé sobre qué modelo me estás preguntando.");
            return fetchTextFromApi(userQuery, chatApiConfig, true); // true indica que es chat
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(origamiThemes) || "origami básico";
            const specificPrompt = `Genera 15 nombres de modelos o técnicas de origami muy simples sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 100); // Max length adjusted
                     if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas nuevas.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 600, height: 600, nologo: true }; // Square often good for objects
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "simple origami model";
             // Prompt enfocado en el modelo terminado
             const enhancedPrompt = `Finished origami model: '${safePromptText}'. Clean, simple paper folding. Clear, bright lighting, plain light-colored background (white, beige, light gray). No hands, no diagrams, just the final folded paper figure. Photorealistic style or clean illustration.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "diagram, instructions, text, words, labels, arrows, numbers, multiple models, messy, wrinkled paper, dark background, hands, person, drawing, sketch, low quality, blurry";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 // Convertir saltos de línea simples DENTRO de un bloque en <br> para pasos de instrucciones
                 let content = block.replace(/\n/g, '<br>');
                 // Si un bloque parece ser un paso numerado, darle estilo
                 if (/^\d+\.\s/.test(content)) {
                     return `<p class="step">${content}</p>`; // Puedes añadir estilo CSS para .step si quieres
                 }
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
         }


        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = true; // Disable chat initially
             currentModelTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender) { /* ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentModelTitle) return; // Ensure context exists

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                // Use friendly error from API if available, or a default
                addChatError(`Asistente: ${error.message || 'No pude procesar tu pregunta ahora mismo.'}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false; // Re-enable after response/error
                chatInput.focus();
            }
        }


        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { /* ... */ return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { /* ... */ const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Sort alphabetically for consistency
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">¡Vaya! Parece que no hay modelos cargados.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             if (addedCount > 0) filterTitles(searchInput.value); // Re-apply filter only if titles were added
             else console.log("Generate More: No new unique titles found.");
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentModelTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';
            chatSendBtn.disabled = true; // Disable chat until content loads

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");
                chatSendBtn.disabled = false; // *** ENABLE CHAT ***

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Creando imagen del modelo terminado...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Append placeholder to text content

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Modelo terminado de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => {
                        showFullscreenImage(imgElement.src);
                    });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-camera placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo cargar la imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append image AFTER placeholder
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                // *** USE FRIENDLY ERROR MESSAGE ***
                modalErrorMessage.textContent = error.message || "¡Oh no! Tuvimos un problema al cargar este tutorial.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden'); // Hide chat on main load error
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando ideas...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No encontramos más ideas simples por ahora."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 // *** USE FRIENDLY ERROR MESSAGE ***
                 alert(`Error buscando ideas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Buscar Más Ideas Simples';
             }
         }

         // *** Search Filter Function (with accent normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Show if 0 results OR if list empty
         }


        // ========== INITIALIZATION ==========
        function initApp() {
             // Check for essential elements
             const essentialElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, modalContent, modalTextArea];
             if (essentialElements.some(el => !el)) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: #d0021b; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: La página no pudo cargarse correctamente. Faltan componentes.</p>';
                 return;
             }

            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter' && !chatSendBtn.disabled) handleSendMessage(); }); // Ensure button enabled
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            resetModalState(); // Ensure clean state on load
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>