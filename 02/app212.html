<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía Definitiva: Ejercicios de Pierna para Hombres</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y modernas -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Fitness/Piernas --- */
        :root {
            --color-primary: #2563eb; /* Azul vibrante */
            --color-secondary: #f97316; /* Naranja como acento */
            --color-tertiary: #10b981; /* Verde para éxito/énfasis */
            --color-background: #f8fafc; /* Blanco Hueso / Gris muy claro */
            --color-text: #1f2937; /* Gris muy oscuro */
            --color-text-muted: #6b7280; /* Gris medio */
            --color-modal-bg: #ffffff; /* Blanco puro para modal */
            --color-border: #e5e7eb; /* Borde gris claro */
            --color-error-bg: #fef2f2; /* Fondo error rojo muy claro */
            --color-error-text: #dc2626; /* Texto error rojo */
            --color-error-border: #fecaca; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Montserrat', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 600; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alinear a la izquierda */ font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-size: 0.95rem; position: relative; overflow: hidden; }
        .title-item::before { /* Pequeño indicador visual */ content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background-color: var(--color-primary); opacity: 0; transition: opacity 0.2s ease; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #eff6ff; /* Azul muy claro */ }
        .title-item:hover::before { opacity: 1; }
        .title-item i { margin-right: 0.7rem; color: var(--color-primary); width: 1.2em; text-align: center;} /* Icono a la izquierda */

        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-secondary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Montserrat', sans-serif; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #ea580c; box-shadow: var(--shadow-md); transform: translateY(-2px); }
        #generate-more-btn:disabled { background-color: #fdba74; color: #fff; cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { /* Mismo que antes */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { /* Mismo que antes */ background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem 2rem; max-width: 950px; width: 95%; max-height: 90vh; min-height: 400px; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { /* Mismo que antes */ position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { /* Mismo que antes */ font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; } /* Naranja para énfasis */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Montserrat', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 600;}
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: #0f766e; } /* Verde azulado oscuro para H3 */
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; font-weight: 600;}
        /* Imagen/Diagrama */
        #modal-content .final-image { display: block; max-width: 75%; /* Más pequeño por defecto para diagramas */ height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; background-color: #fff; /* Fondo blanco por si es transparente */ }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(209, 213, 219, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; /* Gris muy claro */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; font-weight: 400;}
        .ai-message { background-color: var(--color-border); color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.3rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #1d4ed8; }
        #chat-send-btn:disabled { background-color: #93c5fd; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { /* Mismo */ text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(248, 250, 252, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-primary); font-size: 1.3rem; font-family: 'Montserrat'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { /* Mismo */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(30, 41, 59, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 90%; max-height: 90%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); background-color: white; /* Fondo blanco para diagramas */ }
        #fullscreen-close-btn { /* Mismo */ position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-modal-bg); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-dumbbell mr-3 text-blue-600"></i> <!-- Icono pesa -->
                     Entrenamiento de Pierna
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Guía Completa para Hombres «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Construye Piernas Fuertes y Definidas</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto">Explora una biblioteca completa de ejercicios, técnicas y conceptos para maximizar tu desarrollo de pierna.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar ejercicio o concepto (ej: Sentadilla, Cuádriceps)...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-list-ul text-blue-600 mr-2"></i> <!-- Icono lista -->
                 Biblioteca de Ejercicios y Conceptos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando biblioteca...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron ejercicios o conceptos para tu búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Cargar 40 Ejercicios/Conceptos Más
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Cargando Información...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen/diagrama y su placeholder se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <h4 class="text-sm font-semibold text-gray-600 mb-2 text-center font-montserrat">Consulta al Experto sobre "<span id="chat-context-title">Ejercicio</span>"</h4>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Analizando pregunta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Ej: ¿Qué músculos trabaja principalmente?">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen o Diagrama Ampliado">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos y de referencia sobre entrenamiento de pierna.</p>
              <p class="mt-1">Consulta siempre a un profesional de la salud o entrenador certificado antes de iniciar cualquier programa de ejercicios.</p>
              <p class="mt-2">© 2025 Guía de Pierna Definitiva</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Compuestos Barra
            "Sentadilla con Barra (Trasera, Barra Alta)", "Sentadilla con Barra (Trasera, Barra Baja)", "Sentadilla Frontal con Barra", "Sentadilla Zercher", "Sentadilla Búlgara con Barra", "Peso Muerto Convencional", "Peso Muerto Sumo", "Peso Muerto Rumano (RDL) con Barra", "Buenos Días (Good Mornings) con Barra", "Zancadas (Lunges) con Barra (Frontales)", "Zancadas (Lunges) con Barra (Traseras)", "Sentadilla Box con Barra", "Sentadilla Hack con Barra (Landmine)", "Peso Muerto con Barra Hexagonal (Trap Bar)", "Sentadilla Overhead con Barra", "Sentadilla Pausada con Barra", "Sentadilla con Tempo (Barra)", "Sentadilla 1 y 1/4 con Barra",
            // Compuestos Mancuernas/Kettlebells
            "Sentadilla Goblet (Mancuerna/Kettlebell)", "Sentadilla con Mancuernas (a los lados)", "Sentadilla Frontal con Doble Kettlebell", "Sentadilla Búlgara con Mancuernas", "Peso Muerto Rumano (RDL) con Mancuernas", "Peso Muerto a una Pierna con Mancuerna/Kettlebell (SL RDL)", "Zancadas (Lunges) con Mancuernas (Frontales)", "Zancadas (Lunges) con Mancuernas (Traseras)", "Zancadas Laterales con Mancuerna", "Zancadas Caminando con Mancuernas", "Swing con Kettlebell (Americano)", "Swing con Kettlebell (Ruso)", "Sentadilla Sumo con Mancuerna/Kettlebell", "Step-Ups con Mancuernas", "Thruster con Mancuernas (Componente de pierna)", "Sentadilla Pausada con Mancuerna/KB",
            // Máquinas
            "Prensa de Piernas (Inclinada)", "Prensa de Piernas Horizontal", "Prensa de Piernas Vertical", "Sentadilla Hack en Máquina", "Sentadilla Sissy en Máquina", "Extensión de Cuádriceps (Leg Extension)", "Curl Femoral Sentado (Seated Leg Curl)", "Curl Femoral Tumbado (Lying Leg Curl)", "Curl Femoral de Pie (Standing Leg Curl)", "Elevación de Talones Sentado (Máquina)", "Elevación de Talones de Pie (Máquina/Smith)", "Elevación de Talones tipo Burro (Donkey Calf Raise)", "Máquina de Abductores (Cadera)", "Máquina de Aductores (Cadera)", "Máquina de Glúteo Kickback", "Prensa para Gemelos en Máquina de Prensa", "Sentadilla en Máquina Smith (Varias posturas)", "Máquina Pendulum Squat", "Máquina Belt Squat", "Máquina Glute Drive / Hip Thrust",
            // Peso Corporal
            "Sentadilla con Peso Corporal (Air Squat)", "Sentadilla Isométrica (Wall Sit)", "Sentadilla Pistol (a una pierna)", "Sentadilla Búlgara con Peso Corporal", "Sentadilla Sumo con Peso Corporal", "Zancadas (Lunges) con Peso Corporal (Frontales)", "Zancadas (Lunges) con Peso Corporal (Traseras)", "Zancadas Laterales con Peso Corporal", "Zancadas Cruzadas (Curtsy Lunge)", "Zancadas con Salto (Jumping Lunges)", "Sentadilla con Salto (Jump Squat)", "Puente de Glúteo (Glute Bridge)", "Puente de Glúteo a una Pierna", "Elevación de Talones con Peso Corporal (De pie)", "Elevación de Talones Sentado (Sin peso)", "Sentadilla Skater", "Hip Thrust con Peso Corporal", "Step-Ups (Banco/Cajón)", "Sentadilla Shrimp (Gambas)", "Nordic Hamstring Curl (Asistido/Regresión)", "Marcha de Soldado (Toy Soldier)", "Patada de Glúteo (Donkey Kick)", "Hidrante de Fuego (Fire Hydrant)",
            // Pliometría
            "Salto al Cajón (Box Jump)", "Salto de Profundidad (Depth Jump)", "Saltos Laterales sobre Obstáculo", "Salto Amplio (Broad Jump)", "Saltos Tuck (Rodillas al pecho)", "Saltos Divididos (Split Jumps)", "Saltos de Vallas (Laterales/Frontales)", "Saltos a una Pierna (Single Leg Hops)", "Boundings (Saltos largos alternos)",
            // Aislamiento y Otros
            "Curl Nórdico (Nordic Ham Curl)", "Hip Thrust con Barra", "Hip Thrust con Bandas", "Hip Thrust a una Pierna", "Patada de Glúteo en Polea", "Abducción de Cadera en Polea", "Aducción de Cadera en Polea", "Good Mornings con Banda", "Pull Through en Polea", "Reverse Hyperextension", "Elevación de Tibial Anterior", "Sentadilla Jefferson", "Arrancada con Mancuerna (Componente pierna)", "Cargada con Mancuerna (Componente pierna)", "Paseo del Granjero (Farmer's Walk)", "Arrastre de Trineo (Sled Drag - Forward/Backward)", "Empuje de Trineo (Sled Push)", "Sentadilla con Cadenas", "Sentadilla con Bandas (Resistencia)", "Peso Muerto con Bandas/Cadenas",
            // Anatomía y Conceptos
            "Anatomía del Cuádriceps", "Anatomía de los Isquiotibiales (Hamstrings)", "Anatomía de los Glúteos (Mayor, Medio, Menor)", "Anatomía de los Gemelos (Gastrocnemio y Sóleo)", "Anatomía de los Aductores", "Anatomía de los Abductores", "Anatomía del Tibial Anterior", "Biomecánica de la Sentadilla", "Biomecánica del Peso Muerto", "Biomecánica de la Zancada", "Importancia del 'Leg Day'", "Frecuencia de Entrenamiento de Pierna", "Volumen de Entrenamiento para Piernas", "Intensidad (RPE/RIR) para Piernas", "Selección de Ejercicios para Hipertrofia de Pierna", "Selección de Ejercicios para Fuerza de Pierna", "Progresión de Sobrecarga en Piernas", "Periodización para Entrenamiento de Pierna", "Calentamiento Específico para Piernas", "Movilidad de Cadera para Sentadillas", "Movilidad de Tobillo para Sentadillas", "Estiramientos para Cuádriceps", "Estiramientos para Isquiotibiales", "Estiramientos para Glúteos", "Estiramientos para Gemelos", "Estiramientos para Aductores", "Prevención de Lesiones Comunes de Rodilla", "Prevención de Lesiones Lumbares en Pierna", "Errores Comunes en la Sentadilla", "Errores Comunes en el Peso Muerto", "Errores Comunes en la Prensa de Piernas", "Valgo de Rodilla: Causas y Corrección", "Importancia del Rango de Movimiento (ROM)", "Técnicas de Intensidad (Drop Sets, Superseries) para Piernas", "Entrenamiento Unilateral vs Bilateral", "Calzado Adecuado para Levantar Pesas", "Nutrición para el Desarrollo Muscular de Piernas", "Descanso y Recuperación para Piernas", "Rol del Core en Ejercicios de Pierna", "Activación de Glúteos", "Conexión Mente-Músculo en Piernas", "Diferencias entre Hipertrofia Sarcoplasmática y Miofibrilar", "Entrenamiento Oclusivo (BFR) para Piernas", "Variaciones de Stance (Postura) en Sentadillas", "Uso de Cinturón Lumbar: Pros y Contras", "Dolor de Rodilla y Modificaciones de Ejercicios", "Máquinas vs Pesos Libres para Piernas",
            // Ciclos y Programación (Ejemplos Conceptuales)
            "Rutina de Pierna Enfocada en Cuádriceps", "Rutina de Pierna Enfocada en Isquiotibiales y Glúteos", "Rutina de Pierna Completa (Principiante)", "Rutina de Pierna Completa (Intermedio)", "Rutina de Pierna Completa (Avanzado)", "Rutina Dividida PPL (Push-Pull-Legs): Día de Pierna", "Rutina Dividida Upper/Lower: Día de Pierna", "Microciclo de Ejemplo para Fuerza de Pierna", "Microciclo de Ejemplo para Hipertrofia de Pierna", "Cómo Estructurar una Semana de Entrenamiento Incluyendo Pierna", "Periodización Ondulante Diaria (DUP) para Pierna", "Periodización Lineal para Pierna", "Periodización en Bloques para Pierna", "Fase de Descarga (Deload) para Piernas", "Evaluación del Progreso en Entrenamiento de Pierna",
             // ... (Espacio para 200+ más que puede generar la API)
        ];
        const exerciseThemes = [ // Temas para "Generar Más"
            "ejercicios compuestos de pierna", "ejercicios de aislamiento de cuádriceps", "ejercicios de isquiotibiales", "ejercicios para glúteos masculinos", "ejercicios de gemelos", "entrenamiento de pierna con barra", "entrenamiento de pierna con mancuernas", "ejercicios de pierna en máquina", "ejercicios de pierna con peso corporal", "pliometría para piernas", "anatomía muscular de la pierna", "biomecánica de levantamientos", "programación de entrenamiento de pierna", "prevención de lesiones de rodilla", "técnicas avanzadas de entrenamiento de pierna", "movilidad para sentadillas", "calentamiento para pierna", "estiramientos de pierna", "variaciones de sentadilla", "variaciones de peso muerto", "entrenamiento unilateral de pierna"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un experto en kinesiología y entrenador de fuerza certificado, especializado en el entrenamiento de la extremidad inferior masculina. Tu tarea es describir el ejercicio, concepto anatómico o principio de entrenamiento de pierna indicado de manera detallada, precisa y práctica. Incluye: Músculos principales trabajados, descripción técnica de la ejecución correcta (paso a paso), errores comunes a evitar, beneficios clave, posibles variaciones o regresiones/progresiones, consideraciones de seguridad y cómo integrarlo en una rutina. Si es un concepto, explica su importancia y aplicación práctica. Usa un lenguaje claro, informativo y motivador. El objetivo es una guía completa de aproximadamente 1200-1300 palabras. Basa tu descripción únicamente en el siguiente ejercicio o concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
             systemPrompt: "Actúa como un entrenador personal asistente. Responde preguntas específicas sobre el ejercicio o concepto de pierna actualmente mostrado ('[EJERCICIO_AQUI]'). Enfócate en detalles de forma, músculos implicados, programación, o dudas relacionadas directamente con ese tema. Sé conciso, claro y práctico.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // *** SOLICITAR 40 TÍTULOS ***
            model: "mistral",
            systemPrompt: "Eres un generador de ideas para una enciclopedia de entrenamiento de pierna masculino. Genera exactamente 40 nombres de ejercicios específicos (con equipo si aplica), conceptos de anatomía de pierna, o principios de programación/entrenamiento relevantes. Devuelve *solo* la lista, un ítem por línea. No incluyas números, guiones, introducciones o despedidas.",
            timeoutSeconds: 60 // Aumentar timeout para 40 títulos
        };

        // ========== DOM ELEMENTS (sin cambios estructurales) ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Área scrollable texto+img
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const chatContextTitle = document.getElementById('chat-context-title'); // Span para título en chat
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentExerciseTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             // Dynamic system prompt for chat
             const systemPromptToUse = isChat && currentExerciseTitle
                 ? `Actúa como un entrenador personal asistente. Responde preguntas específicas sobre el ejercicio o concepto de pierna llamado '${currentExerciseTitle}'. Enfócate en detalles de forma, músculos implicados, programación, o dudas relacionadas directamente con ese tema. Sé conciso, claro y práctico.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             // Seed no es tan relevante para chat o generación masiva de títulos
             if (config.seed && !isChat && config !== titleGenerationConfig) params.append('seed', config.seed);

             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}, Titles: ${config===titleGenerationConfig}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                      throw new Error(`(Error ${response.status}) Nuestros servidores están experimentando mucho tráfico en este momento. Por favor, intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular o inténtalo más tarde.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) {
             if (!currentExerciseTitle) throw new Error("Error interno: No se estableció el contexto del ejercicio para el chat.");
             return fetchTextFromApi(userQuery, chatApiConfig, true); // true indica chat
        }
        // *** MODIFIED: fetchGeneratedTitles to use correct config ***
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(exerciseThemes) || "ejercicios de pierna variados";
            // *** Prompt pide 40 ***
            const specificPrompt = `Genera 40 ítems (ejercicios específicos, conceptos anatómicos, principios de entrenamiento) sobre ${randomTheme}`;
            console.log("Generating 40 titles with prompt:", specificPrompt);
            // *** Usa titleGenerationConfig ***
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     // *** Esperar al menos 20-30 títulos generados de 40 solicitados ***
                     if (titles.length < 20) throw new Error("La IA no generó suficientes ideas de ejercicios/conceptos.");
                     return titles.slice(0, 40); // Devolver hasta 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 600, height: 800, nologo: true }; // Más vertical para diagramas?
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "anatomía muscular pierna";
             // *** PROMPT PARA DIAGRAMAS/ILUSTRACIONES SIN TEXTO ***
             const enhancedPrompt = `Clear anatomical illustration or diagram showing the muscles involved or correct form for '${safePromptText}'. Focus on clarity and accuracy. White background preferred. Minimalist style. IMPORTANT: Avoid adding any text labels, titles, or annotations to the image itself.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Negativo más enfocado en quitar texto/desorden
             const negativePrompt = "text, words, labels, letters, title, caption, annotation, chart, graph, numbers, blurry, unclear, messy, abstract art, photograph, multiple figures, complex background, watermark, signature";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */ if(!rawText)return'';let formatted=rawText.trim();formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1');formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('−','-');return`${base}<sup>${cleanExponent}</sup>`;});formatted=formatted.replace(/\\rightarrow/g,'&rarr;');formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>');const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0);formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block;let content=block.replace(/\n/g,' ');return`<p>${content}</p>`;}).join('');return formatted; }

        // ========== MODAL FUNCTIONS ========== (sin cambios estructurales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { storyModal.classList.remove('active'); if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; } modalTextArea.scrollTop = 0; console.log("Scroll set to 0 on hideModal"); resetModalState(); }
        function resetModalState() { modalLoadingIndicator.style.display = 'flex'; modalStoryContentArea.classList.add('content-hidden'); modalError.classList.add('content-hidden'); modalTitle.textContent = ''; modalContent.innerHTML = ''; modalErrorMessage.textContent = ''; chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; currentExerciseTitle = null; chatContextTitle.textContent = 'Ejercicio'; hideFullscreenImage(); }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios estructurales)
        function addChatMessage(message, sender) { const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled || !currentExerciseTitle) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        // *** Add Icon to Title Item ***
        function createTitleItem(title) {
             const div = document.createElement('div');
             div.className = 'title-item';
             // Basic icon logic (can be expanded)
             let iconClass = 'fa-question-circle'; // Default
             if (title.toLowerCase().includes('sentadilla') || title.toLowerCase().includes('squat')) iconClass = 'fa-person-hiking'; // Simulating squat
             else if (title.toLowerCase().includes('peso muerto') || title.toLowerCase().includes('deadlift')) iconClass = 'fa-weight-hanging';
             else if (title.toLowerCase().includes('prensa') || title.toLowerCase().includes('press')) iconClass = 'fa-gear'; // Machine icon
             else if (title.toLowerCase().includes('zancada') || title.toLowerCase().includes('lunge')) iconClass = 'fa-shoe-prints'; // Steps
             else if (title.toLowerCase().includes('curl') || title.toLowerCase().includes('extensi')) iconClass = 'fa-bolt'; // Isolation/Machine
             else if (title.toLowerCase().includes('gemelo') || title.toLowerCase().includes('talon') || title.toLowerCase().includes('calf')) iconClass = 'fa-arrow-up-from-ground-water'; // Up arrow
             else if (title.toLowerCase().includes('glúteo') || title.toLowerCase().includes('hip thrust')) iconClass = 'fa-bridge'; // Glute bridge ish
             else if (title.toLowerCase().includes('anatomía') || title.toLowerCase().includes('biomecánica')) iconClass = 'fa-person-chalkboard'; // Teaching
             else if (title.toLowerCase().includes('rutina') || title.toLowerCase().includes('programa')) iconClass = 'fa-calendar-alt'; // Planning

             div.innerHTML = `<i class="fas ${iconClass}"></i><span>${title}</span>`; // Add icon span
             div.setAttribute('data-title', title);
             div.addEventListener('click', () => handleTitleClick(title));
             return div;
         }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Simple sort, could be smarter grouping later
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay ejercicios o conceptos cargados.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.getAttribute('data-title')));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick (set chat context title) ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentExerciseTitle = title; // Set chat context
            chatContextTitle.textContent = title; // Update chat title span
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Image Placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Generando diagrama/ilustración...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Image Element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Diagrama o ilustración de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { console.log("Image loaded."); placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { console.error("Error loading image:", title); placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo cargar la imagen.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { console.error("No image URL generated for:", title); placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al crear URL.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la información.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles (uses new config) ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más en la base de datos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Uses the updated function
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más ejercicios/conceptos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar más datos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // *** BUTTON TEXT UPDATED ***
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Cargar 40 Ejercicios/Conceptos Más';
             }
         }

         // Search Filter Function (normalize accents)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.getAttribute('data-title').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Robust check for essential elements
            const essentialElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, chatContextTitle];
            if (essentialElements.some(el => !el)) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: No se cargaron los componentes de la interfaz. Recarga la página.</p>';
                 return;
            }

            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial Load
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            console.log("App Initialized Successfully");
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>