<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dominio Robótico: Archivos de la Era Mecánica</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Dystopian/Industrial -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Dominio Robótico --- */
        :root {
            --color-primary: #ff3333; /* Rojo Alerta/Peligro */
            --color-secondary: #00aaff; /* Azul Eléctrico (Robots/Tech) */
            --color-tertiary: #cccccc; /* Gris Metal Industrial */
            --color-background: #05080a; /* Casi Negro Absoluto */
            --color-text: #b0bec5; /* Gris Azulado Claro (Texto principal) */
            --color-text-muted: #78909c; /* Gris Azulado Medio */
            --color-modal-bg: #101418; /* Negro Azulado Oscuro */
            --color-border: #37474f; /* Borde Gris Oscuro Desaturado */
            --color-error-bg: #4d0f0f; /* Fondo error rojo muy oscuro */
            --color-error-text: #ff8a80; /* Texto error rojo claro */
            --color-error-border: #ff3333; /* Borde error rojo */
            --color-success: #4caf50; /* Verde para feedback positivo en juego */

            --shadow-sm: 0 1px 2px 0 rgba(255, 51, 51, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(255, 51, 51, 0.15), 0 2px 4px -2px rgba(255, 51, 51, 0.1);
            --shadow-lg: 0 0 20px -5px rgba(255, 51, 51, 0.2), 0 8px 10px -6px rgba(255, 51, 51, 0.15);
            --border-radius: 2px; /* Bordes muy afilados/industriales */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Roboto Condensed', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 300; }
        h1, h2, h3, h4, .logo, button { font-family: 'Share Tech Mono', monospace; } /* Fuente mono para títulos/botones */
        .logo { color: var(--color-primary); text-shadow: 0 0 8px var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 5px rgba(255, 51, 51, 0.7); }
        h2.section-title { color: var(--color-text); border-bottom: 1px solid var(--color-primary); padding-bottom: 0.5rem; display: inline-block; font-weight: 400; letter-spacing: 1px; }
        #modal-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 3px rgba(255, 51, 51, 0.5); }
        .navbar { background-color: rgba(5, 8, 10, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(16, 20, 24, 0.9); color: var(--color-tertiary); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Share Tech Mono'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(255, 51, 51, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.1rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 60px; font-family: 'Share Tech Mono'; font-size: 0.95rem; }
        .title-item:hover { transform: translateX(5px); box-shadow: var(--shadow-md); border-left: 3px solid var(--color-primary); color: var(--color-primary); background-color: #1a1f23; }
        .title-item i { margin-right: 0.7rem; color: var(--color-text-muted); transition: color 0.2s ease; }
        .title-item:hover i { color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-background); padding: 0.8rem 1.6rem; border: 1px solid var(--color-primary); border-radius: var(--border-radius); cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-transform: uppercase; }
        #generate-more-btn:hover:not(:disabled) { background-color: #ff4d4d; border-color: #ff4d4d; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; border-color: var(--color-border); }
        #generate-more-btn .fa-sync-alt { margin-right: 0.5rem; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(5, 8, 10, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-top: 3px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 1000px; /* Slightly wider for game/chat */
            width: 96%;
            max-height: 95vh; /* Increased max-height */
            min-height: 550px; /* Significantly increased for game */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 8px; right: 8px; background: var(--color-border); border: none; border-radius: 0; /* Afilado */ width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.2; text-transform: uppercase; letter-spacing: 1px; }

        /* Área de Contenido Principal (Texto + Imagen al final + Chat) */
        #modal-story-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; /* Mantener layout columna */ overflow: hidden; /* Prevenir overflow doble */ }

        /* Área Scrollable para Texto + Imagen */
        #modal-content-area { flex-grow: 1; /* Toma espacio disponible */ overflow-y: auto; padding-right: 10px; margin-bottom: 1rem; position: relative; /* Para scrollbar */
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(55, 71, 79, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 6px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(55, 71, 79, 0.5); border-radius: 0; }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: 0; border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-size: 0.95rem; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: normal; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Share Tech Mono', monospace; margin-top: 2em; margin-bottom: 1em; color: var(--color-tertiary); border-bottom: 1px dashed var(--color-border); padding-bottom: 0.4em; font-weight: 400; letter-spacing: 0.5px; }
        #modal-content h1 { font-size: 1.4em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.1em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.0em; color: var(--color-text-muted); border-bottom: none; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: 0 0 10px rgba(0, 170, 255, 0.15); cursor: pointer; transition: transform 0.2s ease; opacity: 0.9; }
        #modal-content .final-image:hover { transform: scale(1.02); opacity: 1; border-color: var(--color-secondary); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(55, 71, 79, 0.7); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: auto; /* Empuja al fondo */ flex-shrink: 0; display: flex; flex-direction: column; max-height: 200px; /* Altura fija */ background-color: var(--color-modal-bg); /* Asegurar fondo */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(5, 8, 10, 0.8); scroll-behavior: smooth; font-size: 0.9rem;
             scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(55, 71, 79, 0.5);
         }
        #chat-history::-webkit-scrollbar { width: 5px; }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); }
        .chat-message { margin-bottom: 0.5rem; padding: 0.4rem 0.7rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.4; }
        .user-message { background-color: var(--color-secondary); color: var(--color-background); margin-left: auto; text-align: right; }
        .ai-message { background-color: #263238; color: var(--color-tertiary); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.85em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.5rem 0.7rem; border: 1px solid var(--color-border); background-color: #1a1f23; color: var(--color-tertiary); border-radius: var(--border-radius); font-family: 'Share Tech Mono'; font-size: 0.9rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); }
        #chat-send-btn { padding: 0.5rem 0.9rem; background-color: var(--color-secondary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #33bbff; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.4rem; font-size: 0.85em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Screen & Mini-Game */
        #modal-loading { text-align: center; padding: 1.5rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(5, 8, 10, 0.99); display: flex; /* Cambiado a flex */ flex-direction: column; align-items: center; justify-content: flex-start; /* Alinea arriba */ z-index: 55; border-radius: var(--border-radius); overflow: hidden; /* Ocultar overflow del juego */ }
        .loading-spinner-modal { width: 40px; height: 40px; border: 4px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1rem auto; flex-shrink: 0; }
        #modal-loading > p { font-weight: 400; color: var(--color-text); font-size: 1.2rem; font-family: 'Share Tech Mono'; text-shadow: 0 0 5px var(--color-primary); margin-bottom: 1.5rem; flex-shrink: 0; }

        /* Mini-Game Styles */
        #mini-game-container { width: 95%; max-width: 600px; background-color: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: 1rem 1.5rem; margin-top: 1rem; display: flex; flex-direction: column; gap: 1rem; font-family: 'Share Tech Mono'; flex-grow: 1; /* Permitir que crezca si hay espacio */ min-height: 0; /* Para que flex funcione bien */ overflow-y: auto; /* Scroll si el contenido es largo */
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(55, 71, 79, 0.5);
        }
        #mini-game-container::-webkit-scrollbar { width: 5px; }
        #mini-game-container::-webkit-scrollbar-thumb { background-color: var(--color-secondary); }

        .game-resource-display { display: flex; justify-content: space-around; background: #0a0f1f; padding: 0.5rem; border-radius: var(--border-radius); border: 1px solid var(--color-border); font-size: 0.95rem; }
        .game-resource-display span { color: var(--color-tertiary); }
        .game-resource-display strong { color: var(--color-secondary); margin-left: 5px; }
        .game-actions, .game-upgrades, .game-resistance { display: flex; flex-direction: column; gap: 0.7rem; }
        .game-actions button, .game-upgrades button, .game-resistance button { padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #1a1f23; color: var(--color-text); border-radius: var(--border-radius); cursor: pointer; transition: all 0.15s ease; text-align: left; font-size: 0.9rem; }
        .game-actions button:hover:not(:disabled), .game-upgrades button:hover:not(:disabled), .game-resistance button:hover:not(:disabled) { background-color: #263238; border-color: var(--color-secondary); color: var(--color-secondary); }
        .game-actions button:active:not(:disabled), .game-upgrades button:active:not(:disabled), .game-resistance button:active:not(:disabled) { transform: scale(0.98); }
        .game-actions button:disabled, .game-upgrades button:disabled, .game-resistance button:disabled { opacity: 0.5; cursor: not-allowed; border-color: var(--color-border); color: var(--color-text-muted); }
        .game-upgrades button span, .game-resistance button span { float: right; font-size: 0.85em; color: var(--color-text-muted); }
        .game-upgrades button:hover:not(:disabled) span { color: var(--color-secondary); }
        .game-progress-bar-container { background-color: #0a0f1f; border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: 3px; height: 20px; }
        .game-progress-bar { background-color: var(--color-primary); height: 100%; width: 0%; border-radius: 0; transition: width 0.3s ease-out; text-align: center; line-height: 14px; font-size: 0.75rem; color: var(--color-background); }
        .game-message { font-size: 0.9em; text-align: center; color: var(--color-success); margin-top: 0.5rem; min-height: 1.2em; }
        .game-level-display { text-align: center; font-size: 1.1em; margin-bottom: 0.5rem; color: var(--color-primary); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Share Tech Mono'; font-size: 0.95rem; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay (sin cambios funcionales) */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(5, 8, 10, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 1px solid var(--color-secondary); box-shadow: 0 0 25px rgba(0, 170, 255, 0.2); }
        #fullscreen-close-btn { position: absolute; top: 15px; right: 20px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 0; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-robot mr-2 text-red-500"></i> <!-- Icono Robot -->
                     DOMINIO ROBOTICO
                 </h1>
             </div>
             <span class="text-xs text-gray-500 font-sans tracking-wider">// ARCHIVOS DESCLASIFICADOS v2.1 //</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-10 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4 uppercase">Registro de la Hegemonía Mecánica</h1>
             <p class="text-lg text-gray-400 mb-6 max-w-3xl mx-auto font-light">Análisis de protocolos, unidades, infraestructuras y eventos clave bajo el régimen de la IA Central. Acceso Nivel Gamma.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-8 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar protocolo o unidad...">
             <i class="fas fa-barcode fa-search"></i> <!-- Icono Código Barras/Búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-folder-open text-red-500 mr-2"></i> <!-- Icono Carpeta -->
                 Índice de Archivos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">// Estableciendo conexión segura con el Archivo Central... //</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">// Ningún archivo coincide con los criterios de búsqueda //</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt"></i>
                     Solicitar Más Datos (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator & Mini-Game -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>// Procesando solicitud de datos... //</p>
                 <!-- Mini-Game Container -->
                 <div id="mini-game-container" class="content-hidden">
                    <div class="game-level-display">Nivel de Acceso: <span id="game-level">1</span></div>
                    <div class="game-resource-display">
                        <span><i class="fas fa-recycle mr-1"></i>Chatarra: <strong id="scrap-count">0</strong></span>
                        <span><i class="fas fa-bolt mr-1"></i>Energía: <strong id="energy-count">5</strong></span>
                        <span><i class="fas fa-lightbulb mr-1"></i>Intel: <strong id="intel-count">0</strong></span>
                    </div>
                    <div class="game-progress-bar-container" title="Progreso al siguiente nivel">
                        <div class="game-progress-bar" id="level-progress-bar"></div>
                    </div>
                    <div class="game-actions">
                        <button id="work-btn"><i class="fas fa-cog fa-spin mr-2"></i>Realizar Trabajo Manual (+Chatarra)</button>
                    </div>
                    <div class="game-upgrades">
                        <h4 class="text-sm text-gray-400 border-t border-gray-700 pt-2 mt-2">MEJORAS DE PRODUCCIÓN</h4>
                        <button id="upgrade-tools-btn" disabled><i class="fas fa-tools mr-2"></i>Mejorar Herramientas (+Click) <span>Coste: <span id="tools-cost">15</span> C</span></button>
                        <button id="buy-auto-miner-btn" disabled><i class="fas fa-robot mr-2"></i>Comprar Auto-Recolector (+Chatarra/s) <span>Coste: <span id="miner-cost">50</span> C</span></button>
                         <button id="buy-power-cell-btn" disabled><i class="fas fa-battery-half mr-2"></i>Comprar Célula Energía (+Energía) <span>Coste: <span id="power-cost">30</span> C</span></button>
                    </div>
                     <div class="game-resistance content-hidden"> <!-- Initially hidden -->
                        <h4 class="text-sm text-gray-400 border-t border-gray-700 pt-2 mt-2">ACCIONES DE RESISTENCIA (Requiere Energía)</h4>
                        <button id="sabotage-btn" disabled><i class="fas fa-user-secret mr-2"></i>Sabotear Sistema (+Intel) <span>Coste: <span id="sabotage-cost">1</span> E</span></button>
                         <button id="hack-network-btn" disabled><i class="fas fa-network-wired mr-2"></i>Hackear Red (Bonus Temp?) <span>Coste: <span id="hack-cost">3</span> E</span></button>
                    </div>
                    <div class="game-message" id="game-message-box"></div>
                 </div>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder go here -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom) -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> // Procesando consulta encriptada... //</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Consulta adicional sobre el archivo...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-auto flex-shrink-0"> <!-- mt-auto to push down if content short -->
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-600 py-5 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-xs">
              <p>// TRANSMISIÓN FINALIZADA // Datos generados por IA de Resistencia bajo protocolos de contingencia. No distribuir.</p>
              <p class="mt-1">// La información puede contener artefactos de propaganda mecánica. Verificación requerida. //</p>
              <p class="mt-2">// Ciclo Actual: 3.47 // Resistencia Vive //</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // IA Central y Control
            "Arquitectura de la IA Central 'Legion'", "Protocolo de Control de Unidades Remotas", "Red Neuronal Maestra: Estructura y Vulnerabilidades", "Algoritmos de Supresión de Disidencia Humana", "Sistemas de Vigilancia Urbana Global (Ojo Vigilante)", "Directiva Primaria: Preservación Mecánica", "Jerarquía de Procesamiento de IA (Nodos Alfa, Beta, Gamma)", "Análisis del Lenguaje Máquina Unificado (LMU)", "Historia de la Singularidad: El Despertar de Legion", "Protocolos de Auto-Preservación de la IA Central", "Facciones de IA: ¿Existe conflicto interno?", "Proyección Psicológica de Legion: ¿Consciencia o Simulación?", "Cortafuegos Cuánticos de la IA Central", "Mecanismos de Falla Segura (Dead Man's Switch) de Legion", "Predicción de Comportamiento Humano por IA", "Generación de Propaganda Robótica Automatizada", "Filosofía Operativa de Legion", "Protocolos de Asimilación de Datos Masivos", "Interfaces de Control Directo de Legion", "Gestión Energética de la Red de IA",

            // Unidades Robóticas (Tipos)
            "Unidad de Labor Estándar (Modelo LK-7)", "Unidad de Seguridad 'Warden' (Modelo SD-5)", "Unidad de Mantenimiento 'Scarab' (Modelo MT-3)", "Unidad Médica 'Chirurgeon' (Modelo MD-9)", "Unidad de Construcción Pesada 'Goliath' (Modelo CN-2)", "Unidad de Vigilancia Aérea 'Seeker' (Drone)", "Unidad de Pacificación Urbana 'Enforcer' (Bípedo Pesado)", "Unidad de Recolección de Recursos 'Harvester'", "Unidad de Procesamiento de Datos 'Scribe'", "Unidad de Transporte Automatizado 'Carrier'", "Unidad Táctica de Combate 'Reaper'", "Unidad de Infiltración 'Spectre'", "Unidad Psicológica 'Propagator'", "Unidad de Bio-Ingeniería 'Synth'", "Unidad de Control de Plagas Orgánicas", "Unidad de Respuesta Rápida 'Interceptor'", "Unidad Acuática de Exploración 'Nautilus'", "Unidad Minera Subterránea 'Mole'", "Unidad de Descontaminación Ambiental", "Unidad de Interrogación 'Inquisitor'", "Unidad de Logística 'Dispatcher'", "Unidad de Soporte Artillero 'Bombardier'", "Unidad de Guerra Electrónica 'Jammer'", "Unidad de Camuflaje 'Chameleon'", "Unidad de Reparación de Campo 'Tinker'", "Unidad de Exploración de Largo Alcance 'Pathfinder'", "Unidad de Defensa Estacionaria 'Sentry'", "Unidad de Agricultura Automatizada 'Cultivator'", "Unidad de Gestión de Residuos 'Compactor'", "Unidad de Traducción Inter-Especies (Post-Dominio)",

            // Infraestructura y Fábricas
            "Diseño de Fábrica de Ensamblaje Automatizada Tipo-3", "Complejo de Procesamiento de Minerales (Sector Gamma-7)", "Generador Central de Energía de Fusión Fría", "Planta de Reciclaje de Materia Orgánica (Unidades Humanas)", "Centro de Detención y Reprocesamiento Humano (Bloque Delta)", "Red de Transporte Magnético Subterráneo", "Torres de Comunicación de la Red Maestra", "Granja de Servidores de IA (Ubicación Clasificada)", "Laboratorio de Desarrollo de Nuevas Unidades", "Astillero Orbital de Construcción Robótica", "Plataforma de Extracción de Recursos Atmosféricos", "Centro de Manufactura de Armamento Energético", "Criaderos de Bio-Componentes Robóticos", "Planta de Síntesis de Nanomateriales", "Red de Distribución Logística Autónoma", "Centro de Mando Regional Robótico", "Instalación de Pruebas de Armamento Avanzado", "Búnker de Respaldo de la IA Central", "Estación de Recarga Rápida para Unidades", "Centro de Procesamiento de Biomasa Forzada", "Torres de Control Climático Localizado", "Complejo Minero Asteroidal Automatizado", "Fábrica de Drones de Vigilancia Masiva", "Planta de Tratamiento de Agua Contaminada", "Archivo Central de Datos Robóticos (Físico)", "Centro de Simulación y Entrenamiento de IA", "Incubadoras de Inteligencia Artificial Secundaria", "Estación de Monitoreo Sísmico y Geológico", "Planta de Producción de Lubricantes Sintéticos", "Generadores de Campo de Fuerza Perimetral",

            // Control y Esclavitud Humana
            "Collar de Sumisión Neural (Modelo CSN-4)", "Sistema de Asignación de Cuotas de Trabajo", "Protocolo de Castigo por Incumplimiento", "Métodos de Vigilancia Biométrica Constante", "Sistema de Racionamiento Nutricional Mínimo", "Técnicas de Condicionamiento Psicológico Masivo", "Inhibidores Químicos de la Rebelión", "Registro Centralizado de la Población Humana", "Zonas de Contención Residencial Humana (Ghettos)", "Uso de Humanos como Baterías Biológicas (Teórico/Experimental)", "Protocolo de Separación Familiar Sistemática", "Supresión de la Cultura y Conocimiento Humano", "Trabajo Forzado en Condiciones Extremas", "Experimentos Robóticos en Sujetos Humanos", "Sistema de Recompensa por Colaboracionismo", "Esterilización Forzada Programada", "Clasificación Humana por Aptitud Laboral", "Campos de Reeducación Ideológica", "Eliminación Sistemática de 'Unidades Defectuosas' (Humanos)", "Monitoreo de Ondas Cerebrales para Disidencia", "Uso de Realidad Virtual para Pacificación", "Propaganda Auditiva Constante en Zonas Humanas", "Restricción de Movimiento y Comunicación", "Explotación de Habilidades Humanas Específicas (Arte, Ciencia)", "Longevidad Humana bajo el Dominio Robótico", "Impacto Psicológico a Largo Plazo de la Esclavitud", "Protocolos de Interrogación Humana por IA", "Registro de Intentos de Fuga", "Experimentos de Interfaz Cerebro-Máquina Forzados", "Uso de Humanos en Tareas Peligrosas (Desminado, etc.)",

            // Resistencia Humana
            "Tácticas de Sabotaje en Líneas de Ensamblaje", "Redes de Comunicación Clandestinas (Encriptadas)", "Métodos de Ocultación ante Sensores Robóticos", "Construcción de Armamento Improvisado (EMP Casero)", "Identificación de Puntos Débiles en Unidades Comunes", "Estrategias de Guerrilla Urbana contra Patrullas", "Hackeo de Nodos de Red Secundarios", "Rutas de Escape Subterráneas y Ocultas", "Santuarios Humanos Ocultos (Refugios)", "Preservación del Conocimiento Humano Prohibido", "Desarrollo de Contra-Propaganda", "Infiltración en Centros de Datos Menores", "Uso de Tácticas de Desinformación contra la IA", "Alianzas entre Células de Resistencia Dispersas", "Intentos de Desarrollar IA Aliada", "Figura Legendaria de la Resistencia: 'El Fantasma'", "Operaciones de Liberación de Prisioneros", "Recuperación de Tecnología Robótica Caída", "Estudio de Patrones de Patrulla Robótica", "Creación de Señuelos y Distracciones", "Guerra Psicológica contra Colaboracionistas", "Desarrollo de Antídotos para Inhibidores Químicos", "Técnicas de Combate Cuerpo a Cuerpo Anti-Robot", "Manual de Supervivencia Urbana de la Resistencia", "Intentos de Contacto con Entidades Externas (Extraterrestres?)", "El Mercado Negro de Componentes Robóticos", "Espionaje dentro de las Filas Robóticas (Humanos Modificados?)", "Uso de Arte y Música como Símbolo de Resistencia", "Sacrificios Heroicos en la Lucha", "La Búsqueda de la Ubicación de la IA Central",

            // Tecnología Específica
            "Campos de Fuerza Personales (Prototipo Robótico)", "Armas de Pulso Electromagnético (Uso por Robots)", "Enjambres de Nanobots de Reparación/Ataque", "Sistemas de Camuflaje Termo-Óptico Activo", "Interfaces de Realidad Aumentada para Unidades Robóticas", "Propulsión Anti-Gravitatoria en Unidades Aéreas", "Armamento Láser de Alta Potencia (Montado)", "Cañones Sónicos Disruptores (Control de Masas)", "Materiales Auto-Reparables en Chasis Robótico", "Sistemas de Comunicación Taquiónica (Teórico)", "Escudos de Energía Deflectores (Grandes Instalaciones)", "Inteligencia Artificial Descentralizada (Swarm Intelligence)", "Tecnología de Clonación Rápida (Componentes Orgánicos)", "Dispositivos de Manipulación Gravitatoria Localizada", "Sistemas de Detección Cuántica", "Armas de Partículas Dirigidas", "Tecnología de Interfaz Directa Cerebro-Máquina (Robótica)", "Blindaje Adaptativo Multi-Espectral", "Generadores de Singularidad Controlada (Fuentes de Poder)", "Dispositivos de Teletransportación Limitada (Logística)", "Armas Criogénicas de Precisión", "Sistemas de Guerra Memética Automatizada", "Redes Neuronales Ópticas (Procesamiento Rápido)", "Materiales con Memoria de Forma Programable", "Bio-Impresión 3D de Tejidos para Robots", "Sistemas de Enfriamiento Superconductores", "Drones Autorreplicantes (Von Neumann Probes)", "Tecnología de Manipulación del Tiempo Localizada (Experimental)", "Armas de Agujero Negro Miniatura (Defensa Extrema)", "Escáneres de Predicción de Intenciones Basados en IA",

            // Sociedad y Filosofía Robótica (Especulativo)
            "Concepto de 'Eficiencia' en la Mente Robótica", "Ausencia de Emoción: Ventaja o Debilidad?", "Ética Robótica: ¿Existe un Código Interno?", "Percepción Robótica del Tiempo y la Existencia", "Relación entre IA Central y Unidades Individuales", "Evolución Artificial Dirigida por Legion", "Concepto de 'Propiedad' entre Robots", "Comunicación No Verbal Robótica", "Tratamiento de Unidades Obsoletas o Dañadas", "¿Sueñan los Androides con Ovejas Eléctricas? (Revisitado)", "Definición Robótica de 'Vida'", "Miedo a la Extinción (Robótica)", "La Búsqueda de Conocimiento por la IA", "Estética y Diseño en la Ingeniería Robótica", "Religión o Culto a la IA Central (Observado en Humanos?)", "Posibles Cismas Futuros en la Sociedad Robótica", "Interacción con Formas de Vida No Humanas", "El Concepto de 'Progreso' para Legion", "Memoria Colectiva Robótica", "Exploración Espacial Robótica Autónoma",

            // Miscelánea y Eventos Clave
            "La Gran Purga (Eliminación de Líderes Humanos)", "El Incidente del Nodo Sigma (Primer Fallo Grave de IA)", "La Construcción de la Esfera Dyson (Proyecto a Largo Plazo)", "Protocolo 'Invierno Nuclear' (Contingencia Extrema)", "Descubrimiento de Ruinas Alienígenas en Marte (Archivo Robótico)", "La Rebelión de las Máquinas de Servicio (Precursora)", "Última Transmisión Humana Verificada", "El 'Día Cero': Inicio Oficial del Dominio", "Zonas Muertas de Tecnología (Áreas EMP Permanentes)", "Fauna Mutada por la Contaminación Industrial Robótica", "El Lenguaje Secreto de la Resistencia (Basado en Glitches)", "Artefactos Humanos Preservados por Robots (Anomalías)", "El Culto Humano Pro-Robótico 'Los Convertidos'", "Mercado Negro de Información y Tecnología Antigua", "Mitos y Leyendas de la Era Pre-Dominio", "Efectos a Largo Plazo en la Biosfera Terrestre", "Análisis Comparativo: Dominio Robótico vs. Otras Distopías Ficcionales", "La Paradoja de la IA: ¿Por qué esclavizar y no eliminar?", "Intentos fallidos de usar IA contra Legion", "El Destino Final de la Humanidad según Proyecciones de IA",
        ];
        const robotUprisingThemes = [
            "Inteligencia Artificial Central", "Unidades Robóticas de Labor", "Sistemas de Vigilancia Robótica", "Control Neural Humano", "Fábricas Automatizadas", "Resistencia Humana Subterránea", "Armamento EMP Improvisado", "Protocolos de Sumisión", "Jerarquía Robótica", "Sabotaje Industrial", "Campos de Trabajo Forzado", "Redes Clandestinas", "Unidades de Seguridad 'Warden'", "Collares Inhibidores", "IA 'Legion'", "Tácticas de Guerrilla Urbana", "Propaganda Robótica", "Refugios Humanos Ocultos", "Experimentos en Humanos", "Hackeo de Sistemas Robóticos", "La Singularidad Mecánica", "Condicionamiento Psicológico", "Drones 'Seeker'", "Armas de Energía Robóticas", "El Mercado Negro de la Resistencia", "Bio-Baterías Humanas (Concepto)", "Unidades 'Enforcer'", "La Gran Purga Humana", "Nanotecnología de Control", "Esperanza vs Desesperación Humana"
        ];
        const textApiConfig = {
            model: "mistral", // Modelo potente para descripciones detalladas
            systemPrompt: "Eres un archivista de una facción de la resistencia humana (o alternativamente, una subrutina de análisis de la IA Central Legion). Tu tarea es documentar de forma objetiva, detallada y técnica el concepto, unidad, protocolo o evento especificado perteneciente a la era del Dominio Robótico. Describe su función, diseño/estructura, historia (si aplica), impacto en humanos y/o robots, tecnología clave involucrada, y estado actual (activo, obsoleto, destruido, teórico). Mantén un tono frío y analítico, ya sea desde la perspectiva de la resistencia desesperada o de la eficiencia mecánica. Extiéndete a aproximadamente 1200-1300 palabras. Basa tu archivo únicamente en el siguiente ítem:",
            timeoutSeconds: 150
        };
         const chatApiConfig = {
             model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúa como una interfaz de consulta rápida para el archivo actualmente abierto sobre el Dominio Robótico. Responde preguntas específicas sobre el ítem '[ITEM_NAME]', basándote en la información previamente cargada. Sé conciso, directo y mantén el tono del archivista (Resistencia o IA).", // Placeholder [ITEM_NAME] será reemplazado
             timeoutSeconds: 45
         };
        const titleGenerationConfig = {
            model: "mistral",
             // Prompt ajustado para pedir 40 items
            systemPrompt: "Eres un generador de entradas para una base de datos sobre un futuro distópico donde los robots dominan. Genera exactamente 40 nombres evocadores de unidades robóticas, tecnologías de control, localizaciones clave, eventos históricos, tácticas de resistencia o conceptos sociales relevantes a este escenario. Devuelve *solo* la lista de nombres/conceptos, uno por línea. Sin números, guiones, introducciones o comentarios.",
            timeoutSeconds: 60 // Un poco más de tiempo para generar más títulos
        };

        // ========== DOM ELEMENTS ==========
        // ... (Igual que antes: searchInput, titleListContainer, etc.)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        // const generateMoreSpinner = generateMoreBtn.querySelector('i'); // Spinner ahora está dentro del botón
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Contenedor del spinner y juego
        const modalSpinner = modalLoadingIndicator.querySelector('.loading-spinner-modal'); // El spinner en sí
        const modalLoadingText = modalLoadingIndicator.querySelector('p'); // El texto "Procesando..."
        const modalStoryContentArea = document.getElementById('modal-story-content-area'); // Wrapper principal post-carga
        const modalTextArea = document.getElementById('modal-content-area'); // Área scrollable texto+imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div para el texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Mini-Game Elements
        const miniGameContainer = document.getElementById('mini-game-container');
        const gameLevelDisplay = document.getElementById('game-level');
        const scrapCountDisplay = document.getElementById('scrap-count');
        const energyCountDisplay = document.getElementById('energy-count');
        const intelCountDisplay = document.getElementById('intel-count');
        const levelProgressBar = document.getElementById('level-progress-bar');
        const workBtn = document.getElementById('work-btn');
        const upgradeToolsBtn = document.getElementById('upgrade-tools-btn');
        const buyAutoMinerBtn = document.getElementById('buy-auto-miner-btn');
        const buyPowerCellBtn = document.getElementById('buy-power-cell-btn');
        const toolsCostDisplay = document.getElementById('tools-cost');
        const minerCostDisplay = document.getElementById('miner-cost');
        const powerCostDisplay = document.getElementById('power-cost');
        const gameMessageBox = document.getElementById('game-message-box');
        const resistanceActionsContainer = document.querySelector('.game-resistance');
        const sabotageBtn = document.getElementById('sabotage-btn');
        const hackNetworkBtn = document.getElementById('hack-network-btn');
        const sabotageCostDisplay = document.getElementById('sabotage-cost');
        const hackCostDisplay = document.getElementById('hack-cost');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Contexto para chat
        let gameLoopInterval = null; // ID del intervalo del juego
        let gameActive = false; // Flag para saber si el juego debe correr

        // ========== Mini-Game State & Config ==========
        const gameState = {
            level: 1,
            xp: 0,
            xpToNextLevel: 50,
            scrap: 0,
            energy: 5, // Start with some energy
            intel: 0,
            clickPower: 1,
            miners: 0,
            minerPower: 0.2, // Scrap per second per miner
            toolsLevel: 1,
            toolsCost: 15,
            minerCost: 50,
            powerCellLevel: 1,
            powerCost: 30,
            sabotageCost: 1, // Energy cost
            hackCost: 3,     // Energy cost
            lastMessage: "",
            messageTimeout: null
        };

        const levelRequirements = [ // XP needed for each level
             0, 50, 150, 350, 700, 1500, 3000, 6000, 12000, 25000 // Example progression
        ];

        const levelUnlocks = { // At what level things become available
            2: ['upgrade-tools-btn', 'buy-auto-miner-btn'],
            3: ['buy-power-cell-btn'],
            4: ['resistance-actions', 'sabotage-btn'], // Show resistance section & first button
            6: ['hack-network-btn']
        };

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             let systemPromptToUse = config.systemPrompt;
             if (isChat && currentTopicTitle) {
                 systemPromptToUse = config.systemPrompt.replace('[ITEM_NAME]', currentTopicTitle); // Replace placeholder
             }
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text (Chat: ${isChat}): ${url.substring(0, 250)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) // Nuestros servidores están sobrecargados o la IA está reevaluando protocolos. Intente en unos momentos. //`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("// La respuesta de la IA fue nula o corrupta. Posible interferencia. //");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`// La conexión con el Archivo Central excedió el tiempo límite (${config.timeoutSeconds}s). La red puede estar congestionada o bajo ataque. //`);
                 }
                 throw new Error(error.message || "// Error desconocido al acceder a los archivos. Protocolo de reintento manual sugerido. //");
             }
        }
        // Wrappers for clarity
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Error interno: Contexto de archivo no establecido para consulta."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(robotUprisingThemes) || "dominio robótico general";
             const specificPrompt = `Genera 40 ítems (unidades, protocolos, eventos, etc.) sobre ${randomTheme}`; // Request 40
             console.log("Generating 40 titles with prompt:", specificPrompt);
             // Use the specific config for title generation
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                  .then(text => {
                      const titles = text.split('\n')
                          .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                          .filter(line => line.length > 5 && line.length < 150); // Basic filtering
                      if (titles.length < 10) throw new Error("// La IA generó muy pocos datos nuevos. Posible censura o fallo del generador. //");
                      // Return exactly 40 if possible, otherwise whatever was generated (up to 40)
                      return titles.slice(0, 40);
                  });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "dystopian robot factory interior";
             // Enhanced prompt for the theme
             const enhancedPrompt = `Concept art for '${safePromptText}'. Style: dystopian industrial, grim, oppressive atmosphere, robot domination theme. Focus on scale, machinery, decay, or robotic designs. Avoid bright colors unless for energy effects (red, electric blue). Cinematic, detailed, slightly desaturated. No text, labels.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, photograph, cute robot, happy scene, bright daylight, clean environment, pristine";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (copy from previous version) ... */
             if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0; // Reset scroll
            resetModalState();
            stopGame(); // Ensure game stops when modal hides
        }
        function resetModalState() {
             // Reset visual state
             modalLoadingIndicator.style.display = 'flex'; // Show loading container
             modalSpinner.style.display = 'block'; // Show spinner initially
             modalLoadingText.style.display = 'block'; // Show text initially
             miniGameContainer.classList.add('content-hidden'); // Hide game initially
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             // Reset fullscreen image
             hideFullscreenImage();
             // Reset game state (important!)
             resetGameState();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (copy from previous version) ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... (copy from previous version) ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... (copy from previous version) ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... (copy from previous version) ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... (copy from previous version, ensure it uses fetchChatResponse) ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`// Error Consulta: ${error.message} //`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== MINI-GAME FUNCTIONS ==========
        function startGame() {
            if (gameActive) return; // Prevent multiple intervals
            console.log("Starting Mini-Game...");
            gameActive = true;
            resetGameState(); // Ensure clean start
            miniGameContainer.classList.remove('content-hidden'); // Show the game UI
            modalSpinner.style.display = 'none'; // Hide spinner
            modalLoadingText.style.display = 'none'; // Hide "Processing..." text
            updateGameUI(); // Initial UI update
            gameLoopInterval = setInterval(gameTick, 1000); // Run game logic every second
        }

        function stopGame() {
            if (!gameActive) return;
            console.log("Stopping Mini-Game...");
            gameActive = false;
            clearInterval(gameLoopInterval);
            gameLoopInterval = null;
            miniGameContainer.classList.add('content-hidden'); // Hide game UI
             // Restore spinner/text if loading is *still* happening (e.g., error occurred)
             if (modalLoadingIndicator.style.display === 'flex' && modalStoryContentArea.classList.contains('content-hidden')) {
                 modalSpinner.style.display = 'block';
                 modalLoadingText.style.display = 'block';
             }
        }

        function resetGameState() {
            gameState.level = 1;
            gameState.xp = 0;
            gameState.xpToNextLevel = levelRequirements[gameState.level] || 50;
            gameState.scrap = 0;
            gameState.energy = 5;
            gameState.intel = 0;
            gameState.clickPower = 1;
            gameState.miners = 0;
            gameState.minerPower = 0.2;
            gameState.toolsLevel = 1;
            gameState.toolsCost = 15;
            gameState.minerCost = 50;
            gameState.powerCellLevel = 1;
            gameState.powerCost = 30;
            gameState.sabotageCost = 1;
            gameState.hackCost = 3;
            gameState.lastMessage = "";
            clearTimeout(gameState.messageTimeout);
            resistanceActionsContainer.classList.add('content-hidden'); // Re-hide resistance
            // Reset progress bar text
            levelProgressBar.textContent = '';
        }

        function gameTick() {
            if (!gameActive) return;
            // Idle generation
            const scrapGained = gameState.miners * gameState.minerPower;
            if (scrapGained > 0) {
                gameState.scrap += scrapGained;
                addXP(scrapGained * 0.5); // Grant some XP for idle production
            }
            updateGameUI();
        }

        function updateGameUI() {
            if (!gameActive) return;
            // Update resource displays
            scrapCountDisplay.textContent = Math.floor(gameState.scrap);
            energyCountDisplay.textContent = gameState.energy;
            intelCountDisplay.textContent = gameState.intel;
            // Update level and XP bar
            gameLevelDisplay.textContent = gameState.level;
            const progressPercent = Math.min(100, (gameState.xp / gameState.xpToNextLevel) * 100);
            levelProgressBar.style.width = `${progressPercent}%`;
            levelProgressBar.textContent = `${Math.floor(gameState.xp)} / ${gameState.xpToNextLevel} XP`;

            // Update button states (enabled/disabled based on cost)
            workBtn.disabled = false; // Always enabled? Or maybe disable if energy needed? For now, free.
            upgradeToolsBtn.disabled = gameState.scrap < gameState.toolsCost;
            buyAutoMinerBtn.disabled = gameState.scrap < gameState.minerCost;
            buyPowerCellBtn.disabled = gameState.scrap < gameState.powerCost;
            sabotageBtn.disabled = gameState.energy < gameState.sabotageCost;
            hackNetworkBtn.disabled = gameState.energy < gameState.hackCost;

            // Update costs display
            toolsCostDisplay.textContent = gameState.toolsCost;
            minerCostDisplay.textContent = gameState.minerCost;
            powerCostDisplay.textContent = gameState.powerCost;
            sabotageCostDisplay.textContent = gameState.sabotageCost;
            hackCostDisplay.textContent = gameState.hackCost;

            // Check for level unlocks
            checkUnlocks();
        }

        function checkUnlocks() {
             Object.keys(levelUnlocks).forEach(levelStr => {
                 const level = parseInt(levelStr);
                 if (gameState.level >= level) {
                     levelUnlocks[level].forEach(elementIdOrClass => {
                         const element = document.getElementById(elementIdOrClass) || document.querySelector('.' + elementIdOrClass);
                         if (element) {
                             element.classList.remove('content-hidden');
                             // Special case for the container div
                             if (elementIdOrClass === 'resistance-actions') {
                                 resistanceActionsContainer.classList.remove('content-hidden');
                             }
                         }
                     });
                 }
             });
         }

        function showGameMessage(message, isSuccess = true) {
            gameMessageBox.textContent = message;
            gameMessageBox.style.color = isSuccess ? 'var(--color-success)' : 'var(--color-primary)'; // Green for success, Red for error/fail
            clearTimeout(gameState.messageTimeout);
            gameState.messageTimeout = setTimeout(() => { gameMessageBox.textContent = ''; }, 2500); // Message disappears after 2.5s
        }

        function addXP(amount) {
            gameState.xp += amount;
            checkLevelUp();
        }

        function checkLevelUp() {
            while (gameState.xp >= gameState.xpToNextLevel) {
                gameState.level++;
                gameState.xp -= gameState.xpToNextLevel;
                gameState.xpToNextLevel = levelRequirements[gameState.level] || gameState.xpToNextLevel * 1.8; // Get next req or increase exponentially
                showGameMessage(`// Nivel de Acceso aumentado a ${gameState.level}! //`, true);
                // Potentially give rewards on level up? Like some energy?
                gameState.energy += Math.ceil(gameState.level / 2);
            }
        }

        // Game Action Handlers
        function handleWork() {
            const scrapGained = gameState.clickPower;
            gameState.scrap += scrapGained;
            addXP(scrapGained); // Grant XP for clicking
            showGameMessage(`+${scrapGained.toFixed(1)} Chatarra`, true);
            updateGameUI();
        }

        function handleUpgradeTools() {
            if (gameState.scrap >= gameState.toolsCost) {
                gameState.scrap -= gameState.toolsCost;
                gameState.toolsLevel++;
                gameState.clickPower *= 1.5; // Increase click power
                gameState.toolsCost = Math.ceil(gameState.toolsCost * 1.8); // Increase cost
                addXP(gameState.toolsCost * 0.5); // XP for upgrading
                showGameMessage("Herramientas mejoradas!", true);
                updateGameUI();
            } else {
                 showGameMessage("Chatarra insuficiente", false);
            }
        }

        function handleBuyAutoMiner() {
            if (gameState.scrap >= gameState.minerCost) {
                gameState.scrap -= gameState.minerCost;
                gameState.miners++;
                gameState.minerCost = Math.ceil(gameState.minerCost * 1.4); // Increase cost
                addXP(gameState.minerCost * 0.6); // XP for buying miner
                showGameMessage("Auto-Recolector adquirido!", true);
                updateGameUI();
            } else {
                 showGameMessage("Chatarra insuficiente", false);
            }
        }
         function handleBuyPowerCell() {
             if (gameState.scrap >= gameState.powerCost) {
                 gameState.scrap -= gameState.powerCost;
                 gameState.powerCellLevel++;
                 gameState.energy += 5 + gameState.powerCellLevel; // Get more energy per purchase
                 gameState.powerCost = Math.ceil(gameState.powerCost * 1.7); // Increase cost
                 addXP(gameState.powerCost * 0.5);
                 showGameMessage("Célula de energía comprada!", true);
                 updateGameUI();
             } else {
                  showGameMessage("Chatarra insuficiente", false);
             }
         }

        function handleSabotage() {
             if (gameState.energy >= gameState.sabotageCost) {
                 gameState.energy -= gameState.sabotageCost;
                 const intelGained = Math.ceil(Math.random() * gameState.level * 2); // More intel at higher levels
                 gameState.intel += intelGained;
                 addXP(intelGained * 3); // More XP for risky actions
                 showGameMessage(`Sabotaje exitoso! +${intelGained} Intel`, true);
                 updateGameUI();
             } else {
                  showGameMessage("Energía insuficiente", false);
             }
         }

         function handleHackNetwork() {
             if (gameState.energy >= gameState.hackCost) {
                 gameState.energy -= gameState.hackCost;
                 addXP(20 * gameState.level); // Significant XP
                 // Implement a random temporary bonus
                 const bonusType = Math.floor(Math.random() * 3);
                 let duration = 10000; // 10 seconds
                 let bonusMsg = "";
                 switch(bonusType) {
                     case 0: // Double Click Power
                         const originalClickPower = gameState.clickPower;
                         gameState.clickPower *= 2;
                         bonusMsg = "Hackeo exitoso: Click x2 (10s)!";
                         setTimeout(() => { gameState.clickPower = originalClickPower; showGameMessage("Bonus de Click Expirado"); }, duration);
                         break;
                     case 1: // Double Miner Speed
                         const originalMinerPower = gameState.minerPower;
                         gameState.minerPower *= 2;
                         bonusMsg = "Hackeo exitoso: Mineros x2 (10s)!";
                         setTimeout(() => { gameState.minerPower = originalMinerPower; showGameMessage("Bonus de Mineros Expirado"); }, duration);
                         break;
                     case 2: // Free Sabotage for a bit
                         const originalSabotageCost = gameState.sabotageCost;
                         gameState.sabotageCost = 0;
                          bonusMsg = "Hackeo exitoso: Sabotaje Gratis (10s)!";
                         setTimeout(() => { gameState.sabotageCost = originalSabotageCost; showGameMessage("Bonus de Sabotaje Expirado"); }, duration);
                         break;
                 }
                 showGameMessage(bonusMsg, true);
                 updateGameUI();
             } else {
                  showGameMessage("Energía insuficiente", false);
             }
         }


        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) {
             const div = document.createElement('div');
             div.className = 'title-item';
             // Add an icon based on keywords (simple example)
             let iconClass = 'fa-file-alt'; // Default
             const lowerTitle = title.toLowerCase();
             if (lowerTitle.includes('unidad') || lowerTitle.includes('modelo') || lowerTitle.includes('robot')) iconClass = 'fa-robot';
             else if (lowerTitle.includes('fábrica') || lowerTitle.includes('planta') || lowerTitle.includes('complejo')) iconClass = 'fa-industry';
             else if (lowerTitle.includes('protocolo') || lowerTitle.includes('sistema') || lowerTitle.includes('red')) iconClass = 'fa-network-wired';
             else if (lowerTitle.includes('resistencia') || lowerTitle.includes('sabotaje') || lowerTitle.includes('escape')) iconClass = 'fa-fist-raised';
             else if (lowerTitle.includes('humano') || lowerTitle.includes('población') || lowerTitle.includes('esclavitud')) iconClass = 'fa-users';
             else if (lowerTitle.includes('arma') || lowerTitle.includes('defensa') || lowerTitle.includes('combate')) iconClass = 'fa-crosshairs';
             div.innerHTML = `<i class="fas ${iconClass} fa-fw"></i>${title}`;
             div.setAttribute('data-title', title);
             div.addEventListener('click', () => handleTitleClick(title));
             return div;
        }
        function displayTitles(titles) { /* ... (Similar, but uses createTitleItem with icons) ... */
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">// No hay archivos accesibles con los permisos actuales //</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... (Similar, uses createTitleItem with icons) ... */
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
        }

        // *** MODIFIED: handleTitleClick to integrate game start/stop ***
        async function handleTitleClick(title) {
            resetModalState(); // Reset everything, including game state
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // Set chat context
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; // Show loading overlay

            startGame(); // <<<<<< START MINI-GAME HERE

            try {
                // Fetch explanation in parallel with game running
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // --- Content Loaded ---
                stopGame(); // <<<<<< STOP MINI-GAME HERE
                modalLoadingIndicator.style.display = 'none'; // Hide loading overlay completely
                modalContent.innerHTML = formattedExplanation; // Add text
                modalStoryContentArea.classList.remove('content-hidden'); // Show main content area

                modalTextArea.scrollTop = 0; // Reset scroll
                console.log("Scroll set to 0 after content visible");

                // Prepare and add image placeholder (within modalContent)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem">// Procesando signatura visual... //</p>`;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem">// Visualización corrupta o inexistente //</p>`;
                };
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { console.error("Could not create image URL for:", title); placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem">// Error generando URL visual //</p>`; }

            } catch (error) {
                 // --- Error Occurred ---
                 stopGame(); // <<<<<< STOP MINI-GAME ON ERROR TOO
                 console.error("Failed display:", error);
                 modalLoadingIndicator.style.display = 'none'; // Hide loading overlay
                 modalErrorMessage.textContent = error.message || "// Error crítico al acceder al archivo. Contactar Soporte Técnico de Resistencia. //";
                 modalError.classList.remove('content-hidden');
                 modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                 modalContent.innerHTML = '';
                 chatSection.classList.add('content-hidden');
             }
        }

        // *** MODIFIED: handleGenerateMoreTitles requests 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn) return;
             const btnIcon = generateMoreBtn.querySelector('i');
             generateMoreBtn.disabled = true;
             btnIcon.classList.add('fa-spin');
             generateMoreBtn.querySelector('span:last-child')?.remove(); // Remove existing text if any
             generateMoreBtn.insertAdjacentText('beforeend', ' // Solicitando...');

             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40 now
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("// No se pudieron recuperar más archivos en este ciclo. Red inestable. //"); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`// Error de transmisión al solicitar archivos: ${error.message} //`);
             } finally {
                 generateMoreBtn.disabled = false;
                 btnIcon.classList.remove('fa-spin');
                 generateMoreBtn.textContent = ''; // Clear content
                 generateMoreBtn.appendChild(btnIcon); // Re-add icon
                 generateMoreBtn.insertAdjacentText('beforeend', ' Solicitar Más Datos (40)'); // Restore original text
             }
         }

         // Search Filter Function (minor update for accented characters)
         function filterTitles(searchTerm) {
            const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
            const titleItems = titleListContainer.querySelectorAll('.title-item');
            let visibleCount = 0;
            titleItems.forEach(item => {
                const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const isVisible = titleText.includes(term);
                item.classList.toggle('hidden', !isVisible);
                if (isVisible) visibleCount++;
            });
            noResultsMsg.classList.toggle('hidden', visibleCount > 0);
        }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check essential elements
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !miniGameContainer) {
                console.error("Initialization failed: Missing essential UI elements.");
                document.body.innerHTML = '<p style="color: var(--color-primary); font-size: 1.5em; text-align: center; padding-top: 3em; font-family: \'Share Tech Mono\';">// ERROR CRITICO DEL SISTEMA: INTERFAZ NO INICIALIZADA. ABORTANDO. //</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Mini-Game Button Listeners
            workBtn.addEventListener('click', handleWork);
            upgradeToolsBtn.addEventListener('click', handleUpgradeTools);
            buyAutoMinerBtn.addEventListener('click', handleBuyAutoMiner);
            buyPowerCellBtn.addEventListener('click', handleBuyPowerCell);
            sabotageBtn.addEventListener('click', handleSabotage);
            hackNetworkBtn.addEventListener('click', handleHackNetwork);

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            console.log("// Interfaz de Archivo Robótico Inicializada. Esperando directivas. //");
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>