<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laberintos de la Obsesión - Cuentos Interactivos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes con aire oscuro/serio -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Cuentos de Obsesión --- */
        :root {
            --color-primary: #8b0000; /* Rojo Oscuro Sangre Seca */
            --color-secondary: #4b0082; /* Índigo/Morado Profundo */
            --color-tertiary: #556b2f; /* Verde Oliva Oscuro (toque enfermizo) */
            --color-background: #1a1a1a; /* Gris Casi Negro */
            --color-text: #cccccc; /* Gris Muy Claro */
            --color-text-muted: #888888; /* Gris Medio */
            --color-modal-bg: #2b2b2b; /* Gris Oscuro */
            --color-border: #444444; /* Borde Gris Medio-Oscuro */
            --color-error-bg: #3b1f1f; /* Fondo error rojo muy oscuro */
            --color-error-text: #f5caca; /* Texto error claro */
            --color-error-border: #a94442; /* Borde error rojo apagado */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.35);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -4px rgba(0, 0, 0, 0.45);
            --border-radius: 4px; /* Bordes ligeramente suavizados */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Cormorant Garamond', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); text-shadow: 1px 1px 3px rgba(139, 0, 0, 0.5); }
        h1.page-title { color: var(--color-text); font-weight: 600; border-bottom: 1px solid var(--color-primary); display: inline-block; padding-bottom: 0.3rem; }
        h2.section-title { color: var(--color-text-muted); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6rem; display: inline-block; font-weight: 600; }
        #modal-title { color: var(--color-primary); font-weight: 700; font-size: 2rem; }
        .navbar { background-color: rgba(26, 26, 26, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(43, 43, 43, 0.8); color: var(--color-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.4); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); border-left: 4px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; }
        .title-item:hover { transform: translateX(5px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); border-left-color: var(--color-primary); color: #fff; background-color: #333; }
        .title-item i { margin-right: 0.7rem; color: var(--color-text-muted); transition: color 0.3s ease; }
        .title-item:hover i { color: var(--color-primary); }

        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: var(--color-text); padding: 0.8rem 1.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-family: 'Cormorant Garamond', serif; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        #generate-more-btn:hover:not(:disabled) { background-color: #a52a2a; /* Rojo más claro */ border-color: var(--color-secondary); box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-text); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.95); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 1000px; /* Un poco más ancho para texto */
            width: 95%;
            max-height: 90vh;
            min-height: 450px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #fff; transform: rotate(90deg); }
        #modal-title { text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.2; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(68, 68, 68, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(68, 68, 68, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-size: 1.05rem; /* Texto un poco más grande */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cormorant Garamond', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 600; letter-spacing: 0.3px;}
        #modal-content h1 { font-size: 1.6em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 3rem auto 1.5rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: 0 0 20px rgba(0, 0, 0, 0.6); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; filter: saturate(0.8) contrast(1.1); }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 25px rgba(139, 0, 0, 0.4); filter: saturate(1) contrast(1.1); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); opacity: 0.7; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(68, 68, 68, 0.7); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1.2s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; opacity: 0.5; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(26, 26, 26, 0.7); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(68, 68, 68, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(68, 68, 68, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; font-size: 0.95rem; }
        .user-message { background-color: var(--color-tertiary); color: #f0f0f0; margin-left: auto; text-align: right; box-shadow: var(--shadow-sm); }
        .ai-message { background-color: #3a3a3a; color: var(--color-text); margin-right: auto; text-align: left; box-shadow: var(--shadow-sm); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #333; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 2px rgba(75, 0, 130, 0.3); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-secondary); color: var(--color-text); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #6a0dad; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-style: italic;}
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 26, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 7px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.3s linear infinite; margin: 0 auto 1.8rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text-muted); font-size: 1.4rem; font-family: 'Cormorant Garamond'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); box-shadow: var(--shadow-lg); filter: saturate(0.9) contrast(1.05); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: #fff; transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-ghost mr-3 opacity-80"></i> <!-- Icono Fantasma/Espíritu -->
                     Laberintos de la Obsesión
                 </h1>
             </div>
             <span class="text-sm text-gray-500 font-sans tracking-wide">» Cuentos Interactivos «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Donde la Razón se Desvanece</h1>
             <p class="text-xl text-gray-400 mb-8 max-w-3xl mx-auto font-light">Explora relatos de personajes consumidos por sus fijaciones. Cada historia, un descenso a la espiral de la compulsión y la autodestrucción.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar una obsesión, un título...">
             <i class="fas fa-search fa-search"></i> <!-- Icono Lupa -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-dead text-red-800 mr-2"></i> <!-- Icono Libro Muerto/Oscuro -->
                 Índice de Fijaciones
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los archivos de la locura...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún eco de esa obsesión encontrado... aún «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Invocar Nuevos Relatos (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Tejiendo la Trama...</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image and placeholder added via JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Escuchando los susurros...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este relato...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-comment-dots"></i> <!-- Icono comentario -->
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Relato">
      </div>

      <!-- Footer -->
      <footer class="bg-black text-gray-600 py-6 mt-12 border-t border-gray-800 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Relatos generados por IA, explorando las sombras de la psique humana.</p>
              <p class="mt-1">Contenido ficticio con fines narrativos y de reflexión.</p>
              <p class="mt-2">© MMXXIV Archivos de la Obsesión</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Obsesiones Amorosas / Románticas (Torcidas)
            "El Coleccionista de Cartas No Enviadas", "La Sombra en el Espejo de Ella", "El Perfume que Nunca Olvidó", "Esperando su Regreso en el Muelle Podrido", "El Jardín Secreto para un Amor Muerto", "La Melodía que Solo Él Podía Oír", "Amar hasta la Última Fotografía Quemada", "El Guardián del Mechón de Pelo", "Obsesión bajo la Luna Pálida", "Construir un Mundo para Quien No Existe", "El Eco de su Nombre en las Paredes Vacías", "Vigilarla Dormir desde el Árbol Torcido", "El Maniquí con sus Ojos", "Las Flores que Florecen con Sangre", "Repetir su Última Conversación Eternamente", "El Último Baile con un Fantasma", "La Promesa Rota Grabada en la Piel", "Celos que Consumen la Realidad", "El Libro de Poemas Manchado de Lágrimas Negras", "La Habitación Intacta",
            // Obsesiones con Objetos / Coleccionismo
            "El Hombre que Contaba Granos de Arena", "La Colección de Llaves que No Abren Nada", "El Último Sello de la Serie Incompleta", "Pulir la Misma Moneda Cada Noche", "Los Ojos de las Muñecas de Porcelana", "Acumular Silencios en Frascos de Cristal", "El Reloj Detenido a la Hora Exacta", "Obsesión por la Simetría Perfecta del Polvo", "El Mapa con un Destino Inexistente", "Guardar Fragmentos de Espejos Rotos", "El Coleccionista de Sonrisas Perdidas (Fotografías)", "La Caja de Música que Susurra Secretos", "Ordenar Libros por el Color del Dolor", "El Brillo del Metal Robado", "La Perfección de la Caja Vacía", "Acumular Mentiras Bien Dobladas", "El Aroma de los Libros Olvidados", "La Textura del Papel Quemado", "Guardar las Uñas Recortadas", "El Sonido de las Canicas al Chocar",
            // Obsesiones con Ideas / Conceptos
            "Descifrar el Patrón en las Grietas del Techo", "La Búsqueda del Color que Falta", "Encontrar la Palabra Perdida", "La Ecuación Imposible en la Pared", "Perseguir una Teoría Conspirativa hasta el Fin", "La Obsesión por la Verdad Absoluta y Vacía", "Entender el Silencio entre las Notas", "El Significado Oculto de los Números Primos", "Reconstruir un Recuerdo Fragmentado", "La Idea Fija de Volar Sin Alas", "El Laberinto de un Pensamiento Circular", "La Pureza Inalcanzable", "Traducir el Lenguaje de los Insectos", "El Orden Secreto del Caos", "La Inmortalidad a Través de la Repetición", "El Concepto del Vacío Perfecto", "La Búsqueda del Olvido Total", "Entender la Mirada de un Extraño", "La Obsesión por la Propia Muerte", "El Último Teorema del Corazón Roto",
            // Obsesiones con Lugares / Entornos
            "El Hombre Atrapado en la Casa de su Infancia", "Regresar Siempre al Cruce de Caminos Maldito", "La Habitación Cerrada con Llave Desde Adentro", "Explorar el Bosque que Cambia de Forma", "El Mapa Mental de una Ciudad Olvidada", "Obsesión por la Luz del Faro Apagado", "Vivir en las Ruinas de un Teatro", "El Reflejo Invertido en el Lago Negro", "El Último Habitante del Pueblo Fantasma", "Perdido en los Pasillos del Hospital Abandonado", "El Jardín donde Nada Crece Igual", "La Sombra Constante de la Montaña", "Atrapado en un Bucle Temporal en el Metro", "El Sonido del Mar en una Habitación Sin Ventanas", "La Casa Construida sobre un Cementerio Indio", "Buscar la Puerta Oculta en la Biblioteca", "El Atractivo del Abismo Urbano", "La Fascinación por el Lugar del Accidente", "Vigilar la Ciudad desde la Gárgola", "El Camino que Siempre Lleva al Mismo Punto",
            // Obsesiones con el Cuerpo / Perfección Física
            "Contar Cada Lunar Bajo Luz Artificial", "La Cicatriz que No Deja de Picar", "Borrar las Huellas Dactilares", "El Reflejo que No Coincide", "La Perfección Anatómica en Mármol Frío", "Esculpir el Propio Cuerpo con Dolor", "La Obsesión por la Piel Inmaculada", "Oír el Latido del Corazón Ajeno", "El Olor de la Propia Sangre", "La Danza Frente al Espejo Fragmentado", "Medir la Simetría Facial con un Compás Oxidado", "El Cabello que Crece Demasiado Rápido", "La Necesidad de Sentir los Huesos", "El Silencio de los Órganos Internos", "La Textura de la Piel Artificial", "Coleccionar Imperfecciones Ajenas", "El Peso Exacto del Alma", "La Obsesión por las Manos Perfectas", "Ver a Través de la Propia Piel", "El Sonido de los Dientes al Rechinar",
            // Obsesiones con la Venganza / Rencor
            "El Plan Trazado Durante Décadas", "La Lista de Nombres Tachados con Sangre", "Esperar el Momento Justo en las Sombras", "El Veneno Lento y Paciente", "Alimentar el Odio como a una Mascota", "La Venganza Servida en un Plato Frío y Vacío", "Coleccionar Agravios en un Diario Negro", "El Eco de la Traición", "La Justicia Torcida en Manos Propias", "El Regalo Envenenado", "Acechar la Felicidad Ajena", "Destruir Ladrillo a Ladrillo su Legado", "La Sonrisa Falsa Antes del Golpe Final", "El Rencor Heredado", "Convertir el Amor en Cenizas Amargas", "El Susurro Constante de la Venganza", "La Paciencia del Depredador", "El Nudo en la Garganta que Pide Sangre", "La Obsesión por Verle Caer", "El Último Acto de un Corazón Roto y Vengativo",
            // Obsesiones Sensoriales / Perceptivas
            "El Sonido que Solo Yo Escucho", "La Mancha en la Visión Periférica", "El Olor a Tierra Mojada Antes de la Tragedia", "La Textura Áspera Bajo las Uñas", "El Sabor Metálico Constante", "La Luz que Parpadea al Ritmo del Pulso", "El Silencio Ensordecedor", "El Tacto Frío del Miedo", "La Distorsión Visual en los Espejos", "El Zumbido Perpetuo en los Oídos", "El Color Rojo Sangre en Todo", "La Sensación de Ser Observado por las Paredes", "El Olor Dulzón de la Decadencia", "La Música Inaudible que Dirige los Actos", "La Aspereza de una Voz en la Memoria", "El Frío que Emana de un Objeto", "La Visión de Hilos Invisibles Conectando Todo", "El Sabor a Ceniza en la Boca", "La Sensación de Caída Infinita", "El Eco Fantasma de Pasos",
            // Obsesiones Abstractas / Existenciales
            "La Obsesión por el Orden Imposible", "Contar los Segundos Hacia Atrás", "La Necesidad de Dejar una Marca Indeleble", "El Miedo a Ser Olvidado", "La Búsqueda del Propio Doble", "Entender el Propósito del Sufrimiento", "La Fascinación por la Nada", "El Deseo de Desaparecer Sin Dejar Rastro", "La Repetición como Forma de Control", "El Laberinto del Libre Albedrío", "La Obsesión por la Autenticidad", "El Miedo a la Propia Sombra", "La Necesidad Compulsiva de Confesar", "El Juego de Azar con el Destino", "La Persecución de un Sueño Recurrente", "El Significado Oculto de la Coincidencia", "La Obsesión por Desentrañar el Pasado", "El Vértigo Ante el Futuro Incierto", "La Lucha Contra la Entropía Personal", "El Último Secreto Antes del Final",
            // ... (Continuar hasta ~400 títulos variados)
        ];
        const obsessionThemes = [
            "obsesión amorosa tóxica", "coleccionismo enfermizo", "venganza meticulosa", "búsqueda de perfección destructiva", "fijación con un lugar maldito", "persecución de una idea abstracta", "obsesión sensorial inexplicable", "lucha contra el propio cuerpo", "rencorguardado durante años", "atracción por lo macabro", "necesidad compulsiva de orden", "miedo existencial paralizante", "fascinación por objetos cotidianos", "repetición de patrones autodestructivos", "aislamiento autoimpuesto", "celos patológicos", "recuerdos que no se van", "la delgada línea entre genio y locura", "secretos inconfesables", "rituales compulsivos sin sentido"
        ];
        const textApiConfig = { // Para generar el cuento
            model: "mistral",
            systemPrompt: "Eres un escritor especializado en ficción oscura y psicológica. Tu tarea es escribir un cuento corto (aproximadamente 1200-1300 palabras) basado en el título proporcionado. El relato debe centrarse profundamente en la obsesión del protagonista, mostrando cómo esta consume su vida, distorsiona su percepción de la realidad y lo conduce por un camino irracional y, a menudo, autodestructivo. Explora la atmósfera opresiva, la lucha interna (o la falta de ella), la naturaleza cíclica de la obsesión y las consecuencias inevitables. Usa un lenguaje evocador, introspectivo y que mantenga la tensión psicológica. El título es:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúas como un analista literario o un confidente oscuro. El usuario acaba de leer un cuento sobre una obsesión específica (indicada por el título). Responde sus preguntas sobre ESE CUENTO en particular: motivaciones del personaje, simbolismo, posibles interpretaciones, temas subyacentes. Sé perspicaz, quizás un poco enigmático, pero siempre enfocado en el relato discutido.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // *** PROMPT PARA GENERAR 40 TÍTULOS ***
            systemPrompt: "Actúa como un generador de ideas conciso para cuentos de terror psicológico y obsesión. Genera exactamente 40 títulos evocadores para relatos centrados en personajes atrapados en ciclos de obsesión, autodestrucción e irracionalidad. Varía los tipos de obsesión (amor, objetos, ideas, lugares, venganza, cuerpo, etc.). Devuelve *solo* la lista de títulos, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentar un poco el timeout para generar más títulos
        };

        // ========== DOM ELEMENTS ========== (Sin cambios de IDs, solo referencias)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Renombrado para claridad

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            // *** Usa el system prompt dinámico para el chat ***
            const systemPromptToUse = isChat && currentStoryTitle
                ? `Actúas como un analista literario o confidente oscuro. El usuario acaba de leer el cuento titulado '${currentStoryTitle}'. Responde sus preguntas sobre ESE CUENTO: motivaciones, simbolismo, etc. Sé perspicaz y enfocado en el relato.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            // Seed solo para generación de texto principal y títulos, no chat
            if (config.seed && !isChat) params.append('seed', config.seed);

            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}, Title: ${isChat ? currentStoryTitle : 'N/A'}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            // Usa el timeout específico de la config (puede ser mayor para generar títulos)
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, o la petición fue rechazada. Por favor, intenta en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía o incompleta. Intenta de nuevo.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s) o fue interrumpida. Revisa tu conexión o intenta más tarde.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar los servidores de IA.");
            }
        }
        async function fetchStoryText(storyTitle) {
            return fetchTextFromApi(storyTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentStoryTitle) throw new Error("Error interno: No se ha establecido el contexto del relato para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        // *** MODIFICADO PARA GENERAR 40 TÍTULOS ***
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(obsessionThemes) || "obsesiones oscuras variadas";
            const specificPrompt = `Genera 40 títulos de cuentos sobre ${randomTheme}`;
            // Usar config con timeout más largo si es necesario
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                 .then(text => {
                     const titles = text.split('\n')
                                        .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                        .filter(line => line.length > 5 && line.length < 150);
                     // Ajustar el mínimo esperado
                     if (titles.length < 20) { // Ser más permisivo, 40 es mucho pedir a veces
                        console.warn(`API generó solo ${titles.length} títulos, se esperaban ~40.`);
                        if (titles.length === 0) throw new Error("La IA no generó títulos de relatos.");
                     }
                     console.log(`Generados ${titles.length} nuevos títulos.`);
                     return titles.slice(0, 40); // Asegura no más de 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "dark obsession concept art";
            // Prompt ENFOCADO en atmósfera, simbolismo, NO literal.
            const enhancedPrompt = `Dark psychological concept art, symbolic representation of the obsession: '${safePromptText}'. Focus on atmosphere, mood, isolation, repetition, or distorted perception. Use a somber color palette (deep reds, blues, grays, blacks). Avoid literal gore, focus on unsettling imagery. Style: noir, gothic, surreal, atmospheric.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "bright colors, cheerful, happy, text, labels, words, letters, diagram, chart, realistic photo, clear face, simple illustration, cartoon, multiple panels, watermark";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (Sin cambios)
        function formatExplanationText(rawText) { /* ... (Código idéntico al anterior) */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' '); // Reemplazar saltos internos por espacio
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Sin cambios estructurales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null; // Reset chat context
             hideFullscreenImage(); // Asegurar que la imagen ampliada se cierre
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (Código idéntico al anterior) */
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() { /* ... (Código idéntico al anterior) */
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (Sin cambios estructurales)
        function addChatMessage(message, sender) { /* ... (Código idéntico al anterior) */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... (Código idéntico al anterior) */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... (Código idéntico al anterior, usa fetchChatResponse) */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        // Añadir icono a los títulos
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // Añadir un icono genérico o basado en alguna palabra clave (simple)
            let iconClass = 'fa-question-circle'; // Default
            if (title.toLowerCase().includes('amor') || title.toLowerCase().includes('corazón')) iconClass = 'fa-heart-crack';
            else if (title.toLowerCase().includes('colección') || title.toLowerCase().includes('objeto')) iconClass = 'fa-box-archive';
            else if (title.toLowerCase().includes('venganza') || title.toLowerCase().includes('odio')) iconClass = 'fa-skull-crossbones';
            else if (title.toLowerCase().includes('lugar') || title.toLowerCase().includes('casa') || title.toLowerCase().includes('ciudad')) iconClass = 'fa-map-pin';
            else if (title.toLowerCase().includes('idea') || title.toLowerCase().includes('pensamiento')) iconClass = 'fa-lightbulb';
            else if (title.toLowerCase().includes('cuerpo') || title.toLowerCase().includes('piel')) iconClass = 'fa-eye';
             else if (title.toLowerCase().includes('sonido') || title.toLowerCase().includes('música')) iconClass = 'fa-volume-up';

            div.innerHTML = `<i class="fas ${iconClass} fa-fw"></i> ${title}`; // Usar innerHTML para el icono
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar quizás por longitud o dejar aleatorio para más misterio? Alfabético es predecible.
             // const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             const shuffledTitles = shuffleArray([...titles]); // Mostrar en orden aleatorio
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» Los archivos están vacíos... por ahora «</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             const uniqueNewTitles = newTitles.filter(title => !existingTitles.has(title));
             // Añadir los nuevos títulos (quizás al principio o final?)
             uniqueNewTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); // Añadir al final
             filterTitles(searchInput.value); // Reaplicar filtro
             console.log(`Añadidos ${uniqueNewTitles.length} nuevos títulos únicos.`);
         }

        // *** MODIFIED: handleTitleClick - usa fetchStoryText, renombra contexto ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // *** USA fetchStoryText ***
                const rawStoryText = await fetchStoryText(title);
                const formattedStory = formatExplanationText(rawStoryText); // Misma función de formato sirve

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedStory;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset scroll
                console.log("Scroll set to 0 after content visible");

                // Placeholder y carga de imagen (sin cambios lógicos)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Visualizando la esencia...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representación artística de: ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">La visualización falló.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title); // Usa el prompt adaptado
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al tejer el relato."; // Mensaje temático
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden'); // Ocultar chat si falla el texto principal
            }
        }

        // *** MODIFICADO: handleGenerateMoreTitles - usa fetchGeneratedTitles (que pide 40) ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Invocando...';
             try {
                 // fetchGeneratedTitles ahora está configurado para pedir 40
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Los susurros no trajeron nuevos relatos esta vez."); } // Mensaje temático
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al invocar relatos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Asegurarse que el texto del botón refleje que pide 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Invocar Nuevos Relatos (40)';
             }
         }

        // Search Filter Function (sin cambios lógicos, usa normalize)
        function filterTitles(searchTerm) { /* ... (Código idéntico al anterior, con normalize) */
            const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
            const titleItems = titleListContainer.querySelectorAll('.title-item');
            let visibleCount = 0;
            titleItems.forEach(item => {
                const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const isVisible = titleText.includes(term);
                item.classList.toggle('hidden', !isVisible);
                if (isVisible) visibleCount++;
            });
            noResultsMsg.classList.toggle('hidden', visibleCount > 0);
        }

        // ========== INITIALIZATION ========== (Sin cambios estructurales)
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">++ ERROR CRÍTICO: Fallo al cargar la interfaz del Laberinto ++</p>';
                return;
             }
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Initial display
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
             // Asegurar que el texto inicial del botón sea correcto
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Invocar Nuevos Relatos (40)';
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>