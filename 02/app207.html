<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon Ball: ¿Qué Pasaría Si Goku...? - Líneas Temporales Alternativas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes inspiradas en Anime/Energía -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Dragon Ball "What If" --- */
        :root {
            --color-primary: #f97316; /* Naranja (Gi Goku) */
            --color-secondary: #3b82f6; /* Azul (Cielo, Energía) */
            --color-tertiary: #facc15; /* Amarillo/Dorado (Super Saiyan, Esferas) */
            --color-background: #f8fafc; /* Blanco Hueso / Gris muy claro */
            --color-text: #1f2937; /* Gris Oscuro */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco puro modal */
            --color-border: #e5e7eb; /* Borde gris claro */
            --color-error-bg: #fff1f2; /* Fondo error rosa claro */
            --color-error-text: #be123c; /* Texto error rojo oscuro */
            --color-error-border: #fecdd3; /* Borde error rosa */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --border-radius: 6px; /* Bordes redondeados suaves */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        /* Títulos principales con fuente Bangers */
        h1, h2, .logo, .section-title, #modal-title { font-family: 'Bangers', cursive; letter-spacing: 1.5px; font-weight: 400; /* Bangers es bold por defecto */ }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); text-shadow: 2px 2px 0px var(--color-secondary), 4px 4px 0px rgba(0,0,0,0.1); }
        h2.section-title { color: var(--color-secondary); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.5rem; display: inline-block; }
        #modal-title { color: var(--color-primary); text-shadow: 1px 1px 0px var(--color-secondary); }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Roboto'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 700; /* Texto del item más bold */ color: var(--color-secondary); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Roboto'; font-size: 0.95rem; position: relative; overflow: hidden; }
        .title-item::before { /* Efecto hover */ content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(249, 115, 22, 0.2), transparent); transition: left 0.4s ease; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); }
        .title-item:hover::before { left: 100%; }

        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-tertiary)); color: white; padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Bangers', cursive; font-size: 1.3rem; letter-spacing: 1px; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-tertiary), var(--color-primary)); box-shadow: var(--shadow-md); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-text-muted); color: var(--color-border); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; text-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 2px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Altura para acomodar chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 2.5rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.2; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 700; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto', sans-serif; /* Encabezados internos más estándar */ margin-top: 2em; margin-bottom: 1em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 700; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.4em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2rem auto 1rem auto; border: 2px solid var(--color-tertiary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 15px var(--color-tertiary); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 5px solid rgba(229, 231, 235, 0.8); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* Un poco más de altura para chat */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; /* Fondo chat ligeramente distinto */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 1rem; border-radius: 15px; /* Bordes redondeados tipo burbuja */ max-width: 85%; word-wrap: break-word; line-height: 1.5; box-shadow: var(--shadow-sm); }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; border-bottom-right-radius: 3px; }
        .ai-message { background-color: var(--color-secondary); color: white; margin-right: auto; text-align: left; border-bottom-left-radius: 3px; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: 20px; /* Input redondeado */ font-family: 'Roboto'; font-size: 0.95rem; box-shadow: var(--shadow-sm); }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-secondary); color: white; border: none; border-radius: 50%; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1rem; display: flex; align-items: center; justify-content: center; }
        #chat-send-btn:hover:not(:disabled) { background-color: #2563eb; transform: scale(1.1); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; transform: none; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 70px; height: 70px; border: 7px solid var(--color-border); border-top-color: var(--color-primary); border-right-color: var(--color-secondary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.8rem; font-family: 'Bangers'; letter-spacing: 1px; color: var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 700; font-family: 'Roboto'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-tertiary); box-shadow: 0 0 30px var(--color-tertiary); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: rgba(255,255,255,0.1); border: 1px solid var(--color-tertiary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-tertiary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); backdrop-filter: blur(3px); }
        #fullscreen-close-btn:hover { background-color: var(--color-tertiary); color: #000; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                  <img src="https://img.icons8.com/color/48/000000/dragon-ball.png" alt="DB Icon" class="inline-block h-10 w-10 mr-2"/> <!-- Icono Esfera 4 Estrellas -->
                 <h1 class="logo text-3xl sm:text-4xl" style="line-height: 1;">
                     DB: ¿Qué Pasaría Si Goku...?
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-bold tracking-wide">» Explora Líneas Temporales Alternativas «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-7xl mb-4">Universos Infinitos</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">El tejido del tiempo es frágil. Un pequeño cambio puede crear una realidad completamente nueva. Elige un punto de divergencia y observa cómo se desarrolla la historia.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar escenario (Ej: Goku Super Saiyan en Namek)...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-4xl sm:text-5xl mb-8 text-center mx-auto">
                 <i class="fas fa-stream text-orange-500 mr-2"></i> <!-- Icono flujo/líneas -->
                 Puntos de Divergencia
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-bold">Accediendo a los archivos del Kai Supremo del Tiempo...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-bold">» Esta línea temporal no existe en los archivos... todavía «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Más Posibilidades (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Observando Línea Temporal...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <h3 class="text-lg font-bold text-center mb-2 text-secondary font-roboto">Pregúntale al Kai del Tiempo (Sobre esta historia)</h3>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando los pergaminos...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="¿Qué más quieres saber de este universo?">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Escenario">
      </div>

      <!-- Footer -->
      <footer class="bg-blue-100 text-blue-800 py-6 mt-12 border-t border-blue-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias generadas por IA explorando escenarios hipotéticos del universo Dragon Ball con fines creativos y de entretenimiento.</p>
              <p class="mt-1">Basado en la obra de Akira Toriyama. Dragon Ball © BIRD STUDIO/SHUEISHA, TOEI ANIMATION.</p>
              <p class="mt-2">© 2025 Archivos del Tiempo Alternativo</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Dragon Ball Original
            "¿Qué pasaría si Goku nunca se golpeaba la cabeza al caer?",
            "¿Qué pasaría si Goku era encontrado por el Ejército de la Patrulla Roja?",
            "¿Qué pasaría si Bulma nunca buscaba las Esferas del Dragón?",
            "¿Qué pasaría si Goku mataba a Pilaf y sus secuaces?",
            "¿Qué pasaría si Goku entrenaba con el Maestro Karin antes del 21º Torneo?",
            "¿Qué pasaría si Krilin ganaba el 21º Torneo Mundial de Artes Marciales?",
            "¿Qué pasaría si Goku derrotaba a Tao Pai Pai sin subir la Torre Karin?",
            "¿Qué pasaría si Goku destruía el Cuartel General de la Patrulla Roja solo?",
            "¿Qué pasaría si el Maestro Roshi moría en la pelea contra Piccolo Daimaō?",
            "¿Qué pasaría si Tenshinhan se unía a Piccolo Daimaō?",
            "¿Qué pasaría si Goku perdía contra Piccolo Jr. en el 23º Torneo?",
            "¿Qué pasaría si Goku se casaba con Bulma?",
            "¿Qué pasaría si Goku aceptaba ser el sucesor de Kami-sama?",
            "¿Qué pasaría si el Abuelo Gohan sobrevivía?",
            "¿Qué pasaría si Lunch (rubia) se quedaba permanentemente?",
            "¿Qué pasaría si Yamcha superaba su miedo a las mujeres antes?",
            "¿Qué pasaría si Oolong pedía gobernar el mundo?",
            "¿Qué pasaría si Puar tuviera un papel más activo en combate?",
            "¿Qué pasaría si el Dr. Gero ya existía en Dragon Ball original?",
            "¿Qué pasaría si Goku aprendía el Mafuba de Roshi?",

            // Saiyan Saga (Z)
            "¿Qué pasaría si Raditz derrotaba a Goku y Piccolo?",
            "¿Qué pasaría si Goku se unía a Raditz?",
            "¿Qué pasaría si Gohan no intervenía contra Raditz?",
            "¿Qué pasaría si Piccolo mataba a Goku pero no a Raditz?",
            "¿Qué pasaría si los Guerreros Z no entrenaban para los Saiyans?",
            "¿Qué pasaría si Goku llegaba a la Tierra ANTES que Vegeta y Nappa?",
            "¿Qué pasaría si Nappa derrotaba a todos antes de la llegada de Goku?",
            "¿Qué pasaría si Goku usaba el Kaio-ken x5 contra Vegeta?",
            "¿Qué pasaría si Goku no le perdonaba la vida a Vegeta?",
            "¿Qué pasaría si Vegeta destruía la Tierra con su Galick Gun?",
            "¿Qué pasaría si Gohan se transformaba en Ōzaru contra Nappa?",
            "¿Qué pasaría si Piccolo sobrevivía al ataque de Nappa?",
            "¿Qué pasaría si Yajirobe no cortaba la cola de Vegeta?",
            "¿Qué pasaría si Krilin mataba a Vegeta con la Genkidama?",
            "¿Qué pasaría si Goku moría en la pelea contra Vegeta?",
            "¿Qué pasaría si Kami-sama se negaba a revivir a Goku?",
            "¿Qué pasaría si los Saibaman derrotaban a los Guerreros Z?",
            "¿Qué pasaría si Goku aprendía el Spirit Bomb de forma diferente?",
            "¿Qué pasaría si Vegeta y Nappa llegaban un año DESPUÉS?",
            "¿Qué pasaría si Goku mantenía su cola?",

            // Namek / Frieza Saga (Z)
            "¿Qué pasaría si Bulma, Gohan y Krilin iban a Namek solos sin saber de Vegeta/Frieza?",
            "¿Qué pasaría si Vegeta encontraba las Esferas de Namek antes que todos?",
            "¿Qué pasaría si Frieza destruía Namek inmediatamente al llegar?",
            "¿Qué pasaría si Goku llegaba a Namek mucho antes?",
            "¿Qué pasaría si Goku usaba el Kaio-ken x20 contra Ginyu?",
            "¿Qué pasaría si Ginyu se quedaba con el cuerpo de Goku permanentemente?",
            "¿Qué pasaría si Vegeta se convertía en Super Saiyan en Namek?",
            "¿Qué pasaría si Nail derrotaba a Frieza (1ra forma)?",
            "¿Qué pasaría si Dende no curaba a los Guerreros Z?",
            "¿Qué pasaría si Piccolo no se fusionaba con Nail?",
            "¿Qué pasaría si Krilin no moría a manos de Frieza?",
            "¿Qué pasaría si Goku no se transformaba en Super Saiyan contra Frieza?",
            "¿Qué pasaría si Goku mataba a Frieza en Namek con la Genkidama?",
            "¿Qué pasaría si Goku moría en la explosión de Namek?",
            "¿Qué pasaría si Vegeta mataba a Frieza?",
            "¿Qué pasaría si Porunga concedía la inmortalidad a Vegeta?",
            "¿Qué pasaría si Porunga concedía la inmortalidad a Frieza?",
            "¿Qué pasaría si Goku regresaba a la Tierra justo después de vencer a Frieza?",
            "¿Qué pasaría si las Fuerzas Especiales Ginyu derrotaban a todos?",
            "¿Qué pasaría si Goku nunca aprendía la Teletransportación en Yadrat?",

             // Android / Cell Saga (Z)
            "¿Qué pasaría si Trunks del Futuro nunca advertía a Goku?",
            "¿Qué pasaría si Goku moría por la enfermedad del corazón?",
            "¿Qué pasaría si los Guerreros Z derrotaban al Dr. Gero antes de activar a los androides?",
            "¿Qué pasaría si destruían el laboratorio de Gero CON Cell adentro?",
            "¿Qué pasaría si Vegeta derrotaba a Androide 18?",
            "¿Qué pasaría si Androide 17 y 18 eran buenos desde el principio?",
            "¿Qué pasaría si Piccolo derrotaba a Cell Imperfecto?",
            "¿Qué pasaría si Kami-sama no se fusionaba con Piccolo?",
            "¿Qué pasaría si Cell absorbía a Krilin en lugar de 18?",
            "¿Qué pasaría si Vegeta derrotaba a Cell Semi-Perfecto?",
            "¿Qué pasaría si Trunks derrotaba a Cell Perfecto?",
            "¿Qué pasaría si Goku salía de la Habitación del Tiempo dominando el SSJ2?",
            "¿Qué pasaría si Goku no le daba una Semilla del Ermitaño a Cell?",
            "¿Qué pasaría si Gohan no se enfadaba contra Cell?",
            "¿Qué pasaría si Goku sobrevivía al sacrificio contra Cell?",
            "¿Qué pasaría si Gohan mataba a Cell sin la ayuda de Goku/Vegeta?",
            "¿Qué pasaría si Cell ganaba los Cell Games y destruía la Tierra?",
            "¿Qué pasaría si Mr. Satan revelaba la verdad sobre Cell?",
            "¿Qué pasaría si Androide 16 sobrevivía?",
            "¿Qué pasaría si Cell absorbía a Androide 17 y Krilin?",

            // Buu Saga (Z)
            "¿Qué pasaría si Gohan mantenía su entrenamiento después de Cell?",
            "¿Qué pasaría si Goku regresaba a la vida por un día ANTES del torneo?",
            "¿Qué pasaría si Vegeta no se dejaba controlar por Babidi?",
            "¿Qué pasaría si Gohan derrotaba a Dabura fácilmente?",
            "¿Qué pasaría si el Kai Supremo evitaba el despertar de Buu?",
            "¿Qué pasaría si Goku usaba el SSJ3 contra Vegeta Majin?",
            "¿Qué pasaría si Vegeta Majin mataba a Goku?",
            "¿Qué pasaría si Buu Gordo destruía a Babidi antes?",
            "¿Qué pasaría si Goku derrotaba a Buu Gordo con el SSJ3?",
            "¿Qué pasaría si Gotenks (SSJ3) derrotaba a Super Buu?",
            "¿Qué pasaría si Gohan Místico derrotaba a Super Buu (Gotenks absorbido)?",
            "¿Qué pasaría si Goku y Vegeta no se separaban dentro de Buu?",
            "¿Qué pasaría si Vegito decidía quedarse fusionado?",
            "¿Qué pasaría si Vegito destruía a Buu sin entrar en él?",
            "¿Qué pasaría si Kid Buu destruía la Tierra antes de que Goku/Vegeta escaparan?",
            "¿Qué pasaría si Vegeta completaba la Genkidama sin la ayuda de Mr. Satan?",
            "¿Qué pasaría si Goku no podía reunir energía para la Genkidama final?",
            "¿Qué pasaría si Uub no aparecía en el torneo final?",
            "¿Qué pasaría si Buu Gordo nunca se separaba de su maldad?",
            "¿Qué pasaría si Gohan absorbía a Super Buu?",

            // Dragon Ball Super (Anime/Manga)
            "¿Qué pasaría si Goku alcanzaba el SSG por sí mismo?",
            "¿Qué pasaría si Beerus destruía la Tierra?",
            "¿Qué pasaría si Vegeta alcanzaba el SSG antes que Goku?",
            "¿Qué pasaría si Frieza entrenaba por 10 años en lugar de 4 meses?",
            "¿Qué pasaría si Goku o Vegeta mataban a Golden Frieza?",
            "¿Qué pasaría si Whis no retrocedía el tiempo contra Frieza?",
            "¿Qué pasaría si Goku ganaba el torneo contra el Universo 6?",
            "¿Qué pasaría si Frost era bueno de verdad?",
            "¿Qué pasaría si Hit usaba técnicas de asesinato contra Goku?",
            "¿Qué pasaría si Zamasu deseaba intercambiar cuerpos con Vegeta?",
            "¿Qué pasaría si Trunks del Futuro derrotaba a Goku Black/Zamasu solo?",
            "¿Qué pasaría si Vegito Blue derrotaba a Zamasu Fusionado?",
            "¿Qué pasaría si Zeno borraba el futuro de Trunks ANTES?",
            "¿Qué pasaría si Goku reclutaba a Cell para el Torneo del Poder?",
            "¿Qué pasaría si Gohan recuperaba su estado Místico ANTES del ToP?",
            "¿Qué pasaría si Universo 7 perdía el Torneo del Poder?",
            "¿Qué pasaría si Jiren eliminaba a Goku al principio del ToP?",
            "¿Qué pasaría si Goku dominaba el Ultra Instinto Señal contra Kefla?",
            "¿Qué pasaría si Goku y Frieza no trabajaban juntos contra Jiren?",
            "¿Qué pasaría si Androide 17 no ganaba el ToP?",
            "¿Qué pasaría si Broly (DBS) era encontrado por Vegeta niño en Vampa?",
            "¿Qué pasaría si Gogeta Blue mataba a Broly?",
            "¿Qué pasaría si Goku era capturado por la Patrulla Galáctica con Moro?",
            "¿Qué pasaría si Merus sobrevivía y seguía siendo un Patrullero?",
            "¿Qué pasaría si Vegeta derrotaba a Moro con el Espíritu Forzado?",
            "¿Qué pasaría si Goku no dominaba el Ultra Instinto contra Moro?",
            "¿Qué pasaría si Granolah deseaba ser el guerrero más fuerte DESPUÉS de Goku/Vegeta?",
            "¿Qué pasaría si Bardock derrotaba a Gas?",
            "¿Qué pasaría si Goku conocía a Monaito antes?",
            "¿Qué pasaría si Black Frieza aparecía durante el arco de Moro?",

            // Otros Escenarios / Personajes / Conceptos
            "¿Qué pasaría si Goku era mujer?",
            "¿Qué pasaría si Goku era el hermano de Vegeta?",
            "¿Qué pasaría si Goku aterrizaba en el planeta de los Yardratianos?",
            "¿Qué pasaría si Goku se volvía un Dios de la Destrucción?",
            "¿Qué pasaría si Goku aprendía la técnica Hakai?",
            "¿Qué pasaría si Goku se fusionaba (Potara) con Gohan?",
            "¿Qué pasaría si Goku se fusionaba (Danza) con Piccolo?",
            "¿Qué pasaría si Goku entrenaba seriamente con Whis desde el principio?",
            "¿Qué pasaría si Goku nunca conocía a Bulma?",
            "¿Qué pasaría si Goku se quedaba en el Otro Mundo después de Cell?",
            "¿Qué pasaría si Goku prefería usar armas?",
            "¿Qué pasaría si Goku era un genio táctico como Piccolo o Vegeta?",
            "¿Qué pasaría si Goku tenía más interés en la tecnología?",
            "¿Qué pasaría si Goku descubría el Super Saiyan 4 (canónicamente)?",
            "¿Qué pasaría si Goku alcanzaba el Ultra Instinto durante la saga de Cell?",
            "¿Qué pasaría si Goku se enfrentaba a Cooler (canónicamente)?",
            "¿Qué pasaría si Goku era el Legendario Super Saiyan en lugar de Broly?",
            "¿Qué pasaría si Goku tenía un gemelo malvado (no Turles)?",
            "¿Qué pasaría si Goku era criado por Babidi?",
            "¿Qué pasaría si Goku aprendía magia?",
             // ... (Continuar añadiendo hasta ~400 o más)
             // Ejemplo de cómo seguir:
             "¿Qué pasaría si Goku y Chichi nunca tenían a Goten?",
             "¿Qué pasaría si Goku entrenaba a Pan desde bebé?",
             "¿Qué pasaría si Goku se perdía en el Hiperespacio al volver de Namek?",
             "¿Qué pasaría si Goku era inmune a las enfermedades?",
             "¿Qué pasaría si Goku podía usar el Ultra Instinto a voluntad tras el ToP?",
             "¿Qué pasaría si Goku se enfrentaba a Bills en SSJ3?",
             "¿Qué pasaría si Goku convencía a Raditz de volverse bueno?",
             "¿Qué pasaría si Goku aprendía la Fusión Metamoru de niño?",
             "¿Qué pasaría si Goku usaba la Nube Voladora contra Frieza?",
             "¿Qué pasaría si Goku se transformaba en Ozaru Dorado?",
             "¿Qué pasaría si Goku era enviado a destruir la Tierra y lo hacía?",
             "¿Qué pasaría si Goku nacía con el poder de Broly?",
             "¿Qué pasaría si Goku era adoptado por la familia Briefs?",
             "¿Qué pasaría si Goku tenía acceso a la tecnología de Capsule Corp desde niño?",
             "¿Qué pasaría si Goku dominaba el Kaio-ken sin desgaste?",
             "¿Qué pasaría si Goku podía respirar en el espacio?",
             "¿Qué pasaría si Goku recordaba su misión Saiyan sin golpearse?",
             "¿Qué pasaría si Goku entrenaba con los Ángeles de otros universos?",
             "¿Qué pasaría si Goku absorbía las Esferas del Dragón (como en GT)?",
             "¿Qué pasaría si Goku se enfrentaba al Rey Cold junto a Trunks?",
             "¿Qué pasaría si Goku llegaba a la pelea de Gohan vs Dabura?",
             "¿Qué pasaría si Goku usaba el SSJ Blue Kaio-ken x100?",
             "¿Qué pasaría si Goku se fusionaba con Mr. Satan?",
             "¿Qué pasaría si Goku aprendía el Spirit Fission de Vegeta?",
             "¿Qué pasaría si Goku era el discípulo de Beerus en lugar de Vegeta?",
             "¿Qué pasaría si Goku se convertía en un viajero del tiempo?",
             "¿Qué pasaría si Goku y Vegeta intercambiaban personalidades?",
             "¿Qué pasaría si Goku nacía en el Universo 6?",
             "¿Qué pasaría si Goku era un Namekiano?",
             "¿Qué pasaría si Goku era un Androide creado por Gero?",
             "¿Qué pasaría si Goku tenía potencial ilimitado como Gohan?",
             "¿Qué pasaría si Goku aprendía todas las técnicas de los Guerreros Z?",
             "¿Qué pasaría si Goku se enfrentaba a Moro ANTES del ToP?",
             "¿Qué pasaría si Goku podía usar Magia de Destrucción?",
             "¿Qué pasaría si Goku se dedicaba a ser granjero después de Cell?",
             "¿Qué pasaría si Goku era el guardián de la Tierra en lugar de Kami?",
             "¿Qué pasaría si Goku era revivido con las Super Esferas del Dragón?",
             "¿Qué pasaría si Goku podía transformarse en SSJ Rage como Trunks?",
             "¿Qué pasaría si Goku se enfrentaba a Janemba (canónicamente)?",
             "¿Qué pasaría si Goku era el protagonista de Dr. Slump?",
              // Continuar hasta tener una lista muy completa...
        ];
        const dragonBallWhatIfThemes = [ // Temas para generar más títulos
            "Goku en Dragon Ball original", "Goku en la saga Saiyan", "Goku en la saga de Frieza", "Goku en la saga de Cell", "Goku en la saga de Buu", "Goku en Battle of Gods", "Goku en Resurrection F", "Goku en el torneo U6 vs U7", "Goku en la saga de Goku Black", "Goku en el Torneo del Poder", "Goku en la saga de Broly (DBS)", "Goku en la saga de Moro", "Goku en la saga de Granolah", "Goku con diferentes maestros", "Goku con diferentes transformaciones", "Goku fusionado con otros personajes", "Goku con diferente personalidad", "Goku en diferentes universos", "Goku con habilidades diferentes", "Goku tomando decisiones clave distintas", "Goku enfrentando villanos antes/después", "Goku si ciertos personajes sobrevivían/morían", "Goku criado por diferentes facciones", "Goku con relaciones familiares distintas"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un experto en cronologías alternativas del universo Dragon Ball, similar al Kai Supremo del Tiempo. Tu tarea es narrar una historia detallada y coherente explorando el escenario '¿Qué pasaría si...?' indicado. Describe los puntos de divergencia clave, cómo cambian los eventos principales, el desarrollo de los personajes afectados (especialmente Goku), y las consecuencias a corto y largo plazo en la línea temporal. Mantén el tono y la escala de poder consistentes con Dragon Ball. La historia debe tener entre 1200 y 1300 palabras. Basa tu narrativa únicamente en el siguiente escenario hipotético sobre Goku:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat, system prompt se sobreescribe
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente especializado únicamente en la historia alternativa de Dragon Ball que se está mostrando. Responde preguntas de seguimiento sobre sus detalles, personajes o consecuencias *dentro de esa línea temporal específica*. Sé conciso y relevante al tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // *** Generar 40 títulos ***
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas para historias alternativas de Dragon Ball centradas en Goku. Genera exactamente 40 escenarios hipotéticos específicos tipo '¿Qué pasaría si Goku...?', adecuados para una narrativa detallada. Devuelve *solo* la lista de escenarios, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentar ligeramente el timeout por si necesita más tiempo para 40
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que la versión anterior: searchInput, titleListContainer, etc...)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentScenarioTitle = null; // Renombrado para claridad

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentScenarioTitle
                 ? `Eres un asistente especializado únicamente en la historia alternativa de Dragon Ball titulada '${currentScenarioTitle}'. Responde preguntas sobre los detalles, personajes o consecuencias *dentro de esa línea temporal específica*. Sé conciso y mantente dentro del contexto de la historia presentada.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores Kai están sobrecargados ahora mismo. Inténtalo de nuevo en un momento.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La IA no pudo visualizar esta línea temporal. Intenta otra divergencia.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con el Otro Mundo tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió una distorsión temporal inesperada al contactar la IA.");
             }
        }
        async function fetchExplanationText(scenarioTitle) { // Renombrado
            return fetchTextFromApi(scenarioTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentScenarioTitle) throw new Error("Error interno: No se ha seleccionado una línea temporal para consultar.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() { // Pide 40 títulos ahora
            const randomTheme = getRandomElement(dragonBallWhatIfThemes) || "escenarios de Goku variados";
            const specificPrompt = `Genera 40 escenarios hipotéticos sobre ${randomTheme}`;
            console.log("Generating 40 titles with prompt:", specificPrompt);
            // Usa la configuración que pide 40
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     // Aumentar la validación mínima ligeramente para 40 títulos
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.toLowerCase().startsWith('¿qué pasaría si goku') && line.length > 15 && line.length < 200);
                     if (titles.length < 15) throw new Error("La IA no generó suficientes escenarios válidos."); // Esperar al menos 15 de 40
                     return titles.slice(0, 40); // Devolver hasta 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Goku Dragon Ball alternate timeline";
            // Prompt adaptado a DB
            const enhancedPrompt = `Dramatic anime scene illustration depicting the essence of the Dragon Ball alternate timeline '${safePromptText}'. Focus on Goku or key characters in a pivotal moment reflecting the scenario. Dynamic action, energy effects, vibrant colors like orange, blue, gold. Akira Toriyama art style influence. Avoid text, logos, manga panels. Cinematic keyframe.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, label, title, caption, logo, watermark, signature, realistic, photorealistic, 3d render, simple background, blurry, low quality, multiple panels, collage";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (la misma función que antes) */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (sin cambios lógicos, solo nombres/textos)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentScenarioTitle = null; // Limpia el contexto del chat
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios lógicos)
        function showFullscreenImage(imgSrc) { /* ... */ fullscreenImage.src=imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow='hidden'; }
        function hideFullscreenImage() { /* ... */ imageFullscreenOverlay.classList.remove('active'); if(!storyModal.classList.contains('active')){document.body.style.overflow='';} fullscreenImage.src=''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios lógicos)
        function addChatMessage(message, sender) { /* ... */ const msgDiv=document.createElement('div'); msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message'); message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>'); message=message.replace(/\*(.*?)\*/g,'<em>$1</em>'); msgDiv.innerHTML=message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errDiv=document.createElement('div'); errDiv.classList.add('chat-error'); errDiv.textContent=message; chatHistory.appendChild(errDiv); chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const userQuery=chatInput.value.trim(); if(!userQuery||chatSendBtn.disabled)return; addChatMessage(userQuery,'user'); chatInput.value=''; chatSendBtn.disabled=true; chatLoadingIndicator.style.display='block'; try{const aiResponse=await fetchChatResponse(userQuery); addChatMessage(aiResponse,'ai');} catch(error){console.error("Chat Error:",error); addChatError(`Error del Kai: ${error.message}`);} finally{chatLoadingIndicator.style.display='none'; chatSendBtn.disabled=false; chatInput.focus();} }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        // function shuffleArray(array) { ... } // No se usa actualmente, se puede quitar si no es necesario
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar alfabéticamente puede ser menos útil aquí, quizás mantener el orden de las sagas
             // const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (titles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-bold">» No hay líneas temporales registradas «</p>'; return; }
             titles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { // Añade los nuevos títulos (40)
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => {
                 if (!existingTitles.has(title)) {
                    titleListContainer.appendChild(createTitleItem(title));
                    addedCount++;
                 }
             });
             console.log(`Added ${addedCount} new unique titles.`);
             filterTitles(searchInput.value); // Re-aplicar filtro
         }

        // *** MODIFIED: handleTitleClick - Renombrado contexto, textos ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentScenarioTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // Fetch and format text
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Image Placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-history placeholder-icon"></i> <!-- Icono historia/tiempo -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Visualizando evento clave...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Image Element & Loading
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización de: ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = (e) => {
                    console.error("Error loading image for:", title, e);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo visualizar esta línea temporal.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la línea temporal.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles - Pide 40, textos actualizados ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando en el Multiverso...';
             try {
                 // La función fetchGeneratedTitles ya está configurada para pedir 40
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     appendTitles(newTitles); // La función append maneja añadir los nuevos
                 } else {
                     alert("No se encontraron más divergencias interesantes por ahora.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al explorar posibilidades: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Restaurar texto original del botón
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Posibilidades (40)';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // (Asegurarse que todos los elementos DOM necesarios existan)
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡ERROR! ¡La Máquina del Tiempo está Rota! Faltan componentes UI.</p>';
                 return;
             }
            // Listeners (iguales que antes)
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>