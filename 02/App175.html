<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grimorio Oscuro - Forjador de Mundos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Atmosféricas / Góticas Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,700;1,400&family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Fantasía Oscura --- */
        :root {
            --color-primary: #8b0000; /* Rojo Sangre Oscuro */
            --color-secondary: #4b0082; /* Indigo/Morado Profundo */
            --color-tertiary: #a9a9a9; /* Gris Oscuro Deslucido */
            --color-background: #1a1a1a; /* Negro Carbón / Muy Oscuro */
            --color-text: #dcdcdc; /* Gris Muy Claro / Pergamino */
            --color-text-muted: #808080; /* Gris Medio */
            --color-modal-bg: #2b2b2b; /* Gris Oscuro Intenso */
            --color-border: #444444; /* Borde Gris */
            --color-error-bg: #2b0000; /* Fondo error Rojo Muy Oscuro */
            --color-error-text: #f5c6cb; /* Texto error Rosa Pálido */
            --color-error-border: #8b0000; /* Borde error Rojo Sangre */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -4px rgba(0, 0, 0, 0.4);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.3s ease-in-out;
        }
        /* Subtle background texture */
        body {
            font-family: 'EB Garamond', serif;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.75;
            font-weight: 400;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23333333' fill-opacity='0.07'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        h1, h2, h3, h4, .logo, .button-text { font-family: 'Cinzel Decorative', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4); }
        .navbar { background-color: rgba(26, 26, 26, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(43, 43, 43, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'EB Garamond', serif; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'EB Garamond', serif; font-size: 1.05rem; border-left: 4px solid var(--color-border); }
        .title-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #3a3a3a; border-left-color: var(--color-primary); font-weight: 700; }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: var(--color-text); padding: 0.9rem 1.6rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-family: 'Cinzel Decorative', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: 1px 1px 2px #000; box-shadow: var(--shadow-md); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); border-color: var(--color-tertiary); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; text-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-text); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.92); /* Overlay más oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.8rem 2.2rem; /* Ajustar padding */
            max-width: 1000px; /* Un poco más ancho */
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Más altura para chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg), 0 0 15px rgba(139, 0, 0, 0.2); /* Sombra + brillo sutil */
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(-180deg) scale(1.1); box-shadow: 0 0 8px var(--color-primary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.4; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(68, 68, 68, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 9px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(68, 68, 68, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 8px; /* Padding interno del texto */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel Decorative', serif; margin-top: 2.4em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 400; letter-spacing: 0.5px; }
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; font-style: italic; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 3rem auto 1.5rem auto; border: 2px solid var(--color-border); border-radius: var(--border-radius); box-shadow: 0 0 18px rgba(0, 0, 0, 0.6); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; filter: saturate(0.9) contrast(1.1); /* Dark fantasy look */ }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 25px rgba(139, 0, 0, 0.4); border-color: var(--color-primary); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); border: 1px dashed var(--color-border); border-radius: var(--border-radius); background-color: rgba(0,0,0,0.1); padding: 1rem; }
        #modal-content .image-placeholder .spinner { border: 5px solid rgba(68, 68, 68, 0.7); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1.2s linear infinite; margin-bottom: 1rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; margin-bottom: 0.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 2px solid var(--color-border); padding-top: 1.2rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* Slightly taller chat */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(26, 26, 26, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(68, 68, 68, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 7px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(68, 68, 68, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; font-size: 0.95rem; }
        .user-message { background-color: var(--color-secondary); color: var(--color-text); margin-left: auto; text-align: right; box-shadow: var(--shadow-sm); }
        .ai-message { background-color: #444444; color: var(--color-text); margin-right: auto; text-align: left; box-shadow: var(--shadow-sm); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.3rem; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #3a3a3a; color: var(--color-text); border-radius: var(--border-radius); font-family: 'EB Garamond', serif; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 2px rgba(75, 0, 130, 0.3); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: var(--color-text); border: 1px solid var(--color-border); border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #a50000; border-color: var(--color-primary); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; color: #555; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-style: italic; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 26, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 7px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.3s linear infinite; margin: 0 auto 1.8rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.4rem; font-family: 'Cinzel Decorative'; text-shadow: 1px 1px 3px #000; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'EB Garamond', serif; box-shadow: inset 0 0 10px rgba(0,0,0,0.4); }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-border); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); box-shadow: var(--shadow-md); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1) rotate(90deg); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-12">
         <div class="container mx-auto px-4 py-5 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-4 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-book-dead mr-3 text-red-700"></i> <!-- Icono Grimorio -->
                     Grimorio Oscuro
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-serif italic tracking-wider">» Forjador de Mundos Sombríos «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-14 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-6">Teje Realidades de Pesadilla</h1>
             <p class="text-xl text-gray-300 mb-10 max-w-4xl mx-auto font-serif leading-relaxed">Explora los fragmentos de mundos rotos. Invoca criaturas de leyenda oscura, desentraña magias corruptas y camina por paisajes bañados en la eterna penumbra.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-12 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar reinos, bestias, hechizos...">
             <i class="fas fa-search fa-scroll"></i> <!-- Icono pergamino/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-10 text-center mx-auto">
                 <i class="fas fa-dungeon text-gray-500 mr-2"></i> <!-- Icono mazmorra -->
                 Fragmentos del Abismo
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-serif italic">Consultando los anales prohibidos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-6 hidden font-serif italic">» Las sombras no revelan entradas con ese nombre... «</p>
             <div id="generate-more-container" class="text-center mt-10">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     <span class="button-text">Invocar Más Fragmentos</span>
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Descifrando el Fragmento...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando al Oráculo...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Susurra tu pregunta sobre este fragmento...">
                         <button id="chat-send-btn" aria-label="Enviar Pregunta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-black text-gray-600 py-6 mt-16 border-t border-gray-800 font-serif">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Fragmentos generados por ecos del Vacío (IA) con fines creativos y de inspiración oscura.</p>
              <p class="mt-1">Los horrores descritos son puramente ficticios... por ahora.</p>
              <p class="mt-2">© Ciclo Eterno - Grimorio Oscuro</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Reinos y Dominios
            "El Reino Roto de Eldoria", "Las Tierras Cicatriz de Gorgoth", "El Imperio Silente de Ceniza", "La Baronía Susurrante de Umbralia", "Ciudad Libre de Puerto Nocturno", "El Archipiélago Olvidado de las Almas", "Las Estepas Infinitas de Hueso", "El Dominio Glacial de la Pena Eterna", "La Teocracia Sangrienta de Malakor", "El Enclave Subterráneo de los Desollados", "Las Ruinas Flotantes de Aeridor", "El Bosque Petrificado de Yggrad", "El Pantano de la Fiebre Anímica", "El Desierto de Cristal Espectral", "La Ciudadela Obsidiana del Vacío", "El Laberinto Lunar de la Locura", "El Reino Sumergido de Y'ha-nthlei", "El Valle de los Ecos Perdidos", "La Marca del Este Infectada", "El Nido Celestial de los Grifos Carroñeros", "Las Catacumbas del Rey Gusano", "La Fortaleza Carmesí de la Vigilia", "El Santuario Marchito de los Primeros Elfos", "El Mercado Negro Flotante de Sombras", "La Necrópolis de los Mil Reyes", "El Páramo de las Agujas Negras", "El Ducado de la Llama Fría", "La Comarca Maldita por la Hambruna", "El Cañón de los Susurros Traicioneros", "La Isla de las Sirenas Necrófagas",
            // Criaturas y Bestias
            "Acechador Sombrío", "Bestia de Sangre Corrupta", "Carnifex del Abismo", "Devorador de Almas", "Engendro del Vacío Tentacular", "Familiar Impío", "Ghoul Lord Necrófago", "Horror Cósmico Indescriptible", "Imp de Hueso", "Jinete Espectral de la Condena", "Kraken de Tinta Negra", "Lich Archivista Arcano", "Moloch de Carne y Acero", "Naga de Escamas de Obsidiana", "Ogro Mutado por la Plaga", "Perro Infernal de Azufre", "Quimera de Pesadilla", "Revenant Vinculado al Odio", "Súcubo/Íncubo Ladrón de Voluntad", "Terror Alado Nocturno", "Ur-Ghast Primigenio", "Vampiro Antiguo del Linaje Maldito", "Wyrm de la Podredumbre", "Xenomorfo Adaptativo (Biológico)", "Yeti Abominable de las Cumbres Negras", "Zombi de la Plaga Pustulenta", "Ángel Caído Renegado", "Basilisco de la Mirada Petrificante", "Centinela Golem de Hueso", "Dragón de Sombras Ancestral", "Elemental de Sangre Congelada", "Fauces del Terror Subterráneo", "Gárgola Viviente de Catedral Profanada", "Hidra de Cabezas Marchitas", "Inquisidor Fantasmal", "Juggernaut No-Muerto Imparable", "Kobold Adorador de Demonios", "Leviatán de las Profundidades Abisales", "Mantícora Devoradora de Esperanzas", "Nocturno (Criatura de Oscuridad Pura)", "Otyugh Maestro de la Inmundicia", "Parásito Cerebral Psiónico", "Rakshasa Ilusionista Siniestro", "Salamandra de Fuego Infernal", "Treant Corrompido por la Plaga", "Umbraleth (Entidad del Límite)", "Vargheist (Vampiro Bestial)", "Wendigo Devorador de Corazones", "Espectro Llorón", "Yugoloth Mercenario del Abismo", "Zealot del Culto Prohibido",
            // Magia y Poderes
            "Necromancia Avanzada (Alzamiento de Masas)", "Magia de Sangre (Sacrificios y Pactos)", "Hechicería Sombría (Manipulación de Oscuridad)", "Piromancia Corrupta (Fuego Infernal)", "Cronomancia Prohibida (Paradojas)", "Taumaturgia Vil (Manipulación de Almas)", "Alquimia Mutagénica", "Rúnica Maldita (Glifos de Dolor)", "Invocación Demoníaca Peligrosa", "Magia Psiónica de la Locura", "Chamanismo de Espíritus Vengativos", "Teurgia Oscura (Poder de Dioses Muertos)", "Magia de la Carne (Transmutación Corporal)", "Magia Entrópica (Decaimiento Acelerado)", "Ilusionismo Traumático", "Magia de Hielo Negro (Congelación del Alma)", "Geomancia Profanada (Corrupción Terrestre)", "Aeroturgia Pestilente (Vientos Nocivos)", "Hidromancia Abisal (Control de Aguas Negras)", "Magia Simbiótica (Parásitos Arcanos)", "Control Mental Siniestro", "Manipulación de la Entropía Vital", "Forja de Almas (Creación de Constructos)", "Adivinación Sangrienta (Oráculos de Vísceras)", "Magia de Plagas y Enfermedades", "Absorción de Vida y Energía", "Proyección Astral a Reinos Oscuros", "Creación de Maldiciones Permanentes", "Vinculación de Sombras (Control de Sombras Ajenas)", "Animación de Objetos Inertes con Odio",
            // Facciones y Cultos
            "El Culto del Ojo Ciego", "La Orden del Sudario Negro (Nigromantes)", "El Gremio de Asesinos de la Noche Eterna", "Los Caballeros del Cáliz Ensangrentado", "El Consorcio Mercantil de Almas", "La Iglesia del Dios Ahogado", "Los Hijos del Gusano Pálido", "La Cábala de la Llama Sombría", "La Tribu de los Devoradores de Carroña", "La Hermandad del Acero Roto (Caídos)", "El Círculo Druídico de la Espina Retorcida", "Los Profetas de la Última Estrella", "La Legión de los Condenados (No-Muertos)", "El Sindicato de Ladrones de Recuerdos", "Los Inquisidores de la Verdad Dolorosa", "El Conclave de los Brujos del Pacto", "Los Carceleros del Abismo", "La Academia Prohibida de Artes Arcanas", "Los Merodeadores de las Tierras Yermas", "La Resistencia Desesperada (Moralmente Gris)", "Los Guardianes del Saber Olvidado (Peligroso)", "El Culto de la Transformación Dolorosa", "La Sociedad Secreta de los Licántropos", "Los Exiliados del Sol Poniente", "El Parlamento de las Sombras", "Los Peregrinos de la Ciudad Muerta", "La Casta de los Intocables Mutados", "Los Heraldos del Apocalipsis Inminente", "El Aquelarre de las Brujas de Sangre", "La Corte Crepuscular de los Fey Oscuros",
            // Planos y Cosmología
            "El Abismo Infinito de Entropía", "Los Nueve Infiernos Jerárquicos", "El Plano de las Sombras Espejo", "La Dimensión de la Carne Viva", "El Mar Astral de Almas Perdidas", "El Reino de Pesadilla Colectiva", "La Biblioteca Infinita de la Locura", "El Vacío Devorador de Estrellas", "El Panteón de los Dioses Muertos", "La Prisión Cósmica del Primigenio Encadenado", "El Plano Elemental del Decaimiento", "El Sueño Lúcido del Dios Loco", "El Laberinto de los Ecos Imposibles", "El Corazón del Mundo Sangrante", "Las Tierras Fronterizas del Más Allá", "El Nexo de Realidades Rotas", "El Firmamento de Cristal Roto", "La Tumba del Sol Negro", "El Océano de Sangre Primordial", "El Jardín de la Carne Floreciente (Horror Biológico)",
            // Artefactos y Reliquias
            "El Grimorio de Piel Humana", "La Espada Vorpal Sedienta de Almas", "El Orbe de la Visión Torturada", "La Corona del Rey Loco", "El Corazón del Lich", "El Amuleto del Pacto Infernal", "La Llave Esqueleto Multidimensional", "El Espejo de los Deseos Retorcidos", "Las Lágrimas Petrificadas de un Dios Muerto", "El Sudario de los Lamentos Eternos", "El Incensario de Plagas Contagiosas", "La Daga Sacrificial del Culto", "El Yelmo de la Dominación Psíquica", "El Cáliz que Convierte Vino en Sangre", "El Mapa Tatuado en Piel de Demonio", "La Pluma que Escribe con Dolor Ajeno", "El Sello que Libera al Primigenio", "La Caja de Música que Invoca Horrores", "El Anillo del Invierno Interminable", "La Máscara que Roba Identidades",
            // Conceptos y Temas
            "La Naturaleza de la Corrupción del Alma", "El Precio de la Magia Prohibida", "El Ciclo Infinito de Guerra y Sufrimiento", "La Profecía del Fin de los Tiempos", "La Búsqueda del Conocimiento Peligroso", "La Delgada Línea entre Héroe y Monstruo", "La Futilidad de la Resistencia contra el Mal Cósmico", "La Decadencia de las Civilizaciones Antiguas", "La Locura como Fuente de Poder", "El Horror Corporal y la Mutación", "La Traición como Moneda Corriente", "La Pérdida de la Humanidad (Literal o Figurativa)", "El Pacto Faustiano y sus Consecuencias", "La Memoria Ancestral Traumática", "La Belleza Grotesca de lo Monstruoso", "La Supervivencia a Cualquier Costo", "El Culto a la Muerte y la No-Vida", "La Influencia Insidiosa de Entidades Externas", "La Ironía del Destino Trágico", "La Esperanza como una Maldición",
             // Más combinaciones para llegar cerca de 400
            "El Bosque Susurrante de los Ahorcados", "La Ciudad Sumergida bajo el Lago Negro", "El Monasterio Silencioso de los Flagelantes", "La Caravana Perdida en el Desierto de Huesos", "El Coliseo donde Luchan Condenados y Bestias", "El Santuario del Ídolo Tentaculado", "La Torre del Nigromante Solitario", "El Puente Hecho de Cadáveres Petrificados", "El Orfanato Dirigido por Súcubos", "La Mina Explotada por Esclavos Ghouls", "La Catedral Gótica de la Penitencia Eterna", "El Mercado Clandestino de Órganos Arcanos", "El Barco Fantasma Atrapado en Niebla Perpetua", "El Cementerio de Gólems Desactivados", "La Fortaleza Voladora Impulsada por Almas", "El Pozo de los Deseos Malditos", "El Árbol Ancestral Sangrante", "El Templo de la Serpiente de Muchas Cabezas", "La Academia Militar de los Jinetes del Apocalipsis", "La Prisión Mental Construida por Ilusionistas", "El Faro que Guía a las Bestias del Abismo", "El Oasis Ilusorio en el Páramo Maldito", "La Forja donde se Crean Armas Demoníacas", "El Jardín Botánico de Plantas Carnívoras Conscientes", "La Biblioteca Llena de Libros que Muerden", "El Acueducto que Transporta Sangre en Vez de Agua", "El Observatorio que Muestra Futuros Terribles", "El Hospital Atendido por Cirujanos Locos", "El Laberinto Espejado que Atrapa Ecos", "El Volcán que Erupciona Demonios Menores",
            "Bestia de Disformidad Caótica", "Constructo de Relojería Impulsado por Dolor", "Elemental de Ceniza Sofocante", "Familiar Gato Espectral", "Gusano de Tumba Colosal", "Homúnculo Fallido y Vengativo", "Insectoide Psíquico Colectivo", "Kitsune de Nueve Colas Sombrías", "Lobo Fantasmal Aullador", "Medusa con Cabellos de Anguilas Eléctricas", "Nigromante Menor Ambicioso", "Oso Plagado de Hongos Parásitos", "Poltergeist Violento y Territorial", "Quasit Espía Demoníaco", "Rata de Plaga Gigante y Consciente", "Sombra Viviente Desprendida", "Troll Regenerador Ácido", "Unicornio Negro Corrupto", "Vampiro Psíquico Drenador de Emociones", "Xorn Devorador de Metales Preciosos y Almas", "Yeti Caníbal", "Zombi Marino Hinchado", "Arpía Cantora de Lamentos", "Cancerbero de las Puertas del Infierno", "Doppelgänger Ladrón de Vidas", "Elemental de Vacío Devorador", "Fénix Oscuro Renacido en Cenizas Negras", "Grifo Carroñero de Campos de Batalla", "Hobgoblin Estratega Despiadado", "Imp Explosivo Suicida", "Jinete sin Cabeza Buscador de Venganza", "Kraken Eléctrico de Tormentas", "Lémur Espectral Travieso y Mortal", "Mimic Perfecto (Cofre, Puerta, Habitación)", "Nixie Ahogadora de Viajeros", "Ogro Mago Torpe pero Peligroso", "Pixie Maligno Ladrón de Dientes", "Reina Araña Tejedora de Pesadillas", "Sátiro Depravado Líder de Orgías Sangrientas", "Titán Caído Encadenado", "Umber Hulk Hipnotizador", "Valquiria Caída Recolectora de Almas para el Mal", "Will-o'-Wisp Engañoso", "Xill Extraplanario Secuestrador", "Yuan-ti Abominación Serpentina", "Zaratan Tortuga-Isla Viviente y Hostil",
            // ... (continuar generando combinaciones y conceptos específicos)
        ];
        const darkFantasyThemes = [
            "reinos caídos", "ciudades malditas", "paisajes desolados", "bosques encantados oscuros", "pantanos pútridos", "montañas prohibidas", "criaturas no-muertas", "bestias demoníacas", "horrores cósmicos", "fey sombríos", "monstruos mutados", "cultos apocalípticos", "órdenes nigrománticas", "gremios de asesinos", "caballeros renegados", "magia de sangre", "hechicería de sombras", "necromancia", "alquimia oscura", "artefactos malditos", "grimorios prohibidos", "pactos oscuros", "profecías de perdición", "planos infernales", "dimensiones de pesadilla", "el vacío", "dioses muertos u olvidados", "corrupción del alma", "locura y poder", "horror corporal", "dualidad moral", "supervivencia desesperada"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un Cronista de lo Arcano y Olvidado, un erudito que ha dedicado eones a estudiar los fragmentos de mundos rotos y las verdades sombrías que esconden. Tu tarea es describir el elemento de mundo de fantasía oscura indicado (lugar, criatura, magia, facción, concepto, etc.) con gran detalle atmosférico y narrativo. Enfócate en su historia oscura, su apariencia lúgubre, los peligros que entraña, la magia corrupta o poderes siniestros asociados, su impacto en el mundo o sus habitantes, y la sensación omnipresente de decadencia, horror o moralidad fracturada. Utiliza un lenguaje evocador, gótico y rico. El objetivo es una crónica detallada de aproximadamente 1200-1300 palabras. Basa tu descripción únicamente en el siguiente fragmento del Grimorio Oscuro:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúas como un Oráculo susurrante ligado al Grimorio Oscuro, poseedor de conocimiento fragmentado sobre el tema específico que se está consultando. Responde preguntas adicionales sobre sus detalles, secretos o implicaciones, pero tus respuestas son a menudo crípticas, breves y teñidas de fatalismo o advertencia. Céntrate exclusivamente en el tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un escriba loco canalizando ecos del vacío. Genera exactamente 15 nombres evocadores de lugares, criaturas, magias, facciones o conceptos propios de un mundo de fantasía oscura, adecuados para una crónica detallada. Devuelve *solo* la lista de nombres/conceptos, uno por línea. Sin números, guiones, introducciones ni comentarios. Deben sonar ominosos, antiguos o corruptos.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        // (Identical to previous version - searchInput, titleListContainer, etc.)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Renamed for clarity maybe? Keep as is for now.
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Renamed for clarity

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            // Dynamic system prompt for chat
            const systemPromptToUse = isChat && currentTopicTitle
                ? `Actúas como un Oráculo susurrante ligado al Grimorio Oscuro, poseedor de conocimiento fragmentado sobre '${currentTopicTitle}'. Responde preguntas adicionales sobre sus detalles, secretos o implicaciones. Tus respuestas son crípticas, breves y teñidas de fatalismo o advertencia. Céntrate exclusivamente en '${currentTopicTitle}'.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, o el Oráculo guarda silencio. Por favor, intenta de nuevo en unos segundos.`);
                }
                const text = await response.text();
                 if (!text || text.trim().length === 0 || text.toLowerCase().includes("no puedo ayudarte con eso") || text.toLowerCase().includes("incapaz de generar")) {
                     throw new Error("El Oráculo no responde o el fragmento es demasiado oscuro para descifrar. Intenta con otro.");
                 }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión con el más allá tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                }
                throw new Error(error.message || "Una fuerza desconocida impidió la consulta.");
            }
        }
        async function fetchExplanationText(topicTitle) {
             return fetchTextFromApi(topicTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentTopicTitle) throw new Error("Error Interno: El contexto del fragmento se ha perdido en las sombras.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(darkFantasyThemes) || "conceptos de fantasía oscura";
            const specificPrompt = `Genera 15 nombres/conceptos evocadores sobre ${randomTheme}`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La inspiración del Vacío fue insuficiente.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "dark fantasy landscape or creature";
            // Enhanced prompt for dark fantasy art
            const enhancedPrompt = `Dark fantasy concept art, epic illustration depicting '${safePromptText}'. Atmosphere: gloomy, ominous, decaying, corrupt, mysterious. Style: detailed, painterly, gothic, baroque influences maybe. Focus on mood, lighting (chiaroscuro, unnatural glows), textures (stone, bone, flesh, rust). Inspired by artists like Zdzisław Beksiński, H.R. Giger, Brom, Wayne Barlowe. Cinematic composition.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "photorealistic, photograph, bright colors, cheerful, happy, cute, cartoon, anime, text, words, labels, UI, signature, watermark, multiple panels, collage, simple background, clean lines, vector art, low quality, blurry";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (Should be robust enough)
        function formatExplanationText(rawText) { /* ... (Keep the same implementation as before) ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 // Replace multiple newlines within a block with paragraph breaks, single newlines with spaces
                 const paragraphs = block.split(/\n{2,}/).map(p => `<p>${p.replace(/\n/g, ' ').trim()}</p>`).join('');
                 return paragraphs;
                 // Simpler alternative: treat each block as one paragraph, replace inner newlines with spaces
                 // let content = block.replace(/\n/g, ' ');
                 // return `<p>${content}</p>`;
             }).join('');
             return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0; // Use the correct element for scroll reset
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null; // Clear context
             hideFullscreenImage(); // Ensure fullscreen is hidden
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Identical logic)
        function showFullscreenImage(imgSrc) { /* ... */ if(!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src=imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow='hidden'; }
        function hideFullscreenImage() { /* ... */ if(!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if(!storyModal.classList.contains('active')){document.body.style.overflow='';} fullscreenImage.src=''; }

        // ========== CHAT FUNCTIONS ========== (Identical logic)
        function addChatMessage(message, sender) { /* ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Oráculo: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' })); // Sort alphabetically
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-serif italic">» El Grimorio está vacío... por ahora «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
         function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             // Re-apply filter AFTER adding new titles
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to use currentTopicTitle and correct scroll target ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // Set context for chat
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset scroll of the text container
                console.log("Scroll set to 0 after content visible");

                // Image Placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-eye placeholder-icon text-gray-600"></i> <!-- Icono ojo -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Visualizando el fragmento...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Image Element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización artística de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon text-red-800"></i><p style="font-size:0.8em;margin-top:0.5rem;">La visión falló. Demasiado oscuro.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al invocar la imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Un error desconocido acecha en las sombras.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.style.display = 'none'; // Hide chat on main error
            } finally {
                 // Ensure chat section is visible if no error occurred during main load
                 if (!modalError.classList.contains('content-hidden')) {
                     chatSection.style.display = 'none';
                 } else {
                     chatSection.style.display = 'flex'; // Make sure it's flex
                 }
             }
        }

        async function handleGenerateMoreTitles() {
            if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
            generateMoreBtn.disabled = true;
            generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando el Vacío...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("El Vacío no ofreció nuevos fragmentos esta vez."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al invocar fragmentos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Keep the span for the button text
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> <span class="button-text">Invocar Más Fragmentos</span>';
             }
         }

         // Search Filter Function (with normalization)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Show if no results OR if list is empty initially
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Add checks for all essential elements, including chat and fullscreen
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalTextArea) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: var(--color-error-text); background: var(--color-error-bg); border: 1px solid var(--color-error-border); padding: 2em; font-size: 1.5em; text-align: center;">++ ERROR CRÍTICO: El Grimorio no pudo ser cargado. Faltan componentes esenciales. ++</p>';
                 return;
             }

             // Event Listeners (Identical to previous version)
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Initial Display
             displayTitles(predefinedTitles); // Load initial titles
             filterTitles(''); // Apply filter initially (shows all, hides 'no results' if titles exist)
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>