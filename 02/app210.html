<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xeno-Archivo: Civilizaciones Extraterrestres</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Sci-Fi/Modernas -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Xeno-Archivo --- */
        :root {
            --color-primary: #4f46e5; /* Indigo Intenso (Tecnología/Misterio) */
            --color-secondary: #ec4899; /* Rosa Neón (Exótico/Bioluminiscencia) */
            --color-tertiary: #10b981; /* Verde Esmeralda (Vida/Naturaleza Alien) */
            --color-background: #0b0f19; /* Azul Noche Muy Oscuro */
            --color-text: #dbeafe; /* Azul Muy Claro / Blanco Hielo */
            --color-text-muted: #9ca3af; /* Gris Claro */
            --color-modal-bg: #1f2937; /* Gris Azulado Oscuro */
            --color-border: #4b5563; /* Borde Gris Medio */
            --color-error-bg: #450a0a; /* Rojo muy oscuro para error */
            --color-error-text: #fecaca; /* Texto error claro */
            --color-error-border: #ef4444; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(79, 70, 229, 0.15);
            --shadow-md: 0 4px 6px -1px rgba(79, 70, 229, 0.2), 0 2px 4px -2px rgba(79, 70, 229, 0.15);
            --shadow-lg: 0 0 30px -5px rgba(79, 70, 229, 0.3), 0 8px 10px -6px rgba(79, 70, 229, 0.2);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Exo 2', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; background-image: radial-gradient(circle at top right, rgba(79, 70, 229, 0.1), transparent 40%), radial-gradient(circle at bottom left, rgba(236, 72, 153, 0.08), transparent 50%); background-attachment: fixed;}
        h1, h2, h3, h4, .logo { font-family: 'Orbitron', sans-serif; font-weight: 700; letter-spacing: 1px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px rgba(79, 70, 229, 0.7); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 6px rgba(79, 70, 229, 0.6); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 4px rgba(79, 70, 229, 0.5); }
        .navbar { background-color: rgba(11, 15, 25, 0.85); backdrop-filter: blur(8px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(31, 41, 55, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Exo 2'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Exo 2'; font-size: 1rem; border-left: 4px solid transparent; opacity: 0.9; }
        .title-item:hover { transform: translateY(-5px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #374151; border-left-color: var(--color-primary); opacity: 1; }
        #generate-more-btn { grid-column: 1 / -1; /* Ocupa todo el ancho */ background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: var(--color-background); padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Orbitron', sans-serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; letter-spacing: 1.5px; text-shadow: none; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(11, 15, 25, 0.92); backdrop-filter: blur(3px); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 1000px; /* Ligeramente más ancho */
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Más altura para chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg); box-shadow: 0 0 12px var(--color-primary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; /* Espacio scrollbar */ margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(75, 85, 99, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(75, 85, 99, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Orbitron', sans-serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.15em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 3rem auto 1.5rem auto; border: 2px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: 0 0 20px rgba(79, 70, 229, 0.3); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: 0 0 30px rgba(79, 70, 229, 0.5); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 5px solid rgba(75, 85, 99, 0.7); width: 45px; height: 45px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 1rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3.5rem; color: var(--color-border); margin-bottom: 0.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 2px solid var(--color-border); padding-top: 1.2rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* Más altura chat */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(11, 15, 25, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(75, 85, 99, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(75, 85, 99, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; }
        .user-message { background-color: var(--color-primary); color: var(--color-text); margin-left: auto; text-align: left; font-weight: 400; border-bottom-right-radius: 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);}
        .ai-message { background-color: #4b5563; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; border-bottom-left-radius: 0; box-shadow: -2px 2px 5px rgba(0,0,0,0.2);}
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #374151; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Exo 2'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 5px rgba(79, 70, 229, 0.5); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-primary); color: var(--color-text); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #4338ca; }
        #chat-send-btn:active:not(:disabled) { transform: scale(0.95); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.6rem; font-size: 0.95em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.6rem; }

        #modal-loading { text-align: center; padding: 4rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(11, 15, 25, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 70px; height: 70px; border: 7px solid var(--color-border); border-top-color: var(--color-primary); border-bottom-color: var(--color-secondary); /* Doble color spinner */ border-radius: 50%; animation: spin 1.3s linear infinite; margin: 0 auto 2rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.5rem; font-family: 'Orbitron'; text-shadow: 0 0 8px var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Exo 2'; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(11, 15, 25, 0.97); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: var(--shadow-lg); border-radius: var(--border-radius); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1) rotate(90deg); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-meteor mr-3 text-pink-500"></i> <!-- Icono alien/meteorito -->
                     Xeno-Archivo
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Base de Datos Interestelar «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explorando Civilizaciones Cósmicas</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Accede a registros clasificados sobre formas de vida más allá de la Tierra. Analiza su biología, sociedad, tecnología y los mundos que habitan.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar civilización, especie, planeta...">
             <i class="fas fa-satellite-dish fa-search"></i> <!-- Icono antena/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-indigo-400 mr-2"></i> <!-- Icono libro/archivo -->
                 Índice Galáctico
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Estableciendo conexión con la Red Galáctica...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron registros coincidentes en este sector «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Nuevos Sectores (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar Registro">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Descifrando Datos...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                    <h3 class="text-lg font-semibold mb-3 text-center text-indigo-300 font-orbitron flex-shrink-0">Consulta al Xeno-Analista</h3>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Analizando consulta xeno-lingüística...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta civilización...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen Ampliada">&times;</button>
          <img id="fullscreen-image" src="" alt="Visualización Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Xeno-Archivo Compilado por IA. Datos generados con fines especulativos y narrativos.</p>
              <p class="mt-1">Las civilizaciones y datos descritos son enteramente ficticios.</p>
              <p class="mt-2">© 2950 Federación Galáctica de Archivos</p> <!-- Año muy futurista -->
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Civilizaciones Específicas (Ejemplos)
            "Los Arquitectos Silenciosos de Xylos", "La Mente Colmena Acuática de Gliese 581g", "El Imperio Tecno-Orgánico K'Tharr", "Los Nomadas Psiónicos del Vacío", "La Federación Arbórea de Cygnus X-1", "Los Centinelas Cristalinos de Kepler-186f", "La República Energética de la Nebulosa del Cangrejo", "Los Cambiaformas Subterráneos de Tau Ceti e", "El Colectivo de Silicio de Proxima Centauri b", "Los Aviadores Solares de TRAPPIST-1d", "Los Cultivadores de Estrellas de Barnard", "La Antigua Raza Precursora (Los Primigenios)", "La Confederación Mercantil Xantusiana", "El Enjambre Devorador Tyránido (Concepto)", "Los Pacificadores Galácticos Luminares", "La Civilización Submarina de Europa (Luna Joviana)", "Los Seres de Plasma del Sol Muerto", "El Cónclave Robótico de Andrómeda", "Los Exploradores Dimensionales Zargonianos", "La Teocracia Fúngica de Yuggoth", "Los Artistas Etéreos de la Corriente Oscura", "La Casta Guerrera Reptiliana Draconis", "Los Filósofos Gaseosos de Júpiter", "El Imperio Esclavista Skrell", "La Unión Simbiótica de Pendor", "Los Guardianes de Mundos Jardín (Los Eldar)", "La Civilización de Magma de CoRoT-7b", "Los Ingenieros Genéticos Quari", "La Horda Bárbara Klackon", "Los Mecanistas de Fornax",

            // Tipos de Civilización
            "Civilizaciones de Tipo I (Escala Kardashev)", "Civilizaciones de Tipo II (Escala Kardashev)", "Civilizaciones de Tipo III (Escala Kardashev)", "Civilizaciones de Tipo IV y V (Teóricas)", "Civilizaciones Acuáticas Avanzadas", "Civilizaciones Subterráneas Tecnológicas", "Civilizaciones Aéreas / Habitantes de Gigantes Gaseosos", "Formas de Vida Basadas en Silicio", "Formas de Vida Basadas en Energía Pura", "Conciencias Colectivas / Mentes Colmena", "Civilizaciones Nómadas (Flotas Estelares)", "Civilizaciones Post-Biológicas (Digitales/Robóticas)", "Civilizaciones Simbióticas (Múltiples Especies)", "Civilizaciones Plantoides o Fúngicas", "Civilizaciones Líticas (Basadas en Roca/Cristal)", "Civilizaciones que Habitan Agujeros Negros (Teórico)", "Civilizaciones de Universos Paralelos", "Civilizaciones Pre-Industriales Exóticas", "Sociedades Post-Escasez", "Teocracias Galácticas", "Imperios Militares Expansionistas", "Federaciones Democráticas Interestelares", "Anarquías Tecnológicas Distribuidas", "Civilizaciones Enfocadas en el Arte/Filosofía", "Culturas Ancestrales Estancadas", "Civilizaciones con Castas Biológicas Definidas", "Sociedades Matriarcales/Patriarcales Extremas", "Civilizaciones Aislacionistas", "Colectivos Transhumanistas Avanzados", "Civilizaciones que Adoran a la IA",

            // Biología y Fisiología Alienígena
            "Xenobiología: Vida Basada en Amoníaco", "Xenobiología: Vida Basada en Metano", "Xenobiología: Vida Basada en Azufre", "Organismos Extremófilos Complejos", "Bioluminiscencia y Comunicación Alienígena", "Adaptaciones a Gravedad Extrema (Alta/Baja)", "Adaptaciones a Entornos Tóxicos/Radioactivos", "Sistemas Sensoriales Alienígenas (Electrorecepción, Magnetorrecepción)", "Capacidades Psiónicas (Telepatía, Telequinesis)", "Metamorfosis y Ciclos de Vida Complejos", "Reproducción Alienígena (Asexual, Hermafrodita, Parasitaria)", "Simbiosis Obligatoria en Ecosistemas Alienígenas", "Inteligencia No Humanoide (Radial, Gaseosa, Cristalina)", "Longevidad Extrema y Formas de Inmortalidad Biológica", "Ingeniería Genética y Modificación Corporal Extrema", "Sentidos Más Allá de los Humanos (Percepción Temporal, Dimensional)", "Fisiología de Seres de Energía", "Anatomía de Insectoides Inteligentes", "Evolución Convergente en Múltiples Mundos", "Plagas y Enfermedades Alienígenas", "Capacidad de Regeneración Avanzada", "Mecanismos de Camuflaje Biológico", "Biología de los Cambiaformas", "Comunicación Química/Feromonal Compleja", "Resistencia al Vacío Espacial", "Adaptaciones a Mundos Acuáticos Profundos", "Fisiología de Seres Plantoides Senscientes", "Metabolismos Alienígenas Exóticos", "Concepto de 'Alma' o Conciencia en Xeno-Culturas", "Inteligencia Distribuida (Colonias, Enjambres)",

            // Tecnología Alienígena
            "Motores FTL: Warp Drive vs. Hyperdrive vs. Agujero de Gusano", "Tecnología de Escudos de Energía (Deflectores, Campos de Fuerza)", "Armamento Exótico (Antimateria, Singularidad, Psiónico)", "Inteligencia Artificial Avanzada (IA Consciente, Dioses Máquina)", "Nanotecnología y Materia Programable", "Terraformación y Geoingeniería Planetaria", "Megastructuras (Esferas de Dyson, Mundos Anillo, Computronium)", "Tecnología de Invisibilidad / Camuflaje Activo", "Ingeniería Genética y Clonación Avanzada", "Interfaces Cerebro-Computadora Directas", "Teletransportación (Materia y Datos)", "Generación y Manipulación de Energía a Gran Escala", "Medicina Alienígena: Regeneración y Curación Rápida", "Realidad Virtual Totalmente Inmersiva / Carga de Conciencia", "Viaje en el Tiempo (Teórico/Controlado)", "Robótica Autónoma y Drones Inteligentes", "Materiales Exóticos (Resistencia Extrema, Propiedades Únicas)", "Sistemas de Traducción Universal", "Tecnología Psiónica Amplificada", "Armas Planetarias / Destructores de Estrellas", "Tecnología de Control Climático", "Fuentes de Energía Exóticas (Punto Cero, Agujeros Negros)", "Sistemas de Vigilancia y Espionaje Galáctico", "Construcción Autorreplicante", "Manipulación Gravitatoria", "Tecnología de Estasis", "Arqueotecnología Precursora", "Bio-Tecnología (Naves Orgánicas, Armas Vivas)", "Tecnología de Manipulación Dimensional", "Computación Cuántica a Escala Galáctica",

            // Homeworlds y Entornos
            "Mundos Oceánicos Globales", "Planetas Desérticos con Vida Adaptada", "Gigantes Gaseosos Habitados (Capas Superiores)", "Mundos Volcánicos Activos", "Planetas Helados con Océanos Subsuperficiales", "Mundos con Múltiples Soles / Lunas", "Planetas en Sistemas Binarios Estelares", "Mundos Artificiales (Estaciones Orbitales Gigantes, Mundos Anillo)", "Planetas con Atmósferas Exóticas (Corrosivas, Densas)", "Planetas Selva con Megafauna", "Mundos Cristalinos", "Planetas con Gravedad Variable / Extrema", "Planetas Muertos / Arrasados por Guerras", "Mundos Prisión / Colonias Penales", "Planetas Santuario / Reservas Naturales Galácticas", "Planetas Flotantes en Nebulosas", "Planetas Dentro de Esferas de Dyson", "Mundos con Ciclos Día-Noche Extremos (Tidally Locked)", "Planetas con Ruinas Precursoras", "Ecologías Basadas en Silicio", "Mundos Terraformados", "Planetas Rogue (Errantes sin Estrella)", "Hábitats en Asteroides Huecos", "Planetas con Flora Bioluminiscente Masiva", "Mundos Tóxicos con Vida Resistente", "Planetas con Anomalías Gravitatorias/Temporales", "Mundos Bibliotecarios (Archivos Galácticos)", "Planetas Post-Apocalípticos (Impacto, Guerra Nuclear)", "Mundos Sagrados o Prohibidos", "Planetas de Origen (Homeworlds)",

            // Sociedad, Cultura y Política
            "El Primer Contacto: Protocolos y Desafíos", "La Paradoja de Fermi: Explicaciones Posibles", "El Concepto del 'Gran Filtro'", "La Hipótesis del Bosque Oscuro", "Federaciones Galácticas y Alianzas Interestelares", "Imperios Estelares Totalitarios", "Sociedades Post-Singularidad Tecnológica", "Religiones y Creencias Cósmicas", "Formas de Arte y Expresión Alienígena", "Sistemas Económicos Interestelares (Trueque, Créditos, Post-Escasez)", "Leyes y Ética Galáctica", "Conflictos Interestelares y Guerras Galácticas", "Diplomacia y Relaciones Inter-Especies", "Impacto Cultural del Contacto Alienígena en la Humanidad", "Xenofobia y Racismo Interestelar", "Estructuras Sociales No Jerárquicas", "Lenguajes Alienígenas (Conceptos, Métodos de Comunicación)", "Rituales y Tradiciones Exóticas", "Conceptos de Familia y Parentesco Alienígena", "Filosofías y Visiones del Universo", "Arqueología Galáctica: Descubriendo Razas Perdidas", "Turismo Interestelar", "Deportes y Entretenimiento Alienígena", "Sistemas de Castas Sociales", "Movimientos de Resistencia contra Imperios", "Culturas que Rechazan la Tecnología Avanzada", "El Mercado Negro Galáctico", "Organizaciones Criminales Interestelares", "Espionaje y Contrainteligencia Galáctica", "Universidades y Centros de Saber Galáctico",

             // Añadir más títulos diversos... La lista es muy larga ya.
        ];
        const alienCivilizationThemes = [
            "civilizaciones tipo Kardashev", "biología alienígena extrema", "tecnología FTL", "mentes colmena", "formas de vida no carbónicas", "megastructuras espaciales", "planetas exóticos habitados", "primer contacto", "imperios galácticos", "federaciones interestelares", "razas precursoras", "sociedades post-biológicas", "habilidades psiónicas", "guerra interestelar", "xenomorfos", "especies acuáticas inteligentes", "seres de energía", "culturas nómadas espaciales", "planetas terraformados", "arqueología alienígena", "ética galáctica", "inteligencia artificial alienígena", "simbiosis inter-especies", "planetas desérticos", "mundos helados", "gigantes gaseosos"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un xeno-antropólogo y astrobiólogo de la Federación Galáctica de Archivos. Tu misión es catalogar civilizaciones extraterrestres ficticias. Describe la civilización o concepto alienígena indicado de manera exhaustiva y especulativa, pero coherente. Incluye detalles sobre: Biología/Fisiología (apariencia, sentidos, metabolismo, reproducción), Homeworld (tipo de planeta, clima, características únicas), Nivel Tecnológico (escala Kardashev aproximada, tecnologías clave FTL, energía, armas, IA, etc.), Sociedad/Cultura (gobierno, estructura social, arte, religión, ética, lenguaje), Historia conocida (origen, eventos clave, contacto con otras especies), Fortalezas y Debilidades principales. Utiliza un lenguaje académico pero evocador. El objetivo es un informe detallado de aproximadamente 1200-1300 palabras. Basa tu informe únicamente en la siguiente entrada del Xeno-Archivo:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúa como un asistente de IA especializado únicamente en la civilización alienígena ficticia que se está mostrando. Responde preguntas de seguimiento sobre sus características (biología, cultura, tecnología, etc.) basándote en la descripción principal. Sé conciso, preciso y mantente estrictamente dentro del tema de la civilización actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // Para generar más títulos
            model: "mistral",
            systemPrompt: "Actúa como un generador de conceptos para una base de datos de ciencia ficción sobre vida extraterrestre. Genera exactamente 40 nombres evocadores o conceptos relacionados con civilizaciones alienígenas ficticias, especies, planetas, tecnologías o temas xeno-sociológicos. Devuelve *solo* la lista, un ítem por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo para generar 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentCivilizationTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             // *** USA EL SYSTEM PROMPT DINÁMICO PARA CHAT ***
             const systemPromptToUse = isChat && currentCivilizationTitle
                 ? `Eres un asistente de IA experto únicamente en la civilización ficticia '${currentCivilizationTitle}'. Responde preguntas de seguimiento sobre su biología, cultura, tecnología, etc., basándote en la descripción principal. Sé conciso y relevante.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores (o los de la IA) tienen mucho tráfico o hay un problema temporal. Intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o inténtalo más tarde.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con la IA tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(conceptTitle) {
             return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentCivilizationTitle) throw new Error("Error interno: Contexto de civilización no establecido para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        // *** MODIFIED: Fetch Generated Titles (Request 40) ***
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(alienCivilizationThemes) || "civilizaciones alienígenas variadas";
            // *** Explicitly ask for 40 items in the prompt ***
            const specificPrompt = `Genera 40 nombres o conceptos de civilizaciones/especies/tecnologías alienígenas ficticias sobre ${randomTheme}`;
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) }; // Use the correct config
            console.log("Generating 40 titles with prompt:", specificPrompt);

            // Use the generic fetch function
            return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                .then(text => {
                    const titles = text.split('\n')
                                     .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                     .filter(line => line.length > 5 && line.length < 150);
                    // *** Adjust error check for 40 items ***
                    if (titles.length < 20) { // Expecting more than before
                        console.warn("Generated titles count low:", titles.length);
                        throw new Error("La IA no generó suficientes conceptos nuevos (se esperaban ~40).");
                    }
                    // *** Return up to 40 titles ***
                    return titles.slice(0, 40);
                });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 960, height: 640, nologo: true }; // Slightly wider image
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "mysterious alien civilization concept art";
             const enhancedPrompt = `Concept art depicting the fictional alien civilization or concept '${safePromptText}'. Focus on unique biology, advanced or strange technology, atmospheric alien homeworld landscape, sociological elements. Sci-fi aesthetic, cinematic lighting, highly detailed, otherworldly. Avoid humans, Earth scenery, text, labels, diagrams.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, photograph, realistic, human, Earth, simple, blurry, low quality";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (identical to previous version) ... */
             if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (sin cambios estructurales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0; console.log("Scroll reset on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false;
             currentCivilizationTitle = null; // Reset chat context
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (identical to previous version) ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... (identical to previous version) ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios estructurales)
        function addChatMessage(message, sender) { /* ... (identical to previous version) ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... (identical to previous version) ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... (identical to previous version, uses fetchChatResponse) ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar alfabéticamente para consistencia
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» No hay registros en la base de datos galáctica «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Appended ${addedCount} new unique titles.`);
             filterTitles(searchInput.value); // Re-apply filter
         }

        // MODIFIED: handleTitleClick (context set to currentCivilizationTitle)
        async function handleTitleClick(title) {
            resetModalState(); // Includes resetting chat context
            showModal();
            modalTitle.textContent = title;
            currentCivilizationTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = ''; chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0; console.log("Scroll reset after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-pastafarianism placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización xeno-artística...</p>`; // Placeholder icon
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully."); placeholderDiv.remove(); imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => { showFullscreenImage(imgElement.src); });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title); placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { console.error("Could not create image URL for:", title); placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar datos.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // MODIFIED: handleGenerateMoreTitles (uses fetchGeneratedTitles requesting 40)
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             // Updated button text during loading
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Escaneando Sectores Lejanos...';
             try {
                 // This function now requests and processes ~40 titles
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se detectaron nuevas señales de civilización en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al explorar nuevos sectores: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                  // Updated button text after completion
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Nuevos Sectores (40)';
             }
         }

         // Search Filter Function (Added normalization)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (sin cambios estructurales)
        function initApp() {
            // Ensure all elements exist... (same checks as before)
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) { console.error("Initialization failed: Missing essential elements."); document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">++ ERROR CATASTRÓFICO: Falta de Componentes de Interfaz ++ Contactar Soporte Técnico Galáctico ++</p>'; return; }

            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            console.log("Xeno-Archivo Inicializado. Número de registros iniciales:", predefinedTitles.length);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>