<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorando la Cultura Japonesa</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <!-- Podría añadirse Noto Serif JP: <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet"> -->
    <style>
        /* --- Estilos Adaptados para Cultura Japonesa --- */
        :root {
            --color-primary: #B71C1C; /* Rojo oscuro, como laca o torii */
            --color-secondary: #6D6D6D; /* Gris neutro, piedra/madera */
            --color-background: #F8F8F4; /* Blanco roto / Beige muy claro, papel */
            --color-text: #333333; /* Negro/Gris muy oscuro para texto */
            --color-text-muted: #757575; /* Gris medio */
            --color-modal-bg: #FFFFFF; /* Blanco limpio para modal */
            --color-border: #E0E0E0; /* Borde gris claro */
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.08), 0 1px 2px -1px rgb(0 0 0 / 0.05); /* Sombras sutiles */
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.08), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.08), 0 4px 6px -4px rgb(0 0 0 / 0.05);
            --border-radius: 5px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; } /* O 'Noto Serif JP' si se importa */
        h1.logo, h1.page-title { color: var(--color-primary); }
        h2.section-title, #modal-title { color: var(--color-text); }
        h2.section-title { border-bottom: 2px solid var(--color-primary); padding-bottom: 0.5rem; display: inline-block; }
        #modal-title { color: var(--color-primary); }
        .navbar { background-color: rgba(255, 255, 255, 0.9); /* Blanco semi-transparente */ backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.5rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Lato', sans-serif; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f5f5f5; }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #9a1515; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #bdbdbd; color: var(--color-text-muted); cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(51, 51, 51, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 2rem 2.5rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 350px; /* Altura mínima para pantalla de carga */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--color-border);
        }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: #e0e0e0; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; }
        #modal-title { font-size: 1.8rem; /* Título modal claro */ text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }
        #modal-content {
            line-height: 1.8;
            color: var(--color-text);
            white-space: normal;
            overflow-y: auto;
            padding: 0 10px 1.5rem 10px; /* Padding inferior para espacio después de imagen */
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) var(--color-border); /* Scrollbar temático */
        }
        #modal-content::-webkit-scrollbar { width: 10px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; /* O 'Noto Serif JP' */ margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: bold; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-text); }
        #modal-content h4 { font-size: 1.15em; color: var(--color-text-muted); border-bottom: none; }
        /* Estilo para la imagen insertada al final del contenido */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: var(--color-background); /* Fondo suave por si la imagen es transparente */ }
        /* Estilo para el placeholder/spinner de la imagen final */
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); /* Fondo de carga claro */ display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid #e0e0e0; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.3rem; font-family: 'Lato'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #ffcdd2; /* Fondo error rojo claro */ color: #b71c1c; /* Texto rojo oscuro */ padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #ef9a9a; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex justify-center items-center">
             <div class="flex items-center text-center">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-torii-gate mr-3"></i> <!-- Icono Torii -->
                     Explorando Japón
                     <i class="fas fa-fan ml-3"></i> <!-- Icono Abanico -->
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Un Viaje por la Cultura Japonesa</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto">Descubre la riqueza y diversidad de Japón: desde sus antiguas tradiciones hasta su vibrante presente. Selecciona un tema para comenzar tu exploración.</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-red-800 mr-2"></i> <!-- Icono Libro -->
                 Temas Culturales
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Consultando archivos ancestrales...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Temas
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Investigando pergaminos...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - La imagen se añadirá aquí al final -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                     <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-600 py-6 mt-12 border-t border-gray-300">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Contenido generado por IA con fines informativos y educativos sobre la cultura japonesa.</p>
              <p class="mt-1">La cultura es compleja y diversa; esta es solo una introducción.</p>
              <p class="mt-2">© 2025 Explorando Japón</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // HISTORIA
            "Periodo Jomon: Los Orígenes Prehistóricos de Japón", "La Cultura Yayoi y la Introducción del Arroz", "Kofun: Las Grandes Tumbas y el Poder Centralizado", "El Periodo Asuka: La Llegada del Budismo y la Influencia China", "Nara: La Primera Capital Permanente y el Esplendor Budista", "La Era Heian: Refinamiento, Cortesanos y el Nacimiento de la Literatura Clásica", "El Ascenso de los Samuráis y el Shogunato Kamakura", "Guerras Civiles del Periodo Muromachi (Ashikaga)", "Sengoku Jidai: La Era de los Estados Combatientes", "Oda Nobunaga: El Primer Gran Unificador", "Toyotomi Hideyoshi: Completando la Unificación", "Tokugawa Ieyasu y el Establecimiento del Shogunato Edo", "El Periodo Edo: Paz, Aislamiento (Sakoku) y Cultura Urbana", "La Llegada del Comodoro Perry y el Fin del Aislamiento", "La Restauración Meiji: Modernización y Occidentalización", "Guerra Ruso-Japonesa: Japón como Potencia Mundial", "La Era Taisho: Democracia y Liberalismo Efímeros", "Expansionismo Japonés y la Segunda Guerra Mundial en Asia", "La Ocupación Estadounidense de Japón Post-WWII", "El Milagro Económico Japonés de Posguerra", "La Era Heisei: Estancamiento Económico y Cambios Sociales", "Japón en el Siglo XXI: Desafíos y Transformaciones (Era Reiwa)", "Mitos Fundacionales de Japón: Amaterasu y la Familia Imperial", "Relaciones Históricas entre Japón, China y Corea", "Historia de Okinawa y el Reino Ryukyu", "El Papel del Emperador a lo Largo de la Historia Japonesa", "La figura del Shogun: Poder Militar y Político", "Los Daimyo: Señores Feudales y su Poder Regional", "Historia de los Ninjas: Realidad vs. Ficción", "Los Ronin: Samuráis sin Señor", "Rebeliones Campesinas (Ikki) en la Historia Japonesa", "El impacto de los Desastres Naturales (Terremotos, Tifones) en Japón",
            // RELIGIÓN Y FILOSOFÍA
            "Sintoísmo (Shinto): La Vía de los Kami", "Concepto de Kami: Deidades y Espíritus Naturales", "Santuarios Sintoístas (Jinja): Arquitectura y Rituales", "Rituales Sintoístas: Purificación (Misogi, Harae), Oraciones (Norito)", "Festivales Sintoístas (Matsuri): Celebración Comunitaria", "Omikuji y Ema: Prácticas Populares en Santuarios", "El Budismo en Japón: Introducción y Escuelas Principales", "Budismo Zen: Meditación (Zazen), Koans y Satori", "La Influencia del Zen en las Artes Marciales y la Estética", "Budismo de la Tierra Pura (Jodo Shu, Jodo Shinshu): Fe y Salvación", "Budismo Nichiren: El Sutra del Loto", "Templos Budistas (Tera): Estructura y Significado", "Estatuaria Budista Japonesa: Iconografía y Estilos", "El Sincretismo Shinto-Budista (Shinbutsu-shūgō)", "Confucianismo y su Impacto en la Ética y Sociedad Japonesa", "Bushido: El Código del Samurái, ¿Mito o Realidad?", "Concepto de 'Wa' (Armonía) en la Sociedad Japonesa", "El concepto de 'Ma' (Espacio Negativo, Intervalo)", "Wabi-Sabi: La Belleza de la Imperfección y la Impermanencia", "Mono no Aware: La Sensibilidad hacia lo Efímero", "Ikigai: Encontrando el Propósito en la Vida", "Ganbaru: El Espíritu de Esfuerzo y Perseverancia", "Shikata ga nai: La Aceptación de lo Inevitable", "El concepto de 'Uchi' (Dentro) y 'Soto' (Fuera)", "Nuevas Religiones Japonesas (Shinshūkyō)", "Filosofía de la Escuela de Kioto (Nishida Kitaro)",
            // ARTES TRADICIONALES Y ARTESANÍA
            "Ukiyo-e: Grabados del Mundo Flotante (Hokusai, Hiroshige)", "Pintura Sumi-e: El Arte de la Tinta China", "Yamato-e: Pintura Narrativa Japonesa Clásica", "Escuela Kanō de Pintura", "Escuela Rinpa: Estilo Decorativo y Audaz", "Shodo: El Arte de la Caligrafía Japonesa", "Cerámica Japonesa: Estilos Famosos (Raku, Bizen, Arita, Kutani)", "La Ceremonia del Té (Chanoyu / Sado): Ritual y Estética", "Utensilios de la Ceremonia del Té (Chawan, Chasen, Natsume)", "Ikebana / Kado: El Arte del Arreglo Floral Japonés", "Origami: El Arte del Plegado de Papel", "Bunraku: Teatro de Marionetas Tradicional", "Kabuki: Teatro Dramático, Maquillaje y Vestuario", "Noh: Teatro Clásico Japonés, Máscaras y Movimiento Lento", "Kyogen: Interludios Cómicos del Teatro Noh", "Gagaku: Música y Danza de la Corte Imperial", "Instrumentos Musicales Tradicionales (Shamisen, Koto, Shakuhachi, Taiko)", "Lacquerware (Urushi / Shikki): El Arte de la Laca Japonesa", "Maki-e: Decoración con Polvo de Oro en Laca", "Trabajo en Metal Japonés (Espadas, Armaduras, Tsuba)", "Fabricación de Espadas Japonesas (Katana): Proceso y Misticismo", "Textiles Japoneses: Kimono, Yukata, Obi", "Técnicas de Teñido: Shibori, Yuzen", "Aizome: El Arte del Teñido Índigo Japonés", "Kintsugi: Reparar Cerámica con Oro, Abrazando la Historia", "Jardines Japoneses: Principios y Tipos (Zen, Paseo, Té)", "Elementos Clave de un Jardín Japonés (Piedras, Agua, Linternas)", "Arquitectura Tradicional Japonesa: Templos y Santuarios", "Castillos Japoneses (Shiro): Historia y Diseño", "Casas Tradicionales Japonesas (Minka)", "Shoji y Fusuma: Puertas y Paneles Deslizantes", "Tatami: Esteras Tradicionales y su Uso", "Tokonoma: El Nicho Decorativo en la Habitación Japonesa", "Chashitsu: La Arquitectura de la Casa de Té", "Netsuke: Esculturas en Miniatura", "Abanicos Japoneses (Sensu, Uchiwa): Arte y Función", "Máscaras Japonesas: Noh, Kabuki, Festivales", "Muñecas Japonesas Tradicionales (Hina, Kokeshi)", "El Arte del Bonsái", "Suiseki: El Arte de la Contemplación de Piedras",
            // LITERATURA, MANGA Y ANIME
            "El Cuento de Genji (Genji Monogatari): La Primera Novela del Mundo", "El Libro de la Almohada (Makura no Soshi) de Sei Shōnagon", "Poesía Clásica Japonesa: Waka y Tanka", "Haiku: La Esencia de la Poesía Japonesa (Bashō, Issa)", "Literatura del Periodo Edo: Ihara Saikaku y Chikamatsu Monzaemon", "Escritores de la Era Meiji: Natsume Sōseki, Mori Ōgai", "El Grupo Shirakaba y el Idealismo Taisho", "Premios Nobel de Literatura Japoneses (Kawabata, Ōe)", "Yukio Mishima: Vida, Obra y Controversia", "Haruki Murakami: Realismo Mágico y Fama Global", "Autores Contemporáneos Japoneses (Banana Yoshimoto, Kazuo Ishiguro - japonés-británico)", "Literatura Femenina Japonesa: Clásica y Contemporánea", "Manga: Historia y Evolución del Cómic Japonés", "Osamu Tezuka: El 'Dios del Manga'", "Géneros del Manga: Shonen, Shojo, Seinen, Josei, Kodomomuke", "La Influencia Global del Manga", "Anime: Historia y Desarrollo de la Animación Japonesa", "Studio Ghibli: Hayao Miyazaki y Isao Takahata", "Películas Clave de Anime (Akira, Ghost in the Shell, Your Name)", "Series Icónicas de Anime (Dragon Ball, Sailor Moon, Evangelion)", "Géneros del Anime: Mecha, Magical Girl, Isekai, Slice of Life", "Seiyū: Los Actores de Voz en el Anime", "Cosplay: La Cultura de Disfrazarse de Personajes", "Convenciones de Manga y Anime (Comiket)", "Light Novels (Novelas Ligeras): Origen y Popularidad", "Rakugo: Cuentacuentos Cómico Tradicional", "Kamishibai: Teatro de Papel Callejero",
            // GASTRONOMÍA
            "Washoku: La Comida Tradicional Japonesa (Patrimonio UNESCO)", "Arroz Japonés (Gohan): Base de la Dieta", "Sushi: Historia, Tipos y Etiqueta", "Sashimi: Pescado Crudo y su Presentación", "Ramen: Variedades Regionales de Fideos en Caldo", "Udon y Soba: Otros Fideos Japoneses Populares", "Tempura: Fritura Ligera de Mariscos y Vegetales", "Yakitori: Brochetas de Pollo a la Parrilla", "Okonomiyaki y Monjayaki: 'Tortillas' Japonesas", "Takoyaki: Bolas de Pulpo", "Kaiseki Ryori: Alta Cocina Japonesa de Varios Platos", "Shabu-Shabu y Sukiyaki: Hot Pot Japonés", "Donburi: Cuencos de Arroz con Ingredientes Encima", "Curry Japonés (Karē Raisu): Un Plato Adaptado", "Onigiri: Bolas de Arroz Rellenas", "Miso Soup (Misoshiru): Sopa Fermentada de Soja", "Tsukemono: Encurtidos Japoneses", "Tofu y Productos de Soja (Natto, Edamame)", "Wagashi: Dulces Tradicionales Japoneses", "Mochi: Pastel de Arroz Glutinoso", "Matcha: Té Verde en Polvo y su Uso Cultural", "Sake: La Bebida Alcohólica de Arroz Japonesa", "Shochu y Umeshu: Otras Bebidas Alcohólicas Populares", "Cerveza Japonesa: Historia y Marcas", "La Estética en la Presentación de la Comida Japonesa", "Bento: Cajas de Comida para Llevar", "Izakaya: Tabernas Japonesas y su Comida", "Mercados de Pescado en Japón (Tsukiji/Toyosu)", "Etiqueta en la Mesa Japonesa (Palillos, Sorber)", "Ingredientes Clave: Dashi, Soja, Mirin, Wasabi", "Agricultura Japonesa: Arrozales y Productos Locales",
            // SOCIEDAD Y COSTUMBRES
            "Estructura Familiar Japonesa (Ie) y sus Cambios", "Roles de Género Tradicionales y Actuales", "Sistema Educativo Japonés: Exámenes y Juku (Academias)", "Cultura Laboral Japonesa: Lealtad, Horas Extras (Karoshi)", "Jerarquía Social: Senpai-Kohai y Respeto a la Edad", "El Arte de Regalar (Omiyage, Ochugen, Oseibo)", "Etiqueta Japonesa: Saludos (Bowing), Intercambio de Tarjetas (Meishi)", "Quitarse los Zapatos: Costumbre en Hogares y Templos", "Baños Públicos Japoneses (Sento) y Onsen (Aguas Termales)", "Festivales Japoneses (Matsuri): Tipos y Significado", "Obon: Festival de los Antepasados", "Año Nuevo Japonés (Shogatsu): Tradiciones y Comida", "Hanami: La Contemplación de los Cerezos en Flor (Sakura)", "Golden Week: Semana de Vacaciones en Japón", "Ceremonias de Mayoría de Edad (Seijin no Hi)", "Bodas Japonesas: Tradicionales (Shinto) y Modernas", "Funerales Japoneses: Ritos Budistas Comunes", "Pachinko: Salones de Juego y su Cultura", "Karaoke: Origen y Popularidad", "Geishas y Maikos: Arte, Tradición y Malentendidos", "El Sistema de Escritura Japonés: Kanji, Hiragana, Katakana", "El Idioma Japonés: Gramática Básica y Cortesía (Keigo)", "Dialectos Japoneses (Ej: Kansai-ben)", "Transporte en Japón: El Eficiente Sistema de Trenes (Shinkansen)", "Vivienda en Japón: Apartamentos Urbanos vs. Casas Rurales", "Crimen y Seguridad en Japón: Tasas Bajas", "El Envejecimiento de la Población Japonesa", "Inmigración y Diversidad en Japón", "Actitudes hacia los Extranjeros (Gaijin)", "Grupos Minoritarios en Japón (Ainu, Zainichi)", "Movimientos Sociales y Activismo en Japón", "La Familia Imperial Japonesa Actual", "Moda Japonesa: Del Kimono a Harajuku", "Estilos Callejeros de Harajuku (Lolita, Decora, Gyaru)", "Kawaii: La Cultura de lo 'Lindo' o 'Adorable'", "Idols Japoneses: Grupos de Música Pop y su Fandom", "J-Pop y J-Rock: Escena Musical Japonesa", "Cine Japonés: Directores Clásicos (Kurosawa, Ozu, Mizoguchi)", "Cine Japonés Contemporáneo", "Televisión Japonesa: Dramas (Dorama), Shows de Variedades", "Videojuegos Japoneses: Nintendo, Sony, Sega y su Impacto Global", "Tecnología e Innovación en Japón (Robótica, Electrónica)", "Máquinas Expendedoras (Jidohanbaiki): Omnipresencia y Variedad", "Cultura del Manga Café y Capsule Hotels", "Yakuza: El Crimen Organizado Japonés", "Medios de Comunicación en Japón", "El concepto de 'Honne' (Sentimientos Reales) y 'Tatemae' (Fachada Pública)", "Aizuchi: Las Interjecciones de Escucha Activa", "Nomikai: Reuniones Sociales después del Trabajo",
            // ARTES MARCIALES
            "Sumo: El Deporte Nacional de Japón, Historia y Rituales", "Karate: Origen Okinawense y Estilos Principales", "Judo: El 'Camino de la Flexibilidad' (Jigoro Kano)", "Kendo: El 'Camino de la Espada', Esgrima con Bambú", "Aikido: El 'Camino de la Armonía Espiritual' (Morihei Ueshiba)", "Kyudo: El 'Camino del Arco', Arquería Japonesa", "Iaido: El Arte de Desenvainar la Espada", "Ninjutsu: ¿Arte Marcial o Espionaje?", "Dojos: Lugares de Entrenamiento Marcial", "Filosofía en las Artes Marciales Japonesas",
            // GEOGRAFÍA Y NATURALEZA
            "Geografía Física de Japón: Archipiélago Montañoso", "El Monte Fuji (Fujisan): Símbolo Nacional y Volcán Sagrado", "Las Cuatro Estaciones en Japón y su Impacto Cultural", "La Importancia de los Cerezos en Flor (Sakura)", "Momijigari: La Contemplación de las Hojas de Otoño", "Regiones de Japón: Hokkaido, Tohoku, Kanto, Chubu, Kansai, Chugoku, Shikoku, Kyushu, Okinawa", "Parques Nacionales de Japón", "Fauna y Flora Endémica de Japón", "La Relación Japonesa con el Mar", "Impacto Ambiental y Esfuerzos de Conservación en Japón"
        ];
        const japaneseCultureThemes = [
            "historia japonesa", "periodo Edo", "samuráis y bushido", "religión sintoísta", "budismo zen", "festivales japoneses (matsuri)", "arte ukiyo-e", "caligrafía shodo", "ceremonia del té (chanoyu)", "jardines japoneses", "arquitectura tradicional", "teatro kabuki y noh", "literatura clásica japonesa", "haiku", "manga y anime", "studio ghibli", "cultura pop (kawaii, J-Pop)", "gastronomía (sushi, ramen)", "kimono y moda tradicional", "artes marciales (karate, judo, sumo)", "sociedad y etiqueta japonesa", "filosofía (wabi-sabi, ikigai)", "tecnología e innovación", "geografía y naturaleza (Monte Fuji, sakura)", "idioma japonés"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un erudito y divulgador cultural especializado en Japón, con profundo conocimiento de su historia, arte, sociedad y tradiciones. Tu tarea es explicar temas de la cultura japonesa de forma exhaustiva, precisa, matizada y atractiva para un público general interesado. Proporciona contexto histórico, describe las prácticas o conceptos clave, analiza su significado cultural y relevancia (pasada y presente). Utiliza un lenguaje claro y respetuoso, evitando generalizaciones excesivas. Estructura la explicación lógicamente usando párrafos y subtítulos (markdown #, ##, ###). El objetivo es una exposición detallada de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tema o concepto de la cultura japonesa:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador conciso de temas para una enciclopedia cultural. Genera exactamente 15 temas, preguntas o conceptos clave sobre la cultura japonesa (historia, arte, sociedad, religión, etc.), adecuados para ser explicados detalladamente. Devuelve *solo* la lista de temas/preguntas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (sin cambios en IDs)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Contenedor de texto + imagen
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) { /* ... Sin cambios ... */
            const encodedPrompt = encodeURIComponent(prompt);
            const encodedSystem = encodeURIComponent(config.systemPrompt);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo.`);
                throw new Error(`Error de comunicación con la API: ${error.message}`);
            }
        }
        async function fetchExplanationText(conceptTitle) { /* ... Sin cambios ... */
            const text = await fetchTextFromApi(conceptTitle, textApiConfig);
             if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de")) {
                  throw new Error("La IA no pudo generar una explicación adecuada o suficientemente detallada para este tema.");
              }
            return text;
        }
        async function fetchGeneratedTitles() { /* ... Sin cambios ... */
            const randomTheme = getRandomElement(japaneseCultureThemes) || "aspectos de la cultura japonesa";
            const specificPrompt = `Genera 15 temas o preguntas clave sobre ${randomTheme}`;
            console.log("Generating titles with prompt:", specificPrompt);
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
            const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150);
            if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de temas.");
            return titles.slice(0, 15);
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a CULTURA JAPONESA
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "traditional japanese art";
            // Prompt ENFOCADO en estética japonesa, sin texto.
            const enhancedPrompt = `Artistic visualization inspired by the Japanese concept or element: '${safePromptText}'. Serene traditional Japanese aesthetic OR dynamic modern Japanese style. Focus on symbolic elements, nature, architecture, patterns, or abstract concepts relevant to the topic. Minimalist or detailed as appropriate. Avoid text, labels, or diagrams.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            // NEGATIVE PROMPT: Evitar texto, UI, fotos realistas, etc.
            const negativePrompt = "text, words, labels, letters, captions, writing, numbers, formulas, graphs, charts, diagrams, user interface, UI, menu, buttons, watermark, signature, multiple panels, collage, photograph, realistic photo, people posing, cartoon characters unless specifically requested (like anime concept), western architecture";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); // Keep just in case
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, '<br>');
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { /* ... Sin cambios ... */ if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { /* ... Sin cambios ... */
             if(!storyModal || !modalContent) return;
             storyModal.classList.remove('active');
             document.body.style.overflow = '';
             modalContent.scrollTop = 0; // Reset scroll
             console.log("Scroll set to 0 on hideModal");
             resetModalState();
         }
        function resetModalState() { /* ... Sin cambios ... */
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = ''; // Clear previous text and image
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { /* ... Sin cambios ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... Sin cambios ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... Sin cambios ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... Sin cambios ... */
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]);
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay temas disponibles.</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... Sin cambios ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        // *** handleTitleClick con lógica de imagen embebida *** (Sin cambios funcionales respecto a la versión anterior)
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // 1. Fetch and format text
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // 2. Stop loading indicator, display text FIRST
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                // 3. RESET SCROLL after text content is visible
                modalContent.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // 4. Prepare and append image placeholder/spinner WITHIN #modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-palette placeholder-icon"></i> <!-- Icono Arte/Visual -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visión conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // 5. Create and append the actual image element (starts loading)
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none'; // Hide until loaded

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-image-slash placeholder-icon"></i> <!-- Icono Imagen Rota -->
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">No se pudo cargar la imagen.</p>
                    `;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">Error al generar URL de imagen.</p>
                    `;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
            }
        }

        async function handleGenerateMoreTitles() { /* ... Sin cambios funcionales ... */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Descubriendo...'; // Thematic text
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block';
                 } else {
                     alert("No se pudieron descubrir más temas en este momento."); // Thematic text
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al descubrir temas: ${error.message}`); // Thematic text
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Temas'; // Thematic text
             }
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p style="color: #B71C1C; font-size: 2em; text-align: center; padding-top: 5em;">Error al cargar el dojo digital. Por favor, recarga la página.</p>'; return; } // Thematic error
             modalCloseBtn.addEventListener('click', hideModal);
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             displayTitles(predefinedTitles);
         }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>