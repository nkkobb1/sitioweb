<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secretos del Ilusionismo Básico - Guía Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Elegantes/Misteriosas -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Ilusionismo --- */
        :root {
            --color-primary: #a855f7; /* Púrpura Mágico */
            --color-secondary: #facc15; /* Dorado */
            --color-tertiary: #dc2626; /* Rojo Intenso (Cortina/Detalle) */
            --color-background: #1f2937; /* Gris Azulado Muy Oscuro */
            --color-text: #f3f4f6; /* Gris Muy Claro */
            --color-text-muted: #9ca3af; /* Gris Medio */
            --color-modal-bg: #374151; /* Gris Oscuro */
            --color-border: #4b5563; /* Borde Gris Medio-Oscuro */
            --color-error-bg: #450a0a; /* Fondo error rojo muy oscuro */
            --color-error-text: #fecaca; /* Texto error rojo claro */
            --color-error-border: #ef4444; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(250, 204, 21, 0.1); /* Sombra dorada sutil */
            --shadow-md: 0 4px 6px -1px rgba(250, 204, 21, 0.15), 0 2px 4px -2px rgba(250, 204, 21, 0.1);
            --shadow-lg: 0 0 25px -5px rgba(168, 85, 247, 0.3), 0 8px 10px -6px rgba(168, 85, 247, 0.2); /* Sombra púrpura */
            --border-radius: 5px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Playfair Display', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-secondary); text-shadow: 0 0 8px rgba(250, 204, 21, 0.6); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 6px rgba(168, 85, 247, 0.5); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; text-shadow: 0 0 4px rgba(250, 204, 21, 0.5); }
        .navbar { background-color: rgba(31, 41, 55, 0.85); backdrop-filter: blur(7px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(55, 65, 81, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-secondary); box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.25); outline: none; background-color: #4b5563; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-secondary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Lato'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-4px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-secondary); background-color: #4b5563; border-left-color: var(--color-secondary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-tertiary)); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Playfair Display', serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-tertiary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; text-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.92); backdrop-filter: blur(3px); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Increased min-height for game visibility */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-tertiary); color: white; transform: rotate(90deg); box-shadow: 0 0 10px var(--color-tertiary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* --- Loading Overlay --- */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(31, 41, 55, 0.98); /* Dark overlay */
            display: none; /* Initially hidden, shown via JS */
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius); padding: 2rem;
            text-align: center; color: var(--color-text);
        }
        #modal-loading.active { display: flex; } /* Class to show loading */
        #loading-game-container { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 500px; margin-top: 1rem;}
        #game-info { margin-bottom: 1rem; font-size: 1.1em; font-family: 'Lato'; }
        #game-info span { color: var(--color-secondary); font-weight: 700; }
        #game-board { display: grid; gap: 10px; margin-bottom: 1.5rem; }
        .card {
            width: 60px; height: 90px; background-color: var(--color-primary); color: var(--color-secondary);
            border: 1px solid var(--color-secondary); border-radius: 5px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.2em; font-family: 'Playfair Display', serif; cursor: pointer;
            position: relative; perspective: 1000px;
            transition: transform 0.6s; transform-style: preserve-3d;
        }
        .card .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 5px; }
        .card .card-front { background-color: #f3f4f6; color: var(--color-background); transform: rotateY(180deg); } /* Card face color */
        .card .card-back { background: linear-gradient(135deg, var(--color-primary), #6d28d9); /* Gradient back */ }
        .card.is-flipped { transform: rotateY(180deg); }
        .card.is-matched { border-color: var(--color-tertiary); cursor: default; opacity: 0.7; }
        #loading-message { margin-top: 1rem; font-size: 1.1em; font-style: italic; color: var(--color-text-muted); }

        /* --- Main Content Area (after loading) --- */
        #modal-story-content-area { /* Wrapper for scrollable text and fixed chat */
             flex-grow: 1; min-height: 0; display: flex; flex-direction: column;
             /* Hide initially, show after load */
             visibility: hidden; opacity: 0; transition: visibility 0s 0.3s, opacity 0.3s linear;
        }
        #modal-story-content-area.visible { visibility: visible; opacity: 1; transition-delay: 0s; }

        #modal-content-area { /* Scrollable text/image area */
            flex-grow: 1; min-height: 0; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(75, 85, 99, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(75, 85, 99, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }
        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 700; }
        #modal-content em { color: var(--color-primary); font-style: italic; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Playfair Display', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-primary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Image styles */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 2px solid var(--color-secondary); border-radius: var(--border-radius); box-shadow: 0 0 15px rgba(250, 204, 21, 0.3); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(75, 85, 99, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(31, 41, 55, 0.7); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(75, 85, 99, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(75, 85, 99, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--color-secondary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #4b5563; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #4b5563; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-secondary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #fde047; /* Lighter gold */ }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; color: var(--color-primary); }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-secondary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-hat-wizard mr-3 text-purple-400"></i> <!-- Icono sombrero mago -->
                     Ilusionismo Básico
                 </h1>
             </div>
             <span class="text-sm text-gray-300 font-sans tracking-wider">~ Revelando los Secretos ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">El Arte del Engaño</h1>
             <p class="text-xl text-gray-200 mb-8 max-w-3xl mx-auto font-light">Descubre los fundamentos del ilusionismo. Aprende trucos sencillos con cartas, monedas y objetos cotidianos para asombrar a tu público.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar un truco o concepto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-sparkles text-purple-400 mr-2"></i> <!-- Icono libro mágico -->
                 Repertorio de Trucos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Consultando el grimorio...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">~ Ningún secreto encontrado con ese nombre ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar Más Secretos (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Overlay with Game -->
             <div id="modal-loading">
                 <div id="loading-game-container">
                      <div id="game-info">Nivel: <span id="game-level">1</span> | Pares Encontrados: <span id="game-matches">0</span> / <span id="game-total-pairs">0</span></div>
                      <div id="game-board">
                          <!-- Cards will be generated here by JS -->
                      </div>
                      <button id="reset-game-btn" style="padding: 5px 10px; background-color: var(--color-secondary); color: var(--color-background); border:none; border-radius: 4px; cursor: pointer; font-family: Lato; margin-top: -10px; margin-bottom: 15px;">Reiniciar Juego</button>
                 </div>
                 <p id="loading-message">Mientras preparamos el escenario... ¡prueba tu memoria!</p>
             </div>

             <!-- Content Area Wrapper (Initially Hidden) -->
             <div id="modal-story-content-area">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder added via JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al maestro...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este truco...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Truco">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-800 text-gray-400 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA con fines educativos y de entretenimiento sobre ilusionismo básico.</p>
              <p class="mt-1">La práctica constante y una buena presentación son la clave del éxito.</p>
              <p class="mt-2">© <span id="year"></span> Academia de Ilusionistas Digitales</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Cartomagia Básica
            "El Forzaje Clásico (Classic Force)", "El Forzaje Hindú (Hindu Shuffle Force)", "El Forzaje por Corte (Cut Deeper Force)", "El Forzaje por Riffle (Riffle Force)", "Control de Carta: Doble Corte (Double Undercut)", "Control de Carta: Pasar la Carta (Pass - Básico)", "Control de Carta: Mezcla Hindú (Hindu Shuffle Control)", "La Carta Llave (Key Card Principle)", "Revelación Simple: La Carta Volteada", "Revelación Simple: La Carta Ascendente (Ambitious Card - Nivel 0)", "Revelación: Las Cartas Rojas y Negras (Out of This World - Simplificado)", "Floritura: El Abanico con Una Mano", "Floritura: El Abanico con Dos Manos", "Floritura: La Cascada (Simple Riffle Shuffle)", "Floritura: Corte Charlier (Básico)", "El Doble Lift (Double Lift - Introducción)", "El Cambio de Color Básico (Basic Color Change)", "Adivina la Carta del Espectador (Simple)", "Las Cuatro Cartas Viajeras (Simplificado)", "La Carta a Través del Pañuelo", "El Trile Clásico (Three Card Monte - Explicación Básica)", "Ordenación Mágica (Ases, Reyes, etc.)", "Carta Guía Telefónica", "El Reloj Mágico (Clock Trick)", "Carta en el Bolsillo (Básico)", "Predicción Simple con Cartas", "Carta Marcada (Concepto Básico)", "El Juego del Deletreo", "Carta en la Cartera (Preparación)", "Mezcla Falsa Simple (Reteniendo Arriba/Abajo)",
            // Numismagia Básica (Monedas)
            "Desaparición Simple de Moneda (Finger Palm Vanish)", "Desaparición Falsa (Fake Take Vanish)", "Aparición de Moneda desde la Mano Vacía", "El Empalme Clásico (Classic Palm)", "El Empalme de Dedos (Finger Palm)", "Producción de Monedas de la Nada (Simple)", "Moneda a Través de la Mesa (Básico)", "Moneda a Través de la Mano", "La Moneda Viajera (De una mano a otra)", "La Moneda Doblada (Gimmick)", "La Moneda Mordida (Gimmick)", "Multiplicación de Monedas (Básica, 2 a 4)", "Rutina Simple de Dos Monedas", "La Moneda en la Botella (Gimmick)", "El Cambio de Moneda (Cobre/Plata básico)", "Adivinación de Moneda (Cara o Cruz)", "Moneda Marcada (Concepto)", "Sonido de Moneda Falso (Click Pass Básico)", "La Cuchara Doblada (Concepto, relacionado)", "Equilibrio de Moneda en el Borde",
            // Magia con Cuerdas
            "El Corte y Restauración Simple de Cuerda", "Los Nudos Falsos", "El Nudo que Desaparece", "La Cuerda a Través del Cuello", "La Cuerda a Través del Dedo", "Las Tres Cuerdas Iguales (Professor's Nightmare - Básico)", "El Anillo en la Cuerda", "La Cuerda que se Estira", "Nudo Corredizo Mágico", "Unir dos Cuerdas Mágicamente",
            // Magia con Objetos Cotidianos
            "El Lápiz Flotante (Básico)", "El Lápiz a Través del Billete (Gimmick)", "La Goma Elástica que Salta de Dedos", "La Goma Elástica Rota y Restaurada", "Gomas Elásticas Enlazadas", "Desaparición de un Pañuelo (Simple)", "Aparición de un Pañuelo", "El Nudo en el Pañuelo que Desaparece", "El Azúcar que Desaparece", "La Servilleta Rota y Restaurada (Básico)", "El Huevo en la Bolsa (Concepto)", "El Vaso de Agua que no Cae", "Adivinar el Objeto Escondido (Simple)", "El Billete Flotante (Hilo Invisible - Básico)", "Cambio de Color de un Pañuelo (Simple)", "El Cubilete y la Bola (Cups & Balls - Movimiento Básico)", "El Clip Enganchado Mágicamente", "La Pajita Rota y Restaurada", "El Papel Roto y Recompuesto", "La Ceniza a Través de la Mano",
            // Mentalismo Básico
            "Predicción Simple con Números", "Adivinar un Dibujo Simple (One Ahead Principle)", "Forzaje Psicológico de un Número (1-4)", "Lectura en Frío (Cold Reading - Introducción)", "Lectura en Caliente (Hot Reading - Concepto)", "El Pico Central (Center Tear - Básico)", "Adivinar la Palabra de un Libro (Book Test - Simplificado)", "Influencia Sutil (Suggestión - Básico)", "Adivinar la Mano que Esconde la Moneda", "Sincronicidad Mágica (Dos espectadores eligen lo mismo)",
            // Principios Generales
            "El Arte de la Misdirection (Desvío de Atención)", "La Importancia de la Práctica", "Creando una Rutina Mágica", "El Patter: Qué Decir y Cuándo", "Control de la Audiencia (Manejo Básico)", "Ángulos de Visión: Cuidando lo que se Ve", "El Uso de Gimmicks (Objetos Trucados)", "Improvisación en Magia", "Construcción del Personaje Mágico", "Psicología del Engaño", "Ética en el Ilusionismo", "Historia Breve del Ilusionismo", "Tipos de Magia (Cerca, Salón, Escena)", "Cómo Manejar Errores Durante un Truco", "La Teoría Mágica Básica (Efecto vs Método)",
             // Más ideas para la lista exhaustiva
            "Carta Volteada en el Mazo", "Localización por Impulso (Carta)", "Transferencia de Tinta (Carta)", "Adivinar Número de Cartas Cortadas", "La Baraja Invisible (Concepto/Gimmick)", "Moneda Magnética (Concepto/Gimmick)", "Desaparición con Pañuelo (Moneda)", "Rutina 'Matrix' de Monedas (Ultra Básico)", "El Dedo Falso (Thumb Tip - Usos Básicos)", "Producción de Sal del Puño (Thumb Tip)", "Pañuelo que Cambia de Color (Dye Tube - Básico)", "La Cuerda Interminable (De la boca)", "Anillos Chinos (Enlace Básico)", "El Papel de Fumar Indio (Restauración)", "El Billete Roto y Recompuesto (Simple)", "Predicción con Pizarra Pequeña", "El Cubo de Rubik Mágico (Solución Instantánea - Gimmick)", "Adivinar el Color Elegido", "Telepatía con un Compañero (Código Básico)", "La Cuchara Pegada a la Nariz",
            // ... y seguir añadiendo conceptos básicos y nombres de trucos sencillos ...
        ];
        const magicThemes = [
            "trucos de cartas básicos", "magia con monedas fácil", "ilusionismo con cuerdas", "magia con objetos cotidianos", "mentalismo para principiantes", "principios de misdirection", "técnicas de empalme simples", "forzajes de cartas", "floritureas de cartas básicas", "gimmicks comunes en magia", "presentación en magia", "psicología del ilusionismo", "magia de cerca sencilla", "trucos de desaparición", "trucos de aparición", "magia con pañuelos", "nudos mágicos", "predicciones simples", "control de cartas básico"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un Mago Profesional y Maestro Ilusionista, experto en enseñar los fundamentos a aprendices. Explica el truco de magia básico o el principio de ilusionismo indicado de forma clara, detallada y motivadora. Describe: 1. El EFECTO (lo que ve el público). 2. El SECRETO (el método paso a paso, con lenguaje sencillo). 3. Puntos Clave (consejos de manejo, ángulos importantes). 4. Misdirection (dónde dirigir la atención). 5. Presentación y Patter (ideas sobre qué decir y cómo actuar). 6. Consejos de Práctica. Enfócate en la simplicidad y claridad para principiantes. El objetivo es una explicación útil y completa de aproximadamente 1200-1300 palabras. Basa tu lección únicamente en el siguiente truco o concepto:",
            timeoutSeconds: 180 // Aumentado ligeramente por si la explicación es compleja
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente del Mago Maestro, especializado únicamente en el truco de magia que se está mostrando. Responde preguntas de seguimiento sobre detalles del método, consejos de presentación, posibles problemas o variaciones sencillas de ese truco específico. Sé conciso, claro y mantente enfocado en el truco actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // *** PETICIÓN DE 40 TÍTULOS ***
            systemPrompt: "Actúa como un generador de ideas conciso para un libro de trucos de magia para principiantes. Genera exactamente 40 nombres evocadores de trucos de magia básicos (cartas, monedas, cuerdas, objetos, mentalismo) o principios fundamentales del ilusionismo. Devuelve *solo* la lista de nombres/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Más tiempo para generar más títulos
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que la versión anterior, pero añadiendo elementos del juego)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingOverlay = document.getElementById('modal-loading'); // El overlay completo
        const modalStoryContentArea = document.getElementById('modal-story-content-area'); // Wrapper contenido principal
        const modalTextArea = document.getElementById('modal-content-area'); // Área texto/imagen scrollable
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        const yearSpan = document.getElementById('year');
        // Game Elements
        const gameContainer = document.getElementById('loading-game-container');
        const gameBoard = document.getElementById('game-board');
        const gameLevelDisplay = document.getElementById('game-level');
        const gameMatchesDisplay = document.getElementById('game-matches');
        const gameTotalPairsDisplay = document.getElementById('game-total-pairs');
        const gameResetBtn = document.getElementById('reset-game-btn');
        const loadingMessage = document.getElementById('loading-message');


        // ========== State Variables ==========
        let currentMagicTrickTitle = null; // Contexto para chat
        // Game State
        let gameCards = []; // Array of card elements
        let gameFlippedCards = [];
        let gameMatchedPairs = 0;
        let gameCurrentLevel = 1;
        let gameTotalPairs = 0;
        let gameCanFlip = true;
        const gameSymbols = ['<i class="fas fa-heart text-red-500"></i>', '<i class="fas fa-diamond text-blue-500"></i>', '<i class="fas fa-club text-gray-800"></i>', '<i class="fas fa-spade text-gray-800"></i>', '<i class="fas fa-star text-yellow-400"></i>', '<i class="fas fa-hat-wizard text-purple-500"></i>', '<i class="fas fa-wand-magic-sparkles text-pink-500"></i>', '<i class="fas fa-dice text-green-500"></i>', '<i class="fas fa-key text-gray-400"></i>', '<i class="fas fa-question text-orange-500"></i>', '<i class="fas fa-rabbit text-white"></i>', '<i class="fas fa-dove text-blue-200"></i>']; // 12 symbols max for now
        const cardsPerLevel = [4, 6, 8, 10, 12]; // Pairs per level (max 5 levels)

        // ========== API FUNCTIONS ==========
        // fetchTextFromApi, fetchExplanationText, fetchChatResponse, fetchGeneratedTitles, createPollinationsImageUrl
        // (Adapt prompts inside the functions/configs as needed, function signatures remain the same)
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentMagicTrickTitle
                ? `Eres un asistente del Mago Maestro, especializado únicamente en el truco de magia '${currentMagicTrickTitle}'. Responde preguntas de seguimiento sobre detalles del método, consejos de presentación, posibles problemas o variaciones sencillas de ese truco específico. Sé conciso, claro y mantente enfocado en el truco actual.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            // *** Aumentar número de títulos solicitados ***
            const numTitles = config === titleGenerationConfig ? 40 : 1; // Pide 40 solo si es la config de generación
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (numTitles > 1) {
                // No hay un param estándar para num_results en esta API,
                // la IA debe entenderlo por el system prompt
                console.log(`Solicitando ${numTitles} títulos vía prompt.`);
            }
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) { throw new Error(`(Error ${response.status}) Nuestros servidores de magia están algo ocupados. Por favor, inténtalo de nuevo en unos instantes.`); }
                const text = await response.text();
                if (!text || text.trim().length === 0) { throw new Error("El grimorio devolvió una página en blanco. Intenta preguntar de otra forma."); }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') { throw new Error(`La conexión con el éter tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o espera un momento.`); }
                throw new Error(error.message || "Un hechizo inesperado interfirió con la comunicación.");
            }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentMagicTrickTitle) throw new Error("Error interno: No se ha establecido el contexto del truco para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(magicThemes) || "trucos de magia básicos variados";
             // El system prompt ya pide 40
             const specificPrompt = `Genera 40 nombres/conceptos de trucos de magia básicos sobre ${randomTheme}`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     // Esperamos 40, pero aceptamos si genera menos pero suficientes
                     if (titles.length < 15) throw new Error("La IA no reveló suficientes secretos esta vez.");
                     return titles.slice(0, 40); // Devolver hasta 40
                 });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "basic magic trick performance";
            const enhancedPrompt = `Conceptual artwork of a simple magic trick performance or illusion related to '${safePromptText}'. Focus on atmosphere, mystery, simple props (cards, coins, ropes, hat, wand). Avoid text, labels, diagrams. Elegant, slightly mysterious, theatrical lighting style.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, label, title, caption, diagram, chart, graph, instructions, tutorial, multiple hands, realistic photo, audience visible unless specified, boring, plain background, watermark, signature";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (No changes needed)
        function formatExplanationText(rawText) { /* ... (same as before) ... */
            if (!rawText) return ''; let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const ce = exponent.replace('−', '-'); return `${base}<sup>${ce}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingOverlay.classList.remove('active'); // Hide loading/game overlay
             modalStoryContentArea.classList.remove('visible'); // Hide content area
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentMagicTrickTitle = null;
             hideFullscreenImage();
             // Reset game state for next time
             gameCurrentLevel = 1;
             gameMatchedPairs = 0;
             gameFlippedCards = [];
             gameCanFlip = true;
             gameBoard.innerHTML = ''; // Clear game board
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (No changes needed)
        function showFullscreenImage(imgSrc) { /* ... (same as before) ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... (same as before) ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (No changes needed)
        function addChatMessage(message, sender) { /* ... (same as before) ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... (same as before) ... */ const errDiv = document.createElement('div'); errDiv.classList.add('chat-error'); errDiv.textContent = message; chatHistory.appendChild(errDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... (same as before) ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Asistente IA: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== LOADING SCREEN GAME FUNCTIONS ==========
        function createGameBoard() {
            gameBoard.innerHTML = ''; // Clear previous board
            gameMatchedPairs = 0;
            gameFlippedCards = [];
            gameCanFlip = true;
            gameTotalPairs = cardsPerLevel[gameCurrentLevel - 1];

            if (!gameTotalPairs) { // Handle case where level is too high
                console.error("Nivel de juego inválido o máximo alcanzado.");
                gameBoard.innerHTML = "<p>¡Has dominado el juego!</p>";
                loadingMessage.textContent = "¡Impresionante memoria!";
                return;
            }

            // Update UI
            gameLevelDisplay.textContent = gameCurrentLevel;
            gameMatchesDisplay.textContent = gameMatchedPairs;
            gameTotalPairsDisplay.textContent = gameTotalPairs;

            // Prepare card values
            let symbolsForLevel = shuffleArray(gameSymbols).slice(0, gameTotalPairs);
            let cardValues = shuffleArray([...symbolsForLevel, ...symbolsForLevel]);

            // Set grid columns based on number of cards
            let columns = Math.ceil(Math.sqrt(cardValues.length));
             if (cardValues.length === 12) columns = 4; // Specific layout for 12 cards (level 2)
             else if (cardValues.length === 20) columns = 5; // Specific layout for 20 cards (level 4)
             else if (cardValues.length === 24) columns = 6; // Specific layout for 24 cards (level 5)

            gameBoard.style.gridTemplateColumns = `repeat(${columns}, auto)`;

            // Create card elements
            gameCards = cardValues.map(value => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.dataset.value = value; // Store symbol in data attribute

                const cardBack = document.createElement('div');
                cardBack.classList.add('card-face', 'card-back');
                // Optional: Add a generic back symbol like a star or question mark
                cardBack.innerHTML = '<i class="fas fa-star"></i>';

                const cardFront = document.createElement('div');
                cardFront.classList.add('card-face', 'card-front');
                cardFront.innerHTML = value; // Display symbol on front

                card.appendChild(cardBack);
                card.appendChild(cardFront);

                card.addEventListener('click', handleCardClick);
                gameBoard.appendChild(card);
                return card;
            });
             loadingMessage.textContent = "Revelando el truco... ¡Encuentra los pares!";
        }

        function handleCardClick(event) {
            if (!gameCanFlip) return;
            const clickedCard = event.currentTarget;

            // Prevent clicking already flipped or matched cards
            if (clickedCard.classList.contains('is-flipped') || gameFlippedCards.length >= 2) {
                return;
            }

            clickedCard.classList.add('is-flipped');
            gameFlippedCards.push(clickedCard);

            if (gameFlippedCards.length === 2) {
                gameCanFlip = false; // Disable further flips temporarily
                checkForMatch();
            }
        }

        function checkForMatch() {
            const [card1, card2] = gameFlippedCards;
            const isMatch = card1.dataset.value === card2.dataset.value;

            if (isMatch) {
                // Match found
                card1.classList.add('is-matched');
                card2.classList.add('is-matched');
                gameMatchedPairs++;
                gameMatchesDisplay.textContent = gameMatchedPairs;
                gameFlippedCards = []; // Reset flipped cards array
                gameCanFlip = true; // Allow flipping again

                // Check for win condition
                if (gameMatchedPairs === gameTotalPairs) {
                    setTimeout(() => {
                        if (gameCurrentLevel < cardsPerLevel.length) {
                             gameCurrentLevel++;
                             createGameBoard(); // Start next level
                        } else {
                            // Max level reached
                            loadingMessage.textContent = "¡Memoria Prodigiosa! Preparando el acto final...";
                            gameBoard.innerHTML = "<p>¡Nivel Maestro!</p>";
                        }
                    }, 1000); // Short delay before next level/win message
                }
            } else {
                // No match
                setTimeout(() => {
                    card1.classList.remove('is-flipped');
                    card2.classList.remove('is-flipped');
                    gameFlippedCards = []; // Reset flipped cards array
                    gameCanFlip = true; // Allow flipping again
                }, 1200); // Delay before flipping back non-matches
            }
        }
        function resetGame() {
            gameCurrentLevel = 1;
            createGameBoard();
        }


        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
            if (!titleListContainer || !titlesLoading) return;
            const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); // Keep sorted
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">~ El grimorio parece vacío por ahora ~</p>'; return; }
            sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
        }
        function appendTitles(newTitles) { // Handles potentially 40 titles
            if (!titleListContainer || !newTitles || newTitles.length === 0) return;
            const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
            let addedCount = 0;
            newTitles.forEach(title => {
                if (!existingTitles.has(title)) {
                    titleListContainer.appendChild(createTitleItem(title));
                    addedCount++;
                }
            });
            console.log(`Added ${addedCount} new unique titles.`);
            filterTitles(searchInput.value); // Re-apply filter
        }

        // *** MODIFIED: handleTitleClick to integrate loading game ***
        async function handleTitleClick(title) {
            resetModalState(); // Resets general state, including game board
            showModal();
            modalTitle.textContent = title;
            currentMagicTrickTitle = title; // Set chat context
            modalError.classList.add('content-hidden');

            // *** START LOADING & GAME ***
            modalLoadingOverlay.classList.add('active'); // Show loading overlay
            modalStoryContentArea.classList.remove('visible'); // Ensure content is hidden
            createGameBoard(); // Initialize and display the memory game

            try {
                // Fetch explanation in the background while game is played
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // *** API FINISHED - HIDE GAME, SHOW CONTENT ***
                modalLoadingOverlay.classList.remove('active'); // Hide loading overlay (and game)
                modalContent.innerHTML = formattedExplanation; // Add text first
                modalStoryContentArea.classList.add('visible'); // Show the main content area smoothly
                chatSection.classList.remove('content-hidden'); // Ensure chat is visible

                modalTextArea.scrollTop = 0; // Reset text area scroll AFTER content is visible
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder WITHIN modalContent
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Creando ilusión visual...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">La ilusión visual falló.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                    console.error("Could not create image URL for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                 // *** API FAILED - HIDE GAME, SHOW ERROR ***
                modalLoadingOverlay.classList.remove('active'); // Hide loading overlay
                modalErrorMessage.textContent = error.message || "Un error desconocido interrumpió el acto.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.add('visible'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden'); // Hide chat on main error
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando el éter...';
             try {
                 // fetchGeneratedTitles already configured to request 40
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     appendTitles(newTitles); // Append the new titles
                     console.log(`Attempted to add up to ${newTitles.length} titles.`);
                 } else {
                     alert("No se pudieron revelar más secretos en este momento.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al revelar secretos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Revelar Más Secretos (40)';
             }
         }

         // Search Filter Function (minor improvement for accents)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check all essential elements, including game elements
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalLoadingOverlay || !gameBoard || !gameResetBtn) {
                console.error("Initialization failed: Missing essential UI or Game elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡Abracadabra Fallido! Faltan componentes esenciales de la interfaz.</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Game Reset Listener
             gameResetBtn.addEventListener('click', resetGame);

            // Initial display
            if (yearSpan) yearSpan.textContent = new Date().getFullYear(); // Set current year in footer
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>