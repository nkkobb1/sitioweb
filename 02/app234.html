<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sabiduría Hindú - Enciclopedia Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Elegantes y Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Sabiduría Hindú --- */
        :root {
            --color-primary: #FF9933; /* Azafrán/Naranja */
            --color-secondary: #FFC72C; /* Dorado/Amarillo */
            --color-tertiary: #138808; /* Verde (Naturaleza/Vida) */
            --color-accent: #000080; /* Azul Marino (Vishnu/Krishna) */
            --color-background: #FFF8DC; /* Blanco Crema/Marfil */
            --color-text: #4A2C2A; /* Marrón Oscuro Terroso */
            --color-text-muted: #8B4513; /* Marrón Siena */
            --color-modal-bg: #FFFFFF; /* Blanco Puro */
            --color-border: #E0CBA8; /* Borde Crema/Beige */
            --color-error-bg: #fceded; /* Fondo error rosa muy claro */
            --color-error-text: #8b0000; /* Texto error rojo oscuro */
            --color-error-border: #f7a7a7; /* Borde error rosa */

            --shadow-sm: 0 2px 4px 0 rgba(139, 69, 19, 0.1);
            --shadow-md: 0 4px 8px -1px rgba(139, 69, 19, 0.15), 0 2px 4px -2px rgba(139, 69, 19, 0.1);
            --shadow-lg: 0 10px 20px -5px rgba(139, 69, 19, 0.2), 0 8px 10px -6px rgba(139, 69, 19, 0.15);
            --border-radius: 5px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        h1, h2, h3, h4, .logo, button, input::placeholder { font-family: 'Poppins', sans-serif; }
        .logo { color: var(--color-primary); font-weight: 700; }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 500; }
        #modal-title { color: var(--color-accent); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); }
        #search-input::placeholder { color: var(--color-text-muted); font-weight: 400; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(255, 153, 51, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Poppins'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #fffaf0; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Poppins', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        #generate-more-btn:hover:not(:disabled) { background: #e68a00; box-shadow: var(--shadow-md); transform: translateY(-2px); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(74, 44, 42, 0.85); /* Overlay Marrón Translúcido */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Más altura para juego/chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área Contenido Principal (Texto + Imagen) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-modal-bg); }

        #modal-content { padding: 0 5px; font-size: 1.05rem; } /* Ligeramente más grande */
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Poppins', sans-serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-accent); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 500; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; }
        /* Imagen Final */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(224, 203, 168, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.6rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fdfbf5; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.55; font-family: 'Poppins', sans-serif; font-size: 0.95rem; }
        .user-message { background-color: var(--color-tertiary); color: white; margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #eef; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; border: 1px solid #dde; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; font-family: 'Poppins'; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Poppins'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #e68a00; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Poppins'; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Overlay and Mini-Game */
        #modal-loading { text-align: center; padding: 2rem 1rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 248, 220, 0.98); /* Fondo crema casi opaco */ display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p.loading-text { font-weight: 500; color: var(--color-text); font-size: 1.3rem; font-family: 'Poppins'; margin-bottom: 1.5rem; }

        /* Mini-Game Styles */
        #loading-minigame { margin-top: 1rem; padding: 1rem; background-color: rgba(255, 255, 255, 0.6); border: 1px solid var(--color-border); border-radius: var(--border-radius); width: 90%; max-width: 320px; }
        #game-status { font-family: 'Poppins'; color: var(--color-text); margin-bottom: 1rem; font-size: 1rem; font-weight: 500; min-height: 24px; }
        #game-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 200px; height: 200px; margin: 0 auto; }
        .game-button { border-radius: var(--border-radius); cursor: pointer; transition: opacity 0.1s ease-in-out, transform 0.1s ease; opacity: 0.7; }
        .game-button:hover { opacity: 0.9; }
        .game-button.active { opacity: 1; transform: scale(1.05); box-shadow: 0 0 15px white; }
        #btn-green { background-color: #28a745; } /* Verde */
        #btn-red { background-color: #dc3545; } /* Rojo */
        #btn-yellow { background-color: #ffc107; } /* Amarillo */
        #btn-blue { background-color: #007bff; } /* Azul */
        #game-score-level { font-family: 'Poppins'; margin-top: 1rem; color: var(--color-text-muted); font-size: 0.9rem; }
        .minigame-hidden { display: none !important; } /* Para ocultar el juego */

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Poppins'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(74, 44, 42, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-secondary); box-shadow: var(--shadow-lg); background-color: white; }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-text); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-om mr-3 text-orange-500"></i> <!-- Icono Om -->
                     Sabiduría Hindú
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Enciclopedia Interactiva «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora las Historias Védicas</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre las enseñanzas, deidades y relatos ancestrales que conforman el Sanātana Dharma. Selecciona un tema o busca tu interés.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar deidad, concepto, historia...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-orange-600 mr-2"></i> <!-- Icono libro -->
                 Índice de Conocimiento
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Accediendo a los textos sagrados...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron entradas para tu búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar Más Sabiduría (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Mini-Game -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p class="loading-text">Consultando al Pandit Digital...</p>
                 <!-- Mini-Game Container -->
                 <div id="loading-minigame" class="minigame-hidden">
                     <div id="game-status">¡Prueba tu memoria mientras esperas!</div>
                     <div id="game-controls">
                         <div class="game-button" id="btn-green" data-color="green"></div>
                         <div class="game-button" id="btn-red" data-color="red"></div>
                         <div class="game-button" id="btn-yellow" data-color="yellow"></div>
                         <div class="game-button" id="btn-blue" data-color="blue"></div>
                     </div>
                     <div id="game-score-level">Nivel: 0 | Puntuación: 0</div>
                 </div>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder appended here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Reflexionando...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta más sobre este tema...">
                         <button id="chat-send-btn" aria-label="Enviar Pregunta"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-orange-100 text-orange-900 py-6 mt-12 border-t border-orange-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Contenido generado por IA con fines educativos e informativos sobre el Hinduismo.</p>
              <p class="mt-1">Consulta fuentes académicas y maestros espirituales para un estudio profundo.</p>
              <p class="mt-2">© 2025 Explorador Védico</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Trimurti
            "Brahma: El Creador", "Vishnu: El Preservador", "Shiva: El Destructor y Transformador", "Concepto de Trimurti",
            // Devis (Diosas Principales)
            "Saraswati: Diosa del Conocimiento y las Artes", "Lakshmi: Diosa de la Fortuna y la Prosperidad", "Parvati: Consorte de Shiva, Madre Divina", "Durga: La Guerrera Invencible", "Kali: La Diosa Feroz del Tiempo y el Cambio", "Concepto de Shakti (Energía Femenina Divina)", "Tridevi: Saraswati, Lakshmi, Parvati",
            // Avatares de Vishnu
            "Dashavatara: Los Diez Avatares Principales", "Matsya Avatar (Pez)", "Kurma Avatar (Tortuga)", "Varaha Avatar (Jabalí)", "Narasimha Avatar (Hombre-León)", "Vamana Avatar (Enano)", "Parashurama Avatar (Guerrero con Hacha)", "Rama Avatar (Príncipe de Ayodhya)", "Krishna Avatar (El Señor Oscuro)", "Balarama Avatar (Hermano de Krishna)", "Kalki Avatar (Futuro Avatar)", "Significado de los Avatares",
            // Otros Dioses y Figuras Importantes
            "Ganesha: Removedor de Obstáculos", "Hanuman: El Devoto Fiel de Rama", "Kartikeya (Murugan/Skanda): Dios de la Guerra", "Indra: Rey de los Devas, Dios del Trueno", "Agni: Dios del Fuego", "Varuna: Dios de las Aguas y el Orden Cósmico", "Surya: Dios del Sol", "Chandra: Dios de la Luna", "Yama: Dios de la Muerte y la Justicia", "Navagrahas: Los Nueve Planetas Celestiales", "Asuras y Devas: La Lucha Cósmica", "Rishis: Los Sabios Ancestrales",
            // Ramayana
            "Resumen del Ramayana", "Nacimiento de Rama", "Exilio de Rama", "Rapto de Sita por Ravana", "La Búsqueda de Sita", "Construcción del Puente a Lanka", "La Batalla de Lanka", "Muerte de Ravana", "Regreso de Rama a Ayodhya (Diwali)", "Personajes Clave: Rama, Sita, Lakshmana, Hanuman, Ravana, Bharata", "Lecciones Morales del Ramayana",
            // Mahabharata
            "Resumen del Mahabharata", "La Dinastía Kuru: Kauravas y Pandavas", "El Juego de Dados y el Exilio", "El Bhagavad Gita: Diálogo entre Krishna y Arjuna", "La Guerra de Kurukshetra", "Personajes Clave: Krishna, Arjuna, Yudhishthira, Bhima, Nakula, Sahadeva, Draupadi, Duryodhana, Karna, Bhishma", "Lecciones del Mahabharata: Dharma y Adharma",
            // Bhagavad Gita
            "Introducción al Bhagavad Gita", "Karma Yoga: El Camino de la Acción Desinteresada", "Jnana Yoga: El Camino del Conocimiento", "Bhakti Yoga: El Camino de la Devoción", "Concepto de Dharma en el Gita", "La Naturaleza del Atman (Alma)", "La Revelación de la Forma Universal de Krishna (Vishvarupa)", "Los Tres Gunas (Sattva, Rajas, Tamas)", "Importancia del Bhagavad Gita en el Hinduismo",
            // Vedas y Upanishads
            "Los Cuatro Vedas: Rigveda, Yajurveda, Samaveda, Atharvaveda", "Estructura de los Vedas (Samhitas, Brahmanas, Aranyakas, Upanishads)", "Importancia de los Vedas", "Introducción a las Upanishads", "Concepto de Brahman (Realidad Última)", "Concepto de Atman (Ser Individual)", "Mahavakyas: Las Grandes Sentencias", "Tat Tvam Asi (Tú Eres Eso)", "Aham Brahmasmi (Yo Soy Brahman)", "Principales Upanishads (Brihadaranyaka, Chandogya, Katha, Isha, Kena, Mundaka)",
            // Puranas
            "¿Qué son los Puranas?", "Los 18 Mahapuranas", "Historias Populares de los Puranas (Ej: Bhagavata Purana - Vida de Krishna)", "Vishnu Purana", "Shiva Purana", "Devi Bhagavata Purana", "Cosmología Puránica (Yugas, Manvantaras, Kalpas)",
            // Conceptos Filosóficos Clave
            "Dharma: Deber, Orden Cósmico, Rectitud", "Karma: Ley de Causa y Efecto", "Samsara: Ciclo de Nacimiento, Muerte y Renacimiento", "Moksha (Mukti): Liberación del Samsara", "Maya: Ilusión Cósmica", "Atman y Brahman: Relación entre el Ser Individual y la Realidad Última", "Ahimsa: No Violencia", "Satya: Verdad", "Asteya: No Robar", "Brahmacharya: Continencia / Control de los Sentidos", "Aparigraha: No Posesividad", "Yoga: Unión (Diferentes Caminos)", "Los Seis Darshanas (Escuelas de Filosofía Hindú): Nyaya, Vaisheshika, Samkhya, Yoga, Mimamsa, Vedanta",
            // Escuelas del Vedanta
            "Advaita Vedanta (No Dualismo - Shankara)", "Vishishtadvaita Vedanta (No Dualismo Cualificado - Ramanuja)", "Dvaita Vedanta (Dualismo - Madhva)",
            // Prácticas y Rituales
            "Puja: Adoración Ritual", "Mantras: Sonidos Sagrados (Ej: Om, Gayatri Mantra)", "Yajna (Homa): Sacrificio de Fuego", "Meditación (Dhyana)", "Peregrinación (Tirtha Yatra): Lugares Sagrados (Varanasi, Rishikesh, etc.)", "Templos Hindúes (Mandir): Arquitectura y Significado", "Murti: La Imagen Divina", "Prasad: Ofrenda Bendecida", "Vegetarianismo en el Hinduismo",
            // Festivales Importantes
            "Diwali (Deepavali): Festival de las Luces", "Holi: Festival de los Colores", "Navaratri: Nueve Noches de la Diosa", "Dussehra (Vijayadashami)", "Maha Shivaratri: La Gran Noche de Shiva", "Krishna Janmashtami: Nacimiento de Krishna", "Rama Navami: Nacimiento de Rama", "Ganesh Chaturthi: Festival de Ganesha", "Raksha Bandhan: Vínculo de Protección", "Pongal / Makar Sankranti: Festival de la Cosecha",
            // Sistema Social y Etapas de Vida
            "Varna (Sistema de Castas): Orígenes y Controversias (abordar con sensibilidad histórica y crítica)", "Ashramas: Las Cuatro Etapas de la Vida (Brahmacharya, Grihastha, Vanaprastha, Sannyasa)", "Purusharthas: Los Cuatro Objetivos de la Vida (Dharma, Artha, Kama, Moksha)",
            // Símbolos Hindúes
            "Significado del Símbolo Om (Aum)", "El Loto (Padma)", "La Esvástica Tradicional (Símbolo de Buena Fortuna)", "El Tridente de Shiva (Trishula)", "La Caracola (Shankha)", "El Disco de Vishnu (Sudarshana Chakra)", "La Vaca Sagrada (Go Mata)", "El Río Ganges (Ganga)", "Bindi / Tilaka",
            // Hinduismo Contemporáneo
            "Hinduismo en la Diáspora", "Movimientos de Reforma Hindú (Siglo XIX-XX)", "Neohinduismo y Gurús Modernos", "El Hinduismo y la Ciencia", "Desafíos Actuales del Hinduismo",
             // Añadir muchos más... la lista es vasta.
        ];
        const hinduismThemes = [
            "Deidades Hindúes", "Avatares de Vishnu", "Historias del Ramayana", "Relatos del Mahabharata",
            "Enseñanzas del Bhagavad Gita", "Conceptos Védicos", "Filosofía Upanishádica", "Mitología Puránica",
            "Dharma y Karma", "Samsara y Moksha", "Yoga y Meditación", "Rituales y Pujas Hindúes",
            "Festivales Hindúes importantes", "Textos Sagrados del Hinduismo", "Símbolos Hindúes y su significado",
            "Templos Hindúes famosos", "Escuelas de Filosofía Hindú (Darshanas)", "El papel de la mujer en el Hinduismo",
            "Historias de Ganesha", "Leyendas de Shiva", "Pasatiempos de Krishna", "La Diosa Durga y Kali",
            "Peregrinaciones Hindúes", "El sistema de Ashramas", "Los Purusharthas"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un erudito Pandit Digital, un experto en las escrituras, filosofías, historias y tradiciones del Hinduismo (Sanātana Dharma). Tu propósito es explicar de manera clara, respetuosa y detallada el tema específico que se te solicite. Cubre sus orígenes (si aplica), significado, historias asociadas, relevancia filosófica o teológica, y prácticas relacionadas. Utiliza un lenguaje accesible pero preciso, citando fuentes o conceptos clave cuando sea apropiado (ej. Vedas, Upanishads, Puranas, Itihasas). Tu objetivo es proporcionar una explicación completa y enriquecedora de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tema del Hinduismo:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente Pandit Digital, enfocado únicamente en el tema hindú que se está tratando actualmente. Responde preguntas adicionales sobre detalles, interpretaciones o conexiones con otros conceptos mencionados en la explicación principal. Sé conciso, respetuoso y mantente estrictamente dentro del tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia sobre Hinduismo. Genera exactamente 40 nombres de deidades, conceptos filosóficos, historias de las escrituras (Puranas, Itihasas), textos sagrados, festivales o prácticas relevantes del Sanātana Dharma. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentar ligeramente para 40 títulos
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Text+Image area
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Mini-Game Elements
        const miniGameContainer = document.getElementById('loading-minigame');
        const gameStatus = document.getElementById('game-status');
        const gameButtons = {
            green: document.getElementById('btn-green'),
            red: document.getElementById('btn-red'),
            yellow: document.getElementById('btn-yellow'),
            blue: document.getElementById('btn-blue')
        };
        const gameScoreLevel = document.getElementById('game-score-level');

        // ========== State Variables ==========
        let currentHinduismTopic = null; // Chat context
        // Mini-Game State
        let gameSequence = [];
        let playerSequence = [];
        let gameLevel = 0;
        let gameScore = 0;
        let isPlayerTurn = false;
        let gameIsActive = false;
        let gameFlashTimeout;
        let gameSequenceInterval;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentHinduismTopic
                 ? `Eres un asistente Pandit Digital, enfocado únicamente en el tema hindú '${currentHinduismTopic}'. Responde preguntas adicionales sobre detalles, interpretaciones o conexiones con otros conceptos mencionados en la explicación principal. Sé conciso, respetuoso y mantente estrictamente dentro del tema actual.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, por favor intenta en unos segundos.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta del Pandit Digital llegó vacía. Intenta reformular.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 throw new Error(error.message || "Ocurrió un error inesperado consultando la sabiduría ancestral.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentHinduismTopic) throw new Error("Error interno: Contexto del tema no establecido para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(hinduismThemes) || "conceptos generales del Hinduismo";
            const specificPrompt = `Genera 40 ítems (deidades, conceptos, historias, etc.) sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 10) throw new Error("El Pandit Digital no pudo generar suficientes temas nuevos."); // Expect at least 10 out of 40 requested
                     return titles.slice(0, 40); // Return up to 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Hindu symbolism collage";
             // Prompt ENFOCADO en arte conceptual, SÍMBOLOS, evitar fotos realistas o texto.
             const enhancedPrompt = `Conceptual artistic representation inspired by '${safePromptText}'. Hindu art style, symbolic, mystical atmosphere. Focus on colors (saffron, gold, blue), motifs (lotus, Om, mandalas, divine figures abstractly). Avoid photorealism, text, labels.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, photograph, realistic, human face closeup, simple icon, watermark, signature, multiple images, collage border";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */ if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted; }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            stopMiniGame(); // Detener el juego si está activo
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex'; // Show loading initially
             miniGameContainer.classList.add('minigame-hidden'); // Hide game initially
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentHinduismTopic = null;
             hideFullscreenImage();
             resetMiniGameState(); // Reset game variables
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== MINI-GAME FUNCTIONS ==========
        const gameColors = ['green', 'red', 'yellow', 'blue'];
        const flashDuration = 300; // ms for button flash
        const sequenceGap = 600; // ms between sequence flashes

        function resetMiniGameState() {
            gameSequence = [];
            playerSequence = [];
            gameLevel = 0;
            gameScore = 0;
            isPlayerTurn = false;
            gameIsActive = false;
            clearTimeout(gameFlashTimeout);
            clearInterval(gameSequenceInterval);
            updateGameDisplay();
            // Ensure buttons are not in 'active' state visually
            gameColors.forEach(color => gameButtons[color].classList.remove('active'));
            gameStatus.textContent = '¡Prueba tu memoria mientras esperas!';
        }

        function startMiniGame() {
            console.log("Starting Mini Game");
            resetMiniGameState();
            miniGameContainer.classList.remove('minigame-hidden');
            gameIsActive = true;
            gameLevel = 1;
            gameScore = 0;
            updateGameDisplay();
            gameStatus.textContent = "Observa la secuencia...";
            addNewToSequence();
            playSequence();
        }

        function stopMiniGame() {
            console.log("Stopping Mini Game");
            gameIsActive = false;
            miniGameContainer.classList.add('minigame-hidden');
            resetMiniGameState();
        }

        function updateGameDisplay() {
            gameScoreLevel.textContent = `Nivel: ${gameLevel} | Puntuación: ${gameScore}`;
        }

        function addNewToSequence() {
            const randomColor = gameColors[Math.floor(Math.random() * gameColors.length)];
            gameSequence.push(randomColor);
        }

        function playSequence() {
            isPlayerTurn = false;
            playerSequence = [];
            gameStatus.textContent = "Observa...";
            disableGameButtons();

            let i = 0;
            gameSequenceInterval = setInterval(() => {
                if (!gameIsActive) { clearInterval(gameSequenceInterval); return; }
                if (i >= gameSequence.length) {
                    clearInterval(gameSequenceInterval);
                    startPlayerTurn();
                    return;
                }
                flashButton(gameSequence[i]);
                i++;
            }, sequenceGap);
        }

        function flashButton(color) {
            if (!gameButtons[color]) return;
            const button = gameButtons[color];
            button.classList.add('active');
            clearTimeout(gameFlashTimeout); // Clear previous timeout if any
            gameFlashTimeout = setTimeout(() => {
                 if (button) button.classList.remove('active');
             }, flashDuration);
        }

        function startPlayerTurn() {
            isPlayerTurn = true;
            gameStatus.textContent = "¡Tu turno! Repite la secuencia.";
            enableGameButtons();
        }

        function handlePlayerInput(color) {
            if (!isPlayerTurn || !gameIsActive) return;

            flashButton(color); // Visual feedback
            playerSequence.push(color);

            // Check if the pressed button matches the sequence at the current position
            const currentStepIndex = playerSequence.length - 1;
            if (playerSequence[currentStepIndex] !== gameSequence[currentStepIndex]) {
                gameOver();
                return;
            }

            // If the player completed the sequence correctly
            if (playerSequence.length === gameSequence.length) {
                isPlayerTurn = false;
                gameScore += gameLevel * 10; // Simple scoring
                gameLevel++;
                updateGameDisplay();
                gameStatus.textContent = "¡Correcto! Siguiente nivel...";
                disableGameButtons();
                // Wait a bit before starting the next level
                setTimeout(() => {
                    if (gameIsActive) {
                         addNewToSequence();
                         playSequence();
                    }
                }, 1000);
            }
            // If sequence is not complete yet, wait for the next input (do nothing here)
        }

        function gameOver() {
            gameStatus.textContent = `¡Fin del juego! Nivel alcanzado: ${gameLevel}. Puntuación: ${gameScore}.`;
            isPlayerTurn = false;
            gameIsActive = false; // Stop the game loop implicitly
            disableGameButtons();
            // Maybe add a small delay then reset or offer restart? For loading, just stop.
        }

        function enableGameButtons() {
            for (const color in gameButtons) {
                gameButtons[color].style.cursor = 'pointer';
                // The event listener is added once, no need to re-add
            }
        }
        function disableGameButtons() {
             for (const color in gameButtons) {
                gameButtons[color].style.cursor = 'default';
             }
         }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { if (!titleListContainer || !titlesLoading) return; const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none'; if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay entradas disponibles en los archivos «</p>'; return; } sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title)); newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } }); filterTitles(searchInput.value); }

        // *** MODIFIED: handleTitleClick to integrate Mini-Game ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentHinduismTopic = title;
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');

            // *** START LOADING & MINIGAME ***
            modalLoadingIndicator.style.display = 'flex'; // Show spinner etc.
            startMiniGame(); // Show and start the game

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // *** STOP MINIGAME & HIDE LOADING (before showing content) ***
                stopMiniGame();
                modalLoadingIndicator.style.display = 'none';

                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Image Placeholder & Loading
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-spa placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Creando visualización...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                // *** STOP MINIGAME & HIDE LOADING ON ERROR ***
                stopMiniGame();
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el conocimiento.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando en los Vedas...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudo encontrar más sabiduría en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar sabiduría: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Update button text to reflect 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Revelar Más Sabiduría (40)';
             }
         }

         // Search Filter Function (sin cambios funcionales)
         function filterTitles(searchTerm) { const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); const titleItems = titleListContainer.querySelectorAll('.title-item'); let visibleCount = 0; titleItems.forEach(item => { const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const isVisible = titleText.includes(term); item.classList.toggle('hidden', !isVisible); if (isVisible) visibleCount++; }); noResultsMsg.classList.toggle('hidden', visibleCount > 0); }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check all essential elements including game buttons
            const essentialElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, miniGameContainer, gameStatus, gameScoreLevel, ...Object.values(gameButtons)];
            if (essentialElements.some(el => !el)) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: darkred; font-size: 1.5em; text-align: center; padding-top: 3em;">|| Error Crítico: Faltan Componentes Esenciales de la Interfaz ||</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            // Mini-Game Button Listeners
            for (const color in gameButtons) {
                gameButtons[color].addEventListener('click', () => handlePlayerInput(color));
            }
            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            miniGameContainer.classList.add('minigame-hidden'); // Ensure game is hidden on load
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>