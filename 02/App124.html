<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habilidades Animales Increíbles - Enciclopedia Natural</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Habilidades Animales --- */
        :root {
            --color-primary: #22c55e; /* Verde Intenso (Vida, Naturaleza) */
            --color-secondary: #3b82f6; /* Azul Vibrante (Agua, Cielo) */
            --color-tertiary: #f97316; /* Naranja (Energía, Señales) */
            --color-background: #f0fdf4; /* Verde Muy Pálido / Blanco Hueso */
            --color-text: #1f2937; /* Gris Oscuro Casi Negro */
            --color-text-muted: #4b5563; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro */
            --color-border: #d1d5db; /* Borde Gris Claro */
            --color-error-bg: #fff1f2; /* Fondo error rosa pálido */
            --color-error-text: #be123c; /* Texto error rojo oscuro */
            --color-error-border: #fecdd3; /* Borde error rosa claro */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 6px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Lato', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: white; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Nunito'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Nunito'; font-size: 0.95rem; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f0fdf4; /* Verde muy claro */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Lato', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #16a34a; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; opacity: 0.7; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); /* Overlay Gris Oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px; /* Altura para chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e5e7eb; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) #e5e7eb;
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: #e5e7eb; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid #e5e7eb; }

        #modal-content { padding: 0 5px; font-size: 1.05rem; } /* Slightly larger text */
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; font-weight: 600;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Lato', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid #e5e7eb; width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) #e5e7eb;
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: #e5e7eb; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-secondary); color: white; margin-left: auto; text-align: left; font-weight: 600; }
        .ai-message { background-color: #e5e7eb; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Nunito'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #16a34a; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.3rem; font-family: 'Lato'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Nunito'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(30, 41, 59, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); background-color: white; /* Fondo blanco para imágenes con transparencia */ }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-paw mr-3 text-green-600"></i> <!-- Icono huella -->
                     Mundo Animal Asombroso
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">~ Enciclopedia Interactiva de Habilidades ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Adaptaciones Increíbles</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora las habilidades más extraordinarias del reino animal, desde súper sentidos hasta defensas ingeniosas y proezas físicas.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar habilidad o animal...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-dna text-blue-600 mr-2"></i> <!-- Icono ADN -->
                 Catálogo de Habilidades
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando catálogo de maravillas naturales...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">~ No se encontraron habilidades con ese criterio ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Habilidades
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Explorando la habilidad...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando al experto...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta habilidad...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos y de divulgación sobre biología animal.</p>
              <p class="mt-1">Consulta fuentes académicas para estudios detallados.</p>
              <p class="mt-2">© 2025 Enciclopedia Natural Interactiva</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // --- SÚPER SENTIDOS ---
            "Ecolocalización en Murciélagos", "Ecolocalización en Delfines y Ballenas", "Electrorrecepción en Tiburones (Ampollas de Lorenzini)", "Electrorrecepción en Peces Eléctricos", "Electrorrecepción en Ornitorrincos", "Magnetorrecepción en Aves Migratorias", "Magnetorrecepción en Tortugas Marinas", "Magnetorrecepción en Abejas y otros Insectos", "Visión Ultravioleta en Aves", "Visión Ultravioleta en Insectos (Abejas, Mariposas)", "Visión Ultravioleta en Renos", "Visión Polarizada en Insectos (Hormigas del desierto)", "Visión Polarizada en Cefalópodos (Pulpos, Sepias)", "Visión Térmica (Termorrecepción) en Serpientes (Fosetas Loreales)", "Visión Térmica en Murciélagos Vampiro", "Olfato Excepcional en Perros", "Olfato Excepcional en Osos", "Olfato Excepcional en Polillas (Detectando Feromonas)", "Olfato Excepcional en el Kiwi", "Olfato Subacuático en Topos Estrellados", "Olfato en Serpientes (Órgano de Jacobson)", "Gusto Excepcional en Bagres (Papilas Gustativas Corporales)", "Audición Infra-sónica en Elefantes", "Audición Infra-sónica en Ballenas", "Audición Ultra-sónica en Murciélagos y Roedores", "Audición Ultra-sónica en Polillas (Defensa)", "Sentido del Tacto en Mapaches", "Sentido del Tacto en el Topo de Nariz Estrellada", "Percepción de Vibraciones en Arañas", "Percepción de Vibraciones en Escorpiones", "Percepción de Vibraciones en Elefantes (Vía patas)", "Sentido del Flujo de Agua (Línea Lateral en Peces)", "Sentido del Flujo de Agua en Anfibios Acuáticos", "Propiocepción (Conciencia Corporal) Avanzada", "Visión Nocturna Aguda en Felinos", "Visión Nocturna en Búhos", "Visión de 360 Grados en Camaleones", "Visión Monocular vs Binocular", "Capacidad de Ver Colores Invisibles para Humanos", "Detección Química a Distancia (Feromonas)",
            // --- MOVIMIENTO Y LOCOMOCIÓN ---
            "Velocidad Extrema del Guepardo", "Velocidad de Vuelo del Halcón Peregrino (Picado)", "Vuelo Silencioso del Búho", "Vuelo Acrobático del Colibrí", "Vuelo Estacionario del Colibrí", "Planeo en Ardillas Voladoras", "Planeo en Ranas Voladoras", "Planeo en Serpientes Voladoras (Chrysopelea)", "Planeo en Peces Voladores", "Natación Eficiente en Atunes y Marlines", "Natación Propulsada por Chorro en Calamares y Pulpos", "Salto Poderoso en Canguros", "Salto Poderoso en Pulgas", "Salto Poderoso en Gatos", "Salto del Agua en Delfines", "Marcha sobre el Agua en Basiliscos (Lagarto Jesucristo)", "Marcha sobre el Agua en Algunos Insectos (Zapateros)", "Escalada Experta en Gecos (Fuerzas de Van der Waals)", "Escalada en Cabras Montesas", "Escalada Invertida en Insectos", "Trepado Rápido en Primates", "Carrera Bípeda en Avestruces", "Braquiación (Balanceo entre ramas) en Gibones", "Nado Sincronizado en Cardúmenes de Peces", "Vuelo en Formación en Aves Migratorias", "Movimiento Peristáltico en Lombrices de Tierra", "Movimiento Ondulatorio en Serpientes", "Construcción de Túneles Complejos por Topos", "Construcción de Túneles por Hormigas y Termitas", "Locomoción por Adhesión en Caracoles", "Impulso con Tentáculos en Medusas", "Migración de Larga Distancia en Aves", "Migración de Larga Distancia en Ballenas", "Migración de Larga Distancia de la Mariposa Monarca", "Migración Vertical Diaria en el Plancton Marino", "Resistencia Extrema en Caballos y Camellos", "Capacidad de Flotar Inmóvil (Ej. Caimanes)", "Maniobrabilidad Subacuática de las Focas", "Desplazamiento Sigiloso de los Felinos",
            // --- DEFENSA Y SUPERVIVENCIA ---
            "Camuflaje Adaptativo en Pulpos y Sepias", "Camuflaje Disruptivo (Ej. Cebras, Tigres)", "Camuflaje Estacional (Ej. Liebre Ártica)", "Mimetismo Batesiano (Inofensivo imita a peligroso)", "Mimetismo Mülleriano (Peligrosos se imitan entre sí)", "Mimetismo Agresivo (Depredador imita algo inofensivo)", "Caparazón Protector en Tortugas", "Caparazón en Armadillos", "Exoesqueleto Quitinoso en Insectos y Crustáceos", "Piel Gruesa y Resistente (Rinocerontes, Hipopótamos)", "Espinas Defensivas en Erizos", "Espinas en Peces Erizo", "Púas del Puercoespín", "Veneno Neurotóxico en Serpientes (Cobras, Mambas)", "Veneno Hemotóxico en Serpientes (Víboras)", "Veneno Citotóxico en Serpientes", "Veneno en Arañas (Viuda Negra, Reclusa Parda)", "Veneno en Escorpiones", "Veneno en Abejas y Avispas", "Veneno en Ranas Dardo Venenosas", "Veneno en el Ornitorrinco (Espolón del macho)", "Toxicidad en la Piel de Salamandras y Tritones", "Toxicidad en el Pez Globo (Tetrodotoxina)", "Autotomía (Desprendimiento de cola) en Lagartijas", "Autotomía en Algunos Insectos (Patas)", "Autotomía en Pulpos (Brazos)", "Expulsión de Órganos Internos (Pepinos de Mar)", "Spray Químico Oloroso de las Mofetas", "Spray Ácido de Algunos Insectos (Escarabajo Bombardero)", "Tinta Defensiva en Pulpos y Calamares", "Bioluminiscencia Defensiva (Sobresalto, Confusión)", "Descarga Eléctrica Defensiva en Anguilas Eléctricas", "Descarga Eléctrica en Rayas Torpedo", "Hacerse el Muerto (Tanatosis) en Zarigüeyas", "Hacerse el Muerto en Algunas Serpientes e Insectos", "Inflarse para Parecer Más Grande (Pez Erizo)", "Gritos de Alarma Específicos (Monos Vervet)", "Defensa Grupal (Ej. Bueyes Almizcleros)", "Construcción de Refugios Seguros (Castores, Tejedores)", "Enterramiento Rápido en la Arena (Algunos Peces planos, Cangrejos)", "Agilidad Evasiva Extrema", "Secreciones Pegajosas o Resbaladizas", "Regeneración de Miembros en Axolotls", "Regeneración en Estrellas de Mar", "Regeneración en Planarias", "Regeneración Parcial en Lagartijas (Cola)", "Hibernación Profunda en Osos (Discutido, Torpor)", "Hibernación Verdadera en Marmotas y Lirones", "Estivación (Letargo de Verano) en Caracoles del Desierto", "Producción de Anticoagulantes (Sanguijuelas, Murciélagos Vampiro)", "Producción de Proteínas Anticongelantes en Peces Árticos", "Producción de Anticongelantes en Algunos Insectos y Ranas", "Tolerancia a Temperaturas Extremas (Calor) en Hormigas del Desierto", "Tolerancia a Temperaturas Extremas (Frío) en Pingüinos Emperador", "Tolerancia a la Desecación Extrema en Tardígrados (Criptobiosis)", "Tolerancia a la Falta de Oxígeno (Anoxia) en Tortugas Pintadas", "Tolerancia a la Alta Presión en Animales Abisales", "Tolerancia a la Radiación en Tardígrados y Algunos Insectos", "Metabolismo Lento para Conservar Energía", "Capacidad de Almacenar Agua (Camellos)", "Capacidad de Almacenar Grasa (Osos, Ballenas)", "Respiración Cutánea en Anfibios", "Respiración a Través de Branquias", "Respiración Traqueal en Insectos", "Capacidad de Cambiar de Sexo (Algunos Peces)", "Partenogénesis (Reproducción Asexual)", "Hermafroditismo",
            // --- CAZA Y ALIMENTACIÓN ---
            "Acecho y Emboscada Silenciosa (Felinos)", "Caza Cooperativa en Lobos", "Caza Cooperativa en Orcas", "Caza Cooperativa en Hienas", "Caza Cooperativa en Hormigas Legionarias", "Construcción de Telarañas Intrincadas", "Construcción de Trampas (Hormiga León)", "Uso de Señuelos (Pez Pescador Abisal)", "Uso de Señuelos (Tortuga Aligator)", "Lengua Pegajosa y Rápida del Camaleón", "Lengua Pegajosa de Ranas y Sapos", "Lengua Larga del Oso Hormiguero", "Picadura Paralizante de Avispas Parasitoides", "Constricción Poderosa de las Boas y Pitones", "Garras Retráctiles Afiladas (Felinos)", "Dientes Especializados (Carnassiales en Carnívoros)", "Dientes Regenerables en Tiburones", "Pico Fuerte y Curvo de las Aves Rapaces", "Filtración de Alimento en Ballenas Barbadas", "Filtración en Flamencos", "Electro-localización para Cazar (Peces eléctricos débiles)", "Uso de Herramientas en Nutrias Marinas (Piedras)", "Uso de Herramientas en Chimpancés (Ramas, Piedras)", "Uso de Herramientas en Cuervos de Nueva Caledonia", "Uso de Herramientas en Pulpos (Cáscaras de Coco)", "Vuelo de Caza Preciso de Aves Rapaces", "Pesca con Lanza del Martín Pescador", "Almacenamiento de Comida (Caché) por Ardillas", "Almacenamiento de Comida por Pájaros Carpinteros (Bellotas)", "Digestión de Huesos (Hienas)", "Digestión de Celulosa (Rumiantes, Termitas con simbiontes)", "Producción de Enzimas Digestivas Potentes", "Mimetismo Olfativo para Engañar Presas", "Canibalismo Estratégico", "Cleptoparasitismo (Robo de Comida)",
            // --- COMUNICACIÓN Y COMPORTAMIENTO SOCIAL ---
            "Lenguaje Corporal Complejo en Primates", "Comunicación Química mediante Feromonas", "Comunicación Táctil (Aseo Social en Primates)", "Comunicación Visual: Cambio de Color en Cefalópodos", "Comunicación Visual: Exhibiciones de Cortejo en Aves", "Comunicación Visual: Posturas de Dominancia/Sumisión", "Comunicación Acústica: Cantos Complejos de Ballenas", "Comunicación Acústica: Cantos de Aves", "Comunicación Acústica: Dialectos en Orcas", "Comunicación Acústica: Infrasonido en Elefantes", "Comunicación Acústica: Ultrasonido en Roedores", "Bioluminiscencia para Comunicación (Luciérnagas)", "Bioluminiscencia en Peces Abisales", "Danza de las Abejas para Indicar Comida", "Organización Social Compleja en Hormigas y Termitas (Eusocialidad)", "Jerarquías de Dominancia Estrictas", "Cuidado Parental Extensivo", "Adopción en Algunas Especies", "Aprendizaje Social (Observación e Imitación)", "Transmisión Cultural de Comportamientos", "Juego Animal (Desarrollo y Socialización)", "Empatía Rudimentaria (Discutido en Elefantes, Primates)", "Resolución de Problemas Complejos (Cuervos, Pulpos)", "Memoria Espacial Excepcional (Aves que esconden comida)", "Memoria a Largo Plazo", "Reconocimiento Individual", "Construcción de Nidos Elaborados (Aves Tejedoras)", "Construcción de Presas por Castores", "Arquitectura de Termiteros (Ventilación)", "Altruismo Recíproco", "Selección de Parentesco (Ayuda a Familiares)", "Engaño Táctico",
            // --- HABILIDADES 'EXTRAÑAS' Y ÚNICAS ---
            "Producción de Leche en Mamíferos", "Producción de 'Leche de Buche' en Palomas", "Vómito Defensivo en Fulmares", "Lanzamiento de Heces (Monos)", "Electricidad Estática en Patas de Geco (Contribución)", "Navegación por Estrellas (Escarabajo Pelotero)", "Navegación Solar (Abejas, Aves)", "Uso de Mapas Olfativos (Palomas Mensajeras)", "Sentido del Tiempo Preciso (Ritmos Circadianos)", "Mudar la Piel (Reptiles, Insectos)", "Metamorfosis Completa en Insectos (Holometabolismo)", "Metamorfosis Incompleta (Hemimetabolismo)", "Determinación del Sexo por Temperatura (Reptiles)", "Biofluorescencia (Absorber y Reemitir Luz)", "Capacidad de 'Soldar' Heridas (Hormigas Soldado)", "Generar Calor Corporal (Algunas Plantas, Pitones Incubando)", "Control del Flujo Sanguíneo (Animales Buceadores)", "Tolerancia al Alcohol (Musaraña de Cola Plumosa)", "Producción de Seda (Arañas, Gusanos de Seda)", "Mimetismo de Hojas o Ramas (Insecto Palo, Insecto Hoja)", "Producción de Sonidos sin Cuerdas Vocales (Grillos, Cigararras)"
            // Add more as needed...
        ];
        const animalAbilityThemes = [
            "súper sentidos animales", "visión animal avanzada", "ecolocalización", "electrorrecepción", "magnetorrecepción", "olfato animal", "locomoción animal", "vuelo animal", "natación animal", "camuflaje y mimetismo", "defensas químicas animales", "venenos y toxinas", "regeneración animal", "supervivencia extrema (temperatura, presión, oxígeno)", "criptobiosis y letargo", "comunicación animal", "bioluminiscencia", "inteligencia animal", "uso de herramientas en animales", "comportamiento social animal", "eusocialidad", "caza y depredación", "construcción animal (nidos, telas, presas)", "migración animal", "adaptaciones fisiológicas únicas"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un biólogo experto y divulgador científico apasionado por las maravillas del reino animal. Describe la habilidad animal indicada de forma detallada, precisa y fascinante. Incluye: Explicación del mecanismo biológico/fisiológico subyacente, ejemplos de animales notables que la poseen (con detalles específicos), ventajas evolutivas claras que confiere, limitaciones o costos energéticos asociados, datos curiosos o récords mundiales si existen, y el estado actual de la investigación o aplicaciones biomiméticas si es relevante. Utiliza un lenguaje claro, vívido y accesible, pero científicamente riguroso y bien estructurado. El objetivo es una explicación completa y cautivadora de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en la siguiente habilidad animal:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat, system prompt se sobreescribe
            model: "mistral-tiny", // Opcional: modelo más rápido para chat
             systemPrompt: "Actúa como un asistente de biología IA especializado únicamente en la habilidad animal que se está mostrando. Responde preguntas de seguimiento sobre sus mecanismos, los animales que la usan, ventajas evolutivas, o detalles mencionados en la descripción principal. Sé conciso, científicamente preciso y relevante al tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia de biología animal. Genera exactamente 15 nombres de habilidades animales asombrosas, mecanismos biológicos únicos, sentidos extraordinarios o adaptaciones extremas, adecuados para una descripción detallada. Devuelve *solo* la lista de nombres/habilidades, una por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Área scrollable
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentAbilityTitle = null; // RENAMED from currentWeaponTitle

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            // *** USA EL SYSTEM PROMPT DINÁMICO PARA CHAT ***
            const systemPromptToUse = isChat && currentAbilityTitle // RENAMED
                ? `Eres un asistente de biología IA especializado únicamente en la habilidad animal '${currentAbilityTitle}'. Responde preguntas de seguimiento sobre sus mecanismos, los animales que la usan, ventajas evolutivas, o detalles mencionados en la descripción principal. Sé conciso, científicamente preciso y relevante al tema actual.` // RENAMED
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores pueden estar ocupados. Por favor, inténtalo de nuevo en unos momentos.`);
                 }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o inténtalo más tarde.");
                 }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) {
            if (!currentAbilityTitle) throw new Error("Error interno: No se ha establecido el contexto de la habilidad para el chat."); // RENAMED
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(animalAbilityThemes) || "habilidades animales generales";
            const specificPrompt = `Genera 15 nombres/conceptos de habilidades animales asombrosas sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de habilidades.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "amazing animal ability";
             // Prompt enfocado en la habilidad o el animal demostrándola
             const enhancedPrompt = `Conceptual artwork illustrating the animal ability '${safePromptText}'. Focus on the biological mechanism or the animal demonstrating the skill in its natural environment. Naturalistic or slightly stylized art style. Detailed, vibrant colors appropriate to nature.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Negativos para evitar texto y diagramas
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, abstract shapes, cartoon, drawing, simple illustration, human figure, laboratory setting, cage, low quality, blurry";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (la misma función de antes) ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, ' ');
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Sin cambios lógicos)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentAbilityTitle = null; // RENAMED & Reset
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios lógicos)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (Sin cambios lógicos)
        function addChatMessage(message, sender) {
             const msgDiv = document.createElement('div');
             msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
             message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
             msgDiv.innerHTML = message;
             chatHistory.appendChild(msgDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... (igual que antes) ... */
            const errorDiv = document.createElement('div');
            errorDiv.classList.add('chat-error');
            errorDiv.textContent = message;
            chatHistory.appendChild(errorDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">~ No hay habilidades en el catálogo ~</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick (context renamed, logic same) ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentAbilityTitle = title; // *** SET CHAT CONTEXT (RENAMED) ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando ilustración...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => { showFullscreenImage(imgElement.src); });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Ilustración no disponible.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la habilidad.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando Más Maravillas...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron encontrar más habilidades en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar habilidades: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Habilidades';
             }
         }

        // *** Search Filter Function (includes normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (Sin cambios lógicos)
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Fallo al cargar componentes de la interfaz.</p>';
                 return;
              }
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
         }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>