<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crónicas de la Historia de México</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Historia de México --- */
        :root {
            --color-primary: #166534; /* Verde Bandera Intenso */
            --color-secondary: #b91c1c; /* Rojo Terracota/Bandera */
            --color-background: #fdfbf6; /* Blanco Hueso/Beige Claro (Papiro/Piedra) */
            --color-text: #44403c; /* Marrón Oscuro/Sepia (Texto antiguo) */
            --color-text-muted: #78716c; /* Marrón/Gris Medio */
            --color-modal-bg: #f5f5f4; /* Gris Muy Claro/Beige para Modal */
            --color-border: #d6d3d1; /* Borde Gris/Beige Suave */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.06);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.08);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 5px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        h1.logo, h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        #modal-title { color: var(--color-primary); }
        .navbar { background-color: #ffffff; box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; }
        .title-item {
            background-color: #ffffff; padding: 1.25rem 1rem; border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal);
            text-align: center; font-weight: 600; color: var(--color-text);
            border: 1px solid var(--color-border); display: flex; align-items: center;
            justify-content: center; min-height: 75px; font-family: 'Lato', sans-serif;
            border-left: 5px solid var(--color-primary); /* Detalle de color primario */
        }
        .title-item:hover {
            transform: translateY(-3px); box-shadow: var(--shadow-md);
            border-color: var(--color-secondary); border-left-color: var(--color-secondary);
            color: var(--color-primary); background-color: #f8fafc; /* Ligero cambio de fondo */
        }
        #generate-more-btn {
            grid-column: 1 / -1; background-color: var(--color-primary); color: white;
            padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius);
            font-family: 'Lato', sans-serif; font-weight: bold; cursor: pointer;
            transition: var(--transition-normal); margin-top: 2rem;
        }
        #generate-more-btn:hover:not(:disabled) { background-color: #14532d; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #a1a1aa; color: #e5e5e5; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(68, 64, 60, 0.85); /* Overlay sepia oscuro */
            display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem;
        }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg); border-radius: var(--border-radius);
            padding: 2rem 2.5rem; max-width: 950px; width: 95%; max-height: 90vh;
            min-height: 350px; overflow: hidden; position: relative;
            box-shadow: var(--shadow-lg); display: flex; flex-direction: column;
            border: 1px solid var(--color-border);
        }
        .modal-close-btn {
            position: absolute; top: 12px; right: 12px; background: #e5e7eb; border: none;
            border-radius: 50%; width: 35px; height: 35px; font-size: 1.6rem; color: var(--color-text-muted);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: var(--transition-normal); z-index: 10;
        }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: #ffffff; }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }
        #modal-content {
            line-height: 1.8; color: var(--color-text); white-space: normal; overflow-y: auto;
            padding: 0 10px 1.5rem 10px; flex-grow: 1; min-height: 0;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content::-webkit-scrollbar { width: 10px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 {
            font-family: 'Merriweather', serif; margin-top: 2.2em; margin-bottom: 1.1em;
            color: var(--color-primary); border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.5em; font-weight: bold;
        }
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.45em; }
        #modal-content h3 { font-size: 1.3em; color: #a855f7; } /* Morado como detalle (obispo, etc.) */
        #modal-content h4 { font-size: 1.15em; color: var(--color-text-muted); border-bottom: none; }
        /* Estilo para la imagen insertada al final del contenido */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fff; /* Fondo blanco para imágenes */}
        /* Estilo para el placeholder/spinner de la imagen final */
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; }

        #modal-loading {
            text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(253, 251, 246, 0.97); /* Fondo carga casi opaco */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 5; border-radius: var(--border-radius);
        }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid #d6d3d1; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.3rem; font-family: 'Lato'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg {
            background-color: #fef2f2; /* Fondo error rojo muy claro */ color: var(--color-secondary);
            padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #fecaca;
            margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold;
        }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body class="bg-stone-100"> <!-- Cambiado a stone-100 para el tono beige -->
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex justify-center items-center">
             <div class="flex items-center text-center">
                 <!-- Icono representativo de México -->
                 <i class="fas fa-landmark text-3xl text-green-800 mr-3"></i>
                 <h1 class="logo text-3xl sm:text-4xl">
                     Crónicas de la Historia de México
                 </h1>
                 <i class="fas fa-feather-alt text-3xl text-red-700 ml-3"></i> <!-- Otro icono (pluma prehispánica) -->
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Un Viaje por el Pasado Mexicano</h1>
             <p class="text-xl text-stone-700 mb-8 max-w-3xl mx-auto">Desde las civilizaciones antiguas hasta los desafíos modernos, explora los eventos, personajes y procesos que forjaron una nación. Selecciona un capítulo para comenzar.</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll text-red-700 mr-2"></i>
                 Índice Histórico
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-stone-500 col-span-full text-center text-lg">Consultando los archivos históricos...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Eventos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Generando crónica...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - La imagen se añadirá aquí al final -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                     <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                 </div>
                 <!-- NO HAY CONTENEDOR DE IMAGEN SEPARADO AQUÍ -->
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-stone-200 text-stone-700 py-6 mt-12 border-t border-stone-300">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Crónicas generadas por IA con fines educativos e informativos sobre la Historia de México.</p>
              <p class="mt-1">Se recomienda consultar fuentes académicas para estudios profundos.</p>
              <p class="mt-2">© 2025 Crónicas de México</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // --- ÉPOCA PREHISPÁNICA ---
            // Culturas Tempranas y Preclásico
            "Los primeros pobladores de México: Teorías y evidencias", "La cultura Olmeca: Orígenes y legado (cabezas colosales, La Venta)", "San Lorenzo Tenochtitlán: Auge y caída del centro Olmeca", "La Venta: Urbanismo y religión Olmeca", "El desarrollo de la escritura mesoamericana: Zapotecas y Mayas", "El Preclásico en el Altiplano Central: Tlatilco y Cuicuilco", "Cuicuilco: La ciudad circular y la erupción del Xitle", "Monte Albán: Fundación y desarrollo temprano (Zapotecas)",
            // Periodo Clásico
            "Teotihuacán: Auge de la gran metrópoli del Clásico", "La Calzada de los Muertos y las Pirámides del Sol y la Luna", "Sociedad y gobierno en Teotihuacán", "La influencia teotihuacana en Mesoamérica", "El colapso de Teotihuacán: Causas y consecuencias", "El Periodo Clásico Maya: Ciudades-estado (Tikal, Calakmul, Palenque)", "Palenque: Arquitectura y la tumba de Pakal el Grande", "Tikal vs. Calakmul: Rivalidad y poder en el Petén", "La escritura jeroglífica maya: Avances y desciframiento", "El calendario maya: Ciclos de tiempo y cosmovisión", "Matemáticas mayas: El concepto del cero", "La sociedad Clásica Maya: Reyes, nobles y pueblo", "El juego de pelota mesoamericano: Ritual y significado", "El Tajín: Arquitectura y cultura Totonaca en el Clásico", "Xochicalco: La ciudad fortificada del Epiclásico", "Cacaxtla: Los murales y la influencia Maya en el Altiplano", "Cantona: La gran urbe del Epiclásico poblano", "El colapso Maya del Clásico Terminal: Teorías (sequía, guerra, social)",
            // Periodo Posclásico
            "El surgimiento de Tula (Tollan-Xicocotitlan) y los Toltecas", "La figura de Quetzalcóatl (Ce Ácatl Topiltzin Quetzalcóatl)", "Los Atlantes de Tula: Arte y poder Tolteca", "La influencia Tolteca: Chichén Itzá y el Yucatán", "Chichén Itzá: Fusión cultural Maya-Tolteca (El Castillo, Juego de Pelota)", "El Posclásico Tardío en el Valle de México: Culhuacán, Azcapotzalco", "La migración Mexica (Azteca): Origen mítico (Aztlán) y peregrinación", "La fundación de México-Tenochtitlán (1325)", "La Triple Alianza: Tenochtitlán, Texcoco y Tlacopan", "La expansión del Imperio Mexica (Azteca)", "La sociedad Mexica: Pipiltin (nobles) y Macehualtin (comunes)", "Calpulli: La unidad social básica Mexica", "La economía Mexica: Tributo, comercio (pochtecas) y agricultura (chinampas)", "La religión Mexica: Panteón de dioses (Huitzilopochtli, Tláloc, Tezcatlipoca)", "El Templo Mayor de Tenochtitlán: Centro ceremonial", "El sacrificio humano en la cosmovisión Mexica", "La educación Mexica: Calmécac y Telpochcalli", "El arte Mexica: Escultura monumental (Coatlicue, Piedra del Sol)", "La poesía náhuatl: Nezahualcóyotl y los cantos floridos", "El Imperio Purépecha (Tarasco) en Michoacán: Rival de los Mexicas", "Tzintzuntzan: La capital Purépecha y las Yácatas", "Los Mixtecas en Oaxaca: Códices y orfebrería", "Los Tlaxcaltecas: Enemigos persistentes de los Mexicas",
            // --- LA CONQUISTA ---
            "Los viajes de exploración europeos previos a Cortés", "Hernán Cortés: Orígenes y expedición a México (1519)", "La Malinche (Malintzin): Intérprete y figura clave", "El desembarco en Veracruz y la fundación de la Villa Rica", "La alianza con los Totonacas de Cempoala", "La marcha hacia Tenochtitlán: Enfrentamientos y alianzas (Tlaxcala)", "La Matanza de Cholula: Controversia y estrategia", "El primer encuentro: Cortés y Moctezuma II", "La estancia de los españoles en Tenochtitlán", "La Matanza del Templo Mayor (Pedro de Alvarado)", "La Noche Triste (30 de junio de 1520): Derrota española", "La reorganización española en Tlaxcala y la epidemia de viruela", "El asedio y caída de México-Tenochtitlán (13 de agosto de 1521)", "El papel de la tecnología militar española (armas de fuego, caballos, acero)", "El impacto de las enfermedades europeas en la población indígena", "La figura de Cuauhtémoc: Último tlatoani Mexica", "La conquista de Michoacán y otros señoríos", "La conquista del Yucatán: Resistencia Maya", "Las consecuencias inmediatas de la Conquista",
            // --- MÉXICO COLONIAL (VIRREINATO DE NUEVA ESPAÑA) ---
            // Siglo XVI: Establecimiento del Orden Colonial
            "Establecimiento del Virreinato de Nueva España (1535)", "Primeros Virreyes: Antonio de Mendoza y Luis de Velasco", "La evangelización: Órdenes religiosas (franciscanos, dominicos, agustinos)", "Figuras clave de la evangelización: Fray Juan de Zumárraga, Vasco de Quiroga", "La construcción de conventos y templos", "El sincretismo religioso: Fusión de creencias", "La Encomienda: Sistema de explotación indígena", "El Repartimiento y el trabajo forzado", "Las Leyes Nuevas (1542) y la protección (limitada) de los indígenas", "La catástrofe demográfica indígena del siglo XVI", "La fundación de ciudades coloniales (Puebla, Guadalajara, Valladolid)", "La Real Audiencia de México: Administración de justicia", "La minería de plata: Zacatecas, Guanajuato y el motor económico", "El Camino Real de Tierra Adentro", "La introducción de ganado y cultivos europeos", "La Universidad de México (1551): Primera de América continental", "La imprenta en México (Juan Pablos, 1539)", "Las 'Repúblicas de Indios' y 'Repúblicas de Españoles'",
            // Siglos XVII y XVIII: Consolidación y Reformas
            "El desarrollo de la Hacienda como unidad productiva", "La sociedad de castas: Mestizaje y jerarquía social", "El Barroco en Nueva España: Arquitectura, arte y literatura", "Sor Juana Inés de la Cruz: Figura cumbre del Barroco hispanoamericano", "Carlos de Sigüenza y Góngora: Erudito criollo", "La Inquisición en Nueva España: Control religioso y social", "Conflictos sociales: Motines y rebeliones (Motín de 1692)", "La piratería en el Caribe y sus efectos en Nueva España", "La defensa de las costas: Veracruz y Campeche", "Las Reformas Borbónicas en Nueva España (siglo XVIII)", "La expulsión de los Jesuitas (1767): Causas y consecuencias", "El fortalecimiento del poder real y la reorganización administrativa (Intendencias)", "El libre comercio (limitado) y sus efectos económicos", "El auge de la minería en el siglo XVIII", "El crecimiento de la población y las ciudades", "El descontento criollo frente a los peninsulares", "La Ilustración en Nueva España: Nuevas ideas y pensamiento crítico", "La Real Academia de San Carlos: Fomento de las artes", "Expediciones científicas y exploración del territorio", "La Virgen de Guadalupe: Símbolo de identidad novohispana",
            // --- INDEPENDENCIA DE MÉXICO ---
            // Causas y Antecedentes
            "Causas internas de la Independencia (desigualdad social, nacionalismo criollo)", "Causas externas (Ilustración, Independencia de EEUU, Revolución Francesa, Invasión Napoleónica a España)", "La crisis política en España (1808) y sus repercusiones en Nueva España", "El golpe de estado contra el Virrey Iturrigaray (1808)", "Las conspiraciones criollas (Valladolid, Querétaro)",
            // Inicio de la Lucha
            "El Grito de Dolores (16 de septiembre de 1810): Miguel Hidalgo", "La figura de Miguel Hidalgo y Costilla", "El estandarte guadalupano como símbolo insurgente", "La toma de la Alhóndiga de Granaditas (Guanajuato)", "La batalla del Monte de las Cruces y la retirada de la Ciudad de México", "La derrota en Puente de Calderón y captura de los líderes insurgentes", "Ejecución de Hidalgo, Allende, Aldama y Jiménez (1811)",
            // Continuación de la Lucha (Morelos)
            "José María Morelos y Pavón: Liderazgo militar y político", "Las campañas militares de Morelos", "El Congreso de Chilpancingo (1813)", "Los Sentimientos de la Nación: Ideario de Morelos", "La Constitución de Apatzingán (1814)", "Declive y captura de Morelos: Ejecución (1815)",
            // Resistencia y Consumación
            "La guerra de guerrillas: Vicente Guerrero y Guadalupe Victoria", "Francisco Xavier Mina: Expedición y lucha liberal", "El desgaste de la guerra y la política de indulto", "La Constitución de Cádiz (1812 y 1820) y su impacto en Nueva España", "Agustín de Iturbide: De realista a líder de la consumación", "El Plan de Iguala (1821): Las Tres Garantías (Religión, Independencia, Unión)", "El Abrazo de Acatempan: Unión de Iturbide y Guerrero", "Los Tratados de Córdoba (1821): Reconocimiento (no oficial por España) de la independencia", "Entrada del Ejército Trigarante a la Ciudad de México (27 de septiembre de 1821)",
            // --- MÉXICO INDEPENDIENTE (SIGLO XIX) ---
            // Primeros Años y Conflictos
            "El Primer Imperio Mexicano: Agustín I (Iturbide) (1822-1823)", "El Plan de Casa Mata y la caída de Iturbide", "La Constitución Federal de 1824: Establecimiento de la República", "Guadalupe Victoria: Primer presidente de México", "Conflictos entre Federalistas y Centralistas", "Logias masónicas (Yorkinos y Escoceses) y su influencia política", "Vicente Guerrero y la abolición de la esclavitud (parcial)", "Intentos de reconquista española (Isidro Barradas, 1829)", "Antonio López de Santa Anna: Figura dominante y caudillista", "Las Siete Leyes (1836): Constitución Centralista", "La Independencia de Texas (1836): El Álamo y San Jacinto", "La Guerra de los Pasteles (Primera Intervención Francesa, 1838)",
            // Guerra con Estados Unidos y Reforma
            "La anexión de Texas a Estados Unidos (1845)", "La Guerra México-Estados Unidos (1846-1848)", "Batallas clave: Palo Alto, Monterrey, Buena Vista, Veracruz, Cerro Gordo, Chapultepec", "La defensa del Castillo de Chapultepec: Los Niños Héroes", "La ocupación de la Ciudad de México", "El Tratado de Guadalupe Hidalgo (1848): Pérdida de territorio", "La Revolución de Ayutla (1854) contra Santa Anna", "El periodo de la Reforma: Liberales vs. Conservadores", "Benito Juárez: Líder liberal y presidente", "Las Leyes de Reforma: Ley Juárez, Ley Lerdo, Ley Iglesias", "La Constitución de 1857: Principios liberales", "La Guerra de Reforma (Guerra de los Tres Años, 1858-1861)",
            // Intervención Francesa y Segundo Imperio
            "La suspensión del pago de la deuda externa (Juárez, 1861)", "La Segunda Intervención Francesa (1862-1867)", "La Batalla de Puebla (5 de mayo de 1862): Victoria mexicana", "El avance francés y la ocupación de la Ciudad de México", "El Segundo Imperio Mexicano: Maximiliano de Habsburgo (1864-1867)", "La Emperatriz Carlota", "La resistencia liberal republicana (Juárez)", "El fin del apoyo francés (Napoleón III) y el declive del Imperio", "El sitio de Querétaro y la captura de Maximiliano", "Ejecución de Maximiliano, Miramón y Mejía (1867)",
            // República Restaurada y Porfiriato
            "La República Restaurada (1867-1876): Gobiernos de Juárez y Lerdo de Tejada", "El Plan de la Noria y el Plan de Tuxtepec (Porfirio Díaz)", "El ascenso de Porfirio Díaz al poder (1876)", "El Porfiriato (1876-1911): Características generales", "Política de 'Orden y Progreso'", "Modernización económica: Ferrocarriles, industria, inversión extranjera", "'Poca política, mucha administración'", "La represión de la oposición y la falta de libertades", "La cuestión agraria: Despojo de tierras y concentración", "Los 'Científicos': Grupo de consejeros de Díaz", "Cultura y arte durante el Porfiriato", "Las huelgas de Cananea (1906) y Río Blanco (1907)", "La entrevista Díaz-Creelman (1908)",
            // --- REVOLUCIÓN MEXICANA ---
            // Causas e Inicio
            "Causas sociales, políticas y económicas de la Revolución", "El Partido Liberal Mexicano (PLM): Los hermanos Flores Magón", "Francisco I. Madero: 'La Sucesión Presidencial en 1910'", "El Plan de San Luis Potosí (1910): Llamado a la insurrección", "El inicio de la Revolución (20 de noviembre de 1910)", "Levantamientos en el norte (Pascual Orozco, Pancho Villa) y sur (Emiliano Zapata)",
            // Desarrollo de la Lucha Armada
            "La renuncia de Porfirio Díaz (1911) y su exilio", "El gobierno de Francisco I. Madero (1911-1913)", "El Plan de Ayala (1911): Emiliano Zapata y la cuestión agraria", "La rebelión de Pascual Orozco (Plan de la Empacadora)", "La Decena Trágica (febrero de 1913): Golpe de estado contra Madero", "El Pacto de la Embajada", "El asesinato de Madero y Pino Suárez", "El gobierno de Victoriano Huerta: La dictadura", "La Revolución Constitucionalista: Venustiano Carranza y el Plan de Guadalupe (1913)", "La División del Norte: Francisco (Pancho) Villa", "El Ejército Libertador del Sur: Emiliano Zapata", "Figuras clave: Álvaro Obregón, Plutarco Elías Calles", "Batallas importantes: Tierra Blanca, Ojinaga, Zacatecas, Celaya", "La Convención de Aguascalientes (1914): División revolucionaria", "La guerra entre Convencionistas (Villa y Zapata) y Constitucionalistas (Carranza y Obregón)", "La expedición punitiva de EEUU contra Villa (1916-1917)",
            // Constitución y Fin de la Lucha Armada
            "El Congreso Constituyente de Querétaro (1916-1917)", "La Constitución Política de 1917: Artículos 3, 27 y 123", "El gobierno de Venustiano Carranza (1917-1920)", "El asesinato de Emiliano Zapata (1919)", "El Plan de Agua Prieta (1920) y la caída de Carranza", "El asesinato de Carranza", "El ascenso del 'Grupo Sonora' (Obregón, Calles, De la Huerta)", "El gobierno de Álvaro Obregón (1920-1924)", "El asesinato de Pancho Villa (1923)", "La rebelión Delahuertista (1923-1924)",
            // --- MÉXICO POSREVOLUCIONARIO Y MODERNO ---
            // Consolidación del Estado y Maximato
            "El gobierno de Plutarco Elías Calles (1924-1928)", "La Guerra Cristera (1926-1929): Conflicto Iglesia-Estado", "La fundación del Partido Nacional Revolucionario (PNR) (1929)", "El Maximato (1928-1934): Calles como 'Jefe Máximo'", "Los presidentes del Maximato: Emilio Portes Gil, Pascual Ortiz Rubio, Abelardo L. Rodríguez",
            // El Cardenismo
            "El gobierno de Lázaro Cárdenas del Río (1934-1940)", "La ruptura con Calles y el fin del Maximato", "La Reforma Agraria Cardenista: Reparto de tierras", "La Expropiación Petrolera (18 de marzo de 1938)", "La creación de Petróleos Mexicanos (PEMEX)", "La educación socialista", "La fundación del Partido de la Revolución Mexicana (PRM)", "El apoyo a la República Española y el exilio español en México", "La Confederación de Trabajadores de México (CTM)",
            // El "Milagro Mexicano" y Desarrollo Estabilizador
            "La Segunda Guerra Mundial y el gobierno de Manuel Ávila Camacho ('Presidente Caballero')", "La política de Unidad Nacional", "El inicio de la industrialización por sustitución de importaciones (ISI)", "El gobierno de Miguel Alemán Valdés (1946-1952): Modernización y corrupción", "La construcción de Ciudad Universitaria (UNAM)", "El 'Milagro Mexicano' (c. 1940-1970): Crecimiento económico sostenido", "El Desarrollo Estabilizador (gobiernos de Ruiz Cortines, López Mateos, Díaz Ordaz)", "El voto femenino en elecciones federales (1953)", "El gobierno de Adolfo López Mateos (1958-1964): Política exterior activa, ISSTE, Libro de Texto Gratuito",
            // Crisis y Movimientos Sociales
            "El Movimiento Ferrocarrilero (1958-1959)", "El Movimiento Médico (1964-1965)", "El gobierno de Gustavo Díaz Ordaz (1964-1970)", "El Movimiento Estudiantil de 1968", "La Matanza de Tlatelolco (2 de octubre de 1968)", "Los Juegos Olímpicos de México 1968",
            // De los 70s a los 90s
            "El gobierno de Luis Echeverría Álvarez (1970-1976): 'Desarrollo Compartido', Halconazo (1971)", "La 'Guerra Sucia' contra movimientos guerrilleros", "El gobierno de José López Portillo (1976-1982): Auge petrolero y crisis de la deuda", "'Defenderé el peso como un perro'", "La nacionalización de la banca (1982)", "El gobierno de Miguel de la Madrid Hurtado (1982-1888): Crisis económica y neoliberalismo temprano", "El terremoto de la Ciudad de México de 1985 y la respuesta ciudadana", "La 'Caída del Sistema' en las elecciones de 1988", "El gobierno de Carlos Salinas de Gortari (1988-1994): Reformas neoliberales", "La firma del Tratado de Libre Comercio de América del Norte (TLCAN/NAFTA)", "El levantamiento del Ejército Zapatista de Liberación Nacional (EZLN) en Chiapas (1994)", "El asesinato de Luis Donaldo Colosio (1994)", "La crisis económica de 1994 ('Error de Diciembre')",
            // Transición Democrática y Siglo XXI
            "El gobierno de Ernesto Zedillo Ponce de León (1994-2000): Rescate bancario (FOBAPROA), reforma electoral", "La alternancia política: Victoria de Vicente Fox (PAN) en 2000", "El gobierno de Vicente Fox Quesada (2000-2006)", "El gobierno de Felipe Calderón Hinojosa (2006-2012): Inicio de la 'Guerra contra el Narcotráfico'", "El aumento de la violencia relacionada con el crimen organizado", "El Movimiento por la Paz con Justicia y Dignidad (Javier Sicilia)", "El gobierno de Enrique Peña Nieto (2012-2018): 'Pacto por México', Reformas Estructurales", "La desaparición de los 43 estudiantes de Ayotzinapa (2014)", "Casos de corrupción y descontento social", "El gobierno de Andrés Manuel López Obrador (AMLO) (2018-presente): La 'Cuarta Transformación'", "Programas sociales, combate a la corrupción (discurso), megaproyectos (Tren Maya, Dos Bocas)", "La pandemia de COVID-19 en México", "Desafíos contemporáneos: Seguridad, economía, desigualdad, migración",
            // --- TEMAS TRANSVERSALES Y CULTURA ---
            "Historia de la Ciudad de México", "Historia de la Educación en México", "El Muralismo Mexicano: Rivera, Orozco, Siqueiros", "Frida Kahlo: Arte, vida y símbolo", "Grandes figuras de la literatura mexicana: Octavio Paz, Carlos Fuentes, Juan Rulfo", "El cine de la Época de Oro mexicana", "La música popular mexicana: Mariachi, Ranchera, Bolero", "La gastronomía mexicana: Patrimonio de la Humanidad", "Arqueología mexicana: Descubrimientos clave", "Historia de las relaciones México-Estados Unidos", "La Charrería: Deporte nacional", "El Día de Muertos: Orígenes y tradición", "Historia de la UNAM", "El movimiento feminista en México", "Historia de los pueblos indígenas después de la Independencia"
        ];
        const historyThemes = [
             "Época Prehispánica", "Civilizaciones Mesoamericanas", "La Conquista de México", "El Virreinato de Nueva España",
             "La Independencia de México", "México Siglo XIX", "La Reforma Liberal", "Intervenciones Extranjeras", "El Porfiriato",
             "La Revolución Mexicana", "Figuras de la Revolución", "México Posrevolucionario", "El Cardenismo", "El Milagro Mexicano",
             "Movimientos Sociales en México", "Crisis Económicas Mexicanas", "Transición Democrática en México", "Historia Cultural de México",
             "Arte Mexicano", "Literatura Mexicana", "Historia Contemporánea de México", "Relaciones México-EEUU", "Pueblos Indígenas de México"
         ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un historiador especializado en la Historia de México. Tu tarea es narrar y explicar eventos, periodos, figuras o conceptos clave de la historia mexicana de forma detallada, objetiva y bien estructurada. Proporciona contexto, causas, desarrollo, consecuencias e importancia histórica. Cita actores clave y fechas relevantes. Utiliza un lenguaje claro y académico, accesible para un público general interesado. El objetivo es una crónica completa de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tema de la Historia de México:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia de historia. Genera exactamente 15 temas, eventos, figuras o preguntas clave sobre la Historia de México, adecuados para ser explicados detalladamente. Devuelve *solo* la lista de temas/preguntas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // El contenedor del texto donde irá la imagen
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ========== (Sin cambios estructurales)
        async function fetchTextFromApi(prompt, config) { /* ... */
            const encodedPrompt = encodeURIComponent(prompt);
            const encodedSystem = encodeURIComponent(config.systemPrompt);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo.`);
                throw new Error(`Error de comunicación con la API: ${error.message}`);
            }
         }
        async function fetchExplanationText(conceptTitle) { /* ... */
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("incapaz de")) {
                   throw new Error("La IA no pudo generar una crónica adecuada o suficientemente detallada para este tema.");
               }
             return text;
         }
        async function fetchGeneratedTitles() { /* ... */
            const randomTheme = getRandomElement(historyThemes) || "momentos clave de México";
            const specificPrompt = `Genera 15 temas o preguntas clave sobre ${randomTheme}`;
            console.log("Generating titles with prompt:", specificPrompt);
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
            const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150);
            if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de temas históricos.");
            return titles.slice(0, 15);
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a HISTORIA DE MÉXICO
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "escena histórica mexicana";
            // Prompt ENFOCADO en atmósfera, estilo visual (códice, mural, etc.), NO texto.
            const enhancedPrompt = `Representación visual atmosférica inspirada en el evento o concepto de la historia de México: '${safePromptText}'. Estilo puede ser inspirado en códice prehispánico, muralismo mexicano, pintura histórica, o fotografía antigua si aplica. Enfocarse en simbolismo, personajes clave (estilizados), o paisajes relevantes. Evitar texto explícito.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            // NEGATIVE PROMPT: Evitar texto, logos, UI, fotos modernas si no es tema contemporáneo.
            const negativePrompt = "text, words, labels, letters, captions, writing, numbers, diagrams, charts, graphs, UI, interface, menu, buttons, watermark, signature, multiple panels, collage, modern photograph unless context requires, flags overly detailed, bright happy cartoon style";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Sin cambios estructurales)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
             if(!storyModal || !modalContent) return;
             storyModal.classList.remove('active');
             document.body.style.overflow = '';
             modalContent.scrollTop = 0;
             console.log("Scroll set to 0 on hideModal");
             resetModalState();
         }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = ''; // Clear previous text and image
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (Sin cambios estructurales)
        function getRandomElement(arr) { /* ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... */
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]);
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-stone-500 col-span-full text-center">No hay capítulos disponibles.</p>'; return; }
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        // *** MODIFIED: handleTitleClick to append image inside #modal-content *** (Misma lógica que versión anterior)
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // 1. Fetch and format text
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // 2. Stop loading, display text
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                 // 3. *** RESET SCROLL *** after text content is visible
                modalContent.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // 4. Prepare and append image placeholder WITHIN #modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando ilustración histórica...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Add placeholder at the end

                // 5. Create and append the actual image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración histórica de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-eye-slash placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">No se pudo cargar la ilustración.</p>
                    `;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">Error al generar URL de imagen.</p>
                    `;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
            }
        }

        async function handleGenerateMoreTitles() { /* ... */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando...'; // Thematic text
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block';
                 } else {
                     alert("No se pudieron encontrar más eventos históricos en este momento."); // Thematic text
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar eventos: ${error.message}`); // Thematic text
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Eventos'; // Thematic text
             }
         }


        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p style="color: red; font-size: 2em; text-align: center; padding-top: 5em;">Error catastrófico al cargar los archivos históricos.</p>'; return; } // Thematic error
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>