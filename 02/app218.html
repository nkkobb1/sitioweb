<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuentos para Dormir - Dulces Sueños</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Suaves y Amigables -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Cuentos Infantiles --- */
        :root {
            --color-primary: #8ecae6; /* Azul Cielo Suave */
            --color-secondary: #ffb4a2; /* Rosa Durazno */
            --color-tertiary: #ffda63; /* Amarillo Sol Pálido */
            --color-background: #f8f7ff; /* Blanco Ligeramente Lavanda */
            --color-text: #5c5470; /* Morado Grisáceo Oscuro */
            --color-text-muted: #a8a2b4; /* Morado Grisáceo Claro */
            --color-modal-bg: #ffffff; /* Blanco Puro */
            --color-border: #e0ddee; /* Borde Lavanda Muy Claro */
            --color-error-bg: #ffe4e1; /* Fondo error rosa muy claro */
            --color-error-text: #b54c50; /* Texto error rosa oscuro */
            --color-error-border: #f7cac9; /* Borde error rosa claro */

            --shadow-sm: 0 2px 4px 0 rgba(92, 84, 112, 0.08);
            --shadow-md: 0 4px 8px -1px rgba(92, 84, 112, 0.1), 0 2px 4px -2px rgba(92, 84, 112, 0.08);
            --shadow-lg: 0 10px 15px -3px rgba(92, 84, 112, 0.1), 0 4px 6px -4px rgba(92, 84, 112, 0.1);
            --border-radius: 8px; /* Bordes más redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Quicksand', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px dotted var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700;}
        #modal-title { color: #6a6080; font-weight: 700; } /* Un poco más oscuro para título modal */
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #ffffff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Nunito'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(142, 202, 230, 0.3); outline: none; background-color: #ffffff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Nunito'; font-size: 1rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-secondary); border-left-color: var(--color-secondary); background-color: #fff8f6; }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 50px; /* Botón píldora */ font-family: 'Quicksand', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-md); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(92, 84, 112, 0.8); /* Overlay morado translúcido */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 850px; /* Ligeramente más estrecho */
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #edeafd; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-size: 1.05rem; /* Texto un poco más grande */ line-height: 1.8; /* Más espaciado */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 600; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Quicksand', sans-serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px dashed var(--color-border); padding-bottom: 0.5em; font-weight: 700; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid var(--color-border); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-tertiary); }

        /* --- Loading Indicator & Mini-Game --- */
        #modal-loading { text-align: center; padding: 2rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: none; /* Hidden by default */ flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #modal-loading.active { display: flex; } /* Show when loading */
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p.loading-text { font-weight: 600; color: var(--color-text); font-size: 1.2rem; font-family: 'Quicksand'; margin-bottom: 1.5rem; }
        /* Mini-Game Area */
        #modal-loading-game { position: relative; width: 80%; max-width: 300px; height: 100px; margin-bottom: 1rem; border: 1px dashed var(--color-border); border-radius: var(--border-radius); background-color: rgba(142, 202, 230, 0.1); }
        .clickable-star { position: absolute; font-size: 1.8rem; color: var(--color-text-muted); opacity: 0.6; cursor: pointer; transition: transform 0.2s ease, color 0.2s ease, opacity 0.2s ease; }
        .clickable-star:hover { transform: scale(1.2); opacity: 1; }
        .clickable-star.active { color: var(--color-tertiary); /* Amarillo brillante */ opacity: 1; transform: scale(1.1); animation: pulse 0.5s ease; }
        #game-score { font-size: 1rem; font-weight: 700; color: var(--color-primary); margin-top: 0.5rem; }
        #game-score .fa-star { color: var(--color-tertiary); margin-right: 4px;}

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1.1); } 50% { transform: scale(1.3); } 100% { transform: scale(1.1); } }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Nunito'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(92, 84, 112, 0.9); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid white; border-radius: var(--border-radius); box-shadow: 0 0 30px rgba(255,255,255, 0.3); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: white; transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-moon mr-3 text-yellow-300"></i> <!-- Icono luna -->
                     Dulces Sueños
                 </h1>
             </div>
             <span class="text-sm text-gray-500 font-sans tracking-wide">✨ Cuentos Mágicos para Dormir ✨</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Elige tu Aventura Nocturna</h1>
             <p class="text-lg text-gray-600 mb-8 max-w-3xl mx-auto font-light">Explora un mundo de historias llenas de magia y amistad, perfectas para acompañar los sueños de los más pequeños.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar un cuento por título...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-pink-400 mr-2"></i> <!-- Icono libro -->
                 Biblioteca de Sueños
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Abriendo el libro mágico de cuentos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">Parece que no hay cuentos con ese nombre... ¿probamos otro?</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     ¡Descubrir Más Cuentos! (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Game -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p class="loading-text">Tejiendo una nueva historia...</p>
                 <!-- Mini Game -->
                 <div id="modal-loading-game">
                     <!-- Stars will be added here by JS -->
                 </div>
                 <div id="game-score">
                     <i class="fas fa-star"></i> Estrellas activadas: <span id="score-count">0</span>
                 </div>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image and placeholder will be appended here -->
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-sad-tear"></i> <!-- Icono triste -->
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Ilustración del Cuento Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-blue-50 text-gray-500 py-6 mt-12 border-t border-blue-100 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias generadas por IA con cariño, para inspirar dulces sueños.</p>
              <p class="mt-1">¡Que la magia de los cuentos te acompañe!</p>
              <p class="mt-2">© <span id="current-year"></span> Biblioteca de Dulces Sueños</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Animales
            "El Osito que No Quería Dormir", "La Mariposa que Perdió sus Colores", "El Conejo Saltarín y la Luna Dormilona", "La Ardilla que Guardaba Estrellas", "El Pequeño Zorro y el Eco del Bosque", "La Tortuga que Soñaba con Volar", "El Gatito Curioso y el Hilo Mágico", "El Búho Sabio y el Secreto de la Noche", "Los Tres Cerditos y la Casa de Nubes", "La Ovejita que Contaba Personas para Dormir", "El Elefante que Aprendió a Susurrar", "El Pingüino Friolero Busca el Sol", "La Jirafa que Quería Ver las Nubes de Cerca", "El Castor Constructor y el Río Cantarín", "El Delfín Juguetón y las Perlas de Luz", "El Caballito de Mar y la Corriente Suave", "El León Valiente que Tenía Miedo a la Oscuridad", "El Pájaro Carpintero y la Melodía del Árbol", "La Luciérnaga Tímida que Iluminó el Camino", "El Mapache que Lavaba Sueños",
            // Magia y Fantasía
            "El Hada Perdida en el Jardín de Rocío", "El Pequeño Mago y su Varita Estornudadora", "El Duende Travieso y el Tesoro Escondido", "El Árbol Parlante del Bosque Susurrante", "El Dragón Amistoso que Escupía Flores", "La Princesa que Tejía con Hilos de Luna", "El Unicornio Blanco y el Arcoíris Nocturno", "El Gnomo Jardinero y las Semillas de Estrellas", "La Brujita Buena y la Poción de Risas", "El Gigante Gentil que Cuidaba Pajaritos", "El Caballero Valiente y la Flor Encantada", "El Río de Chocolate que Llevaba a la Tierra de los Dulces", "Las Nubes de Algodón que Sabían a Fresa", "El Espejo Mágico que Mostraba Sueños Bonitos", "La Alfombra Voladora que Viajaba Despacio", "El Genio de la Lámpara de Galleta", "El Castillo Flotante Hecho de Burbujas", "El Bosque Encantado Donde los Animales Hablan", "La Fuente de los Deseos Silenciosos", "El Sombrero Mágico que Cambiaba de Forma",
            // Aventuras Suaves
            "El Viaje de la Gota de Agua", "La Estrella Fugaz que Quería Quedarse", "Buscando el Color del Viento", "La Nube Curiosa que Bajó a la Tierra", "El Barquito de Papel que Cruzó el Charco", "La Semilla que Soñaba con Ser un Girasol Gigante", "El Niño que Pintó el Cielo de Naranja", "La Cometa que Rozó la Luna", "El Tren de Juguete y su Viaje Nocturno", "La Muñeca Perdida en el Parque", "El Robot Amistoso que Aprendió a Abrazar", "La Pelota Rebotadora que Llegó al Tejado", "El Lápiz Mágico que Dibujaba Amigos", "La Bicicleta que Aprendió a Cantar", "El Tesoro Escondido Debajo de la Cama", "La Aventura de la Hormiga Exploradora", "El Caracol que Corrió una Maratón Lenta", "El Misterio de la Galleta Desaparecida", "El Día que los Juguetes Cobraron Vida", "La Sombra Juguetona que Bailaba Sola",
            // Naturaleza y Calma
            "El Susurro del Viento entre las Hojas", "La Canción de Cuna del Río", "Cuando las Montañas Bosteza", "El Sol se Va a Dormir", "La Luna Cuida de las Estrellas", "El Baile Lento de los Copos de Nieve", "La Danza de las Olas en la Orilla", "El Silencio Mágico de la Nieve", "El Aroma de la Tierra Mojada Después de Llover", "El Secreto que Guardan las Piedras Lisas", "El Abrazo Cálido del Sol por la Mañana", "El Murmullo de las Abejas en las Flores", "La Paciencia del Árbol Centenario", "Cómo Crecen las Flores Mientras Duermes", "El Arcoíris Tímido Después de la Tormenta", "El Refugio Secreto Detrás de la Cascada", "La Familia de Hongos del Bosque", "El Lago Escondido de Aguas Tranquilas", "La Alfombra de Musgo Suave", "El Despertar de las Flores con el Rocío",
            // Temas Cotidianos y Emociones
            "El Miedo a la Oscuridad y su Amigo el Interruptor", "El Peluche Valiente que Venció a los Monstruos", "La Tristeza que se Convirtió en Burbuja", "El Enfadado que Aprendió a Respirar", "La Alegría Contagiosa de una Sonrisa", "El Primer Día en la Escuela de Nubes", "La Visita al Abuelo que Contaba Estrellas", "Compartiendo Juguetes con el Vecino Tímido", "Ayudando a Mamá a Hacer Galletas de Luna", "El Misterio del Calcetín Perdido", "Aprendiendo a Atarse los Cordones Mágicos", "El Diente que se Cayó y Esperaba al Ratón Pérez", "La Sopa Calentita en un Día Frío", "El Abrazo que Arregla Todo", "La Paciencia de Esperar el Cumpleaños", "El Secreto para Hacer Amigos Nuevos", "Cuidando una Plantita Pequeña", "El Orgullo de Aprender Algo Nuevo", "La Siesta Reparadora del Gato", "El Silencio Antes de Dormir",
             // Añadir más títulos iniciales aquí... (Aspirar a 200+ para empezar)
             "La Luciérnaga que buscaba su Luz", "El Granjero Amable y sus Animales Cantarines", "La Sirena que Coleccionaba Conchas Sonoras", "El Pirata Bueno que Buscaba Abrazos", "El Astronauta que Saludó a la Luna", "El Inventor de Sueños", "La Biblioteca Secreta de los Susurros", "El Panadero que Hacía Pan con Polvo de Estrellas", "La Costurera que Remendaba Nubes Grises", "El Cartero que Repartía Abrazos", "El Reloj que Daba la Hora de los Sueños", "La Llave Dorada que Abría el Corazón", "El Puente de Arcoíris sobre el Río de Leche", "La Isla Flotante de los Peluches Perdidos", "El Circo Silencioso de los Animales Nocturnos", "El Vendedor de Globos de Sueños", "El Jardín donde Crecen Caramelos", "El Tren que Atravesaba Paredes", "El Misterio de la Sombra que Perdí", "El Monstruo Debajo de la Cama que Quería un Cuento",
             "La Niña que Podía Hablar con los Pájaros", "El Niño que Tenía Estrellas en los Ojos", "El Abuelo que Convertía Verduras en Juguetes", "La Abuela que Tejía Bufandas de Niebla", "El Gato Negro que Daba Buena Suerte", "El Perro Guardián de los Sueños", "El Hámster Corredor de Laberintos de Nubes", "El Pez Volador que Nadaba en el Cielo", "El Cangrejo Ermitaño y su Casa Caracol Mágica", "La Rana Cantarina del Estanque de Plata", "El Erizo que Compartía sus Púas Suaves", "La Serpiente Amigable que Hacía Nudos Divertidos", "El Murciélago que Guiaba con Sonidos", "La Araña que Tejía Telarañas de Colores", "El Topo que Cavaba Túneles a la Fantasía", "El Escarabajo que Llevaba un Diamante en la Espalda", "La Libélula con Alas de Cristal", "El Colibrí que Pintaba Flores con su Pico", "La Cebra con Rayas de Arcoíris", "El Oso Polar que Vivía en un Iglú de Azúcar"
        ];
        const bedtimeStoryThemes = [
            "animales del bosque", "criaturas mágicas amigables", "aventuras suaves en la naturaleza", "historias sobre la luna y las estrellas", "cuentos sobre juguetes que cobran vida", "historias de amistad y ayuda", "cuentos sobre emociones (miedo, alegría)", "viajes imaginarios", "fantasía con comida divertida", "historias sobre la naturaleza (lluvia, nieve, sol)", "personajes como hadas, duendes, magos buenos", "objetos cotidianos con magia", "historias para superar pequeños miedos", "cuentos con sonidos relajantes", "historias sobre la familia y el hogar"
        ];
        const textApiConfig = {
            model: "mistral", // O un modelo que funcione bien con historias largas y creativas
            systemPrompt: "Eres un cuentacuentos muy tierno y paciente, especializado en historias para niños pequeños antes de dormir. Tu tarea es crear un cuento dulce, imaginativo y tranquilizador basado en el título proporcionado. Usa un lenguaje sencillo, claro y repetitivo si ayuda. Incluye personajes amables, situaciones positivas y un final muy calmado y feliz que invite al sueño. Evita sustos, conflictos fuertes o tristeza. La historia debe tener entre 1200 y 1300 palabras aproximadamente. Asegúrate de que el final sea especialmente suave y concluyente, dejando una sensación de paz y seguridad. Basa tu cuento únicamente en el siguiente título:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas para cuentos infantiles de dormir. Genera exactamente 40 títulos de cuentos originales, dulces, imaginativos y apropiados para niños pequeños (2-6 años). Deben ser títulos que inviten a la calma y la fantasía. Devuelve *solo* la lista de títulos, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo para generar 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area'); // Wrapper modal content
        const modalTextArea = document.getElementById('modal-content-area'); // Scrollable text + image area
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div for HTML text
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Mini-Game Elements
        const loadingGameArea = document.getElementById('modal-loading-game');
        const scoreCountElement = document.getElementById('score-count');
        const currentYearElement = document.getElementById('current-year');

        // ========== State Variables ==========
        let currentGameScore = 0;
        const numStarsInGame = 7; // Number of stars in the mini-game

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) {
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     // User-friendly error for network/server issues
                     throw new Error(`(Error ${response.status}) ¡Oh, oh! Parece que las estrellas no se alinean ahora mismo. Quizás los servidores de cuentos están muy ocupados. ¿Probamos de nuevo en un ratito?`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("¡Vaya! La hoja del cuento llegó en blanco. Quizás la magia necesite otro intento.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 // Basic check for potentially too short / unsuitable content
                 if (text.trim().length < 800 && !config.systemPrompt.includes("Genera exactamente 40 títulos")) { // Don't flag title generation
                    console.warn("API response seems short for a story.");
                    // Could potentially throw an error here if desired, or just proceed
                 }
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con el mundo de los sueños tardó mucho (>${config.timeoutSeconds}s). Revisa la conexión a internet o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado mientras se tejía la historia.");
             }
         }
        async function fetchStoryText(storyTitle) {
            return fetchTextFromApi(storyTitle, textApiConfig);
        }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(bedtimeStoryThemes) || "cuentos de animales amigables";
             const specificPrompt = `Genera 40 títulos de cuentos infantiles para dormir sobre ${randomTheme}`;
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
             if (titles.length < 20) throw new Error("No se pudieron generar suficientes ideas nuevas para cuentos."); // Need a good amount of the 40 requested
             return titles.slice(0, 40); // Return up to 40
         }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 600, height: 450, nologo: true }; // Slightly smaller image?
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "escena tierna de cuento infantil";
            // **Crucial prompt refinement for children's illustration**
            const enhancedPrompt = `Children's book illustration style, soft pastel colors, gentle scene inspired by '${safePromptText}'. Cute characters, dreamy atmosphere, warm lighting. NO TEXT, NO WORDS, NO LETTERS, NO LABELS. Whimsical and calming.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, signature, watermark, photorealistic, photograph, scary, dark, intricate details, complex background, multiple panels, border, frame";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                // Replace single newlines within a block with space for better paragraph flow
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0; // Ensure scroll reset on hide
            resetModalState();
        }
        function resetModalState() {
             // Hide content, show loading (initially hidden, controlled by .active)
             modalLoadingIndicator.classList.remove('active');
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             resetLoadingGame(); // Reset the mini-game
             hideFullscreenImage();
        }

        // ========== LOADING GAME FUNCTIONS ==========
        function setupLoadingGame() {
            if (!loadingGameArea) return;
            loadingGameArea.innerHTML = ''; // Clear previous stars
            for (let i = 0; i < numStarsInGame; i++) {
                const star = document.createElement('i');
                star.className = 'fas fa-star clickable-star';
                // Random position within the game area
                star.style.left = `${Math.random() * 90}%`; // Avoid edges
                star.style.top = `${Math.random() * 80}%`; // Avoid edges
                star.addEventListener('click', handleStarClick);
                loadingGameArea.appendChild(star);
            }
            resetLoadingGameScore(); // Ensure score starts at 0
        }
        function handleStarClick(event) {
            const star = event.target;
            if (!star.classList.contains('active')) {
                star.classList.add('active');
                currentGameScore++;
                updateGameScore();
                // Optional: Make it slightly more interactive
                setTimeout(() => {
                   // star.classList.remove('active'); // Make it clickable again after a delay? Or just keep it active? Let's keep it active.
                   // Maybe reposition after click?
                   // star.style.left = `${Math.random() * 90}%`;
                   // star.style.top = `${Math.random() * 80}%`;
                }, 500); // Delay matches pulse animation
            }
        }
        function updateGameScore() {
            if (scoreCountElement) {
                scoreCountElement.textContent = currentGameScore;
            }
        }
        function resetLoadingGameScore() {
            currentGameScore = 0;
            updateGameScore();
             // Reset visual state of stars
            loadingGameArea?.querySelectorAll('.clickable-star.active').forEach(star => {
                star.classList.remove('active');
            });
        }
        function resetLoadingGame() {
             resetLoadingGameScore();
             // Optionally remove/recreate stars if needed, but resetting score/visuals is usually enough
             loadingGameArea?.querySelectorAll('.clickable-star').forEach(star => {
                 star.classList.remove('active');
                 // Re-randomize positions if desired
                 // star.style.left = `${Math.random() * 90}%`;
                 // star.style.top = `${Math.random() * 80}%`;
             });
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Sort alphabetically for consistency
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">El libro mágico parece vacío por ahora...</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Added ${addedCount} new unique titles.`);
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick to integrate loading game ***
        async function handleTitleClick(title) {
            resetModalState(); // Clears content, resets game score
            showModal();
            modalTitle.textContent = title; // Set title early
            modalLoadingIndicator.classList.add('active'); // Show loading indicator + game
            setupLoadingGame(); // Initialize stars for clicking

            try {
                const rawStoryText = await fetchStoryText(title);
                const formattedStory = formatExplanationText(rawStoryText);

                // Story fetched successfully, hide loading, show content
                modalLoadingIndicator.classList.remove('active');
                modalContent.innerHTML = formattedStory; // Add story text
                modalStoryContentArea.classList.remove('content-hidden'); // Show the content area

                // *** CRUCIAL: Reset scroll AFTER content is potentially visible and flowed ***
                // Use requestAnimationFrame to ensure layout is done before scrolling
                requestAnimationFrame(() => {
                     modalTextArea.scrollTop = 0;
                     console.log("Scroll set to 0 after content visible");
                });


                // Prepare and add image placeholder AFTER text
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-magic placeholder-icon"></i> <!-- Icono magia -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Dibujando la ilustración...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Append to the end of text content

                // Create and load image
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración para el cuento: ${title}`;
                imgElement.style.display = 'none'; // Hide until loaded

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="far fa-image placeholder-icon" style="color: var(--color-text-muted);"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo dibujar la ilustración.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append image element
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al crear la URL mágica.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.classList.remove('active'); // Hide loading on error too
                modalErrorMessage.textContent = error.message || "¡Ups! Algo no salió bien al buscar el cuento.";
                modalError.classList.remove('content-hidden'); // Show error message area
                modalStoryContentArea.classList.remove('content-hidden'); // Ensure area is visible to show error
                modalContent.innerHTML = ''; // Clear partial content
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más magia...';
             try {
                 // Request 40 new titles
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     appendTitles(newTitles);
                     // Optional: scroll to bottom of list or near button?
                     // generateMoreBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                 } else {
                    alert("No encontramos más cuentos mágicos en este momento.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error buscando cuentos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Update button text correctly
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> ¡Descubrir Más Cuentos! (40)';
             }
         }

         // *** Search Filter Function (with accent normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Show if no results OR if list empty initially
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !imageFullscreenOverlay || !fullscreenCloseBtn || !loadingGameArea || !scoreCountElement || !currentYearElement) {
                console.error("Initialization failed: Missing essential UI elements.");
                document.body.innerHTML = '<p style="color: #b54c50; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: Quicksand;">¡Oh no! El libro mágico no se pudo abrir correctamente.</p>';
                return;
             }
            // Set current year in footer
            currentYearElement.textContent = new Date().getFullYear();

            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden'); // Start hidden
            setupLoadingGame(); // Prepare game stars initially (though hidden)
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>