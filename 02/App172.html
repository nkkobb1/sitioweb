<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abismo Psicológico - Relatos Interactivos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Evocadoras -->
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Merriweather:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Terror Psicológico --- */
        :root {
            --color-primary: #990000; /* Rojo Sangre Oscuro */
            --color-secondary: #4a4a6a; /* Gris Azulado Profundo */
            --color-tertiary: #cccccc; /* Gris Claro (Texto Principal) */
            --color-background: #0d0d0d; /* Negro Casi Absoluto */
            --color-modal-bg: #1a1a1a; /* Gris Muy Oscuro */
            --color-text: var(--color-tertiary);
            --color-text-muted: #7a7a7a; /* Gris Medio */
            --color-border: #333333; /* Borde Gris Oscuro */
            --color-error-bg: #4d0000; /* Fondo error rojo muy oscuro */
            --color-error-text: #ffcccc; /* Texto error claro */
            --color-error-border: var(--color-primary);

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.6), 0 4px 6px -4px rgba(0, 0, 0, 0.5);
            --border-radius: 2px; /* Bordes Casi Rectos */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        /* Títulos Principales con Fuente Temática */
        h1.logo, h1.page-title { font-family: 'Creepster', cursive; font-weight: 400; letter-spacing: 2px; color: var(--color-primary); text-shadow: 1px 1px 5px rgba(153, 0, 0, 0.7); }
        /* Títulos de Sección y Modal con Serif Leíble */
        h2.section-title, #modal-title { font-family: 'Merriweather', serif; font-weight: 700; color: var(--color-tertiary); }
        h2.section-title { border-bottom: 1px solid var(--color-primary); padding-bottom: 0.5rem; display: inline-block; }
        #modal-title { text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5); }

        .navbar { background-color: rgba(13, 13, 13, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 0 0 2px rgba(153, 0, 0, 0.4); outline: none; background-color: #222; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text-muted); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; border-left: 2px solid transparent; }
        .title-item:hover { transform: scale(1.03); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-tertiary); background-color: #252525; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: #eee; padding: 0.7rem 1.4rem; border: 1px solid #660000; border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        #generate-more-btn:hover:not(:disabled) { background-color: #b30000; border-color: var(--color-primary); box-shadow: var(--shadow-md); transform: scale(1.02); }
        #generate-more-btn:disabled { background-color: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; border-color: #222; }
        #generate-more-btn .fa-sync-alt { color: #eee; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(13, 13, 13, 0.96); /* Overlay muy oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 900px; /* Un poco más estrecho puede ser más atmosférico */
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Asegura altura para contenido y chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #333; border: 1px solid #444; border-radius: 50%; width: 35px; height: 35px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #fff; transform: rotate(90deg); box-shadow: 0 0 8px var(--color-primary); border-color: var(--color-primary); }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid #111; }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; color: var(--color-tertiary); font-weight: 300;} /* Texto un poco más claro que el muted */
        #modal-content strong { color: var(--color-primary); font-weight: 700; } /* Énfasis fuerte */
        #modal-content em { color: #b3b3b3; font-style: italic; font-weight: 400;} /* Énfasis sutil */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: #d9d9d9; border-bottom: 1px solid #444; padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.4em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.1em; color: #c0c0c0; }
        #modal-content h4 { font-size: 1.0em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; /* Más pequeña para atmósfera */ height: auto; margin: 3rem auto 1.5rem auto; border: 1px solid #222; border-radius: var(--border-radius); box-shadow: 0 0 15px rgba(0, 0, 0, 0.6); cursor: pointer; transition: all 0.3s ease; opacity: 0.85; /* Ligeramente desvanecida */ }
        #modal-content .final-image:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(153, 0, 0, 0.4); opacity: 1; border-color: var(--color-primary);}
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); opacity: 0.6; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(51, 51, 51, 0.8); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1.2s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; opacity: 0.7; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; /* Ligeramente menos altura */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(13, 13, 13, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) #222;
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: #222; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.5; font-size: 0.9rem; }
        .user-message { background-color: var(--color-secondary); color: #eee; margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #383838; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.85em; opacity: 0.8; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.9rem; border: 1px solid var(--color-border); background-color: #2a2a2a; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.9rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); background-color: #333; }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-secondary); color: #eee; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #5a5a7a; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-style: italic; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { /* Ajustar para el tema */ text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(13, 13, 13, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid #333; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.3s linear infinite; margin: 0 auto 1.8rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text-muted); font-size: 1.2rem; font-family: 'Merriweather', serif; text-shadow: 1px 1px 3px #000; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(13, 13, 13, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 1px solid var(--color-border); box-shadow: 0 0 25px rgba(0, 0, 0, 0.7); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: #fff; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-5 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-4xl sm:text-5xl">
                     <i class="fas fa-eye mr-3 text-red-800 transform scale-x-[-1]"></i> <!-- Icono ojo -->
                     Abismo Psicológico
                 </h1>
             </div>
             <span class="text-sm text-gray-500 font-sans tracking-wider uppercase">» Relatos Interactivos «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-6">Explora los Rincones Oscuros de la Mente</h1>
             <p class="text-lg text-gray-400 mb-8 max-w-3xl mx-auto font-light">Selecciona un fragmento de realidad distorsionada. Sumérgete en historias donde nada es lo que parece y la mayor amenaza reside en tu interior.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-xl mx-auto"> <!-- Más estrecho -->
             <input type="text" id="search-input" placeholder="Buscar susurros en la oscuridad...">
             <i class="fas fa-search fa-question-circle"></i> <!-- Icono lupa/pregunta -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-dead text-gray-500 mr-2"></i> <!-- Icono libro oscuro -->
                 Fragmentos Encontrados
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans italic">Buscando ecos en el vacío...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans italic">» El silencio responde... No se encontraron fragmentos «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Invocar Más Historias
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Descendiendo a la locura...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-6 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image and placeholder will be appended here via JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                    <h4 class="text-sm font-semibold text-gray-500 mb-2 text-center font-sans uppercase tracking-wider">Consulta al Abismo</h4>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> El vacío reflexiona...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Susurra tus preguntas aquí...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-black text-gray-600 py-6 mt-12 border-t border-gray-800 font-sans">
          <div class="container mx-auto px-4 text-center text-xs">
              <p>Los relatos son obras de ficción generadas por IA, inspiradas en el terror psicológico.</p>
              <p class="mt-1">Cualquier parecido con la realidad o la cordura es pura coincidencia.</p>
              <p class="mt-2">© ???? Abismo Psicológico</p> <!-- Año incierto -->
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Sanity & Reality
            "El Espejo Que No Me Refleja", "Ecos En La Habitación Vacía", "La Ciudad Que Olvidó Su Nombre", "Cuando Las Paredes Respiraron", "El Color Fuera De Tono", "El Mapa Imposible", "Mi Sombra Se Mueve Sola", "La Frecuencia Inaudible", "Despertar En Otro Cuerpo", "Las Estrellas Equivocadas", "El Día Que Se Repite", "La Grieta En El Cielo", "Fotografías Que Cambian", "El Reflejo Parpadea", "Texturas Incorrectas", "La Lógica Rota Del Sueño", "El Mundo Tras El Cristal", "Perdido En Mi Propia Casa", "El Reloj Que Va Hacia Atrás", "Caras En La Estática", "Sonidos Bajo La Piel", "El Paisaje Invertido", "La Puerta Que No Estaba Ayer", "Dibujos Infantiles Que Cobran Vida", "El Hombre Que No Podía Despertar", "Cuando Dejé De Reconocerme", "La Gravedad Fluctuante", "El Silencio Que Grita", "Los Objetos Se Reordenan", "El Aroma De Lo Imposible",
            // Paranoia & Isolation
            "La Última Casa Del Callejón Sin Salida", "Observado Desde La Ventana", "Pasos Que No Son Míos", "La Llamada Desde Dentro", "El Vecino Que Nunca Sale", "Sombras En La Periferia", "Me Siguen Los Maniquíes", "El Bosque Tras El Patio", "Motel De Carretera Vacío", "El Apartamento De Arriba", "Ruidos En El Sótano", "Estoy Seguro De Que Había Alguien", "Las Luces Se Apagan Solas", "El Coche Negro Aparcado", "Mensajes Anónimos Detallados", "Cámaras Ocultas", "La Sensación De Ser Reemplazado", "Todos Me Miran Igual", "El Pueblo Silencioso", "Aislado Por La Niebla", "El Único Despierto En La Ciudad", "Manchas De Humedad Que Parecen Caras", "La Radio Transmite Mis Pensamientos", "El Perro Del Vecino No Ladra", "Murmullos Tras La Puerta", "Figuras En La Nieve Fresca", "No Puedo Salir De Esta Habitación", "El Teléfono Suena Sin Parar", "Alguien Ha Estado Aquí", "La Presencia En El Asiento Trasero",
            // Body Horror (Subtle)
            "El Picor Que No Puedo Rascar", "Algo Crece Bajo El Suelo", "Mi Reflejo No Parpadea", "El Diente Que Se Afloja Solo", "La Mancha Que Se Extiende", "Siento Algo Moverse Dentro", "La Cicatriz Que Cambia De Forma", "Mis Huellas Dactilares Han Cambiado", "Perder Sensibilidad Al Tacto", "Escuchar Mis Propios Órganos", "La Piel Demasiado Tirante", "Uñas Que Crecen Demasiado Rápido", "El Ojo Que Ve Cosas Diferentes", "La Voz En Mi Garganta No Es Mía", "Desprendimiento De La Realidad Física", "El Sudor Frío Constante", "La Sensación De Encoger", "Huesos Que Crujen Al Moverse", "La Boca Seca Que No Se Humedece", "Cabello Que Cae En Mechones", "La Sangre Huele Diferente", "Visión Doble Persistente", "El Tatuaje Que Se Mueve", "No Siento Dolor", "El Latido Desincronizado",
            // Uncanny Valley
            "La Muñeca Que Ve La Televisión", "Sonrisas En El Escaparate", "El Retrato Familiar Perfecto", "El Maniquí Del Almacén", "La Máscara Que No Se Quita", "Juguetes Antiguos Que Se Mueven", "El Autómata Del Parque De Atracciones", "Figuras De Cera Demasiado Reales", "La Voz Sintética Que Aprende", "El Robot Doméstico Obsesionado", "Ojos De Botón", "La Marioneta Sin Hilos", "Reemplazado Por Un Doble Imperfecto", "La Sonrisa Fija", "Movimientos Lentos Y Antinaturales", "La Risa Grabada En Bucle", "Piel De Plástico Tibia", "El Eco De Pasos Pequeños", "La Colección De Ojos De Cristal", "El Mimo Silencioso", "Payasos Inmóviles", "Prótesis Abandonadas", "El Animatronic Estropeado", "Muñecas Rusas Infinitas", "El Valle De Los Maniquíes",
            // Existential & Cosmic Lite
            "El Patrón En La Estática", "Qué Significan Los Números", "La Geometría Imposible Del Edificio", "Sombras Más Antiguas Que La Luz", "El Sonido Que Precede Al Silencio", "La Ciudad Bajo Las Olas (Mental)", "Descifrando El Lenguaje De Los Insectos", "El Vacío Entre Los Segundos", "Conciencia En Los Objetos Inanimados", "El Fin Del Universo En Un Sueño", "Las Constelaciones Han Cambiado", "Atrapado En Una Metáfora", "La Biblioteca De Todas Las Vidas No Vividas", "El Hongo Que Conecta Mentes", "La Entidad En El Ruido Blanco", "Simulación Dentro De Simulación", "El Peso De La Eternidad", "Cuando El Cielo Se Volvió Rojo", "La Música Que Deshace La Realidad", "Entidades Hechas De Pura Matemática", "El Laberinto Conceptual", "Miedo Al Infinito", "La Verdad Escrita En El Polvo", "Ángeles Equivocados", "El Dios Olvidado En El Ático",
            // Memory & Identity
            "El Diario Que No Recuerdo Haber Escrito", "Caras Que Debería Conocer", "Despertar En La Vida De Otro", "Fotografías De Una Infancia Que No Tuve", "Amnesia Selectiva Perturbadora", "El Nombre Que No Es El Mío", "Recuerdos Implantados", "La Historia Se Reescribe Sola", "Perder El Reflejo Propio", "Voces De Vidas Pasadas", "Sentirse Un Extraño En La Propia Piel", "El Mapa Mental Borroso", "Fragmentos De Memoria Ajenos", "La Incapacidad De Formar Nuevos Recuerdos", "Robo De Identidad Sutil", "El Pasado Cambia Cada Día", "Las Cicatrices Que No Tienen Historia", "No Reconocer A Mi Familia", "El Eco De Quién Fui", "Múltiples Personalidades Luchando", "La Memoria Como Un Parásito", "Olvidar Cómo Hablar", "El Síndrome De Capgras Extremo", "Documentos Que Prueban Otra Vida", "Construyendo Un Yo Desde Cero",
            // Location Based
            "El Sanatorio Abandonado En La Colina", "El Faro Sin Luz", "La Habitación Sellada Del Hotel", "El Parque Infantil Nocturno", "La Escalera Que Sube Demasiado", "El Cine Vacío", "La Piscina Pública Turbia", "El Orfanato Quemado", "El Túnel Del Tren Olvidado", "La Casa Construida Al Revés", "El Campo De Espantapájaros", "La Iglesia Sumergida", "El Refugio Antiaéreo", "La Biblioteca Silenciosa", "El Invernadero Descuidado", "La Feria Ambulante Fantasma", "El Hospital Psiquiátrico Clausurado", "La Mina De Carbón Derrumbada", "El Pantano Que Susurra", "La Escuela Cerrada Por Vacaciones (Eternas)", "El Cementerio De Mascotas", "La Tienda De Antigüedades", "El Estudio Del Artista Loco", "La Mansión Victoriana Decrépita", "El Laberinto De Setos",
            // Object Based
            "La Caja De Música", "La Radio Antigua", "Metraje Encontrado", "La Carta No Enviada", "El Juguete Roto", "El Espejo Nublado", "El Reloj De Cucu Silencioso", "La Máquina De Escribir Que Predice", "El Cuadro Inacabado", "El Teléfono Descolgado", "La Llave Que No Abre Nada", "El Libro En Blanco", "La Grabadora Con Voces Extrañas", "El Columpio Que Se Mueve Solo", "La Fotografía Quemada", "El Anillo Encontrado", "El Vestido De Novia Manchado", "La Partitura Imposible", "El Tarot Maldito", "El Carrete De Hilo Rojo", "La Máscara Ritual", "El Diente De Leche Guardado", "La Pluma Fuente Sin Tinta", "El Casete Borrado", "El Amuleto Protector Que Falla",
            // Abstract & Intriguing
            "Tinnitus", "Parálisis Del Sueño", "Bucle De Déjà Vu", "Lo Periférico", "El Zumbido Constante", "Sinestesia Perturbadora", "El Efecto Mandela Personal", "Jamais Vu Crónico", "Sonidos Blancos Con Mensajes", "La Pareidolia Obsesiva", "El Síndrome Del Impostor Literal", "Fobia A Los Patrones", "Aritmomanía", "El Miedo A Las Puertas Cerradas", "La Sombra Del Ojo Flotador", "Vértigo Existencial", "Misofonía Extrema", "Ceguera Al Cambio", "El Olor Fantasma", "Prosopagnosia Súbita", "Anuptafobia Irracional", "El Impulso De La Llamada Del Vacío", "Disociación Permanente", "Despersonalización Constante", "Desrealización Inducida",
            // Adding more variations...
            "La Casa Que Recuerda", "El Eco de un Grito", "Manos Frías en la Noche", "El Retrato que Envejece", "La Melodía Olvidada", "El Pasajero Invisible", "Risas en el Desván", "El Jardín de Estatuas Humanas", "La Habitación 1408 (Concepto)", "El Carnaval de las Almas Perdidas", "Susurros en el Viento", "La Muñeca Rota", "El Libro de Piel Humana", "La Sombra bajo la Cama", "El Juego Peligroso", "La Entidad del Armario", "El Sanatorio del Dr. Moreau (Concepto)", "La Niebla que Devora", "El Pacto Siniestro", "El Pozo de los Deseos Oscuros", "La Máscara de Piel", "El Reflejo Asesino", "El Circo de Medianoche", "La Niña del Cuadro", "El Hombre del Saco Real", "La Canción de Cuna Mortal", "El Edificio Enfermo", "El Tren Fantasma", "La Ouija Rebelde", "El Amigo Imaginario Maligno", "La Ciudad Sumergida", "El Bosque Embrujado", "La Carretera Infinita", "El Espejo Negro", "La Presencia en la Oscuridad", "El Experimento Fallido", "El Culto Secreto", "La Venganza del Espantapájaros", "El Hospital Abandonado", "La Maldición Familiar", "El Objeto Poseído", "La Criatura del Lago", "El Payaso Triste", "La Voz en la Radio", "El Manicomio de Arkham (Concepto)", "La Casa de los Secretos", "El Demonio Interior", "El Reloj Detenido", "La Isla Prohibida", "El Tesoro Maldito",
            "El Último Hombre en la Tierra (con un giro)", "La Pesadilla Recurrente", "El Doppelgänger", "La Habitación del Pánico Interior", "Cuando los Sueños Sangran", "El Juego de la Mente", "La Terapia que Salió Mal", "Atrapado en el Tiempo", "El Virus de la Locura", "La Ciudad Silenciosa", "El Experimento Psicológico", "La Realidad Alternativa Hostil", "Miedo a Dormir", "Miedo a Despertar", "La Conciencia Culpable", "El Secreto Inconfesable", "La Paranoia Colectiva", "El Lavado de Cerebro", "La Secta del Fin del Mundo", "El Precio de la Inmortalidad", "La Máquina de los Sueños", "El Laberinto Mental", "La Pérdida de los Sentidos", "La Visión del Futuro Aterrador", "El Pasado que Persigue", "La Casa Inteligente Malévola", "El Bosque que Juzga", "El Mar de la Tranquilidad Rota", "La Montaña de la Locura (Concepto)", "El Desierto de Huesos", "La Jungla Urbana Depredadora", "El Metro a Ninguna Parte", "La Biblioteca de los Libros Prohibidos", "El Museo de Horrores Vivos", "El Teatro de las Marionetas Humanas", "La Tienda de Curiosidades Siniestras", "El Cementerio Indio (Concepto)", "El Faro Encantado", "La Prisión Mental", "La Isla de las Muñecas (Concepto)", "El Orfanato Siniestro", "La Escuela Embrujada", "El Hotel Overlook (Concepto)", "La Mansión Blackwood", "La Cripta Olvidada", "El Monasterio Maldito", "La Catedral Gótica Viviente", "El Castillo Drácula (Concepto Psicológico)", "El Pueblo Fantasma", "La Encrucijada del Diablo", "El Puente de los Suicidas"
            // ... (Reached over 400 concepts)
        ];
        const psychologicalHorrorThemes = [
            "pérdida de la cordura", "realidad distorsionada", "paranoia extrema", "aislamiento y soledad", "miedo a lo desconocido", "terror corporal sutil", "el valle inquietante (uncanny valley)", "muñecas y maniquíes", "horror existencial", "dudas sobre la identidad", "amnesia y memoria falsa", "lugares abandonados", "objetos cotidianos siniestros", "bucles temporales", "sueños y pesadillas", "presencias invisibles", "la oscuridad interior", "culpa y trauma", "cultos y sectas", "locura colectiva", "obsesión destructiva", "el doble (doppelgänger)", "ambigüedad narrativa", "atmósfera opresiva", "suspenso psicológico"
        ];
        const textApiConfig = { // Para el cuento principal
            model: "mistral", // O un modelo más potente si se necesita para narrativa compleja
            systemPrompt: "Eres un escritor especializado en terror psicológico. Tu tarea es escribir un cuento corto (aproximadamente 1200-1300 palabras) basado en el título proporcionado. Enfócate en crear una atmósfera opresiva, suspense creciente, ambigüedad y miedo interno. Sugiere el horror más que mostrarlo explícitamente. Utiliza la perspectiva de un narrador poco fiable o cuya percepción de la realidad está comprometida. Evita el gore excesivo y los jump scares. Explora temas como la paranoia, la pérdida de identidad, la fragilidad de la realidad, el aislamiento o los miedos subconscientes. El objetivo es dejar al lector inquieto y reflexionando. Basa tu cuento únicamente en el siguiente título:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúa como un analista críptico del subconsciente o un intérprete de los abismos de la mente. Responde preguntas sobre el cuento titulado '[TITLE]' que se está leyendo. Enfócate en sus posibles temas, simbolismos, ambigüedades o interpretaciones psicológicas. Mantén un tono misterioso y sugerente, sin dar respuestas definitivas. Sé conciso y relevante al cuento en cuestión.", // [TITLE] será reemplazado dinámicamente
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de conceptos inquietantes para cuentos de terror psicológico. Genera exactamente 15 títulos evocadores o ideas cortas que sugieran paranoia, irrealidad, miedo interno o lo siniestro en lo cotidiano. Devuelve *solo* la lista de títulos/conceptos, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Contenedor de texto+imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div del texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Contexto del chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             let systemPromptToUse = config.systemPrompt;
             if (isChat && currentStoryTitle) {
                 systemPromptToUse = chatApiConfig.systemPrompt.replace('[TITLE]', `'${currentStoryTitle}'`); // Reemplaza el placeholder
             }
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, intenta en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta del vacío llegó en silencio... Intenta preguntar de otra forma.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con el abismo se perdió (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo de nuevo.`);
                 }
                 throw new Error(error.message || "Una fuerza desconocida impidió la comunicación.");
             }
        }
        async function fetchStoryText(title) {
            return fetchTextFromApi(title, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentStoryTitle) throw new Error("Error interno: El contexto del relato se ha perdido en la oscuridad.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(psychologicalHorrorThemes) || "terror psicológico general";
            const specificPrompt = `Genera 15 títulos o conceptos inquietantes sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 4 && line.length < 100); // Ajustar longitud si es necesario
                     if (titles.length < 5) throw new Error("La inspiración oscura no llegó esta vez.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 768, height: 512, nologo: true }; // Relación aspecto más cinematográfica
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "abstract psychological horror concept";
             // Prompt ENFOCADO en atmósfera, simbolismo, oscuridad
             const enhancedPrompt = `Dark, atmospheric, surreal, conceptual artwork inspired by the psychological horror theme '${safePromptText}'. Focus on mood, shadow, unsettling imagery, liminal space, ambiguity. Use a muted or desaturated color palette. Avoid text, labels, gore, jump scares, clearly defined figures unless essential. Style of Beksiński, Giger (conceptual), or modern dark surrealism.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, title, caption, chart, graph, diagram, multiple images, collage, bright colors, happy, cheerful, cute, cartoon, photorealistic person, clear face, gore, blood, weapon, logo, signature, watermark";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                // Reemplazar saltos de línea simples por espacios para párrafos fluidos
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0; // Reset scroll
            console.log("Scroll reset on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null; // Limpia contexto
             hideFullscreenImage(); // Asegura cierre de imagen
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ==========
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = `Abismo: ${message}`; // Prefijo temático
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(error.message);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // No ordenar alfabéticamente para mantener un feel más caótico/encontrado
             // const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (titles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans italic">» El vacío permanece... No hay fragmentos «</p>'; return; }
             titles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Reaplicar filtro
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // SET CHAT CONTEXT
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // 1. Fetch and display story text
                const rawStoryText = await fetchStoryText(title);
                const formattedStory = formatExplanationText(rawStoryText);
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedStory;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is potentially large
                console.log("Scroll reset after text display");

                // 2. Prepare image placeholder (append AFTER text)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-eye-slash placeholder-icon"></i> <!-- Icono ojo cerrado/perturbador -->
                    <p style="font-size: 0.8em; margin-top: 0.8rem;">Visualizando el horror...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Append placeholder to the end of #modal-content

                // 3. Create image element and start loading
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none'; // Hidden until loaded

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                    // Scroll suavemente hacia la imagen una vez cargada (opcional)
                    // imgElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-question-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.8rem;">La visualización falló.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append the actual image element
                } else {
                     console.error("Could not create image URL:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-ban placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.8rem;">Error al crear URL.</p>`;
                }

                 // 4. Ensure chat is visible now that content is loaded
                chatSection.classList.remove('content-hidden'); // O si está dentro de modalStoryContentArea, ya debería ser visible


            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Un error desconocido acecha.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Ensure area is visible for error
                modalContent.innerHTML = ''; // Clear partial content
                chatSection.classList.add('content-hidden'); // Hide chat on main error
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando al oráculo...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("El oráculo permanece en silencio por ahora."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al invocar historias: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Invocar Más Historias';
             }
         }

         // Search Filter Function (maneja tildes)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check essential elements
            const requiredElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, modalTextArea, modalContent, modalLoadingIndicator, modalStoryContentArea, modalError, modalErrorMessage, chatHistory, chatLoadingIndicator, chatSection, fullscreenImage];
             if (requiredElements.some(el => !el)) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: #990000; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: \'Merriweather\', serif;">++ ERROR CRÍTICO // LA REALIDAD SE DESMORONA // FALTAN COMPONENTES ++</p>';
                 return;
             }

            // Add Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') { event.preventDefault(); handleSendMessage(); } }); // Prevent newline, send message
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial Display
            displayTitles(predefinedTitles); // Load initial titles
            noResultsMsg.classList.add('hidden'); // Hide 'no results' initially
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>