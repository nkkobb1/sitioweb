<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía Avanzada de Primeros Auxilios y Técnicas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Primeros Auxilios Avanzados --- */
        :root {
            --color-primary: #005f73; /* Azul petróleo (serio, médico) */
            --color-secondary: #0a9396; /* Teal (limpio, técnico) */
            --color-accent: #ee9b00; /* Naranja ámbar (alerta, atención) */
            --color-background: #ffffff; /* Blanco (limpio) */
            --color-text: #212529; /* Negro suave (legible) */
            --color-text-muted: #495057; /* Gris oscuro */
            --color-modal-bg: #f8f9fa; /* Gris muy claro para modal */
            --color-border: #ced4da; /* Gris medio para bordes */
            --color-danger: #ae2012; /* Rojo oscuro para errores */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 2px 4px -1px rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.06);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.05);
            --border-radius: 4px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto Slab', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        #modal-title { color: var(--color-primary); }
        .navbar { background-color: var(--color-background); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        .disclaimer { background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 0.75rem 1.25rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; text-align: center; font-size: 0.9em; }
        .disclaimer strong { font-weight: bold; }
        /* --- Search Input Styling --- */
        #search-container { margin-bottom: 2rem; position: relative; }
        #search-input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.8rem; /* More padding for icon */
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-normal);
        }
        #search-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 95, 115, 0.2); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; }
        /* --- Title List Styling --- */
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-background); padding: 1rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Align left for procedure names */ font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Roboto', sans-serif; }
        .title-item i { margin-right: 0.75rem; color: var(--color-primary); min-width: 20px; text-align: center; } /* Icon styling */
        .title-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f1fafa; } /* Light teal hover */
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #003f5c; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #adb5bd; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(33, 37, 41, 0.9); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 2rem 2.5rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 350px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            border: 1px solid var(--color-border);
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e9ecef; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.5rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #ced4da; color: #000; }
        #modal-title { font-size: 1.6rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1.5rem; line-height: 1.3; }
        #modal-content { /* Scrollable content area */
            line-height: 1.7;
            color: var(--color-text);
            white-space: normal;
            overflow-y: auto;
            padding: 0 15px 1.5rem 15px;
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content::-webkit-scrollbar { width: 9px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.2em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-accent); font-style: italic; font-weight: bold; } /* Emphasis with accent color */
        #modal-content ul, #modal-content ol { margin-left: 1.5rem; margin-bottom: 1.2em; }
        #modal-content li { margin-bottom: 0.5em; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto Slab', serif; margin-top: 1.8em; margin-bottom: 0.8em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.3em; font-weight: bold; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; font-weight: bold; }
        /* Style for critical warnings/notes within the text */
        #modal-content .warning, #modal-content .important-note {
            background-color: #fff3cd; border-left: 5px solid var(--color-accent); padding: 0.8rem 1rem; margin: 1.5em 0; color: #664d03; font-size: 0.95em;
        }
        #modal-content .warning strong, #modal-content .important-note strong { color: var(--color-accent); }
        /* --- Image within Content Styling --- */
        #modal-content .final-image { display: block; max-width: 70%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #e9ecef; }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(248, 249, 250, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid #ced4da; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.2rem; font-family: 'Roboto', sans-serif; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #f8d7da; color: var(--color-danger); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid #f5c6cb; margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
        #no-results-message { text-align: center; color: var(--color-text-muted); padding: 2rem; grid-column: 1 / -1; font-style: italic; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-6">
         <div class="container mx-auto px-4 py-3 flex justify-center items-center">
             <div class="flex items-center text-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-briefcase-medical mr-3 text-red-600"></i> <!-- Icono maletín médico -->
                     Primeros Auxilios Avanzados
                     <i class="fas fa-book-medical ml-3 text-blue-700"></i> <!-- Icono libro médico -->
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Disclaimer -->
         <div class="disclaimer">
             <strong>¡IMPORTANTE!</strong> Esta guía es solo para fines educativos e informativos. <strong>NO sustituye la formación profesional certificada ni el consejo médico cualificado.</strong> En una emergencia real, contacta inmediatamente a los servicios de emergencia locales (ej. 112, 911, 123 según tu país). Actúa siempre dentro de tu nivel de entrenamiento y la legislación local.
         </div>

         <!-- Hero section -->
         <section class="mb-8 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Dominando Técnicas de Emergencia</h1>
             <p class="text-lg text-gray-700 mb-6 max-w-3xl mx-auto">Explora procedimientos y conceptos avanzados de primeros auxilios. Utiliza el buscador o selecciona un tema de la lista para acceder a información detallada.</p>
             <!-- Search Input -->
             <div id="search-container" class="max-w-2xl mx-auto">
                 <i class="fas fa-search"></i>
                 <input type="text" id="search-input" placeholder="Buscar técnica, evaluación o emergencia...">
             </div>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-cogs text-teal-600 mr-2"></i> <!-- Icono engranajes/procesos -->
                 Índice de Técnicas y Conceptos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Cargando procedimientos...</p>
                  <!-- No results message will be injected here by JS -->
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Cargar Más Técnicas
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Recuperando procedimiento...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - Image appended here -->
                 <div id="modal-content" class="text-sm md:text-base">
                     <!-- Explanation text (HTML) goes here -->
                     <!-- Image and placeholder will be appended here by JS -->
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-300">
          <div class="container mx-auto px-4 text-center text-xs sm:text-sm">
              <p><strong>Recordatorio:</strong> La información aquí presentada es educativa y no reemplaza la formación práctica certificada ni la consulta médica profesional.</p>
              <p class="mt-1">Actúa responsablemente y prioriza siempre la seguridad y la llamada a los servicios de emergencia.</p>
              <p class="mt-2">© 2025 Guía Avanzada de Primeros Auxilios</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Principios y Evaluación
            "Evaluación de la Escena y Seguridad (Primeros Auxilios)", "Precauciones Universales y EPP (Equipo Protección Personal)", "Obtención de Consentimiento Informado (Primeros Auxilios)", "Evaluación Primaria (ABCDE - Enfoque Primeros Auxilios)", "Evaluación Secundaria (SAMPLE, OPQRST - Contexto Primeros Auxilios)", "Niveles de Conciencia: Escala AVPU", "Escala de Coma de Glasgow (GCS) - Interpretación Básica", "Signos Vitales Básicos (Pulso, Respiración, Piel) - Evaluación", "Evaluación Rápida de Trauma (Cabeza a Pies - Básico)", "Documentación Básica del Incidente (Primeros Auxilios)", "Comunicación con Servicios de Emergencia (SBAR/MIST - Introducción)", "Principios de Triage en Incidentes con Múltiples Víctimas (START - Básico)", "Triage SALT - Introducción", "Consideraciones Éticas en Primeros Auxilios Avanzados", "Manejo del Estrés en Incidentes Críticos (Para el Auxiliador)", "Psicological First Aid (Primeros Auxilios Psicológicos) - Principios",
            // Soporte Vital Básico (SVB / BLS) y Reanimación
            "Reconocimiento del Paro Cardiorrespiratorio (PCR)", "RCP de Alta Calidad en Adultos", "RCP de Alta Calidad en Niños", "RCP de Alta Calidad en Lactantes", "Uso del Desfibrilador Externo Automático (DEA/AED)", "RCP con Dispositivo Bolsa-Mascarilla (BVM) - Técnica Básica a 1 y 2 rescatadores", "Compresiones Torácicas Continuas (Solo Compresiones)", "Manejo de la Obstrucción de Vía Aérea (OVACE) - Adulto Consciente", "Manejo de la OVACE - Adulto Inconsciente", "Manejo de la OVACE - Niño Consciente", "Manejo de la OVACE - Niño Inconsciente", "Manejo de la OVACE - Lactante Consciente", "Manejo de la OVACE - Lactante Inconsciente", "Posición Lateral de Seguridad (Recuperación)", "Ventilación de Rescate (Sin compresiones)",
            // Manejo de la Vía Aérea y Respiración
            "Apertura Manual de la Vía Aérea: Maniobra Frente-Mentón", "Apertura Manual de la Vía Aérea: Tracción Mandibular", "Identificación de Ruidos Respiratorios Anormales (Básico)", "Uso de Cánula Orofaringea (OPA / Guedel)", "Uso de Cánula Nasofaringea (NPA)", "Aspiración de Secreciones (Manual y Mecánica Básica)", "Administración de Oxígeno Suplementario: Cánula Nasal", "Administración de Oxígeno Suplementario: Mascarilla Simple", "Administración de Oxígeno Suplementario: Mascarilla con Reservorio (No Reinhalación)", "Administración de Oxígeno Suplementario: Uso con BVM", "Reconocimiento de Dificultad Respiratoria Aguda", "Manejo Inicial del Ataque de Asma", "Manejo Inicial de la Exacerbación de EPOC", "Manejo Inicial de la Hiperventilación", "Reconocimiento del Neumotórax Simple", "Reconocimiento y Manejo Inicial del Neumotórax Abierto (Herida Torácica Aspirante)", "Sellado de Herida Torácica (Parche de 3 lados)", "Reconocimiento y Manejo Inicial del Tórax Inestable (Flail Chest)", "Reconocimiento del Neumotórax a Tensión (Signos)", "Descompresión con Aguja (Concepto y Indicaciones - NO procedimiento)",
            // Hemorragias y Shock
            "Control de Hemorragias Externas: Presión Directa", "Control de Hemorragias Externas: Elevación", "Control de Hemorragias Externas: Puntos de Presión Arterial", "Aplicación Correcta de un Torniquete Comercial (CAT, SOFTT-W)", "Aplicación de un Torniquete Improvisado (Cuándo y Cómo - con precauciones)", "Uso de Agentes Hemostáticos (Gasa Hemostática)", "Manejo de Hemorragia Nasal (Epistaxis)", "Reconocimiento del Shock (Signos y Síntomas Tempranos y Tardíos)", "Clasificación del Shock (Hipovolémico, Cardiogénico, Distributivo, Obstructivo - Básico)", "Manejo Inicial del Shock Hipovolémico (Posición, Temperatura)", "Manejo Inicial del Shock Anafiláctico (Posición, Ayuda con Autoinyector)", "Manejo Inicial del Shock Neurogénico (Posición, Temperatura)", "Manejo Inicial del Shock Séptico (Reconocimiento temprano)", "Manejo Inicial del Shock Cardiogénico (Posición semi-sentado)", "Prevención de Hipotermia en Pacientes con Hemorragia/Shock",
            // Trauma Musculoesquelético
            "Evaluación de Lesiones Musculoesqueléticas (Dolor, Deformidad, Edema, Crepitación)", "Principios Generales de Inmovilización y Ferulización", "Aplicación de Férula Rígida", "Aplicación de Férula Blanda (Almohada, Manta)", "Aplicación de Cabestrillo y Venda de Inmovilización (Brazo/Hombro)", "Inmovilización de Fracturas de Extremidad Superior (Húmero, Cúbito/Radio)", "Inmovilización de Fracturas de Extremidad Inferior (Fémur - conceptual, Tibia/Peroné)", "Férula de Tracción (Indicaciones y Concepto Básico - NO procedimiento detallado)", "Manejo de Luxaciones (Inmovilizar en posición encontrada)", "Manejo de Esguinces y Distensiones (RICE/PRICE)", "Manejo de Fracturas Abiertas (Cubrir herida, controlar sangrado, inmovilizar)", "Inmovilización de Fractura de Pelvis (Atado Pélvico/Sábana)", "Manejo de Amputaciones Traumáticas (Cuidado del muñón y de la parte amputada)", "Síndrome Compartimental (Reconocimiento - Las 5 'P')", "Lesiones por Aplastamiento (Crush Injury) - Consideraciones Iniciales",
            // Trauma Específico (Cabeza, Columna, Tórax, Abdomen)
            "Evaluación del Traumatismo Craneoencefálico (TCE)", "Signos de Fractura de Base de Cráneo (Ojos Mapache, Signo de Battle)", "Manejo de Heridas en Cuero Cabelludo", "Reconocimiento de Conmoción Cerebral (Signos y Síntomas)", "Principios de Restricción del Movimiento Espinal (RME)", "Indicaciones para la RME (Mecanismo Lesional, Evaluación Clínica)", "Estabilización Manual de la Columna Cervical", "Colocación de Collarín Cervical (Técnica básica)", "Uso de Tabla Espinal Larga (Log-Roll / Cuchara - Técnica básica)", "Evaluación del Trauma Torácico (Inspección, Palpación, Auscultación básica)", "Manejo de Heridas Penetrantes en Tórax (Ver Neumotórax Abierto)", "Manejo de Trauma Contuso Torácico (Sospecha de lesiones internas)", "Evaluación del Trauma Abdominal (Inspección, Palpación)", "Manejo de Heridas Penetrantes en Abdomen (No extraer objetos)", "Manejo de Evisceración Abdominal (Cubrir con apósito húmedo estéril)", "Trauma Pélvico (Ver Inmovilización)",
            // Lesiones Ambientales
            "Manejo de Hipotermia Leve, Moderada y Severa", "Recalentamiento Pasivo y Activo Externo", "Manejo de Congelación Superficial y Profunda (Frostbite)", "Prevención de Lesiones por Frío", "Manejo del Agotamiento por Calor", "Manejo del Golpe de Calor (Enfriamiento rápido inmediato)", "Prevención de Lesiones por Calor", "Manejo de Quemaduras Térmicas (1er, 2do, 3er grado)", "Regla de los Nueves para Calcular Superficie Corporal Quemada (SCQ)", "Enfriamiento Inicial de Quemaduras Térmicas", "Cobertura de Quemaduras", "Manejo de Quemaduras Químicas (Irrigación abundante)", "Manejo de Quemaduras Eléctricas (Seguridad, buscar entrada/salida)", "Manejo de Ahogamiento y Casi Ahogamiento (RCP si necesario)", "Manejo de Mal de Montaña Agudo (Descenso, Oxígeno si disponible)", "Manejo de Edema Pulmonar de Altitud (Descenso rápido)", "Manejo de Edema Cerebral de Altitud (Descenso rápido)", "Manejo de Lesiones por Rayo (Seguridad, RCP si necesario)",
            // Mordeduras, Picaduras e Intoxicaciones
            "Manejo General de Mordeduras de Animales (Limpieza, profilaxis rabia/tétanos)", "Manejo de Mordeduras de Serpiente (Inmovilización, calma, NO torniquetes/incisiones)", "Manejo de Picaduras de Insectos (Abejas, Avispas, Hormigas)", "Extracción de Aguijón de Abeja", "Manejo de Picaduras de Araña (Viuda Negra, Reclusa Parda - Reconocimiento básico)", "Manejo de Picaduras de Escorpión", "Manejo de Picaduras de Medusa y Otros Animales Marinos", "Reconocimiento de Intoxicación o Sobredosis (Signos generales)", "Contacto con Centro de Toxicología", "Administración de Carbón Activado (Indicaciones/Contraindicaciones básicas)", "Manejo de Intoxicación por Monóxido de Carbono", "Manejo de Intoxicación Etílica Aguda", "Manejo de Intoxicación por Opiáceos (Naloxona - si entrenado/autorizado)", "Manejo de Ingesta de Cáusticos (NO inducir vómito)", "Manejo de Exposición a Químicos (Descontaminación)",
            // Emergencias Médicas Comunes
            "Reconocimiento del Dolor Torácico Sugerente de Infarto (SICA)", "Manejo Inicial del Dolor Torácico (Posición, Ayuda con AAS/Nitroglicerina si indicado/prescrito)", "Reconocimiento del Accidente Cerebrovascular (ACV / Stroke) - Escala FAST/BEFAST", "Manejo Inicial del ACV (Posición, Hora de inicio, No dar nada por boca)", "Manejo de Convulsiones Tónico-Clónicas (Proteger de lesiones, posición lateral post-ictal)", "Estado Epiléptico (Convulsión prolongada) - Reconocimiento", "Manejo de la Hipoglucemia (Administración de glucosa oral si consciente)", "Manejo de la Hiperglucemia (Reconocimiento, no administrar insulina)", "Reconocimiento de Reacción Alérgica Leve vs. Anafilaxia", "Manejo de Anafilaxia (Uso de Autoinyector de Epinefrina)", "Manejo de Dificultad Respiratoria (Ver Vía Aérea/Respiración)", "Manejo del Dolor Abdominal Agudo (Evaluación básica, posición confort)", "Reconocimiento Temprano de Sepsis (Signos vitales, estado mental)", "Síncope (Desmayo) - Manejo y Evaluación Post-Síncope",
            // Parto de Emergencia y Cuidado Neonatal Básico
            "Reconocimiento del Parto Inminente", "Preparación para un Parto de Emergencia", "Asistencia al Parto Normal (Maniobras básicas)", "Cuidado Inmediato del Recién Nacido (Secado, Estimulación, Calor)", "Pinzamiento y Corte del Cordón Umbilical (Técnica aséptica)", "Manejo de la Hemorragia Postparto (Masaje Uterino)", "Reanimación Neonatal Básica (Si no respira)",
            // Lesiones Específicas (Ojos, Dientes, etc.)
            "Manejo de Cuerpos Extraños en el Ojo (Irrigación)", "Manejo de Heridas Penetrantes en el Ojo (Estabilizar objeto, cubrir AMBOS ojos)", "Manejo de Quemaduras Químicas Oculares (Irrigación prolongada)", "Manejo de Avulsión Dental (Transporte del diente)", "Manejo de Fractura Dental",
            // Consideraciones Especiales
            "Primeros Auxilios Pediátricos: Triángulo de Evaluación Pediátrica (TEP)", "Primeros Auxilios Geriátricos: Consideraciones Especiales", "Primeros Auxilios en Pacientes con Necesidades Especiales", "Primeros Auxilios en Entornos Remotos/Agrestes (Wilderness First Aid - Principios)", "Principios de Cuidado Táctico de Heridos en Emergencias (TECC/TCCC - Introducción: MARCH)",
            // Listado muy extenso, fácilmente supera los 400 items si se desglosan sub-pasos o variaciones.
            "Evaluación del Pulso Carotídeo", "Evaluación del Pulso Radial", "Evaluación del Pulso Braquial (Lactantes)", "Evaluación del Llenado Capilar", "Evaluación del Color, Temperatura y Humedad de la Piel", "Auscultación Pulmonar Básica (Presencia/Ausencia de Murmullo Vesicular)", "Medición de Frecuencia Respiratoria", "Medición de Frecuencia Cardíaca", "Uso de Manta Térmica", "Técnica de Arrastre por Ropa", "Técnica de Levantamiento en Camilla de Cuchara", "Técnica de Giro en Bloque (Log Roll)", "Aplicación de Vendaje Circular", "Aplicación de Vendaje en Espiral", "Aplicación de Vendaje en Ocho", "Aplicación de Vendaje para Muñón", "Aplicación de Vendaje Ocular", "Aplicación de Vendaje Compresivo", "Irrigación de Heridas", "Limpieza Básica de Heridas", "Aplicación de Apósito Estéril", "Aplicación de Apósito Oclusivo", "Aplicación de Apósito No Adherente", "Manejo de Cuerpos Extraños Empalados (No retirar, estabilizar)", "Reconocimiento de Signos de Infección en Heridas", "Escala del Dolor (Numérica, Caras)", "Evaluación Pupilar (PERRLA - Básico)", "Identificación de Edema", "Identificación de Crepitación Ósea", "Identificación de Inestabilidad Articular", "Maniobra de Ortolani/Barlow (Conceptual - Luxación cadera bebé)", "Exploración Sensorial Básica (Tacto)", "Exploración Motora Básica (Movimiento)", "Balance Hídrico (Concepto básico en deshidratación)", "Reconocimiento de Deshidratación", "Rehidratación Oral (Uso de SRO)", "Indicaciones de Evacuación Rápida", "Protocolo de Actuación ante PCR", "Cadena de Supervivencia (AHA)", "Importancia de la Desfibrilación Temprana", "Evaluación de la Seguridad Eléctrica", "Evaluación de Riesgos Químicos (HAZMAT Básico)", "Evaluación de Riesgos Biológicos", "Uso Correcto de Guantes Desechables", "Higiene de Manos (Agua y Jabón / Gel Alcohólico)", "Eliminación Segura de Material Contaminado", "Manejo de Exposición a Sangre o Fluidos Corporales", "Profilaxis Post-Exposición (PEP - Concepto)", "Cinemática del Trauma (Evaluación del Mecanismo Lesional)", "Índice de Sospecha", "Evaluación ABC en Trauma vs. CAB en PCR", "La 'Hora Dorada' en Trauma (Concepto)", "Transporte en Posición de Trendelenburg (Indicaciones/Contraindicaciones)", "Transporte en Posición de Fowler/Semi-Fowler", "Transporte en Decúbito Lateral Izquierdo (Embarazadas)", "Inmovilización en Silla de Extracción (KED - Concepto)", "Retirada Segura de Casco (Técnica a 2 rescatadores)", "Trabajo en Equipo en Primeros Auxilios", "Liderazgo en la Escena", "Transferencia del Paciente a SEM", "Informe Verbal Estructurado", "Registro Escrito Detallado", "Aspectos Legales: Deber de Actuar, Negligencia, Abandono", "Ley del Buen Samaritano (Concepto General)", "Confidencialidad del Paciente", "Manejo de Situaciones Violentas o Agresivas", "Autocuidado del Primer Respondiente", "Debriefing Post-Incidente", "Recursos Comunitarios de Apoyo (Salud Mental)", "Actualización Continua en Primeros Auxilios"
        ];
        const firstAidThemes = [ // Temas para generar más títulos
            "evaluación del paciente", "soporte vital básico (svb)", "manejo de vía aérea", "control de hemorragias",
            "manejo del shock", "trauma musculoesquelético", "inmovilización y ferulización", "traumatismo craneoencefálico (tce)",
            "lesiones de columna", "trauma torácico", "trauma abdominal", "lesiones ambientales (frío/calor)",
            "quemaduras", "intoxicaciones y envenenamientos", "mordeduras y picaduras", "emergencias médicas (cardíacas, respiratorias, neurológicas, metabólicas)",
            "reacciones alérgicas y anafilaxia", "parto de emergencia", "primeros auxilios pediátricos", "primeros auxilios geriátricos",
            "triage y manejo de múltiples víctimas", "principios de seguridad en la escena", "equipo de protección personal (epp)",
            "aspectos éticos y legales", "primeros auxilios psicológicos", "primeros auxilios en entornos agrestes"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un instructor experimentado en soporte vital avanzado y medicina de emergencia (paramédico, médico de urgencias o enfermero de cuidados críticos). Tu tarea es explicar técnicas, procedimientos de evaluación o manejo de emergencias médicas/traumáticas de forma clara, precisa, detallada y estructurada. Cuando describas un procedimiento, hazlo paso a paso. Incluye indicaciones, contraindicaciones importantes (si aplica), puntos clave, posibles complicaciones y signos de alerta. **Enfatiza SIEMPRE que esta información es estrictamente educativa, NO sustituye la formación práctica certificada por instructores cualificados, y que toda actuación debe realizarse dentro del ámbito de la propia formación, certificación y la legislación local.** El objetivo es una descripción exhaustiva de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tema:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un manual avanzado de primeros auxilios/emergencias. Genera exactamente 15 nombres de técnicas específicas, procedimientos de evaluación, manejo de emergencias médicas o traumáticas, o conceptos clave de soporte vital. Devuelve *solo* la lista de nombres, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios significativos de nombres)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Container for text AND image
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        let noResultsMessageElement = null;

        // ========== API FUNCTIONS ========== (Sin cambios en la lógica fetch)
        async function fetchTextFromApi(prompt, config) { /* ... */
            const encodedPrompt = encodeURIComponent(prompt);
            const encodedSystem = encodeURIComponent(config.systemPrompt);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                console.log(`API Response received (${text.length} chars)`);
                // Basic check for refusal
                if (text.toLowerCase().includes("cannot provide medical advice") || text.toLowerCase().includes("consult a medical professional") || text.toLowerCase().includes("not qualified to")) {
                    console.warn("API potentially refused medical-like request.");
                    // Allow proceeding but log it. More robust checks could be added.
                }
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo.`);
                throw new Error(`Error de comunicación con la API: ${error.message}`);
            }
         }
        async function fetchExplanationText(conceptTitle) { /* ... */
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
              if (text.trim().length < 500 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("unable to generate") || text.toLowerCase().includes("not provide detailed medical procedures")) { // Adjust length check and refusal phrases
                   throw new Error("La IA no pudo generar una explicación adecuada o suficientemente detallada para este tema, posiblemente debido a restricciones de contenido médico.");
               }
             return text;
        }
        async function fetchGeneratedTitles() { /* ... */
            const randomTheme = getRandomElement(firstAidThemes) || "técnicas esenciales de primeros auxilios";
            const specificPrompt = `Genera 15 nombres de técnicas o conceptos clave sobre ${randomTheme}`;
            console.log("Generating titles with prompt:", specificPrompt);
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
            const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 100);
            if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de temas.");
            return titles.slice(0, 15);
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a PRIMEROS AUXILIOS
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 600, height: 400, nologo: true }; // Smaller image maybe
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText.split('(')[0].trim() : "first aid concept";
            // Prompt ENFOCADO en concepto, no gráfico
            const enhancedPrompt = `Abstract conceptual visualization representing '${safePromptText}'. Minimalist style using shapes, lines, and subtle medical iconography (like heartbeat line, cross, abstract anatomy). Focus on clarity, process, or intervention concept. Avoid realistic depiction or gore. Clean background.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "realistic human body, graphic injury, blood, gore, surgery, specific medical devices, text, labels, instructions, diagram, chart, photograph, cluttered background";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();

            // ** CRUCIAL: Inject disclaimer again into the text if missing **
             if (!formatted.toLowerCase().includes("no sustituye la formación profesional") && !formatted.toLowerCase().includes("strictly educational")) {
                 formatted = `<p class="warning"><strong>Nota Importante:</strong> La siguiente información es estrictamente para fines educativos y no reemplaza la formación práctica certificada ni el consejo médico profesional. Actúe siempre según su nivel de entrenamiento y contacte a los servicios de emergencia.</p>\n\n` + formatted;
             }

            // Standard Markdown-like formatting
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Handle lists (simple cases)
            formatted = formatted.replace(/^\s*[-*+]\s+(.*)$/gm, '<li>$1</li>'); // Basic unordered list items
             // Basic ordered list items (needs improvement for nested/complex lists)
            formatted = formatted.replace(/^\s*\d+\.\s+(.*)$/gm, '<li>$1</li>');

            // Wrap consecutive <li> items in <ul> or <ol> (simple approach)
             formatted = formatted.replace(/^(<li>.*<\/li>\s*)+/gm, (match) => {
                 // Crude check for ordered vs unordered based on first item
                 const isOrdered = /<li>.*<\/li>/.test(match) && /^\s*\d+\./.test(rawText.substring(rawText.indexOf(match.split('\n')[0]), rawText.indexOf(match.split('\n')[0]) + 10)); // Check original text
                 const listTag = isOrdered ? 'ol' : 'ul';
                 return `<${listTag}>\n${match}</${listTag}>\n`;
             });


            // Paragraph handling: Split by double newlines, wrap non-list/header blocks in <p>
            const blocks = formatted.split(/\n\s*\n/); //.filter(p => p.trim().length > 0); // Allow empty lines between elements
            formatted = blocks.map(block => {
                 const trimmedBlock = block.trim();
                 if (trimmedBlock.startsWith('<h') || trimmedBlock.startsWith('<ul') || trimmedBlock.startsWith('<ol') || trimmedBlock.startsWith('<li') || trimmedBlock.length === 0) {
                     return block; // Keep existing lists, headers, or empty lines
                 }
                 // Wrap remaining blocks in <p>, converting single newlines to <br>
                 let content = block.replace(/\n/g, '<br>');
                 // Highlight potential warnings/notes
                 if (content.toLowerCase().includes("importante:") || content.toLowerCase().includes("advertencia:") || content.toLowerCase().includes("nota:")) {
                    return `<p class="important-note">${content}</p>`;
                 }
                 return `<p>${content}</p>`;
             }).join(''); // Keep original spacing more or less

            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Sin cambios)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }

        // -- Modified createTitleItem to include icon --
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // Simple icon logic based on keywords (can be expanded)
            let iconClass = 'fa-book-medical'; // Default
            const lowerTitle = title.toLowerCase();
            if (lowerTitle.includes('rcp') || lowerTitle.includes('cpr') || lowerTitle.includes('dea') || lowerTitle.includes('corazón') || lowerTitle.includes('cardio')) iconClass = 'fa-heart-pulse';
            else if (lowerTitle.includes('vía aérea') || lowerTitle.includes('respiración') || lowerTitle.includes('asma') || lowerTitle.includes('pulmón') || lowerTitle.includes('bvm')) iconClass = 'fa-lungs';
            else if (lowerTitle.includes('hemorragia') || lowerTitle.includes('sangrado') || lowerTitle.includes('shock') || lowerTitle.includes('torniquete')) iconClass = 'fa-tint'; // Droplet icon
            else if (lowerTitle.includes('fractura') || lowerTitle.includes('hueso') || lowerTitle.includes('inmovilización') || lowerTitle.includes('férula') || lowerTitle.includes('columna')) iconClass = 'fa-bone';
            else if (lowerTitle.includes('quemadura')) iconClass = 'fa-fire';
            else if (lowerTitle.includes('cabeza') || lowerTitle.includes('neurológico') || lowerTitle.includes('avpu') || lowerTitle.includes('gcs') || lowerTitle.includes('acv')) iconClass = 'fa-brain';
            else if (lowerTitle.includes('evaluación') || lowerTitle.includes('assessment')) iconClass = 'fa-stethoscope';
            else if (lowerTitle.includes('seguridad') || lowerTitle.includes('epp') || lowerTitle.includes('peligro') || lowerTitle.includes('riesgo')) iconClass = 'fa-triangle-exclamation';
            else if (lowerTitle.includes('pediátrico') || lowerTitle.includes('niño') || lowerTitle.includes('lactante') || lowerTitle.includes('bebé')) iconClass = 'fa-child';
            else if (lowerTitle.includes('intoxicación') || lowerTitle.includes('veneno') || lowerTitle.includes('droga')) iconClass = 'fa-capsules';

            div.innerHTML = `<i class="fas ${iconClass}"></i> ${title}`; // Add icon before title
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }

        function displayTitles(titles) { /* ... (No change in logic) ... */
            if (!titleListContainer || !titlesLoading) return;
            const shuffledTitles = shuffleArray([...titles]);
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (shuffledTitles.length === 0) {
                showNoResultsMessage("No hay técnicas iniciales disponibles.");
                return;
            }
            shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
            filterTitles();
         }
        function appendTitles(newTitles) { /* ... (No change in logic, uses createTitleItem) ... */
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const searchTerm = searchInput.value.toLowerCase().trim();
             newTitles.forEach(title => {
                 const item = createTitleItem(title); // Creates item with icon
                 if (searchTerm === '' || title.toLowerCase().includes(searchTerm)) {
                     item.style.display = 'flex';
                 } else {
                     item.style.display = 'none';
                 }
                 titleListContainer.appendChild(item);
             });
             checkIfAnyResultsVisible();
         }
        // --- Search Filter Functionality --- (No changes needed)
        function filterTitles() { /* ... */
             if (!searchInput || !titleListContainer) return;
             const searchTerm = searchInput.value.toLowerCase().trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const title = item.getAttribute('data-title').toLowerCase(); // Search on data-title
                 if (title.includes(searchTerm)) {
                     item.style.display = 'flex';
                     visibleCount++;
                 } else {
                     item.style.display = 'none';
                 }
             });
             updateNoResultsMessage(visibleCount);
         }
        function updateNoResultsMessage(visibleCount) { /* ... */
            if (!titleListContainer) return;
            if (noResultsMessageElement) {
                noResultsMessageElement.remove();
                noResultsMessageElement = null;
            }
            if (visibleCount === 0 && titleListContainer.children.length > 0 && titlesLoading.style.display === 'none') {
                showNoResultsMessage(`No se encontraron resultados para "${searchInput.value}"`);
            }
        }
        function showNoResultsMessage(message) { /* ... */
             if (noResultsMessageElement || !titleListContainer) return;
             noResultsMessageElement = document.createElement('p');
             noResultsMessageElement.id = 'no-results-message';
             noResultsMessageElement.textContent = message;
             titleListContainer.appendChild(noResultsMessageElement);
         }
        function checkIfAnyResultsVisible() { /* ... */
             const visibleItems = titleListContainer.querySelectorAll('.title-item[style*="display: flex"]');
             updateNoResultsMessage(visibleItems.length);
        }

        // *** MODIFIED: handleTitleClick (Image logic same, placeholder icon updated) ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText); // Formats and adds disclaimer if needed

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalContent.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-notes-medical placeholder-icon"></i> <!-- Medical notes icon -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual para ${title.split('(')[0].trim()}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => { console.log("Image loaded."); placeholderDiv.remove(); imgElement.style.display = 'block'; };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-image-slash placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">No se pudo cargar la imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">Error al generar URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = `<p class="warning">No se pudo cargar el contenido detallado. ${error.message}</p>`; // Show error within content area
            }
        }

        async function handleGenerateMoreTitles() { /* ... (No change in logic, just button text) ... */
             if (!generateMoreBtn || !generateMoreContainer) return;
             const spinner = generateMoreBtn.querySelector('i');
             generateMoreBtn.disabled = true;
             if(spinner) spinner.classList.remove('hidden');
             generateMoreBtn.childNodes[generateMoreBtn.childNodes.length - 1].nodeValue = " Cargando...";

             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block';
                 } else {
                     alert("No se pudieron cargar más técnicas en este momento.");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al cargar técnicas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 if(spinner) spinner.classList.add('hidden');
                 generateMoreBtn.childNodes[generateMoreBtn.childNodes.length - 1].nodeValue = " Cargar Más Técnicas";
                 checkIfAnyResultsVisible();
             }
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput) { console.error("Init fail."); document.body.innerHTML = '<p style="color: var(--color-danger); font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: No se pudo inicializar la guía de primeros auxilios.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            searchInput.addEventListener('input', filterTitles);
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>