<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon Ball Universe - Enciclopedia Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Estilo Anime/Din√°micas -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Dragon Ball --- */
        :root {
            --color-primary: #ff7f00; /* Naranja (Gi Goku) */
            --color-secondary: #005bff; /* Azul (Uniforme / Ki) */
            --color-tertiary: #ffcc00; /* Amarillo (Super Saiyan / Dragon Balls) */
            --color-background: #f0f8ff; /* Azul Cielo Muy Claro / Blanco */
            --color-text: #333333; /* Gris Oscuro */
            --color-text-muted: #667788; /* Gris Azulado */
            --color-modal-bg: #ffffff; /* Blanco */
            --color-border: #d1d5db; /* Borde Gris Claro */
            --color-error-bg: #fff1f2; /* Fondo error rosa claro */
            --color-error-text: #be123c; /* Texto error rojo oscuro */
            --color-error-border: #fecdd3; /* Borde error rosa */

            --shadow-sm: 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 8px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 20px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 8px; /* Bordes m√°s redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo, #generate-more-btn, #modal-title { font-family: 'Bangers', cursive; letter-spacing: 1.5px; /* Fuente tem√°tica para t√≠tulos */ }
        .logo { color: var(--color-primary); text-shadow: 1px 1px 0 #fff, 2px 2px 0 var(--color-secondary); }
        h1.page-title { color: var(--color-secondary); font-weight: 400; /* Bangers no tiene weights */ text-shadow: 1px 1px 1px rgba(0,0,0,0.1); }
        h2.section-title { color: var(--color-primary); border-bottom: 3px dashed var(--color-secondary); padding-bottom: 0.6rem; display: inline-block; font-weight: 400; }
        #modal-title { color: var(--color-secondary); font-weight: 400; font-size: 2.4rem !important; } /* M√°s grande */
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato', sans-serif; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(255, 127, 0, 0.3); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.3rem; } /* M√°s columnas */
        .title-item { background-color: var(--color-modal-bg); padding: 1.1rem 0.8rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 700; /* Lato Bold */ color: var(--color-secondary); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Lato', sans-serif; font-size: 0.95rem; position: relative; overflow: hidden; }
        .title-item::before { content: ''; position: absolute; bottom: 0; left: -100%; width: 100%; height: 4px; background-color: var(--color-primary); transition: left 0.3s ease; }
        .title-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-primary); }
        .title-item:hover::before { left: 0; }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-tertiary)); color: white; padding: 0.9rem 1.8rem; border: none; border-radius: 50px; /* Bot√≥n redondo */ font-size: 1.3rem; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); box-shadow: var(--shadow-md); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-tertiary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; text-shadow: none; }
        #generate-more-btn .fa-sync-alt { margin-right: 10px; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 91, 255, 0.8); /* Overlay azul */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 3px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-primary); border: 2px solid white; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }
        .modal-close-btn:hover { background-color: var(--color-secondary); transform: rotate(90deg) scale(1.1); box-shadow: 0 0 10px var(--color-secondary); }

        /* √Årea de Contenido Principal */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid #f0f8ff; }

        #modal-content { padding: 0 5px; font-family: 'Lato', sans-serif; font-size: 1.05rem; } /* Texto normal */
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 700; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Bangers', cursive; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 1px; }
        #modal-content h1 { font-size: 1.8em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.6em; }
        #modal-content h3 { font-size: 1.4em; color: #ff9f40; } /* Naranja m√°s claro */
        #modal-content h4 { font-size: 1.2em; color: var(--color-text-muted); border-bottom: none; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 3px solid var(--color-tertiary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 20px var(--color-tertiary); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); border: 2px dashed var(--color-border); border-radius: var(--border-radius); background-color: #fafafa; }
        #modal-content .image-placeholder .spinner { border: 5px solid rgba(209, 213, 219, 0.5); width: 45px; height: 45px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 1rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 2px dashed var(--color-border); padding-top: 1rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; /* Ajustar altura */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 1rem; border-radius: 15px; /* M√°s redondeado */ max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; border-bottom-right-radius: 3px; }
        .ai-message { background-color: var(--color-secondary); color: white; margin-right: auto; text-align: left; border-bottom-left-radius: 3px; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: 50px; font-family: 'Lato', sans-serif; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(255, 127, 0, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-secondary); color: white; border: none; border-radius: 50%; /* Redondo */ cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1rem; flex-shrink: 0; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-primary); transform: scale(1.1); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; transform: none; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; color: var(--color-primary); }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 70px; height: 70px; border: 8px solid rgba(0, 91, 255, 0.2); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 2rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-secondary); font-size: 1.8rem; font-family: 'Bangers'; text-shadow: 1px 1px 1px rgba(0,0,0,0.1); letter-spacing: 1px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 700; font-family: 'Lato', sans-serif; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 4px solid var(--color-tertiary); box-shadow: 0 0 30px var(--color-tertiary); border-radius: 5px; }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-primary); border: 2px solid white; border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); opacity: 0.8; }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); transform: scale(1.1); opacity: 1; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-4xl sm:text-5xl">
                     <i class="fas fa-dragon mr-2" style="color: var(--color-tertiary); text-shadow: 1px 1px 1px #a50"></i> <!-- Icono Drag√≥n -->
                     Dragon Ball Universe
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-bold tracking-wide">¬ª Kakarot! Encuentra tu personaje ¬´</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Enciclopedia Z Interactiva</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-normal">¬°Explora el vasto universo de Dragon Ball! Descubre historias, poderes y transformaciones de tus h√©roes y villanos favoritos.</p>
             <img src="https://img.icons8.com/color/96/000000/dragon-ball.png" alt="Dragon Ball Icon" class="mx-auto mb-4"/> <!-- Icono Dragon Ball -->
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar personaje, t√©cnica o concepto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-users text-orange-500 mr-2"></i> <!-- Icono Grupo -->
                 √çndice de Guerreros y Conceptos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Buscando en los archivos de Capsule Corp...</p>
                  <!-- Los .title-item se a√±adir√°n aqu√≠ -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">¬°No se encontr√≥! Quiz√°s est√© en otro universo...</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt animate-spin hidden"></i>
                     ¬°Invocar M√°s Ideas!
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>¬°Cargando datos!</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se a√±adir√°n aqu√≠ v√≠a JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                          <!-- Mensaje inicial o vac√≠o -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> El Scouter est√° procesando...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Preg√∫ntale algo a Bulma sobre esto...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-blue-100 text-gray-700 py-6 mt-12 border-t border-blue-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Informaci√≥n recopilada por la IA de Capsule Corp. con fines de entretenimiento y referencia.</p>
              <p class="mt-1">Los niveles de poder pueden variar seg√∫n la saga y la fuente. ¬°Divi√©rtete explorando!</p>
              <p class="mt-2">¬© Capsule Corporation Archives</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Personajes Principales (Z-Fighters y Familia)
            "Goku", "Vegeta", "Gohan", "Piccolo", "Krillin", "Trunks (Futuro)", "Trunks (Ni√±o)", "Goten", "Bulma", "Chi-Chi", "Master Roshi (Kame Sennin)", "Tien Shinhan", "Chiaotzu", "Yamcha", "Yajirobe", "Android 18 (Lazuli)", "Android 17 (Lapis)", "Videl", "Pan", "Uub", "Gotenks (Fusi√≥n)", "Vegito (Fusi√≥n Potara)", "Gogeta (Fusi√≥n Metamoru)",
            // Villanos Principales y Secundarios (DB, Z, Super, GT, Pel√≠culas)
            "Raditz", "Nappa", "Saibamen", "King Vegeta", "Frieza (Formas)", "Cooler", "King Cold", "Zarbon", "Dodoria", "Ginyu Force (Equipo Completo)", "Capit√°n Ginyu", "Recoome", "Burter", "Jeice", "Guldo", "Dr. Gero (Android 20)", "Android 19", "Android 16", "Cell (Formas)", "Cell Jr.", "Majin Buu (Gordo)", "Majin Buu (Maldad Pura / Flaco)", "Super Buu (Formas)", "Kid Buu", "Babidi", "Dabura (Rey Demonio)", "Pui Pui", "Yakon", "Pilaf", "Shu", "Mai", "Emperador Pilaf (M√°quina)", "Mercenary Tao (Tao Pai Pai)", "General Blue", "Comandante Red", "General White", "Ninja Murasaki", "Androide 8 (Eighter)", "Red Ribbon Army (Ej√©rcito)", "King Piccolo (Piccolo Daima≈ç)", "Tambourine", "Cymbal", "Drum", "Piano", "Garlic Jr.", "Spice Boys (Mustard, Spice, Vinegar, Salt)", "Turles", "Crusher Corps", "Lord Slug", "Angila", "Medamatcha", "Wings (Dorodabo)", "Zeeun", "Android 13", "Android 14", "Android 15", "Super Android 13", "Broly (Z - Legendario Super Saiyan)", "Paragus (Z)", "Bojack", "Bojack Unbound ( secuaces: Zangya, Kogu, Bido, Bujin)", "Janemba (Formas)", "Hirudegarn", "Hoi", "Baby (GT)", "Super Android 17 (GT)", "Hell Fighter 17 (GT)", "Shadow Dragons (Syn/Omega, Haze, Eis, Nuova, Rage, Oceanus, Naturon)", "Syn Shenron", "Omega Shenron", "Beerus (Dios de la Destrucci√≥n U7)", "Zamasu", "Goku Black", "Zamasu Fusionado (Corrupto)", "Frost (Universo 6)", "Hit (Universo 6)", "Cabba (Universo 6)", "Caulifla (Universo 6)", "Kale (Universo 6)", "Kefla (Fusi√≥n U6)", "Magetta (Universo 6)", "Botamo (Universo 6)", "Auta Magetta (Universo 6)", "Dr. Rota (Universo 6)", "Pride Troopers (Universo 11)", "Jiren (Universo 11)", "Toppo (Universo 11)", "Dyspo (Universo 11)", "Kahseral (Universo 11)", "Cocotte (Universo 11)", "Kettol (Universo 11)", "Tupper (Universo 11)", "Zoiray (Universo 11)", "Vewon (Universo 11)", "Kunshi (Universo 11)", "Bergamo (Tr√≠o del Peligro U9)", "Lavender (Tr√≠o del Peligro U9)", "Basil (Tr√≠o del Peligro U9)", "Universo 9 (General)", "Universo 10 (Gowasu, Zamasu)", "Moro (Prisionero Gal√°ctico)", "Patrulla Gal√°ctica (Jaco, Merus)", "Granolah", "Heeters (Elec, Gas, Oil, Maki)", "Dr. Hedo", "Gamma 1", "Gamma 2", "Cell Max",
             // Dioses, √Ångeles y Seres Celestiales
            "Whis (√Ångel U7)", "Grand Zeno (Rey del Todo)", "Guardias de Zeno", "Grand Priest (Daishinkan)", "Supreme Kai (Shin - Kaioshin del Este)", "Kibito", "Kibito Kai (Fusi√≥n)", "Old Kai (Rou Dai Kaioshin)", "Kami (Dios de la Tierra)", "Dende (Dios de la Tierra)", "Mr. Popo", "Korin (Kar√≠n)", "Rey Kai (Kaio del Norte)", "Bubbles", "Gregory", "South Kai", "West Kai", "East Kai", "Grand Kai", "Chronoa (Suprema Kai del Tiempo)", "Champa (Dios de la Destrucci√≥n U6)", "Vados (√Ångel U6)", "Otros Dioses de la Destrucci√≥n (Belmod, Heles, etc.)", "Otros √Ångeles (Marcarita, Cus, etc.)", "Zalama (Creador Super Dragon Balls)", "Shenron (Drag√≥n de la Tierra)", "Porunga (Drag√≥n de Namek)", "Super Shenron (Drag√≥n Super Dragon Balls)", "Black Smoke Shenron (GT)",
            // Otros Personajes Relevantes
            "Bardock", "Gine", "Ox-King (Gy≈´ma≈ç)", "Launch (Lunch)", "Puar", "Oolong", "Fortuneteller Baba (Uranai Baba)", "Annin (Guardiana Horno M√°gico)", "Maestro Mutaito", "Abuelo Gohan (Son Gohan)", "Mr. Satan (Hercule)", "Bee (Perro Buu)", "Marron (Hija Krillin/18)", "Bulla (Bra - Hija Vegeta/Bulma)", "Monaka", "Jaco (Patrullero Gal√°ctico)", "Tights (Hermana Bulma)", "Rey de la Tierra (King Furry)", "Namekianos (General)", "Guru (Gran Patriarca Namek)", "Nail", "Moori", "Saiyans (Raza)", "Planeta Vegeta", "Planeta Namek", "Planeta Yardrat", "Planeta Sadala (Universo 6)", "Otros Universos (Lista)",
            // Transformaciones y Estados
            "Super Saiyan (SSJ)", "Super Saiyan 2 (SSJ2)", "Super Saiyan 3 (SSJ3)", "Super Saiyan 4 (SSJ4 - GT)", "Super Saiyan God (SSG)", "Super Saiyan Blue (SSB / SSGSS)", "Super Saiyan Blue Kaio-ken", "Super Saiyan Blue Evolution (Vegeta)", "Ultra Instinto Se√±al (Omen)", "Ultra Instinto Dominado (MUI)", "Ultra Ego (Vegeta)", "Legendary Super Saiyan (Broly Z/Kale)", "Super Saiyan Ros√© (Goku Black)", "Forma Dorada (Frieza/Cooler)", "Forma Final 100% Poder (Frieza)", "Forma Met√°lica (Cooler)", "Forma Perfecta (Cell)", "Super Perfecta (Cell)", "Potencial Desatado (Gohan M√≠stico/Ultimate)", "Modo Bestia (Gohan Beast)", "Orange Piccolo", "Majin (Estado)", "Kaio-ken", "Ozaru (Gran Mono)", "Ozaru Dorado (GT)", "Modo Dios de la Destrucci√≥n (Toppo)", "Modo Berserker (Kale)", "M√°ximo Poder (Master Roshi)", "Purificaci√≥n (Buu)",
            // T√©cnicas y Habilidades
            "Kamehameha", "Final Flash", "Special Beam Cannon (Makankosappo)", "Masenko", "Destructo Disc (Kienzan)", "Spirit Bomb (Genki Dama)", "Instant Transmission (Shunkan Id≈ç)", "Solar Flare (Taiy≈çken)", "Tri-Beam (Kik≈çh≈ç)", "Dodon Ray (Dodonpa)", "Galick Gun", "Big Bang Attack", "Fusion Dance (Metamoru)", "Potara Fusion", "Ki Blast / Energy Wave", "Senzu Bean", "Dragon Radar", "Scouter", "Capsule Corporation Technology", "Flying Nimbus (Kinto'un)", "Power Pole (Nyoi-b≈ç)", "Zenkai Boost", "Mafuba (Evil Containment Wave)", "Healing (Dende/Otros)", "Telekinesis (Chiaotzu/Otros)", "Time Skip (Hit)", "Energy Blade / Ki Sword", "Clonaci√≥n / Multi-Form Technique (Tien)", "Regeneraci√≥n (Piccolo/Cell/Buu)", "Absorci√≥n (Cell/Buu/Moro)", "Gigantificaci√≥n (Namekianos/Slug)", "Candy Beam (Buu)", "Death Beam (Frieza)", "Supernova (Frieza/Cooler)", "Hellzone Grenade (Piccolo)", "Clothes Beam (Piccolo)", "Magic Materialization (Varios)", "Hakai (Energy of Destruction)", "Forced Spirit Fission (Vegeta)",
            // Conceptos y Lugares
            "Ki (Energ√≠a Vital)", "Power Level (Nivel de Poder)", "Dragon Balls (Esferas del Drag√≥n - Tierra)", "Dragon Balls Namekianas", "Super Dragon Balls", "Other World (Otro Mundo)", "Heaven (Para√≠so)", "Hell (Infierno - HFIL)", "Snake Way (Camino de la Serpiente)", "Hyperbolic Time Chamber (Habitaci√≥n del Tiempo)", "Kami's Lookout (Atalaya de Kami)", "Kame House", "Capsule Corporation", "World Martial Arts Tournament (Tenkaichi Bud≈çkai)", "Cell Games", "Tournament of Power (Torneo del Poder)", "Sagas de Dragon Ball (Resumen)", "Sagas de Dragon Ball Z (Resumen)", "Sagas de Dragon Ball Super (Resumen)", "Sagas de Dragon Ball GT (Resumen)", "Pel√≠culas de Dragon Ball (Lista)", "Planetas Importantes (Lista)", "Razas Principales (Lista)", "L√≠neas Temporales", "Fuerzas Especiales Ginyu (Filosof√≠a)", "Filosof√≠a de los Saiyans", "Mitolog√≠a de los Dioses", "Jerarqu√≠a Celestial", "Androides (Tipos: Totalmente Artificial, Ciborg, Bio-Androide)"
            // A√±adir m√°s... ¬°El bot√≥n "Invocar M√°s" ayudar√°!
        ];
        const dragonBallThemes = [
            "personajes Saiyan", "villanos de Dragon Ball Z", "transformaciones Super Saiyan", "personajes de Dragon Ball Super", "dioses de la destrucci√≥n", "√°ngeles del multiverso", "participantes del Torneo del Poder", "personajes de las pel√≠culas de DBZ", "t√©cnicas de Ki famosas", "fusiones (Potara y Metamoru)", "androides del Dr. Gero", "raza de Frieza", "Namekianos notables", "personajes de Dragon Ball GT", "dragones malignos GT", "las Esferas del Drag√≥n", "lugares ic√≥nicos", "sagas principales", "conceptos como Ki y Power Level", "Z Fighters", "Red Ribbon Army", "Patrulla Gal√°ctica", "personajes femeninos fuertes"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres el Kaio Shin del Tiempo, Chronoa, o un archivista experto de Capsule Corp. Tu conocimiento del universo Dragon Ball (DB, Z, Super, GT, pel√≠culas, conceptos) es enciclop√©dico. Describe al personaje, transformaci√≥n, t√©cnica o concepto indicado de forma detallada y apasionada. Incluye: Origen/Historia relevante, apariencia f√≠sica/caracter√≠sticas, habilidades/poderes/t√©cnicas clave, nivel de poder estimado o comparativo (mencionando la saga si es relevante), personalidad, rol en las sagas principales, relaciones importantes y curiosidades. Utiliza un lenguaje que capture la esencia de Dragon Ball. El objetivo es una descripci√≥n rica de aproximadamente 1200-1300 palabras. Basa tu cr√≥nica √∫nicamente en el siguiente guerrero o concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Act√∫a como Bulma o Whis, respondiendo preguntas adicionales sobre el personaje, t√©cnica o concepto espec√≠fico que se est√° mostrando. Usa tu vasto conocimiento y responde de forma √∫til, concisa y con el tono caracter√≠stico del personaje que interpretas (Bulma: inteligente, directa, a veces impaciente; Whis: calmado, educado, algo misterioso, quiz√°s con comentarios sobre comida). C√©ntrate *solo* en el tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Act√∫a como Shenron o Porunga. Concede un deseo generando exactamente 15 nombres de personajes, transformaciones, t√©cnicas, razas o conceptos importantes del universo Dragon Ball (DB, Z, Super, GT, pel√≠culas). Devuelve *solo* la lista de deseos concedidos (los nombres/conceptos), uno por l√≠nea. Sin n√∫meros, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentCharacterTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const persona = isChat ? (Math.random() > 0.5 ? 'Bulma' : 'Whis') : 'Chronoa/Archivista Capsule Corp.'; // Elige persona para el chat
            const systemPromptToUse = isChat && currentCharacterTitle
                ? `Act√∫a como ${persona}, respondiendo preguntas adicionales sobre el personaje, t√©cnica o concepto espec√≠fico llamado '${currentCharacterTitle}'. Usa tu vasto conocimiento y responde de forma √∫til, concisa y con el tono caracter√≠stico de ${persona} (${persona === 'Bulma' ? 'inteligente, directa, a veces impaciente' : 'calmado, educado, algo misterioso, quiz√°s con comentarios sobre comida'}). C√©ntrate *solo* en '${currentCharacterTitle}'.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            // Eliminar seed para chat, puede ser repetitivo
            // if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Persona: ${persona}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) ¬°Nuestros servidores tienen mucho tr√°fico ahora mismo, como en el Torneo del Poder! Intenta en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar")) {
                    throw new Error("Parece que la informaci√≥n se perdi√≥ en otra dimensi√≥n. Intenta de nuevo o con otra consulta.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexi√≥n tard√≥ m√°s que cargar una Genki Dama (>${config.timeoutSeconds}s). Revisa tu conexi√≥n o intenta m√°s tarde.`);
                }
                throw new Error(error.message || "¬°Algo inesperado ocurri√≥! Quiz√°s fue un ataque sorpresa.");
            }
        }

        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentCharacterTitle) throw new Error("Error interno: ¬°No s√© de qui√©n estamos hablando!");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(dragonBallThemes) || "personajes de Dragon Ball";
            const specificPrompt = `Genera 15 personajes, t√©cnicas o conceptos relacionados con ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 2 && line.length < 100); // Ajustar longitud filtro
                     if (titles.length < 5) throw new Error("¬°Las Esferas del Drag√≥n no pudieron encontrar suficientes ideas ahora!");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Goku Kamehameha";
            // Prompt espec√≠fico para estilo Dragon Ball
            const enhancedPrompt = `Dynamic anime style artwork of '${safePromptText}' from Dragon Ball universe. Focus on character design, iconic pose or transformation if applicable, vibrant colors, energy effects. Akira Toriyama style inspiration. No text, labels, watermarks. Clean background or simple action environment.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, letters, labels, title, caption, logo, watermark, signature, photograph, realistic, 3D render, low quality, blurry, multiple characters unless specified, complex background, UI elements";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-‚àí]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('‚àí', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             // Corregir cursiva simple si interfiere con nombres como *Namek*
             // formatted = formatted.replace(/(?<!\w)\*(?!\s)(.*?)(?<!\s)\*(?!\w)/g, '<em>$1</em>'); // Intenta ser m√°s espec√≠fico
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); // Mantener simple por ahora

             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 // Convertir saltos de l√≠nea internos en espacios para p√°rrafos m√°s fluidos
                 let content = block.replace(/\n/g, ' ');
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentCharacterTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ==========
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = `ü§ñ Error: ${message}`; // A√±adir un icono/prefijo
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(error.message);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar puede ser menos √∫til con tantos t√≠tulos, pero mantiene consistencia
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">¬°Parece que Zeno borr√≥ todos los datos!</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Reaplicar filtro
         }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentCharacterTitle = title; // Set context for chat
            modalContent.innerHTML = '';
            chatHistory.innerHTML = ''; // Clear chat
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is visible

                // Add Image Placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.9em; margin-top: 0.5rem;">Buscando imagen en Capsule Corp...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Append placeholder to text content

                // Create and load image
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Imagen de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-times-circle placeholder-icon" style="color:red;"></i><p style="font-size:0.9em;margin-top:0.5rem;">¬°Imagen no encontrada! Quiz√°s Yamcha la rompi√≥.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append image element
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon" style="color:orange;"></i><p style="font-size:0.9em;margin-top:0.5rem;">Error al generar URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "¬°Error desconocido! El radar del drag√≥n fall√≥.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = ''; // Clear partial content
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreSpinner.classList.remove('hidden'); // Show spinner
             generateMoreBtn.childNodes[generateMoreBtn.childNodes.length - 1].textContent = ' Invocando...'; // Change text
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Shenron no pudo conceder m√°s ideas en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`¬°Error al invocar ideas! ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreSpinner.classList.add('hidden'); // Hide spinner
                 generateMoreBtn.childNodes[generateMoreBtn.childNodes.length - 1].textContent = ' ¬°Invocar M√°s Ideas!'; // Restore text
             }
         }

         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Show if no results OR if list is empty initially
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Add checks for all essential elements used
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalContent || !modalTextArea || !chatHistory || !modalLoadingIndicator || !modalStoryContentArea || !modalTitle || !modalError || !chatLoadingIndicator || !fullscreenImage) {
                console.error("Initialization failed: Missing essential UI elements! Check IDs.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¬°Error Catastr√≥fico! La interfaz no carg√≥. Contacta a Bulma.</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden'); // Start hidden
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>