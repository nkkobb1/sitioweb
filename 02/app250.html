<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sabiduría Ancestral - Guía de Neopaganismo Celta y Wicca</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes con toque místico/natural pero legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Neopaganismo Celta/Wicca --- */
        :root {
            --color-primary: #228B22; /* Forest Green */
            --color-secondary: #8A2BE2; /* Blue Violet (Mystic) */
            --color-tertiary: #DAA520; /* Goldenrod (Accent) */
            --color-background: #F5F5DC; /* Beige (Parchment/Natural) */
            --color-text: #4B3A26; /* Dark Brown (Earthy Text) */
            --color-text-muted: #708090; /* Slate Gray */
            --color-modal-bg: #FFFAF0; /* Floral White (Modal Background) */
            --color-border: #BDB76B; /* Dark Khaki (Borders) */
            --color-error-bg: #f7e9e9; /* Soft Pink error bg */
            --color-error-text: #8B0000; /* Dark Red error text */
            --color-error-border: #CD5C5C; /* Indian Red error border */

            --shadow-sm: 0 2px 4px rgba(75, 58, 38, 0.1);
            --shadow-md: 0 5px 10px rgba(75, 58, 38, 0.15);
            --shadow-lg: 0 10px 20px rgba(75, 58, 38, 0.2);
            --border-radius: 5px; /* Slightly softer edges */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; background-image: url("data:image/svg+xml,%3Csvg width='52' height='26' viewBox='0 0 52 26' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23dcd7c7' fill-opacity='0.2'%3E%3Cpath d='M10 10c0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6h2c0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4v2c-3.314 0-6-2.686-6-6 0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6zm25.464-1.95l8.486 8.486-1.414 1.414-8.486-8.486 1.414-1.414z' /%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); /* Subtle background pattern */
        }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; }
        .navbar { background-color: rgba(245, 245, 220, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Search Bar */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Merriweather'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(34, 139, 34, 0.2); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Merriweather'; font-size: 0.95rem; border-left: 3px solid transparent; position: relative; overflow: hidden; }
        .title-item::before { /* Subtle decorative element */ content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(120deg, transparent, rgba(218, 165, 32, 0.1), transparent); transition: left 0.6s ease; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #f8f8f0; border-left-color: var(--color-primary); }
        .title-item:hover::before { left: 100%; }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-tertiary)); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-tertiary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-text-muted); color: #e0e0e0; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(75, 58, 38, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 2px solid var(--color-border); /* Thicker border */
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px; width: 95%;
            max-height: 90vh; min-height: 450px; /* Increased min-height */
            overflow: hidden; position: relative;
            box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column;
             border-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cstyle%3E.k path %7B fill: %23BDB76B; stroke: %234B3A26; stroke-width: 0.5px; %7D%3C/style%3E%3Cg class='k'%3E%3Cpath d='M 0 0 L 25 10 L 0 25 Z' /%3E%3Cpath d='M 100 0 L 75 10 L 100 25 Z' /%3E%3Cpath d='M 0 100 L 25 90 L 0 75 Z' /%3E%3Cpath d='M 100 100 L 75 90 L 100 75 Z' /%3E%3Cpath d='M 50 0 L 60 25 L 40 25 Z' /%3E%3Cpath d='M 50 100 L 60 75 L 40 75 Z' /%3E%3Cpath d='M 0 50 L 25 60 L 25 40 Z' /%3E%3Cpath d='M 100 50 L 75 60 L 75 40 Z' /%3E%3C/g%3E%3C/svg%3E") 15 / 15px / 0px stretch; /* Celtic knot-like border */
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Main Content Area (Text + Image) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem; scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(189, 183, 107, 0.4); }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(189, 183, 107, 0.4); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }
        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 0.5px; }
        #modal-content h1 { font-size: 1.5em; } #modal-content h2 { font-size: 1.35em; } #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); } #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        /* Image Styles */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(112, 128, 144, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px dashed var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(245, 245, 220, 0.6); scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(189, 183, 107, 0.4); }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(189, 183, 107, 0.4); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; box-shadow: var(--shadow-sm); }
        .user-message { background-color: var(--color-tertiary); color: #333; margin-left: auto; text-align: right; font-weight: 400; }
        .ai-message { background-color: var(--color-primary); color: white; margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Merriweather'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #1e7e1e; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator & Minigame */
        #modal-loading { text-align: center; padding: 1rem 0 0 0; /* Less top padding */ position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(245, 245, 220, 0.97); /* Slightly transparent beige */ display: flex; flex-direction: column; align-items: center; justify-content: flex-start; /* Start content at top */ z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { display: none; /* Replaced by game */ }
        #loading-title { font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--color-primary); margin-bottom: 0.5rem; font-weight: 700; }
        #loading-subtitle { font-family: 'Merriweather'; font-size: 1rem; color: var(--color-text-muted); margin-bottom: 1rem; }

        /* Minigame Styles */
        #minigame-container { width: 95%; height: 65%; /* Adjust height as needed */ position: relative; background-color: rgba(255, 250, 240, 0.7); border: 1px dashed var(--color-border); border-radius: var(--border-radius); overflow: hidden; margin-bottom: 1rem; box-shadow: inset 0 0 10px rgba(75, 58, 38, 0.1); }
        .game-element { position: absolute; font-size: 1.5rem; /* Adjust size */ cursor: pointer; transition: transform 0.2s ease, opacity 0.5s ease; user-select: none; opacity: 0; animation: fadeIn 0.5s forwards, float 6s ease-in-out infinite alternate; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        @keyframes float { 0% { transform: translateY(0px) scale(1); } 50% { transform: translateY(-10px) scale(1.05); } 100% { transform: translateY(0px) scale(1); } }
        .game-element:hover { transform: scale(1.2); }
        /* Element Types (Example Icons - Add more variety) */
        .el-herb { color: #2E8B57; } /* SeaGreen */
        .el-crystal { color: #8A2BE2; } /* BlueViolet */
        .el-moonbeam { color: #F0E68C; text-shadow: 0 0 5px #FFFFE0; } /* Khaki / LightYellow glow */
        .el-rune { color: #A0522D; font-family: sans-serif; font-weight: bold; } /* Sienna */
        .el-star { color: #FFD700; } /* Gold */
        /* Score & Level Display */
        #game-stats { display: flex; justify-content: space-around; width: 90%; margin: 0.5rem 0; font-family: 'Cinzel'; font-size: 1.1rem; color: var(--color-primary); }
        #game-score span, #game-level span { font-weight: 700; color: var(--color-text); }
        /* Altar Display */
        #altar-display { width: 90%; margin-top: 0.5rem; text-align: center; }
        #altar-title { font-family: 'Cinzel'; font-size: 1rem; color: var(--color-secondary); margin-bottom: 0.5rem; }
        #altar-items { display: flex; justify-content: center; align-items: flex-end; gap: 15px; height: 40px; /* Adjust height */ }
        .altar-item { font-size: 1.8rem; /* Size of icons */ color: var(--color-text-muted); opacity: 0.3; transition: opacity 0.5s ease, color 0.5s ease; }
        .altar-item.unlocked { opacity: 1; color: var(--color-tertiary); /* Goldenrod when unlocked */ }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Merriweather'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay (Unchanged conceptually) */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(75, 58, 38, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-tertiary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-tertiary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-tertiary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-tertiary); color: var(--color-modal-bg); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-leaf mr-3 text-green-600"></i> <!-- Icono Hoja -->
                     Sabiduría Ancestral
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Neopaganismo Celta y Wicca «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora los Caminos Antiguos</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre la riqueza de las tradiciones neopaganas celtas y wiccanas. Mitos, deidades, prácticas y la Rueda del Año te esperan.</p>
         </section>

         <!-- Search -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar deidad, sabbat, concepto...">
             <i class="fas fa-search fa-feather-alt"></i> <!-- Icono Pluma/Búsqueda -->
         </section>

         <!-- Title List -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-purple-600 mr-2"></i> <!-- Icono Libro Abierto -->
                 Índice de Conocimiento
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Desplegando los pergaminos...</p>
                  <!-- Titles -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún sendero encontrado con esa búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Consultar Más Sabiduría (40)
                  </button>
             </div>
         </section>
     </main>

     <!-- Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <h3 id="loading-title">Canalizando Conocimiento...</h3>
                 <p id="loading-subtitle">Mientras la conexión se establece, ¡ayuda a reunir energías!</p>
                 <!-- Game Stats -->
                 <div id="game-stats">
                     <div id="game-score">Energía: <span>0</span></div>
                     <div id="game-level">Nivel: <span>1</span></div>
                 </div>
                 <!-- Minigame Area -->
                 <div id="minigame-container">
                     <!-- Game elements will appear here -->
                 </div>
                 <!-- Altar Display -->
                 <div id="altar-display">
                     <div id="altar-title">Altar en Construcción</div>
                     <div id="altar-items">
                         <i id="altar-candle" class="fas fa-candle-holder altar-item" title="Vela"></i>
                         <i id="altar-cauldron" class="fas fa-dharmachakra altar-item" title="Caldero"></i> <!-- Using dharmachakra as proxy -->
                         <i id="altar-athame" class="fas fa-magic altar-item" title="Athame"></i> <!-- Using magic wand as proxy -->
                         <i id="altar-crystal" class="far fa-gem altar-item" title="Cristal"></i>
                         <i id="altar-pentacle" class="fas fa-star altar-item" title="Pentáculo"></i>
                         <i id="altar-book" class="fas fa-book altar-item" title="Libro de Sombras"></i>
                     </div>
                 </div>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text -->
                         <!-- Image -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando oráculos...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Profundiza sobre este tema...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-green-900 bg-opacity-80 text-beige py-6 mt-12 border-t border-green-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA con fines educativos y de referencia sobre Neopaganismo Celta y Wicca.</p>
              <p class="mt-1">Este es un resumen general; la práctica y creencias pueden variar.</p>
              <p class="mt-2">© Ciclo Eterno - Guía Interactiva</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Rueda del Año (Sabbats)
            "Samhain: Orígenes y Celebración", "Yule: El Solsticio de Invierno", "Imbolc: El Despertar de la Tierra", "Ostara: El Equinoccio de Primavera", "Beltane: Fuego y Fertilidad", "Litha: El Solsticio de Verano", "Lughnasadh/Lammas: La Primera Cosecha", "Mabon: El Equinoccio de Otoño", "Significado de la Rueda del Año", "Adaptaciones Modernas de los Sabbats", "El Año Celta vs. el Año Wiccano", "Simbolismo de cada Sabbat", "Rituales Típicos de Samhain", "Tradiciones de Yule", "La Diosa Brighid e Imbolc", "Huevos y Liebres en Ostara", "El Palo de Mayo (Maypole) en Beltane", "Hogueras de Litha", "El Sacrificio del Dios del Grano (Lughnasadh)", "Temas de Equilibrio en Mabon",
            // Esbats y la Luna
            "Los Esbats: Celebrando la Luna Llena", "Fases de la Luna y su Significado Mágico", "La Triple Diosa y la Luna (Doncella, Madre, Anciana)", "Magia Lunar: Trabajos según la Fase", "Deidades Lunares Celtas (Arianrhod, Cerridwen)", "Nombres Tradicionales de las Lunas Llenas", "El Ciclo Lunar y el Ciclo Femenino", "Rituales de Luna Nueva", "Rituales de Luna Creciente", "Rituales de Luna Menguante", "La Luna Oscura: Tiempo de introspección", "El Poder de la Luna Llena",
            // Deidades Principales (Panteón Celta - Irlanda)
            "El Dagda: El Buen Dios", "La Morrigan: Diosa de la Guerra y la Soberanía", "Lugh: El de Múltiples Talentos", "Brighid: Diosa de la Poesía, la Forja y la Sanación", "Danu: La Diosa Madre Ancestral", "Manannán mac Lir: Señor del Mar", "Aengus Óg: Dios del Amor y la Juventud", "Nuada: El del Brazo de Plata", "Goibniu: El Herrero Divino", "Dian Cecht: El Sanador Divino", "Los Tuatha Dé Danann: El Pueblo de la Diosa Danu", "Otros Dioses del Panteón Irlandés", "Mitología del Ciclo de Ulster", "Mitología del Ciclo Feniano",
             // Deidades Principales (Panteón Celta - Gales)
            "Arianrhod: Diosa de la Estrella Plateada", "Cerridwen: Guardiana del Caldero de la Inspiración", "Rhiannon: Diosa de los Caballos y la Soberanía", "Blodeuwedd: La Mujer hecha de Flores", "Gwydion: El Mago", "Lleu Llaw Gyffes: El de la Mano Hábil", "Math fab Mathonwy: Rey y Mago", "Pwyll: Príncipe de Dyfed", "Bran el Bendito: Gigante y Rey", "El Mabinogion: Fuente de la Mitología Galesa", "Comparación entre Panteones Irlandés y Galés",
             // Deidades Generales / Conceptos Divinos
            "El Dios Cornudo (Cernunnos, Herne)", "La Triple Diosa: Doncella, Madre, Anciana", "Animismo: El Espíritu en Todas las Cosas", "Politeísmo vs. Duoteísmo en Wicca", "Arquetipos Divinos en el Neopaganismo", "Invocación y Evocación de Deidades", "Relación Personal con lo Divino", "Panteísmo: Dios es Todo",
             // Conceptos Fundamentales (Wicca y Neopaganismo Celta)
            "La Rede Wicca: 'An it harm none, do what ye will'", "La Ley del Tres (Threefold Law)", "Magia: Definición y Ética", "Los Cinco Elementos: Tierra, Aire, Fuego, Agua, Espíritu (Akasha)", "El Círculo Mágico: Creación y Propósito", "El Cono de Poder", "Correspondencias Mágicas (Colores, Hierbas, Cristales)", "Adivinación: Tarot, Runas, Ogham, Escrying", "Meditación y Visualización", "El Libro de las Sombras (Book of Shadows)", "Tradiciones Wiccanas (Gardneriana, Alejandrina, Diánica, Ecléctica)", "Neodruidismo: Una Vía Hermana", "Reconstruccionismo Celta vs. Wicca", "Sincretismo en el Neopaganismo Moderno", "El Concepto de 'Brujería'", "Historia de la Wicca Moderna (Gerald Gardner)", "Influencia de la Golden Dawn y Aleister Crowley", "Doreen Valiente: Madre de la Wicca Moderna", "Raymond Buckland y la expansión de la Wicca", "El Movimiento Pagano Contemporáneo",
            // Herramientas Rituales
            "El Athame: La Daga Ritual", "La Varita Mágica", "El Pentáculo (Disco del Altar)", "El Cáliz", "El Caldero", "El Incensario (Sahumerio)", "La Escoba (Besom)", "Velas y su Simbolismo", "Cristales y Piedras: Usos Mágicos", "Hierbas Mágicas Comunes", "Aceites Esenciales en Rituales", "Túnicas Rituales", "Consagración de Herramientas", "El Altar: Preparación y Significado",
            // Prácticas y Rituales
            "Estructura Básica de un Ritual Wiccano", "Limpieza y Consagración del Espacio", "Trazado del Círculo Mágico", "Llamada a los Cuartos (Guardianes / Elementales)", "Invocación de Deidades", "Trabajo Mágico Principal (Hechizo, Meditación)", "Pasteles y Cerveza (Cakes and Ale)", "Agradecimientos y Despedidas", "Apertura del Círculo", "Puesta a Tierra (Grounding)", "Centrado (Centering)", "Hechizos: Tipos y Ética", "Magia de Nudos", "Magia con Velas", "Magia Simpática", "Protección Mágica", "Adivinación con Tarot", "Interpretación de Runas Futhark", "El Alfabeto Ogham", "Escrying (Videncia en superficies reflectantes)", "Trabajo con Sueños", "Viaje Astral y Proyección", "Sanación Energética", "Conexión con Espíritus de la Naturaleza (Elementales, Hadas)",
            // Simbolismo Celta y Wiccano
            "El Pentáculo y la Estrella de Cinco Puntas", "La Triquetra (Nudo de la Trinidad)", "El Triskelion (Triple Espiral)", "El Nudo Celta Infinito", "El Árbol de la Vida (Crann Bethadh)", "Animales Sagrados Celtas (Ciervo, Salmón, Cuervo, Lobo)", "Simbolismo de los Colores", "El Laberinto como Símbolo Espiritual", "La Espiral", "El Caldero como Símbolo del Útero y la Transformación", "Simbolismo del Roble, Tejo, Serbal", "Ogham: El Alfabeto Arbóreo", "Los Cuatro Tesoros de los Tuatha Dé Danann",
            // Temas Contemporáneos y Sociales
            "Ecologismo y Conciencia de la Tierra en el Paganismo", "Activismo Pagano", "Comunidad y Covens", "Practicantes Solitarios", "Festivales Paganos Modernos", "Interreligiosidad y Diálogo", "Desafíos y Prejuicios contra el Paganismo", "Representación en los Medios", "Ética Sexual en el Paganismo", "Paganismo Urbano", "Tecnopaganismo", "El Futuro del Neopaganismo",
            // Mitología y Folklore Específico
            "El Mito de la Creación Celta (Variaciones)", "Historias del Otro Mundo (Tír na nÓg, Annwn)", "El Grial y su Conexión Celta", "El Rey Arturo: Raíces Paganas", "Merlín: Druida y Mago", "Las Banshees", "El Pueblo de las Hadas (Sidhe)", "Leprechauns y Clurichauns", "La Cacería Salvaje (Wild Hunt)", "Mitos sobre Cambiaformas (Shapeshifting)", "Lugares Sagrados Celtas (Tara, Stonehenge, Newgrange)", "El Poder de la Palabra Hablada (Geasa, Encantamientos)",
            // Añadir más conceptos específicos, figuras menores, variaciones regionales, etc.
        ];
        const neopaganThemes = [
            "Sabbats Wiccanos", "Rueda del Año", "Esbats", "Magia Lunar", "Triple Diosa", "Dios Cornudo", "Panteón Celta Irlandés", "Panteón Celta Galés", "Tuatha Dé Danann", "Mabinogion", "Rede Wicca", "Ley del Tres", "Elementos Mágicos", "Círculo Mágico", "Herramientas Rituales Wicca", "Athame", "Caldero", "Pentáculo", "Libro de las Sombras", "Tradiciones Wiccanas", "Neodruidismo", "Adivinación Pagana", "Tarot", "Runas", "Ogham", "Simbolismo Celta", "Triquetra", "Triskelion", "Árbol de la Vida", "Conexión con la Naturaleza", "Ética Mágica", "Hechizos Wiccanos", "Historia de la Wicca", "Gerald Gardner", "Doreen Valiente", "Lugares Sagrados Celtas", "Mitología Celta", "Folklore de Hadas"
        ];
        const textApiConfig = {
            model: "mistral", // Podrías probar "mistral-large" si está disponible y necesitas más profundidad, pero puede ser más lento.
            systemPrompt: "Eres un erudito y practicante respetuoso con profundos conocimientos sobre Neopaganismo Celta y Wicca. Explica el concepto, deidad, práctica o tema indicado de forma clara, informativa y neutral. Diferencia entre reconstruccionismo histórico, Wicca moderna y creencias populares cuando sea apropiado. Cubre orígenes (históricos/míticos), simbolismo, prácticas asociadas, relevancia moderna y variaciones comunes. Usa un lenguaje respetuoso y académico. Evita proselitismos o juicios de valor. El objetivo es una exposición detallada y bien estructurada de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tema:",
            timeoutSeconds: 240 // Aumentado ligeramente por la complejidad potencial y los 4 min mencionados
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Mantener uno rápido para chat
             systemPrompt: "Actúa como un asistente de biblioteca especializado únicamente en el tema específico de Neopaganismo Celta/Wicca que se está discutiendo (ej: Samhain, La Morrigan, El Athame). Responde preguntas de seguimiento sobre detalles, simbolismo, o prácticas relacionadas *directamente* con ese tema. Sé conciso, respetuoso y factual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una guía sobre Neopaganismo Celta y Wicca. Genera exactamente 40 nombres evocadores de deidades, sabbats, esbats, herramientas, conceptos mágicos, éticos o mitológicos relevantes. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo para generar 40
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que la versión anterior: searchInput, titleListContainer, etc.)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Scrollable text area
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameContainer = document.getElementById('minigame-container');
        const gameScoreDisplay = document.getElementById('game-score').querySelector('span');
        const gameLevelDisplay = document.getElementById('game-level').querySelector('span');
        const altarItems = document.getElementById('altar-items').querySelectorAll('.altar-item');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Chat context
        // Minigame State
        let gameScore = 0;
        let gameLevel = 1;
        let gameInterval = null;
        let elementSpawnRate = 1500; // ms between spawns (initial)
        const levelThresholds = [0, 100, 250, 500, 800, 1200]; // Score needed for level 1, 2, 3...
        const altarUnlockLevels = [1, 2, 3, 4, 5, 6]; // Level at which each altar item unlocks
        const elementTypes = [ // Icon class, points, type identifier
            { class: 'fa-leaf el-herb', points: 5, type: 'herb' },
            { class: 'fa-gem el-crystal', points: 10, type: 'crystal' },
            { class: 'fa-moon el-moonbeam', points: 7, type: 'moonbeam' },
            // Use text for runes initially for simplicity, or find rune icons
            { class: 'fa-bold el-rune', points: 8, type: 'rune', text: 'ᚠ' }, // Example rune (Fehu)
            { class: 'fa-star el-star', points: 6, type: 'star' },
             { class: 'fa-feather-alt el-herb', points: 5, type: 'herb' }, // More variety
             { class: 'fa-tint el-crystal', points: 10, type: 'crystal' }, // Water drop as crystal alt
        ];

        // ========== API FUNCTIONS ==========
        // fetchTextFromApi, fetchExplanationText, fetchChatResponse (adapted system prompts)
        // fetchGeneratedTitles (requests 40), createPollinationsImageUrl (adapted prompt)
        // ... (Code is conceptually the same as previous version, just prompts/config updated)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Eres un asistente de biblioteca especializado únicamente en el tema de Neopaganismo Celta/Wicca llamado '${currentTopicTitle}'. Responde preguntas de seguimiento sobre sus detalles, simbolismo o prácticas relacionadas directamente. Sé conciso, respetuoso y factual.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             // Seed for main description, not chat
             if (config.seed && !isChat && config.model !== "mistral-tiny") params.append('seed', config.seed); // Seed might not work well/be needed for tiny/chat

             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}, Seed: ${params.get('seed')}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores parecen tener mucho tráfico o la consulta es compleja. Por favor, intenta de nuevo en unos momentos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o el tema.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con la sabiduría ancestral tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Una bruma inesperada impidió la conexión con la IA.");
             }
        }
        async function fetchExplanationText(conceptTitle) {
            // Add a random seed for potentially varied results on same topic if desired
            const configForThis = {...textApiConfig, seed: Math.floor(Math.random() * 1000000)};
            return fetchTextFromApi(conceptTitle, configForThis, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentTopicTitle) throw new Error("Error interno: El hilo de la conversación se perdió. No sé sobre qué tema hablar.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() { // Fetches 40
            const randomTheme = getRandomElement(neopaganThemes) || "Neopaganismo Celta general";
            const specificPrompt = `Genera 40 ítems (deidades, sabbats, conceptos, herramientas, etc.) sobre ${randomTheme} o Wicca/Neopaganismo Celta`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 20) throw new Error("La IA no generó suficientes ideas nuevas."); // Expecting more than 20 at least
                     return titles.slice(0, 40); // Return up to 40
                 });
        }
         function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Celtic Neopagan symbol";
             // Prompt focused on atmosphere, nature, symbolism
             const enhancedPrompt = `Mystical artwork inspired by '${safePromptText}'. Celtic Neopaganism, Wicca themes. Focus on atmosphere, nature (forests, stones, moon), symbolism (spirals, knots, elements), or ritual items abstractly. Earthy or ethereal color palette. Avoid text, labels, diagrams, cartoon style, overly literal interpretations.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, photograph, realistic human figure unless specified, simple background, cartoon, anime";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }


        // ========== Text Formatting ========== (Unchanged)
        function formatExplanationText(rawText) { /* ... */ if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted; }

        // ========== MODAL FUNCTIONS ========== (Include game stop)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            resetModalState(); // This will also stop the game
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex'; // Show loading initially
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
             stopGame(); // Ensure game stops and resets
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Unchanged)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (Unchanged conceptually)
        function addChatMessage(message, sender) { const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error Oráculo: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== MINIGAME FUNCTIONS ==========
        function startGame() {
            console.log("Starting minigame...");
            gameScore = 0;
            gameLevel = 1;
            elementSpawnRate = 1500; // Reset speed
            updateGameDisplay();
            resetAltar();
            // Clear previous interval if any
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, elementSpawnRate);
            // Initial burst of elements
            for(let i = 0; i < 3; i++) spawnGameElement();
        }

        function stopGame() {
            console.log("Stopping minigame...");
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = null;
            // Remove any leftover elements
            const existingElements = minigameContainer.querySelectorAll('.game-element');
            existingElements.forEach(el => el.remove());
        }

        function gameLoop() {
            spawnGameElement();
            // Potentially increase difficulty slightly over time even without level up?
        }

        function spawnGameElement() {
            if (!minigameContainer) return;
            const type = getRandomElement(elementTypes);
            const element = document.createElement('i');
            // Font Awesome classes + specific type class + base class
            element.className = `fas ${type.class} game-element`;
            element.dataset.points = type.points;

            // If it's a text-based element (like runes)
            if (type.text) {
                 element.textContent = type.text;
                 // Reset font awesome classes if using text
                 element.className = `game-element ${type.class}`; // Keep color class
            }


            // Random position within the container
            const containerWidth = minigameContainer.offsetWidth;
            const containerHeight = minigameContainer.offsetHeight;
            const x = Math.random() * (containerWidth - 30); // Minus element approx size
            const y = Math.random() * (containerHeight - 30);
            element.style.left = `${x}px`;
            element.style.top = `${y}px`;

            element.addEventListener('click', handleElementClick);
            minigameContainer.appendChild(element);

            // Auto-remove after a while if not clicked
            setTimeout(() => {
                if (element && element.parentElement) {
                    element.style.opacity = '0';
                    element.style.transform = 'scale(0.5)';
                    setTimeout(() => element.remove(), 500); // Remove after fade out
                }
            }, 5000 + Math.random() * 2000); // Lifespan 5-7 seconds
        }

        function handleElementClick(event) {
            const element = event.target;
            const points = parseInt(element.dataset.points || 0);
            gameScore += points;

            // Visual feedback for click
            element.style.transition = 'transform 0.1s ease, opacity 0.1s ease';
            element.style.transform = 'scale(1.5)';
            element.style.opacity = '0';

            setTimeout(() => element.remove(), 100); // Remove quickly after animation

            updateGameDisplay();
            checkLevelUp();
        }

        function updateGameDisplay() {
            if (gameScoreDisplay) gameScoreDisplay.textContent = gameScore;
            if (gameLevelDisplay) gameLevelDisplay.textContent = gameLevel;
        }

        function checkLevelUp() {
            const nextLevel = gameLevel + 1;
            if (nextLevel <= levelThresholds.length && gameScore >= levelThresholds[nextLevel - 1]) {
                gameLevel = nextLevel;
                console.log("Level Up!", gameLevel);
                // Increase difficulty: reduce spawn rate
                elementSpawnRate = Math.max(500, elementSpawnRate * 0.85); // Decrease by 15%, min 500ms
                clearInterval(gameInterval); // Clear old interval
                gameInterval = setInterval(gameLoop, elementSpawnRate); // Start new one with faster rate
                console.log("New spawn rate:", elementSpawnRate);
                updateGameDisplay();
                unlockAltarItem();
            }
        }

        function resetAltar() {
            altarItems.forEach(item => item.classList.remove('unlocked'));
            // Unlock the first item immediately at level 1
            if(altarItems.length > 0 && altarUnlockLevels[0] === 1) {
                altarItems[0].classList.add('unlocked');
            }
        }

        function unlockAltarItem() {
             altarItems.forEach((item, index) => {
                 if (gameLevel >= altarUnlockLevels[index]) {
                     item.classList.add('unlocked');
                 }
             });
         }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        // shuffleArray (if needed, currently not)
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { if (!titleListContainer || !titlesLoading) return; const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none'; if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» La biblioteca está vacía por ahora «</p>'; return; } sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title)); newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } }); filterTitles(searchInput.value); }

        // *** MODIFIED: handleTitleClick to integrate game start/stop ***
        async function handleTitleClick(title) {
            resetModalState(); // Resets everything, stops previous game if any
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title;
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; // Show loading screen

            startGame(); // *** START THE MINIGAME ***

            try {
                // API Call happens here, while the game is running
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // --- Loading Finished Successfully ---
                stopGame(); // *** STOP THE MINIGAME ***
                modalLoadingIndicator.style.display = 'none'; // Hide loading screen

                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is visible

                // Add image placeholder and load image (same logic as before)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando visión...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visión fallida.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de visión.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                // --- Loading Finished with Error ---
                stopGame(); // *** STOP THE MINIGAME ***
                modalLoadingIndicator.style.display = 'none'; // Hide loading screen

                modalErrorMessage.textContent = error.message || "Un error desconocido interrumpió la conexión.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles requests 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando pergaminos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudo encontrar más sabiduría en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar sabiduría: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Consultar Más Sabiduría (40)';
             }
         }

         // Search Filter Function (with normalization)
         function filterTitles(searchTerm) { const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); const titleItems = titleListContainer.querySelectorAll('.title-item'); let visibleCount = 0; titleItems.forEach(item => { const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const isVisible = titleText.includes(term); item.classList.toggle('hidden', !isVisible); if (isVisible) visibleCount++; }); noResultsMsg.classList.toggle('hidden', visibleCount > 0); }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check for all essential elements, including game elements
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameContainer || !gameScoreDisplay || !gameLevelDisplay) {
                console.error("Initialization failed: Missing essential elements (incl. game components).");
                document.body.innerHTML = '<p style="color: darkred; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: serif;">++ Fallo Crítico del Sistema: Faltan Componentes Esenciales de la Interfaz ++</p>';
                return;
             }
            // Listeners (Modal, Generate More, Search, Chat, Fullscreen)
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>