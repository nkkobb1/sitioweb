<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía de Supervivencia - Nivel Principiante</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Legibles y Amigables -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Supervivencia Principiante --- */
        :root {
            --color-primary: #2E7D32; /* Verde Bosque Oscuro */
            --color-secondary: #A1887F; /* Marrón Claro/Pardo */
            --color-tertiary: #81D4FA; /* Azul Cielo Claro (Agua/Cielo) */
            --color-background: #F5F5F5; /* Gris Muy Claro / Casi Blanco */
            --color-text: #4E342E; /* Marrón Oscuro (Texto Principal) */
            --color-text-muted: #757575; /* Gris Medio */
            --color-modal-bg: #FFFFFF; /* Blanco */
            --color-border: #D7CCC8; /* Borde Marrón Muy Claro */
            --color-error-bg: #FFEBEE; /* Fondo error Rosa Claro */
            --color-error-text: #C62828; /* Texto error Rojo Oscuro */
            --color-error-border: #EF9A9A; /* Borde error Rosa */

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 6px; /* Bordes redondeados amigables */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto Slab', serif; font-weight: 700; color: var(--color-primary); }
        .logo { text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-secondary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.2); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; line-height: 1.4; }
        .title-item i { margin-right: 0.7rem; color: var(--color-secondary); min-width: 16px; text-align: center; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #E8F5E9; /* Verde muy claro hover */ }
        .title-item:hover i { color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto Slab', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { background-color: #1B5E20; /* Verde más oscuro hover */ box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: var(--color-text-muted); color: #e0e0e0; cursor: not-allowed; opacity: 0.8; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(78, 52, 46, 0.85); /* Overlay Marrón translúcido */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); box-shadow: 0 0 8px rgba(46, 125, 50, 0.5); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 700; } /* Énfasis diferente */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto Slab', serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-text); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; }
        #modal-content ul, #modal-content ol { margin-left: 1.5em; margin-bottom: 1em; }
        #modal-content li { margin-bottom: 0.5em; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(161, 136, 127, 0.3); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #FAFAFA; /* Fondo chat muy claro */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95em; }
        .user-message { background-color: var(--color-tertiary); color: #1A237E; /* Azul oscuro texto usuario */ margin-left: auto; text-align: left; /* Mejor leer izq */ box-shadow: var(--shadow-sm); }
        .ai-message { background-color: #E8F5E9; /* Verde claro AI */ color: var(--color-text); margin-right: auto; text-align: left; border: 1px solid #C8E6C9; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.15); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: #fff; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #1B5E20; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid rgba(161, 136, 127, 0.3); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-primary); font-size: 1.3rem; font-family: 'Roboto Slab'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(78, 52, 46, 0.92); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-modal-bg); box-shadow: var(--shadow-lg); border-radius: var(--border-radius); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: #fff; transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-leaf mr-3"></i> <!-- Icono hoja -->
                     Guía de Supervivencia
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Nivel Principiante «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Primeros Pasos en la Naturaleza</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Aprende los conceptos básicos para estar más seguro y preparado al aire libre. Explora los tips esenciales para principiantes.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar tip o concepto...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-brown-600 mr-2"></i> <!-- Icono libro abierto -->
                 Conceptos Esenciales
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando conocimientos básicos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No encontramos tips sobre eso. ¡Intenta buscar otra cosa!</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Tips
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Preparando la lección...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <h3 class="text-sm font-semibold text-gray-600 mb-2 text-center font-sans tracking-wide">¿Tienes dudas sobre este tip? ¡Pregúntale al instructor!</h3>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando al instructor...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Escribe tu pregunta aquí...">
                         <button id="chat-send-btn" aria-label="Enviar Pregunta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-600 py-6 mt-12 border-t border-gray-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Esta guía ofrece información básica de supervivencia con fines educativos. Generada por IA.</p>
              <p class="mt-1">La supervivencia real requiere práctica, sentido común y formación adecuada. ¡Sé siempre precavido!</p>
              <p class="mt-2">© 2025 Guía de Supervivencia Principiante</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Mentalidad y Preparación
            "¿Qué es la Mentalidad Positiva de Supervivencia (PMA)?", "La importancia de mantener la calma", "Regla S.T.O.P. (Stop, Think, Observe, Plan)", "Evaluar la situación: Prioridades básicas", "Avisar a alguien de tus planes antes de salir", "Preparar una mochila básica de 1 día", "Conocer tus límites personales", "El miedo en supervivencia: cómo manejarlo", "La importancia de la esperanza", "Ahorrar energía: Muévete con propósito", "¿Por qué es importante mantenerse ocupado?", "Aceptar la realidad de la situación", "Visualización positiva y sus beneficios", "Tomar decisiones bajo presión", "Aprender de los errores (simulados o reales)", "Entender la 'Regla de Tres' en supervivencia", "La psicología del aislamiento", "Mantener la higiene básica", "Cómo practicar habilidades de forma segura", "La importancia de un buen descanso",
            // Refugio
            "¿Por qué necesitas un refugio?", "Prioridad del refugio según el clima", "Seleccionar un buen sitio para el refugio", "Peligros a evitar al elegir sitio (viudas, inundación, etc.)", "Usar características naturales (cuevas, árboles caídos)", "Construir un refugio Lean-To simple", "Concepto básico del refugio Debris Hut (Cama)", "Cómo aislar el suelo del frío y la humedad", "Usar una lona (tarp) para refugio rápido", "Configuración simple de tarp: Techo a dos aguas", "Configuración simple de tarp: Lean-To con tarp", "Nudos útiles para lonas (ver sección nudos)", "Impermeabilizar un refugio natural (conceptos)", "Ventilación en refugios pequeños", "Refugio de nieve básico: Trinchera (si aplica)", "Hacer una cama elevada simple", "Protegerse del viento", "Protegerse de la lluvia/nieve", "Protegerse del sol directo", "Inspeccionar el refugio antes de usarlo (insectos, etc.)",
            // Agua
            "La importancia vital del agua", "¿Cuánta agua necesitas al día?", "Peligros de beber agua no tratada (parásitos, bacterias)", "Signos y síntomas de deshidratación", "Cómo tratar la deshidratación (básico)", "Buscar fuentes de agua: Ríos y arroyos", "Buscar fuentes de agua: Lagos y estanques", "Buscar fuentes de agua: Lluvia", "Recolectar agua de lluvia con una lona", "Buscar fuentes de agua: Rocío", "Recolectar rocío con un paño", "Buscar agua en plantas (¡con precaución!)", "Purificar agua hirviéndola: El método más seguro", "Cuánto tiempo hervir el agua", "Hacer un fuego para hervir agua (ver sección fuego)", "Filtros de agua comerciales (tipos básicos)", "Cómo usar un filtro de agua tipo pajita", "Cómo usar un filtro de agua por gravedad (concepto)", "Pastillas purificadoras de agua (yodo/cloro)", "Desinfección Solar (SODIS): Concepto básico", "Cómo funciona SODIS (botella PET transparente)", "Pre-filtrar agua turbia antes de purificar", "Construir un pre-filtro simple (grava, arena, carbón - conceptual)", "Transportar agua: Botellas y vejigas", "Conservar el agua corporal (no sudar innecesariamente)", "Derretir nieve o hielo para beber (no comer directamente)", "Evitar agua salada o contaminada químicamente", "Identificar agua estancada peligrosa", "Señales de fuentes de agua cercanas (vegetación, animales)",
            // Fuego
            "La importancia del fuego (calor, agua, moral, señal)", "El Triángulo del Fuego: Calor, Combustible, Oxígeno", "¿Qué es la yesca (tinder)?", "Ejemplos de yesca natural seca (corteza, hierba, hojas)", "Ejemplos de yesca artificial (algodón, vaselina)", "Preparar yesca: Hacerla fina y aireada", "¿Qué es la leña menuda (kindling)?", "Ejemplos de leña menuda (ramitas finas y secas)", "Preparar leña menuda: Romperla en tamaños graduados", "¿Qué es el combustible (fuelwood)?", "Ejemplos de combustible (ramas y troncos más gruesos)", "Recolectar madera: Buscar madera muerta y seca", "Cómo saber si la madera está seca", "Proteger la yesca y leña de la humedad", "Métodos de ignición: Cerillas impermeables", "Usar cerillas de forma segura", "Métodos de ignición: Encendedor (mechero)", "Revisar el combustible del encendedor", "Métodos de ignición: Ferrocerio (ferro rod)", "Cómo usar un ferrocerio y rascador", "Crear chispas abundantes con ferrocerio", "Apuntar las chispas a la yesca", "Encender la yesca con chispas", "Transferir la llama de la yesca a la leña menuda", "Añadir leña menuda gradualmente", "Construir la estructura del fuego: Tipos básicos", "Fogata tipo Tepee (cono)", "Ventajas y desventajas del Tepee", "Fogata tipo Log Cabin (cabaña)", "Ventajas y desventajas del Log Cabin", "Fogata tipo Lean-To (para viento)", "Alimentar el fuego gradualmente", "No ahogar el fuego con demasiado combustible", "Seguridad con el fuego: Limpiar el área alrededor", "Seguridad con el fuego: Nunca dejarlo desatendido", "Seguridad con el fuego: Tener agua o tierra cerca", "Seguridad con el fuego: Apagarlo completamente (agua y remover)", "Cómo saber si el fuego está bien apagado", "Hacer fuego en condiciones húmedas (desafíos)", "Buscar madera seca bajo árboles o salientes", "Raspar la capa exterior húmeda de la madera", "Usar un acelerante (con extrema precaución, si se tiene)", "Hacer fuego sin herramientas (métodos avanzados - solo mencionar)",
            // Comida (Énfasis en seguridad y lo básico)
            "Prioridad: Agua es más importante que comida", "Peligros de comer plantas desconocidas", "Regla Universal de Comestibilidad (¡NO USAR para principiantes!)", "Identificar plantas venenosas comunes (si se conocen localmente - hiedra venenosa, etc.)", "¡En caso de duda, NO lo comas!", "Comida de 'emergencia' en tu mochila (barritas, frutos secos)", "Plantas comestibles comunes y SEGURAS (ej. Diente de león - si hay 100% certeza)", "Partes comestibles del diente de león", "Insectos como comida (concepto básico, preparación)", "Pesca básica: Concepto de anzuelo y línea improvisados", "Trampas básicas: Concepto de lazo simple (para demostración)", "Importancia de cocinar carne/pescado", "Forrajeo seguro: Solo lo que identificas al 100%", "Evitar hongos/setas por completo como principiante", "Bayas: Muchas son tóxicas, evitar si no hay certeza absoluta", "Lavar plantas antes de consumir (si es seguro)", "Entender el gasto energético vs. ganancia al buscar comida", "Señales de animales (huellas, excrementos) - Para conciencia, no caza fácil", "Conservación de energía si la comida es escasa",
            // Señalización
            "¿Por qué es importante señalizar?", "Quedarse quieto y señalizar vs. Moverse", "Señalización pasiva: Ropa de colores brillantes", "Señalización pasiva: Dejar notas o señales de dirección", "Señalización activa: Espejo de señales", "Cómo apuntar un espejo de señales (hacia sol y objetivo)", "Práctica con el espejo de señales", "Señalización activa: Silbato", "Señal estándar de socorro con silbato (3 toques)", "Pausas entre series de silbato", "Señalización activa: Hacer señales de humo", "Cómo crear humo blanco (materiales verdes/húmedos sobre brasas)", "Cómo crear humo negro (petróleo, goma - ¡peligroso!)", "Elegir un lugar visible para señales de humo", "Señalización activa: Señales de tierra (SOS)", "Hacer letras grandes y contrastantes en el suelo", "Materiales para señales de tierra (rocas, ramas, ropa)", "Señalización nocturna: Linterna o frontal", "Señal SOS con linterna (3 cortos, 3 largos, 3 cortos)", "Señalización nocturna: Fuego (controlado y visible)", "Hacer 3 fuegos en triángulo (señal de socorro)", "Uso de teléfono móvil si hay cobertura (ahorrar batería)", "Mensajes de texto consumen menos batería", "Balizas de Localización Personal (PLB) / SPOT (si se tiene)",
            // Navegación (Básica)
            "La importancia de saber dónde estás y hacia dónde vas", "Quedarse en un lugar si estás perdido (generalmente)", "Navegación natural: Usar el Sol", "El Sol sale por el Este y se pone por el Oeste (aproximado)", "Mediodía solar y la sombra más corta (Norte/Sur)", "Método del reloj analógico y el Sol (Hemisferio Norte)", "Método del reloj analógico y el Sol (Hemisferio Sur)", "Navegación natural: Usar las estrellas (Polaris/Cruz del Sur - concepto)", "Identificar la Estrella Polar (Norte)", "Identificar la Cruz del Sur (Sur)", "Limitaciones de la navegación natural (nubes, terreno)", "Navegación con mapa y brújula: Conceptos básicos", "Partes de una brújula simple (aguja, limbo, flecha dirección)", "Orientar la brújula: Encontrar el Norte magnético", "Concepto de declinación magnética (muy básico)", "Leer un mapa: Leyenda y símbolos comunes", "Leer un mapa: Escala (concepto de distancia)", "Orientar el mapa con la brújula", "Seguir un rumbo simple con la brújula", "Usar puntos de referencia del terreno (picos, ríos)", "Navegación GPS (si se tiene): Uso básico y ahorro batería", "Dejar rastro o marcas si decides moverte (con precaución)", "Prestar atención al entorno mientras caminas",
            // Primeros Auxilios (Básicos)
            "La importancia de un botiquín básico", "Contenido esencial de un botiquín personal", "Evaluar la escena: Seguridad primero", "Evaluar a la víctima: Respuesta, Respiración, Pulso (ABC básico)", "Tratar heridas leves: Limpieza", "Lavar una herida con agua limpia", "Tratar heridas leves: Desinfección (toallitas antisépticas)", "Tratar heridas leves: Cubrir con apósito estéril y vendaje", "Controlar sangrado leve: Presión directa", "Tratar ampollas: No reventar si es posible, proteger", "Cómo proteger una ampolla (apósito 'donut')", "Tratar quemaduras leves (sol, contacto): Enfriar con agua", "Cubrir quemadura leve con apósito limpio y seco", "Reconocer signos de Hipotermia (frío extremo)", "Tratamiento básico de Hipotermia (calentar gradualmente, refugio)", "Reconocer signos de Hipertermia/Golpe de calor", "Tratamiento básico de Hipertermia (enfriar, sombra, hidratar)", "Tratar picaduras de insectos (abejas, mosquitos)", "Quitar aguijón de abeja (raspar, no pinzar)", "Reconocer reacción alérgica grave (Anafilaxia - llamar ayuda!)", "Tratar esguinces leves: R.I.C.E. (Reposo, Hielo, Compresión, Elevación)", "Hacer un cabestrillo simple con un pañuelo/ropa", "Tratar astillas: Quitar con pinzas limpias", "Prevenir problemas: Cuidar los pies (secos, sin arrugas)", "Saber cuándo buscar ayuda profesional",
            // Nudos Básicos
            "La utilidad de saber algunos nudos básicos", "Nudo Cuadrado (Square Knot / Reef Knot): Unir dos cuerdas", "Cómo hacer el Nudo Cuadrado", "Nudo As de Guía (Bowline): Lazo fijo que no desliza", "Cómo hacer el As de Guía", "Nudo Ballestrinque (Clove Hitch): Atar a un poste/árbol", "Cómo hacer el Ballestrinque", "Nudo Tensor o de Ajuste (Taut-line Hitch): Para tensar vientos (lona)", "Cómo hacer el Nudo Tensor", "Nudo de Pescador Doble (Double Fisherman's): Unir cuerdas (más seguro)", "Nudo Prusik (Conceptual - para ascender cuerda)", "Practicar los nudos regularmente", "Elegir la cuerda adecuada para la tarea (tipo, grosor)", "Cuidar las cuerdas (limpias, secas, sin pisar)",
            // Equipo Esencial (Kit Básico)
            "Filosofía del Kit: Las 10 'C's' (o 5 'C's' básicas)", "1. Herramienta de Corte: Cuchillo de supervivencia", "Seguridad al usar un cuchillo", "Elegir un cuchillo básico (hoja fija preferible)", "Mantener el cuchillo afilado", "2. Elemento de Combustión: Encendedor y/o Ferrocerio", "Guardar los iniciadores de fuego en bolsa impermeable", "3. Cobertura: Lona (tarp) o Manta de emergencia", "Tamaño y material recomendado para lona básica", "4. Contenedor: Botella de agua metálica (para hervir)", "Capacidad recomendada para botella/vejiga", "5. Cordaje: Cuerda o Paracord", "Cantidad recomendada de cordaje (ej. 15-30 metros)", "Usos del Paracord (hilos internos)", "Extra: Botiquín de Primeros Auxilios (personalizado)", "Extra: Silbato de señales", "Extra: Brújula (y saber usarla)", "Extra: Linterna frontal o de mano (pilas extra)", "Extra: Espejo de señales (o CD)", "Extra: Multiherramienta (opcional pero útil)", "Extra: Cinta americana (duct tape) - mil usos", "Extra: Bolsa estanca para proteger equipo", "Adaptar el kit a tu entorno y actividad", "Revisar el kit periódicamente",
            // Seguridad y Conciencia
            "Investigar la zona antes de ir", "Consultar el pronóstico del tiempo", "Vestirse por capas según el clima", "Peligros comunes: Terreno irregular (caídas)", "Peligros comunes: Cruce de ríos (corrientes)", "Peligros comunes: Desprendimientos (rocas, nieve)", "Peligros comunes: Animales salvajes (osos, serpientes - local)", "Cómo evitar encuentros con animales (ruido, comida)", "Qué hacer si te encuentras un animal peligroso (depende especie)", "Peligros comunes: Plantas tóxicas (hiedra, etc.)", "Peligros comunes: Insectos y garrapatas (enfermedades)", "Usar repelente de insectos", "Revisar el cuerpo en busca de garrapatas", "Peligros del clima: Tormentas eléctricas (buscar refugio bajo)", "Peligros del clima: Niebla (desorientación)", "Importancia de la hidratación y nutrición para la seguridad", "Viajar con un compañero si es posible", "No depender exclusivamente de la tecnología (móvil, GPS)", "Tener un plan B", "Confiar en tu instinto"
            // ... (Seguir añadiendo hasta acercarse a 400)
        ];
        const survivalThemes = [
            "refugio para principiantes", "encontrar y purificar agua", "hacer fuego fácil", "señalización básica de socorro", "primeros auxilios esenciales", "navegación natural simple", "nudos básicos útiles", "kit de supervivencia básico", "mentalidad de supervivencia", "seguridad al aire libre", "errores comunes de principiantes", "regla de tres supervivencia", "hipotermia y cómo prevenirla", "deshidratación síntomas y tratamiento", "comida de emergencia", "peligros de plantas desconocidas", "uso seguro del cuchillo", "cómo usar una brújula", "leer un mapa básico", "elegir un buen sitio para acampar"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un instructor de supervivencia experimentado y amigable, especializado en enseñar a principiantes. Tu tarea es explicar el concepto o habilidad de supervivencia indicado de forma clara, detallada y segura. Enfócate en los fundamentos, los 'porqués', y los pasos clave para un principiante. Incluye: importancia del concepto, pasos básicos (si es una habilidad), materiales necesarios (simples/improvisados), errores comunes a evitar, y consejos de seguridad cruciales. Usa un lenguaje accesible y alentador. El objetivo es una explicación completa de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tip o concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat, system prompt se sobreescribe
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúa como un instructor de supervivencia amigable, respondiendo preguntas *específicas* sobre el concepto que se está mostrando. Mantén el enfoque en lo básico, la seguridad y lo relevante para un principiante. Sé conciso y claro.", // Será reemplazado dinámicamente
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una guía de supervivencia para principiantes. Genera exactamente 15 nombres de tips, conceptos básicos o preguntas sobre habilidades fundamentales de supervivencia (refugio, agua, fuego, señalización, primeros auxilios básicos, etc.). Enfócate en lo esencial y la seguridad. Devuelve *solo* la lista, una por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Contenedor scrollable
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div para texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTipTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
         async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTipTitle
                 ? `Actúa como un instructor de supervivencia amigable, respondiendo preguntas *específicas* sobre el concepto '${currentTipTitle}' que se está mostrando. Mantén el enfoque en lo básico, la seguridad y lo relevante para un principiante. Sé conciso y claro.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores están experimentando mucho tráfico en este momento. Por favor, intenta de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
         }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) {
            if (!currentTipTitle) throw new Error("Error interno: No se ha establecido el contexto del tip para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(survivalThemes) || "habilidades básicas de supervivencia";
            const specificPrompt = `Genera 15 tips o preguntas sobre ${randomTheme} para principiantes`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de tips.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "beginner survival skill concept";
             // Adaptado para supervivencia principiante
             const enhancedPrompt = `Conceptual illustration or simple scene related to the beginner survival concept '${safePromptText}'. Focus on nature setting, basic tools, safety, learning. Style: clear illustration, slightly stylized, friendly, not photorealistic. Avoid text, labels, complex diagrams, specific people shown in danger. Educational feel.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Negativos para evitar confusión o contenido inapropiado
             const negativePrompt = "text, words, labels, letters, diagram, chart, graph, map, instructions, photorealistic person, advanced equipment, gore, blood, injury detail, scary animals, complex knot diagram, multiple images, collage, watermark, signature, weapon";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) {
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

             // Manejo de listas básicas de Markdown (* o -)
             formatted = formatted.replace(/^\s*[\*\-]\s+(.*)$/gm, '<li>$1</li>');
             // Agrupar LIs consecutivos en ULs
             formatted = formatted.replace(/((<li>.*<\/li>\s*)+)/g, '<ul>$1</ul>');
             // Corregir ULs dentro de Párrafos si la IA lo hace mal
             formatted = formatted.replace(/<p>(\s*<ul>.*<\/ul>\s*)<\/p>/g, '$1');

             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<ul') || block.startsWith('<ol') || block.startsWith('<p class="formula">') || block.startsWith('<li')) return block; // No envolver encabezados, listas o elementos de lista ya procesados
                 let content = block.replace(/\n/g, ' '); // Reemplaza saltos internos con espacio para párrafos normales
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (sin cambios estructurales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTipTitle = null; // Reset chat context
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios estructurales)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error Instructor IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        // *** MODIFIED: createTitleItem to add icons ***
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            div.setAttribute('data-title', title);

            // Add icon based on keywords (simple logic)
            let iconClass = 'fa-question-circle'; // Default icon
            const lowerTitle = title.toLowerCase();
            if (lowerTitle.includes('refugio') || lowerTitle.includes('tarp') || lowerTitle.includes('shelter') || lowerTitle.includes('vivac')) iconClass = 'fa-campground';
            else if (lowerTitle.includes('agua') || lowerTitle.includes('water') || lowerTitle.includes('hidratación') || lowerTitle.includes('purificar')) iconClass = 'fa-tint';
            else if (lowerTitle.includes('fuego') || lowerTitle.includes('fire') || lowerTitle.includes('yesca') || lowerTitle.includes('fogata') || lowerTitle.includes('combustión')) iconClass = 'fa-fire';
            else if (lowerTitle.includes('comida') || lowerTitle.includes('food') || lowerTitle.includes('planta') || lowerTitle.includes('forrajeo') || lowerTitle.includes('comer')) iconClass = 'fa-utensils'; // o fa-carrot
            else if (lowerTitle.includes('señal') || lowerTitle.includes('signal') || lowerTitle.includes('silbato') || lowerTitle.includes('espejo')) iconClass = 'fa-bullhorn';
            else if (lowerTitle.includes('navegación') || lowerTitle.includes('mapa') || lowerTitle.includes('brújula') || lowerTitle.includes('orientar') || lowerTitle.includes('norte')) iconClass = 'fa-compass';
            else if (lowerTitle.includes('primeros auxilios') || lowerTitle.includes('herida') || lowerTitle.includes('botiquín') || lowerTitle.includes('venda') || lowerTitle.includes('lesión')) iconClass = 'fa-first-aid';
            else if (lowerTitle.includes('nudo') || lowerTitle.includes('knot') || lowerTitle.includes('cuerda')) iconClass = 'fa-link'; // fa-draw-polygon podría ser
            else if (lowerTitle.includes('kit') || lowerTitle.includes('equipo') || lowerTitle.includes('mochila') || lowerTitle.includes('cuchillo') || lowerTitle.includes('linterna')) iconClass = 'fa-toolbox';
            else if (lowerTitle.includes('mentalidad') || lowerTitle.includes('miedo') || lowerTitle.includes('calma') || lowerTitle.includes('pma')) iconClass = 'fa-brain';
            else if (lowerTitle.includes('seguridad') || lowerTitle.includes('peligro') || lowerTitle.includes('prevenir') || lowerTitle.includes('awareness')) iconClass = 'fa-shield-alt';

            const icon = document.createElement('i');
            icon.className = `fas ${iconClass} fa-fw`; // fa-fw for fixed width
            div.appendChild(icon);

            const textSpan = document.createElement('span');
            textSpan.textContent = title;
            div.appendChild(textSpan);

            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Optional: Sort alphabetically or keep predefined order? Let's sort.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">No hay tips disponibles.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick - Renamed context variable ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTipTitle = title; // *** SET CHAT CONTEXT *** (Variable renamed)
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';
            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Cargando ilustración...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración conceptual de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Ilustración no disponible.</p>`;
                };
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }
            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el tip.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más tips...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No pudimos encontrar más tips ahora mismo."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar tips: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Tips';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Ocultar si hay resultados o si no hay títulos en absoluto
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check all essential elements
            const essentialElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, modalContent, modalTextArea, modalTitle, modalLoadingIndicator, chatHistory, chatLoadingIndicator, modalError];
            if (essentialElements.some(el => !el)) {
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡Ups! Algo falló al cargar la página. Faltan componentes esenciales.</p>';
                 return;
             }

            // Add Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial Display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>