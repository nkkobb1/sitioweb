<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitos Griegos Reimaginados - Historias Ficticias</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Clásicas/Elegantes -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #D4AF37; /* Oro */
            --color-secondary: #1976D2; /* Azul Profundo (Mar/Cielo) */
            --color-tertiary: #4CAF50; /* Verde Olivo (Naturaleza/Laurel) - Uso moderado */
            --color-background: #f8f6f2; /* Blanco Hueso / Marmol muy claro */
            --color-text: #333333; /* Gris Oscuro casi Negro */
            --color-text-muted: #666666; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro */
            --color-border: #e0e0e0; /* Borde Gris Claro */
            --color-error-bg: #fff3f3; /* Fondo error rosa muy claro */
            --color-error-text: #b71c1c; /* Texto error rojo oscuro */
            --color-error-border: #ffcdd2; /* Borde error rosa */

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 4px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel Decorative', serif; font-weight: 700; letter-spacing: 1px; }
        .logo { color: var(--color-primary); text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        h1.page-title { color: var(--color-secondary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-secondary); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Lato'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #fffef7; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; /* Ocupa todo el ancho */ background: linear-gradient(45deg, var(--color-primary), #e4c85e); color: #333; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel Decorative', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: none; box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, #e4c85e, var(--color-primary)); box-shadow: var(--shadow-md); transform: scale(1.01); }
        #generate-more-btn:disabled { background: #e0e0e0; color: #9e9e9e; cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: #333; }

        /* Modal Styles */
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(50, 50, 50, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Increased height for potential game/chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #eee; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #fff; transform: rotate(90deg); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Modal Loading Area with Minigame */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.98);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius); padding: 2rem;
            text-align: center; color: var(--color-text);
        }
        #loading-minigame-container {
            width: 100%; max-width: 400px; height: 250px; /* Adjust size as needed */
            background-color: #e3f2fd; /* Light blue background for game */
            border: 2px solid var(--color-secondary);
            border-radius: var(--border-radius);
            position: relative; overflow: hidden;
            margin-top: 1.5rem; cursor: pointer;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        .minigame-icon {
            position: absolute; font-size: 1.8rem; /* Adjust size */
            transition: transform 0.1s ease-out;
            color: var(--color-secondary); /* Default icon color */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .minigame-icon.target-match { color: var(--color-tertiary); /* Green for correct clicks */ }
        .minigame-icon.target-miss { color: #e57373; /* Red for wrong clicks */ }
        .minigame-icon.bad-icon { color: #757575; /* Grey for bad icons */ }
        #minigame-target { margin-top: 1rem; font-size: 1.1rem; }
        #minigame-target-icon { font-size: 2.5rem; color: var(--color-primary); vertical-align: middle; margin: 0 0.5rem; }
        #minigame-info { margin-top: 0.5rem; font-size: 0.9rem; color: var(--color-text-muted); }

        /* Main Content Area (Scrollable Text + Fixed Chat below) */
        #modal-story-content-area { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; } /* Hidden initially */
        #modal-content-area { flex-grow: 1; min-height: 0; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-size: 1.05rem; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 700; }
        #modal-content em { color: var(--color-primary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel Decorative', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: #795548; } /* Brownish for H3 */
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Image Styles */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9f9f9; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; box-shadow: var(--shadow-sm); }
        .user-message { background-color: var(--color-secondary); color: #fff; margin-left: auto; text-align: left; font-weight: 400; }
        .ai-message { background-color: #e0e0e0; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: #333; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #c8a02b; }
        #chat-send-btn:disabled { background-color: #bdbdbd; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(50, 50, 50, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fall {
            0% { transform: translateY(-50px); opacity: 1; }
            100% { transform: translateY(250px); opacity: 0; } /* Match game container height */
        }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-book-open mr-3 text-yellow-600"></i> <!-- Icono Libro -->
                     Mitos Griegos Reimaginados
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">~ Historias Ficticias del Olimpo ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Relatos Perdidos del Panteón</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora narrativas alternativas y aventuras jamás contadas de los dioses, héroes y monstruos de la Antigua Grecia.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar dios, héroe, mito...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll text-yellow-700 mr-2"></i> <!-- Icono Pergamino -->
                 Índice de Historias
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los archivos del Oráculo...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">~ Ninguna leyenda coincide con tu búsqueda ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Invocar 40 Nuevos Relatos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <p class="text-xl font-semibold mb-2 font-serif">El Oráculo te pone a prueba...</p>
                 <p class="mb-4 text-sm">Mientras los hilos del destino tejen la historia, ¡demuestra tu valía!</p>
                 <div id="loading-minigame-container">
                     <!-- Minigame elements will be injected here by JS -->
                 </div>
                 <div id="minigame-target">Haz clic en: <i id="minigame-target-icon" class="fas fa-question-circle"></i></div>
                 <div id="minigame-info">Nivel: <span id="minigame-level">1</span> | Puntos: <span id="minigame-score">0</span></div>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image placeholder/image goes here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando a las Musas...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta más sobre esta leyenda...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada de la Leyenda">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias ficticias generadas por IA, inspiradas en la mitología griega con fines creativos y de entretenimiento.</p>
              <p class="mt-1">Estas narrativas no pretenden ser representaciones históricas ni mitológicamente exactas.</p>
              <p class="mt-2">© MMXXIV Archivos del Olimpo Reimaginado</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Dioses Mayores (Historias Ficticias)
            "El Juicio Secreto de Zeus", "La Furia Invernal de Hera", "El Laberinto Submarino de Poseidón", "La Biblioteca Perdida de Hades", "La Canción Oculta de Apolo", "El Jardín Mecánico de Hefesto", "La Tregua Olvidada de Ares", "El Espejo Lunar de Artemisa", "La Armadura Dorada de Atenea", "El Último Banquete de Dionisio", "El Mensaje Cifrado de Hermes", "La Cosecha Perpetua de Deméter", "Zeus: El Torneo de los Campeones Mortales", "Hera: La Venganza de las Plumas Doradas", "Poseidón: La Ciudad Sumergida de Coral", "Hades: El Lamento de Eurídice Resucitada", "Apolo: El Oráculo Silenciado", "Hefesto: La Autómata Enamorada", "Ares: El Pacto con los Gigantes", "Artemisa: La Caza de la Quimera Estelar", "Atenea: La Estratega contra el Caos", "Dionisio: El Festival de las Ilusiones", "Hermes: El Robo del Tiempo", "Deméter: El Secreto de la Primavera Eterna", "La Noche en que Zeus Perdió el Rayo", "El Jardín Secreto de Hera", "Poseidón y el Kraken de Bronce", "Hades y el Río de las Almas Olvidadas", "Apolo y la Lira del Silencio", "Hefesto y la Espada que Forjó un Destino", "Ares en el Laberinto del Minotauro", "Artemisa y el Bosque Susurrante", "Atenea y el Enigma de la Esfinge Mecánica", "Dionisio y la Vid de la Locura", "Hermes y el Mapa de las Estrellas Caídas", "Deméter y el Invierno que Nunca Acabó",
            // Dioses Menores y Otros Seres
            "El Vuelo Final de Ícaro (Final Alternativo)", "La Maldición Inversa de Medusa", "El Eco Eterno de Narciso", "La Rueda Dorada de Némesis", "El Cruce de Caronte: Tarifa Especial", "El Secreto de las Hespérides", "La Ascensión de Ganimedes al Olimpo", "El Taller de Dedalo: Inventos Perdidos", "La Melodía Prohibida de Orfeo", "Pan y la Flauta de los Sueños", "Hécate y el Cruce de los Tres Caminos", "Las Moiras: El Hilo que se Resistió", "Perséfone: Reina del Inframundo por Elección", "El Juicio de Paris: La Cuarta Diosa", "El Desafío de Aracne a Atenea (Rematch)", "El Secreto de Circe: Más Allá de la Transformación", "El Voto de Silencio de las Musas", "La Furia de las Erinias: Un Caso Equivocado", "Hipnos y Tánatos: El Intercambio de Reinos", "Asclepio: La Cura para la Muerte", "Nike y la Derrota Inesperada", "Iris y el Puente de Arcoíris Roto", "Helios y el Carro Solar Desbocado", "Selene y el Amante Mortal Oculto", "Eolo y la Tormenta Perfecta", "El Festín Robado de Tántalo", "Sísifo y la Cima de la Montaña", "Prometeo: El Fuego Recuperado", "Atlas y el Mundo en Miniatura", "Las Sirenas y el Canto de la Verdad", "El Viento Perdido de Céfiro", "Bóreas y la Princesa de Hielo", "La Última Profecía de Casandra", "La Primera Sombra de Érebo", "El Último Brillo de Hemera",
            // Héroes (Nuevas Aventuras)
            "Heracles: El Decimotercer Trabajo", "Odiseo: El Viaje a Través del Tiempo", "Aquiles: La Vida Después de Troya", "Perseo: El Escudo de las Gorgonas", "Teseo: El Regreso al Laberinto", "Jasón y los Argonautas: La Búsqueda del Vellocino Lunar", "Belerofonte: El Vuelo sobre el Olimpo", "Edipo: La Redención en Colono", "Héctor: El Fantasma de Troya", "Agamenón: El Juicio en el Inframundo", "Menelao y Helena: La Segunda Fuga", "Áyax: El Guerrero Solitario", "Diomedes: El Favor de Atenea Retirado", "Néstor: El Relato Jamás Contado", "Peleo y Tetis: La Disputa por Aquiles", "Cadmo y la Fundación de la Ciudad Perdida", "Atalanta: La Carrera contra el Tiempo", "Meleagro y la Caza del Jabalí Estelar", "Orfeo y Eurídice: El Pacto con Hades", "La Infancia Secreta de Heracles", "Odiseo y la Isla de las Ilusiones", "Aquiles y la Amazona Pentesilea (Final Alternativo)", "Perseo y la Medusa Arrepentida", "Teseo y Ariadna: La Fuga a Creta", "Jasón y Medea: La Reconciliación", "El Entrenamiento de Aquiles con Quirón", "La Misión Secreta de Belerofonte", "Edipo y el Acertijo del Futuro", "Héctor y Andrómaca: Un Escape Imposible", "La Sabiduría Oculta de Néstor",
            // Monstruos (Perspectivas Diferentes)
            "La Soledad de Medusa antes de la Maldición", "El Minotauro: Guardián Incomprendido", "La Hidra de Lerna: La Cabeza que Sobrevivió", "Cerbero: El Cachorro del Inframundo", "La Esfinge: El Acertijo sin Respuesta", "Las Arpías: Mensajeras del Destino", "Los Cíclopes: Los Primeros Arquitectos", "Escila y Caribdis: El Pacto Secreto", "El León de Nemea: Más que una Piel Invulnerable", "Los Centauros: Entre la Sabiduría y la Furia", "Las Sirenas: El Canto que Salva", "El Grifo: Guardián de Tesoros Olvidados", "La Quimera: Un Experimento Fallido", "El Cancerbero y Perséfone", "El Lamento del Minotauro", "La Verdadera Historia de las Gorgonas", "El Origen Secreto de la Hidra", "Las Arpías y el Festín Celestial", "Polifemo: El Cíclope Poeta", "Escila: La Guardiana del Estrecho", "Caribdis: El Corazón del Remolino", "La Juventud del León de Nemea", "Quirón y la Educación de los Monstruos", "Las Sirenas y Odiseo: La Conversación", "Los Grifos y el Oro de Apolo", "La Furia Domesticada de la Quimera",
            // Lugares y Eventos (Historias Alternativas)
            "El Olimpo: La Rebelión Silenciosa", "El Inframundo: Un Día de Puertas Abiertas", "Tartaro: La Fuga Imposible", "Los Campos Elíseos: La Llegada Inesperada", "El Oráculo de Delfos: La Profecía Falsa", "La Guerra de Troya: La Intervención Egipcia", "La Titanomaquia: La Tregua Secreta", "El Jardín de las Hespérides: El Fruto Prohibido Robado", "El Laberinto de Creta: La Salida Oculta", "El Monte Ida: La Cuna Secreta de Zeus", "El Río Estigia: El Juramento Roto", "La Atlántida: El Legado de Poseidón", "El Banquete de los Dioses: El Invitado Incómodo", "La Creación del Hombre (Versión de Hefesto)", "El Diluvio de Deucalión: Los Supervivientes Olvidados", "La Construcción de las Murallas de Troya (Por Dentro)", "El Viaje de los Argonautas: La Ruta Alternativa", "Los Misterios de Eleusis Revelados", "La Fundación de Atenas: El Voto Decisivo", "El Nacimiento de Afrodita: La Otra Versión", "El Vuelo de Faetón: Aterrizaje Forzoso", "La Caída de Ícaro: Sobreviviente", "El Eco de Eco: La Última Palabra", "La Transformación de Dafne: El Árbol Consciente",
            // Conceptos y "What Ifs"
            "¿Y si Hades Hubiera Gobernado el Olimpo?", "¿Y si Aquiles Hubiera Rechazado la Guerra?", "¿Y si Medusa Nunca Hubiera Sido Maldecida?", "¿Y si Heracles Hubiera Fallado un Trabajo?", "¿Y si Zeus Hubiera Sido Fiel a Hera?", "¿Y si los Titanes Hubieran Ganado?", "¿Y si Odiseo Nunca Hubiera Vuelto a Ítaca?", "¿Y si Perséfone Hubiera Odiado las Granadas?", "¿Y si Atenea y Poseidón Hubieran Hecho las Paces?", "¿Y si Prometeo No Hubiera Robado el Fuego?", "La Naturaleza de la Divinidad: Una Conversación", "El Significado de la Hybris para un Dios", "El Destino vs. El Libre Albedrío Divino", "La Profecía como Arma de Doble Filo", "La Maldición Familiar de los Átridas (Nueva Generación)", "La Metamorfosis como Escape", "La Intervención Divina: ¿Ayuda o Estorbo?", "El Amor entre Mortales e Inmortales: Casos Exitosos", "El Legado de los Semidioses", "El Poder de la Oración: Un Experimento Divino", "El Humor de los Dioses: Bromas Cósmicas", "La Tecnología en el Olimpo: Inventos de Hefesto", "El Arte de la Guerra según Ares vs. Atenea", "La Diplomacia Divina: El Consejo del Olimpo", "La Existencia de Otros Panteones (Cruce)",
            // ... (Continuar hasta ~400 o más)
            // ... Ejemplo de cómo seguir:
            "Zeus y el Juicio de Ganimedes", "Hera y el Pavo Real de Mil Ojos", "Poseidón y la Carrera de Hipocampos", "Hades y el Jardín de Asfódelos", "Apolo y la Flecha que Erró el Blanco", "Hefesto y la Red Invisible Mejorada", "Ares y el Entrenamiento de Fobos y Deimos", "Artemisa y la Osa Mayor", "Atenea y el Tejido del Universo", "Dionisio y el Vino que Revela Secretos", "Hermes y las Sandalias Perdidas", "Deméter y el Pacto con el Invierno", "El Último Gigante de la Gigantomaquia", "El Lamento de Calipso", "La Venganza de Circe", "La Biblioteca de las Musas", "El Taller Secreto de Asclepio", "La Risa de Momo", "El Silencio de Némesis", "La Travesía de Caronte", "El Regalo de Prometeo: La Esperanza", "La Paciencia de Atlas", "El Origen de las Ninfas", "El Secreto de los Sátiros", "La Danza de las Horas", "El Velo de Nix", "El Brillo de Eos", "La Caída de Hiperión", "La Memoria de Mnemósine", "La Justicia de Temis", "El Poder Oculto de Rea", "La Astucia de Cronos (Plan B)", "Heracles y la Hidra Mecánica", "Odiseo y el Cíclope Diplomático", "Aquiles y la Fuente de la Inmortalidad", "Perseo y Andrómeda: La Vida Después", "Teseo y el Minotauro Filósofo", "Jasón y el Vellocino Falso", "Belerofonte y Pegaso: El Viaje Interdimensional", "Edipo y la Esfinge Amistosa", "Héctor y el Escudo de Atenea", "Agamenón y Clitemnestra: Terapia de Pareja", "Medusa y Perseo: Una Alianza Inesperada", "El Minotauro y Ariadna: Hermanos Reconciliados", "La Hidra y Heracles: Un Empate Técnico", "Cerbero: Guardián de los Sueños", "La Esfinge y el Viajero del Tiempo", "Las Arpías y la Comida Rápida Divina", "El Olimpo como Destino Turístico", "El Inframundo S.A.: Nuevas Políticas", "El Laberinto de Creta 2.0", "La Atlántida Resurge", "La Guerra de Troya: El Musical", "El Jardín de las Hespérides: App de Entrega", "El Oráculo de Delfos Online", "Tartaro: Programa de Rehabilitación", "Campos Elíseos VIP Lounge", "El Río Estigia: Control de Pasaportes"
        ];
        const greekMythThemes = [
            "dioses olímpicos", "titanes", "héroes griegos", "monstruos mitológicos", "ninfas y sátiros",
            "la Guerra de Troya", "la Odisea", "los trabajos de Heracles", "el vellocino de oro", "el mito de Perseo",
            "el mito de Teseo", "el Inframundo griego", "el Oráculo de Delfos", "historias de amor mitológicas",
            "maldiciones y profecías", "metamorfosis divinas", "intervención divina", "hybris y némesis",
            "criaturas fantásticas griegas", "lugares míticos (Olimpo, Tartaro, Elíseo)", "dioses menores (Hécate, Pan, Nike)",
            "relaciones entre dioses y mortales", "secretos del Olimpo", "aventuras alternativas de héroes",
            "perspectivas de monstruos"
        ];
        const textApiConfig = {
            model: "mistral", // O el modelo que prefieras
            systemPrompt: "Eres un Aedo (poeta épico) moderno, un maestro narrador que teje nuevas y *ficticias* historias inspiradas en la mitología griega. Tu tarea es contar un relato fascinante sobre el dios, héroe, monstruo o evento indicado. NO te limites a resumir el mito conocido. Inventa detalles, motivaciones ocultas, diálogos, giros inesperados y aventuras alternativas. Mantén un tono épico y lírico, evocando la grandeza y el drama de la Antigua Grecia, pero con libertad creativa. Desarrolla personajes complejos, incluso los divinos. La historia debe tener una estructura clara (inicio, desarrollo, clímax, desenlace) y una extensión aproximada de 1200-1300 palabras. Basa tu creación únicamente en el siguiente título o concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúa como una Musa conocedora de esta *historia específica* que se acaba de contar. Responde preguntas sobre sus personajes, trama, simbolismo o posibles continuaciones (dentro de la narrativa ficticia presentada). Sé perspicaz y mantente enfocado únicamente en el relato actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para nuevas leyendas griegas *ficticias*. Genera exactamente 40 títulos evocadores y originales para historias sobre dioses, héroes, monstruos o eventos de la mitología griega. Enfócate en conceptos intrigantes o perspectivas novedosas. Devuelve *solo* la lista de títulos, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Más tiempo para generar 40
        };

        // ========== DOM ELEMENTS ==========
        // ... (Igual que antes: searchInput, titleListContainer, etc.)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameContainer = document.getElementById('loading-minigame-container');
        const minigameTargetIconEl = document.getElementById('minigame-target-icon');
        const minigameLevelEl = document.getElementById('minigame-level');
        const minigameScoreEl = document.getElementById('minigame-score');


        // ========== State Variables ==========
        let currentMythTitle = null;
        // Minigame State
        let gameLoopInterval = null;
        let gameIsRunning = false;
        let gameScore = 0;
        let gameLevel = 1;
        let gameIcons = []; // Array to hold active icon elements and their data
        let gameCurrentTargetIconClass = ''; // e.g., 'fa-bolt'
        let gameSpawnRate = 1500; // Milliseconds
        let gameFallSpeed = 2; // Pixels per frame
        let gameLastSpawnTime = 0;
        let gameTime = 0;
        const GAME_TARGET_ICONS = ['fa-bolt', 'fa-water', 'fa-fire', 'fa-feather-alt', 'fa-shield-alt', 'fa-ankh', 'fa-staff-aesculapius', 'fa-hat-wizard', 'fa-scroll', 'fa-gem', 'fa-leaf', 'fa-wine-glass-alt', 'fa-horse-head', 'fa-skull-crossbones', 'fa-ghost']; // More icons
        const GAME_BAD_ICONS = ['fa-spider', 'fa-poo', 'fa-virus']; // Icons to avoid


        // ========== API FUNCTIONS ==========
        // fetchTextFromApi, fetchExplanationText, fetchChatResponse remain largely the same,
        // but ensure context uses currentMythTitle and error messages are friendly.
         async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentMythTitle
                 ? `Eres una Musa conocedora de la historia ficticia sobre '${currentMythTitle}'. Responde preguntas de seguimiento sobre sus personajes, trama, simbolismo o posibles continuaciones (dentro de la narrativa presentada). Sé perspicaz y mantente enfocado únicamente en el relato actual.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, intenta en unos segundos.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la IA llegó vacía. Intenta de nuevo o reformula.");
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión con el Oráculo tardó demasiado (>${config.timeoutSeconds}s). Por favor, verifica tu conexión.`);
                 throw new Error(error.message || "Un error inesperado impidió contactar a las Musas.");
             }
         }
         async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
         async function fetchChatResponse(userQuery) { if (!currentMythTitle) throw new Error("Error interno: Contexto del mito no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
         // *** MODIFIED: fetchGeneratedTitles requests 40 ***
         async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(greekMythThemes) || "mitología griega general";
             const specificPrompt = `Genera 40 títulos de historias ficticias sobre ${randomTheme}`;
             console.log("Generating 40 titles with prompt:", specificPrompt);
             // Usa la configuración que pide 40
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                  .then(text => {
                      const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                      if (titles.length < 20) throw new Error("El Oráculo no pudo generar suficientes ideas nuevas."); // Expect less than 40 maybe
                      console.log(`Generated ${titles.length} new titles.`);
                      return titles.slice(0, 40); // Return up to 40
                  });
         }
         function createPollinationsImageUrl(promptText, options = {}) {
              const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
              const settings = { ...defaults, ...options };
              const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "ancient greek myth scene";
              const enhancedPrompt = `Epic mythological artwork depicting '${safePromptText}'. Style of classical oil painting (e.g., Rembrandt, Caravaggio, Waterhouse), dramatic lighting, detailed figures, ancient Greece setting. Avoid text, labels.`;
              const escapedPrompt = encodeURIComponent(enhancedPrompt);
              if (!escapedPrompt) return '';
              const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, photograph, blurry, low quality, modern elements";
              const escapedNegative = encodeURIComponent(negativePrompt);
              let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
              if (settings.nologo) url += '&nologo=true';
              console.log("Image URL:", url);
              return url;
          }

        // ========== Text Formatting ========== (Sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            stopMinigame(); // Ensure game stops when modal closes
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex'; // Show loading (with game) by default
             modalStoryContentArea.classList.add('content-hidden'); // Hide main content
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentMythTitle = null;
             hideFullscreenImage();
             // Reset game state for next opening
             gameScore = 0;
             gameLevel = 1;
             gameIcons = [];
             if (minigameContainer) minigameContainer.innerHTML = ''; // Clear game area
             updateMinigameDisplay();
        }

        // ========== FULLSCREEN IMAGE ========== (Sin cambios)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (Sin cambios funcionales, solo contexto y mensajes)
        function addChatMessage(message, sender) { /* ... */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error de la Musa: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
         }

        // ========== MINIGAME FUNCTIONS ==========
        function startMinigame() {
            if (!minigameContainer || gameIsRunning) return;
            console.log("Starting Minigame...");
            gameIsRunning = true;
            gameScore = 0;
            gameLevel = 1;
            gameIcons = [];
            gameTime = 0;
            minigameContainer.innerHTML = ''; // Clear previous icons
            setGameLevelParameters();
            chooseNewTargetIcon();
            updateMinigameDisplay();
            gameLastSpawnTime = performance.now();
            gameLoopInterval = requestAnimationFrame(gameLoop);
        }

        function stopMinigame() {
            if (!gameIsRunning) return;
            console.log("Stopping Minigame.");
            gameIsRunning = false;
            if (gameLoopInterval) {
                cancelAnimationFrame(gameLoopInterval);
                gameLoopInterval = null;
            }
            if (minigameContainer) minigameContainer.innerHTML = ''; // Clear icons on stop
        }

        function gameLoop(currentTime) {
            if (!gameIsRunning) return;

            const deltaTime = currentTime - gameTime;
            gameTime = currentTime;

            // Spawn new icons based on rate
            if (currentTime - gameLastSpawnTime > gameSpawnRate) {
                spawnIcon();
                gameLastSpawnTime = currentTime;
            }

            // Move existing icons and check for removal/clicks
            const containerHeight = minigameContainer.clientHeight;
            const iconsToRemove = [];
            gameIcons.forEach((iconData, index) => {
                iconData.y += gameFallSpeed * (deltaTime / 16.67); // Normalize speed roughly to 60fps
                iconData.element.style.top = `${iconData.y}px`;

                // Remove if off-screen
                if (iconData.y > containerHeight) {
                    iconsToRemove.push(index);
                    iconData.element.remove();
                    // Optional: Penalty for missing a target icon?
                    // if(iconData.isTarget) { gameScore -= 5; }
                }
            });

            // Remove icons from array (iterate backwards to avoid index issues)
            for (let i = iconsToRemove.length - 1; i >= 0; i--) {
                gameIcons.splice(iconsToRemove[i], 1);
            }

            updateMinigameDisplay(); // Update score/level shown

            // Continue loop
            gameLoopInterval = requestAnimationFrame(gameLoop);
        }

        function spawnIcon() {
            if (!minigameContainer || !gameIsRunning) return;

            const iconEl = document.createElement('i');
            iconEl.classList.add('fas', 'minigame-icon');

            // Decide icon type (target, bad, or filler)
            const iconTypeRoll = Math.random();
            let iconClass = '';
            let isTarget = false;
            let isBad = false;

            // Increase chance of bad icons at higher levels
            const badIconChance = Math.min(0.1 + (gameLevel * 0.02), 0.3); // Max 30% chance
            const targetIconChance = 0.4; // Chance to spawn the *current* target

            if (gameLevel >= 3 && iconTypeRoll < badIconChance && GAME_BAD_ICONS.length > 0) {
                iconClass = getRandomElement(GAME_BAD_ICONS);
                isBad = true;
                iconEl.classList.add('bad-icon');
            } else if (iconTypeRoll < badIconChance + targetIconChance) {
                 iconClass = gameCurrentTargetIconClass; // Spawn the one we need
                 isTarget = true;
            } else {
                // Spawn a random "good" icon (that isn't the current target or bad)
                let possibleIcons = GAME_TARGET_ICONS.filter(i => i !== gameCurrentTargetIconClass && !GAME_BAD_ICONS.includes(i));
                 if (possibleIcons.length === 0) possibleIcons = GAME_TARGET_ICONS.filter(i => i !== gameCurrentTargetIconClass); // Fallback if all good are bad
                 iconClass = getRandomElement(possibleIcons);
            }


            iconEl.classList.add(iconClass);

            // Random horizontal position
            const containerWidth = minigameContainer.clientWidth;
            const iconSize = 30; // Approx width/height
            const xPos = Math.random() * (containerWidth - iconSize);
            iconEl.style.left = `${xPos}px`;
            iconEl.style.top = '-30px'; // Start above screen

            minigameContainer.appendChild(iconEl);

            const iconData = {
                element: iconEl,
                iconClass: iconClass,
                x: xPos,
                y: -30,
                isTarget: isTarget,
                isBad: isBad
            };

            // Add click listener TO THE ICON ITSELF
            iconEl.addEventListener('click', (event) => handleIconClick(event, iconData));

            gameIcons.push(iconData);
        }

        function handleIconClick(event, iconData) {
            if (!gameIsRunning || !iconData || iconData.clicked) return;
            event.stopPropagation(); // Prevent clicks bubbling to container maybe?

            iconData.clicked = true; // Prevent multi-click scoring
            const iconEl = iconData.element;

            if (iconData.isBad) {
                // Clicked a bad icon - Penalty!
                gameScore = Math.max(0, gameScore - 15); // Example penalty
                iconEl.classList.add('target-miss'); // Show visual feedback
                console.log("Clicked bad icon!");
            } else if (iconData.iconClass === gameCurrentTargetIconClass) {
                // Clicked the correct target icon - Score!
                gameScore += 10 + gameLevel; // Score increases with level
                iconEl.classList.add('target-match'); // Show visual feedback
                console.log("Clicked target icon!");
                checkLevelUp();
                // Maybe choose a new target immediately after a successful click?
                // chooseNewTargetIcon();
            } else {
                // Clicked a wrong (but not 'bad') icon - Minor penalty or ignore
                gameScore = Math.max(0, gameScore - 2);
                iconEl.classList.add('target-miss');
                console.log("Clicked wrong icon.");
            }

             // Optional: Remove icon immediately on click or let it fall?
             // iconEl.remove();
             // gameIcons = gameIcons.filter(i => i !== iconData);

            // Simple visual feedback: brief scale up/down
             iconEl.style.transform = 'scale(1.3)';
             setTimeout(() => {
                 if (iconEl) iconEl.style.transform = 'scale(1)';
                 // Optionally remove after animation
                  setTimeout(() => {
                      if(iconEl && iconEl.parentElement) {
                           iconEl.remove();
                           gameIcons = gameIcons.filter(i => i !== iconData);
                      }
                  }, 150); // Remove after feedback fades
             }, 100);


            updateMinigameDisplay();
        }

        function chooseNewTargetIcon() {
            const possibleTargets = GAME_TARGET_ICONS.filter(icon => icon !== gameCurrentTargetIconClass);
            gameCurrentTargetIconClass = getRandomElement(possibleTargets.length > 0 ? possibleTargets : GAME_TARGET_ICONS);
            if (minigameTargetIconEl) {
                 minigameTargetIconEl.className = `fas ${gameCurrentTargetIconClass}`;
             }
        }

        function checkLevelUp() {
            const scoreNeeded = gameLevel * 50 + (gameLevel * gameLevel * 10); // Example progression
            if (gameScore >= scoreNeeded) {
                gameLevel++;
                setGameLevelParameters();
                chooseNewTargetIcon(); // Change target on level up
                console.log(`Level Up! Reached Level ${gameLevel}`);
                // Maybe add brief visual feedback for level up?
            }
        }

        function setGameLevelParameters() {
            // Adjust spawn rate and fall speed based on level
            gameSpawnRate = Math.max(300, 1500 - (gameLevel * 100)); // Faster spawns, minimum 300ms
            gameFallSpeed = 2 + (gameLevel * 0.3); // Faster fall speed
            console.log(`Level ${gameLevel}: SpawnRate=${gameSpawnRate.toFixed(0)}ms, FallSpeed=${gameFallSpeed.toFixed(1)}px/frame`);
        }

        function updateMinigameDisplay() {
            if (minigameLevelEl) minigameLevelEl.textContent = gameLevel;
            if (minigameScoreEl) minigameScoreEl.textContent = gameScore;
             if (minigameTargetIconEl && gameCurrentTargetIconClass) {
                 minigameTargetIconEl.className = `fas ${gameCurrentTargetIconClass}`; // Ensure target display updates
             }
        }


        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { /* ... */ const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... */
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">~ El Oráculo no revela más historias por ahora ~</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... */
            if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Appended ${addedCount} new unique titles.`);
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick integrates minigame start/stop ***
        async function handleTitleClick(title) {
            resetModalState(); // Resets everything, including game state vars
            showModal();
            modalTitle.textContent = title;
            currentMythTitle = title; // Set chat context
            modalLoadingIndicator.style.display = 'flex'; // Show loading area
            modalStoryContentArea.classList.add('content-hidden'); // Hide content area initially
            startMinigame(); // *** START MINIGAME ***

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                stopMinigame(); // *** STOP MINIGAME on success ***
                modalLoadingIndicator.style.display = 'none'; // Hide loading area
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Show content area
                chatSection.classList.remove('content-hidden'); // Ensure chat is visible too

                modalTextArea.scrollTop = 0; // Reset scroll *after* content is visible

                // Image Placeholder & Loading (within modalContent)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-palette placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Pintando la escena...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo visualizar.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                stopMinigame(); // *** STOP MINIGAME on error ***
                modalLoadingIndicator.style.display = 'none'; // Hide loading area
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la leyenda.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show the area so error is visible
                modalContent.innerHTML = ''; // Clear potentially partial content
                chatSection.classList.add('content-hidden'); // Hide chat on main error
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles uses new config ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando al Oráculo...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40 now
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("El Oráculo no ofrece más visiones por ahora."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error del Oráculo: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Invocar 40 Nuevos Relatos';
             }
         }

         // Search Filter Function (with accent normalization)
         function filterTitles(searchTerm) { /* ... */
            const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
            const titleItems = titleListContainer.querySelectorAll('.title-item');
            let visibleCount = 0;
            titleItems.forEach(item => {
                const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const isVisible = titleText.includes(term);
                item.classList.toggle('hidden', !isVisible);
                if (isVisible) visibleCount++;
            });
            noResultsMsg.classList.toggle('hidden', visibleCount > 0);
          }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameContainer) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡Oh, dioses! Faltan componentes cruciales de la interfaz. No se puede continuar.</p>';
                return;
             }
            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            // Minigame click listener on the container (delegation - might be less precise)
            // minigameContainer.addEventListener('click', handleMinigameClick); // Using direct listener on icons now

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            resetModalState(); // Ensure modal starts clean, game state reset
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>