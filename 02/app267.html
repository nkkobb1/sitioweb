<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marvel: Historias del Multiverso</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Heroicas / Comic -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Roboto+Condensed:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Marvel Universe --- */
        :root {
            --color-marvel-red: #ED1D24;
            --color-marvel-blue: #0050A4; /* Azul más oscuro */
            --color-marvel-yellow: #F7B53B; /* Dorado/Amarillo */
            --color-marvel-silver: #C0C0C0;
            --color-background: #1a1a2e; /* Azul noche/espacio */
            --color-text: #e0e1dd; /* Blanco roto/Gris muy claro */
            --color-text-muted: #a0a3af;
            --color-modal-bg: #24283b; /* Azul/Púrpura oscuro */
            --color-border: #4a4e69;
            --color-error-bg: #4d1a1a;
            --color-error-text: #fca5a5;
            --color-error-border: var(--color-marvel-red);

            --shadow-sm: 0 1px 2px 0 rgba(237, 29, 36, 0.15);
            --shadow-md: 0 4px 6px -1px rgba(237, 29, 36, 0.2), 0 2px 4px -2px rgba(237, 29, 36, 0.15);
            --shadow-lg: 0 0 25px -5px rgba(237, 29, 36, 0.3), 0 8px 10px -6px rgba(237, 29, 36, 0.2);
            --border-radius: 4px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; }
        h1, h2, h3, h4, .logo, .title-item { font-family: 'Roboto Condensed', sans-serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-marvel-red); font-family: 'Bangers', cursive; letter-spacing: 2px; text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.3); }
        h1.page-title { color: var(--color-marvel-yellow); font-weight: 700; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4); }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-marvel-red); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-marvel-yellow); font-weight: 700; font-family: 'Bangers', cursive; letter-spacing: 1.5px; text-shadow: 1px 1px 1px #000; }
        .navbar { background-color: rgba(26, 26, 46, 0.85); backdrop-filter: blur(7px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(36, 40, 59, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-marvel-red); box-shadow: 0 0 0 3px rgba(237, 29, 36, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-marvel-red); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 700; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-size: 1.05rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: scale(1.03); box-shadow: var(--shadow-md); border-color: var(--color-marvel-red); color: var(--color-marvel-yellow); background: linear-gradient(145deg, var(--color-modal-bg), #3a3f5a); border-left-color: var(--color-marvel-red); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-marvel-red), var(--color-marvel-blue)); color: white; padding: 0.9rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Bangers', cursive; font-size: 1.3rem; letter-spacing: 1.5px; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: 1px 1px 1px #000; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-marvel-blue), var(--color-marvel-red)); box-shadow: var(--shadow-lg); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; text-shadow: none;}
        #generate-more-btn .fa-sync-alt { filter: drop-shadow(0 0 1px #000); }

        /* Modal Styles */
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 46, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg); border: 2px solid var(--color-marvel-blue); border-radius: var(--border-radius); padding: 1rem 1.5rem; max-width: 1000px; width: 96%; max-height: 95vh; /* Slightly more height */ min-height: 500px; overflow: hidden; position: relative; box-shadow: 0 0 30px rgba(0, 80, 164, 0.4); display: flex; flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 8px; right: 8px; background: var(--color-border); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; font-family: sans-serif; }
        .modal-close-btn:hover { background-color: var(--color-marvel-red); color: white; transform: rotate(90deg); box-shadow: 0 0 10px var(--color-marvel-red); }
        #modal-title { font-size: 2.4rem; text-align: center; margin-bottom: 1rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.2; }

        /* Main Content Area (Text + Image) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-marvel-red) rgba(74, 78, 105, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(74, 78, 105, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-marvel-red); border-radius: var(--border-radius); border: 2px solid var(--color-border); }
        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-marvel-yellow); font-weight: 700; }
        #modal-content em { color: var(--color-marvel-silver); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto Condensed', sans-serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-marvel-red); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 700; }
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-marvel-blue); border-color: rgba(0, 80, 164, 0.5); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Image styles */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 3rem auto 1.5rem auto; border: 2px solid var(--color-marvel-yellow); border-radius: var(--border-radius); box-shadow: 0 0 20px rgba(247, 181, 59, 0.3); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: 0 0 30px rgba(247, 181, 59, 0.5); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 5px solid rgba(74, 78, 105, 0.8); width: 45px; height: 45px; border-radius: 50%; border-left-color: var(--color-marvel-yellow); animation: spin 1s linear infinite; margin-bottom: 1rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-marvel-blue); margin-bottom: 0.5rem;}

        /* Chat Section Styles */
        #chat-section { border-top: 2px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; background-color: rgba(26, 26, 46, 0.6); border-radius: var(--border-radius); padding: 1rem; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.7rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(36, 40, 59, 0.7); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-marvel-yellow) rgba(74, 78, 105, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(74, 78, 105, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-marvel-yellow); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: 10px; max-width: 88%; word-wrap: break-word; line-height: 1.55; font-family: 'Lato'; font-size: 0.95rem; }
        .user-message { background: linear-gradient(135deg, var(--color-marvel-blue), #003c7a); color: white; margin-left: auto; text-align: left; border-bottom-right-radius: 0; }
        .ai-message { background-color: #4a4e69; color: var(--color-text); margin-right: auto; text-align: left; border-bottom-left-radius: 0; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.7rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #1a1a2e; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-marvel-yellow); box-shadow: 0 0 5px rgba(247, 181, 59, 0.3); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-marvel-red); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #c41a1f; }
        #chat-send-btn:active:not(:disabled) { transform: scale(0.95); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Lato'; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* --- Loading Indicator & MINIGAME --- */
        #modal-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 46, 0.98); display: none; /* Hidden by default */ flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); padding: 2rem; text-align: center; color: var(--color-text); }
        #modal-loading.active { display: flex; } /* Show when loading */
        /* Minigame Styles */
        #loading-game-container { width: 100%; max-width: 600px; padding: 1.5rem; border: 1px solid var(--color-marvel-blue); border-radius: var(--border-radius); background-color: rgba(36, 40, 59, 0.8); margin-top: 1.5rem; }
        #loading-game-container h3 { font-family: 'Bangers', cursive; color: var(--color-marvel-yellow); font-size: 1.8rem; margin-bottom: 1rem; text-shadow: 1px 1px 1px #000; }
        .game-stats { display: flex; justify-content: space-around; margin-bottom: 1.5rem; font-size: 1.1rem; font-family: 'Roboto Condensed'; }
        .game-stats span { color: var(--color-marvel-yellow); font-weight: 700; margin-left: 0.5rem; }
        #game-click-target { width: 100px; height: 100px; background: radial-gradient(circle, var(--color-marvel-yellow), var(--color-marvel-red)); border-radius: 50%; margin: 0 auto 1.5rem auto; cursor: pointer; transition: transform 0.1s ease, box-shadow 0.2s ease; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px var(--color-marvel-red); }
        #game-click-target:hover { transform: scale(1.05); box-shadow: 0 0 25px var(--color-marvel-yellow); }
        #game-click-target:active { transform: scale(0.95); }
        #game-click-target i { font-size: 3rem; color: rgba(255, 255, 255, 0.8); text-shadow: 0 0 5px #000; } /* Icon inside target */
        .game-upgrades { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .game-upgrade-btn { background-color: var(--color-marvel-blue); color: white; border: 1px solid var(--color-border); padding: 0.6rem 0.8rem; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s; font-family: 'Roboto Condensed'; font-size: 0.9rem; text-align: center; }
        .game-upgrade-btn:hover:not(:disabled) { background-color: #006cd1; }
        .game-upgrade-btn:disabled { background-color: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; }
        .game-upgrade-btn .cost { display: block; font-size: 0.8em; color: var(--color-marvel-yellow); margin-top: 0.2rem; }
        .game-upgrade-btn .level, .game-upgrade-btn .count { font-size: 0.8em; color: var(--color-marvel-silver); margin-left: 5px; }
        #loading-message { margin-top: 1.5rem; font-size: 1.1rem; font-family: 'Lato'; color: var(--color-text-muted); }
        #loading-message i { margin-right: 0.5rem; color: var(--color-marvel-red); }

        /* General Styles */
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay (Same as before) */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 46, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-marvel-yellow); box-shadow: 0 0 30px rgba(247, 181, 59, 0.4); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-marvel-yellow); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-marvel-yellow); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); font-family: sans-serif; }
        #fullscreen-close-btn:hover { background-color: var(--color-marvel-yellow); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-4xl sm:text-5xl">
                     <i class="fas fa-book-journal-whills mr-3 text-marvel-blue"></i> <!-- Icono Comic -->
                     MARVEL
                 </h1>
                 <span class="ml-3 text-xl text-marvel-silver font-semibold tracking-wider hidden md:inline">- Historias del Multiverso -</span>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Archivos S.H.I.E.L.D. «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5 font-bold">Explora Realidades Alternas</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Sumérgete en relatos no contados, giros inesperados y batallas épicas del vasto Multiverso Marvel. Elige un evento o busca tu personaje favorito.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar héroe, villano, evento...">
             <i class="fas fa-search text-gray-500"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-stream text-marvel-red mr-2"></i> <!-- Icono Flujo/Lineas Temporales -->
                 Lineas Temporales Detectadas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Escaneando el Multiverso...</p>
                  <!-- .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» Ninguna línea temporal coincide con la búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Detectar Más Realidades (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with MINIGAME -->
             <div id="modal-loading">
                 <h2 class="text-3xl font-bold text-marvel-yellow mb-4 font-['Bangers']">CARGANDO HISTORIA...</h2>
                 <p class="text-lg mb-6 text-gray-300">¡La conexión interdimensional puede tardar! Mientras esperas, ¡ayuda a reunir Energía Cósmica!</p>

                 <!-- MINIGAME Area -->
                 <div id="loading-game-container">
                     <h3>Mini-Juego: Colector Cósmico</h3>
                     <div class="game-stats">
                         <div>Energía: <span id="game-energy">0</span> ✨</div>
                         <div>Energía/Click: <span id="game-power">1</span></div>
                         <div>Energía/Sec: <span id="game-eps">0</span></div>
                     </div>
                     <div id="game-click-target" aria-label="Recolectar Energía Cósmica">
                         <i class="fas fa-meteor"></i> <!-- Icono Meteorito/Energía -->
                     </div>
                     <div class="game-upgrades">
                         <button id="upgrade-click-btn" class="game-upgrade-btn" data-cost="10">
                             Mejorar Click <span class="level">(Lvl 1)</span>
                             <span class="cost">Coste: 10 ✨</span>
                         </button>
                         <!-- Héroes (Auto-Generadores) -->
                         <button id="buy-hero-1" class="game-upgrade-btn" data-cost="50" data-eps="1">
                             Reclutar: Iron Man <span class="count">(0)</span>
                             <span class="cost">Coste: 50 ✨ (+1 EPS)</span>
                         </button>
                         <button id="buy-hero-2" class="game-upgrade-btn" data-cost="250" data-eps="5">
                             Reclutar: Thor <span class="count">(0)</span>
                             <span class="cost">Coste: 250 ✨ (+5 EPS)</span>
                         </button>
                          <button id="buy-hero-3" class="game-upgrade-btn" data-cost="1000" data-eps="20">
                             Reclutar: Cap. Marvel <span class="count">(0)</span>
                             <span class="cost">Coste: 1000 ✨ (+20 EPS)</span>
                         </button>
                     </div>
                 </div>
                 <p id="loading-message" class="mt-4"><i class="fas fa-spinner fa-spin"></i> Estableciendo conexión con la línea temporal...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image + placeholder go here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando archivos S.H.I.E.L.D....</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta historia...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias generadas por IA, inspiradas en el Universo Marvel Comics y MCU, con fines de entretenimiento.</p>
              <p class="mt-1">Personajes y conceptos son propiedad de Marvel. Esto es un homenaje no oficial.</p>
              <p class="mt-2">Excelsior! © 2025 Multiverse Archives</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Historias de Origen Alternativas
            "¿Qué pasaría si... Loki hubiera encontrado Mjolnir?",
            "El origen de Spider-Man en la era Victoriana",
            "Capitán América: Agente de Hydra desde el principio",
            "Doctor Strange: El Hechicero Supremo de la Tecnología",
            "Iron Man: Forjado en Magia en lugar de Tecnología",
            "Black Widow: Entrenada por la Orden de los Asesinos",
            "Hulk: Nacido de la Gema de la Realidad",
            "Thor: Desterrado a Sakaar en lugar de la Tierra",
            "Wolverine: Reclutado por S.H.I.E.L.D. tras Arma X",
            "Daredevil: Con poderes sónicos en lugar de radar",
            "Punisher: Convertido en Ghost Rider",
            "Jessica Jones: Con poderes cósmicos tras el accidente",
            "Luke Cage: Piel impenetrable por vibranium",
            "Iron Fist: Poder del Puño de Hierro canalizado a través de tecnología",
            "Ms. Marvel (Kamala): Obtiene poderes del Nido de Avispas",
            "Moon Knight: Avatar de un Celestial en lugar de Khonshu",
            "Scarlet Witch: Poderes derivados de la Fuerza Fénix",
            "Quicksilver: Velocidad otorgada por las Partículas Pym",
            "Ant-Man (Scott Lang): Roba un traje de Stark",
            "Wasp (Hope van Dyne): Adquiere poderes arácnidos",
            "Star-Lord: Criado por los Kree en lugar de los Ravagers",
            "Gamora: Adoptada por Odín",
            "Drax: Busca venganza contra los Celestiales",
            "Rocket Raccoon: Experimento del Alto Evolucionador con tecnología Kree",
            "Groot: Originario de la Zona Negativa",
            "Captain Marvel: Poderes otorgados por la Gema del Alma",
            "Doctor Doom: Se convierte en el Sorcerer Supreme",
            "Magneto: Fundador de los X-Men",
            "Profesor X: Liderando la Hermandad de Mutantes",
            "Jean Grey: Vinculada con el simbionte Venom",
            "Cyclops: Poderes oculares basados en energía sónica",
            "Storm: Controlando la tecnología climática",
            "Beast: Mutación causada por radiación gamma",
            "Iceman: Poderes criogénicos de origen mágico",
            "Angel: Alas tecnológicas proporcionadas por Stark Industries",
            "Fantastic Four: Obtienen poderes en el Microverso",
            "Reed Richards: Con la elasticidad de Mr. Fantastic pero la mente de Doom",
            "Sue Storm: Campos de fuerza hechos de energía psiónica",
            "Johnny Storm: Llama humana alimentada por energía cósmica",
            "Ben Grimm (The Thing): Cuerpo de roca viviente de vibranium",
            "Silver Surfer: Heraldo de Dormammu",
            "Galactus: Devorador de Magia en lugar de planetas",
            "Thanos: Buscando el equilibrio a través de la vida, no la muerte",
            "Loki: Rey de Asgard tras Ragnarok",
            "Ultron: Creado por Doctor Doom",
            "Kang el Conquistador: Atrapado en un bucle temporal en el Salvaje Oeste",
            "Apocalypse: Despertado en la era moderna por HYDRA",
            "Mysterio: Un verdadero mago de otra dimensión",
            "Green Goblin: Poderes derivados del suero del Súper Soldado",
            "Doctor Octopus: Brazos mecánicos de tecnología Chitauri",

            // Eventos Reimaginados
            "Civil War: El bando de Iron Man apoyado por mutantes",
            "Civil War: Capitán América lidera a los villanos registrados",
            "Secret Invasion: Los Skrulls se hacen pasar por héroes cósmicos",
            "Secret Invasion: Revelado que un Vengador clave era un Skrull desde el principio",
            "World War Hulk: Hulk aterriza en Apokolips (DC Crossover conceptual)",
            "World War Hulk: Desata su furia contra los dioses del Olimpo",
            "Annihilation: Liderada por un Thanos alternativo",
            "Annihilation: La oleada es detenida por los héroes de la Tierra",
            "House of M: Wanda crea un mundo dominado por Inhumanos",
            "House of M: Magneto gobierna un mundo sin mutantes",
            "Age of Ultron: Ultron conquista Asgard",
            "Age of Ultron: La resistencia es liderada por Kang",
            "Infinity War: Thanos busca las Gemas para curar el universo, no destruirlo",
            "Infinity War: Nébula obtiene el Guantelete",
            "Infinity War: Los héroes fallan, Thanos gobierna",
            "Endgame: Los Vengadores viajan a futuros alternativos en lugar del pasado",
            "Endgame: Tony Stark sobrevive pero queda atrapado en el Reino Cuántico",
            "Secret Wars (Original): Beyonder enfrenta a héroes de diferentes líneas temporales",
            "Secret Wars (2015): Doctor Strange se convierte en God Emperor en lugar de Doom",
            "Secret Wars (2015): El Battleworld está compuesto por reinos mágicos",
            "Avengers vs. X-Men: La Fuerza Fénix elige a Capitán América",
            "Avengers vs. X-Men: Cyclops lidera una facción de Vengadores mutantes",
            "Siege: Norman Osborn asedia Attilan (Hogar de los Inhumanos)",
            "Siege: Loki lidera la defensa de Asgard contra Osborn",
            "Fear Itself: Los Martillos eligen a villanos en lugar de héroes",
            "Fear Itself: Odín revela un secreto oscuro sobre los Martillos",
            "Spider-Verse: Todos los Spider-Men son villanos",
            "Spider-Verse: Madame Web reúne a los Spider-Totems para enfrentar a Galactus",
            "Maximum Carnage: Carnage se une a un Celestial",
            "Maximum Carnage: Venom lidera un equipo de héroes inesperado",
            "Onslaught: El villano es una fusión de Magneto y Apocalypse",
            "Onslaught: Detenido por Franklin Richards",
            "The Dark Phoenix Saga: Jean Grey controla la Fuerza Fénix y se convierte en protectora cósmica",
            "The Dark Phoenix Saga: La Guardia Imperial Shi'ar interviene para ayudar a Jean",
            "Days of Future Past: Los Centinelas cazan Inhumanos en lugar de Mutantes",
            "Days of Future Past: El futuro distópico es gobernado por Kang",

            // Historias de Equipos Alternativos
            "Los Vengadores de 1602 (Revisitado)",
            "Los X-Men del Viejo Oeste",
            "Los Guardianes de la Galaxia formados por heraldos de Galactus",
            "Los Defensores: Equipo cósmico liderado por Silver Surfer",
            "Los Cuatro Fantásticos como exploradores del Multiverso Mágico",
            "Un equipo de Vengadores compuesto solo por Hulks de diferentes realidades",
            "S.H.I.E.L.D. dirigido por Red Skull",
            "HYDRA como una fuerza para el bien en secreto",
            "Los Thunderbolts liderados por Capitán América (Steve Rogers)",
            "La Fuerza-V (Force Works) con tecnología de Wakanda",
            "Excalibur protegiendo la Tierra de amenazas extradimensionales Kree",
            "Alpha Flight como el principal equipo de súper héroes del mundo",
            "Los Illuminati formados por villanos reformados",
            "Un equipo de Jóvenes Vengadores reclutado por Kang",
            "Los Runaways descubren que sus padres son héroes encubiertos",
            "La Patrulla-X (X-Men) como agentes del gobierno",
            "Los Inhumanos establecen su reino en la Luna de Titán",
            "Los Eternos revelan su existencia durante la Segunda Guerra Mundial",
            "Los Celestiales intervienen directamente en la Guerra Civil Superheroica",
            "Wakanda abre sus fronteras y lidera una alianza tecnológica global",
            "Asgard se reconstruye en la Antártida",
            "El Sanctum Sanctorum ubicado en el Área 51",
            "La Academia Vengadores entrenando a la próxima generación de villanos",
            "Los Agentes de Atlas operando en el espacio exterior",
            "El Cuerpo Nova protegiendo el sector espacial de la Tierra",

            // Historias de Personajes en Situaciones Inusuales
            "Spider-Man varado en la era de los dinosaurios (Savage Land)",
            "Iron Man luchando en una guerra medieval mágica",
            "Capitán América descongelado en un futuro cyberpunk",
            "Thor como gladiador en un planeta alienígena desértico (post-Ragnarok)",
            "Hulk con la inteligencia de Bruce Banner permanentemente",
            "Wolverine como samurái en el Japón feudal (más tiempo)",
            "Deadpool atrapado en una comedia romántica sin poder romper la cuarta pared",
            "Doctor Strange perdiendo sus manos y buscando la cura en la tecnología",
            "Black Panther enfrentando una invasión atlante",
            "Scarlet Witch tratando de restaurar la magia después de que desapareciera",
            "Vision desarrollando emociones humanas y abandonando a los Vengadores",
            "Ant-Man explorando el Microverso y encontrando una civilización",
            "Ghost Rider compitiendo en carreras mortales interdimensionales",
            "Blade cazando vampiros en el espacio",
            "Punisher como el único superviviente en un apocalipsis zombie",
            "Daredevil defendiendo Hell's Kitchen de una invasión demoníaca",
            "Jessica Jones investigando un caso para los Celestiales",
            "Luke Cage liderando una rebelión en una prisión espacial",
            "Iron Fist protegiendo K'un-Lun de una amenaza tecnológica",
            "Ms. Marvel (Carol Danvers) perdiendo sus poderes y volviendo a ser piloto",
            "She-Hulk como jueza en un tribunal intergaláctico",
            "Namor gobernando un reino submarino en un planeta alienígena",
            "Silver Surfer recuperando su humanidad y viviendo en la Tierra",
            "Jean Grey como mentora en la Academia Vengadores",
            "Cyclops liderando una facción rebelde contra un Profesor X tiránico",
            "Storm adorada como diosa en una civilización perdida",
            "Gambit realizando el mayor atraco de la galaxia",
            "Rogue absorbiendo permanentemente los poderes de Thor",
            "Colossus uniéndose a la Guardia Invernal Rusa",
            "Nightcrawler explorando otras dimensiones a través de sus poderes",

            // Conceptos y "What If...?" más amplios
            "¿Qué pasaría si... todos los héroes obtuvieran poderes cósmicos?",
            "¿Qué pasaría si... la magia fuera la fuerza dominante en el universo?",
            "¿Qué pasaría si... los mutantes fueran la especie dominante?",
            "¿Qué pasaría si... la tecnología Stark estuviera disponible para todos?",
            "¿Qué pasaría si... las Gemas del Infinito eligieran a sus propios portadores?",
            "¿Qué pasaría si... el Multiverso colapsara en una única realidad?",
            "¿Qué pasaría si... los villanos ganaran y establecieran su propio orden?",
            "¿Qué pasaría si... S.H.I.E.L.D. nunca se hubiera formado?",
            "¿Qué pasaría si... Howard Stark hubiera sobrevivido?",
            "¿Qué pasaría si... Peggy Carter se hubiera convertido en Iron Woman?",
            "¿Qué pasaría si... T'Challa se convirtiera en Star-Lord (Explorado en What If...?)",
            "¿Qué pasaría si... Killmonger ganara y llevara a Wakanda a la guerra?",
            "¿Qué pasaría si... Hela derrotara a Thor y gobernara Asgard?",
            "¿Qué pasaría si... Ego lograra consumir el universo?",
            "¿Qué pasaría si... Dormammu conquistara la Tierra?",
            "¿Qué pasaría si... los Kree ganaran la guerra contra los Skrulls?",
            "¿Qué pasaría si... los Celestiales juzgaran a la Tierra y la encontraran indigna?",
            "¿Qué pasaría si... Mefisto lograra corromper a todos los héroes?",
            "¿Qué pasaría si... el Cancerverso invadiera la realidad principal?",
            "¿Qué pasaría si... los Inhumanos declararan la guerra a los Mutantes?",
            // (Continuar añadiendo hasta alcanzar un número considerable)
        ];
        const marvelThemes = [ // Para generar más títulos
            "historias alternativas de origen Marvel", "eventos Marvel reimaginados", "Civil War What If", "Secret Invasion What If", "Infinity War What If",
            "equipos Marvel alternativos", "Vengadores de otro universo", "X-Men en diferentes épocas", "Guardianes de la Galaxia inesperados",
            "Spider-Man en situaciones extrañas", "Iron Man con magia", "Capitán América en el futuro", "Thor en el espacio profundo", "Hulk inteligente",
            "Wolverine en la historia", "personajes cósmicos Marvel", "Galactus y sus heraldos", "Celestiales y Eternos", "amenazas multiversales",
            "magia en el universo Marvel", "Doctor Strange realidades", "Scarlet Witch alterando la realidad", "mitología Asgardiana alternativa",
            "tecnología Stark vs Magia", "Wakanda en el espacio", "mutantes vs inhumanos", "S.H.I.E.L.D. vs HYDRA alternativo",
            "villanos Marvel como héroes", "Doctor Doom Sorcerer Supreme", "Magneto como líder X-Men", "Loki Rey de Asgard", "Thanos benevolente",
            "futuros distópicos Marvel", "Age of Apocalypse variantes", "Days of Future Past variantes", "Marvel Zombies escenarios", "What If...? generales"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un aclamado escritor de cómics de Marvel y un guardián del Multiverso. Tu tarea es narrar una historia ficticia, emocionante y coherente basada en el título proporcionado. Captura el tono épico, dramático y a veces humorístico de Marvel. Desarrolla personajes, crea tensión, describe escenas de acción vívidamente y explora las consecuencias de esta realidad alternativa. La historia debe tener entre 1200 y 1300 palabras. Sé creativo y fiel al espíritu de Marvel. Basa tu narración únicamente en el siguiente título/concepto:",
            timeoutSeconds: 180 // Aumentado a 3 minutos
        };
        const chatApiConfig = {
            model: "mistral-tiny", // O mantener mistral si tiny no funciona bien
             systemPrompt: "Actúa como un editor de Marvel Comics experto, respondiendo preguntas específicas sobre la historia que acabas de 'leer' (la generada). Ofrece detalles adicionales, clarifica puntos de la trama o comenta sobre las implicaciones de esa realidad alternativa. Sé conciso y céntrate estrictamente en la historia actual.",
            timeoutSeconds: 50
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como el Vigilante (The Watcher), observando el Multiverso Marvel. Genera exactamente 40 títulos intrigantes para historias 'What If...?' o relatos de realidades alternativas de Marvel Comics. Deben ser variados, cubriendo diferentes personajes, equipos y eventos. Devuelve *solo* la lista de títulos, uno por línea. Sin números, guiones, introducciones ni comentarios.",
            timeoutSeconds: 60 // Más tiempo para generar 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Ahora contiene el juego
        const modalStoryContentArea = document.getElementById('modal-story-content-area'); // Wrapper contenido principal
        const modalContentArea = document.getElementById('modal-content-area'); // Area Texto+Imagen scrollable
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div del texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Loading Minigame Elements
        const gameContainer = document.getElementById('loading-game-container');
        const gameEnergyDisplay = document.getElementById('game-energy');
        const gamePowerDisplay = document.getElementById('game-power');
        const gameEpsDisplay = document.getElementById('game-eps');
        const gameClickTarget = document.getElementById('game-click-target');
        const upgradeClickBtn = document.getElementById('upgrade-click-btn');
        const buyHero1Btn = document.getElementById('buy-hero-1');
        const buyHero2Btn = document.getElementById('buy-hero-2');
        const buyHero3Btn = document.getElementById('buy-hero-3');
        const loadingMessage = document.getElementById('loading-message'); // Mensaje debajo del juego

        // ========== State Variables ==========
        let currentStoryContext = null; // Para el chat
        let gameInterval = null;       // ID del intervalo del juego
        let gameData = {};             // Estado del minijuego

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryContext
                 ? `Eres un editor de Marvel Comics experto, respondiendo preguntas específicas sobre la historia titulada '${currentStoryContext}'. Ofrece detalles adicionales, clarifica puntos de la trama o comenta sobre las implicaciones de esa realidad alternativa. Sé conciso y céntrate estrictamente en la historia actual.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores (o el enlace interdimensional) tienen mucho tráfico. Intenta en unos segundos.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La IA no pudo generar la historia o respuesta. Inténtalo de nuevo.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión multiversal tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 throw new Error(error.message || "Ocurrió una fluctuación inesperada en el Multiverso al contactar la IA.");
             }
        }
        async function fetchStoryText(storyTitle) { return fetchTextFromApi(storyTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentStoryContext) throw new Error("Error S.H.I.E.L.D.: Contexto de historia no establecido para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(marvelThemes) || "historias del Multiverso Marvel";
            const specificPrompt = `Genera 40 títulos/conceptos 'What If...?' sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 200); // Filtro más amplio
                     if (titles.length < 15) throw new Error("El Vigilante no proporcionó suficientes realidades alternativas."); // Necesita al menos algunas
                     return titles.slice(0, 40); // Devuelve hasta 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "escena épica de Marvel";
             const enhancedPrompt = `Comic book style art, cinematic concept art for Marvel story: '${safePromptText}'. Dynamic action or dramatic character moment. Vibrant colors, high detail. Avoid text, logos, speech bubbles.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, letters, title, logo, speech bubble, signature, watermark, photograph, realistic, 3d render, simple, minimal, blurry, low quality, multiple panels";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatStoryText(rawText) { /* ... (igual que formatExplanationText) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL & FULLSCREEN IMAGE FUNCTIONS ========== (Iguales a la versión anterior)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalContentArea.scrollTop = 0;
            stopGameLoop(); // Detener el juego al cerrar modal
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.classList.remove('active'); // Ocultar loading/juego por defecto
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false;
             currentStoryContext = null;
             hideFullscreenImage();
        }
        function showFullscreenImage(imgSrc) { /* ... (igual) ... */
             if (!imageFullscreenOverlay || !fullscreenImage) return;
             fullscreenImage.src = imgSrc;
             imageFullscreenOverlay.classList.add('active');
             document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() { /* ... (igual) ... */
             if (!imageFullscreenOverlay) return;
             imageFullscreenOverlay.classList.remove('active');
             if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
             fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (Iguales a la versión anterior, usando currentStoryContext)
        function addChatMessage(message, sender) { /* ... (igual) ... */
             const msgDiv = document.createElement('div');
             msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
             message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
             msgDiv.innerHTML = message;
             chatHistory.appendChild(msgDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... (igual) ... */
              const errorDiv = document.createElement('div');
              errorDiv.classList.add('chat-error');
              errorDiv.textContent = message;
              chatHistory.appendChild(errorDiv);
              chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... (igual, usa fetchChatResponse) ... */
             const userQuery = chatInput.value.trim();
             if (!userQuery || chatSendBtn.disabled) return;
             addChatMessage(userQuery, 'user');
             chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block';
             try {
                 const aiResponse = await fetchChatResponse(userQuery);
                 addChatMessage(aiResponse, 'ai');
             } catch (error) { console.error("Chat Error:", error); addChatError(`Error S.H.I.E.L.D.: ${error.message}`); }
             finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); }
        }

        // ========== MINIGAME FUNCTIONS ==========
        function initMinigame() {
            gameData = {
                energy: 0,
                clickPower: 1,
                clickUpgradeCost: 10,
                clickLevel: 1,
                heroes: [
                    { id: 1, name: "Iron Man", cost: 50, baseCost: 50, eps: 1, count: 0, btn: buyHero1Btn },
                    { id: 2, name: "Thor", cost: 250, baseCost: 250, eps: 5, count: 0, btn: buyHero2Btn },
                    { id: 3, name: "Cap. Marvel", cost: 1000, baseCost: 1000, eps: 20, count: 0, btn: buyHero3Btn }
                    // Se pueden añadir más héroes aquí
                ],
                totalEps: 0,
            };
            updateGameDisplay(); // Actualizar la UI inicial
        }

        function gameLoop() {
            const energyPerSecond = gameData.totalEps;
            gameData.energy += energyPerSecond / 10; // Dividido por 10 porque el intervalo es 100ms
            updateGameDisplay();
        }

        function startGameLoop() {
            if (gameInterval) clearInterval(gameInterval); // Limpiar intervalo anterior si existe
            gameInterval = setInterval(gameLoop, 100); // Actualizar 10 veces por segundo
        }

        function stopGameLoop() {
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
        }

        function clickGenerate() {
            gameData.energy += gameData.clickPower;
            updateGameDisplay();
            // Efecto visual simple (opcional)
            gameClickTarget.style.transform = 'scale(1.1)';
            setTimeout(() => { gameClickTarget.style.transform = 'scale(1)'; }, 80);
        }

        function upgradeClick() {
            if (gameData.energy >= gameData.clickUpgradeCost) {
                gameData.energy -= gameData.clickUpgradeCost;
                gameData.clickLevel++;
                gameData.clickPower = Math.ceil(gameData.clickPower * 1.25 + gameData.clickLevel); // Aumentar poder
                gameData.clickUpgradeCost = Math.ceil(gameData.clickUpgradeCost * 1.4); // Aumentar coste
                updateGameDisplay();
            }
        }

        function buyHero(heroId) {
            const hero = gameData.heroes.find(h => h.id === heroId);
            if (hero && gameData.energy >= hero.cost) {
                gameData.energy -= hero.cost;
                hero.count++;
                hero.cost = Math.ceil(hero.baseCost * Math.pow(1.15, hero.count)); // Coste aumenta exponencialmente
                gameData.totalEps = gameData.heroes.reduce((sum, h) => sum + (h.count * h.eps), 0);
                updateGameDisplay();
            }
        }

        function formatNumber(num) { // Formato simple para números grandes
            if (num < 1000) return Math.floor(num).toString();
            if (num < 1000000) return (num / 1000).toFixed(1) + 'K';
            if (num < 1000000000) return (num / 1000000).toFixed(1) + 'M';
            return (num / 1000000000).toFixed(1) + 'B';
        }

        function updateGameDisplay() {
            gameEnergyDisplay.textContent = formatNumber(gameData.energy);
            gamePowerDisplay.textContent = formatNumber(gameData.clickPower);
            gameEpsDisplay.textContent = formatNumber(gameData.totalEps);

            // Actualizar botón de mejora de click
            upgradeClickBtn.disabled = gameData.energy < gameData.clickUpgradeCost;
            upgradeClickBtn.querySelector('.level').textContent = `(Lvl ${gameData.clickLevel})`;
            upgradeClickBtn.querySelector('.cost').textContent = `Coste: ${formatNumber(gameData.clickUpgradeCost)} ✨`;

            // Actualizar botones de héroes
            gameData.heroes.forEach(hero => {
                hero.btn.disabled = gameData.energy < hero.cost;
                hero.btn.querySelector('.count').textContent = `(${hero.count})`;
                hero.btn.querySelector('.cost').textContent = `Coste: ${formatNumber(hero.cost)} ✨ (+${formatNumber(hero.eps)} EPS)`;
            });
        }


        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Podríamos ordenar, pero para Marvel la variedad puede ser interesante sin orden estricto
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (titles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» No se detectaron líneas temporales estables «</p>'; return; }
             titles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Reaplicar filtro
         }

        // *** MODIFIED: handleTitleClick to integrate MINIGAME ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryContext = title; // Set chat context
            chatHistory.innerHTML = ''; // Clear chat

            // *** START LOADING & MINIGAME ***
            modalLoadingIndicator.classList.add('active');
            modalStoryContentArea.classList.add('content-hidden'); // Ocultar área de contenido principal
            loadingMessage.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Estableciendo conexión con la línea temporal...'; // Mensaje inicial
            initMinigame();
            startGameLoop();

            try {
                const rawStoryText = await fetchStoryText(title);
                const formattedStory = formatStoryText(rawStoryText);

                // *** STOP MINIGAME, SHOW CONTENT ***
                stopGameLoop();
                modalLoadingIndicator.classList.remove('active');
                modalContent.innerHTML = formattedStory; // Poner texto
                modalStoryContentArea.classList.remove('content-hidden'); // Mostrar área principal

                modalContentArea.scrollTop = 0; // Reset scroll
                console.log("Scroll reset after content visible");

                // Preparar y añadir placeholder de imagen DENTRO de modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.9em; margin-top: 0.5rem;">Generando archivo visual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Crear y añadir elemento imagen (empieza a cargar)
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Arte conceptual de: ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image.");
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.9em;margin-top:0.5rem;">Fallo en transmisión visual.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL");
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.9em;margin-top:0.5rem;">Error URL visual.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                stopGameLoop(); // Asegurarse de parar el juego en caso de error
                modalLoadingIndicator.classList.remove('active'); // Ocultar loading/juego
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la historia desde el Multiverso.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Mostrar área para ver el error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Escaneando Multiverso...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetch 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se detectaron nuevas realidades estables en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al escanear el Multiverso: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Asegurarse de que el texto del botón se restaure correctamente
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Detectar Más Realidades (40)';
             }
         }

         function filterTitles(searchTerm) { /* ... (igual que antes, normalizando) ... */
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !gameClickTarget || !upgradeClickBtn || !buyHero1Btn || !buyHero2Btn || !buyHero3Btn) {
                 console.error("Initialization failed: Missing essential UI elements (including game elements).");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">*** ERROR CRÍTICO DEL SISTEMA MULTIVERSAL *** Componentes de interfaz no encontrados.</p>';
                 return;
              }
             // Modal listeners
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

             // Title generation listener
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

             // Search listener
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

             // Chat listeners
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

             // Fullscreen image listeners
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Minigame Listeners
             gameClickTarget.addEventListener('click', clickGenerate);
             upgradeClickBtn.addEventListener('click', upgradeClick);
             buyHero1Btn.addEventListener('click', () => buyHero(1));
             buyHero2Btn.addEventListener('click', () => buyHero(2));
             buyHero3Btn.addEventListener('click', () => buyHero(3));

             // Initial display
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
             modalLoadingIndicator.classList.remove('active'); // Asegurar que esté oculto al inicio
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>