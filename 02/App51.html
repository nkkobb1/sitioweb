<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educación Sencilla - Derecho Romano</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- Theme Update --- */
        :root {
            --color-primary: #7f1d1d; /* Red-900 (Imperial/Classical) */
            --color-secondary: #b45309; /* Amber-700 (Bronze/Scroll) */
            --color-background: #fefcf9; /* Slightly off-white, parchment-like */
            --color-text: #1f2937; /* Dark gray */
            --color-text-muted: #6b7280;
            --color-modal-bg: #ffffff;
            --color-border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px;
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Nunito', sans-serif; background-color: var(--color-background); color: var(--color-text); }
        h1, h2, h3, h4, .logo { font-family: 'Quicksand', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.5rem; display: inline-block; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Nunito', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #991b1b; /* Darker Red */ box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border-radius: var(--border-radius); padding: 1.5rem; max-width: 950px; /* Slightly wider for longer text */ width: 95%; max-height: 90vh; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e5e7eb; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.4rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: #d1d5db; color: var(--color-text); }
        #modal-title { color: var(--color-primary); text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; font-size: 1.6rem; /* Slightly larger title */ }
        #modal-content { line-height: 1.75; /* Slightly more spacing for long text */ color: var(--color-text); white-space: normal; overflow-y: auto; margin-bottom: 1.5rem; padding: 0 15px; /* More padding */ flex-grow: 1; min-height: 0; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content::-webkit-scrollbar { width: 8px; }
        #modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 4px;}
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: 4px; border: 2px solid var(--color-border); }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: bold; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Quicksand', sans-serif; margin-top: 1.8em; margin-bottom: 0.8em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.3em; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.2em; }
        #modal-content h4 { font-size: 1.1em; color: var(--color-secondary); }
        #modal-content .formula { /* Keep style for potential math/logic within law */ text-align: center; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 1.1em; padding: 0.8em; margin: 1.2em 0; border: 1px solid var(--color-border); background-color: #f9fafb; border-radius: var(--border-radius); overflow-x: auto; white-space: nowrap; }
        #modal-content .formula sub, #modal-content .formula sup { font-size: 0.8em; line-height: 0; position: relative; vertical-align: baseline; }
        #modal-content .formula sub { top: 0.5em; }
        #modal-content .formula sup { top: -0.5em; }
        #modal-image-container { width: 100%; height: 240px; /* Slightly taller image */ background-color: #f3f4f6; border-radius: var(--border-radius); overflow: hidden; display: none; /* Start hidden */ align-items: center; justify-content: center; border: 1px solid var(--color-border); flex-shrink: 0; margin-top: 1rem; }
        #modal-image-container.visible { display: flex; }
        #modal-image-container img { width: 100%; height: 100%; object-fit: contain; display: none; }
        #modal-image-container .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 30px; height: 30px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; display: none; }
        #modal-image-container .placeholder-icon { font-size: 3rem; color: var(--color-border); display: none; }
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fee2e2; color: #b91c1c; padding: 1rem; border-radius: var(--border-radius); border: 1px solid #fecaca; margin-top: 1rem; text-align: center; flex-shrink: 0; }
        .error-msg i { margin-right: 0.5rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-8">
         <div class="container mx-auto px-4 py-3 flex justify-center items-center">
             <div class="flex items-center">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-gavel mr-2"></i> Educación Sencilla: Derecho Romano
                 </h1>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Fundamentos del Derecho Occidental</h1>
             <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">Explora las bases del pensamiento legal que moldearon Occidente con explicaciones claras por IA. ¡Selecciona un principio!</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-6 text-center mx-auto">
                 <i class="fas fa-scroll text-amber-700 mr-2"></i>
                 Principios a Explorar
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Consultando archivos...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Principios
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Compilando explicación...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                 </div>
                  <!-- Image Container (Initially Hidden) -->
                 <div id="modal-image-container">
                     <div class="spinner"></div>
                     <i class="fas fa-landmark placeholder-icon"></i> <!-- Placeholder icon -->
                     <img id="modal-image" alt="Visualización abstracta del concepto" />
                 </div>
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-circle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-5 mt-12 border-t border-gray-200">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA con fines educativos introductorios. El derecho es complejo, consulta fuentes académicas especializadas.</p>
              <p class="mt-1">© 2025 Educación Sencilla</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [ // Expanded List (around 150)
            "¿Qué es el Derecho Romano?", "La importancia del Derecho Romano hoy", "Periodización: Monarquía, República, Imperio", "Fuentes del Derecho Romano (Visión General)", "La Ley de las XII Tablas", "Los Edictos de los Magistrados (Pretores)", "El Ius Honorarium", "Los Senadoconsultos", "Las Constituciones Imperiales", "La Jurisprudencia Clásica", "Gayo y las Instituciones", "Ulpiano, Papiniano, Paulo, Modestino", "La Ley de Citas", "El Corpus Iuris Civilis de Justiniano", "El Código, el Digesto, las Institutas y las Novelas", "Concepto de Persona en Roma", "Status Libertatis: Libres y Esclavos", "Manumisión: Formas de Liberar Esclavos", "Status Civitatis: Ciudadanos, Latinos, Peregrinos", "La ciudadanía romana y su extensión", "Status Familiae: Sui Iuris y Alieni Iuris", "La Patria Potestas", "Capitis Deminutio (Máxima, Media, Mínima)", "El Matrimonio Romano (Cum Manu, Sine Manu)", "Requisitos y Disolución del Matrimonio", "El Divorcio en Roma", "La Dote", "La Tutela y la Curatela", "La Adopción y la Adrogación", "Concepto de 'Cosa' (Res)", "Clasificación de las Cosas (Mancipi/Nec Mancipi, Muebles/Inmuebles)", "La Propiedad (Dominium ex iure Quiritium)", "Modos de Adquirir la Propiedad Originarios (Ocupación, Accesión)", "Modos de Adquirir la Propiedad Derivativos (Mancipatio, In Iure Cessio, Traditio)", "La Usucapión (Prescripción Adquisitiva)", "La Posesión: Tenencia y Animus", "Interdictos Posesorios", "Derechos Reales sobre Cosa Ajena (Iura in re aliena)", "Las Servidumbres Prediales (Rústicas y Urbanas)", "El Usufructo, Uso y Habitación", "La Enfiteusis y la Superficie", "Derechos Reales de Garantía: Fiducia, Pignus, Hypotheca", "Concepto de Obligación (Obligatio)", "Elementos de la Obligación: Sujetos, Objeto, Vínculo", "Fuentes de las Obligaciones (Contratos, Delitos, Cuasi...)", "Clasificación de las Obligaciones (Dar, Hacer, No Hacer)", "Obligaciones Civiles y Naturales", "Obligaciones Solidarias y Mancomunadas", "Extinción de las Obligaciones (Pago, Novación, Compensación)", "El Incumplimiento de las Obligaciones", "Dolo y Culpa en las Obligaciones", "Caso Fortuito y Fuerza Mayor", "La Mora (Debitoris y Creditoris)", "Los Contratos en Derecho Romano", "Contratos Formales (Verbales y Literales)", "La Stipulatio", "Contratos Reales (Mutuo, Comodato, Depósito, Prenda)", "El Mutuo (Préstamo de Consumo)", "El Comodato (Préstamo de Uso)", "El Depósito (Regular e Irregular)", "Contratos Consensuales", "La Compraventa (Emptio Venditio)", "Obligaciones del Vendedor y Comprador", "Vicios Ocultos y Evicción", "El Arrendamiento (Locatio Conductio - Rei, Operarum, Operis)", "La Sociedad", "El Mandato", "Contratos Innominados (Do ut Des, etc.)", "Los Pactos (Nuda Pacta y Pacta Vestita)", "Los Delitos Privados (Delicta)", "El Hurto (Furtum)", "La Rapiña (Robo con Violencia)", "El Daño Injustamente Causado (Damnum Iniuria Datum - Lex Aquilia)", "Las Lesiones u Ofensas (Iniuria)", "Cuasicontratos (Gestión de Negocios, Pago de lo Indebido)", "Cuasidelitos", "La Sucesión Mortis Causa", "Sucesión Testamentaria", "El Testamento Romano: Formas y Contenido", "Institución de Heredero", "Sustituciones Hereditarias", "Legados y Fideicomisos", "Invalidez e Ineficacia del Testamento", "Sucesión Intestada (Ab Intestato)", "Órdenes Sucesorios según las XII Tablas y el Pretor", "Reformas de Justiniano a la Sucesión Intestada", "La Sucesión Necesaria (Legítima)", "La Querella Inofficiosi Testamenti", "Adquisición de la Herencia", "Beneficio de Inventario", "El Derecho Procesal Romano (Visión General)", "Las Acciones de la Ley (Legis Actiones)", "El Procedimiento Formulario", "Partes de la Fórmula (Intentio, Demonstratio, Condemnatio, Adiudicatio)", "La Litis Contestatio", "La Fase In Iure y Apud Iudicem", "La Sentencia y su Ejecución", "El Procedimiento Extraordinario (Cognitio Extra Ordinem)", "La Apelación", "El Concepto de 'Ius Civile'", "El 'Ius Gentium'", "El 'Ius Naturale'", "La Equidad (Aequitas)", "La Buena Fe (Bona Fides)", "Conceptos Clave: Justicia, Ley, Costumbre", "Influencia del Derecho Romano en el Código Civil", "La Recepción del Derecho Romano en Europa", "Derecho Romano y Lenguaje Jurídico Actual", "Principios Romanos en el Derecho Moderno (Pacta Sunt Servanda)", "Figuras Jurídicas Heredadas de Roma", "La Persona Jurídica en Roma (Concepto Incipiente)", "El Concepto de Fraude (Fraus)", "La Responsabilidad por Hecho Ajeno (Noxalidad)", "El Negocio Jurídico", "Elementos Esenciales y Accidentales del Negocio", "Vicios de la Voluntad (Error, Dolo, Violencia)", "La Representación (Directa e Indirecta)", "El Senado Romano y su Papel Jurídico", "Los Comicios (Asambleas Populares)", "El Papel del Pretor Peregrino", "La Codificación como Fenómeno Jurídico", "Derecho Público vs. Privado en Roma", "El Crimen (Crimina Publica)"
        ];
        const romanLawThemes = [ // Themes for generating more titles
            "fuentes del derecho romano", "derecho de personas", "capacidad jurídica", "derecho de familia romano", "matrimonio y divorcio", "patria potestad", "derechos reales", "propiedad y posesión", "servidumbres y usufructo", "derecho de obligaciones", "contratos romanos", "compraventa y arrendamiento", "delitos privados", "hurto y daño", "derecho sucesorio", "testamentos", "sucesión intestada", "procedimiento formulario", "acciones legales romanas", "el Corpus Iuris Civilis", "Justiniano", "jurisconsultos clásicos", "conceptos fundamentales (ius, fas, lex)", "ius civile vs ius gentium", "la recepción del derecho romano", "influencia en el derecho moderno", "figuras jurídicas clave", "negocio jurídico", "derecho público romano", "magistraturas romanas"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un experto en Derecho Romano y un excelente divulgador histórico-jurídico. Tu tarea es explicar instituciones, conceptos o periodos del Derecho Romano de forma muy clara, precisa y detallada, situándolos en su contexto histórico. El público objetivo es general o estudiantes que se inician en el tema. Utiliza un lenguaje accesible pero riguroso, define términos latinos clave (si los usas) y estructura la explicación lógicamente (párrafos, subtítulos con #, ##, ### o ####). El objetivo es una explicación completa y fácil de seguir de unas 1200-1300 palabras. Basa tu explicación únicamente en el siguiente concepto o pregunta:",
            timeoutSeconds: 150 // Increased timeout
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso. Genera exactamente 15 conceptos o preguntas clave sobre Derecho Romano, adecuados para ser explicados de forma sencilla a un público general o estudiante. Devuelve *solo* la lista de conceptos/preguntas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 30
        };

        // ========== DOM ELEMENTS ========== (sin cambios)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImageSpinner = modalImageContainer.querySelector('.spinner');
        const modalImagePlaceholder = modalImageContainer.querySelector('.placeholder-icon');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // --- Variable to hold the current scroll listener ---
        let currentScrollHandler = null;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config) { /* ... (igual que antes) ... */
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0,150)}...`); // Log shorter URL
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s).`);
                 throw new Error(`Error de comunicación con la API. ${error.message}`);
             }
         }
        async function fetchExplanationText(conceptTitle) {
             const text = await fetchTextFromApi(conceptTitle, textApiConfig);
             // Adjust length check for longer text
             if (text.trim().length < 900 || text.toLowerCase().includes("cannot fulfill")) {
                  throw new Error("La IA no pudo generar una explicación suficientemente detallada para este concepto.");
              }
             return text;
         }
        async function fetchGeneratedTitles() { /* ... (igual que antes, usa romanLawThemes) ... */
             const randomTheme = getRandomElement(romanLawThemes) || "conceptos básicos";
             const specificPrompt = `Genera 15 conceptos o preguntas clave sobre ${randomTheme} en Derecho Romano`;
             console.log("Generating concepts with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150); // Allow slightly longer titles
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas de conceptos.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "roman law concept abstract";
             // Updated prompt for Roman Law
             const enhancedPrompt = `Abstract visualization related to the Roman legal or historical concept of '${safePromptText}', classical art style influence, minimalist, focus on structure, order, or justice motifs, ancient scroll texture`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Keep negative prompt strong against text/diagrams
             const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, equations, graphs, charts, diagrams, figures, axes, specific historical figures, specific buildings unless highly abstract, realistic photo, person, people, modern legal symbols, books, computer, handwriting, signature, watermark";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (igual que antes) ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, '<br>');
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (sin cambios en lógica, solo referencias a DOM)
        function showModal() { if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0; // Reset scroll
            console.log("Scroll set to 0 on hideModal");
            if (currentScrollHandler) {
                modalContent.removeEventListener('scroll', currentScrollHandler);
                currentScrollHandler = null;
                console.log("Scroll listener removed on hideModal.");
            }
            resetModalState();
        }
        function resetModalState() {
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent || !modalImage || !modalImageSpinner || !modalImagePlaceholder || !modalImageContainer) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             // ScrollTop reset handled in hideModal and handleTitleClick
             modalImage.src = '';
             modalImage.style.display = 'none';
             modalImageSpinner.style.display = 'none';
             modalImagePlaceholder.style.display = 'none';
             modalImageContainer.classList.remove('visible');
             modalImageContainer.style.display = 'none';
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (sin cambios en lógica)
        function getRandomElement(arr) { /* ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... */
            if (!titleListContainer || !titlesLoading) return;
            const shuffledTitles = shuffleArray([...titles]);
            titleListContainer.innerHTML = '';
            titlesLoading.style.display = 'none';
            if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay conceptos disponibles.</p>'; return; }
            shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        async function handleTitleClick(title) {
             resetModalState();
             showModal();
             modalTitle.textContent = title;
             modalContent.innerHTML = '';
             modalImageContainer.style.display = 'none';
             modalImageContainer.classList.remove('visible');
             modalError.classList.add('content-hidden');
             modalLoadingIndicator.style.display = 'flex'; // Show loading for text

             // Clear previous listener
             if (currentScrollHandler) {
                 modalContent.removeEventListener('scroll', currentScrollHandler);
                 currentScrollHandler = null;
             }

             try {
                 const rawExplanationText = await fetchExplanationText(title);
                 const formattedExplanation = formatExplanationText(rawExplanationText);

                 modalLoadingIndicator.style.display = 'none'; // Hide text loading
                 modalContent.innerHTML = formattedExplanation;
                 modalStoryContentArea.classList.remove('content-hidden');
                 modalContent.scrollTop = 0; // <<<--- RESET SCROLL HERE
                 console.log("Scroll set to 0 after content visible");

                 // Prepare image, container still hidden
                 modalImageSpinner.style.display = 'block';
                 const imageUrl = createPollinationsImageUrl(title);
                  if (imageUrl) {
                      modalImage.onload = () => { modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'none'; modalImage.style.display = 'block'; };
                      modalImage.onerror = () => { console.error("Error loading image:", title); modalImageSpinner.style.display = 'none'; modalImagePlaceholder.style.display = 'block'; modalImage.style.display = 'none'; };
                      modalImage.src = imageUrl;
                  } else {
                      console.error("Could not create image URL:", title);
                      modalImageSpinner.style.display = 'none';
                      modalImagePlaceholder.style.display = 'block';
                  }

                 // Setup scroll listener for image visibility
                 const scrollBuffer = 20; // Adjust if needed
                 currentScrollHandler = () => {
                     if (modalContent.scrollHeight <= modalContent.clientHeight) {
                         console.log("Content fits, showing image immediately.");
                         modalImageContainer.classList.add('visible');
                         modalImageContainer.style.display = 'flex';
                         modalContent.removeEventListener('scroll', currentScrollHandler);
                         currentScrollHandler = null;
                     } else if ((modalContent.scrollTop + modalContent.clientHeight) >= (modalContent.scrollHeight - scrollBuffer)) {
                         console.log("Scroll end reached, showing image.");
                         modalImageContainer.classList.add('visible');
                         modalImageContainer.style.display = 'flex';
                         modalContent.removeEventListener('scroll', currentScrollHandler);
                         currentScrollHandler = null;
                         console.log("Scroll listener removed after showing image.");
                     }
                 };
                 modalContent.addEventListener('scroll', currentScrollHandler);
                 console.log("Scroll listener added.");
                 // Initial check
                 setTimeout(currentScrollHandler, 150); // Longer delay for potentially longer rendering

             } catch (error) {
                 console.error("Failed to display explanation:", error);
                 modalLoadingIndicator.style.display = 'none';
                 modalErrorMessage.textContent = `Error al cargar: ${error.message}`;
                 modalError.classList.remove('content-hidden');
                 modalStoryContentArea.classList.remove('content-hidden');
                 modalImageContainer.style.display = 'none';
                 modalContent.innerHTML = '';
                 if (currentScrollHandler) {
                     modalContent.removeEventListener('scroll', currentScrollHandler);
                     currentScrollHandler = null;
                  }
             }
         }

        async function handleGenerateMoreTitles() { /* ... (igual, usa romanLawThemes) ... */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             // Update loading text
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none'; appendTitles(newTitles);
                     if (titleListContainer.parentNode) { titleListContainer.parentNode.appendChild(generateMoreContainer); }
                     generateMoreContainer.style.display = 'block';
                 } else { alert("No se pudieron generar nuevos principios en este momento."); }
             } catch (error) { console.error("Failed generation:", error); alert(`Error: ${error.message}`);
             } finally { generateMoreBtn.disabled = false; // Update button text
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Principios'; }
         }

        // ========== INITIALIZATION ========== (sin cambios)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p>Error crítico.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>