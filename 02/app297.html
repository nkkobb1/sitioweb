<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo Sobre los Chakras - Guía Energética</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Temáticos Chakras (sin cambios) --- */
        :root {
            --chakra-red: #EF4444; --chakra-orange: #F97316; --chakra-yellow: #EAB308;
            --chakra-green: #22C55E; --chakra-blue: #3B82F6; --chakra-indigo: #6366F1;
            --chakra-violet: #A855F7; --chakra-white: #F8FAFC;
            --color-primary: var(--chakra-indigo); --color-secondary: var(--chakra-green);
            --color-tertiary: var(--chakra-yellow); --color-accent: var(--chakra-violet);
            --color-background: linear-gradient(180deg, #e0e7ff 0%, #f3e8ff 100%);
            --color-text: #374151; --color-text-muted: #6b7280; --color-modal-bg: var(--chakra-white);
            --color-border: #d1d5db; --color-error-bg: #ffefef; --color-error-text: #c81e1e;
            --color-error-border: #fecaca; --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.07); --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
            --border-radius: 10px; --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Open Sans', sans-serif; background: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400; background-attachment: fixed; }
        h1, h2, h3, h4, .logo { font-family: 'Lora', serif; font-weight: 600; }
        .logo { color: var(--color-primary); font-weight: 600; }
        .logo .chakra-swirl { display: inline-block; width: 1em; height: 1em; background: conic-gradient(from 0deg, var(--chakra-red), var(--chakra-orange), var(--chakra-yellow), var(--chakra-green), var(--chakra-blue), var(--chakra-indigo), var(--chakra-violet), var(--chakra-red)); border-radius: 50%; margin-right: 0.5rem; vertical-align: middle; animation: spin 8s linear infinite; }
        h1.page-title { color: var(--color-primary); font-weight: 600; }
        h2.section-title { color: var(--color-secondary); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 600; }
        #modal-title { color: var(--color-accent); font-weight: 600; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(6px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.3rem 0.9rem 3.2rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Open Sans'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1.1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.5rem; }
        .title-item { background: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Open Sans'; font-size: 1rem; position: relative; border-left: 5px solid transparent; }
        .title-item:hover { transform: translateY(-4px) scale(1.01); box-shadow: var(--shadow-lg); border-left-color: var(--color-primary); color: var(--color-primary); background-color: #f9fafb; }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.9rem 1.8rem; border: none; border-radius: 30px; font-family: 'Lora', serif; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(55, 65, 81, 0.9); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border: 1px solid var(--color-border); border-top: 5px solid var(--color-primary); border-radius: var(--border-radius); padding: 1.5rem 2.2rem; max-width: 950px; width: 95%; max-height: 90vh; min-height: 500px; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e5e7eb; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }
        #modal-story-content-area { display: none; flex-grow: 1; min-height: 0; flex-direction: column; }
        #modal-story-content-area.visible { display: flex; }
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem; scrollbar-width: thin; scrollbar-color: var(--color-primary) #e5e7eb; }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: #f3f4f6; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid #f3f4f6; }
        #modal-content { padding: 0 5px; font-size: 1rem; line-height: 1.8; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Lora', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 600;}
        #modal-content h1 { font-size: 1.5em; color: var(--color-accent); }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(209, 213, 219, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-secondary); }
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: var(--color-secondary) #e5e7eb; }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: #f3f4f6; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.7rem 1.1rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.6; box-shadow: var(--shadow-sm); }
        .user-message { background: linear-gradient(to right, var(--color-primary), var(--color-indigo)); color: white; margin-left: auto; text-align: left; font-weight: 600;}
        .ai-message { background-color: var(--color-modal-bg); border: 1px solid var(--color-secondary); color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.8rem 1.1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: 25px; font-family: 'Open Sans'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15); }
        #chat-send-btn { padding: 0.8rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: 50%; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1.1rem; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-secondary); transform: scale(1.1); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; transform: none; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }
        #modal-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(180deg, rgba(224, 231, 255, 0.97) 0%, rgba(243, 232, 255, 0.97) 100%); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); padding: 2rem; color: var(--color-text); text-align: center; }
        #modal-loading.active { display: flex; }
        #chakra-balance-canvas { border: 2px solid var(--color-primary); background-color: #fff; max-width: 90%; max-height: 60%; aspect-ratio: 4 / 3; box-shadow: var(--shadow-md); margin-bottom: 1rem; display: block; cursor: none; }
        #loading-instructions { font-size: 0.95rem; margin-top: 0.5rem; font-family: 'Open Sans'; color: var(--color-text-muted); }
        #loading-score { font-size: 1.6rem; font-family: 'Lora'; margin-top: 0.5rem; color: var(--color-primary); font-weight: 600; }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #e5e7eb; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Open Sans'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: #f3f4f6; color: var(--color-primary); transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <span class="chakra-swirl"></span>
                     Guía de Chakras
                 </h1>
             </div>
             <span class="text-md text-gray-600 font-semibold font-sans tracking-wide">» Equilibrio y Bienestar Energético «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora Tus Centros Energéticos</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre el fascinante mundo de los chakras: su significado, cómo equilibrarlos y su impacto en tu vida diaria.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar (Ej: Chakra Raíz, Meditación, Cristales, Aura...)">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-om text-indigo-500 mr-2"></i>
                 Temas de Exploración
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Sintonizando con la energía...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron temas para tu búsqueda energética «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar 40 Nuevos Temas
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Balancing Minigame -->
             <div id="modal-loading">
                 <canvas id="chakra-balance-canvas" width="400" height="300">Tu navegador no soporta Canvas.</canvas>
                 <p id="loading-instructions">¡Equilibra la energía! Usa el ratón para nivelar la barra.</p>
                 <p id="loading-score">Equilibrio: Estable | Nivel: 1</p>
                 <div class="loading-spinner-modal content-hidden"></div>
             </div>

             <!-- Content Area Wrapper (Initially Hidden) -->
             <div id="modal-story-content-area">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando sabiduría...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Profundiza aquí... (Ej: ¿Cómo afecta esto?)">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-white text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información generada por IA sobre sistemas de chakras con fines educativos y de exploración personal.</p>
              <p class="mt-1">Esta guía no sustituye el consejo médico o terapéutico profesional.</p>
              <p class="mt-2">© 2025 Guía Energética Holística</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [ /* ... (lista larga de títulos de chakras) ... */
             // Conceptos Fundamentales
            "¿Qué son los Chakras?", "Origen e Historia de los Sistemas de Chakras (India Antigua)", "Los 7 Chakras Principales: Una Visión General", "El Flujo de Energía (Prana/Chi) a Través de los Chakras", "La Relación entre Chakras y el Cuerpo Sutil (Aura)", "Nadis: Los Canales Energéticos (Ida, Pingala, Sushumna)", "Kundalini: La Energía Serpiente y su Despertar", "Diferencias entre Sistemas de Chakras Orientales y Occidentales", "Mitos y Malentendidos Comunes sobre los Chakras", "Perspectiva Científica (o ausencia de) sobre los Chakras",
             // Chakra Raíz (Muladhara)
            "Chakra Raíz: Ubicación y Significado (Supervivencia, Seguridad)", "Color Rojo: Simbolismo del Chakra Raíz", "Elemento Tierra: Conexión a Tierra y Estabilidad", "Funciones Físicas Asociadas al Chakra Raíz", "Desequilibrios del Chakra Raíz (Miedo, Inseguridad, Problemas Financieros)", "Síntomas de un Chakra Raíz Bloqueado", "Síntomas de un Chakra Raíz Hiperactivo", "Técnicas para Equilibrar el Chakra Raíz", "Meditación para el Chakra Raíz", "Afirmaciones Positivas para Muladhara", "Cristales para el Chakra Raíz (Jaspe Rojo, Turmalina Negra, Hematita)", "Aceites Esenciales para el Chakra Raíz (Cedro, Pachulí, Vetiver)", "Alimentos que Apoyan el Chakra Raíz", "Posturas de Yoga para el Chakra Raíz (Postura de la Montaña, Guerrero I)", "Sonido y Mantra del Chakra Raíz (LAM)",
             // Chakra Sacro (Svadhisthana)
            "Chakra Sacro: Ubicación y Significado (Creatividad, Emociones, Sexualidad)", "Color Naranja: Simbolismo del Chakra Sacro", "Elemento Agua: Fluidez Emocional y Creativa", "Funciones Físicas Asociadas al Chakra Sacro", "Desequilibrios del Chakra Sacro (Bloqueo Creativo, Culpa, Dependencia)", "Síntomas de un Chakra Sacro Bloqueado", "Síntomas de un Chakra Sacro Hiperactivo", "Técnicas para Equilibrar el Chakra Sacro", "Meditación para el Chakra Sacro", "Afirmaciones Positivas para Svadhisthana", "Cristales para el Chakra Sacro (Cornalina, Piedra Lunar, Calcita Naranja)", "Aceites Esenciales para el Chakra Sacro (Ylang-Ylang, Naranja Dulce, Sándalo)", "Alimentos que Apoyan el Chakra Sacro", "Posturas de Yoga para el Chakra Sacro (Postura de la Diosa, Postura del Ángulo Atado)", "Sonido y Mantra del Chakra Sacro (VAM)",
             // Chakra Plexo Solar (Manipura)
            "Chakra Plexo Solar: Ubicación y Significado (Poder Personal, Autoestima)", "Color Amarillo: Simbolismo del Plexo Solar", "Elemento Fuego: Transformación y Voluntad", "Funciones Físicas Asociadas al Plexo Solar", "Desequilibrios del Plexo Solar (Baja Autoestima, Ira, Falta de Control)", "Síntomas de un Plexo Solar Bloqueado", "Síntomas de un Plexo Solar Hiperactivo", "Técnicas para Equilibrar el Plexo Solar", "Meditación para el Plexo Solar", "Afirmaciones Positivas para Manipura", "Cristales para el Plexo Solar (Citrino, Ojo de Tigre, Pirita)", "Aceites Esenciales para el Plexo Solar (Limón, Jengibre, Menta)", "Alimentos que Apoyan el Plexo Solar", "Posturas de Yoga para el Plexo Solar (Postura del Barco, Torsiones)", "Sonido y Mantra del Plexo Solar (RAM)",
             // Chakra Corazón (Anahata)
            "Chakra Corazón: Ubicación y Significado (Amor, Compasión, Conexión)", "Color Verde (y Rosa): Simbolismo del Chakra Corazón", "Elemento Aire: Expansión y Libertad", "Funciones Físicas Asociadas al Chakra Corazón", "Desequilibrios del Chakra Corazón (Tristeza, Soledad, Celos, Dificultad para Perdonar)", "Síntomas de un Chakra Corazón Bloqueado", "Síntomas de un Chakra Corazón Hiperactivo", "Técnicas para Equilibrar el Chakra Corazón", "Meditación para el Chakra Corazón (Metta)", "Afirmaciones Positivas para Anahata", "Cristales para el Chakra Corazón (Cuarzo Rosa, Aventurina Verde, Esmeralda)", "Aceites Esenciales para el Chakra Corazón (Rosa, Bergamota, Geranio)", "Alimentos que Apoyan el Chakra Corazón", "Posturas de Yoga para el Chakra Corazón (Postura del Camello, Postura de la Cobra)", "Sonido y Mantra del Chakra Corazón (YAM)",
             // Chakra Garganta (Vishuddha)
            "Chakra Garganta: Ubicación y Significado (Comunicación, Autoexpresión, Verdad)", "Color Azul Claro: Simbolismo del Chakra Garganta", "Elemento Éter/Espacio: Sonido y Vibración", "Funciones Físicas Asociadas al Chakra Garganta", "Desequilibrios del Chakra Garganta (Miedo a Hablar, Timidez, Chismes)", "Síntomas de un Chakra Garganta Bloqueado", "Síntomas de un Chakra Garganta Hiperactivo", "Técnicas para Equilibrar el Chakra Garganta", "Meditación para el Chakra Garganta", "Afirmaciones Positivas para Vishuddha", "Cristales para el Chakra Garganta (Aguamarina, Lapislázuli, Sodalita)", "Aceites Esenciales para el Chakra Garganta (Eucalipto, Manzanilla Romana, Menta)", "Alimentos que Apoyan el Chakra Garganta", "Posturas de Yoga para el Chakra Garganta (Postura del Pez, Postura del Arado)", "Sonido y Mantra del Chakra Garganta (HAM)",
             // Chakra Tercer Ojo (Ajna)
            "Chakra Tercer Ojo: Ubicación y Significado (Intuición, Sabiduría, Percepción)", "Color Índigo: Simbolismo del Tercer Ojo", "Elemento Luz: Clarity y Visión Interior", "Funciones Físicas Asociadas al Tercer Ojo (Glándula Pineal)", "Desequilibrios del Tercer Ojo (Confusión Mental, Falta de Visión, Pesadillas)", "Síntomas de un Tercer Ojo Bloqueado", "Síntomas de un Tercer Ojo Hiperactivo", "Técnicas para Equilibrar el Tercer Ojo", "Meditación para el Tercer Ojo (Trataka)", "Afirmaciones Positivas para Ajna", "Cristales para el Tercer Ojo (Amatista, Fluorita, Lapislázuli)", "Aceites Esenciales para el Tercer Ojo (Incienso, Lavanda, Romero)", "Alimentos que Apoyan el Tercer Ojo", "Posturas de Yoga para el Tercer Ojo (Postura del Niño, Meditación Sentada)", "Sonido y Mantra del Tercer Ojo (OM o AUM)",
             // Chakra Corona (Sahasrara)
            "Chakra Corona: Ubicación y Significado (Conexión Espiritual, Unidad)", "Color Violeta o Blanco: Simbolismo del Chakra Corona", "Elemento Pensamiento/Consciencia Cósmica", "Funciones Físicas Asociadas al Chakra Corona (Glándula Pituitaria)", "Desequilibrios del Chakra Corona (Desconexión Espiritual, Cinismo, Depresión)", "Síntomas de un Chakra Corona Bloqueado", "Síntomas de un Chakra Corona Hiperactivo", "Técnicas para Equilibrar el Chakra Corona", "Meditación para el Chakra Corona (Silencio, Consciencia Pura)", "Afirmaciones Positivas para Sahasrara", "Cristales para el Chakra Corona (Cuarzo Claro, Selenita, Amatista)", "Aceites Esenciales para el Chakra Corona (Incienso, Loto, Lavanda)", "Alimentos que Apoyan el Chakra Corona (Ayuno Ligero, Alimentos Puros)", "Posturas de Yoga para el Chakra Corona (Savasana, Parada de Cabeza - con precaución)", "Sonido y Mantra del Chakra Corona (Silencio o OM)",
            // Temas Avanzados y Complementarios
            "Limpieza y Carga Energética de Chakras", "Cómo Sentir la Energía de tus Chakras", "Test de Chakras: Identificando Desequilibrios", "El Aura Humana y sus Capas", "Conexión entre Chakras y Colores del Aura", "Chakras Secundarios y Menores (Manos, Pies, etc.)", "Reiki y Sanación de Chakras", "Sanación con Sonido: Cuencos Tibetanos y Diapasones", "Cristaloterapia para la Armonización de Chakras", "Aromaterapia y Chakras: Sinergias", "Yoga Terapéutico Enfocado en Chakras", "El Papel de la Respiración (Pranayama) en el Equilibrio de Chakras", "Dieta y Nutrición para la Salud Energética", "Relación entre Emociones y Bloqueos de Chakras", "Chakras y Desarrollo Espiritual", "Integración de la Sabiduría de los Chakras en la Vida Diaria", "Visualizaciones Guiadas para Cada Chakra", "Mandala de Chakras: Significado y Uso", "Mudras para Activar los Chakras", "El Sistema de Chakras en Otras Culturas", "Equilibrio Masculino/Femenino (Ida/Pingala) y Chakras", "Chakras y Ley de Atracción", "Protección Energética y Límites Saludables", "Cómo Equilibrar los Chakras de Mascotas", "Chakras y Ciclos Lunares", "Interpretación de Sueños y Mensajes de los Chakras",
        ];
        const chakraThemes = [ "Chakra Raíz", "Chakra Sacro", "Chakra Plexo Solar", "Chakra Corazón", "Chakra Garganta", "Chakra Tercer Ojo", "Chakra Corona", "Equilibrio de Chakras", "Meditación de Chakras", "Yoga para Chakras", "Cristales y Chakras", "Aceites Esenciales y Chakras", "Sonido y Chakras", "Mantras de Chakras", "Aura y Chakras", "Energía Kundalini", "Nadis y Prana", "Bloqueos Energéticos", "Sanación Energética", "Reiki", "Desarrollo Espiritual", "Conexión a Tierra", "Creatividad y Emociones", "Poder Personal", "Amor y Compasión", "Comunicación Auténtica", "Intuición y Sabiduría", "Conexión Universal", "Chakras Menores", "Dieta Energética", "Afirmaciones Positivas", "Visualización Guiada" ];
        const textApiConfig = { model: "mistral", systemPrompt: "Eres una guía experta, compasiva y clara sobre el sistema de chakras y prácticas de bienestar energético. Tu propósito es explicar conceptos relacionados con los chakras de manera accesible, informativa y equilibrada. Describe el tema solicitado (chakra específico, técnica, concepto) detallando su significado, función, posibles desequilibrios y métodos para armonizarlo. Utiliza un lenguaje inspirador pero práctico. Evita afirmaciones médicas no comprobadas, enfocándote en el bienestar energético y espiritual según las tradiciones que los describen. Proporciona una explicación detallada de aproximadamente 1200-1300 palabras basada *únicamente* en el siguiente tema:", timeoutSeconds: 150 };
        const chatApiConfig = { model: "mistral-tiny", systemPrompt: "Actúa como un asistente de diálogo reflexivo sobre el tema de chakras que se está mostrando. Responde preguntas de seguimiento sobre detalles específicos, aplicaciones prácticas o conexiones con otros conceptos mencionados en la explicación principal *de ese tema*. Fomenta la exploración personal pero recuerda no dar consejos médicos. Mantén un tono calmado y centrado.", timeoutSeconds: 50 };
        const titleGenerationConfig = { model: "mistral", systemPrompt: "Eres un generador de ideas para una guía completa sobre chakras. Genera exactamente 40 títulos específicos y relevantes que cubran chakras individuales, técnicas de equilibrio, conceptos energéticos y temas relacionados. Devuelve *solo* la lista de títulos, uno por línea, sin números, guiones, introducciones ni conclusiones.", timeoutSeconds: 60 };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input'); const titleListContainer = document.getElementById('title-list'); const titlesLoading = document.getElementById('titles-loading'); const noResultsMsg = document.getElementById('no-results'); const generateMoreContainer = document.getElementById('generate-more-container'); const generateMoreBtn = document.getElementById('generate-more-btn'); const generateMoreSpinner = generateMoreBtn.querySelector('i'); const storyModal = document.getElementById('story-modal'); const modalCloseBtn = document.getElementById('modal-close'); const modalLoadingIndicator = document.getElementById('modal-loading'); const modalStoryContentArea = document.getElementById('modal-story-content-area'); const modalTextArea = document.getElementById('modal-content-area'); const modalTitle = document.getElementById('modal-title'); const modalContent = document.getElementById('modal-content'); const modalError = document.getElementById('modal-error'); const modalErrorMessage = document.getElementById('modal-error-message'); const chatSection = document.getElementById('chat-section'); const chatHistory = document.getElementById('chat-history'); const chatInput = document.getElementById('chat-input'); const chatSendBtn = document.getElementById('chat-send-btn'); const chatLoadingIndicator = document.getElementById('chat-loading'); const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay'); const fullscreenImage = document.getElementById('fullscreen-image'); const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn'); const balanceCanvas = document.getElementById('chakra-balance-canvas'); const balanceCtx = balanceCanvas.getContext('2d'); const balanceInstructions = document.getElementById('loading-instructions'); const balanceScoreDisplay = document.getElementById('loading-score');

        // ========== State Variables ==========
        let currentChakraTopic = null; let balanceGameLoopId = null; let isBalanceGameRunning = false; let mouseX = balanceCanvas.width / 2;

        // ========== BALANCE MINIGAME VARIABLES & LOGIC ==========
        const CHAKRA_COLORS_JS = { red: '#EF4444', orange: '#F97316', yellow: '#EAB308', green: '#22C55E', blue: '#3B82F6', indigo: '#6366F1', violet: '#A855F7', white: '#FFFFFF', grey: '#6B7280' };
        const chakraColorArray = Object.values(CHAKRA_COLORS_JS).slice(0, 7);
        const balanceConfig = { barWidth: 250, barHeight: 15, barColor: CHAKRA_COLORS_JS.indigo, pivotY: balanceCanvas.height * 0.75, maxAngle: Math.PI / 4, gravity: 0.005, mouseSensitivity: 0.001, damping: 0.98, orbSize: 8, orbSpawnRate: 0.03, orbFallSpeed: 1.5, orbWeightMultiplier: 0.01, scoreMultiplier: 10, levelUpTime: 15000, maxOrbSpawnRateIncrease: 0.005, maxOrbWeightIncrease: 0.002 };
        let balanceBar = { angle: 0, angularVelocity: 0 }; let fallingOrbs = []; let balanceScore = 0; let balanceLevel = 1; let timeElapsed = 0; let lastTimestamp = 0; let currentOrbSpawnRate = balanceConfig.orbSpawnRate; let currentOrbWeight = balanceConfig.orbWeightMultiplier;

        function resetBalanceGame() { balanceBar.angle = 0; balanceBar.angularVelocity = 0; fallingOrbs = []; balanceScore = 0; balanceLevel = 1; timeElapsed = 0; lastTimestamp = 0; currentOrbSpawnRate = balanceConfig.orbSpawnRate; currentOrbWeight = balanceConfig.orbWeightMultiplier; mouseX = balanceCanvas.width / 2; balanceScoreDisplay.textContent = `Equilibrio: Estable | Nivel: 1`; console.log("Balance Game Reset"); }
        function handleMouseMove(e) { if (!isBalanceGameRunning) return; const rect = balanceCanvas.getBoundingClientRect(); mouseX = e.clientX - rect.left; }

        // *** CORRECTED updateBalanceGame ***
        function updateBalanceGame(timestamp) {
            if (!isBalanceGameRunning) return;
            if (!lastTimestamp) lastTimestamp = timestamp;
            const deltaTime = timestamp - lastTimestamp;
            lastTimestamp = timestamp;
             if (deltaTime <= 0 || deltaTime > 100) { // Skip frame if delta is weird (e.g., tab hidden)
                 console.warn("Skipping frame due to deltaTime:", deltaTime);
                 balanceGameLoopId = requestAnimationFrame(balanceGameLoop); // Reschedule immediately
                 return;
            }
            timeElapsed += deltaTime;

            const pivotX = balanceCanvas.width / 2;
            let totalOrbTorqueThisFrame = 0;

            // --- Orb Collision Check & Torque Calculation ---
            fallingOrbs.forEach(orb => {
                if (orb.markedForRemoval) return;

                const orbDistFromPivotX = orb.x - pivotX;
                const barYAtOrbX = balanceConfig.pivotY - Math.sin(balanceBar.angle) * orbDistFromPivotX;
                const barHalfWidth = balanceConfig.barWidth / 2;
                const cosAngle = Math.cos(balanceBar.angle);
                const barXStart = pivotX - barHalfWidth * cosAngle;
                const barXEnd = pivotX + barHalfWidth * cosAngle;

                // Collision Check (Simplified: check orb center against bar thickness/span)
                const barTop = barYAtOrbX - balanceConfig.barHeight / 2;
                const barBottom = barYAtOrbX + balanceConfig.barHeight / 2;
                const isYOverlapping = orb.y >= barTop && orb.y <= barBottom; // Check orb center Y
                const isXAligned = orb.x >= barXStart && orb.x <= barXEnd; // Check orb center X

                if (isYOverlapping && isXAligned) {
                    // console.log("Collision detected!", orb); // Keep for debugging if needed
                    const torque = (orbDistFromPivotX / barHalfWidth) * orb.weight;
                    totalOrbTorqueThisFrame += torque;
                    orb.markedForRemoval = true;
                }
            });

            // --- Physics Update ---
            const mouseOffset = (mouseX - pivotX) / (pivotX || 1); // Avoid division by zero if pivotX is 0 initially
            const mouseForce = mouseOffset * balanceConfig.mouseSensitivity;
            const gravityForce = -Math.sin(balanceBar.angle) * balanceConfig.gravity;
            balanceBar.angularVelocity += (mouseForce + gravityForce + totalOrbTorqueThisFrame) * (deltaTime / 16.67); // Approx 60fps normalization
            balanceBar.angularVelocity *= Math.pow(balanceConfig.damping, deltaTime / 16.67); // Time-corrected damping
            balanceBar.angle += balanceBar.angularVelocity * (deltaTime / 16.67);
            balanceBar.angle = Math.max(-balanceConfig.maxAngle, Math.min(balanceConfig.maxAngle, balanceBar.angle));

            // --- Orb Spawning & Movement ---
            if (Math.random() < currentOrbSpawnRate * (deltaTime / 16.67)) {
                fallingOrbs.push({ x: Math.random() * balanceCanvas.width, y: -balanceConfig.orbSize, weight: currentOrbWeight * (Math.random() * 0.5 + 0.75), color: chakraColorArray[Math.floor(Math.random() * chakraColorArray.length)], markedForRemoval: false });
            }
            fallingOrbs.forEach(orb => { if (!orb.markedForRemoval) { orb.y += balanceConfig.orbFallSpeed * (deltaTime / 16.67); } });

            // --- Clean up Orbs ---
            fallingOrbs = fallingOrbs.filter(orb => !orb.markedForRemoval && orb.y <= balanceCanvas.height + balanceConfig.orbSize * 2); // Extended cleanup range

            // --- Score & Level Update ---
            const balanceFactor = 1 - Math.abs(balanceBar.angle / balanceConfig.maxAngle);
            balanceScore += balanceFactor * balanceConfig.scoreMultiplier * (deltaTime / 1000);
            const balanceStatus = balanceFactor > 0.95 ? "Perfecto" : balanceFactor > 0.7 ? "Estable" : balanceFactor > 0.4 ? "Inestable" : "Crítico";
            balanceScoreDisplay.textContent = `Equilibrio: ${balanceStatus} | Nivel: ${balanceLevel}`;

            if (timeElapsed >= balanceLevel * balanceConfig.levelUpTime) {
                balanceLevel++;
                currentOrbSpawnRate = Math.min(balanceConfig.orbSpawnRate * 3, balanceConfig.orbSpawnRate + (balanceLevel - 1) * balanceConfig.maxOrbSpawnRateIncrease);
                currentOrbWeight = Math.min(balanceConfig.orbWeightMultiplier * 3, balanceConfig.orbWeightMultiplier + (balanceLevel - 1) * balanceConfig.maxOrbWeightIncrease);
                console.log(`Level Up! Level: ${balanceLevel}, SpawnRate: ${currentOrbSpawnRate.toFixed(4)}, Weight: ${currentOrbWeight.toFixed(4)}`);
                balanceCanvas.style.boxShadow = `0 0 15px ${chakraColorArray[balanceLevel % chakraColorArray.length]}`;
                setTimeout(() => { balanceCanvas.style.boxShadow = 'var(--shadow-md)'; }, 500);
            }
        }
        // *** END CORRECTED updateBalanceGame ***


        function drawBalanceGame() {
            if (!isBalanceGameRunning || !balanceCtx) return;
            try {
                balanceCtx.clearRect(0, 0, balanceCanvas.width, balanceCanvas.height);
                const gradBg = balanceCtx.createLinearGradient(0, 0, 0, balanceCanvas.height);
                gradBg.addColorStop(0, '#f0f2f5'); gradBg.addColorStop(1, '#e6e9ed');
                balanceCtx.fillStyle = gradBg; balanceCtx.fillRect(0, 0, balanceCanvas.width, balanceCanvas.height);

                fallingOrbs.forEach(orb => {
                    balanceCtx.fillStyle = orb.color; balanceCtx.beginPath();
                    balanceCtx.arc(orb.x, orb.y, balanceConfig.orbSize, 0, Math.PI * 2); balanceCtx.fill();
                });

                balanceCtx.save();
                balanceCtx.translate(balanceCanvas.width / 2, balanceConfig.pivotY);
                balanceCtx.rotate(balanceBar.angle);
                const barGrad = balanceCtx.createLinearGradient(-balanceConfig.barWidth / 2, 0, balanceConfig.barWidth / 2, 0);
                barGrad.addColorStop(0, CHAKRA_COLORS_JS.violet); barGrad.addColorStop(0.5, CHAKRA_COLORS_JS.blue); barGrad.addColorStop(1, CHAKRA_COLORS_JS.green);
                balanceCtx.fillStyle = barGrad; balanceCtx.fillRect(-balanceConfig.barWidth / 2, -balanceConfig.barHeight / 2, balanceConfig.barWidth, balanceConfig.barHeight);
                balanceCtx.fillStyle = CHAKRA_COLORS_JS.grey; balanceCtx.beginPath();
                balanceCtx.arc(0, 0, 5, 0, Math.PI * 2); balanceCtx.fill();
                balanceCtx.restore();
            } catch (e) { console.error("Error during drawing:", e); stopBalanceGame(); }
        }

        function balanceGameLoop(timestamp) { if (!isBalanceGameRunning) return; updateBalanceGame(timestamp); drawBalanceGame(); balanceGameLoopId = requestAnimationFrame(balanceGameLoop); }
        function startBalanceGame() { if (isBalanceGameRunning || !balanceCtx) { console.warn("Cannot start game. Running:", isBalanceGameRunning, "Context:", balanceCtx); return; } console.log("Starting Balance Game Loop..."); isBalanceGameRunning = true; resetBalanceGame(); balanceCanvas.addEventListener('mousemove', handleMouseMove); balanceCanvas.addEventListener('touchmove', (e) => { if (e.touches.length > 0) { handleMouseMove(e.touches[0]); e.preventDefault(); } }, { passive: false }); lastTimestamp = performance.now(); balanceGameLoopId = requestAnimationFrame(balanceGameLoop); modalLoadingIndicator.classList.add('active'); balanceCanvas.style.display = 'block'; console.log("Game loop requested with ID:", balanceGameLoopId); }
        function stopBalanceGame() { if (!isBalanceGameRunning) return; console.log("Stopping Balance Game Loop"); isBalanceGameRunning = false; if (balanceGameLoopId) { cancelAnimationFrame(balanceGameLoopId); balanceGameLoopId = null; } balanceCanvas.removeEventListener('mousemove', handleMouseMove); balanceCanvas.removeEventListener('touchmove', handleMouseMove); }

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) { const encodedPrompt = encodeURIComponent(prompt); const systemPromptToUse = isChat && currentChakraTopic ? `Eres un asistente de diálogo reflexivo sobre '${currentChakraTopic}'. Responde preguntas de seguimiento sobre detalles específicos, aplicaciones prácticas o conexiones mencionadas en la explicación principal *de ese tema*. Mantén un tono calmado.` : config.systemPrompt; const encodedSystem = encodeURIComponent(systemPromptToUse); const params = new URLSearchParams({ model: config.model, system: encodedSystem }); if (config.seed && !isChat) params.append('seed', config.seed); const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`; console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`); const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000); try { const response = await fetch(url, { signal: controller.signal }); clearTimeout(timeoutId); if (!response.ok) { throw new Error(`(Error ${response.status}) Nuestros servidores energéticos están un poco congestionados. Por favor, respira e intenta de nuevo en unos momentos.`); } const text = await response.text(); if (!text || text.trim().length < (isChat ? 10 : 500)) { throw new Error("La respuesta de la IA fue demasiado breve o no llegó. Intenta reconectar o elige otro tema."); } console.log(`API Response received (${text.length} chars)`); return text; } catch (error) { clearTimeout(timeoutId); console.error("API Fetch Error:", error); if (error.name === 'AbortError') { throw new Error(`La conexión energética tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde con calma.`); } throw new Error(error.message || "Ocurrió una desconexión inesperada con la fuente de información."); } }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentChakraTopic) throw new Error("Error interno: Contexto del chakra no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() { const randomTheme = getRandomElement(chakraThemes) || "equilibrio de chakras"; const specificPrompt = `Genera 40 títulos de temas específicos sobre ${randomTheme} y el sistema de chakras`; console.log("Generating 40 titles with prompt:", specificPrompt); const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) }; return fetchTextFromApi(specificPrompt, configForThisRequest, false).then(text => { const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 8 && line.length < 180 && !/^\s*$/.test(line) && !/generando|lista|ideas|aquí/i.test(line)).slice(0, 40); if (titles.length < 15) { throw new Error("La IA no generó suficientes temas válidos sobre chakras."); } return titles; }); }
        function createPollinationsImageUrl(promptText, options = {}) { const defaults = { seed: Math.floor(Math.random() * 10000000), width: 896, height: 896, nologo: true }; const settings = { ...defaults, ...options }; const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "abstract chakra energy flow"; const enhancedPrompt = `Abstract spiritual concept art, ethereal, vibrant colors representing '${safePromptText}'. Flowing energy, sacred geometry elements (lotus, mandala hints), light effects. Serene, balanced composition.`; const escapedPrompt = encodeURIComponent(enhancedPrompt); if (!escapedPrompt) return ''; const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, human figure, realistic, photograph, blurry, low quality, watermark, signature, cluttered"; const escapedNegative = encodeURIComponent(negativePrompt); let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`; if (settings.nologo) url += '&nologo=true'; console.log("Image URL:", url); return url; }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText){ if(!rawText)return'';let formatted=rawText.trim();formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1');formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('−','-');return`${base}<sup>${cleanExponent}</sup>`;});formatted=formatted.replace(/\\rightarrow/g,'&rarr;');formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>');const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0);formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block;let content=block.replace(/\n/g,' ');return`<p>${content}</p>`;}).join('');return formatted;}

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { stopBalanceGame(); storyModal.classList.remove('active'); if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; } modalTextArea.scrollTop = 0; resetModalState(); }
        function resetModalState() { stopBalanceGame(); modalLoadingIndicator.classList.remove('active'); modalStoryContentArea.classList.remove('visible'); modalStoryContentArea.classList.add('content-hidden'); modalError.classList.add('content-hidden'); modalTitle.textContent = ''; modalContent.innerHTML = ''; modalErrorMessage.textContent = ''; chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; currentChakraTopic = null; hideFullscreenImage(); }

        // ========== FULLSCREEN IMAGE FUNCTIONS ==========
        function showFullscreenImage(imgSrc){if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden';}
        function hideFullscreenImage(){if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src='';}

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender) { const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        function addChatError(message){ const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        async function handleSendMessage(){const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Error IA: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}}

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title) { const div=document.createElement('div');div.className='title-item';div.textContent=title;div.setAttribute('data-title',title);div.addEventListener('click',()=>handleTitleClick(title));return div; }
        function displayTitles(titles) { if (!titleListContainer || !titlesLoading) return; const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none'; if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay temas energéticos disponibles. ¡Intenta generar más! «</p>'; return; } sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); console.log(`Displayed ${sortedTitles.length} titles.`); }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; console.log(`Appending ${newTitles.length} new chakra topics.`); const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title)); let addedCount = 0; newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } }); console.log(`Successfully added ${addedCount} unique topics.`); filterTitles(searchInput.value); }

        async function handleTitleClick(title) {
            resetModalState(); showModal();
            modalTitle.textContent = title; currentChakraTopic = title; chatHistory.innerHTML = '';
            modalLoadingIndicator.classList.add('active'); // Show loading first
            startBalanceGame(); // Then start game
            try {
                const explanationPromise = fetchExplanationText(title);
                const imageUrl = createPollinationsImageUrl(title);
                const rawExplanationText = await explanationPromise; // Wait for text
                stopBalanceGame(); // Stop game *before* swapping views
                modalLoadingIndicator.classList.remove('active'); // Hide loading
                modalStoryContentArea.classList.add('visible'); modalStoryContentArea.classList.remove('content-hidden'); // Show content area
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalContent.innerHTML = formattedExplanation; modalTextArea.scrollTop = 0;
                const placeholderDiv = document.createElement('div'); placeholderDiv.className = 'image-placeholder'; placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Visualizando energía...</p>`; modalContent.appendChild(placeholderDiv);
                if (imageUrl) { const imgElement = document.createElement('img'); imgElement.className = 'final-image'; imgElement.alt = `Visualización de ${title}`; imgElement.style.display = 'none'; imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); }; imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al visualizar.</p>`; }; imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo generar URL.</p>`; }
            } catch (error) {
                console.error("Failed display:", error); stopBalanceGame(); modalLoadingIndicator.classList.remove('active'); modalStoryContentArea.classList.add('visible'); modalStoryContentArea.classList.remove('content-hidden'); modalErrorMessage.textContent = error.message || "Error desconocido al cargar el tema."; modalError.classList.remove('content-hidden'); modalContent.innerHTML = ''; chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() { if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return; generateMoreBtn.disabled = true; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Canalizando Nuevos Temas...'; try { const newTitles = await fetchGeneratedTitles(); if (newTitles && newTitles.length > 0) { appendTitles(newTitles); } else { alert("No se pudieron canalizar más temas en este momento."); } } catch (error) { console.error("Failed title generation:", error); alert(`Error al generar temas: ${error.message}`); } finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar 40 Nuevos Temas'; } }
        function filterTitles(searchTerm) { const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); const titleItems = titleListContainer.querySelectorAll('.title-item'); let visibleCount = 0; titleItems.forEach(item => { const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const isVisible = titleText.includes(term); item.classList.toggle('hidden', !isVisible); if (isVisible) visibleCount++; }); noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleListContainer.children.length === 0 || (titleListContainer.children.length === 1 && titleListContainer.children[0].id === 'titles-loading')); }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !balanceCanvas || !balanceCtx || !balanceScoreDisplay) { console.error("Initialization failed: Missing essential elements. balanceCtx:", balanceCtx); document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error de inicialización: Faltan componentes energéticos.</p>'; return; }
            modalCloseBtn.addEventListener('click', hideModal); storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); }); generateMoreBtn.addEventListener('click', handleGenerateMoreTitles); searchInput.addEventListener('input', (event) => filterTitles(event.target.value)); searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); }); chatSendBtn.addEventListener('click', handleSendMessage); chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); }); imageFullscreenOverlay.addEventListener('click', hideFullscreenImage); fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            displayTitles(predefinedTitles); noResultsMsg.classList.add('hidden'); console.log("Chakra App Initialized Successfully. Canvas context obtained.");
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>