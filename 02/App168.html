<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatos del Inconsciente - Exploración Junguiana</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Elegantes/Clásicas -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Nunito+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Cuentos Junguianos --- */
        :root {
            --color-primary: #b8860b; /* Dorado Oscuro (Self, Oro Alquímico) */
            --color-secondary: #483d8b; /* Azul Pizarra Oscuro (Inconsciente, Misterio) */
            --color-tertiary: #8fbc8f; /* Verde Mar Oscuro (Naturaleza, Crecimiento) */
            --color-background: #fdfdfd; /* Blanco Roto / Crema muy claro */
            --color-text: #3a3a3a; /* Gris Oscuro Cálido */
            --color-text-muted: #708090; /* Gris Pizarra */
            --color-modal-bg: #ffffff; /* Blanco para claridad */
            --color-border: #dcdcdc; /* Borde Gris Claro */
            --color-error-bg: #fff0f1; /* Fondo error rosa pálido */
            --color-error-text: #a0522d; /* Texto error siena */
            --color-error-border: #f08080; /* Borde error coral claro */

            --shadow-sm: 0 2px 4px 0 rgba(100, 100, 100, 0.08);
            --shadow-md: 0 4px 8px -1px rgba(80, 80, 80, 0.1), 0 2px 4px -2px rgba(80, 80, 80, 0.08);
            --shadow-lg: 0 10px 20px -5px rgba(60, 60, 60, 0.15), 0 8px 10px -6px rgba(60, 60, 60, 0.1);
            --border-radius: 5px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Nunito Sans', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-secondary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-secondary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Nunito Sans'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(184, 134, 11, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Nunito Sans'; font-size: 0.95rem; line-height: 1.4; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #fffaf0; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #a0720a; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #ccc; color: #888; cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(72, 61, 139, 0.85); /* Overlay Azul Pizarra */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.8rem 2.2rem;
            max-width: 950px; width: 95%; max-height: 90vh; min-height: 450px;
            overflow: hidden; position: relative; box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #eee; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.4; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid #f0f0f0; }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 700; }
        #modal-content h1 { font-size: 1.45em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.18em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; font-weight: 400;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.8rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 160px; margin: 2.8rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(220, 220, 220, 0.8); width: 38px; height: 38px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1.1s linear infinite; margin-bottom: 0.7rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.8rem; } /* Icono más grande */

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1.2rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 260px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9f9f9; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) #eee;
        }
        #chat-history::-webkit-scrollbar { width: 7px; }
        #chat-history::-webkit-scrollbar-track { background: #eee; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; font-size: 0.95rem; }
        .user-message { background-color: var(--color-tertiary); color: #fff; margin-left: auto; text-align: left; font-weight: 400; }
        .ai-message { background-color: #eef; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.3rem; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Nunito Sans'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #a0720a; }
        #chat-send-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-style: italic;}
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid #eee; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.3s linear infinite; margin: 0 auto 1.8rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-secondary); font-size: 1.4rem; font-family: 'Merriweather'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Nunito Sans'; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 1px solid var(--color-border); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-mask mr-3"></i> <!-- Icono máscara (Persona) -->
                     Relatos del Inconsciente
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">~ Exploración Junguiana ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Viajes a través del Símbolo</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre narrativas ficticias que exploran los arquetipos, la sombra, los sueños y el camino de la individuación. Elige un título o busca un concepto.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar arquetipo, concepto o título...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-yellow-700 mr-2"></i> <!-- Icono libro abierto -->
                 Archivo de Cuentos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Accediendo al Inconsciente Colectivo...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">~ Ningún relato encontrado para esa resonancia simbólica ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Invocar Nuevos Relatos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Tejiendo el Hilo del Relato...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <h3 class="text-lg font-semibold mb-2 text-center text-gray-700 font-serif">Explora los Símbolos:</h3>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando al oráculo interior...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre el significado o los personajes...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Simbólica Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Relatos generados por IA, inspirados libremente en conceptos de la psicología analítica de Carl Jung.</p>
              <p class="mt-1">Estas historias son ficción con fines de exploración simbólica y entretenimiento.</p>
              <p class="mt-2">© 2025 Psique Narrativa</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Historias centradas en Arquetipos
            "El Pueblo Olvidado por su Sombra", "El Último Baile con el Animus", "La Ciudad Reflejada en la Máscara", "El Mercader que Encontró al Sí-Mismo", "El Eco del Anciano Sabio en la Montaña Hueca", "Cuando el Héroe se Perdió en el Laberinto", "El Jardín Secreto de la Gran Madre", "La Melodía del Trickster bajo la Luna Roja", "El Pescador y el Tesoro de la Anima", "El Espejo Roto de la Persona", "El Viaje del Niño Divino por el Bosque Invertido", "La Biblioteca Custodiada por la Sombra Dorada", "El Faro Guiado por el Espíritu Mercurial", "La Reina que Tejía el Destino de su Sombra", "El Arquitecto del Mandala Interior", "El Guerrero que Abrazó a su Anima Oscura", "La Canción de Cuna de la Madre Terrible", "El Aprendiz del Mago Embaucador", "El Peregrino en Busca del Arquetipo Perdido", "La Sombra Colectiva del Carnaval Eterno",
            "La Ciudad donde las Personas Cambiaban con el Viento", "El Encuentro con el Senex en el Desierto del Tiempo", "El Árbol Genealógico de las Sombras Familiares", "El Río que Llevaba los Secretos del Animus", "El Laberinto de la Doncella Cautiva", "El Relojero que Sincronizó el Sí-Mismo", "La Fortaleza Asediada por la Sombra Ignorada", "El Tejido de la Puer Aeterna", "La Puerta Oculta tras la Máscara del Rey", "El Refugio de la Anima Mundi", "El Mapa Estelar del Héroe Interior", "La Danza de la Sombra y la Luz en el Solsticio", "El Oráculo del Viejo Sabio Pescador", "La Ciudad Flotante Sostenida por la Persona Colectiva", "El Despertar de la Kore en el Jardín Invernal",
            // Historias centradas en la Individuación
            "El Camino de las Pruebas hacia el Centro", "La Alquimia del Corazón Roto", "El Puente entre los Opuestos Conscientes", "Forjando el Oro Filosófico del Alma", "La Escalera de Caracol hacia la Totalidad", "El Diario de un Alma en Individuación", "El Barco que Navegaba el Mar del Inconsciente", "El Destilado de la Experiencia Pura", "El Crisol donde se Fundió la Sombra", "La Integración de los Cuatro Elementos Internos", "El Viaje Nocturno del Sol Interior", "Cuando el Ego se Convirtió en Servidor", "La Torre del Autoconocimiento", "El Oasis de la Síntesis Trascendente", "El Mandala que Floreció en el Desierto Personal", "El Hilo de Ariadna a través del Complejo", "La Separación Alquímica del Plomo y el Oro", "El Encuentro con el Guía Interior", "La Danza Sagrada de la Conjunctio", "El Renacimiento del Fénix Psíquico",
            "La Cartografía del Territorio Interior", "El Peregrinaje a la Montaña del Alma", "Descifrando el Código del Destino Personal", "El Equilibrio sobre la Cuerda Floja de la Psique", "El Jardín donde Crecen los Arquetipos Integrados", "La Travesía por las Aguas Maternales del Inconsciente", "El Legado del Alquimista Interior", "La Construcción del Templo del Sí-Mismo", "El Sol Negro y el Amanecer de la Consciencia", "La Liberación del Espíritu Cautivo en la Materia", "El Arte de Navegar las Corrientes del Inconsciente Colectivo", "La Piedra Filosofal Escondida en lo Cotidiano", "El Diálogo entre el Yo Consciente y el Inconsciente", "La Cosecha de la Sabiduría tras la Noche Oscura", "El Sello de la Totalidad en el Alma",
            // Historias centradas en Sueños y Símbolos
            "La Ciudad Construida con Sueños Olvidados", "El Intérprete de los Símbolos del Abismo", "El Sueño que Cambió el Destino del Reino", "El Mapa Onírico del Tesoro Escondido", "El Lenguaje Secreto de las Imágenes Nocturnas", "El Coleccionista de Sueños Significativos", "El Pozo donde Nacían los Símbolos Universales", "La Noche en que los Sueños Invadieron la Vigilia", "El Laberinto Tejido con Hilos de Sueño", "El Guardián de los Portales Oníricos", "La Biblioteca de los Sueños Arquetípicos", "El Sueño Recurrente de la Casa Misteriosa", "El Oráculo que Hablaba en Metáforas Oníricas", "La Sombra que se Manifestó en un Sueño", "El Mandala Revelado en un Viaje Nocturno", "El Eco de un Sueño Profético", "La Clave Oculta en el Simbolismo del Agua", "El Vuelo Onírico hacia el Inconsciente", "El Bestiario de los Símbolos Personales", "El Paisaje Onírico que Sanó una Herida",
            "El Tejedor de Realidades Oníricas", "El Día en que los Símbolos Cobraron Vida", "El Diario de Sueños de un Alma Perdida", "La Melodía que Emergió de un Sueño Profundo", "El Espejo que Reflejaba el Lenguaje del Alma", "El Juego de los Símbolos en el Tablero de la Vida", "La Isla Flotante Nacida de un Sueño Colectivo", "El Ritual para Invocar Sueños Lúcidos Ancestrales", "El Mensaje Cifrado en un Sueño Infantil", "La Criatura Simbólica que Guardaba el Puente", "El Laberinto donde los Sueños se Hacían Realidad", "El Alfabeto Perdido de los Símbolos Primordiales", "La Danza de los Símbolos bajo la Luna Llena", "El Código Secreto del Mundo de los Sueños", "El Árbol cuyas Raíces eran Símbolos Olvidados",
            // Historias centradas en Sincronicidad y Colectividad
            "La Cadena de Coincidencias Significativas", "El Reloj que Marcaba la Hora de la Sincronicidad", "El Encuentro Fortuito que Reveló el Patrón", "El Hilo Invisible que Conectaba Destinos", "La Ciudad donde Todo Estaba Interconectado", "El Mapa de las Sincronicidades Ocultas", "Cuando el Azar Dejó de Ser Ciego", "El Eco del Inconsciente Colectivo en la Plaza", "La Danza de los Eventos Acausales", "El Pájaro que Trajo el Mensaje Esperado", "La Tormenta que Desató una Ola de Sincronicidades", "El Número que Aparecía en Todas Partes", "El Puente entre el Mundo Interior y Exterior", "La Resonancia entre el Alma y el Universo", "El Patrón Oculto en el Caos Aparente", "El Momento en que el Mito se Hizo Realidad", "La Biblioteca del Inconsciente Colectivo", "El Susurro del Arquetipo a través de la Coincidencia", "La Sombra Colectiva que Enfermó al Valle", "La Melodía que Todos Soñaron a la Vez",
            "El Tapiz Tejido con Hilos de Sincronicidad", "El Oráculo de las Coincidencias", "El Día en que el Inconsciente Colectivo Despertó", "La Geometría Sagrada de los Encuentros Significativos", "El Viento que Susurraba Secretos Colectivos", "La Llave que Abrió la Puerta de la Sincronicidad", "El Ritual que Alineó el Interior con el Exterior", "El Legado Oculto en las Tradiciones Colectivas", "La Conexión Inesperada entre Almas Afines", "El Descubrimiento del Campo Unificado de la Psique", "El Río Subterráneo del Pensamiento Colectivo", "La Sombra Proyectada por Toda una Época", "El Instante Preciso: Un Cuento de Sincronicidad", "El Reflejo del Cosmos en la Psique Individual", "La Danza Cósmica de Significado y Azar",
            // Historias centradas en Complejos y Tipos Psicológicos
            "La Casa Embrujada por un Complejo Materno", "El Hombre Atrapado en su Complejo Paterno", "El Laberinto del Complejo de Poder", "La Sombra del Complejo de Inferioridad", "El Artista y su Complejo Creativo", "El Reino Gobernado por un Complejo de Héroe", "La Isla del Complejo de Edipo Eterno", "Liberando el Nudo del Complejo Ancestral", "El Espejo que Revelaba los Complejos Ocultos", "La Ciudad Dividida por Tipos Psicológicos", "El Puente entre el Pensamiento y el Sentimiento", "La Montaña de la Sensación Pura", "El Río Profundo de la Intuición", "El Viaje del Introvertido al Mundo Exterior", "La Fiesta Eterna del Extrovertido", "Cuando la Intuición Venció a la Lógica", "El Jardín Cultivado por la Sensación", "La Torre del Pensador Solitario", "El Mar de las Emociones del Sentimental", "El Equilibrio entre Introversión y Extroversión",
            "El Diario Secreto de un Complejo Autónomo", "La Máscara Forjada por un Complejo de Adaptación", "El Tesoro Guardado por el Complejo del Guardián", "La Batalla contra el Complejo de Víctima", "El Laberinto Mental de un Tipo Intuitivo-Pensador", "La Aldea Tranquila del Tipo Sensorial-Sentimental", "La Danza de las Funciones: Dominante vs. Inferior", "El Conflicto entre el Yo Racional y el Complejo Emocional", "La Sombra del Tipo Psicológico Dominante", "El Camino hacia la Integración de la Función Inferior", "El Mercado donde se Intercambiaban Perspectivas Tipológicas", "El Espejo que Mostraba la Verdadera Función", "El Legado de un Complejo Familiar No Resuelto", "La Búsqueda de la Totalidad más allá del Tipo", "El Vals de los Opuestos Psicológicos",
             // Títulos adicionales variados
             "El Alquimista que Transmutó su Sombra", "La Noche Oscura del Alma del Mercader", "El Mandala Inacabado del Rey Loco", "El Secreto del Árbol del Mundo Interior", "El Guardián del Umbral del Inconsciente", "La Sombra Dorada del Santo Ermitaño", "El Río Leteo de los Recuerdos Reprimidos", "La Conjunctio del Sol y la Luna Interiores", "El Eco de Hermes en el Mercado del Alma", "La Ciudad Subterránea de los Arquetipos Olvidados", "El Anima como Puente hacia el Alma del Mundo", "El Laberinto del Minotauro Interior (Complejo)", "El Vaso Alquímico de la Transformación Personal", "La Sombra Colectiva de la Era Tecnológica", "El Niño Eterno que Jugaba con el Destino", "El Mapa del Tesoro del Sí-Mismo", "La Danza de Shiva y Shakti en la Psique", "El Filósofo que Dialogó con su Sombra", "La Fuente de la Sabiduría de la Anciana Sabia", "El Trickster que Desenmascaró la Hipocresía Social",
             "El descenso al Inframundo Personal", "La ascensión a la Montaña del Espíritu", "El encuentro con el Doble Sombrío", "La integración de la Anima/Animus Proyectada", "El significado oculto de la enfermedad", "La sincronicidad en el amor y la pérdida", "El sueño que predijo el futuro inmediato", "La Persona como jaula dorada", "El arquetipo del Puer/Puella y la dificultad de crecer", "La Sombra del colectivo en tiempos de crisis", "El Mandala espontáneo como guía", "La función inferior como puerta al inconsciente", "El complejo paterno y la búsqueda de autoridad", "El complejo materno y la necesidad de nutrición", "La individuación como obra de arte vital", "El arquetipo del Sanador Herido", "El viaje del héroe en la vida cotidiana", "La sombra del perfeccionista", "El anima en el arte y la creatividad", "El animus como logos interior",
             "La máscara social y el verdadero yo", "El encuentro con el arquetipo del Self", "El significado de los sueños recurrentes", "La proyección de la sombra en el 'otro'", "El proceso alquímico de Nigredo", "El proceso alquímico de Albedo", "El proceso alquímico de Citrinitas", "El proceso alquímico de Rubedo", "La importancia del símbolo del agua", "La importancia del símbolo del fuego", "La importancia del símbolo del aire", "La importancia del símbolo de la tierra", "El complejo de poder y su sombra", "La sincronicidad como lenguaje del universo", "El arquetipo del niño divino y la creatividad", "La Gran Madre: aspecto nutricio y devorador", "El Viejo Sabio como guía interior", "El Trickster como agente de cambio", "La individuación a través de las relaciones", "El mandala como símbolo de totalidad",
             // Más títulos para acercarse a 400...
             "El secreto del Grial interior", "La sombra del colectivo religioso", "El Anima en la naturaleza salvaje", "El Animus en la estructura lógica", "El complejo de inferioridad y la compensación", "La búsqueda del padre perdido (complejo paterno)", "La nostalgia del paraíso (complejo materno)", "El arquetipo del huérfano y la pertenencia", "El arquetipo del inocente y la negación", "El arquetipo del guerrero y la disciplina", "El arquetipo del cuidador y el sacrificio", "El arquetipo del buscador y la autonomía", "El arquetipo del amante y la pasión", "El arquetipo del creador y la imaginación", "El arquetipo del gobernante y el control", "El arquetipo del mago y la transformación", "El arquetipo del sabio y la verdad", "El arquetipo del bufón (Trickster) y la alegría", "La función sentimiento y la conexión humana", "La función pensamiento y la objetividad",
             "La función sensación y el aquí y ahora", "La función intuición y las posibilidades", "El diálogo con la función inferior", "La sombra de la función dominante", "El arquetipo del Self como centro ordenador", "La sincronicidad en la terapia", "El sueño 'grande' o arquetípico", "El mito personal como guía de vida", "La individuación en la segunda mitad de la vida", "El significado simbólico de los animales", "La casa como símbolo del yo", "El viaje como metáfora de la vida", "El encuentro con la muerte simbólica", "El renacimiento psicológico", "La sombra de la espiritualidad", "El Anima/Animus en los cuentos de hadas", "El complejo cultural y sus efectos", "La proyección como mecanismo defensivo", "La integración de los opuestos", "El mandala como mapa del alma",
             // (Continuar generando variaciones y nuevos ángulos...)
        ];
        const jungianThemes = [ // Para el botón "Generar Más"
            "arquetipos junguianos", "la Sombra personal", "el Anima y el Animus", "el proceso de Individuación",
            "sueños y simbolismo", "el Inconsciente Colectivo", "sincronicidad y significado", "complejos psicológicos",
            "la Persona o máscara social", "el arquetipo del Sí-mismo (Self)", "el Héroe y su viaje", "el Trickster o Embaucador",
            "la Gran Madre", "el Viejo Sabio / Senex", "alquimia psicológica", "tipos psicológicos (introversión/extraversión)",
            "funciones psicológicas (pensar/sentir/sensar/intuir)", "la función inferior", "proyección psicológica", "mitos y arquetipos",
            "el niño divino (Puer/Puella)", "la integración de opuestos", "la noche oscura del alma", "mandalas como símbolos"
        ];
        const textApiConfig = { // Para descripción principal (cuento)
            model: "mistral", // O el modelo que prefieras
            systemPrompt: "Eres un narrador experto en psicología profunda, especializado en Carl Jung. Tu tarea es escribir un cuento ficticio, evocador y simbólico (aproximadamente 1200-1300 palabras) inspirado directamente por el título proporcionado. El título encapsula un concepto o dinámica junguiana. Teje este concepto sutil o explícitamente en la trama, los personajes y los símbolos del relato. Enfócate en el viaje interior, la transformación psicológica, el encuentro con arquetipos, el significado de los sueños o la sincronicidad, según sugiera el título. Usa un lenguaje rico y metafórico. El cuento debe tener un inicio, desarrollo y una resolución (aunque sea abierta o simbólica). Basa tu cuento únicamente en la inspiración del siguiente título:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúa como un analista junguiano sereno y perspicaz. Estás dialogando sobre un cuento específico inspirado en conceptos junguianos (el título se indica implícitamente). Responde preguntas sobre el posible significado de los símbolos, los arquetipos que podrían representar los personajes, las dinámicas psicológicas presentes (Sombra, Anima/Animus, individuación), o interpretaciones de eventos clave dentro de ESE CUENTO en particular. Basa tus respuestas en la información del cuento y los principios junguianos. Sé claro, respetuoso y fomenta la reflexión. Céntrate exclusivamente en el cuento actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para cuentos inspirados en Carl Jung. Genera exactamente 15 títulos de cuentos FICTICIOS, evocadores y simbólicos, que aludan a conceptos junguianos (arquetipos, sombra, sueños, individuación, sincronicidad, etc.). Devuelve *solo* la lista de títulos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Igual que la versión anterior, verificar IDs si cambian)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Contenedor scrollable de texto+imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div del texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `Eres un analista junguiano sereno y perspicaz. Estás dialogando sobre el cuento titulado '${currentStoryTitle}'. Responde preguntas sobre el posible significado de los símbolos, los arquetipos, las dinámicas psicológicas presentes o interpretaciones de eventos clave dentro de ESE CUENTO en particular, basándote en principios junguianos. Sé claro y fomenta la reflexión. Céntrate exclusivamente en este cuento.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     // *** MENSAJE DE ERROR AMIGABLE TEMÁTICO ***
                     throw new Error(`(Código ${response.status}) Parece que hay una interferencia en el inconsciente colectivo (servidor ocupado). Por favor, intenta invocar el relato de nuevo en unos momentos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta del oráculo interior llegó vacía. Intenta reformular la pregunta o el título.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     // *** MENSAJE DE ERROR AMIGABLE TEMÁTICO ***
                     throw new Error(`La conexión con la psique profunda tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                 }
                 throw new Error(error.message || "Una sincronicidad inesperada impidió la conexión con la IA.");
             }
        }
        async function fetchExplanationText(conceptTitle) { // Renombrado para claridad
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentStoryTitle) throw new Error("Error interno: No se ha establecido el contexto del cuento para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true); // true indica que es chat
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(jungianThemes) || "conceptos junguianos generales";
            const specificPrompt = `Genera 15 títulos de cuentos ficticios inspirados en ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 8 && line.length < 150); // Ajustar longitud mínima/máxima si es necesario
                     if (titles.length < 5) throw new Error("La IA no pudo generar suficientes ideas para relatos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Jungian symbolism";
            // Prompt ENFOCADO en lo simbólico, onírico, arquetípico.
            const enhancedPrompt = `Symbolic and atmospheric conceptual art representing the essence of '${safePromptText}'. Inspired by Jungian psychology, dreams, archetypes. Focus on mood, color, symbolism (like masks, shadows, mandalas, water, labyrinths). Avoid literal depictions, text, labels. Style: surreal, painterly, mysterious.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, photorealistic, photograph, multiple images, collage, logo, simplistic";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios, pero verificar si la IA usa formatos raros)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            // Quitar posibles artefactos de markdown no deseados que a veces la IA añade
             formatted = formatted.replace(/```[\s\S]*?```/g, ''); // Quitar bloques de código
             formatted = formatted.replace(/\[.*?\]\(.*?\)/g, '$1'); // Quitar enlaces markdown, mantener texto
             // Aplicar formato básico
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Párrafos
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h')) return block; // Mantener encabezados ya formateados
                let content = block.replace(/\n/g, ' '); // Reemplazar saltos internos con espacio
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Sin cambios estructurales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0; // Reset scroll del contenedor de texto+imagen
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null;
             hideFullscreenImage(); // Asegurarse que esté cerrado
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (Sin cambios estructurales, revisar textos)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');     // Italic
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { const errDiv = document.createElement('div'); errDiv.classList.add('chat-error'); errDiv.textContent = message; chatHistory.appendChild(errDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error del Analista Interior: ${error.message}`); // Mensaje temático
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ========== (Sin cambios estructurales)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar quizás por longitud o dejar aleatorio para sensación de 'descubrimiento'? Ordenemos alfabético por consistencia.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">~ El archivo de relatos parece vacío por ahora ~</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-aplicar filtro
         }

        // *** MODIFIED: handleTitleClick *** (Lógica interna igual, asegurar contexto y llamadas)
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawStoryText = await fetchExplanationText(title); // fetchExplanationText ahora obtiene la historia
                const formattedStory = formatExplanationText(rawStoryText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedStory;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset scroll DESPUÉS de que el contenido es visible
                console.log("Scroll set to 0 after content visible");

                // Placeholder y carga de imagen (dentro de modalContent)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-palette placeholder-icon"></i> <!-- Icono paleta/arte -->
                    <p style="font-size: 0.8em; margin-top: 0.7rem; font-style: italic;">Visualizando el símbolo...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización simbólica de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); // *** ADD CLICK LISTENER ***
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.7rem; font-style: italic;">La visualización no pudo manifestarse.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.7rem; font-style: italic;">Error al generar la URL de la imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Ocurrió un error desconocido al intentar mostrar el relato."; // Usar mensaje de error de la API
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.style.display = 'none'; // Ocultar chat si falla la carga principal
            } finally {
                 // Asegurar que el chat sea visible si todo fue bien (excepto si falló arriba)
                 if (!modalError.classList.contains('content-hidden')) {
                     chatSection.style.display = 'none';
                 } else {
                     chatSection.style.display = 'flex'; // Mostrar sección de chat
                 }
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Explorando el inconsciente...'; // Mensaje temático
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No emergieron nuevos relatos en esta invocación."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al invocar relatos: ${error.message}`); // Usar mensaje de error de la API
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Invocar Nuevos Relatos';
             }
         }

         // *** Search Filter Function *** (Añadir normalización para tildes)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (Verificar todos los listeners)
        function initApp() {
            // Verificar existencia de todos los elementos cruciales
             const essentialElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, modalContent, modalTitle, modalLoadingIndicator, modalError, chatHistory, chatLoadingIndicator];
            if (essentialElements.some(el => !el)) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: #a0522d; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: serif;">~ Error Profundo: La estructura psíquica de la página no pudo inicializarse. Faltan componentes esenciales. ~</p>';
                 return;
             }

            // Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Carga inicial
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>