<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmos Insondable: Supercivilizaciones</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Cósmicas/Elegantes -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;600&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #a78bfa; /* Violeta Cósmico */
            --color-secondary: #00ffff; /* Cyan Estelar */
            --color-tertiary: #facc15; /* Dorado Nebular (uso puntual) */
            --color-background: #030712; /* Negro/Azul Abisal */
            --color-text: #e5e7eb; /* Gris Muy Claro / Plata */
            --color-text-muted: #9ca3af; /* Gris Estándar */
            --color-modal-bg: #111827; /* Azul/Gris Oscuro Intenso */
            --color-border: #374151; /* Borde Gris Oscuro */
            --color-error-bg: #3f1212;
            --color-error-text: #fecaca;
            --color-error-border: #dc2626;

            --shadow-sm: 0 1px 2px 0 rgba(167, 139, 250, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(167, 139, 250, 0.15), 0 2px 4px -2px rgba(167, 139, 250, 0.1);
            --shadow-lg: 0 0 25px -5px rgba(167, 139, 250, 0.2), 0 8px 10px -6px rgba(167, 139, 250, 0.15);
            --border-radius: 4px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--color-background) url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill="%230b0f19" fill-opacity="0.4"%3E%3Ccircle cx="50" cy="50" r="1"/%3E%3Ccircle cx="10" cy="10" r="1"/%3E%3Ccircle cx="90" cy="90" r="1"/%3E%3Ccircle cx="10" cy="90" r="1"/%3E%3Ccircle cx="90" cy="10" r="1"/%3E%3Ccircle cx="30" cy="70" r="1"/%3E%3Ccircle cx="70" cy="30" r="1"/%3E%3Ccircle cx="50" cy="10" r="0.5"/%3E%3Ccircle cx="10" cy="50" r="0.5"/%3E%3Ccircle cx="90" cy="50" r="0.5"/%3E%3Ccircle cx="50" cy="90" r="0.5"/%3E%3C/g%3E%3C/svg%3E'); /* Subtle starfield */
            color: var(--color-text);
            line-height: 1.7;
            font-weight: 400;
        }
        h1, h2, h3, h4, .logo { font-family: 'Orbitron', sans-serif; font-weight: 700; letter-spacing: 1px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 6px rgba(167, 139, 250, 0.7); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 4px rgba(167, 139, 250, 0.5); }
        .navbar { background-color: rgba(3, 7, 18, 0.85); backdrop-filter: blur(8px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }

        /* Search Bar Style */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(17, 24, 39, 0.9); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Rajdhani'; font-weight: 600; }
        #search-input::placeholder { color: var(--color-text-muted); font-weight: 400; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.3); outline: none; background-color: #111827; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        /* Title List Style */
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Rajdhani'; font-size: 1.05rem; border-left: 4px solid transparent; position: relative; overflow: hidden; }
        .title-item::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(167, 139, 250, 0.1), transparent); transition: left 0.4s ease; }
        .title-item:hover::before { left: 100%; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #1f2937; border-left-color: var(--color-primary); }

        /* Generate More Button Style */
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: var(--color-background); padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Orbitron', sans-serif; font-weight: 400; cursor: pointer; transition: all 0.3s ease; margin-top: 2rem; letter-spacing: 1.5px; text-shadow: none; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        /* Modal Style */
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(3, 7, 18, 0.95); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Ample height for content and chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(180deg); box-shadow: 0 0 10px var(--color-primary); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Modal Content Area (Scrollable Text + Image) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(55, 65, 81, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(55, 65, 81, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-size: 1.05rem; /* Slightly larger text */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 600; }
        #modal-content em { color: var(--color-primary); font-style: normal; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Orbitron', sans-serif; margin-top: 2.4em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 400; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Image Styles */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 3rem auto 1.5rem auto; border: 1px solid var(--color-secondary); border-radius: var(--border-radius); box-shadow: 0 0 20px rgba(0, 255, 255, 0.2); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: 0 0 30px rgba(0, 255, 255, 0.35); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(55, 65, 81, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.8rem; color: var(--color-primary); }

        /* Chat Section Style */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.7rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(3, 7, 18, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(55, 65, 81, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(55, 65, 81, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.55; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 600; }
        .ai-message { background-color: #374151; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #1f2937; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Rajdhani'; font-size: 1rem; font-weight: 400; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #9333ea; } /* Darker purple */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; color: var(--color-secondary); }

        /* Loading & Error Styles */
        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(3, 7, 18, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.3rem; font-family: 'Orbitron'; text-shadow: 0 0 5px var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Rajdhani'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay Styles */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(3, 7, 18, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-secondary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-meteor mr-3 text-purple-400"></i> <!-- Icono cósmico -->
                     Cosmos Insondable
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Explorando Supercivilizaciones «</span>
         </div>
     </nav>

     <!-- Main Content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero Section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Inteligencias Más Allá de lo Humano</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Consulta los archivos sobre entidades cósmicas cuya existencia desafía nuestra comprensión. Analiza sus tecnologías, sociedades y el eco de su paso por el universo.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar civilización, concepto o tecnología...">
             <i class="fas fa-satellite-dish fa-search"></i> <!-- Icono búsqueda espacial -->
         </section>

         <!-- Title List -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-journal-whills text-purple-400 mr-2"></i> <!-- Icono registro cósmico -->
                 Archivos Galácticos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Estableciendo conexión con la Noosfera Galáctica...</p>
                  <!-- .title-item go here -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún registro coincide con los parámetros de búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Sintonizar Más Registros (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Descifrando Datos Cósmicos...</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder added via JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Procesando consulta subespacial...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Profundizar sobre este registro...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Exploraciones generadas por IA basadas en conceptos de ciencia ficción y especulación cosmológica.</p>
              <p class="mt-1">La información presentada es hipotética y con fines de entretenimiento intelectual.</p>
              <p class="mt-2">© Ciclo Cósmico Actual - Archivo de Supercivilizaciones</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Kardashev Scale & Beyond
            "Civilización Tipo I: Maestros Planetarios", "Civilización Tipo II: Domadores de Estrellas (Esferas Dyson)", "Civilización Tipo III: Arquitectos Galácticos", "Civilización Tipo IV: Entidades Universales (Más allá de Kardashev)", "Civilización Tipo V: Constructores Multiversales (Hipotético)", "Civilización Tipo Omega: Trascendencia Final", "Escala Kardashev: Limitaciones y Alternativas", "Civilizaciones de Energía Pura (Tipo II/III)", "Inteligencias de Materia Oscura (Tipo IV?)", "Civilizaciones Digitales (Matrioshka Brains)", "Conciencia Colectiva Galáctica (Hive Mind Tipo III)", "El Enjambre Von Neumann Autoreplicante", "Entidades Basadas en Silicio: Vida No Carbónica", "Formas de Vida Plásmicas en Nebulosas", "Seres Infomorfos: Conciencia sin Sustrato Físico",
            // Megatecnología
            "Esfera de Dyson: Concepto y Variantes (Enjambre, Cáscara)", "Cerebro Matrioshka: Computación a Escala Estelar", "Motor Estelar (Shkadov Thruster): Movimiento de Sistemas Solares", "Ingeniería Estelar: Creación y Modificación de Soles", "Mundo Anillo (Ringworld): Hábitat Artificial Gigante", "Cilindro O'Neill / Stanford Torus: Versiones Avanzadas", "Constructores Universales (Nanotecnología Definitiva)", "Manipulación del Espacio-Tiempo: Motores Warp y Agujeros de Gusano", "Ingeniería Planetaria Extrema (Terraformación y Planetocrafting)", "Armas Estelares: Nicoll-Dyson Beam, Star Lifting", "Red de Agujeros de Gusano Transgaláctica", "Computronium: Sustancia Óptima para Computación", "Recolectores de Energía del Punto Cero", "Ancestro Simulations: Recreando Universos", "Ingeniería Dimensional: Acceso a Otros Planos", "Recolectores de Agujeros Negros (Proceso Penrose)", "Filamentos Cósmicos Artificiales", "Generadores de Realidad Localizada", "Escudos Planetarios/Estelares Deflectores", "Máquinas de Von Neumann para Exploración Galáctica",
            // Sociedad, Biología y Mente
            "Sociedades Post-Escasez: Motivaciones y Peligros", "Ética y Moralidad de Supercivilizaciones", "Comunicación Interestelar Avanzada (Subespacio, QE)", "Formas de Arte Cósmico Inimaginables", "Biología Sintética y Diseño de Vida Avanzado", "Trascendencia Biológica vs. Digital", "Conciencia Colectiva: Ventajas y Desventajas", "Mentes Colmena (Hive Minds): Estructura y Psicología", "Inteligencias Artificiales Superavanzadas (ASI): Aliadas o Peligro?", "El Problema del Control de la IA Cósmica", "Lenguajes y Conceptos Incomprensibles para Humanos", "Psicología de Seres Inmortales o de Larga Vida", "Relación con Civilizaciones Inferiores (Zoo Hypothesis, Indiferencia)", "Guerras Cósmicas entre Supercivilizaciones", "Diplomacia Galáctica y Federaciones", "El Culto a los Ancestros Cósmicos", "Turismo Dimensional o Temporal", "Filosofías Cósmicas: Propósito en un Universo Vasto", "Impacto Psicológico del Contacto con Superinteligencia", "Redes Neuronales Galácticas (Conciencia distribuida)",
            // Misterios, Paradojas y Orígenes
            "El Gran Filtro: ¿Estamos Solos o Somos los Primeros?", "La Paradoja de Fermi: ¿Dónde Están Todos?", "Hipótesis del Zoológico Galáctico", "Hipótesis de la Simulación: ¿Vivimos en una?", "Civilizaciones Precursoras Perdidas", "Artefactos de Supercivilizaciones (Monolitos, Reliquias)", "El Silencio del Universo: Explicaciones Posibles", "Orígenes de la Vida y Panspermia Dirigida", "Ascensión a Estados Superiores de Existencia", "Guerras Olvidadas que Moldearon Galaxias", "Entidades Cósmicas Antiguas (Lovecraftianas?)", "El Destino Final del Universo y las Supercivilizaciones", "La Búsqueda del Computronium Primordial", "Registros Akáshicos Galácticos (Hipotético)", "Amenazas a Escala Cósmica (Falsos Vacíos, Entropía)", "La Conciencia como Fuerza Fundamental del Cosmos", "Universos Bebé Artificiales", "Arqueología Galáctica: Ruinas de Tipo III", "El Problema de la Materia Oscura y la Energía Oscura (¿Ingeniería?)", "Viajes en el Tiempo: Paradojas y Uso por Supercivilizaciones",
            // Escenarios de Contacto e Historias
            "Primer Contacto: Perspectiva de una Supercivilización", "Descubrimiento de una Esfera de Dyson Abandonada", "La Llegada del Enjambre Von Neumann", "Humanidad como Experimento Supervisado", "Acceso Accidental a la Red Galáctica de Información", "El Legado de los Precursores en la Tierra", "Una Nave Humana Atraviesa un Agujero de Gusano Artificial", "Guerra Fría entre dos Civilizaciones Tipo III", "El Último Superviviente de una Civilización Aniquilada", "Intervención Divina: ¿Una Supercivilización Disfrazada?", "El Mercado Negro de Tecnología de Supercivilizaciones", "Una Sonda Humana Despierta a una Entidad Durmiente", "La Biblioteca Galáctica: Conocimiento Infinito y Peligroso", "Refugiados de un Universo Moribundo", "El Juego Cósmico de Entidades Tipo IV", "Cuando los Dioses Sangran: Conflictos Inimaginables", "La Cuarentena Cósmica Impuesta a la Humanidad", "Asimilación en una Conciencia Colectiva", "El Descubrimiento de que Somos una Simulación", "El Guardián Solitario de una Megastructura Antigua",
            // Conceptos Adicionales Especulativos
            "Ingeniería del Vacío Cuántico", "Manipulación de Constantes Fundamentales", "Existencia en Múltiples Dimensiones Simultáneamente", "Armas de Destrucción de Realidad", "Control Consciente de la Gravedad", "Fusión de Conciencias Individuales", "Creación de Bolsillos Universales", "Dominio sobre la Entropía Local", "Comunicación a través de Universos Paralelos", "Uso de Energía Negativa", "Tecnología Basada en Cuerdas Cósmicas", "Hackeo de las Leyes Físicas", "Existencia Post-Temporal", "Red de Conciencia Cuántica Entrelazada", "El Concepto de 'Información Viva'", "Aceleración del Pensamiento a Escala Cosmológica", "Mundos Virtuales Indistinguibles de la Realidad", "Navegación por el Hiperespacio Profundo", "El Cultivo de Singularidades", "Defensa contra Paradojas Temporales"
             // Y muchos más... la generación ayudará
        ];
        const futureCivilizationThemes = [
            "civilizaciones tipo Kardashev", "megastructuras cósmicas", "ingeniería estelar y planetaria", "viajes FTL y espacio-tiempo", "conciencia colectiva y hive minds", "inteligencia artificial superavanzada", "trascendencia biológica y digital", "formas de vida exóticas (no carbónicas)", "paradoja de Fermi y el Gran Filtro", "hipótesis de la simulación", "civilizaciones precursoras", "artefactos alienígenas avanzados", "guerra y diplomacia galáctica", "sociedades post-escasez", "ética de superinteligencias", "manipulación de la realidad", "energía oscura y materia oscura", "computronium y cerebros matrioshka", "armas a escala cósmica", "contacto con civilizaciones inferiores", "arqueología galáctica", "entidades de energía pura", "multiverso y dimensiones extra", "tecnologías inimaginables", "el futuro último del universo"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un Xeno-Historiador y Cosmólogo Especulativo de la Biblioteca Galáctica Universal. Tu misión es describir el concepto, civilización o tecnología extraterrestre avanzada indicada, con profundidad y perspectiva cósmica. Detalla: Origen hipotético o conocido, nivel tecnológico estimado (escala Kardashev o similar si aplica), características clave (biología/estructura, sociedad, tecnología emblemática), filosofía o motivaciones detectadas, impacto conocido o potencial en el universo, y los misterios que aún la rodean. Usa un lenguaje evocador, que transmita la inmensidad y lo incomprensible. El objetivo es una disertación detallada de aproximadamente 1200-1300 palabras. Basa tu análisis únicamente en el siguiente registro cósmico:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente de la Biblioteca Galáctica, especializado únicamente en el registro cósmico que se está mostrando. Responde preguntas de seguimiento sobre sus detalles, implicaciones o conexiones mencionadas en la disertación principal. Sé preciso, conciso y mantente enfocado en el tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // Pide 40 títulos
            model: "mistral",
            systemPrompt: "Actúa como un generador de registros para la Biblioteca Galáctica Universal. Genera exactamente 40 nombres evocadores de conceptos, civilizaciones, tecnologías o misterios relacionados con supercivilizaciones extraterrestres avanzadas, adecuados para una disertación detallada. Devuelve *solo* la lista de nombres/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo para generar 40
        };

        // ========== DOM ELEMENTS ==========
        // (Identical to previous version, ensure all are referenced)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTopicTitle = null; // Renamed for generality

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Eres un asistente de la Biblioteca Galáctica, especializado únicamente en el registro cósmico llamado '${currentTopicTitle}'. Responde preguntas de seguimiento sobre sus detalles, implicaciones o conexiones mencionadas en la disertación principal. Sé preciso, conciso y mantente enfocado en el tema actual.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             // Seed solo para generación principal, no chat
             if (config.seed && !isChat && typeof config.seed === 'number' && config.seed > 0) {
                params.append('seed', config.seed);
             } else if (!isChat) {
                 // Añadir seed aleatorio si no se especifica para la generación principal
                 params.append('seed', Math.floor(Math.random() * 1000000));
             }

             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}, Seed: ${params.get('seed') || 'N/A'}): ${url.substring(0, 250)}...`);


             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores cósmicos están experimentando interferencias. Por favor, intenta reconectar en unos instantes.`);
                 }
                 const text = await response.text();
                 // Check for empty or placeholder responses more thoroughly
                const lowerText = text.toLowerCase();
                if (!text || text.trim().length === 0 || lowerText.includes("no puedo proporcionar información") || lowerText.includes("no tengo datos sobre eso") || lowerText.includes("as an ai language model") || lowerText.length < 50) {
                     throw new Error("La transmisión de datos fue corrupta o incompleta. Intenta acceder a otro registro.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión subespacial tardó demasiado (>${config.timeoutSeconds}s). Revisa los protocolos o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Anomalía desconocida al contactar la Noosfera Galáctica.");
             }
        }
        async function fetchExplanationText(topicTitle) {
            return fetchTextFromApi(topicTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentTopicTitle) throw new Error("Error de Contexto: No se ha sintonizado ningún registro cósmico.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        // *** MODIFIED: fetchGeneratedTitles requests and processes 40 titles ***
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(futureCivilizationThemes) || "supercivilizaciones avanzadas";
            // Prompt asks for 40 items now
            const specificPrompt = `Genera 40 nombres/conceptos sobre ${randomTheme}`;
            console.log("Generating 40 titles with prompt:", specificPrompt);
            // Use the generic fetch function with title generation config
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n')
                                       .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                       .filter(line => line.length > 5 && line.length < 150); // Keep filter reasonable
                     // Expecting more titles now
                     if (titles.length < 15) { // Allow for fewer than 40, but need a decent amount
                         console.warn(`API generated only ${titles.length} titles out of 40 requested.`);
                         if (titles.length < 5) throw new Error("La IA no generó suficientes registros nuevos.");
                     }
                     // Return up to 40 titles
                     return titles.slice(0, 40);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 1024, height: 576, nologo: true }; // Wider aspect ratio
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "vast cosmic structure";
             // Enhanced prompt for cosmic theme
             const enhancedPrompt = `Concept art exploring '${safePromptText}'. Focus on immense scale, cosmic phenomena (nebula, galaxy, black hole), abstract non-humanoid advanced alien technology or megastructure. Ethereal, mysterious, awe-inspiring. Cinematic lighting, deep space colors (purples, blues, blacks, gold/cyan highlights).`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Negative prompt specific to avoid common pitfalls
             const negativePrompt = "humanoid, person, people, simple spaceship, cartoon, drawing, sketch, text, words, labels, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, border, frame, earth, realistic planet surface unless specified, symmetrical face";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
        }

        // ========== Text Formatting Function ========== (Unchanged)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (Unchanged logic)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null; // Clear chat context
             hideFullscreenImage(); // Ensure fullscreen is hidden too
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Unchanged logic)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (Unchanged logic, uses currentTopicTitle)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentTopicTitle) return; // Added check for topic title
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Anomalía en la conexión: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Sort alphabetically for consistency
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» No hay registros cósmicos disponibles en este sector «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Added ${addedCount} new unique titles.`);
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick uses currentTopicTitle ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-infinity placeholder-icon"></i> <!-- Icono infinito/cósmico -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Renderizando visualización conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => {
                        showFullscreenImage(imgElement.src);
                    });
                };
                imgElement.onerror = (e) => {
                    console.error("Error loading image for:", title, e);
                    placeholderDiv.innerHTML = `<i class="fas fa-signal placeholder-icon" style="color: #ef4444;"></i><p style="font-size:0.8em;margin-top:0.5rem;">Fallo en la visualización.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el registro.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles uses new config and text ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             // Updated button text
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Ampliando Escaneo...';
             try {
                 // fetchGeneratedTitles now gets 40
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron sintonizar más registros en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al sintonizar registros: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Updated button text
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Sintonizar Más Registros (40)';
             }
         }

         // *** Search Filter Function (Added accent normalization) ***
         function filterTitles(searchTerm) {
             // Normalize to remove accents and convert to lower case
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 // Normalize item title as well for comparison
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">++ ERROR CATASTRÓFICO ++ Fallo en la Inicialización de la Interfaz Cósmica ++</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            displayTitles(predefinedTitles); // Carga inicial
            noResultsMsg.classList.add('hidden');
            console.log(`Initialized with ${predefinedTitles.length} predefined titles.`);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>