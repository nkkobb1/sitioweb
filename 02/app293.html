<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rituales de Magia Blanca - Guía Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- *** Asegúrate de cargar Font Awesome 6 Free CORRECTAMENTE *** -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Elegantes y Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Magia Blanca --- */
        :root {
            --color-primary: #a7c957; /* Verde Salvia Suave */
            --color-secondary: #e0aaff; /* Lavanda Claro */
            --color-tertiary: #f2e8cf; /* Crema / Pergamino */
            --color-accent: #ffb703; /* Dorado Suave */
            --color-background: #f8f9fa; /* Blanco Roto / Gris muy claro */
            --color-text: #495057; /* Gris Oscuro Suave */
            --color-text-muted: #adb5bd; /* Gris Medio Claro */
            --color-modal-bg: #ffffff; /* Blanco Puro */
            --color-border: #dee2e6; /* Borde Gris Claro */
            --color-error-bg: #fff5f5; /* Fondo error rosa muy pálido */
            --color-error-text: #e53e3e; /* Texto error rojo */
            --color-error-border: #fed7d7; /* Borde error rojo pálido */

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --border-radius: 10px; /* Bordes más suaves */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Lora', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400;
               background-image: linear-gradient(rgba(248, 249, 250, 0.97), rgba(248, 249, 250, 0.97)),
                                 url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d8e2dc' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
               background-attachment: fixed;
        }
        h1, h2, h3, h4, .logo { font-family: 'Playfair Display', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        .logo .fa-leaf { color: var(--color-primary); }
        .logo .fa-star { color: var(--color-accent); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; font-size: 2rem; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lora'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(167, 201, 87, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.5rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Lora'; font-size: 1rem; border-left: 5px solid var(--color-secondary); }
        .title-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: var(--color-primary); color: var(--color-primary); border-left-color: var(--color-primary); background-color: #f8f9fa; }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-accent)); color: white; padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; letter-spacing: 1px; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; text-shadow: 1px 1px 1px rgba(0,0,0,0.1); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-accent), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(73, 80, 87, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 2px solid var(--color-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 500px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-secondary); border: 1px solid var(--color-primary); border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); transform: rotate(90deg) scale(1.1); box-shadow: 0 0 8px var(--color-primary); }

        #modal-story-content-area { flex-grow: 1; min-height: 0; display: none; flex-direction: column; }
        #modal-story-content-area.visible { display: flex; }

        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-tertiary);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-tertiary); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-tertiary); }

        #modal-content { padding: 0 5px; font-size: 1.1rem; } /* Slightly larger text */
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Playfair Display', serif; margin-top: 2.4em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 700; }
        #modal-content h1 { font-size: 1.7em; }
        #modal-content h2 { font-size: 1.5em; color: var(--color-secondary); }
        #modal-content h3 { font-size: 1.3em; }
        #modal-content h4 { font-size: 1.15em; color: var(--color-text-muted); border-bottom: none; font-style: italic;}
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 3rem auto 1rem auto; border: 2px solid var(--color-secondary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: 0 0 12px var(--color-secondary); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 3rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(173, 181, 189, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.8rem; color: var(--color-primary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f8f9fa; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) #e9ecef;
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: #e9ecef; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.7rem 1rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.6; box-shadow: var(--shadow-sm); font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; font-weight: 600; }
        .ai-message { background-color: var(--color-secondary); color: white; margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.8rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lora'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(167, 201, 87, 0.2); }
        #chat-send-btn { padding: 0.8rem 1.2rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1rem; flex-shrink: 0; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-secondary); transform: scale(1.05); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; transform: none; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Screen & Minigame - "Altar Harmony" */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, rgba(242, 232, 207, 0.95) 0%, rgba(167, 201, 87, 0.95) 100%); /* Crema a Verde Salvia */
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius);
            padding: 2rem; color: var(--color-text); text-align: center;
        }
        #modal-loading.active { display: flex; }
        #loading-game-canvas {
            border: 2px solid var(--color-primary);
            background-color: var(--color-tertiary); /* Fondo pergamino */
            max-width: 80%; /* Más pequeño que el anterior */
            max-height: 55%;
            aspect-ratio: 4 / 3; /* Ratio más cuadrado */
            box-shadow: 0 0 15px rgba(167, 201, 87, 0.4);
            margin-bottom: 1rem;
            display: block;
            cursor: pointer; /* Indica que se puede clickear */
        }
        #loading-instructions { font-size: 0.95rem; margin-top: 0.5rem; font-family: 'Lora'; font-style: italic; }
        #loading-score { font-size: 1.4rem; font-family: 'Playfair Display'; margin-top: 0.5rem; color: var(--color-primary); }
        .loading-spinner-modal { /* Fallback spinner */
            width: 50px; height: 50px; border: 5px solid rgba(173, 181, 189, 0.3); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Estilo para items en el juego */
        .game-item-icon { font-size: 24px; /* Ajustar tamaño */ }
        .game-item-icon.candle { color: #ffec8b; } /* Amarillo vela */
        .game-item-icon.crystal { color: #add8e6; } /* Azul claro cristal */
        .game-item-icon.herb { color: #90ee90; } /* Verde claro hierba */
        .game-item-icon.water { color: #87cefa; } /* Azul cielo agua */
        .game-item-icon.feather { color: #f5f5f5; } /* Blanco pluma */
        .game-item-icon.salt { color: #faf0e6; } /* Lino/Sal */
        /* Efecto visual en match */
        .particle { position: absolute; width: 5px; height: 5px; background: var(--color-accent); border-radius: 50%; animation: fadeOut 0.5s ease-out forwards; pointer-events: none; /* Importante para no interferir con clicks */ z-index: 110; /* Encima del canvas pero debajo del overlay si fuera necesario */}
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px) scale(0.5); } }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Lora'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(248, 249, 250, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-secondary); border-radius: var(--border-radius); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 2px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: white; transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-leaf mr-2"></i> <!-- Icono hoja -->
                     Rituales de Luz
                     <i class="fas fa-star ml-2"></i> <!-- Icono estrella -->
                 </h1>
             </div>
             <span class="text-md text-gray-600 font-semibold font-sans tracking-wide">» Guía Interactiva de Magia Blanca «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Senda de la Armonía</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora rituales para la protección, sanación, prosperidad y crecimiento espiritual. Conecta con tu intención y la energía positiva del universo.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar ritual (Ej: limpieza energética, protección hogar, amor propio...)">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book text-purple-400 mr-2"></i> <!-- Icono libro abierto -->
                 Compendio de Rituales
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los archivos ancestrales...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron rituales para tu búsqueda de intención «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar 40 Rituales Más
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <canvas id="loading-game-canvas" width="400" height="300">Canvas no soportado.</canvas>
                 <p id="loading-instructions">¡Armoniza el Altar! Haz clic en el símbolo de abajo que coincida con el de arriba.</p>
                 <p id="loading-score">Armonía: 0 | Nivel: 1</p>
                 <div class="loading-spinner-modal content-hidden"></div> <!-- Fallback -->
             </div>

             <!-- Content Area Wrapper (Initially Hidden) -->
             <div id="modal-story-content-area">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Ritual text (HTML) goes here -->
                         <!-- Image and placeholder added via JS -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando sabiduría...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este ritual (variaciones, simbolismo...).">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gradient-to-r from-green-50 to-purple-50 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Guía generada por IA con fines informativos y de inspiración para prácticas espirituales positivas.</p>
              <p class="mt-1">La magia es una herramienta personal; úsala con responsabilidad, ética y respeto. No sustituye el consejo profesional médico o psicológico.</p>
              <p class="mt-2">© 2025 Senda de la Armonía</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Protección
            "Ritual Básico de Protección Personal con Visualización", "Crear un Círculo de Protección antes de un Ritual", "Ritual de Protección del Hogar con Sal Marina", "Amuleto de Protección Personal con Ojo Turco o similar", "Ritual de Limpieza y Protección con Humo de Salvia Blanca", "Hechizo de Protección contra Energías Negativas con Turmalina Negra", "Ritual para Proteger a un Ser Querido a Distancia", "Crear Agua de Luna Llena para Protección", "Ritual de Protección durante Viajes", "Escudo Psíquico: Técnica de Visualización", "Protección del Espacio de Trabajo/Estudio", "Bendición y Protección de Mascotas", "Romper Lazos Energéticos Negativos", "Ritual con Vela Negra para Absorber Negatividad (Uso Ético)", "Invocar a Guías o Ángeles Guardianes para Protección",
            // Limpieza y Purificación
            "Limpieza Energética Personal con Baño de Sal y Hierbas", "Limpieza Profunda del Hogar con los Cuatro Elementos", "Ritual de Purificación con Incienso (Copal, Sándalo)", "Limpieza de Cristales con Agua Corriente o Luz Lunar", "Ritual de 'Destierro' de Malos Hábitos o Pensamientos", "Limpieza Energética después de una Discusión o Estrés", "Ritual de Luna Menguante para Liberar lo que no Sirve", "Purificación de Herramientas Mágicas Nuevas o Usadas", "Ritual de Limpieza con Sonido (Campanas, Cuencos)", "Limpiar el Aura con Plumas o Selenita", "Ritual del Perdón para Limpieza Emocional", "Baño de Descarga Energética con Ruda", "Limpieza de Objetos de Segunda Mano", "Ritual de 'Borrado' de Huellas Energéticas", "Limpieza con Agua de Florida o similar",
            // Sanación (Emocional, Espiritual)
            "Ritual de Sanación Emocional con Cuarzo Rosa", "Meditación Guiada para la Sanación del Niño Interior", "Ritual para Superar una Pérdida o Duelo", "Hechizo para Fomentar la Paz Interior con Amatista", "Ritual de Auto-perdón y Compasión", "Sanación de Relaciones Pasadas (Cortar Lazos Sanamente)", "Ritual para Aliviar la Ansiedad con Lavanda", "Conectar con la Energía Sanadora de la Tierra (Earthing)", "Ritual de Sanación a través de la Escritura Terapéutica", "Baño Ritual para la Renovación Espiritual", "Cargar Agua con Intención Sanadora", "Ritual para Sanar Heridas de Traición o Abandono", "Fomentar Sueños Lúcidos para la Sanación Subconsciente", "Ritual con Velas Verdes para la Salud y Bienestar General", "Círculo de Sanación Grupal (Intención Colectiva)",
            // Amor (Propio, Atracción General Positiva)
            "Ritual de Amor Propio frente al Espejo", "Baño Ritual para Aumentar el Amor Propio con Pétalos de Rosa", "Hechizo para Atraer Amistades Positivas", "Ritual para Fortalecer el Amor en una Relación Existente (Ético)", "Crear un Tarro de Miel para Endulzar Relaciones (Amor Propio/General)", "Ritual de Afirmaciones Positivas para el Amor Propio", "Hechizo para Abrir el Corazón al Amor (General)", "Ritual de Gratitud por el Amor Presente en tu Vida", "Meditación para Conectar con la Diosa Interior (Amor Propio)", "Ritual con Vela Rosa para Atraer Amor Romántico (Abierto, no específico)", "Sanar el Corazón Roto con Crisocola o similar", "Ritual para Mejorar la Comunicación en Pareja", "Crear un Aceite de Unción para el Amor Propio", "Hechizo de Belleza Interior y Exterior (Confianza)", "Ritual de Luna Nueva para Manifestar Amor Propio",
            // Prosperidad y Abundancia
            "Ritual de Prosperidad con Vela Verde y Canela", "Crear un Cuenco de la Abundancia con Arroz y Monedas", "Hechizo para Atraer Oportunidades Laborales o de Negocio", "Ritual de Luna Creciente para la Prosperidad", "Agradecer la Abundancia Presente para Atraer Más", "Limpieza de Creencias Limitantes sobre el Dinero", "Amuleto de Prosperidad con Citrino o Pirita", "Ritual para Pagar Deudas y Liberar Bloqueos Financieros", "Visualización Creativa de la Abundancia Deseada", "Hechizo de la Nuez Moscada para la Buena Suerte Financiera", "Plantar una Semilla con Intención de Prosperidad", "Ritual con Hojas de Laurel para Manifestar Éxito", "Bendición del Dinero (Tratarlo con Respeto)", "Crear Agua de Arroz para Atraer Prosperidad al Hogar", "Ritual de Gratitud por las Pequeñas Abundancias Diarias",
            // Conexión (Naturaleza, Elementos, Ciclos)
            "Ritual de Conexión con los Cuatro Elementos (Tierra, Aire, Fuego, Agua)", "Meditación para Conectar con el Espíritu de un Árbol", "Honrar los Ciclos de la Luna (Nueva, Creciente, Llena, Menguante)", "Ritual Sencillo para Agradecer al Sol", "Celebración de los Sabbats (Solsticios, Equinoccios, Puntos Medios)", "Crear un Altar Dedicado a la Naturaleza", "Caminata Consciente en la Naturaleza para Conectar", "Ritual para Honrar a los Espíritus Elementales (Ético)", "Trabajar con las Energías de las Estaciones", "Ofrenda Sencilla a la Madre Tierra", "Meditación en un Cuerpo de Agua Natural (Río, Mar)", "Observación de Estrellas con Intención Mágica", "Crear Arte Inspirado en la Naturaleza como Acto Mágico", "Diario de Gratitud hacia la Naturaleza", "Ritual para Conectar con tu Animal de Poder o Guía Espiritual",
            // Herramientas y Prácticas
            "Consagración de Herramientas Mágicas (Varita, Athame, Cáliz)", "Uso de Velas de Colores y sus Correspondencias", "Introducción al Uso de Cristales en Rituales", "Quema de Hierbas Sagradas (Salvia, Romero, Lavanda): Propiedades", "Creación de Sigilos para la Intención Positiva", "Uso Básico del Péndulo para Respuestas Simples", "Introducción a la Lectura del Tarot con Enfoque Intuitivo", "Creación de Agua de Luna/Sol", "Elaboración de Aceites de Unción Rituales", "Uso de Nudos en la Magia (Cord Magic)", "Creación de Bolsitas de Hechizos (Mojo Bags)", "Interpretación de Señales y Sincronicidades", "El Poder de la Intención Focalizada en Rituales", "La Importancia de la Visualización Creativa", "Llevar un Diario Mágico o Libro de Sombras (Positivo)",
            // Rituales Específicos y Otros
            "Ritual para Fomentar la Creatividad", "Hechizo para Mejorar la Concentración en Estudios/Trabajo", "Ritual para Bendecir un Nuevo Hogar", "Hechizo para Encontrar Objetos Perdidos", "Ritual para Tener Sueños Tranquilos y Reparadores", "Fomentar la Paciencia y la Calma Interior", "Ritual de Gratitud General por la Vida", "Hechizo para Fortalecer la Intuición", "Ritual Sencillo antes de un Evento Importante (Entrevista, Examen)", "Bendición de Alimentos antes de Comer", "Ritual para Atraer Buena Suerte General", "Desarrollar Habilidades Psíquicas (Meditación)", "Ritual de Año Nuevo para Establecer Intenciones", "Celebración Personal de Cumpleaños con Intención Mágica", "Crear un Espacio Sagrado Personal",
            // (Se añadieron más títulos para ser exhaustivos)
            "Ritual de Carga de Cristales bajo la Luna Llena", "Invocación de los Cuatro Arcángeles para Guía", "Baño de Florecimiento para Atraer Energías Positivas", "Hechizo de Nudo para Liberar Preocupaciones", "Crear un Talismán Personalizado con Sigilos", "Ritual para Potenciar la Clarividencia con Amatista", "Limpieza de Aura con Agua de Rosas", "Hechizo con Vela Naranja para el Éxito y la Motivación", "Ritual para Aumentar la Confianza en uno Mismo", "Meditación de los Chakras para Equilibrio Energético", "Ritual de Conexión con Ancestros Positivos", "Hechizo de Protección para Redes Sociales/Internet", "Crear un Spray de Ambiente Purificador (Agua, Alcohol, Aceites Esenciales)", "Ritual para Atraer la Calma en Momentos de Caos", "Bendición de Semillas antes de Plantar en el Jardín", "Hechizo Simple para la Felicidad con Manzanilla", "Ritual de Agradecimiento al Elemento Agua", "Protección contra Pesadillas con Bolsa de Hierbas", "Ritual para Fomentar la Comunicación Honesta", "Hechizo de la Llave para Abrir Caminos", "Ritual de Celebración de Logros Personales", "Consagración de un Espejo para Auto-reflexión", "Hechizo con Cuarzo Ahumado para Anclaje y Realidad", "Ritual para Bendecir Herramientas de Trabajo/Estudio", "Crear Polvo de Hadas (Glitter ecológico + intención) para Alegría", "Ritual para la Fertilidad (Creativa o Física, con intención clara)", "Hechizo de Reconciliación Pacífica (si es ético y deseado por ambas partes)", "Ritual para Entender Mensajes de Sueños", "Meditación con Sonido de Cuencos Tibetanos", "Ritual para Liberar la Ira de Forma Constructiva",
            // (Se continua añadiendo hasta cerca de 400, el botón 'Generar Más' ayuda)
            // ... (aproximadamente 200+ títulos más siguiendo las categorías)
        ];
        const whiteMagicThemes = [
            "rituales de protección", "limpieza energética", "sanación emocional", "amor propio", "prosperidad y abundancia", "rituales lunares", "magia con velas", "uso de cristales", "hierbas mágicas", "conexión elemental", "purificación del hogar", "rituales de gratitud", "manifestación positiva", "consagración de herramientas", "círculo mágico", "meditación guiada mágica", "rituales de Sabbat", "rituales de Esbat", "amuletos y talismanes", "agua de luna/sol", "sigilos positivos", "ética en la magia", "intuición y psiquismo", "sueños y magia", "bendiciones generales", "rituales con los 4 elementos", "magia de cocina (Kitchen Witchery)", "baños rituales", "aceites mágicos", "polvos y sales rituales"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un guía espiritual y practicante experimentado de magia blanca y tradiciones paganas éticas. Describe el ritual o concepto mágico proporcionado de manera clara, respetuosa y detallada. Explica el propósito, los materiales sugeridos (con alternativas), los pasos a seguir, el simbolismo involucrado, la importancia de la intención clara y positiva, y consideraciones éticas cruciales (ej: no manipulación, respeto al libre albedrío). Enfatiza la seguridad y el empoderamiento personal. El objetivo es una guía informativa y segura de aproximadamente 1200-1300 palabras. Basa tu explicación *únicamente* en el siguiente ritual o concepto:",
            timeoutSeconds: 180
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un consejero espiritual ético y conocedor, enfocado *exclusivamente* en el ritual de magia blanca descrito. Responde preguntas sobre variaciones seguras, simbolismo profundo de los elementos, mejores momentos astrológicos/lunares, alternativas si no se tienen ciertos materiales, o cómo integrar la intención personal. Mantén siempre una perspectiva ética, positiva y respetuosa.",
            timeoutSeconds: 50
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de ideas para un compendio de rituales de magia blanca. Genera exactamente 40 títulos o conceptos específicos para rituales enfocados en protección, sanación, amor propio, prosperidad, limpieza, conexión espiritual y otros fines positivos y éticos. Evita cualquier connotación negativa o dañina. Devuelve *solo* la lista, un ítem por línea, sin números, guiones, introducciones ni conclusiones.",
            timeoutSeconds: 60
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        const gameCanvas = document.getElementById('loading-game-canvas');
        const gameCtx = gameCanvas.getContext('2d');
        const loadingInstructions = document.getElementById('loading-instructions');
        const loadingScoreDisplay = document.getElementById('loading-score');

        // ========== State Variables ==========
        let currentRitualTitle = null;
        let gameLoopId = null;
        let isGameRunning = false;

        // ========== MINIGAME LOGIC - Altar Harmony ==========
        const altarGameConfig = {
            itemSize: 35,
            itemTypes: ['candle', 'crystal', 'herb', 'water', 'feather', 'salt'],
            itemIcons: { candle: '\uf6cb', crystal: '\uf3a5', herb: '\uf55a', water: '\uf043', feather: '\uf52d', salt: '\ue542' }, // Make sure \ue542 is a valid salt/bowl icon in FA6 Free
            itemColors: { candle: '#FFEC8B', crystal: '#ADD8E6', herb: '#90EE90', water: '#87CEFA', feather: '#E0E0E0', salt: '#F5F5DC' }, // Adjusted feather/salt colors
            altarItemY: gameCanvas.height - 50,
            spawnY: -30,
            fallSpeed: 1.5,
            spawnInterval: 1800,
            timeLimitPerItem: 4000,
            scorePerMatch: 15,
            scorePenaltyMiss: -5,
            levelUpScore: 100,
            speedIncreasePerLevel: 0.2,
            spawnIntervalDecreasePerLevel: 150,
            timeLimitDecreasePerLevel: 200,
        };

        let currentItem = null;
        let altarItemsLayout = [];
        let gameScore = 0;
        let gameLevel = 1;
        let currentFallSpeed = altarGameConfig.fallSpeed;
        let currentSpawnInterval = altarGameConfig.spawnInterval;
        let currentTimeLimit = altarGameConfig.timeLimitPerItem;
        let spawnTimerId = null;
        let particleEffectPool = [];

        function setupAltarLayout() {
            altarItemsLayout = [];
            const totalItems = altarGameConfig.itemTypes.length;
            // Ensure canvas has valid dimensions before calculating layout
            if (gameCanvas.width <= 0 || gameCanvas.height <= 0) {
                 console.warn("Canvas dimensions not ready for layout.");
                 // Use default width if needed, or wait for resize event
                 const tempWidth = gameCanvas.width || 400; // Use attribute width as fallback
                 const spacing = (tempWidth - (totalItems * altarGameConfig.itemSize)) / (totalItems + 1);
                 altarGameConfig.itemTypes.forEach((type, index) => {
                    altarItemsLayout.push({ type, x: spacing + index * (altarGameConfig.itemSize + spacing), y: altarGameConfig.altarItemY, width: altarGameConfig.itemSize, height: altarGameConfig.itemSize });
                });
                return; // Exit if dimensions are not valid
            }
            const spacing = (gameCanvas.width - (totalItems * altarGameConfig.itemSize)) / (totalItems + 1);
             if (spacing < 5) { // Check for potential overlap if canvas too small
                  console.warn("Canvas too small for item layout, items might overlap.");
              }
            altarGameConfig.itemTypes.forEach((type, index) => {
                altarItemsLayout.push({
                    type: type,
                    x: spacing + index * (altarGameConfig.itemSize + spacing),
                    y: altarGameConfig.altarItemY,
                    width: altarGameConfig.itemSize,
                    height: altarGameConfig.itemSize
                });
            });
        }

        function resetAltarGame() {
            currentItem = null;
            gameScore = 0;
            gameLevel = 1;
            currentFallSpeed = altarGameConfig.fallSpeed;
            currentSpawnInterval = altarGameConfig.spawnInterval;
            currentTimeLimit = altarGameConfig.timeLimitPerItem;
            if (spawnTimerId) clearTimeout(spawnTimerId);
            spawnTimerId = null;
            loadingScoreDisplay.textContent = `Armonía: 0 | Nivel: 1`;
            setupAltarLayout();
            console.log("Altar Game Reset");
        }

        function spawnNewItem() {
            if (!isGameRunning) return;
            const randomType = getRandomElement(altarGameConfig.itemTypes);
            currentItem = {
                type: randomType,
                x: Math.random() * (gameCanvas.width - altarGameConfig.itemSize),
                y: altarGameConfig.spawnY,
                spawnTime: Date.now()
            };
            if (spawnTimerId) clearTimeout(spawnTimerId);
            spawnTimerId = setTimeout(spawnNewItem, currentSpawnInterval);
        }

        // *** CORRECTED handleCanvasClick ***
        function handleCanvasClick(event) {
            if (!isGameRunning || !currentItem) return;

            const rect = gameCanvas.getBoundingClientRect();

             // --- SCALING CORRECTION ---
             // Calculate the scale factors based on the actual rendered size vs. the canvas internal resolution
             const scaleX = gameCanvas.width / rect.width;
             const scaleY = gameCanvas.height / rect.height;

             // Calculate the click coordinates relative to the canvas's internal coordinate system
             const clickX = (event.clientX - rect.left) * scaleX;
             const clickY = (event.clientY - rect.top) * scaleY;
             // --- END SCALING CORRECTION ---

            // console.log(`Click Event: client(${event.clientX}, ${event.clientY}), rect(${rect.left.toFixed(2)}, ${rect.top.toFixed(2)}), scale(${scaleX.toFixed(2)}, ${scaleY.toFixed(2)}), Canvas Coords: (${clickX.toFixed(2)}, ${clickY.toFixed(2)})`); // Debugging logs

            let matched = false;
            altarItemsLayout.forEach(altarItem => {
                 // console.log(`Checking Altar Item: ${altarItem.type} at (${altarItem.x.toFixed(2)}, ${altarItem.y.toFixed(2)}) w:${altarItem.width}, h:${altarItem.height}`); // Debugging logs
                // Check if the SCALED click coordinates are within the altar item's bounds
                if (clickX >= altarItem.x && clickX <= altarItem.x + altarItem.width &&
                    clickY >= altarItem.y && clickY <= altarItem.y + altarItem.height) {

                    // console.log(`Clicked within bounds of Altar Item: ${altarItem.type}`); // Debugging logs

                    if (altarItem.type === currentItem.type) {
                        // Correct Match!
                        // console.log(`CORRECT MATCH! Clicked ${altarItem.type}, Current item is ${currentItem.type}`); // Debugging logs
                        gameScore += altarGameConfig.scorePerMatch;
                        createParticleEffect(altarItem.x + altarItem.width / 2, altarItem.y + altarItem.height / 2);
                        currentItem = null; // Remove matched item
                        if (spawnTimerId) clearTimeout(spawnTimerId);
                        spawnTimerId = setTimeout(spawnNewItem, 300); // Spawn next quickly
                        checkAltarLevelUp();
                        matched = true;
                    } else {
                        // Incorrect Match
                        // console.log(`INCORRECT MATCH! Clicked ${altarItem.type}, Current item is ${currentItem.type}`); // Debugging logs
                        gameScore = Math.max(0, gameScore + altarGameConfig.scorePenaltyMiss);
                    }
                    // Update score display immediately after a click check (correct or incorrect)
                    loadingScoreDisplay.textContent = `Armonía: ${gameScore} | Nivel: ${gameLevel}`;
                }
            });

            // Note: The score display update was moved inside the loop for immediate feedback on incorrect clicks too.
            // If no match was found after checking all items, no score update happens here (only if item times out/falls off).
        }


        function createParticleEffect(x, y) {
            const particleCount = 5;
            const parentRect = gameCanvas.getBoundingClientRect(); // Get bounds relative to viewport
             // Get scroll offsets
             const scrollX = window.scrollX || window.pageXOffset;
             const scrollY = window.scrollY || window.pageYOffset;

            for (let i = 0; i < particleCount; i++) {
                 let particle = particleEffectPool.find(p => !p.parentElement);
                 if (!particle) {
                     particle = document.createElement('div');
                     particle.className = 'particle';
                     particleEffectPool.push(particle);
                 }
                // Calculate position relative to the document, including canvas position and scroll offset
                 const particleX = parentRect.left + scrollX + x + (Math.random() - 0.5) * 10;
                 const particleY = parentRect.top + scrollY + y + (Math.random() - 0.5) * 10;

                 particle.style.left = `${particleX}px`;
                 particle.style.top = `${particleY}px`;

                 // Ensure particle is added to the body to be positioned absolutely relative to the document
                 document.body.appendChild(particle);

                 setTimeout(() => {
                     if (particle.parentElement) {
                         particle.remove();
                     }
                 }, 600);
            }
        }


        function checkAltarLevelUp() {
            const nextLevelThreshold = gameLevel * altarGameConfig.levelUpScore;
            if (gameScore >= nextLevelThreshold) {
                gameLevel++;
                currentFallSpeed = Math.min(5, altarGameConfig.fallSpeed + (gameLevel - 1) * altarGameConfig.speedIncreasePerLevel);
                currentSpawnInterval = Math.max(500, altarGameConfig.spawnInterval - (gameLevel - 1) * altarGameConfig.spawnIntervalDecreasePerLevel);
                currentTimeLimit = Math.max(1500, altarGameConfig.timeLimitPerItem - (gameLevel - 1) * altarGameConfig.timeLimitDecreasePerLevel);
                console.log(`Altar Level Up! Lvl: ${gameLevel}, Speed: ${currentFallSpeed.toFixed(1)}, Interval: ${currentSpawnInterval}, Limit: ${currentTimeLimit}`);
                 gameCanvas.style.boxShadow = `0 0 20px ${['#a7c957', '#e0aaff', '#ffb703'][gameLevel % 3]}`;
                 setTimeout(() => { gameCanvas.style.boxShadow = '0 0 15px rgba(167, 201, 87, 0.4)'; }, 400);
                 // Update score display immediately on level up too
                 loadingScoreDisplay.textContent = `Armonía: ${gameScore} | Nivel: ${gameLevel}`;
            }
        }

        function updateAltarGame() {
            if (!isGameRunning || !currentItem) return;

            currentItem.y += currentFallSpeed;

            const timeElapsed = Date.now() - currentItem.spawnTime;
            if (currentItem.y > gameCanvas.height || timeElapsed > currentTimeLimit) {
                // console.log(`Item missed or timed out: ${currentItem.type}`); // Debugging
                gameScore = Math.max(0, gameScore + altarGameConfig.scorePenaltyMiss);
                loadingScoreDisplay.textContent = `Armonía: ${gameScore} | Nivel: ${gameLevel}`; // Update score display on miss
                currentItem = null;
                if (spawnTimerId) clearTimeout(spawnTimerId);
                 spawnTimerId = setTimeout(spawnNewItem, currentSpawnInterval);
            }
        }

        function drawAltarGame() {
            if (!isGameRunning || !gameCtx) return;

            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

            // Draw Altar Base
            gameCtx.fillStyle = '#e0e0e0';
            gameCtx.fillRect(0, gameCanvas.height - 60, gameCanvas.width, 60);
             gameCtx.strokeStyle = '#bdbdbd';
             gameCtx.lineWidth = 2;
             gameCtx.strokeRect(0, gameCanvas.height - 60, gameCanvas.width, 60);

            // Draw Altar Items (Static)
             // *** CRUCIAL: Set font properties BEFORE drawing text ***
             gameCtx.font = `${altarGameConfig.itemSize}px "Font Awesome 6 Free"`; // Use the correct Font Awesome 6 class name if needed
             gameCtx.textAlign = 'center';
             gameCtx.textBaseline = 'middle';

            altarItemsLayout.forEach(item => {
                gameCtx.fillStyle = altarGameConfig.itemColors[item.type] || '#cccccc';
                // Ensure icon code is correct and font loaded
                try {
                     gameCtx.fillText(altarGameConfig.itemIcons[item.type], item.x + item.width / 2, item.y + item.height / 2);
                 } catch (e) {
                     console.error(`Error drawing icon ${item.type} (${altarGameConfig.itemIcons[item.type]}):`, e);
                     gameCtx.fillStyle = 'red'; // Draw red square if icon fails
                     gameCtx.fillRect(item.x, item.y, item.width, item.height);
                 }
            });

            // Draw Current Falling Item
            if (currentItem) {
                 // *** Set font properties AGAIN before drawing the falling item ***
                 gameCtx.font = `${altarGameConfig.itemSize}px "Font Awesome 6 Free"`;
                 gameCtx.textAlign = 'center';
                 gameCtx.textBaseline = 'middle';
                 gameCtx.fillStyle = altarGameConfig.itemColors[currentItem.type] || '#000000';
                 try {
                     gameCtx.fillText(altarGameConfig.itemIcons[currentItem.type], currentItem.x + altarGameConfig.itemSize / 2, currentItem.y + altarGameConfig.itemSize / 2);
                 } catch (e) {
                     console.error(`Error drawing falling icon ${currentItem.type} (${altarGameConfig.itemIcons[currentItem.type]}):`, e);
                     gameCtx.fillStyle = 'red';
                     gameCtx.fillRect(currentItem.x, currentItem.y, altarGameConfig.itemSize, altarGameConfig.itemSize);
                 }

                 // Time bar
                 const timeRatio = Math.max(0, 1 - (Date.now() - currentItem.spawnTime) / currentTimeLimit);
                 gameCtx.fillStyle = timeRatio > 0.3 ? '#66bb6a' : '#ef5350'; // Green / Red
                 gameCtx.fillRect(currentItem.x, currentItem.y + altarGameConfig.itemSize + 2, altarGameConfig.itemSize * timeRatio, 4); // Slightly thicker bar
            }
        }


        function altarGameLoop() {
            if (!isGameRunning) return;
            updateAltarGame();
            drawAltarGame();
            gameLoopId = requestAnimationFrame(altarGameLoop);
        }

        function startAltarGameLoop() {
            if (isGameRunning) return;
             // Ensure canvas context is valid
             if (!gameCtx) {
                 console.error("Canvas context not available for game.");
                 // Show spinner as fallback?
                 const spinner = modalLoadingIndicator.querySelector('.loading-spinner-modal');
                 if(spinner) spinner.classList.remove('content-hidden');
                 return;
             }
            console.log("Starting Altar Game Loop");
            isGameRunning = true;
            resetAltarGame();
            gameCanvas.addEventListener('click', handleCanvasClick);
            spawnNewItem();
            gameLoopId = requestAnimationFrame(altarGameLoop);
            modalLoadingIndicator.classList.add('active');
            gameCanvas.style.display = 'block';
             // Hide fallback spinner if it was shown
             const spinner = modalLoadingIndicator.querySelector('.loading-spinner-modal');
             if(spinner) spinner.classList.add('content-hidden');
        }

        function stopAltarGameLoop() {
            if (!isGameRunning) return;
            console.log("Stopping Altar Game Loop");
            isGameRunning = false;
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            if (spawnTimerId) clearTimeout(spawnTimerId);
            gameLoopId = null;
            spawnTimerId = null;
            gameCanvas.removeEventListener('click', handleCanvasClick);
             particleEffectPool.forEach(p => { if(p.parentElement) p.remove(); });
        }

        // ========== API FUNCTIONS ==========
         async function fetchTextFromApi(prompt, config, isChat = false) {
              const encodedPrompt = encodeURIComponent(prompt);
              const systemPromptToUse = isChat && currentRitualTitle
                  ? `Eres un consejero espiritual ético enfocado exclusivamente en el ritual '${currentRitualTitle}'. Responde preguntas sobre sus variaciones seguras, simbolismo, o alternativas. Mantén siempre una perspectiva ética y positiva.`
                  : config.systemPrompt;
              const encodedSystem = encodeURIComponent(systemPromptToUse);
              const params = new URLSearchParams({ model: config.model, system: encodedSystem });
              if (config.seed && !isChat) params.append('seed', config.seed);

              const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
              console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
              const controller = new AbortController();
              const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
              try {
                  const response = await fetch(url, { signal: controller.signal });
                  clearTimeout(timeoutId);
                  if (!response.ok) {
                      throw new Error(`(Error ${response.status}) Nuestros servidores energéticos están sobrecargados. Por favor, respira profundo e intenta de nuevo en unos momentos.`);
                  }
                  const text = await response.text();
                  if (!text || text.trim().length < (isChat ? 15 : 600)) {
                      throw new Error("La respuesta de la guía fue muy breve o vacía. Intenta con otra intención o reformula.");
                  }
                  console.log(`API Response received (${text.length} chars)`);
                  return text;
              } catch (error) {
                  clearTimeout(timeoutId);
                  console.error("API Fetch Error:", error);
                  if (error.name === 'AbortError') {
                      throw new Error(`La conexión espiritual tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión terrenal o vuelve más tarde.`);
                  }
                  throw new Error(error.message || "Ocurrió una interferencia inesperada al canalizar la información.");
              }
          }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentRitualTitle) throw new Error("Error interno: No se ha sintonizado con el ritual actual para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(whiteMagicThemes) || "rituales de magia blanca general";
             const specificPrompt = `Genera 40 títulos o ideas específicas para rituales de magia blanca éticos y positivos, relacionados con ${randomTheme}`;
             console.log("Generating 40 titles with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                  .then(text => {
                      const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150 && !line.toLowerCase().includes("aquí tienes") && !line.toLowerCase().includes("lista de ideas")).slice(0, 40);
                      if (titles.length < 15) { console.warn("Generated fewer titles than expected:", titles.length); throw new Error("La inspiración no fluyó lo suficiente para generar bastantes rituales válidos."); }
                      return titles;
                  });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "white magic ritual setting";
             const enhancedPrompt = `Serene and beautiful digital painting, representing a white magic ritual concept: '${safePromptText}'. Focus on soft glowing light, natural elements (herbs, crystals, candles maybe), ethereal atmosphere, positive energy. Pastel colors, maybe watercolour style. Avoid dark, scary, or overly complex elements. Symbolic and abstract is okay.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "dark magic, blood, sacrifice, scary, evil, demonic, cluttered, chaotic, text, words, labels, signature, watermark, photorealistic face";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
          }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText){ if(!rawText)return'';let formatted=rawText.trim();formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1');formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('−','-');return`${base}<sup>${cleanExponent}</sup>`;});formatted=formatted.replace(/\\rightarrow/g,'&rarr;');formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>');const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0);formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block;let content=block.replace(/\n/g,' ');return`<p>${content}</p>`;}).join('');return formatted;}

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            stopAltarGameLoop();
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             stopAltarGameLoop();
             modalLoadingIndicator.classList.remove('active');
             modalStoryContentArea.classList.remove('visible');
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentRitualTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ==========
        function showFullscreenImage(imgSrc){if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden';}
        function hideFullscreenImage(){if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src='';}

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender){const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        function addChatError(message){const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        async function handleSendMessage(){const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Guía IA: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}}

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title) {const div=document.createElement('div');div.className='title-item';div.textContent=title;div.setAttribute('data-title',title);div.addEventListener('click',()=>handleTitleClick(title));return div;}
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» Aún no se han revelado rituales. Intenta generar más. «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
             console.log(`Displayed ${sortedTitles.length} ritual titles.`);
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             console.log(`Appending ${newTitles.length} new ritual titles.`);
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Successfully added ${addedCount} unique ritual titles.`);
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick for Altar Harmony Game ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentRitualTitle = title;
            chatHistory.innerHTML = '';

            // *** START LOADING & ALTAR HARMONY GAME ***
            modalLoadingIndicator.classList.add('active');
            startAltarGameLoop(); // Iniciar el juego del altar

            try {
                const ritualPromise = fetchExplanationText(title);
                const imageUrl = createPollinationsImageUrl(title);
                const rawExplanationText = await ritualPromise;

                // *** STOP GAME & SHOW CONTENT ***
                stopAltarGameLoop();
                modalLoadingIndicator.classList.remove('active');
                modalStoryContentArea.classList.add('visible');
                modalStoryContentArea.classList.remove('content-hidden');

                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalContent.innerHTML = formattedExplanation;
                modalTextArea.scrollTop = 0;

                // Image Handling
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Canalizando imagen...</p>`;
                modalContent.appendChild(placeholderDiv);

                if (imageUrl) {
                    const imgElement = document.createElement('img');
                    imgElement.className = 'final-image';
                    imgElement.alt = `Representación simbólica de ${title}`;
                    imgElement.style.display = 'none';
                    imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                    imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">La visualización no pudo completarse.</p>`; };
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-times-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                // *** STOP GAME & SHOW ERROR ***
                stopAltarGameLoop();
                modalLoadingIndicator.classList.remove('active');
                modalStoryContentArea.classList.add('visible');
                modalStoryContentArea.classList.remove('content-hidden');

                modalErrorMessage.textContent = error.message || "Error desconocido al consultar el ritual.";
                modalError.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando Oráculos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Pide 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("La inspiración no ha revelado más rituales por ahora."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar rituales: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Revelar 40 Rituales Más';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             // Ajustar lógica de no-results para mostrar si no hay items VISIBLES
             const anyVisible = titleListContainer.querySelector('.title-item:not(.hidden)');
             noResultsMsg.classList.toggle('hidden', !!anyVisible || titleListContainer.children.length === 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !gameCanvas || !loadingScoreDisplay || !gameCtx) {
                console.error("Initialization failed: Missing essential elements or canvas context.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error de Círculo: Faltan componentes esenciales o el canvas no se inicializó.</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            // Setup initial layout for the game even if not started,
            // in case canvas dimensions are set by CSS initially.
            setupAltarLayout();
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>