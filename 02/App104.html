<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Plataforma AI v4 (con Spinner)</title>
    <style>
        /* Fuentes */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600&display=swap');

        /* --- Variables CSS (Temas Predefinidos) --- */
        :root, body.theme-cyberpunk { /* Tema por defecto: Cyberpunk Neon */
            --bg-color: #0a0a18;
            --bg-gradient-start: #0f0f1a;
            --bg-gradient-end: #1a1a2e;
            --container-bg: rgba(26, 26, 46, 0.85);
            --primary-color: #00ffff; /* Cyan */
            --secondary-color: #ff00ff; /* Magenta */
            --accent-glow: rgba(0, 255, 255, 0.6);
            --accent-glow-secondary: rgba(255, 0, 255, 0.5);
            --text-color: #e0e0e0;
            --text-muted-color: #a0a0c0;
            --input-bg: #1f1f3a;
            --border-color: #3a3a5e;
            --prompt-border-color: var(--primary-color);
            --error-color: #ff4d4d;
            --success-color: #4dff4d;
            --tab-bg: #1a1a2e;
            --tab-active-bg: var(--primary-color);
            --tab-active-text: #000;
            --scrollbar-thumb: var(--primary-color);
            --scrollbar-track: var(--input-bg);
        }

        body.theme-space { /* Tema: Minimalista Espacial */
            --bg-color: #101018;
            --bg-gradient-start: #181828;
            --bg-gradient-end: #080810;
            --container-bg: rgba(30, 30, 50, 0.9);
            --primary-color: #a0a0ff; /* Azul claro */
            --secondary-color: #f0f0f0; /* Blanco */
            --accent-glow: rgba(160, 160, 255, 0.5);
            --accent-glow-secondary: rgba(240, 240, 240, 0.3);
            --text-color: #f0f0f0;
            --text-muted-color: #b0b0b0;
            --input-bg: #252535;
            --border-color: #404055;
            --prompt-border-color: var(--primary-color);
            --error-color: #ff6666;
            --success-color: #66ff66;
            --tab-bg: #252535;
            --tab-active-bg: var(--primary-color);
            --tab-active-text: #101018;
            --scrollbar-thumb: var(--primary-color);
            --scrollbar-track: var(--input-bg);
        }

        body.theme-oceanic { /* Tema: Oceanic */
            --bg-color: #051a2e;
            --bg-gradient-start: #0b2a45;
            --bg-gradient-end: #03101b;
            --container-bg: rgba(11, 42, 69, 0.9);
            --primary-color: #20c0f0; /* Azul Agua */
            --secondary-color: #90f0ff; /* Azul Claro */
            --accent-glow: rgba(32, 192, 240, 0.6);
            --accent-glow-secondary: rgba(144, 240, 255, 0.4);
            --text-color: #e0f8ff;
            --text-muted-color: #a0c0d0;
            --input-bg: #103a5c;
            --border-color: #1a5a8a;
            --prompt-border-color: var(--primary-color);
            --error-color: #ff7070;
            --success-color: #70ffb0;
            --tab-bg: #103a5c;
            --tab-active-bg: var(--primary-color);
            --tab-active-text: #051a2e;
            --scrollbar-thumb: var(--primary-color);
            --scrollbar-track: var(--input-bg);
        }

        body.theme-forest { /* Tema: Forest */
            --bg-color: #102010;
            --bg-gradient-start: #183018;
            --bg-gradient-end: #081808;
            --container-bg: rgba(24, 48, 24, 0.9);
            --primary-color: #60d060; /* Verde Bosque */
            --secondary-color: #d0f0a0; /* Verde Claro */
            --accent-glow: rgba(96, 208, 96, 0.6);
            --accent-glow-secondary: rgba(208, 240, 160, 0.4);
            --text-color: #e8f8e8;
            --text-muted-color: #b0d0b0;
            --input-bg: #204820;
            --border-color: #306030;
            --prompt-border-color: var(--primary-color);
            --error-color: #ff8080;
            --success-color: #80ff80;
            --tab-bg: #204820;
            --tab-active-bg: var(--primary-color);
            --tab-active-text: #102010;
            --scrollbar-thumb: var(--primary-color);
            --scrollbar-track: var(--input-bg);
        }

        body.theme-sunset { /* Tema: Sunset */
            --bg-color: #201030;
            --bg-gradient-start: #401840;
            --bg-gradient-end: #180820;
            --container-bg: rgba(48, 24, 64, 0.9);
            --primary-color: #ff8040; /* Orange */
            --secondary-color: #ffc060; /* Light Orange/Yellow */
            --accent-glow: rgba(255, 128, 64, 0.6);
            --accent-glow-secondary: rgba(255, 64, 64, 0.5); /* Reddish glow */
            --text-color: #f8f0f0;
            --text-muted-color: #c0a0b0;
            --input-bg: #402048;
            --border-color: #603068;
            --prompt-border-color: var(--primary-color);
            --error-color: #ff6060;
            --success-color: #ffa060;
            --tab-bg: #402048;
            --tab-active-bg: var(--primary-color);
            --tab-active-text: #201030;
            --scrollbar-thumb: var(--primary-color);
            --scrollbar-track: var(--input-bg);
        }

        body.theme-matrix { /* Tema: Matrix */
            --bg-color: #000800;
            --bg-gradient-start: #001800;
            --bg-gradient-end: #000000;
            --container-bg: rgba(0, 24, 0, 0.9);
            --primary-color: #00ff00; /* Bright Green */
            --secondary-color: #a0ffa0; /* Lighter Green */
            --accent-glow: rgba(0, 255, 0, 0.6);
            --accent-glow-secondary: rgba(160, 255, 160, 0.4);
            --text-color: #c0ffc0;
            --text-muted-color: #80c080;
            --input-bg: #002000;
            --border-color: #004000;
            --prompt-border-color: var(--primary-color);
            --error-color: #ff4040;
            --success-color: #80ff80;
            --tab-bg: #002000;
            --tab-active-bg: var(--primary-color);
            --tab-active-text: #000800;
            --scrollbar-thumb: var(--primary-color);
            --scrollbar-track: var(--input-bg);
        }

        body.theme-desert { /* Tema: Desert */
            --bg-color: #f0e8d8;
            --bg-gradient-start: #f8f0e0;
            --bg-gradient-end: #e8d8c8;
            --container-bg: rgba(232, 216, 200, 0.9);
            --primary-color: #c08040; /* Brown */
            --secondary-color: #60a0d0; /* Sky Blue */
            --accent-glow: rgba(192, 128, 64, 0.5);
            --accent-glow-secondary: rgba(96, 160, 208, 0.4);
            --text-color: #403020; /* Dark Brown Text */
            --text-muted-color: #806050;
            --input-bg: #e0d0c0;
            --border-color: #d0b8a8;
            --prompt-border-color: var(--primary-color);
            --error-color: #d04040;
            --success-color: #40a040;
            --tab-bg: #e0d0c0;
            --tab-active-bg: var(--primary-color);
            --tab-active-text: #f0e8d8;
            --scrollbar-thumb: var(--primary-color);
            --scrollbar-track: var(--input-bg);
        }

        body.theme-arctic { /* Tema: Arctic */
            --bg-color: #e8f0f8;
            --bg-gradient-start: #f0f8ff;
            --bg-gradient-end: #d8e8f0;
            --container-bg: rgba(216, 232, 240, 0.9);
            --primary-color: #40a0e0; /* Ice Blue */
            --secondary-color: #80c0f0; /* Lighter Blue */
            --accent-glow: rgba(64, 160, 224, 0.5);
            --accent-glow-secondary: rgba(176, 208, 240, 0.4);
            --text-color: #102030; /* Dark Blue/Gray Text */
            --text-muted-color: #507090;
            --input-bg: #d0e0f0;
            --border-color: #b0c8e0;
            --prompt-border-color: var(--primary-color);
            --error-color: #e06060;
            --success-color: #60c080;
            --tab-bg: #d0e0f0;
            --tab-active-bg: var(--primary-color);
            --tab-active-text: #e8f0f8;
            --scrollbar-thumb: var(--primary-color);
            --scrollbar-track: var(--input-bg);
        }

        body.theme-volcanic { /* Tema: Volcanic */
            --bg-color: #180808;
            --bg-gradient-start: #301010;
            --bg-gradient-end: #080000;
            --container-bg: rgba(48, 16, 16, 0.9);
            --primary-color: #ff4000; /* Bright Orange/Red */
            --secondary-color: #ff8040; /* Orange */
            --accent-glow: rgba(255, 64, 0, 0.6);
            --accent-glow-secondary: rgba(255, 128, 64, 0.5);
            --text-color: #f8e8e0;
            --text-muted-color: #c0a090;
            --input-bg: #401818;
            --border-color: #602020;
            --prompt-border-color: var(--primary-color);
            --error-color: #ff6060;
            --success-color: #ffA060;
            --tab-bg: #401818;
            --tab-active-bg: var(--primary-color);
            --tab-active-text: #180808;
            --scrollbar-thumb: var(--primary-color);
            --scrollbar-track: var(--input-bg);
        }

        /* --- Estilos Base --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; padding: 20px;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            transition: background 0.5s ease, color 0.5s ease;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; transition: background 0.3s ease; }
        ::-webkit-scrollbar-thumb:hover { background: var(--secondary-color); }

        /* Contenedor, Título, Pestañas */
        .container { background-color: var(--container-bg); padding: 25px 35px; border-radius: 15px; border: 1px solid var(--border-color); box-shadow: 0 0 30px rgba(0, 0, 0, 0.6), 0 0 15px var(--accent-glow), 0 0 10px var(--accent-glow-secondary); width: 100%; max-width: 1100px; backdrop-filter: blur(8px); transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease; }
        h1 { font-family: 'Orbitron', sans-serif; color: var(--primary-color); text-align: center; margin-bottom: 15px; text-shadow: 0 0 10px var(--accent-glow), 0 0 5px var(--accent-glow-secondary); letter-spacing: 1.5px; font-size: 2.2em; }
        .tabs { display: flex; justify-content: center; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); }
        .tab-button { padding: 10px 20px; cursor: pointer; background-color: var(--tab-bg); border: 1px solid var(--border-color); border-bottom: none; color: var(--text-muted-color); font-family: 'Orbitron', sans-serif; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease; border-radius: 8px 8px 0 0; margin: 0 5px -1px 5px; }
        .tab-button.active { background-color: var(--tab-active-bg); color: var(--tab-active-text); font-weight: bold; box-shadow: 0 -4px 8px -4px var(--accent-glow); border-color: var(--primary-color); }
        .tab-button:not(.active):hover { background-color: var(--input-bg); color: var(--primary-color); }
        .tab-content { display: none; padding-top: 20px; animation: fadeIn 0.5s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Contenido Principal y Layout */
        .main-content { display: flex; flex-wrap: wrap; gap: 30px; }
        .controls { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 18px; }
        .output { flex: 1.5; min-width: 350px; display: flex; flex-direction: column; align-items: center; background-color: rgba(0,0,0,0.1); padding: 20px; border-radius: 10px; border: 1px solid var(--border-color); }

        /* Controles */
        .control-group { display: flex; flex-direction: column; }
        .control-row { display: flex; align-items: center; gap: 10px; }
        .control-row label { margin-bottom: 0; flex-basis: 60px; flex-shrink: 0;}
        .control-row input[type="range"] { flex-grow: 1; }
        .control-row input[type="number"] { width: 80px; text-align: center; flex-shrink: 0;}
        .seed-group { display: flex; align-items: center; gap: 10px; }
        .seed-group input { flex-grow: 1; }
        .seed-group button { padding: 8px 10px; font-size: 1.1em; flex-shrink: 0; line-height: 1; }
        .prompt-group { position: relative; }
        .prompt-group button { position: absolute; right: 12px; bottom: 12px; padding: 5px 8px; font-size: 0.8em; z-index: 5;}
        label { font-weight: 600; margin-bottom: 8px; color: var(--primary-color); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; display: block; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 10px 14px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-family: 'Poppins', sans-serif; font-size: 0.95em; transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease; }
        textarea { min-height: 100px; resize: vertical; }
        #prompt { border-width: 2px; border-color: var(--prompt-border-color); box-shadow: 0 0 12px -2px color-mix(in srgb, var(--prompt-border-color) 50%, transparent); font-size: 1.05em; padding: 12px 15px; }
        #prompt:focus { border-color: color-mix(in srgb, var(--prompt-border-color) 70%, white); box-shadow: 0 0 15px 0px color-mix(in srgb, var(--prompt-border-color) 60%, transparent); }
        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 8px var(--accent-glow); }
        input[type="range"] { width: 100%; cursor: pointer; height: 8px; background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); border-radius: 5px; -webkit-appearance: none; appearance: none; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--text-color); border-radius: 50%; border: 2px solid var(--input-bg); cursor: pointer; transition: background 0.2s ease; }
        input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; background: var(--text-color); border-radius: 50%; border: 2px solid var(--input-bg); cursor: pointer; transition: background 0.2s ease; }
        input[type="range"]:hover::-webkit-slider-thumb { background: var(--primary-color); }
        input[type="range"]:hover::-moz-range-thumb { background: var(--primary-color); }

        /* Plantillas de Tamaño */
        .size-templates { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
        .size-template-button { padding: 5px 10px; font-size: 0.8em; background-color: var(--input-bg); color: var(--text-muted-color); border: 1px solid var(--border-color); border-radius: 5px; cursor: pointer; transition: all 0.2s ease; font-family: 'Poppins', sans-serif; }
        .size-template-button:hover { border-color: var(--primary-color); color: var(--primary-color); transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Botones */
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        button { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 0.9em; font-weight: 700; transition: all 0.2s ease; text-transform: uppercase; letter-spacing: 1px; background-color: var(--input-bg); color: var(--primary-color); border: 1px solid var(--primary-color); flex-grow: 1; }
        button:hover { background-color: rgba(0, 255, 255, 0.1); box-shadow: 0 0 10px var(--accent-glow); transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; }
        button.primary-action { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: #fff; border: none; box-shadow: 0 0 10px var(--accent-glow), 0 0 5px var(--accent-glow-secondary); }
        button.primary-action:hover { background: linear-gradient(45deg, color-mix(in srgb, var(--primary-color) 90%, white), color-mix(in srgb, var(--secondary-color) 90%, white)); box-shadow: 0 0 15px var(--accent-glow), 0 0 10px var(--accent-glow-secondary); }
        button.small-button { padding: 6px 10px; font-size: 0.8em; flex-grow: 0; }

        /* Parámetros Avanzados */
        #advanced-toggle { margin-top: 10px; }
        #advanced-params { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border-color); }
        #advanced-params.visible { display: flex; flex-direction: column; gap: 15px; }

        /* Theme Selector Group */
        .theme-selector-group { margin-top: 15px; padding: 15px; background-color: rgba(0,0,0,0.1); border-radius: 8px; border: 1px dashed var(--border-color); }
        .theme-selector { display: flex; align-items: center; gap: 10px; }
        .theme-selector label { margin-bottom: 0; flex-shrink: 0;}
        .theme-selector select { flex-grow: 1;}

        /* Output Area */
        h2 { font-family: 'Orbitron', sans-serif; color: var(--secondary-color); margin-bottom: 15px; font-weight: 400; letter-spacing: 1px; text-shadow: 0 0 8px var(--accent-glow-secondary); }
        #image-container { margin-top: 5px; width: 100%; max-width: 512px; aspect-ratio: 1 / 1; background-color: rgba(0,0,0,0.3); border-radius: 10px; display: flex; justify-content: center; align-items: center; overflow: hidden; border: 1px dashed var(--border-color); position: relative; transition: aspect-ratio 0.3s ease; }
        #generated-image { display: block; max-width: 100%; max-height: 100%; height: auto; width: auto; object-fit: contain; border-radius: 8px; opacity: 1; transition: opacity 0.5s ease-in-out; }
        #generated-image.loading { opacity: 0.3; }

        /* --- Loading Indicator con Spinner --- */
        #loading-indicator {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            color: var(--primary-color);
            font-size: 1.1em;
            text-shadow: 0 0 5px var(--accent-glow);
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 12px 20px;
            border-radius: 8px;
            text-align: center;
            /* Usar flex para alinear spinner y texto */
            display: flex;
            align-items: center;
            gap: 10px; /* Espacio entre spinner y texto */
        }
        /* Controlar visibilidad con JS */
        #loading-indicator:not(.visible) {
            display: none;
        }
        #loading-indicator.visible {
            display: flex; /* Mostrar como flex cuando esté visible */
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid color-mix(in srgb, var(--primary-color) 30%, transparent); /* Pista más clara */
            border-top-color: var(--primary-color); /* Color del spinner */
            border-radius: 50%;
            display: inline-block;
            animation: spin 1s linear infinite;
            flex-shrink: 0; /* Evitar que se encoja */
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* --- Fin Loading Indicator --- */

        #error-message { color: var(--error-color); text-align: center; margin-top: 10px; font-weight: 600; display: none; font-size: 0.9em; }
        #status-message { color: var(--success-color); text-align: center; margin-top: 10px; font-weight: 600; display: none; font-size: 0.9em; height: 1.2em; }
        #current-params-display { font-size: 0.8em; margin-top: 15px; padding: 10px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-muted-color); max-width: 90%; word-wrap: break-word; text-align: center; }
        #current-params-display strong { color: var(--primary-color); }
        #output-actions { display: flex; gap: 10px; margin-top: 15px; justify-content: center; width: 100%; max-width: 512px; }
        #image-url-container { margin-top: 15px; width: 100%; max-width: 512px; }
        #image-url-container label { font-size: 0.8em; display: block; margin-bottom: 5px; text-align: center;}
        #image-url { font-family: 'Courier New', Courier, monospace; background-color: var(--input-bg); padding: 8px 10px; border-radius: 5px; word-break: break-all; font-size: 0.85em; border: 1px solid var(--border-color); color: var(--text-muted-color); display: block; min-height: 3em; line-height: 1.4; text-align: center; }

        /* Historial y Favoritos */
        .list-section { max-height: 60vh; overflow-y: auto; padding-right: 10px; display: flex; flex-direction: column; gap: 15px; }
        .list-item { display: flex; align-items: center; gap: 15px; background-color: var(--input-bg); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .list-item:hover { border-color: var(--primary-color); box-shadow: 0 0 8px -2px var(--accent-glow); }
        .list-item img.thumbnail { width: 64px; height: 64px; object-fit: cover; border-radius: 5px; flex-shrink: 0; border: 1px solid var(--border-color); }
        .list-item-info { flex-grow: 1; font-size: 0.9em; overflow: hidden; }
        .list-item-info p { margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item-info p strong { color: var(--primary-color); }
        .list-item-info .prompt-text { font-style: italic; color: var(--text-muted-color); max-width: 95%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; }
        .list-item-info .params-text { font-size: 0.85em; color: var(--text-muted-color); }
        .list-item-actions { display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
        .list-item-actions button { font-size: 0.8em; padding: 5px 8px; width: 80px; text-align: center;}
        .empty-list-message { text-align: center; color: var(--text-muted-color); font-style: italic; margin-top: 30px; }

        /* Responsividad */
        @media (max-width: 900px) { .container { padding: 20px; } .main-content { flex-direction: column; } .output { margin-top: 30px; } .list-item { flex-direction: column; align-items: flex-start; } .list-item-actions { flex-direction: row; margin-top: 10px; width: 100%; justify-content: flex-end;} .list-item-actions button { width: auto; } }
        @media (max-width: 600px) { h1 { font-size: 1.8em; } .tabs { justify-content: flex-start; overflow-x: auto; } .tab-button { padding: 8px 12px; font-size: 0.8em;} .controls, .output { min-width: unset; } #image-container { max-width: 100%; } #output-actions, #image-url-container { max-width: 100%; } input, select, textarea, button:not(.small-button) { font-size: 0.9em; } .control-row label { flex-basis: 50px; font-size: 0.8em;} .control-row input[type="number"] { width: 65px; } .button-group { flex-direction: column; } .size-templates { justify-content: center; } }

    </style>
</head>
<body> <!-- Theme class applied by JS -->
    <div class="container">
        <h1>SUPER PLATAFORMA AI v4</h1>

        <!-- Pestañas -->
        <div class="tabs">
            <button class="tab-button active" data-tab="generator">Generador</button>
            <button class="tab-button" data-tab="history">Historial</button>
            <button class="tab-button" data-tab="favorites">Favoritos</button>
        </div>

        <!-- Contenido Pestaña Generador -->
        <div id="generator-tab" class="tab-content active">
            <div class="main-content">
                <div class="controls">

                    <div class="control-group prompt-group">
                        <label for="prompt">Prompt (Descripción):</label>
                        <textarea id="prompt" placeholder="Ej: A bioluminescent forest at night, fantasy art" required>A beautiful landscape</textarea>
                        <button id="random-prompt-button" class="small-button" title="Generar Prompt Aleatorio">💡 Idea</button>
                    </div>

                     <div class="control-group">
                        <label>Plantillas de Tamaño:</label>
                        <div class="size-templates" id="size-templates-container">
                             <button class="size-template-button" data-width="1080" data-height="1080">Insta Post (1:1)</button>
                             <button class="size-template-button" data-width="1080" data-height="1350">Insta Port (4:5)</button>
                             <button class="size-template-button" data-width="1080" data-height="1920">Story/TikTok (9:16)</button>
                             <button class="size-template-button" data-width="1920" data-height="1080">YouTube (16:9)</button>
                             <button class="size-template-button" data-width="1024" data-height="1024">Default (1024)</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <div class="control-row">
                             <label for="width">Ancho:</label>
                            <input type="range" id="width-slider" value="1024" min="64" max="2048" step="64">
                            <input type="number" id="width-number" value="1024" min="64" max="2048" step="64">
                         </div>
                    </div>
                    <div class="control-group">
                         <div class="control-row">
                             <label for="height">Alto:</label>
                            <input type="range" id="height-slider" value="1024" min="64" max="2048" step="64">
                            <input type="number" id="height-number" value="1024" min="64" max="2048" step="64">
                        </div>
                    </div>
                    <div class="control-group">
                        <label for="seed">Seed (Semilla):</label>
                         <div class="seed-group">
                            <input type="number" id="seed" placeholder="Aleatorio si vacío" min="0">
                            <button id="random-seed-button" title="Generar Seed Aleatorio">🎲</button>
                        </div>
                        <small>Cada seed genera una variación diferente.</small>
                    </div>
                    <div class="control-group">
                        <label for="model">Modelo:</label>
                        <select id="model">
                            <option value="flux" selected>Flux</option>
                            <option value="turbo">Turbo</option>
                            <option value="stable_diffusion">Stable Diffusion</option>
                            <option value="dall-e-3">DALL-E 3</option>
                             <option value="">(API Default)</option>
                        </select>
                    </div>

                    <!-- Advanced Params -->
                     <button id="advanced-toggle" class="small-button">Avanzado ▼</button>
                    <div id="advanced-params">
                        <div class="control-group">
                             <label for="negative-prompt">Negative Prompt:</label>
                            <textarea id="negative-prompt" placeholder="Ej: blurry, low quality, text, signature"></textarea>
                        </div>
                         <small>Parámetros avanzados dependen del modelo/API.</small>
                    </div>

                    <!-- Theme Selector Group -->
                     <div class="theme-selector-group control-group">
                         <label>Apariencia Visual:</label>
                         <div class="theme-selector">
                            <label for="theme-select">Tema:</label>
                            <select id="theme-select">
                                <option value="theme-cyberpunk">Cyberpunk Neon</option>
                                <option value="theme-space">Minimalista Espacial</option>
                                <option value="theme-oceanic">Oceanic</option>
                                <option value="theme-forest">Forest</option>
                                <option value="theme-sunset">Sunset</option>
                                <option value="theme-matrix">Matrix</option>
                                <option value="theme-desert">Desert</option>
                                <option value="theme-arctic">Arctic</option>
                                <option value="theme-volcanic">Volcanic</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="button-group">
                       <button id="generate-button" class="primary-action">Generar Imagen</button>
                       <button id="generate-variation-button">Nueva Variación (Seed Aleat.)</button>
                    </div>
                     <div class="button-group">
                         <button id="copy-prompt-button" class="small-button">Copiar Prompt</button>
                     </div>

                </div>

                <div class="output">
                    <h2>Vista Previa</h2>
                    <div id="image-container">
                        <img id="generated-image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Imagen Generada" >
                         <div id="loading-indicator"> <!-- Controlado por JS (.visible) -->
                             <div class="spinner"></div> <!-- Spinner añadido -->
                             CARGANDO...
                         </div>
                    </div>
                    <div id="error-message">Error al cargar. Verifica parámetros o la API.</div>
                     <div id="status-message"></div>
                     <div id="current-params-display">Parámetros aparecerán aquí...</div>
                    <div id="output-actions">
                        <button id="favorite-button" class="small-button" title="Guardar en Favoritos" disabled>⭐ Añadir Fav</button>
                        <button id="copy-url-button" class="small-button" title="Copiar URL de la Imagen" disabled>🔗 Copiar URL</button>
                    </div>
                    <div id="image-url-container">
                        <label for="image-url">URL Generada:</label>
                        <code id="image-url">Haz clic en "Generar Imagen"...</code>
                    </div>
                </div>
            </div>
        </div><!-- Fin Pestaña Generador -->

        <!-- Contenido Pestaña Historial -->
        <div id="history-tab" class="tab-content">
            <h2>Historial de Sesión (Últimas 10)</h2>
            <div id="history-list" class="list-section"> <p class="empty-list-message">Aún no has generado imágenes.</p> </div>
        </div>

        <!-- Contenido Pestaña Favoritos -->
        <div id="favorites-tab" class="tab-content">
            <h2>Favoritos Guardados</h2>
             <button id="clear-favorites-button" class="small-button" style="margin-bottom: 15px;">Limpiar Todos</button>
            <div id="favorites-list" class="list-section"> <p class="empty-list-message">No tienes favoritos guardados.</p> </div>
        </div>

    </div>

    <script>
        // --- Constants ---
        const BASE_API_URL = "https://image.pollinations.ai/prompt/";
        const MAX_HISTORY_ITEMS = 10;
        const DEFAULT_THEME = 'theme-cyberpunk';
        const LS_THEME_KEY = 'ai_platform_theme_v4';
        const LS_FAVORITES_KEY = 'ai_platform_favorites_v4';

        // --- State Variables ---
        let history = [];
        let favorites = [];
        let currentGenerationData = null;
        let isGenerating = false;

        // --- DOM Elements ---
        const body = document.body;
        const themeSelect = document.getElementById('theme-select');
        const sizeTemplatesContainer = document.getElementById('size-templates-container');
        const promptInput = document.getElementById('prompt');
        const randomPromptButton = document.getElementById('random-prompt-button');
        const widthSlider = document.getElementById('width-slider');
        const widthNumber = document.getElementById('width-number');
        const heightSlider = document.getElementById('height-slider');
        const heightNumber = document.getElementById('height-number');
        const seedInput = document.getElementById('seed');
        const randomSeedButton = document.getElementById('random-seed-button');
        const modelSelect = document.getElementById('model');
        const generateButton = document.getElementById('generate-button');
        const generateVariationButton = document.getElementById('generate-variation-button');
        const copyPromptButton = document.getElementById('copy-prompt-button');
        const advancedToggle = document.getElementById('advanced-toggle');
        const advancedParamsDiv = document.getElementById('advanced-params');
        const negativePromptInput = document.getElementById('negative-prompt');
        const generatedImage = document.getElementById('generated-image');
        const imageContainer = document.getElementById('image-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const statusMessage = document.getElementById('status-message');
        const currentParamsDisplay = document.getElementById('current-params-display');
        const imageUrlDisplay = document.getElementById('image-url');
        const favoriteButton = document.getElementById('favorite-button');
        const copyUrlButton = document.getElementById('copy-url-button');
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const historyList = document.getElementById('history-list');
        const favoritesList = document.getElementById('favorites-list');
        const clearFavoritesButton = document.getElementById('clear-favorites-button');

        // Prompt Ideas
        const promptSubjects = ["A majestic castle", "A futuristic cityscape", "A serene forest", "A lonely astronaut", "A mythical creature", "A bioluminescent flower", "An underwater city", "A steampunk airship", "A cute robot pet", "A cosmic nebula"];
        const promptStyles = ["pixel art", "photorealistic", "watercolor painting", "cyberpunk style", "anime art", "fantasy illustration", "vintage poster", "low poly", "cinematic lighting", "impressionist"];
        const promptSettings = ["at sunset", "in the rain", "on an alien planet", "during a meteor shower", "under a full moon", "in a post-apocalyptic world", "covered in snow", "floating in space", "hidden in clouds", "glowing with magic"];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            loadFavorites();
            setupEventListeners();
            syncSlidersAndNumbers();
            displayHistory();
            displayFavorites();
            seedInput.value = Math.floor(Math.random() * 100000);
        });

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            themeSelect.addEventListener('change', handleThemeChange);
            sizeTemplatesContainer.addEventListener('click', handleSizeTemplateClick);
            tabs.forEach(tab => { tab.addEventListener('click', () => switchTab(tab.dataset.tab)); });
            widthSlider.addEventListener('input', () => syncSlidersAndNumbers('slider', 'width'));
            widthNumber.addEventListener('input', () => syncSlidersAndNumbers('number', 'width'));
            heightSlider.addEventListener('input', () => syncSlidersAndNumbers('slider', 'height'));
            heightNumber.addEventListener('input', () => syncSlidersAndNumbers('number', 'height'));
            randomSeedButton.addEventListener('click', setRandomSeed);
            randomPromptButton.addEventListener('click', generateRandomPrompt);
            generateButton.addEventListener('click', () => triggerGeneration(false));
            generateVariationButton.addEventListener('click', () => triggerGeneration(true));
            copyPromptButton.addEventListener('click', copyPrompt);
            advancedToggle.addEventListener('click', toggleAdvancedParams);
            favoriteButton.addEventListener('click', toggleFavorite);
            copyUrlButton.addEventListener('click', copyUrl);
            generatedImage.onload = handleImageLoadSuccess;
            generatedImage.onerror = handleImageLoadError;
            historyList.addEventListener('click', handleListAction);
            favoritesList.addEventListener('click', handleListAction);
            clearFavoritesButton.addEventListener('click', clearAllFavorites);
        }

        // --- Theme Handling ---
        function initializeTheme() {
            const savedTheme = localStorage.getItem(LS_THEME_KEY) || DEFAULT_THEME;
            const isValidTheme = Array.from(themeSelect.options).some(opt => opt.value === savedTheme);
            const themeToApply = isValidTheme ? savedTheme : DEFAULT_THEME;
            themeSelect.value = themeToApply;
            body.className = themeToApply;
        }

        function handleThemeChange() {
            const selectedTheme = themeSelect.value;
            localStorage.setItem(LS_THEME_KEY, selectedTheme);
            body.className = selectedTheme;
        }

        // --- Size Templates ---
        function handleSizeTemplateClick(event) {
            if (event.target.classList.contains('size-template-button')) {
                const button = event.target;
                const width = button.dataset.width; const height = button.dataset.height;
                if (width && height) {
                    widthNumber.value = width; heightNumber.value = height;
                    syncSlidersAndNumbers('number', 'width'); syncSlidersAndNumbers('number', 'height');
                    // Visual feedback (optional)
                    [widthNumber, heightNumber].forEach(el => {
                        el.style.transition = 'background-color 0.1s ease';
                        el.style.backgroundColor = 'var(--primary-color)';
                        setTimeout(() => { el.style.backgroundColor = ''; }, 150);
                    });
                }
            }
        }

        // --- Tab Switching ---
        function switchTab(targetTabId) {
            tabContents.forEach(content => { content.classList.remove('active'); });
            tabs.forEach(button => { button.classList.remove('active'); });
            document.getElementById(`${targetTabId}-tab`).classList.add('active');
            document.querySelector(`.tab-button[data-tab="${targetTabId}"]`).classList.add('active');
        }

        // --- Control Helpers ---
        function syncSlidersAndNumbers(source, dimension) {
            const slider = document.getElementById(`${dimension}-slider`); const number = document.getElementById(`${dimension}-number`);
            if (source === 'slider') { number.value = slider.value; }
            else { let val = parseInt(number.value, 10); const min = parseInt(slider.min, 10); const max = parseInt(slider.max, 10); if (isNaN(val)) val = slider.value; val = Math.max(min, Math.min(max, val)); number.value = val; slider.value = val; }
        }
        function setRandomSeed() { seedInput.value = Math.floor(Math.random() * 1000000000); }
        function generateRandomPrompt() { const subject = promptSubjects[Math.floor(Math.random() * promptSubjects.length)]; const style = promptStyles[Math.floor(Math.random() * promptStyles.length)]; const setting = promptSettings[Math.floor(Math.random() * promptSettings.length)]; promptInput.value = `${subject}, ${setting}, ${style}`; promptInput.focus(); promptInput.dispatchEvent(new Event('input')); }
        function toggleAdvancedParams() { const isVisible = advancedParamsDiv.classList.toggle('visible'); advancedToggle.textContent = isVisible ? 'Avanzado ▲' : 'Avanzado ▼'; }
        function copyToClipboard(text, message) { navigator.clipboard.writeText(text).then(() => { showStatusMessage(message || 'Copiado!', 'success'); }).catch(err => { console.error('Error al copiar: ', err); showStatusMessage('Error al copiar', 'error'); }); }
        function copyPrompt() { copyToClipboard(promptInput.value, 'Prompt copiado!'); }
        function copyUrl() { if (currentGenerationData && currentGenerationData.url) { copyToClipboard(currentGenerationData.url, 'URL copiada!'); } }
        function showStatusMessage(message, type = 'success') { statusMessage.textContent = message; statusMessage.style.color = type === 'error' ? 'var(--error-color)' : 'var(--success-color)'; statusMessage.style.display = 'block'; setTimeout(() => { statusMessage.style.display = 'none'; }, 3000); }

        // --- Image Generation Logic ---
        function triggerGeneration(isVariation = false) {
            if (isGenerating) return;
            const prompt = promptInput.value.trim();
            if (!prompt) { alert("Introduce un prompt."); promptInput.focus(); return; }
            if (isVariation) { setRandomSeed(); }

            showLoadingState(); // Muestra spinner y texto

            const params = getGenerationParameters();
            const apiUrl = buildApiUrl(params);
            imageUrlDisplay.textContent = apiUrl;
            currentGenerationData = { ...params, url: apiUrl, timestamp: Date.now() };

            setTimeout(() => {
                generatedImage.src = apiUrl; // Inicia carga
                if (params.width && params.height && params.height > 0) { imageContainer.style.aspectRatio = `${params.width} / ${params.height}`; }
                else { imageContainer.style.aspectRatio = '1 / 1'; }
            }, 50);
            console.log("Iniciando generación:", currentGenerationData);
        }
        function getGenerationParameters() {
            const seedValue = seedInput.value.trim();
            return {
                prompt: promptInput.value.trim(),
                width: parseInt(widthNumber.value, 10),
                height: parseInt(heightNumber.value, 10),
                seed: (seedValue !== "" && /^\d+$/.test(seedValue)) ? seedValue : undefined,
                model: modelSelect.value || undefined,
                negative_prompt: advancedParamsDiv.classList.contains('visible') ? negativePromptInput.value.trim() || undefined : undefined
            };
        }
        function buildApiUrl(params) {
            const encodedPrompt = encodeURIComponent(params.prompt);
            let url = `${BASE_API_URL}${encodedPrompt}`;
            const queryParams = new URLSearchParams();
            if (params.width && params.width >= 64) queryParams.append('width', params.width);
            if (params.height && params.height >= 64) queryParams.append('height', params.height);
            if (params.seed !== undefined) queryParams.append('seed', params.seed);
            if (params.model) queryParams.append('model', params.model);
            if (params.negative_prompt) queryParams.append('negative_prompt', params.negative_prompt);
            const queryString = queryParams.toString();
            if (queryString) { url += `?${queryString}`; }
            return url;
        }
        function showLoadingState() {
            isGenerating = true;
            loadingIndicator.classList.add('visible'); // Muestra spinner + texto
            errorMessage.style.display = 'none';
            statusMessage.style.display = 'none';
            generateButton.disabled = true;
            generateVariationButton.disabled = true;
            generatedImage.classList.add('loading'); // Atenúa imagen vieja/placeholder
            generatedImage.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; // Placeholder
            favoriteButton.disabled = true;
            copyUrlButton.disabled = true;
            currentParamsDisplay.textContent = 'Generando...';
        }
        function finalizeLoadingState(success = true) {
            isGenerating = false;
            loadingIndicator.classList.remove('visible'); // Oculta spinner + texto
            generateButton.disabled = false;
            generateVariationButton.disabled = false;
            generatedImage.classList.remove('loading'); // Quita atenuación

            if (success && currentGenerationData) {
                favoriteButton.disabled = false;
                copyUrlButton.disabled = false;
                updateCurrentParamsDisplay(currentGenerationData);
                updateFavoriteButtonState();
            } else {
                currentParamsDisplay.textContent = success ? 'Listo.' : 'Error.';
                if (!success) {
                    generatedImage.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; // Placeholder on error
                    imageUrlDisplay.textContent = 'Error al cargar.';
                }
            }
        }
        function updateCurrentParamsDisplay(data) {
             let displayText = `<strong>Prompt:</strong> ${data.prompt.substring(0, 50)}${data.prompt.length > 50 ? '...' : ''}`;
             displayText += ` | <strong>Size:</strong> ${data.width}x${data.height}`;
             if (data.seed !== undefined) displayText += ` | <strong>Seed:</strong> ${data.seed}`;
             if (data.model) displayText += ` | <strong>Model:</strong> ${data.model}`;
             if (data.negative_prompt) displayText += ` | <strong>Neg:</strong> ${data.negative_prompt.substring(0, 20)}...`;
             currentParamsDisplay.innerHTML = displayText;
        }
        function handleImageLoadSuccess() {
            console.log("Imagen cargada OK:", generatedImage.src);
            finalizeLoadingState(true); // Oculta spinner, activa botones, etc.
            errorMessage.style.display = 'none';
            if (currentGenerationData) { addToHistory(currentGenerationData); }
        }
        function handleImageLoadError() {
            console.error("Error al cargar imagen:", generatedImage.src);
            finalizeLoadingState(false); // Oculta spinner, muestra error
            errorMessage.textContent = `Error al cargar URL. Verifica consola o API.`;
            errorMessage.style.display = 'block';
            currentGenerationData = null;
        }

        // --- History ---
        function addToHistory(item) { history.unshift(item); if (history.length > MAX_HISTORY_ITEMS) { history.pop(); } displayHistory(); }
        function displayHistory() {
            historyList.innerHTML = '';
            if (history.length === 0) { historyList.innerHTML = '<p class="empty-list-message">Historial de sesión vacío.</p>'; return; }
            history.forEach((item, index) => { historyList.appendChild(createListItem(item, index, 'history')); });
        }

        // --- Favorites ---
        function loadFavorites() { const stored = localStorage.getItem(LS_FAVORITES_KEY); if (stored) { try { favorites = JSON.parse(stored); } catch (e) { console.error("Error parsing favorites:", e); favorites = []; } } else { favorites = []; } displayFavorites(); }
        function saveFavorites() { try { localStorage.setItem(LS_FAVORITES_KEY, JSON.stringify(favorites)); } catch (e) { console.error("Error saving favorites:", e); alert("No se pudieron guardar favoritos."); } }
        function isFavorite(itemToCompare) { if (!itemToCompare) return false; return favorites.some(fav => fav.url === itemToCompare.url); }
        function updateFavoriteButtonState() { if (currentGenerationData && isFavorite(currentGenerationData)) { favoriteButton.textContent = '❤️ Quitar Fav'; favoriteButton.title = 'Quitar de Favoritos'; } else { favoriteButton.textContent = '⭐ Añadir Fav'; favoriteButton.title = 'Guardar en Favoritos'; } favoriteButton.disabled = !currentGenerationData; }
        function toggleFavorite() { if (!currentGenerationData) return; const idx = favorites.findIndex(fav => fav.url === currentGenerationData.url); if (idx > -1) { favorites.splice(idx, 1); showStatusMessage('Quitado de favoritos', 'info'); } else { favorites.unshift({ ...currentGenerationData }); showStatusMessage('Añadido a favoritos!', 'success'); } saveFavorites(); displayFavorites(); updateFavoriteButtonState(); }
        function displayFavorites() { favoritesList.innerHTML = ''; clearFavoritesButton.style.display = favorites.length > 0 ? 'inline-block' : 'none'; if (favorites.length === 0) { favoritesList.innerHTML = '<p class="empty-list-message">No tienes favoritos.</p>'; return; } favorites.forEach((item, index) => { favoritesList.appendChild(createListItem(item, index, 'favorites')); }); }
        function removeFromFavorites(index) { if (index >= 0 && index < favorites.length) { favorites.splice(index, 1); saveFavorites(); displayFavorites(); updateFavoriteButtonState(); showStatusMessage('Favorito eliminado.', 'info'); } }
        function clearAllFavorites() { if (confirm("¿Eliminar TODOS los favoritos?")) { favorites = []; saveFavorites(); displayFavorites(); updateFavoriteButtonState(); showStatusMessage('Favoritos eliminados.', 'info'); } }

        // --- Common List Item Creation & Handling ---
        function createListItem(item, index, listType) {
            const li = document.createElement('li'); li.classList.add('list-item'); li.dataset.index = index; li.dataset.listType = listType;
            const img = document.createElement('img'); img.src = item.url; img.alt = `Thumb: ${item.prompt.substring(0,30)}...`; img.classList.add('thumbnail'); img.onerror = (e) => { e.target.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='50' font-size='12' fill='%23aaa' text-anchor='middle' dy='.3em'%3EError%3C/text%3E%3C/svg%3E"; };
            const infoDiv = document.createElement('div'); infoDiv.classList.add('list-item-info');
            const promptP = document.createElement('p'); promptP.innerHTML = `<strong>Prompt:</strong> <span class="prompt-text" title="${item.prompt}">${item.prompt}</span>`;
            const paramsP = document.createElement('p'); paramsP.classList.add('params-text'); paramsP.textContent = `Params: ${item.width}x${item.height} | Seed: ${item.seed ?? 'N/A'} | Model: ${item.model ?? 'N/A'}`; if(item.negative_prompt) paramsP.textContent += ` | Neg: ${item.negative_prompt.substring(0,15)}...`;
            infoDiv.appendChild(promptP); infoDiv.appendChild(paramsP);
            const actionsDiv = document.createElement('div'); actionsDiv.classList.add('list-item-actions');
            const loadButton = document.createElement('button'); loadButton.textContent = 'Cargar'; loadButton.classList.add('load-button', 'small-button'); loadButton.title = 'Cargar parámetros'; actionsDiv.appendChild(loadButton);
            if (listType === 'favorites') { const removeButton = document.createElement('button'); removeButton.textContent = 'Quitar'; removeButton.classList.add('remove-button', 'small-button'); removeButton.title = 'Quitar favorito'; actionsDiv.appendChild(removeButton); }
            li.appendChild(img); li.appendChild(infoDiv); li.appendChild(actionsDiv);
            return li;
        }
        function handleListAction(event) {
             const button = event.target.closest('button'); if (!button) return;
             const listItem = event.target.closest('.list-item'); if (!listItem) return;
             const index = parseInt(listItem.dataset.index, 10); const listType = listItem.dataset.listType;
            if (button.classList.contains('load-button')) { loadParamsFromItem(index, listType); }
            else if (button.classList.contains('remove-button') && listType === 'favorites') { removeFromFavorites(index); }
         }
        function loadParamsFromItem(index, listType) {
             const sourceArray = (listType === 'history') ? history : favorites;
             if (index >= 0 && index < sourceArray.length) {
                 const item = sourceArray[index];
                 promptInput.value = item.prompt || '';
                 widthNumber.value = item.width || 1024; heightNumber.value = item.height || 1024;
                 syncSlidersAndNumbers('number', 'width'); syncSlidersAndNumbers('number', 'height');
                 seedInput.value = item.seed || ''; modelSelect.value = item.model || '';
                 negativePromptInput.value = item.negative_prompt || '';
                 if (item.negative_prompt && !advancedParamsDiv.classList.contains('visible')) { toggleAdvancedParams(); }
                 else if (!item.negative_prompt && advancedParamsDiv.classList.contains('visible')) { /* Optional: Hide if empty? toggleAdvancedParams(); */ }
                 switchTab('generator');
                 // Important: Clear previous image and show loading *before* setting new src if auto-generating
                 // showLoadingState(); // Uncomment if you want auto-generate on load
                 generatedImage.src = item.url; // Set src (will trigger load/error handlers)
                 imageContainer.style.aspectRatio = `${item.width}/${item.height}`;
                 imageUrlDisplay.textContent = item.url;
                 currentGenerationData = { ...item }; // Set as current data *before* finalizeLoadingState
                 updateCurrentParamsDisplay(item);
                 updateFavoriteButtonState();
                 errorMessage.style.display = 'none';
                 // finalizeLoadingState(true); // Let the onload handler call this
                 showStatusMessage('Parámetros cargados.', 'info');
                 window.scrollTo({ top: 0, behavior: 'smooth' });
             }
         }

    </script>
</body>
</html>