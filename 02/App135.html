<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Química para Principiantes - Conceptos Clave</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Limpias y Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Química Principiante --- */
        :root {
            --color-primary: #0d6efd; /* Azul Estándar (Científico, Estable) */
            --color-secondary: #6c757d; /* Gris Secundario (Neutro) */
            --color-tertiary: #198754; /* Verde (Orgánico, Éxito - uso moderado) */
            --color-background: #f8f9fa; /* Blanco Hueso / Gris Muy Claro (Limpieza) */
            --color-text: #212529; /* Negro Suave (Legibilidad) */
            --color-text-muted: #6c757d; /* Gris para texto secundario */
            --color-modal-bg: #ffffff; /* Blanco Puro (Contenido principal) */
            --color-border: #dee2e6; /* Borde Gris Claro */
            --color-error-bg: #f8d7da; /* Fondo error rosa claro */
            --color-error-text: #58151c; /* Texto error rojo oscuro */
            --color-error-border: #f5c2c7; /* Borde error rosa */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 5px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 500; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alineación a la izquierda */ font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; }
        .title-item i { margin-right: 0.6rem; color: var(--color-primary); width: 18px; text-align: center; } /* Icono para títulos */
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #e7f1ff; } /* Azul muy claro hover */
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #0b5ed7; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #adb5bd; color: #f8f9fa; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(33, 37, 41, 0.75); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e9ecef; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; color: var(--color-text); }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 500; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: #0b5ed7; } /* Azul más oscuro para H3 */
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; background-color: #f8f9fa; /* Fondo claro por si la imagen es transparente */ }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f8f9fa; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; /* Keep left align for readability */ border-bottom-right-radius: 0px; } /* Slight style difference */
        .ai-message { background-color: #e9ecef; color: var(--color-text); margin-right: auto; text-align: left; border-bottom-left-radius: 0px; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #0b5ed7; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 55px; height: 55px; border: 5px solid #dee2e6; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 500; color: var(--color-text); font-size: 1.2rem; font-family: 'Roboto'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(33, 37, 41, 0.9); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); background-color: white; box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-atom mr-2"></i> <!-- Icono átomo -->
                     Química para Principiantes
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">Conceptos Fundamentales Explicados</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-10 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Descubre el Mundo de la Química</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora los bloques de construcción de la materia y cómo interactúan. Selecciona un concepto o busca para empezar a aprender.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar concepto (ej: átomo, enlace iónico, pH)...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-600 mr-2"></i> <!-- Icono libro -->
                 Índice de Conceptos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando conceptos básicos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No se encontraron conceptos que coincidan con tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Más Conceptos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Cargando explicación...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                         <div class="ai-message" style="font-style: italic; font-size: 0.9em;">Hola! ¿Tienes alguna pregunta sobre este concepto?</div>
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Pensando...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregúntame algo más sobre esto...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA para facilitar el aprendizaje de conceptos básicos de química.</p>
              <p class="mt-1">Consulta siempre fuentes académicas para estudios formales.</p>
              <p class="mt-2">© 2025 Guía de Química Básica</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Fundamentos y Definiciones
            "¿Qué es la Química?", "Materia: Definición y Propiedades", "Átomo: La Unidad Básica", "Molécula: Agrupación de Átomos", "Elemento Químico: Sustancia Pura", "Compuesto Químico: Combinación de Elementos", "Mezcla Homogénea", "Mezcla Heterogénea", "Diferencia entre Elemento, Compuesto y Mezcla", "Sustancia Pura vs Mezcla", "Propiedades Físicas de la Materia", "Propiedades Químicas de la Materia", "Cambios Físicos", "Cambios Químicos", "Ley de Conservación de la Masa", "Energía en Química: Introducción",
            // Estados de la Materia
            "Estado Sólido: Características", "Estado Líquido: Características", "Estado Gaseoso: Características", "Plasma: El Cuarto Estado (Introducción)", "Fusión: De Sólido a Líquido", "Solidificación/Congelación: De Líquido a Sólido", "Vaporización/Ebullición: De Líquido a Gas", "Condensación: De Gas a Líquido", "Sublimación: De Sólido a Gas", "Deposición: De Gas a Sólido", "Diagrama de Fases (Concepto Simple)", "Punto de Fusión", "Punto de Ebullición",
            // Estructura Atómica
            "Modelo Atómico de Dalton", "Descubrimiento del Electrón (Thomson)", "Modelo Atómico de Thomson (Budín de Pasas)", "Experimento de Rutherford y el Núcleo", "Modelo Atómico de Rutherford", "Descubrimiento del Protón", "Descubrimiento del Neutrón", "Partículas Subatómicas: Protón, Neutrón, Electrón", "El Núcleo Atómico", "Número Atómico (Z)", "Número Másico (A)", "Isótopos: Átomos del Mismo Elemento con Diferente Masa", "Iones: Átomos con Carga (Cationes y Aniones)", "Niveles de Energía o Capas Electrónicas (Modelo de Bohr)", "Modelo Atómico de Bohr (Introducción)", "Electrones de Valencia", "Configuración Electrónica (Introducción Simple)", "Orbitales Atómicos (Concepto Básico s, p)",
            // Tabla Periódica
            "¿Qué es la Tabla Periódica?", "Historia de la Tabla Periódica (Mendeléyev)", "Organización: Grupos y Períodos", "Lectura de la Información en la Tabla Periódica", "Metales: Propiedades Generales", "No Metales: Propiedades Generales", "Metaloides o Semimetales", "Gases Nobles (Grupo 18)", "Metales Alcalinos (Grupo 1)", "Metales Alcalinotérreos (Grupo 2)", "Halógenos (Grupo 17)", "Elementos de Transición (Bloque d)", "Lantánidos y Actínidos (Bloque f)", "Tendencias Periódicas: Radio Atómico (Concepto)", "Tendencias Periódicas: Energía de Ionización (Concepto)", "Tendencias Periódicas: Electronegatividad (Concepto)", "Carácter Metálico en la Tabla Periódica",
            // Enlaces Químicos
            "¿Por qué se Unen los Átomos? La Regla del Octeto", "Enlace Químico: Definición", "Enlace Iónico: Transferencia de Electrones", "Formación de Compuestos Iónicos (Ej: NaCl)", "Propiedades de los Compuestos Iónicos", "Enlace Covalente: Compartición de Electrones", "Enlace Covalente Simple", "Enlace Covalente Doble", "Enlace Covalente Triple", "Moléculas Diatómicas (H₂, O₂, N₂)", "Estructuras de Lewis (Moléculas Simples)", "Enlace Covalente Polar (Ej: H₂O)", "Enlace Covalente Apolar (Ej: Cl₂)", "Electronegatividad y Polaridad del Enlace", "Moléculas Polares y Apolares", "Fuerzas Intermoleculares (Introducción)", "Puentes de Hidrógeno (Concepto)", "Enlace Metálico (Mar de Electrones)", "Propiedades de los Metales (Conductividad)",
            // Reacciones Químicas
            "¿Qué es una Reacción Química?", "Reactivos y Productos", "Ecuación Química: Representación Simbólica", "Cómo Leer una Ecuación Química", "Balanceo de Ecuaciones Químicas (Método de Tanteo Simple)", "Importancia de Balancear Ecuaciones", "Tipos de Reacciones: Síntesis o Combinación", "Tipos de Reacciones: Descomposición", "Tipos de Reacciones: Desplazamiento Simple", "Tipos de Reacciones: Desplazamiento Doble (Metátesis)", "Tipos de Reacciones: Combustión", "Reacciones de Oxidación-Reducción (Redox - Introducción)", "Agente Oxidante y Agente Reductor (Concepto)", "Número de Oxidación (Concepto Básico)",
            // Ácidos y Bases
            "Propiedades de los Ácidos", "Propiedades de las Bases (Álcalis)", "Definición de Arrhenius (Simple)", "Definición de Brønsted-Lowry (Pares Ácido-Base Conjugados - Intro)", "Ión Hidronio (H₃O⁺)", "Ión Hidróxido (OH⁻)", "La Escala de pH: Medida de Acidez", "pH Neutro (pH = 7)", "pH Ácido (pH < 7)", "pH Básico o Alcalino (pH > 7)", "Indicadores de pH (Papel Tornasol, Fenolftaleína)", "Neutralización: Reacción Ácido-Base", "Formación de Sal y Agua en Neutralización", "Ácidos Fuertes y Débiles (Concepto)", "Bases Fuertes y Débiles (Concepto)", "Lluvia Ácida (Introducción)",
            // Soluciones
            "¿Qué es una Solución?", "Soluto y Solvente", "Solvente Universal: El Agua", "Solubilidad: Capacidad de Disolverse", "Factores que Afectan la Solubilidad (Temperatura, Presión en gases)", "Solución Saturada", "Solución Insaturada", "Solución Sobresaturada", "Concentración de una Solución (Idea General)", "Concentración: Porcentaje en Masa (%)", "Concentración: Porcentaje en Volumen (%)", "Molaridad (M): Moles por Litro (Introducción)", "Dilución: Añadir Solvente", "Electrolitos: Sustancias que Conducen Electricidad en Solución", "No Electrolitos", "Coloides y Suspensiones (Diferencia con Soluciones)",
            // Estequiometría Básica
            "El Mol: Unidad de Cantidad de Sustancia", "Número de Avogadro (6.022 x 10²³)", "Masa Molar: Masa de un Mol de Sustancia", "Cómo Calcular la Masa Molar de un Compuesto", "Conversión entre Moles y Gramos", "Conversión entre Moles y Número de Partículas (Átomos/Moléculas)", "Relaciones Molares en Ecuaciones Químicas Balanceadas", "Cálculos Estequiométricos Simples (Mol a Mol)", "Cálculos Estequiométricos Simples (Masa a Mol, Mol a Masa)", "Reactivo Limitante (Concepto Introductorio)", "Rendimiento Teórico y Real (Concepto)",
            // Termoquímica Básica
            "Energía Cinética y Potencial en Química", "Calor: Transferencia de Energía Térmica", "Temperatura vs Calor", "Reacción Exotérmica: Libera Calor", "Reacción Endotérmica: Absorbe Calor", "Entalpía (H): Contenido de Calor (Concepto)", "Cambio de Entalpía (ΔH)", "ΔH Negativo (Exotérmico)", "ΔH Positivo (Endotérmico)", "Energía de Activación (Concepto)", "Catalizadores: Aceleran Reacciones (Introducción)",
            // Introducción a la Química Orgánica
            "¿Qué es la Química Orgánica?", "El Átomo de Carbono: Base de la Vida", "Capacidad del Carbono para Formar Enlaces", "Hidrocarburos: Compuestos de C y H", "Alcanos: Enlaces Simples (Metano, Etano, Propano)", "Nomenclatura Básica de Alcanos Simples", "Alquenos: Enlaces Dobles (Eteno)", "Alquinos: Enlaces Triples (Etino/Acetileno)", "Isómeros Estructurales (Concepto Simple)", "Grupos Funcionales (Introducción muy básica)", "Alcoholes (-OH)", "Ácidos Carboxílicos (-COOH)", "Polímeros: Moléculas Grandes (Introducción)", "Ejemplos de Polímeros Naturales y Sintéticos",
            // Química y Sociedad / Laboratorio
            "Importancia de la Química en la Vida Diaria", "Química en la Cocina", "Química de los Productos de Limpieza", "Seguridad en el Laboratorio de Química: Reglas Básicas", "Equipo Básico de Laboratorio (Matraz, Vaso de Precipitados, Probeta)", "Uso del Mechero Bunsen", "Medición de Volumen: Probetas y Pipetas", "Medición de Masa: Balanza", "Unidades del Sistema Internacional (SI) en Química", "Notación Científica", "Cifras Significativas (Introducción)", "Precisión vs Exactitud en Medidas", "Método Científico en Química",
            // Conceptos Adicionales Simples
            "Densidad: Masa por Unidad de Volumen", "Presión (Especialmente en Gases)", "Ley de Boyle (Gases - Relación P-V)", "Ley de Charles (Gases - Relación V-T)", "Ley de Avogadro (Gases - Relación V-n)", "Ley del Gas Ideal (PV=nRT - Introducción)", "Mezclas de Gases: Ley de Dalton (Presiones Parciales)", "Equilibrio Químico (Concepto muy básico de reversibilidad)", "Principio de Le Châtelier (Introducción)", "Velocidad de Reacción (Concepto)", "Factores que afectan la Velocidad de Reacción (Temp, Concentración, Superficie)", "Radiactividad (Introducción: Alfa, Beta, Gamma)", "Vida Media (Decaimiento Radiactivo)", "Fisión y Fusión Nuclear (Concepto)", "Química Verde (Principios Básicos)"
        ];
        const chemistryThemes = [
            "fundamentos de química", "estructura atómica", "tabla periódica", "enlaces químicos", "reacciones químicas", "estados de la materia", "ácidos y bases", "soluciones químicas", "estequiometría básica", "termoquímica", "química orgánica introductoria", "seguridad en laboratorio", "mediciones químicas", "historia de la química", "química en la vida cotidiana", "gases ideales", "equilibrio químico básico", "cinética química básica", "química nuclear introductoria"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un profesor(a) de química paciente y experto(a) en explicar conceptos a principiantes. Tu tarea es describir el concepto de química indicado de forma muy clara, sencilla y detallada. Usa analogías simples, ejemplos cotidianos y evita jerga compleja innecesariamente. Explica el 'por qué' detrás del concepto. Incluye: Definición clara, explicación del principio fundamental, ejemplos relevantes, importancia o aplicación, y si aplica, una breve reseña histórica o relación con otros conceptos básicos. El objetivo es una explicación completa y fácil de entender de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente concepto de química:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúa como un asistente de tutoría amigable especializado únicamente en el concepto de química que se está mostrando. Responde preguntas de seguimiento sobre ese concepto específico de forma clara y concisa, manteniendo el nivel principiante.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas para un curso de química básica. Genera exactamente 15 nombres de conceptos, preguntas fundamentales o temas introductorios de química, adecuados para una explicación detallada para principiantes. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Identical structure, names are generic enough)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Scrollable text area
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Text div
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentConceptTitle = null; // Renamed for clarity

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             // *** USE DYNAMIC SYSTEM PROMPT FOR CHAT ***
             const systemPromptToUse = isChat && currentConceptTitle
                 ? `Eres un asistente de tutoría amigable especializado únicamente en el concepto de química llamado '${currentConceptTitle}'. Responde preguntas de seguimiento sobre ese concepto específico de forma clara y concisa, manteniendo el nivel principiante.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     // *** FRIENDLY ERROR MESSAGE ***
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, por favor intenta en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) {
            if (!currentConceptTitle) throw new Error("Error interno: No se estableció el concepto químico para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(chemistryThemes) || "química básica";
            const specificPrompt = `Genera 15 conceptos o preguntas de ${randomTheme} para principiantes`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes conceptos nuevos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 600, height: 450, nologo: true }; // Smaller default image maybe
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "abstract chemistry concept";
             // Prompt ENFOCADO en lo conceptual/abstracto, EVITANDO diagramas complejos o texto.
             const enhancedPrompt = `Abstract conceptual visualization of the chemistry concept: '${safePromptText}'. Simple representation, focus on atoms, molecules, bonds, energy levels, or states of matter symbolically. Clean background, scientific illustration style. Avoid complex diagrams, formulas, text, labels.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, chemical formula, complex diagram, graph, chart, UI, menu, button, watermark, signature, realistic photograph, detailed lab equipment unless specified, messy background";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (No changes needed)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return ''; let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula" style="text-align:center; font-style:italic; margin:1em 0;">$1</p>'); // Style formula slightly
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (No changes needed)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0; console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '<div class="ai-message" style="font-style: italic; font-size: 0.9em;">Hola! ¿Tienes alguna pregunta sobre este concepto?</div>'; // Reset with initial message
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentConceptTitle = null; // Clear context
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (No changes needed)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (No changes needed)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block';
            try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); }
            catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); }
            finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        // *** Add Icon to Title Item ***
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // Basic keyword-based icon assignment
            let iconClass = 'fa-question-circle'; // Default
            const lowerTitle = title.toLowerCase();
            if (lowerTitle.includes('átomo') || lowerTitle.includes('núcleo') || lowerTitle.includes('electrón') || lowerTitle.includes('protón') || lowerTitle.includes('neutrón')) iconClass = 'fa-atom';
            else if (lowerTitle.includes('molécula') || lowerTitle.includes('enlace') || lowerTitle.includes('polaridad')) iconClass = 'fa-share-alt'; // Using share icon for bonding/molecule
            else if (lowerTitle.includes('elemento') || lowerTitle.includes('tabla periódica') || lowerTitle.includes('metal') || lowerTitle.includes('gas noble')) iconClass = 'fa-table-cells';
            else if (lowerTitle.includes('reacción') || lowerTitle.includes('combustión') || lowerTitle.includes('síntesis') || lowerTitle.includes('descomposición')) iconClass = 'fa-flask-vial';
            else if (lowerTitle.includes('ácido') || lowerTitle.includes('base') || lowerTitle.includes('ph')) iconClass = 'fa-flask';
            else if (lowerTitle.includes('solución') || lowerTitle.includes('soluto') || lowerTitle.includes('solvente') || lowerTitle.includes('concentración')) iconClass = 'fa-tint'; // Water drop for solutions
            else if (lowerTitle.includes('estado') || lowerTitle.includes('sólido') || lowerTitle.includes('líquido') || lowerTitle.includes('gas')) iconClass = 'fa-cube'; // Cube for states
            else if (lowerTitle.includes('energía') || lowerTitle.includes('calor') || lowerTitle.includes('termoquímica') || lowerTitle.includes('exotérmica') || lowerTitle.includes('endotérmica')) iconClass = 'fa-fire';
            else if (lowerTitle.includes('orgánica') || lowerTitle.includes('carbono') || lowerTitle.includes('hidrocarburo')) iconClass = 'fa-dna'; // DNA icon for organic
            else if (lowerTitle.includes('mol') || lowerTitle.includes('masa molar') || lowerTitle.includes('estequiometría')) iconClass = 'fa-calculator';
            else if (lowerTitle.includes('laboratorio') || lowerTitle.includes('seguridad') || lowerTitle.includes('medición')) iconClass = 'fa-vial';

            div.innerHTML = `<i class="fas ${iconClass}"></i> ${title}`; // Add icon HTML
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Simple alphabetical sort is fine here
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">No hay conceptos disponibles.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick *** (Main logic unchanged, context variable name change)
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentConceptTitle = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            // chatHistory is reset in resetModalState
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is potentially visible
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-palette placeholder-icon"></i> <!-- Palette icon for conceptual image -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Create image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    // *** ADD CLICK LISTENER FOR FULLSCREEN ***
                    imgElement.addEventListener('click', () => { showFullscreenImage(imgElement.src); });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo generar la imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al crear URL.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Ocurrió un error al cargar la explicación.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** Generate More Titles Handler *** (Error message is friendly via API call)
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más temas...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se encontraron más conceptos para generar en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar conceptos: ${error.message}`); // Display friendly error
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Conceptos';
             }
         }

         // *** Search Filter Function (with normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ========== (No changes needed)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Faltan componentes de la interfaz.</p>';
                return;
             }
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>