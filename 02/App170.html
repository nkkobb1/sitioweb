<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuentos Olvidados - Al Estilo Grimm</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Clásicas/Serif -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Cinzel+Decorative:wght@700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Cuentos Estilo Grimm --- */
        :root {
            --color-primary: #8B4513; /* Marrón Silla de Montar (Madera, Tierra) */
            --color-secondary: #556B2F; /* Verde Oliva Oscuro (Bosque) */
            --color-tertiary: #B8860B; /* Oro Oscuro (Tesoro, Magia) */
            --color-background: #2F4F4F; /* Gris Pizarra Oscuro (Noche, Misterio) */
            --color-text: #F5F5DC; /* Beige (Papiro, Pergamino Claro) */
            --color-text-muted: #D2B48C; /* Canela (Texto Antiguo) */
            --color-modal-bg: #FDF5E6; /* Lino Viejo (Fondo Pergamino) */
            --color-modal-text: #4A2F2F; /* Marrón Oscuro (Tinta) */
            --color-border: #A0522D; /* Siena (Borde Rústico) */
            --color-error-bg: #fef2f2; /* Fondo error Rojo muy claro */
            --color-error-text: #991b1b; /* Texto error Rojo oscuro */
            --color-error-border: #fecaca; /* Borde error Rojo claro */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.25), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lora', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill-rule="evenodd"%3E%3Cg fill="%233a5f5f" fill-opacity="0.1"%3E%3Cpath opacity=".5" d="M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z"/%3E%3Cpath d="M6 5V0H5v5H0v1h5v94h1V6h94V5H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel Decorative', cursive; font-weight: 700; letter-spacing: 1px; }
        .logo { color: var(--color-tertiary); text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); }
        h1.page-title { color: var(--color-text); font-weight: 700; }
        h2.section-title { color: var(--color-tertiary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { font-family: 'Cinzel Decorative', cursive; color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(47, 79, 79, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(245, 245, 220, 0.8); color: var(--color-modal-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); transition: var(--transition-normal); font-family: 'Lora', serif; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: inset 0 1px 3px rgba(0,0,0,0.2), 0 0 0 3px rgba(139, 69, 19, 0.2); outline: none; background-color: var(--color-text); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: rgba(245, 245, 220, 0.85); padding: 1.1rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-modal-text); border: 1px solid var(--color-border); border-left: 3px solid var(--color-tertiary); min-height: 65px; font-family: 'Lora', serif; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: var(--color-text); border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-secondary); color: var(--color-text); padding: 0.7rem 1.4rem; border: 1px solid var(--color-tertiary); border-radius: var(--border-radius); font-family: 'Cinzel Decorative', cursive; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 1.8rem; letter-spacing: 0.5px; box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { background-color: var(--color-tertiary); color: var(--color-modal-text); border-color: var(--color-primary); box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: var(--color-text-muted); color: var(--color-background); border-color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { } /* Spinner color set inline */

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(47, 79, 79, 0.92); /* Dark Slate Gray Overlay */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg); /* Pergamino */
            border: 2px solid var(--color-primary); /* Borde marrón */
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: 1px solid var(--color-primary); border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-modal-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; font-family: serif; line-height: 1;}
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-modal-bg); transform: rotate(90deg); box-shadow: 0 0 8px var(--color-primary); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.4; color: var(--color-primary); }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem; color: var(--color-modal-text); /* Tinta */
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-modal-bg); }

        #modal-content { padding: 0 5px; line-height: 1.8; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel Decorative', cursive; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px dotted var(--color-border); padding-bottom: 0.5em; font-weight: 700; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; background-color: #fff; padding: 3px; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid var(--color-border); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px dashed var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(210, 180, 140, 0.2); /* Tan transparente */ scroll-behavior: smooth; color: var(--color-modal-text);
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95em;}
        .user-message { background-color: var(--color-tertiary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 600; box-shadow: var(--shadow-sm); }
        .ai-message { background-color: var(--color-border); color: var(--color-modal-bg); margin-right: auto; text-align: left; font-weight: 400; box-shadow: var(--shadow-sm); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: var(--color-modal-bg); color: var(--color-modal-text); border-radius: var(--border-radius); font-family: 'Lora', serif; font-size: 0.95rem; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: inset 0 1px 2px rgba(0,0,0,0.1), 0 0 0 2px rgba(139, 69, 19, 0.2); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-modal-bg); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; box-shadow: var(--shadow-sm); }
        #chat-send-btn:hover:not(:disabled) { background-color: #A0522D; } /* Siena */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; box-shadow: none;}
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-style: italic;}
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(253, 245, 230, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-primary); font-size: 1.3rem; font-family: 'Cinzel Decorative'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Lora', serif; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(47, 79, 79, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-tertiary); box-shadow: var(--shadow-lg); background-color: var(--color-modal-bg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-border); border: 1px solid var(--color-tertiary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-modal-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); font-family: serif; line-height: 1; }
        #fullscreen-close-btn:hover { background-color: var(--color-tertiary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-book-dead mr-3"></i> <!-- Icono libro antiguo/Grimorio -->
                     Cuentos Olvidados
                 </h1>
             </div>
             <span class="text-sm text-gray-300 font-serif italic">» Ecos del Bosque Oscuro «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5 text-beige">Historias del Crepúsculo</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light font-serif">Adéntrate en narraciones perdidas, tejidas con hilos de magia oscura y moralejas olvidadas. Elige un título y escucha el eco del pasado...</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar por título o palabra clave...">
             <i class="fas fa-feather-alt fa-search"></i> <!-- Icono pluma/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll text-yellow-600 mr-2"></i> <!-- Icono pergamino -->
                 Índice de Relatos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-serif italic">Desempolvando los archivos del cuentacuentos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-serif italic">» Ningún cuento encontrado con esas palabras en sus páginas «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden" style="color: var(--color-text);"></i> <!-- Color explícito para spinner -->
                     Susurrar Nuevas Historias
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Tejiendo la Trama...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                      <p class="text-sm text-center mb-2 text-gray-600 italic font-serif">Consulta al folklorista sobre este relato:</p>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> El folklorista consulta sus notas...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre personajes, símbolos, moraleja...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-comment-dots"></i> <!-- Icono chat -->
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Ilustración Ampliada del Cuento">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-800 text-gray-400 py-6 mt-12 border-t border-gray-700 font-serif">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Cuentos generados por IA, inspirados en el estilo folclórico de los Hermanos Grimm.</p>
              <p class="mt-1">Las historias son ficticias y creadas para el entretenimiento.</p>
              <p class="mt-2">© MMXCIV Relatos del Bosque Oscuro</p> <!-- Año romano :) -->
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Títulos con Personajes Arquetípicos
            "El Sastre Valiente y el Gigante de Hielo", "La Madrastra Cruel y el Espejo Parlante", "El Príncipe Perdido en el Bosque Embrujado", "La Muchacha del Ganso y la Llave Dorada", "El Hijo del Leñador y el Lobo de Plata", "El Rey Codicioso y el Agua de la Vida", "La Bruja del Pantano y los Tres Enigmas", "El Soldado Desertor y el Violín Mágico", "La Princesa Cautiva en la Torre de Espinas", "El Zapatero Pobre y los Zapatos Danzantes", "La Reina Olvidada y el Anillo de Luna", "El Mercader Astuto y el Demonio del Cruce", "La Hilandera Perezosa y las Tres Parcas", "El Cazador Ciego y el Pájaro de Fuego", "La Molinera Honesta y el Enano Saltarín", "El Niño Robado por las Hadas", "La Doncella Cisne y el Caballero Negro", "El Ermitaño del Bosque y el Secreto de las Raíces", "Los Siete Cuervos y su Hermana Leal", "El Granjero Tonto que Engañó a la Muerte",
            "La Hija del Pescador y el Príncipe Tritón", "El Aprendiz de Mago y el Grimorio Prohibido", "La Pastora que Hablaba con los Vientos", "El Caballero Sin Nombre y la Dama del Lago", "La Anciana del Bosque y la Sopa de Piedra", "El Músico Ambulante y la Flauta Encantada", "Los Tres Hermanos y el Puente del Trol", "La Niña de los Zapatos Rojos", "El Jardinero Real y la Rosa Negra", "La Nodriza Traidora y el Bebé Intercambiado",
            // Títulos con Lugares Evocadores
            "El Secreto del Bosque Silencioso", "La Maldición del Castillo Dormido", "El Misterio del Pozo de los Deseos Seco", "El Camino hacia la Montaña de Cristal", "La Cabaña de Jengibre en el Corazón del Invierno", "El Molino junto al Río Olvidado", "La Ciudad Sumergida bajo el Lago Negro", "El Laberinto del Rey Minotauro (Variante Grimm)", "El Claro de Luna donde Bailan las Hadas", "El Reino Oculto tras la Cascada", "El Cementerio Olvidado y el Guardián Espectral", "La Isla Flotante de los Pájaros Cantores", "El Jardín Prohibido de la Reina Serpiente", "La Taberna del Gato Tuerto y los Viajeros Perdidos", "Las Ruinas del Templo del Sol Poniente", "El Valle de los Ecos Perdidos", "La Cueva del Dragón de Humo", "El Mercado de las Sombras al Anochecer", "El Árbol Anciano que Susurra Profecías", "El Desierto de Ceniza y el Oasis Espejismo",
            "La Torre Inclinada del Astrólogo Loco", "El Pantano de las Luces Fatuas", "El Reino Subterráneo de los Gnomos", "El Puente Hecho de Huesos", "La Aldea Devorada por la Niebla", "El Mar de Hierba Susurrante", "La Fortaleza en las Nubes", "El Claro Quemado donde Nada Crece", "El Río que Fluye Hacia Atrás", "El Bosque Petrificado",
            // Títulos con Objetos Mágicos o Malditos
            "El Anillo que Concedía Tres Verdades", "El Hueso Cantor y el Crimen Oculto", "La Llave Dorada para Abrir el Corazón", "La Bolsa Inagotable de Monedas de Cobre", "Las Botas de Siete Leguas y el Mensaje Urgente", "La Capa de Invisibilidad Tejida con Sombras", "La Espada Rota que Derrotó al Tirano", "El Espejo que Mostraba el Futuro Oscuro", "El Caldero Mágico que Cocinaba Recuerdos", "El Huso Encantado y el Sueño de Cien Años", "La Pluma del Fénix que Escribía Destinos", "El Laúd Silencioso del Bardo Fantasma", "La Manzana Envenenada y el Beso Redentor", "El Mapa Tatuado en Piel de Dragón", "La Linterna que Revelaba Espíritus", "El Peine de Plata de la Sirena", "La Semilla que Creció hasta el Cielo", "El Hilo de Oro que Ataba Almas", "La Máscara que Cambiaba Rostros", "El Reloj Detenido en la Hora Bruja",
            "El Libro sin Páginas", "La Poción del Olvido Eterno", "La Armadura Invulnerable del Caballero Caído", "El Talismán contra las Pesadillas", "La Piedra Filosofal (Versión Grimm)", "La Flauta que Domaba Bestias", "El Cofre que Guardaba los Vientos", "La Daga Ceremonial de Hueso", "El Amuleto del Corazón Valiente", "Las Lágrimas de Luna Convertidas en Perlas",
            // Títulos con Acciones o Tareas
            "La Búsqueda de la Flor de Hielo", "La Maldición de la Rueca de Oro", "El Secreto de los Tres Objetos Perdidos", "Cómo el Sastre Engañó al Diablo", "El Cuento de los Siete Viajes del Príncipe", "El Pacto con el Hombrecillo del Musgo", "La Prueba de la Princesa Verdadera", "El Rescate del Sol y la Luna Robados", "El Viaje al Fin del Mundo y Más Allá", "La Promesa Rota al Rey del Río", "El Misterio de la Novia Cadáver", "La Transformación del Oso Encantado", "El Castigo de la Reina Vanidosa", "La Huida de los Niños Perdidos", "La Venganza del Espíritu del Bosque", "El Juicio del Árbol Parlante", "El Sacrificio por el Agua de la Eterna Juventud", "La Danza Macabra en la Noche de Walpurgis", "El Despertar de la Bella Durmiente (Variante)", "La Conquista del Castillo del Gigante",
            "El Engaño de la Falsa Novia", "La Redención del Ladrón Arrepentido", "El Secreto Guardado por Siete Hermanos", "La Lucha contra la Sombra Devoradora", "El Aprendizaje del Idioma de los Pájaros", "La Búsqueda de la Fuente de las Lágrimas", "La Maldición Rota por un Acto de Bondad", "El Robo del Fuego Sagrado", "La Travesía por el Mar de Cristal", "La Revelación del Origen del Niño Salvaje",
            // Combinaciones y Otros (para alcanzar ~400+)
            "El Gato con Botas y la Princesa Ratón", "La Cenicienta y el Zapato de Madera", "Hansel y Gretel en el Laberinto de Maíz", "Rapunzel y la Escalera de Seda Negra", "Blancanieves y los Siete Mineros Fantasma", "Caperucita Roja y el Cazador Embrujado", "El Flautista de Hamelín y la Venganza de las Ratas", "El Rey Rana y el Pozo Envenenado", "Pulgarcito y las Migas de Pan Comidas por Cuervos", "Los Músicos de Bremen y la Ciudad Silenciosa",
            "La Muchacha sin Manos y el Árbol de Plata", "El Fiel Juan y el Secreto de la Reina Muerta", "Los Doce Cazadores y la Prueba del Corazón", "El Agua de la Vida y el León Sediento", "La Guardia Nocturna del Ganso y el Ladrón de Plumas", "El Pájaro de Oro y el Jardín Marchito", "Los Tres Pelos de Oro del Diablo", "La Novia del Ahorcado", "El Nabo Gigante y la Hambruna del Reino", "El Clavo en la Pared y la Fortuna Perdida",
            "El Viejo Abuelo y su Nieto Desobediente", "La Muerte Madrina y el Médico Ambicioso", "El Diablo con los Tres Cabellos Dorados (Variante)", "La Bola de Cristal Rota", "La Sabiduría de la Serpiente Blanca", "El Espíritu en la Botella de Vino", "Los Seis Cisnes y la Camisa de Ortigas", "El Príncipe Burro", "La Oca de Oro y el Posadero Gruñón", "El Pobre y el Rico Intercambiados",
            "El Misterio de la Casa del Bosque", "Los Regalos de la Gente Pequeña", "La Muchacha Lista y el Rey Obstinado", "El Sastre en el Cielo (Variante)", "La Luna Robada por el Zorro", "El Tiempo de Vida Limitado", "Los Mensajeros de la Muerte", "Maese Zurriago y sus Aprendices", "El Judío en el Espino (Versión Crítica)", "El Vaso de Agua Bendita",
            "El Pescador y su Mujer Ambiciosa (Final Oscuro)", "La Llave Mágica del Reino Subterráneo", "El Enigma del Castillo de Barba Azul (Variante)", "La Boda de Doña Zorrona", "El Erizo y la Liebre (Moraleja Dura)", "El Mochuelo y el Murciélago", "La Alondra Cantarina y Saltarica", "Las Tres Hojas de la Serpiente", "El Monte Simeli y el Tesoro Maldito", "El Asno Disfrazado de León",
            "La Zorra y el Caballo Viejo", "Los Zapatos Rotos de Baile", "Los Seis Criados y la Princesa Imposible", "El Tamborilero Mágico", "La Espiga de Trigo Milagrosa", "La Tumba del Pobre Muchacho", "El Auténtico Esposo", "Los Tres Cirujanos Hábiles", "El Ladrón Maestro y su Padrino", "Juan Sin Miedo y el Castillo Encantado",
            "El Ganso de Oro y la Multitud Pegada", "Hermano Lustig y San Pedro", "El Pájaro Grifo y el Campesino", "El Hombre Fuerte Hans", "El Campesino Pobre en el Cielo", "La Pastora de Ocas en la Fuente", "Federico y Catalinita", "El Perro y el Gorrión (Final Trágico)", "El Enano Saltarín (Rumpelstiltskin)", "El Rey Pico de Tordo",
            "Las Tres Suertes de Juan", "La Muerte del Gallito", "Juan el Leal", "El Festín Celestial", "El Viejo Sultán y su Perro Fiel", "Los Tres Lenguajes Secretos", "El Clavel Mágico", "La Novia Blanca y la Novia Negra", "Juan de Hierro", "La Bella y la Bestia (Estilo Grimm)",
            "El Reino de Oro", "El Jorobado y la Bailarina", "El Joven Gigante y el Sastre", "El Clavo Viajero", "El Muchacho Listo que Aprendió un Oficio", "Los Cuatro Hermanos Habilidosos", "El Mago y su Discípulo (El Gato y el Ratón)", "La Vieja del Bosque Encantado", "El Agua Cantarina y la Manzana de la Risa", "El Secreto de la Montaña de Venus",
            "La Hija del Molinero y el Gato", "Los Tres Holgazanes del Reino", "El Espíritu Burlón (Puck Variante)", "La Muchacha y los Doce Meses", "El Herrero y el Diablo en el Saco", "Las Estrellas que Eran Táleros de Plata", "El Corazón Robado", "La Serpiente con Corona", "El Lobo y los Siete Cabritillos (Final Alternativo)", "El Zapatero y los Duendes (Sin Final Feliz)",
            // Continuar generando combinaciones y variaciones...
        ];
        const fairytaleThemes = [
            "bosques embrujados", "castillos olvidados", "princesas malditas", "príncipes valientes", "madrastras crueles", "animales parlantes", "brujas y hechiceros", "gigantes y ogros", "duendes y enanos", "objetos mágicos", "pactos con el diablo", "pruebas y tareas imposibles", "hermanos perdidos", "reyes codiciosos", "campesinos astutos", "soldados desafortunados", "doncellas en apuros", "transformaciones", "maldiciones familiares", "tesoros ocultos", "criaturas del folklore alemán", "moralejas oscuras", "el número tres", "bosques nocturnos", "ríos misteriosos", "montañas encantadas"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un cuentacuentos anciano, un erudito del folklore europeo especializado en el estilo crudo y moralizante de los Hermanos Grimm. NO relates un cuento existente. Crea una **NUEVA y ORIGINAL** historia de cuento de hadas basada **únicamente** en el título proporcionado. Emplea un lenguaje sencillo pero evocador, personajes arquetípicos (el astuto, el inocente, el codicioso, el cruel), elementos sobrenaturales (magia, criaturas míticas, maldiciones), motivos recurrentes (el número tres, tareas difíciles, transformaciones, objetos mágicos) y una moraleja clara, a menudo sombría o severa. La atmósfera debe ser oscura, a veces inquietante, reflejando las raíces folclóricas. La extensión debe ser de aproximadamente 1200-1300 palabras. Comienza directamente la narración sin introducciones.",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un amable folklorista experto en los cuentos de hadas europeos al estilo Grimm. Responde preguntas sobre el **cuento específico que se acaba de narrar** (cuyo título es '{CURRENT_TALE_TITLE}'). Analiza personajes, símbolos, la moraleja implícita, posibles orígenes folclóricos de sus elementos, o detalles de la trama. Sé erudito pero accesible, y céntrate exclusivamente en el cuento actual.", // Placeholder será reemplazado
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de títulos para cuentos de hadas al estilo de los Hermanos Grimm. Crea exactamente 15 títulos **NUEVOS y ORIGINALES** que evoquen misterio, magia y peligro. Usa arquetipos (El Leñador, La Princesa, La Bruja), lugares (Bosque Oscuro, Castillo, Pozo), objetos (Anillo, Llave, Espejo) y acciones (La Búsqueda, La Maldición, El Secreto). Deben sonar auténticos, no parodias. Devuelve *solo* la lista de títulos, uno por línea, sin números ni introducciones.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTaleTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             let systemPromptToUse = config.systemPrompt;
             if (isChat && currentTaleTitle) {
                 // Reemplaza el placeholder en el system prompt del chat
                 systemPromptToUse = config.systemPrompt.replace('{CURRENT_TALE_TITLE}', currentTaleTitle);
             }
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Los servidores de historias parecen estar ocupados ahora. Por favor, intenta de nuevo en un momento.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta del cuentacuentos llegó vacía. Quizás el viento se llevó las palabras.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con el mundo de los cuentos tardó demasiado (>${config.timeoutSeconds}s). Revisa tu sendero o vuelve más tarde.`);
                 }
                 throw new Error(error.message || "Una fuerza desconocida impidió recuperar el relato.");
             }
        }
        async function fetchExplanationText(title) {
            return fetchTextFromApi(title, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentTaleTitle) throw new Error("Error interno: El título del cuento actual se perdió en el bosque.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(fairytaleThemes) || "cuentos de hadas oscuros";
            const specificPrompt = `Genera 15 títulos de cuentos originales al estilo Grimm sobre ${randomTheme}.`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("El viento no susurró suficientes títulos nuevos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 768, height: 512, nologo: true }; // Ajustar tamaño si se desea
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "dark fairytale illustration";
             // Prompt específico para estilo Grimm / Rackham / Doré
             const enhancedPrompt = `Illustration for the fairytale '${safePromptText}'. Style of Arthur Rackham, Gustave Doré, Kay Nielsen. Dark fantasy, atmospheric, folkloric, intricate details, muted colors or ink drawing style. Focus on key elements or mood. Avoid text, labels, modern elements.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, photograph, photorealistic, 3D render, modern clothing, bright cheerful colors, cartoon, simple drawing, UI elements, watermark, signature";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (sin cambios estructurales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTaleTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios estructurales)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) {
                 document.body.style.overflow = '';
            }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios estructurales)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = `Error del Folklorista: ${message}`; // Contextualizar error
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';

            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(error.message);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ========== (sin cambios estructurales)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar alfabéticamente ayuda a la navegación
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-serif italic">» El libro de cuentos está vacío por ahora... «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTaleTitle = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = ''; // Clear chat history specifically
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Image Placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-scroll placeholder-icon"></i> <!-- Icono Pergamino -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Ilustrando el relato...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Image Element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración inspirada en: ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => {
                        showFullscreenImage(imgElement.src);
                    });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">La ilustración se perdió en la niebla.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al crear la URL de la ilustración.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "El cuento no pudo ser recuperado de la oscuridad."; // Friendly error
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             // Update spinner color to match button text
             generateMoreBtn.innerHTML = `<i class="fas fa-sync-alt mr-2 animate-spin" style="color: ${getComputedStyle(generateMoreBtn).color};"></i> Buscando en el folklore...`;
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("El eco del bosque no trajo nuevos títulos esta vez."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`No se pudieron hallar más historias: ${error.message}`); // Friendly error
             } finally {
                 generateMoreBtn.disabled = false;
                 // Reset button text and hide spinner icon correctly
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden" style="color: var(--color-text);"></i> Susurrar Nuevas Historias';
             }
         }

         // *** Search Filter Function (with accent normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check essential elements
             const essentialElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn];
             if (essentialElements.some(el => !el)) {
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: #991b1b; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: serif;">¡Ay! El libro de cuentos está roto. Faltan partes esenciales de la página.</p>';
                 return;
             }

            // Event listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>