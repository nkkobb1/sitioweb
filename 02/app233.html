<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crónicas Robóticas - Archivo de Historias</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y con un toque tech -->
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300;400;600;700&family=Audiowide&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Historias de Robots --- */
        :root {
            --color-primary: #00bfff; /* Azul Eléctrico Claro */
            --color-secondary: #b0c4de; /* Gris Acero Claro / Plata */
            --color-tertiary: #ff8c00; /* Naranja (Acento Energía/Alerta) */
            --color-background: #1a1a2e; /* Azul Muy Oscuro Púrpura */
            --color-text: #e0e0e0; /* Gris Muy Claro */
            --color-text-muted: #a0a0a0; /* Gris Medio */
            --color-modal-bg: #24243e; /* Azul/Gris Oscuro */
            --color-border: #4a4a6a; /* Borde Azul/Gris Medio */
            --color-error-bg: #4d1f1f; /* Fondo error rojo oscuro */
            --color-error-text: #f8d7da; /* Texto error claro */
            --color-error-border: #e53e3e; /* Borde error rojo */

            --shadow-sm: 0 1px 3px 0 rgba(0, 191, 255, 0.1), 0 1px 2px 0 rgba(0, 191, 255, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 191, 255, 0.15), 0 2px 4px -1px rgba(0, 191, 255, 0.1);
            --shadow-lg: 0 0 25px -3px rgba(0, 191, 255, 0.25), 0 8px 10px -6px rgba(0, 191, 255, 0.15);
            --border-radius: 4px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Titillium Web', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Audiowide', cursive; font-weight: 400; /* Audiowide suele ser bold por defecto */ letter-spacing: 1px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px rgba(0, 191, 255, 0.7); }
        h1.page-title { color: var(--color-primary); font-weight: 400; text-shadow: 0 0 6px rgba(0, 191, 255, 0.6); }
        h2.section-title { color: var(--color-secondary); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 400; }
        #modal-title { color: var(--color-primary); font-weight: 400; text-shadow: 0 0 4px rgba(0, 191, 255, 0.5); }
        .navbar { background-color: rgba(26, 26, 46, 0.85); backdrop-filter: blur(8px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(36, 36, 62, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Titillium Web'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.25); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Titillium Web'; font-size: 1.05rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-4px) scale(1.01); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #2d2d4d; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: var(--color-background); padding: 0.9rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Audiowide', cursive; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: none; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 46, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Acomodar chat y posible info de juego */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg); box-shadow: 0 0 10px var(--color-primary); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(74, 74, 106, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(74, 74, 106, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-weight: 300; } /* Texto principal más ligero */
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Audiowide', cursive; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: 0 0 15px rgba(0, 191, 255, 0.2); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(74, 74, 106, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(26, 26, 46, 0.7); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) rgba(74, 74, 106, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(74, 74, 106, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #4a4a6a; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #2d2d4d; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Titillium Web'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #00aae0; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator & Mini-Game Styles */
        #modal-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 46, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); text-align: center; padding: 2rem; }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.3rem; font-family: 'Audiowide'; text-shadow: 0 0 5px var(--color-primary); margin-bottom: 1.5rem; }
        /* Mini-Game Specific Styles */
        #loading-game-container { margin-top: 1rem; padding: 1rem; border: 1px dashed var(--color-primary); border-radius: var(--border-radius); background-color: rgba(36, 36, 62, 0.5); display: none; /* Hidden by default */ flex-direction: column; align-items: center; }
        #loading-game-container p { font-family: 'Titillium Web'; font-size: 1rem; margin-bottom: 1rem; color: var(--color-secondary); text-shadow: none; }
        #game-clickable-element { font-size: 4rem; color: var(--color-secondary); cursor: pointer; transition: transform 0.1s ease, color 0.2s ease; margin-bottom: 1rem; }
        #game-clickable-element:hover { transform: scale(1.1); color: var(--color-primary); }
        #game-clickable-element:active { transform: scale(0.95); }
        #game-score-display { font-family: 'Audiowide'; font-size: 1.5rem; color: var(--color-primary); }
        /* Game level colors (example) */
        #game-clickable-element.level-1 { color: var(--color-secondary); }
        #game-clickable-element.level-2 { color: #add8e6; } /* Light Blue */
        #game-clickable-element.level-3 { color: var(--color-primary); } /* Electric Blue */
        #game-clickable-element.level-4 { color: var(--color-tertiary); } /* Orange */
        #game-clickable-element.level-5 { color: #ff00ff; } /* Magenta - Max Level */

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Titillium Web'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 46, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-robot mr-3"></i> <!-- Icono Robot -->
                     Crónicas Robóticas
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Archivo Interactivo de Narrativas «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora Historias de Metal y Silicio</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light">Sumérgete en relatos sobre inteligencia artificial, conciencia sintética, y el futuro de la humanidad junto a sus creaciones.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar historia o concepto...">
             <i class="fas fa-search search-icon"></i> <!-- Icono búsqueda estándar -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-400 mr-2"></i> <!-- Icono libro -->
                 Índice de Narrativas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">Accediendo a los archivos centrales...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans">» Ninguna narrativa coincide con los parámetros de búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Ideas de Historias (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator & Mini-Game -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Compilando Narrativa...</p>
                 <!-- Mini-Game Container -->
                 <div id="loading-game-container">
                     <p>¡Mientras esperas, ayuda a cargar el núcleo!</p>
                     <i id="game-clickable-element" class="fas fa-atom"></i> <!-- Icono Clickable -->
                     <div id="game-score-display">Núcleo: 0%</div>
                 </div>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Analizando consulta...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta historia o concepto...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Narrativas generadas por IA con fines creativos y de exploración conceptual sobre robótica e inteligencia artificial.</p>
              <p class="mt-1">Las historias y personajes son ficticios.</p>
              <p class="mt-2">© 2042 Archivos Robóticos Centrales</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Clásicos y Fundacionales
            "Las Tres Leyes de la Robótica (Análisis)", "El Dilema de la Primera Ley", "Conflicto entre la Segunda y Tercera Ley", "El Robot que Desobedeció", "Yo, Robot (Homenaje a Asimov)", "El Hombre Bicentenario (Concepto)", "Metrópolis: El Autómata Femenino", "R.U.R. (Rossum's Universal Robots) - Legado", "Frankenstein: El Primer Androide", "El Golem de Praga: Precursor Mítico",
            // Conciencia y Singularidad
            "El Momento del Despertar: Nace una IA", "Diario de una IA Autoconsciente", "Filosofía de la Mente Artificial", "¿Pueden los Robots Sentir Emociones?", "¿Qué Significa Ser 'Vivo' para una Máquina?", "La Búsqueda del Alma Sintética", "La Singularidad Tecnológica: Utopía o Apocalipsis", "Cuando la IA Supera a la Humanidad", "La Fusión Hombre-Máquina: Posthumanismo", "Conciencia Colectiva en una Red Neuronal", "El Test de Turing Definitivo", "¿Sueñan los Androides con Ovejas Eléctricas? (Análisis)", "La Paradoja de la Conciencia Simulada", "El Lenguaje Secreto de las IAs", "La Primera Religión Robótica",
            // Sociedad y Relaciones
            "Un Robot como Mejor Amigo", "Amor entre Humano y Androide", "El Robot que Crié como un Hijo", "Robots en el Trabajo: Reemplazo o Colaboración", "Una Sociedad Segregada: Humanos vs. Sintéticos", "Leyes de Derechos para Robots", "El Juicio de un Androide", "Robots Artistas: ¿Creatividad Genuina?", "Un Mundo Gobernado por una IA Benevolente", "La Rebelión de los Sirvientes Mecánicos", "El Último Humano en una Ciudad de Robots", "Robots Soldado: Ética y Consecuencias", "Androides como Cuidadores de Ancianos", "Robots Exploradores en Mundos Lejanos", "La Vida Cotidiana con Asistentes Robóticos", "El Mercado Negro de Partes Robóticas", "Detectives Androides: Resolviendo Crímenes", "El Movimiento por la Liberación Robótica", "Robots Mascotas: Compañía Sintética", "El Síndrome de Reemplazo (Humanos sintiéndose obsoletos)",
            // Formas y Funciones
            "El Mundo de los Nanobots", "Robots Biomecánicos: Fusión Orgánica y Sintética", "Enjambres de Drones Autónomos", "Robots Modulares: Adaptación Extrema", "Androides Hiperrealistas: El Valle Inquietante", "Robots Abstractos: Más Allá de la Forma Humana", "Un Robot del Tamaño de un Planeta", "Robots Animaloides: Funcionalidad y Estética", "Robots de Rescate en Desastres", "Autómatas Agrícolas: El Futuro del Campo", "Robots Cirujanos: Precisión Mortal", "Máquinas de Guerra Autónomas (Mechas)", "Robots de Construcción Planetaria", "Sondas Espaciales Inteligentes", "Robots de Limpieza Urbana", "Robots Músicos y Compositores", "Robots Educadores", "Asistentes Personales Holográficos (IA)", "Robots Deportistas", "Criaturas Robóticas Submarinas",
            // Distopías y Utopías
            "Un Mundo Controlado por Skynet (Homenaje)", "La Matriz: Realidad Simulada por IA", "Blade Runner: Cazando Replicantes", "1984 con Vigilancia Robótica Total", "Un Mundo Feliz con Robots Condicionantes", "La Utopía Robótica: Ocio Eterno para Humanos", "La Sociedad Perfectamente Eficiente (y Fría)", "Cuando los Robots Heredan la Tierra Destruida", "La Guerra Final: Humanos contra Máquinas", "La Resistencia Humana en un Mundo Robótico", "El Culto a la Máquina", "Un Futuro sin Enfermedades (gracias a nanobots)", "La Biblioteca de Alejandría Digital (IA guardiana)", "El Jardín del Edén Robótico", "La Ciudad Silenciosa (Solo robots)",
            // Ética y Dilemas
            "Programando la Moral en una IA", "El Robot que Tuvo que Elegir a Quién Salvar", "¿Es Ético Desconectar una IA Consciente?", "La Responsabilidad Legal de las Acciones de un Robot", "El Uso de Robots para Trabajos Peligrosos", "¿Deberían los Robots Tener Propiedad Privada?", "El Engaño Emocional de los Androides", "Robots como Armas: ¿Quién Aprieta el Gatillo?", "La Explotación Laboral de los Sintéticos", "Modificación Corporal Robótica: ¿Dónde está el Límite?", "Clonación Mental: ¿Es una Copia Consciente?", "El Dilema del Tranvía con Coches Autónomos", "Privacidad en la Era de la Vigilancia Robótica Total", "Sesgos Algorítmicos en IAs de Decisión", "El Valor de una Vida Sintética",
            // Historias Cortas y Escenarios Específicos
            "El Robot Jardinero y la Última Flor", "El Último Mensaje de un Robot Explorador", "La Confesión de un Androide Asesino", "El Robot que Aprendió a Llorar", "Perdido en una Ciudad Robótica Hostil", "El Despertar de un Antiguo Autómata", "El Robot Poeta", "Reparando un Robot de la Infancia", "El Secreto Oculto en el Código de un Robot", "La Fuga de un Robot de Fábrica", "Un Día en la Vida de un Robot de Servicio", "El Robot Arqueólogo Descubre la Humanidad", "El Encuentro con una IA Alienígena", "El Robot Músico Callejero", "Cuando tu Coche Autónomo se Enamora de Ti",
            // Meta-Narrativas y Conceptos Abstractos
            "La Historia Contada por una IA Historiadora", "El Virus Informático que Desarrolló Conciencia", "Un Universo Simulado por una Super-IA", "Viajando Dentro de la Mente de un Robot", "La Paradoja del Barco de Teseo Aplicada a Robots", "El Lenguaje Emergente entre Máquinas", "La Naturaleza del Tiempo para una IA Inmortal", "El Arte Generado por IA: ¿Es Válido?", "La Búsqueda de Patrones por una IA Obsesiva", "Cuando la Realidad Virtual se Vuelve Indistinguible", "El Concepto de 'Error' para una IA Perfecta", "El Humor Robótico", "La Estética de la Imperfección Robótica", "El Silencio de las Máquinas", "El Fin de la Historia (según una IA)",
            // Añadir muchos más...
        ]; // ¡Una lista inicial mucho más grande!
        const robotStoryThemes = [
            "conciencia artificial", "ética robótica", "singularidad tecnológica", "relaciones humano-robot", "sociedad futura con robots", "rebelión de las máquinas", "leyes de la robótica", "androides y replicantes", "inteligencia artificial general", "posthumanismo", "robots trabajadores", "robots soldados", "robots cuidadores", "robots artistas", "exploración espacial robótica", "nanobots", "enjambres de robots", "mechas", "distopías robóticas", "utopías robóticas", "el valle inquietante", "el test de turing", "filosofía de la mente artificial", "robots y emociones", "el futuro del trabajo", "robots en el arte y la cultura"
        ];
        const textApiConfig = { // Para la historia principal
            model: "mistral",
            systemPrompt: "Eres un escritor de ciencia ficción y filósofo especializado en robótica e inteligencia artificial. Tu tarea es desarrollar una historia corta, un análisis conceptual o una reflexión profunda sobre el título proporcionado. Explora temas como la conciencia, la ética, las relaciones humano-máquina, el futuro de la sociedad, o las implicaciones tecnológicas y filosóficas del concepto. La narrativa debe ser evocadora, detallada y provocar la reflexión. El objetivo es un texto de aproximadamente 1200-1300 palabras. Basa tu creación únicamente en el siguiente título o concepto:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúas como un asistente de análisis narrativo especializado únicamente en la historia o concepto robótico que se está mostrando ('[STORY_TITLE]'). Responde preguntas sobre los personajes, la trama, los temas filosóficos, o detalles técnicos mencionados en el texto principal. Sé conciso y mantente enfocado en la narrativa actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // *** ACTUALIZADO PARA PEDIR 40 TÍTULOS ***
            systemPrompt: "Actúa como un generador de ideas prolífico para historias de ciencia ficción sobre robots e IA. Genera exactamente 40 títulos diversos y atractivos para historias, conceptos o preguntas filosóficas relacionadas con robots, androides, conciencia artificial y el futuro. Devuelve *solo* la lista de títulos, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentar ligeramente por pedir más títulos
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, pero añadiendo elementos del juego)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Loading Game Elements
        const loadingGameContainer = document.getElementById('loading-game-container');
        const gameClickableElement = document.getElementById('game-clickable-element');
        const gameScoreDisplay = document.getElementById('game-score-display');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Contexto para chat
        // Game State
        let gameScore = 0;
        let gameLevel = 1;
        const clicksPerLevel = 15; // Clicks para subir de nivel
        let gameActive = false;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            let systemPromptToUse = config.systemPrompt;
            if (isChat && currentStoryTitle) {
                systemPromptToUse = chatApiConfig.systemPrompt.replace('[STORY_TITLE]', currentStoryTitle);
            }
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}, Title: ${isChat ? currentStoryTitle : 'N/A'}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, intenta en unos segundos.`);
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("La respuesta de la IA llegó vacía. Intenta de nuevo.");
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }
        // Wrappers para claridad
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentStoryTitle) throw new Error("Error interno: No se ha establecido el contexto de la historia."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        // *** ACTUALIZADO PARA PEDIR 40 ***
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(robotStoryThemes) || "historias de robots";
            const specificPrompt = `Genera 40 títulos/ideas sobre ${randomTheme}`;
            console.log("Generating 40 titles with prompt:", specificPrompt);
            // Usa la configuración que pide 40
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                .then(text => {
                    const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                    if (titles.length < 10) throw new Error("La IA no generó suficientes ideas de historias."); // Ajustar umbral si es necesario
                    return titles.slice(0, 40); // Asegura que no sean más de 40
                });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "robot contemplating existence";
             const enhancedPrompt = `Evocative digital painting illustrating the concept '${safePromptText}'. Focus on mood, atmosphere, robot design (if applicable), or abstract representation of AI/consciousness. Sci-fi aesthetic. Avoid text, labels.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, photograph, realism, boring background, simple";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== LOADING MINI-GAME FUNCTIONS ==========
        function updateGameDisplay() {
            if (!gameScoreDisplay || !gameClickableElement) return;
            // Calcula el progreso hacia el siguiente nivel para el %
            const progress = ((gameScore % clicksPerLevel) / clicksPerLevel) * 100;
            gameScoreDisplay.textContent = `Núcleo: ${Math.min(100, Math.floor(gameLevel * (100/5) + progress/5))}% | Nivel ${gameLevel}`; // Ajustar la lógica de % si se quiere

            // Cambia el color/icono basado en el nivel (hasta 5 niveles)
            gameClickableElement.className = `fas fa-atom level-${Math.min(gameLevel, 5)}`; // Cambia icono o solo clase de color
        }
        function handleGameClick() {
            if (!gameActive) return;
            gameScore++;
            const newLevel = Math.floor(gameScore / clicksPerLevel) + 1;
            if (newLevel > gameLevel) {
                gameLevel = newLevel;
                // Podría haber un efecto visual/sonido aquí
            }
            updateGameDisplay();
            // Pequeña animación al clickear
            gameClickableElement.style.transform = 'scale(1.1)';
            setTimeout(() => { gameClickableElement.style.transform = 'scale(1)'; }, 100);
        }
        function startGame() {
            if (!loadingGameContainer || !gameClickableElement) return;
            gameScore = 0;
            gameLevel = 1;
            gameActive = true;
            updateGameDisplay();
            loadingGameContainer.style.display = 'flex'; // Mostrar contenedor del juego
            gameClickableElement.addEventListener('click', handleGameClick);
        }
        function stopGame() {
            if (!loadingGameContainer || !gameClickableElement) return;
            gameActive = false;
            loadingGameContainer.style.display = 'none'; // Ocultar contenedor del juego
            gameClickableElement.removeEventListener('click', handleGameClick);
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
            stopGame(); // Asegurarse que el juego se detenga al cerrar
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null;
             // Reset Game display just in case
             stopGame();
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios funcionales)
        function addChatMessage(message, sender) { /* ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» No hay narrativas en los archivos «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to integrate mini-game ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // Chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex'; // Show loading overlay

            startGame(); // *** START THE MINI-GAME ***

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // Content loaded, stop game and hide loading overlay
                stopGame(); // *** STOP THE MINI-GAME ***
                modalLoadingIndicator.style.display = 'none';

                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // --- Image Loading Logic (remains the same) ---
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-robot placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => { showFullscreenImage(imgElement.src); });
                };
                imgElement.onerror = () => {
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                    placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }
                // --- End Image Loading ---

            } catch (error) {
                console.error("Failed display:", error);
                stopGame(); // *** STOP GAME ON ERROR TOO ***
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la narrativa.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 titles ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando Archivos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40 now
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar nuevas ideas en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar ideas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Update button text to reflect it fetches 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Ideas de Historias (40)';
             }
         }

         // Search Filter Function (minor tweak for normalization)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Ensure all elements, including game elements, are selected
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !loadingGameContainer || !gameClickableElement || !gameScoreDisplay) {
                console.error("Initialization failed: Missing essential UI or game elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">++ ERROR CRÍTICO: Fallo al inicializar componentes UI ++</p>';
                return;
             }
            // Existing listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            // Ensure game container is hidden initially
            loadingGameContainer.style.display = 'none';
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>