<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economía para Principiantes - Guía Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Claras y Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Economía para Principiantes --- */
        :root {
            --color-primary: #2563eb; /* Azul Primario (Confianza) */
            --color-secondary: #10b981; /* Verde Secundario (Crecimiento, Dinero) */
            --color-tertiary: #f59e0b; /* Amarillo/Oro (Énfasis - usar con moderación) */
            --color-background: #f9fafb; /* Gris Muy Claro / Blanco Hueso */
            --color-text: #374151; /* Gris Oscuro */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro Modal */
            --color-border: #e5e7eb; /* Borde Gris Claro */
            --color-error-bg: #fef2f2; /* Fondo error rojo muy claro */
            --color-error-text: #b91c1c; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.08), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px; /* Bordes Suavemente Redondeados */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Nunito Sans', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Nunito Sans'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; /* Alineación a la izquierda */ font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; /* Para icono opcional */ align-items: center; min-height: 65px; font-family: 'Nunito Sans'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item i { margin-right: 0.6rem; color: var(--color-primary); opacity: 0.7; } /* Icono opcional */
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #eff6ff; /* Azul muy claro hover */ border-left-color: var(--color-primary); }
        .title-item:hover i { opacity: 1; }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-secondary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #059669; box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { /* Color se establecerá en JS */ }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(55, 65, 81, 0.85); /* Overlay gris */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px; /* Suficiente para carga y chat inicial */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #f3f4f6; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 600;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 700; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; /* Más pequeña para ilustraciones */ height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(209, 213, 219, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; /* Mejor para leer */ font-weight: 600; border-bottom-right-radius: 0;}
        .ai-message { background-color: #e5e7eb; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; border-bottom-left-radius: 0;}
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Nunito Sans'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #1d4ed8; }
        #chat-send-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #d1d5db; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 600; color: var(--color-text); font-size: 1.2rem; font-family: 'Roboto'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1rem 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Nunito Sans'; font-size: 0.95rem; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: #fff; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-lightbulb mr-2 text-yellow-500"></i> <!-- Icono idea/aprendizaje -->
                     Economía Fácil
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wide">» Conceptos Clave para Empezar «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Descomplica la Economía</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora los fundamentos económicos de manera sencilla e interactiva. Selecciona un concepto o busca para aprender más.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar concepto económico (ej: inflación, PIB)...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-600 mr-2"></i> <!-- Icono libro -->
                 Temas Fundamentales
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando conceptos económicos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No se encontraron conceptos para tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Conceptos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Obteniendo explicación...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder added via JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <h3 class="text-sm font-semibold mb-2 text-gray-600 text-center">¿Tienes dudas sobre "<span id="chat-topic-placeholder">[Concepto]</span>"? ¡Pregúntame!</h3>
                     <div id="chat-history">
                         <!-- Chat messages appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Analizando tu pregunta...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Escribe tu pregunta aquí...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Ilustración Económica Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA con fines educativos para introducir conceptos económicos básicos.</p>
              <p class="mt-1">Esta guía no constituye asesoramiento financiero. Consulta fuentes expertas para decisiones importantes.</p>
              <p class="mt-2">© 2025 Economía Fácil</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // == Conceptos Fundamentales ==
            "¿Qué es la Economía?", "La Escasez: El Problema Económico Fundamental", "Necesidades vs. Deseos", "Recursos Económicos (Tierra, Trabajo, Capital, Emprendimiento)", "El Costo de Oportunidad: ¿A qué renuncias?", "Incentivos: Cómo nos motivan las decisiones", "Pensamiento Marginal: Decisiones 'un poco más'", "Intercambio y Comercio: Beneficios Mutuos", "Especialización y División del Trabajo", "Los Tres Problemas Económicos: Qué, Cómo y Para Quién Producir", "Eficiencia vs. Equidad", "Modelos Económicos: Simplificando la Realidad", "Ceteris Paribus: 'Todo lo demás constante'", "Economía Positiva vs. Economía Normativa",
            // == Microeconomía: Decisiones Individuales y Mercados ==
            "¿Qué es la Microeconomía?", "Mercados: Donde Compradores y Vendedores se Encuentran", "La Ley de la Demanda: A mayor precio, menor cantidad", "Curva de Demanda: Representación gráfica", "Factores que Desplazan la Demanda", "Bienes Normales vs. Bienes Inferiores", "Bienes Sustitutos vs. Bienes Complementarios", "La Ley de la Oferta: A mayor precio, mayor cantidad", "Curva de Oferta: Representación gráfica", "Factores que Desplazan la Oferta", "Equilibrio de Mercado: Donde Oferta y Demanda se Cruzan", "Precio de Equilibrio y Cantidad de Equilibrio", "Exceso de Oferta (Excedente)", "Exceso de Demanda (Escasez)", "Elasticidad Precio de la Demanda: ¿Qué tan sensible es?", "Demanda Elástica vs. Demanda Inelástica", "Factores que afectan la Elasticidad de la Demanda", "Elasticidad Precio de la Oferta", "Utilidad: La Satisfacción del Consumidor", "Utilidad Marginal Decreciente", "Restricción Presupuestaria: Lo que puedes permitirte", "Elección del Consumidor: Maximizando la Utilidad", "Costos de Producción: Fijos y Variables", "Costo Total, Costo Medio, Costo Marginal", "Beneficio Económico: Ingresos Totales menos Costos Totales (incluido oportunidad)", "Economías de Escala", "Competencia Perfecta: Muchas empresas, producto idéntico", "Monopolio: Una sola empresa domina", "Oligopolio: Pocas empresas dominan", "Competencia Monopolística: Muchas empresas, productos diferenciados", "Barreras de Entrada al Mercado", "Fallas de Mercado: Cuando el mercado no es eficiente", "Externalidades: Efectos en terceros (Positivas y Negativas)", "Bienes Públicos: No rivales y no excluibles", "Información Asimétrica",
            // == Macroeconomía: La Economía en su Conjunto ==
            "¿Qué es la Macroeconomía?", "Producto Interno Bruto (PIB): Midiendo la producción total", "PIB Nominal vs. PIB Real", "PIB per Cápita: Riqueza promedio", "Componentes del PIB (Consumo, Inversión, Gasto Público, Exportaciones Netas)", "Limitaciones del PIB como medida de bienestar", "Crecimiento Económico: Aumento de la producción a largo plazo", "Factores que impulsan el Crecimiento Económico", "Ciclos Económicos: Expansión y Recesión", "Inflación: Aumento generalizado de precios", "¿Cómo se mide la Inflación? (IPC)", "Causas de la Inflación (Demanda, Costos)", "Efectos de la Inflación", "Deflación: Caída generalizada de precios", "Hiperinflación", "Desempleo: Personas buscando trabajo sin encontrarlo", "Tasa de Desempleo: Cálculo e interpretación", "Tipos de Desempleo (Friccional, Estructural, Cíclico)", "Pleno Empleo (Tasa Natural de Desempleo)", "Costos del Desempleo", "Política Fiscal: Uso del Gasto Público y los Impuestos", "Política Fiscal Expansiva (Estimular la economía)", "Política Fiscal Contractiva (Enfriar la economía)", "Presupuesto del Gobierno: Ingresos y Gastos", "Déficit Público vs. Superávit Público", "Deuda Pública", "Política Monetaria: Control de la Oferta de Dinero y Tasas de Interés", "El Banco Central: Funciones (Ej: Reserva Federal, BCE)", "Herramientas de la Política Monetaria (Tasas de interés, reservas, operaciones de mercado abierto)", "Política Monetaria Expansiva", "Política Monetaria Contractiva", "Oferta Agregada y Demanda Agregada (Modelo OA-DA básico)", "Curva de Phillips (Relación inflación-desempleo a corto plazo)",
            // == Dinero, Banca y Finanzas Básicas ==
            "¿Qué es el Dinero?", "Funciones del Dinero (Medio de cambio, Unidad de cuenta, Depósito de valor)", "Tipos de Dinero (Mercancía, Fiduciario)", "Oferta Monetaria: ¿Cuánto dinero hay?", "Bancos Comerciales: Funciones", "Creación de Dinero Bancario (Multiplicador monetario)", "Sistema de Reserva Fraccionaria", "Tasas de Interés: El precio del dinero prestado", "Tasa de Interés Nominal vs. Tasa de Interés Real", "Mercado de Dinero", "Inflación y Tasas de Interés", "Ahorro vs. Inversión", "Mercados Financieros: Donde se negocian activos", "Acciones (Stocks): Propiedad parcial de una empresa", "Bonos (Bonds): Préstamos a gobiernos o empresas", "Dividendos e Intereses", "Riesgo y Rendimiento: La relación básica en finanzas", "Diversificación: No poner todos los huevos en la misma canasta", "Bolsa de Valores: Mercado para comprar y vender acciones", "Índices Bursátiles (Ej: S&P 500, IBEX 35)", "Fondos Mutuos / Fondos de Inversión", "Concepto básico de Valor Presente", "Préstamos e Hipotecas", "Tarjetas de Crédito y Débito", "Presupuesto Personal: Planificación de ingresos y gastos", "Importancia del Ahorro a Largo Plazo", "Seguros: Gestión del riesgo",
            // == Economía Internacional ==
            "Comercio Internacional: Intercambio entre países", "Importaciones y Exportaciones", "Ventaja Absoluta vs. Ventaja Comparativa (Base del comercio)", "Argumentos a favor del Libre Comercio", "Proteccionismo: Barreras al comercio (Aranceles, Cuotas)", "Balanza de Pagos: Registro de transacciones internacionales", "Cuenta Corriente y Cuenta de Capital", "Tipos de Cambio: Precio de una moneda en términos de otra", "Mercado de Divisas (Forex)", "Tipo de Cambio Fijo vs. Tipo de Cambio Flexible (Flotante)", "Apreciación y Depreciación de la Moneda", "Globalización: Interconexión económica mundial", "Organizaciones Económicas Internacionales (FMI, Banco Mundial, OMC)", "Bloques Comerciales (Ej: Unión Europea, Mercosur)", "Desarrollo Económico: Mejora del bienestar en países", "Países Desarrollados vs. Países en Desarrollo", "Indicadores de Desarrollo (IDH)", "Ayuda Exterior",
            // == Sistemas Económicos y Pensamiento ==
            "Sistemas Económicos: ¿Cómo se organiza la economía?", "Economía de Mercado (Capitalismo)", "Economía Planificada (Socialismo/Comunismo)", "Economía Mixta: La mayoría de los países", "El Papel del Gobierno en la Economía", "Adam Smith y la 'Mano Invisible'", "Karl Marx y la Crítica al Capitalismo", "John Maynard Keynes y la Intervención del Gobierno", "Escuela Austriaca de Economía", "Milton Friedman y el Monetarismo", "Economía del Comportamiento (Behavioral Economics): Introducción", "Racionalidad Limitada y Sesgos Cognitivos",
             // == Más Preguntas y Conceptos Derivados (para alcanzar volumen) ==
             "¿Cómo afecta la tecnología al empleo?", "Impacto económico de la inmigración", "Economía ambiental: Valoración de recursos naturales", "Impuestos: Tipos y propósitos (Directos, Indirectos)", "Impuesto sobre la Renta (IRPF)", "Impuesto sobre el Valor Añadido (IVA)", "Impuestos Progresivos, Regresivos, Proporcionales", "¿Qué es una burbuja económica?", "Crisis Financiera de 2008: Causas básicas", "Desigualdad de Ingresos: Medición (Coeficiente de Gini)", "Pobreza: Absoluta vs. Relativa", "Microcréditos y Finanzas Inclusivas", "El concepto de 'Capital Humano'", "Productividad: ¿Cómo se mide?", "Innovación y su impacto económico", "¿Qué son las externalidades de red?", "El problema del 'polizón' (free-rider)", "Regulación económica: ¿Por qué y cómo?", "Derechos de propiedad: Importancia", "Contratos y su función económica", "La economía de la información", "¿Qué es la estanflación?", "El papel de las expectativas en la economía", "Teoría de juegos: Concepto básico", "Dilema del Prisionero: Ejemplo", "Costos de transacción", "Depreciación del capital (en contabilidad y economía)", "Amortización", "Flujo Circular de la Renta: Modelo simple", "Frontera de Posibilidades de Producción (FPP)", "¿Qué mide el Índice de Precios al Productor (IPP)?", "Índices de Confianza del Consumidor", "Leading Economic Indicators (Indicadores Adelantados)", "Lagging Economic Indicators (Indicadores Retrasados)", "Tipo de interés interbancario (Ej: Euribor, SOFR)", "Prima de riesgo", "Calificación crediticia (Rating)", "Mercado primario vs. Mercado secundario (financiero)", "Oferta Pública Inicial (OPI / IPO)", "Capitalización de mercado", "Intermediarios financieros", "¿Qué es un 'cisne negro' en economía?", "Sostenibilidad económica", "Economía circular: Concepto", "Fintech: Innovación financiera tecnológica", "Criptomonedas: Introducción básica (Bitcoin)", "Blockchain: Tecnología subyacente", "Economía colaborativa (Sharing Economy)", "Gig Economy: Trabajo temporal/flexible", "Renta Básica Universal: Concepto", "Impacto económico del cambio climático", "Transición energética y economía", "Economía de la salud: Conceptos básicos", "Economía de la educación", "¿Cómo afecta la demografía a la economía?"
            // ... (Continuar expandiendo con preguntas específicas y sub-temas)
        ];
        const economicsThemes = [ // Para botón "Generar Más"
            "conceptos basicos de economia", "microeconomia", "macroeconomia", "inflacion y desempleo", "politica fiscal y monetaria", "dinero y banca", "mercados financieros", "acciones y bonos", "comercio internacional", "tipos de cambio", "crecimiento economico", "desarrollo economico", "sistemas economicos", "fallas de mercado", "impuestos", "historia del pensamiento economico", "economia del comportamiento", "globalizacion", "economia ambiental"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un profesor/a de economía paciente y claro/a, especializado/a en explicar conceptos a principiantes absolutos. Tu tarea es definir y explicar el concepto económico indicado de forma muy sencilla, usando analogías cotidianas y ejemplos simples. Evita la jerga técnica قدر الإمكان (as much as possible), y si usas un término específico, explícalo brevemente. Cubre qué es el concepto, por qué es importante, y cómo funciona o se aplica de manera básica. El objetivo es una explicación clara y accesible de aproximadamente 1200-1300 palabras. Enfócate únicamente en el siguiente concepto económico para principiantes:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúa como un tutor amigable respondiendo preguntas adicionales sobre el concepto económico específico que se está viendo. Usa explicaciones simples y céntrate SOLO en el tema actual. Si la pregunta se desvía, indica amablemente que solo puedes hablar sobre [Concepto Actual].",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una guía de economía para principiantes. Genera exactamente 15 nombres de conceptos económicos fundamentales o preguntas básicas sobre economía, adecuados para una explicación sencilla. Devuelve *solo* la lista de conceptos/preguntas, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area'); // Wrapper
        const modalTextArea = document.getElementById('modal-content-area'); // Área texto+img
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const chatTopicPlaceholder = document.getElementById('chat-topic-placeholder'); // Span para título en chat
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentConceptTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            // Dynamic system prompt for chat
            const systemPromptToUse = isChat && currentConceptTitle
                ? `Actúa como un tutor amigable respondiendo preguntas adicionales sobre '${currentConceptTitle}'. Usa explicaciones simples y céntrate SOLO en este tema. Si la pregunta se desvía, indica amablemente que solo puedes hablar sobre '${currentConceptTitle}'.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    // Friendly error message
                    throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, por favor intenta en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentConceptTitle) throw new Error("Error interno: Contexto del concepto no establecido para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(economicsThemes) || "conceptos economicos basicos";
             const specificPrompt = `Genera 15 conceptos o preguntas sobre ${randomTheme} para principiantes`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de conceptos.");
                     return titles.slice(0, 15);
                 });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 600, height: 450, nologo: true }; // Aspect ratio for illustration
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "concepto económico abstracto";
             // Prompt for clear, conceptual, beginner-friendly illustrations
             const enhancedPrompt = `Simple conceptual illustration explaining the economic concept of '${safePromptText}' for beginners. Minimalist flat design, clear symbols (like graphs, coins, arrows, people interacting simply), bright and friendly colors. Avoid complex details, text, labels, or realistic photos. Focus on conveying the core idea visually.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, chart labels, numbers, formulas, complex diagram, realistic photo, 3D render, dark, confusing, cluttered, watermark, signature";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (Likely no changes needed)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            // Basic Markdown / formatting cleanup (Keep existing rules, may not be used often in Econ)
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Paragraph handling
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' '); // Replace internal newlines with space
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Minor changes for chat placeholder)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             chatTopicPlaceholder.textContent = '[Concepto]'; // Reset placeholder
             currentConceptTitle = null;
             hideFullscreenImage(); // Ensure fullscreen is hidden
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (No changes needed)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (No changes needed)
        function addChatMessage(message, sender) { /* ... */ const msgDiv=document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>'); msgDiv.innerHTML=message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv=document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent=message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const userQuery=chatInput.value.trim(); if(!userQuery||chatSendBtn.disabled) return; addChatMessage(userQuery,'user'); chatInput.value=''; chatSendBtn.disabled=true; chatLoadingIndicator.style.display='block'; try { const aiResponse=await fetchChatResponse(userQuery); addChatMessage(aiResponse,'ai'); } catch(error){ console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); } finally { chatLoadingIndicator.style.display='none'; chatSendBtn.disabled=false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { // Optionally add an icon
             const div = document.createElement('div');
             div.className = 'title-item';
             // Simple heuristic for icons (can be expanded)
             let iconClass = 'fa-lightbulb'; // Default
             if (title.toLowerCase().includes('pib') || title.toLowerCase().includes('crecimiento') || title.toLowerCase().includes('inflación') || title.toLowerCase().includes('desempleo')) iconClass = 'fa-chart-line';
             else if (title.toLowerCase().includes('mercado') || title.toLowerCase().includes('oferta') || title.toLowerCase().includes('demanda')) iconClass = 'fa-balance-scale';
             else if (title.toLowerCase().includes('dinero') || title.toLowerCase().includes('banco') || title.toLowerCase().includes('interés') || title.toLowerCase().includes('acciones') || title.toLowerCase().includes('bonos')) iconClass = 'fa-coins';
             else if (title.toLowerCase().includes('impuesto') || title.toLowerCase().includes('gobierno') || title.toLowerCase().includes('política fiscal')) iconClass = 'fa-university';
             else if (title.toLowerCase().includes('comercio') || title.toLowerCase().includes('importa') || title.toLowerCase().includes('exporta') || title.toLowerCase().includes('globalización')) iconClass = 'fa-globe';

             div.innerHTML = `<i class="fas ${iconClass} fa-fw"></i> ${title}`; // Add icon
             div.setAttribute('data-title', title);
             div.addEventListener('click', () => handleTitleClick(title));
             return div;
         }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); // Keep alphabetical sort
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay conceptos disponibles.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick (Update chat topic placeholder) ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentConceptTitle = title; // Set chat context
            chatTopicPlaceholder.textContent = title; // Update chat placeholder
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Image placeholder and loading
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando ilustración...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Ilustración no disponible.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                    console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la explicación.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                // Optionally hide chat section on major error
                // chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron generar más conceptos ahora."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al generar conceptos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar Más Conceptos';
             }
         }

         // *** Search Filter Function (added accent normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 // Get text content excluding the icon's text if present
                 const itemText = (item.textContent || item.innerText || "").replace(item.querySelector('i')?.textContent || '', '').trim();
                 const titleText = itemText.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Robust check for essential elements
             const essentialElements = [
                 titleListContainer, storyModal, modalCloseBtn, generateMoreBtn,
                 titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn,
                 imageFullscreenOverlay, fullscreenCloseBtn, chatTopicPlaceholder,
                 modalLoadingIndicator, modalStoryContentArea, modalTextArea, modalTitle, modalContent, modalError
             ];
             if (essentialElements.some(el => !el)) {
                 console.error("Initialization failed: Missing essential elements. Check IDs.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Faltan componentes esenciales de la página.</p>';
                 return;
             }

            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>