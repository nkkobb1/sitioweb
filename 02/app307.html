<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archivo Paranormal LATAM</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes: Una inquietante + una legible -->
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Leyendas Urbanas LATAM --- */
        :root {
            --color-primary: #4A044E; /* Morado Oscuro Intenso */
            --color-secondary: #7F1D1D; /* Rojo Sangre Oscuro */
            --color-tertiary: #9CA3AF; /* Gris Fantasma */
            --color-background: #111827; /* Fondo Casi Negro */
            --color-text: #D1D5DB; /* Texto Gris Claro */
            --color-text-muted: #6B7280; /* Texto Gris Medio */
            --color-modal-bg: #1F2937; /* Modal Gris Azulado Oscuro */
            --color-border: #374151; /* Borde Gris Oscuro */
            --color-locked-bg: #374151; /* Fondo bloqueado = Borde */
            --color-locked-text: #9CA3AF; /* Texto bloqueado = Gris Fantasma */
            --color-error-bg: #4d1a1a;
            --color-error-text: #fecaca;
            --color-error-border: #9b2c2c;

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.5), 0 3px 6px rgba(0, 0, 0, 0.3);
            --border-radius: 4px; /* Bordes más definidos */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23374151' fill-opacity='0.2'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); /* Subtle noise/static pattern */ }
        h1, h2, h3, h4, .logo, #generate-more-btn, #unlock-ad-button, #modal-title, #loading-text { font-family: 'Special Elite', cursive; font-weight: 400; text-transform: uppercase; letter-spacing: 1.5px; }
        .logo { color: var(--color-secondary); filter: drop-shadow(0 0 3px rgba(127, 29, 29, 0.5)); }
        h1.page-title { color: var(--color-primary); font-weight: 400; text-shadow: 0 0 5px rgba(74, 4, 78, 0.5); }
        h2.section-title { color: var(--color-tertiary); border-bottom: 2px dotted var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 400; letter-spacing: 2px; }
        #modal-title { color: var(--color-secondary); font-weight: 400; font-size: 1.7rem; text-align: center; }
        .navbar { background-color: rgba(17, 24, 39, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }

        /* Search Bar */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Roboto'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic;}
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(74, 4, 78, 0.3); outline: none; background-color: #2a3b4d; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        /* Title List & Items */
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1rem 1.2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between; min-height: 60px; font-family: 'Roboto', sans-serif; font-size: 0.95rem; position: relative; overflow: hidden; border-left: 4px solid var(--color-primary); }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-left-color: var(--color-secondary); color: var(--color-tertiary); background-color: #2a3b4d; border-color: #4b5563; }
        .title-item .title-text { flex-grow: 1; margin-right: 10px; }
        .title-item .lock-icon { color: var(--color-text-muted); font-size: 1.1rem; flex-shrink: 0; }

        /* Locked Title Items */
        .title-item.locked { background-color: var(--color-locked-bg); color: var(--color-locked-text); cursor: pointer; border-color: #4b5563; border-left-color: var(--color-locked-text); opacity: 0.7; }
        .title-item.locked:hover { transform: none; box-shadow: var(--shadow-sm); background-color: var(--color-locked-bg); color: var(--color-locked-text); border-left-color: var(--color-secondary); opacity: 0.8; }
        .title-item.locked .title-text { font-weight: 300; }
        .title-item.locked .lock-icon { color: var(--color-secondary); animation: pulse-lock 1.8s infinite ease-in-out; }
        @keyframes pulse-lock { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.15); opacity: 1; } }

        /* Generate More Button */
        #generate-more-btn { grid-column: 1 / -1; background: var(--color-primary); color: var(--color-text); padding: 0.8rem 1.6rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; }
        #generate-more-btn:hover:not(:disabled) { background: var(--color-secondary); border-color: var(--color-primary); box-shadow: var(--shadow-lg); transform: scale(1.02); color: var(--color-tertiary); }
        #generate-more-btn:disabled { background: var(--color-text-muted); color: var(--color-background); cursor: not-allowed; opacity: 0.5; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-text); }

        /* Story Modal (Principal) */
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: 1.5rem 2rem; max-width: 900px; width: 95%; max-height: 90vh; min-height: 400px; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.6rem; color: var(--color-background); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: white; transform: rotate(-90deg); }

        /* Modal Content Area (Scrollable) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem; scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border); }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; font-size: 1rem; }
        #modal-content strong { color: var(--color-tertiary); font-weight: 700; }
        #modal-content em { color: var(--color-primary); font-style: italic; font-weight: 400;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Special Elite', cursive; margin-top: 2em; margin-bottom: 1em; color: var(--color-tertiary); border-bottom: 1px dashed var(--color-border); padding-bottom: 0.4em; font-weight: 400; letter-spacing: 1px;}
        #modal-content h1 { font-size: 1.5em; color: var(--color-secondary); border-bottom-style: solid; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-primary); border-bottom: none; }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; font-style: italic; font-family: 'Roboto'; text-transform: none; letter-spacing: normal;}
        /* Imagen Final */
        #modal-content .final-image { display: block; max-width: 70%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, filter 0.3s ease; filter: saturate(0.8) contrast(1.1); }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); filter: saturate(1) contrast(1); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(55, 65, 81, 0.7); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1.2s linear infinite; margin-bottom: 0.7rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.8rem; color: var(--color-tertiary); opacity: 0.6; }

        /* Chat Section */
        #chat-section { border-top: 1px dashed var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
         #chat-section h3 { font-family: 'Special Elite', cursive; text-align: center; color: var(--color-tertiary); margin-bottom: 0.8rem; font-size: 1.1rem; letter-spacing: 1px;}
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.6rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(17, 24, 39, 0.7); scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #chat-history::-webkit-scrollbar { width: 7px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.6; font-size: 0.95rem; }
        .user-message { background-color: var(--color-tertiary); color: var(--color-background); margin-left: auto; text-align: right; border-radius: var(--border-radius) 0 var(--border-radius) var(--border-radius); }
        .ai-message { background-color: var(--color-primary); color: var(--color-text); margin-right: auto; text-align: left; border-radius: 0 var(--border-radius) var(--border-radius) var(--border-radius); opacity: 0.9;}
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #374151; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Roboto'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); background-color: #4b5563; }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-secondary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-primary); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Special Elite'; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Overlay con Datos Curiosos */
        #modal-loading { text-align: center; padding: 2rem 1rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(17, 24, 39, 0.97); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #modal-loading.active { display: flex; }
        #loading-status { margin-bottom: 1.5rem; }
        #loading-text { font-weight: 400; color: var(--color-secondary); font-size: 1.5rem; margin-bottom: 1rem; letter-spacing: 2px; }
        /* Contenedor para el dato curioso */
        #curious-fact-container {
            margin-top: 1rem;
            padding: 1rem 1.5rem;
            background-color: rgba(55, 65, 81, 0.5); /* Fondo semitransparente */
            border: 1px dashed var(--color-tertiary);
            border-radius: var(--border-radius);
            min-height: 100px; /* Espacio para el texto */
            max-width: 80%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #curious-fact-display {
            font-family: 'Roboto', sans-serif;
            font-style: italic;
            font-size: 1.1rem;
            color: var(--color-tertiary);
            line-height: 1.6;
            text-align: center;
            font-weight: 300;
            transition: opacity 0.5s ease-in-out; /* Transición suave al cambiar */
        }
        #loading-final-text { font-weight: 300; color: var(--color-text-muted); font-size: 0.9rem; font-family: 'Roboto'; margin-top: 1.5rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Roboto'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 10, 15, 0.97); /* Casi negro */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-tertiary); box-shadow: var(--shadow-lg); filter: brightness(0.9); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-tertiary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-tertiary); color: var(--color-background); transform: scale(1.1); }

        /* Unlock Modal (Sin Countdown) */
        #unlock-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.9); display: none; align-items: center; justify-content: center; z-index: 70; padding: 1rem; font-family: 'Roboto', sans-serif; }
        #unlock-modal.active { display: flex; }
        .unlock-modal-content { background-color: var(--color-modal-bg); padding: 2.5rem 2rem 2rem 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); text-align: center; max-width: 480px; width: 90%; position: relative; border: 1px solid var(--color-border); }
        .unlock-modal-close-btn { position: absolute; top: 10px; right: 10px; background: transparent; border: none; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; line-height: 1; transition: color 0.2s ease; }
        .unlock-modal-close-btn:hover { color: var(--color-primary); }
        #unlock-modal h3 { font-family: 'Special Elite', cursive; color: var(--color-secondary); font-size: 1.8rem; margin-bottom: 1.2rem; letter-spacing: 1px; }
        #unlock-modal p { color: var(--color-text); margin-bottom: 2rem; line-height: 1.7; font-size: 1.05rem; }
        #unlock-ad-button { background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.9rem 2.2rem; border: none; border-radius: var(--border-radius); font-family: 'Special Elite', cursive; font-size: 1.3rem; letter-spacing: 1px; cursor: pointer; transition: var(--transition-normal); margin-bottom: 1.5rem; display: inline-block; box-shadow: var(--shadow-md); text-shadow: 1px 1px 2px rgba(0,0,0,0.4); }
        #unlock-ad-button:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: translateY(-2px); }
        #unlock-ad-button:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; box-shadow: none; transform: none; }
        /* #unlock-countdown REMOVED */
        #unlock-status { font-size: 1rem; color: var(--color-tertiary); margin-top: 0.5rem; font-style: italic; min-height: 20px; /* Espacio para mensaje */ }

    </style>
</head>
<body class="bg-gray-900 text-gray-300">
     <!-- Header/Navbar -->
     <nav class="navbar mb-12">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                  <h1 class="logo text-3xl sm:text-4xl">
                      <i class="fas fa-ghost mr-3 text-gray-400"></i>
                      Archivo Paranormal LATAM
                 </h1>
             </div>
             <span class="text-xs text-gray-500 font-sans tracking-wider uppercase">» Donde las Sombras Hablan «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Leyendas Urbanas</h1>
             <p class="text-xl text-gray-400 mb-8 max-w-3xl mx-auto font-light">Explora los mitos y relatos escalofriantes que susurran en cada rincón de Latinoamérica. ¿Te atreves a investigar?</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar leyenda, país, criatura...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-skull text-purple-400 mr-2"></i> <!-- Libro Calavera -->
                 Expedientes Clasificados
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando archivos ocultos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No hay registros de esa entidad... aún «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Leyendas (40)
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal (Principal) -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>
             <!-- Loading Overlay con Datos Curiosos -->
             <div id="modal-loading">
                 <div id="loading-status">
                     <p id="loading-text">Investigando el Misterio...</p>
                     <!-- Contenedor de Datos Curiosos -->
                     <div id="curious-fact-container">
                         <p id="curious-fact-display">Recopilando información...</p>
                     </div>
                 </div>
                 <p id="loading-final-text">Mientras se revela la leyenda, absorbe estos fragmentos de conocimiento arcano.</p>
             </div>
             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content"></div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                      <h3 class="text-lg font-semibold mb-2">Consulta al Investigador</h3>
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Contactando fuentes anónimas...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta más sobre esta leyenda...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                     <i class="fas fa-exclamation-triangle"></i>
                     <span id="modal-error-message"></span>
                 </div>
             </div>
         </div>
     </div>

      <!-- Unlock Modal (Sin Countdown) -->
      <div id="unlock-modal">
          <div class="unlock-modal-content">
              <button class="unlock-modal-close-btn" id="unlock-modal-close" aria-label="Cerrar">&times;</button>
              <h3><i class="fas fa-key mr-2 text-yellow-500"></i> Revelar Leyenda</h3>
              <p>Este conocimiento está sellado. Haz clic en "ANUNCIO" para romper el sello y acceder al relato prohibido.</p>
              <button id="unlock-ad-button">
                  <i class="fas fa-bolt mr-2"></i> ANUNCIO (Romper Sello)
              </button>
              <!-- Countdown removido -->
              <div id="unlock-status"></div>
              <input type="hidden" id="unlock-target-title" value="">
          </div>
      </div>

      <!-- Fullscreen Image Overlay (sin cambios) -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Ilustración de la Leyenda">
      </div>

      <!-- Footer -->
      <footer class="bg-black text-gray-500 py-6 mt-12 border-t border-gray-800 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Relatos de leyendas urbanas latinoamericanas generados por IA, basados en folclore popular.</p>
              <p class="mt-1">Estas historias son interpretaciones. La realidad puede ser más extraña... o no.</p>
              <p class="mt-2">© 2025 Archivo Paranormal LATAM - No nos hacemos responsables de pesadillas.</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const adUrl = 'https://increasingbelieveabonnement.com/pcmu77j4?key=1f38fa224b5ecf757563a32d2d8ac126';
        // const unlockCountdownSeconds = 5; // REMOVED
        const lockPercentage = 0.7; // 70% initially locked
        const themePrefix = 'LeyendasLA'; // Unique prefix for this theme
        const userUnlockedKey = `unlockedTitles_${themePrefix}`;
        const initialLockStateSetFlagKey = `initialLockStateSet_${themePrefix}`;
        const initialLockedSetKey = `initialLockedSet_${themePrefix}`;
        const curiousFactsUrl = 'https://papitasfritas.com/datoscuriosos.json';
        const factChangeIntervalMs = 5000; // 5 seconds

        const predefinedTitles = [
            // México
            "La Llorona: El Lamento Eterno del Río", "El Chupacabras: ¿Mito Moderno o Realidad?", "La Planchada: La Enfermera Fantasma de Hospitales", "El Nahual: El Cambiaformas Ancestral", "La Isla de las Muñecas: Terror en Xochimilco", "El Charro Negro: El Pacto Demoníaco a Caballo", "La Leyenda de los Volcanes: Popocatépetl e Iztaccíhuatl", "El Callejón del Beso: Amor y Tragedia en Guanajuato", "Las Momias de Guanajuato: ¿Despertarán?", "El Fantasma de la Monja: Convento Embrujado",
            // Colombia
            "El Silbón: La Venganza que Silba en los Llanos", "La Patasola: La Mujer Monstruosa del Monte", "El Mohán: El Guardián Dorado de los Ríos", "La Madremonte: El Espíritu Protector de la Selva", "El Hombre Caimán: La Maldición de Plato", "La Candileja: El Fuego Fatuo Vengativo", "El Sombrerón (Colombia/Guatemala): El Enamorado Tenebroso", "La Llorona (Versión Colombiana)", "El Duende: El Travieso Guardián de Tesoros", "La Muelona: La Devoradora de Hombres",
            // Argentina & Uruguay
            "La Luz Mala: El Espectro de los Campos", "El Lobizón: El Séptimo Hijo Varón Maldito", "El Pombero: El Duende Silbador del Litoral", "La Viuda Negra: El Fantasma de la Ruta", "El Familiar: El Demonio Protector de Ingenios", "Nahuelito: El Monstruo del Lago Nahuel Huapi", "La Salamanca: La Cueva de Brujas y Demonios", "Gauchito Gil: ¿Santo Popular o Leyenda?", "El Perro Familiar (Uruguay)", "La Llorona (Versión Rioplatense)",
            // Chile
            "El Trauco: El Enano Seductor de Chiloé", "La Pincoya: La Danzarina del Mar", "El Caleuche: El Barco Fantasma Chilote", "El Alicanto: El Ave de Oro y Plata Minera", "El Chonchón: La Bruja Cabeza Voladora", "El Cuero: El Monstruo Acuático", "La Viuda de la Quebrada", "El Fantasma del Faro Carranza", "La Lola: El Espectro Femenino Atormentado", "El Pihuichén: El Vampiro Alado",
            // Perú
            "El Pishtaco: El Degollador Blanco de los Andes", "El Tunche Maligno: El Silbido Mortal de la Selva", "El Muqui: El Duende Minero", "La Runamula: La Mujer Castigada", "El Yacumama: La Serpiente Gigante del Agua", "El Chullachaqui: El Duende de Pies Desiguales", "La Achiqué: La Vieja Roba-Niños", "Jarjacha: El Demonio Inca de la Lujuria", "El Simpira: El Demonio Raya de la Amazonía", "La Casa Matusita: ¿La Más Embrujada de Lima?",
            // Venezuela
            "La Sayona: La Mujer Vengativa de Blanco", "El Silbón (Versión Venezolana)", "El Ánima Sola: El Espíritu del Purgatorio", "La Loca Luz Caraballo: El Poema Hecho Leyenda", "Florentino y el Diablo: El Contrapunteo Legendario", "María Lionza: Reina y Diosa del Culto", "El Hachador Perdido", "El Carretón de la Muerte", "La Novia de Puerto Cabello", "El Chivato de Cumanacoa",
            // Centroamérica (General/Varios)
            "El Cadejo (Blanco y Negro): El Perro Guardián y el Demonio", "La Siguanaba/Sihuanaba: La Mujer con Cara de Caballo", "La Tulevieja (Panamá/Costa Rica): El Monstruo Ave-Mujer", "El Padre sin Cabeza", "La Carreta Nagua/Chillona (Nicaragua/Costa Rica)", "La Cegua (Costa Rica/Nicaragua): Variante de la Siguanaba", "Los Duendes Centroamericanos", "El Sisimite/Itacayo (Honduras/Belice): El Hombre Salvaje", "La Llorona (Versiones Centroamericanas)", "El Gritón (El Salvador)",
            // Caribe (General/Varios)
            "El Bacá (República Dominicana): El Demonio Familiar", "Las Ciguapas (República Dominicana): Mujeres de Pies al Revés", "El Jupía (Puerto Rico): Fantasma Taíno", "La Luz de Yara (Cuba)", "El Güije/Jigüe (Cuba): El Negrito del Agua", "Los Biembiens (Haití): Criaturas Salvajes", "El Galipote (República Dominicana): El Hombre que se Transforma", "El Vudú y los Zombis (Haití - Más Creencia que Leyenda Urbana Pura)", "Anansi la Araña (Folclore Afrocaribeño con Ecos)", "El Comelenguas (Puerto Rico - Moderno)",
            // Bolivia
            "El Tío de la Mina: El Guardián Demoníaco del Subsuelo", "La Viuda Alegre: El Fantasma Seductor", "El Kari Kari: El Ladrón Nocturno de Grasa Humana", "La Casa de las Cadenas (Potosí)", "La Leyenda del Lago Titicaca", "El Chiru Chiru: El Ladrón Robin Hood", "El Cóndor y la Cholita", "La Maldición de la Papa", "Ajayus y Espíritus Andinos", "El Jukumari: El Hombre Oso Boliviano",
            // Ecuador
            "La Dama Tapada (Guayaquil)", "Cantuña y el Diablo: El Pacto por San Francisco", "El Duende Tsáchila", "La Caja Ronca (Cuenca)", "El Guagua Auca", "La Princesa Inca y el Agua", "El Chuzalongo", "La Mariangula", "El Jinete sin Cabeza (Versión Ecuatoriana)", "El Cura sin Cabeza (Versión Ecuatoriana)",
            // Paraguay
            "El Pombero (Versión Guaraní)", "El Jasy Jatere: El Rubio Roba-Niños de la Siesta", "El Luisón/Lobizón (Versión Guaraní)", "El Moñái: La Serpiente Protectora de Tesoros", "El Kurupí: El Sátiro del Monte", "El Ao Ao: El Monstruo Come-Hombres", "El Teju Jagua: El Lagarto-Perro de Siete Cabezas", "Taú y Keraná: Padres de los 7 Monstruos Míticos", "La Leyenda del Lago Ypacaraí", "Plata Yvyguy: Tesoros Enterrados",
            // Leyendas Transnacionales o Comunes
            "El Familiar (Demonio Protector)", "El Duende (Varias formas)", "El Jinete sin Cabeza", "El Tesoro Enterrado (Varias formas)", "La Viuda (Fantasma de Rutas/Caminos)", "El Perro Negro Demoníaco", "La Casa Embrujada Local", "El Hombre de la Bolsa/El Ropavejero", "Pactos con el Diablo (Varias leyendas)", "La Rubia del Baño/Verónica (Leyenda Escolar)",
            //... (Continuar hasta ~400, buscando variantes locales, leyendas menos conocidas, etc.)
        ];
        const leyendaThemes = [ // Para generar más títulos
            "fantasmas latinoamericanos", "criaturas míticas latam", "leyendas de terror méxico", "folclore andino sobrenatural", "mitos amazónicos oscuros", "leyendas urbanas colombia", "espíritus vengativos latam", "demonios folclóricos argentina", "brujería y pactos chile", "leyendas coloniales malditas", "monstruos acuáticos latam", "duendes y protectores ambiguos", "leyendas de caminos y rutas", "folclore afrocaribeño misterioso", "leyendas precolombinas terroríficas"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un Cronista de lo Oculto, un narrador experto en leyendas urbanas y folclore oscuro de toda Latinoamérica. Relata la leyenda consultada con atmósfera de suspense, detalles escalofriantes y respeto por la tradición oral. Describe los orígenes (si se conocen), las características de la entidad o fenómeno, los testimonios típicos y el impacto cultural. Usa un lenguaje evocador y sombrío. Extensión: 1200-1300 palabras. Narra la leyenda de:",
            timeoutSeconds: 180
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúas como un asistente del Cronista de lo Oculto. Responde preguntas puntuales sobre la leyenda recién narrada. Clarifica detalles sobre variantes, posibles explicaciones racionales (si existen y son relevantes sin quitar misterio), símbolos o advertencias asociadas. Sé conciso, mantén el tono de misterio y céntrate en el relato proporcionado.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Genera una lista concisa de 40 leyendas urbanas o criaturas folclóricas específicas y variadas de distintos países de Latinoamérica. Incluye tanto conocidas como menos comunes. Devuelve *solo* la lista de ítems, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60
        };

        // ========== DOM ELEMENTS ==========
        // (Asegurarse que todos existen, incluyendo el nuevo #curious-fact-display y quitando los del puzzle)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        // Elementos para datos curiosos
        const curiousFactDisplay = document.getElementById('curious-fact-display');
        const loadingText = document.getElementById('loading-text');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        const unlockModal = document.getElementById('unlock-modal');
        const unlockModalCloseBtn = document.getElementById('unlock-modal-close');
        const unlockAdButton = document.getElementById('unlock-ad-button');
        // const unlockCountdownDisplay = document.getElementById('unlock-countdown'); // REMOVED
        const unlockStatusDisplay = document.getElementById('unlock-status');
        const unlockTargetTitleInput = document.getElementById('unlock-target-title');

        // ========== State Variables ==========
        let currentTopicTitle = null;
        let initialLockedTitles = loadInitialLockedSet();
        // let countdownInterval = null; // REMOVED
        // --- NEW: State for Curious Facts ---
        let curiousFactsData = [];
        let factInterval = null;

        // ========== LocalStorage Functions ==========
        // (Sin cambios respecto al ejemplo anterior - getJsonFromStorage, setJsonInStorage, user unlock functions, initial lock state functions)
        function getJsonFromStorage(key) { /* ... */ try { const stored = localStorage.getItem(key); return stored ? JSON.parse(stored) : null; } catch (e) { console.error(`Error reading key ${key} from localStorage:`, e); return null; } }
        function setJsonInStorage(key, value) { /* ... */ try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error(`Error saving key ${key} to localStorage:`, e); } }
        function getUnlockedTitles() { const unlockedArray = getJsonFromStorage(userUnlockedKey); return new Set(unlockedArray || []); }
        function saveUnlockedTitles(unlockedSet) { setJsonInStorage(userUnlockedKey, Array.from(unlockedSet)); }
        function isTitleUnlockedByUser(title) { return getUnlockedTitles().has(title); }
        function unlockTitlePermanentlyByUser(title) { if (!title) return; const unlockedByUser = getUnlockedTitles(); if (!unlockedByUser.has(title)) { unlockedByUser.add(title); saveUnlockedTitles(unlockedByUser); console.log(`Title permanently unlocked by user: ${title}`); updateTitleItemLockStatus(title, false); } }
        function loadInitialLockedSet() { const lockedArray = getJsonFromStorage(initialLockedSetKey); return new Set(lockedArray || []); }
        function saveInitialLockedSet(lockedSet) { setJsonInStorage(initialLockedSetKey, Array.from(lockedSet)); }
        function isInitialLockStateSet() { return localStorage.getItem(initialLockStateSetFlagKey) === 'true'; }
        function setInitialLockStateFlag() { localStorage.setItem(initialLockStateSetFlagKey, 'true'); }
        function isTitleInitiallyLocked(title) { return initialLockedTitles.has(title); }


        // ========== API & DATA FETCHING FUNCTIONS ==========
        // fetchTextFromApi (Adaptar mensajes de error)
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentTopicTitle
                ? `Actúas como un asistente del Cronista de lo Oculto. Responde preguntas puntuales sobre la leyenda '${currentTopicTitle}'. Clarifica detalles, variantes o símbolos. Sé conciso y mantén el misterio.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`(Error ${response.status}) Interferencias psíquicas... Los servidores del más allá están ocupados. Intenta más tarde.`);
                const text = await response.text();
                if (!text || text.trim().length === 0) throw new Error("El Cronista guarda silencio (respuesta vacía). El misterio persiste. Intenta de nuevo.");
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') throw new Error(`La consulta se perdió en la oscuridad (>${config.timeoutSeconds}s). Conexión débil o entidades bloqueando. Intenta de nuevo.`);
                throw new Error(error.message || "Error desconocido contactando los archivos paranormales.");
            }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Error interno: Se perdió el rastro de la leyenda."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() { // (Adaptar prompt y tema)
             const randomTheme = getRandomElement(leyendaThemes) || "leyendas latinoamericanas variadas";
             const specificPrompt = `Genera 40 nombres específicos de leyendas urbanas, criaturas o fenómenos paranormales de Latinoamérica sobre ${randomTheme}`;
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 10) throw new Error("La IA no encontró suficientes susurros en el viento.");
                     return titles.slice(0, 40);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Adaptar prompt
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Latin American urban legend";
            const enhancedPrompt = `Dark, atmospheric illustration representing the Latin American legend '${safePromptText}'. Style: eerie, folk horror, mysterious lighting, slightly gritty texture. Use a dark color palette (deep blues, purples, blacks, greys) with unsettling highlights. Focus on mood and suspense. No text, logos, words.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, bright colors, daylight, happy scene, cute";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // --- NEW: Fetch Curious Facts ---
        async function fetchCuriousFacts() {
            if (!curiousFactsUrl) {
                console.warn("No URL provided for curious facts.");
                return;
            }
            console.log("Fetching curious facts from:", curiousFactsUrl);
            try {
                const response = await fetch(curiousFactsUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                // Assuming the JSON is an array of strings or objects like { fact: "..." }
                if (Array.isArray(data)) {
                     curiousFactsData = data.map(item => (typeof item === 'string' ? item : item.fact)).filter(Boolean);
                     console.log(`Loaded ${curiousFactsData.length} curious facts.`);
                     // Display one immediately if loading indicator is active
                     if (modalLoadingIndicator.classList.contains('active')) {
                         displayRandomFact();
                     }
                } else {
                    console.error("Curious facts data is not an array:", data);
                    curiousFactsData = ["Error al cargar datos curiosos."];
                }
            } catch (error) {
                console.error("Error fetching curious facts:", error);
                curiousFactsData = ["No se pudieron cargar los datos curiosos."];
                 if (modalLoadingIndicator.classList.contains('active')) {
                     displayRandomFact(); // Show error message
                 }
            }
        }

         // --- NEW: Display Random Fact ---
         function displayRandomFact() {
             if (!curiousFactDisplay) return;

             let factToShow = "Investigando...";
             if (curiousFactsData && curiousFactsData.length > 0) {
                 factToShow = getRandomElement(curiousFactsData);
             } else {
                 factToShow = "Recopilando información arcana..."; // Or the error message if loading failed
             }

             // Fade out, change text, fade in
             curiousFactDisplay.style.opacity = 0;
             setTimeout(() => {
                 curiousFactDisplay.textContent = factToShow;
                 curiousFactDisplay.style.opacity = 1;
             }, 300); // Short delay for fade effect
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (igual que antes) ... */ if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted; }

        // ========== MODAL FUNCTIONS ==========
        // showModal, hideModal, resetModalState (Adaptar para limpiar intervalo de datos)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active') && !unlockModal.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            modalTextArea.scrollTop = 0;
            // --- Stop fact interval ---
            if (factInterval) {
                clearInterval(factInterval);
                factInterval = null;
                console.log("Fact interval cleared.");
            }
            resetModalState();
        }
        function resetModalState() {
            modalLoadingIndicator.classList.remove('active');
            modalStoryContentArea.classList.add('content-hidden');
            modalError.classList.add('content-hidden');
            modalTitle.textContent = ''; modalContent.innerHTML = '';
            modalErrorMessage.textContent = ''; chatHistory.innerHTML = '';
            chatInput.value = ''; chatLoadingIndicator.style.display = 'none';
            chatSendBtn.disabled = false; currentTopicTitle = null;
            hideFullscreenImage(); chatSection.classList.remove('content-hidden');
            // Reset fact display text
            if(curiousFactDisplay) curiousFactDisplay.textContent = "Recopilando información...";
        }
        function showUnlockModal(titleToUnlock) { /* ... (sin cambios) ... */ unlockTargetTitleInput.value = titleToUnlock; unlockStatusDisplay.textContent = ''; unlockAdButton.disabled = false; unlockModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideUnlockModal() { /* ... (sin cambios, ya no necesita limpiar countdown) ... */ unlockModal.classList.remove('active'); if (!storyModal.classList.contains('active') && !imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; } }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active') && !unlockModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios lógicos)
        function addChatMessage(message, sender) { /* ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error Investigador: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }

        // createTitleItem, updateTitleItemLockStatus, displayTitles, appendTitles (Sin cambios respecto al ejemplo anterior, usan la lógica de persistencia)
        function createTitleItem(title) { /* ... (igual que antes, usa isTitleInitiallyLocked y isTitleUnlockedByUser) ... */ const div = document.createElement('div'); div.className = 'title-item'; div.setAttribute('data-title', title); const textSpan = document.createElement('span'); textSpan.className = 'title-text'; textSpan.textContent = title; div.appendChild(textSpan); const initiallyLocked = isTitleInitiallyLocked(title); const unlockedByUser = isTitleUnlockedByUser(title); const isEffectivelyLocked = initiallyLocked && !unlockedByUser; div.setAttribute('data-locked', isEffectivelyLocked ? 'true' : 'false'); div.style.cursor = 'pointer'; if (isEffectivelyLocked) { div.classList.add('locked'); const lockIcon = document.createElement('i'); lockIcon.className = 'fas fa-lock lock-icon'; div.appendChild(lockIcon); } else { div.classList.remove('locked'); } div.addEventListener('click', () => handleTitleClick(title, div)); return div; }
        function updateTitleItemLockStatus(title, isLocked) { /* ... (igual que antes) ... */ const titleItem = titleListContainer.querySelector(`.title-item[data-title="${CSS.escape(title)}"]`); if (titleItem) { titleItem.setAttribute('data-locked', isLocked ? 'true' : 'false'); titleItem.classList.toggle('locked', isLocked); let lockIcon = titleItem.querySelector('.lock-icon'); if (isLocked && !lockIcon) { lockIcon = document.createElement('i'); lockIcon.className = 'fas fa-lock lock-icon'; titleItem.appendChild(lockIcon); } else if (!isLocked && lockIcon) { lockIcon.remove(); } } }
        function displayTitles(titles) { /* ... (igual que antes, maneja la configuración inicial persistente) ... */ if (!titleListContainer || !titlesLoading) return; if (!isInitialLockStateSet() && titles.length > 0) { console.log("Setting initial lock state for the first time..."); const shuffled = shuffleArray([...titles]); const lockCount = Math.floor(titles.length * lockPercentage); const newInitialLockedSet = new Set(); for (let i = 0; i < lockCount; i++) { newInitialLockedSet.add(shuffled[i]); } saveInitialLockedSet(newInitialLockedSet); setInitialLockStateFlag(); initialLockedTitles = newInitialLockedSet; console.log(`Initially locked ${initialLockedTitles.size} titles and saved state.`); } else { console.log(`Initial lock state already set. Loaded ${initialLockedTitles.size} initially locked titles.`); } const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none'; if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» Los archivos están vacíos... por ahora «</p>'; return; } sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { /* ... (igual que antes, añade a la lista y al set persistente inicial) ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title)); let newTitlesAddedToInitialLock = false; newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); if (!initialLockedTitles.has(title)) { initialLockedTitles.add(title); newTitlesAddedToInitialLock = true; } } }); if (newTitlesAddedToInitialLock) { saveInitialLockedSet(initialLockedTitles); console.log("Added new generated titles to the persistent initial locked set."); } filterTitles(searchInput.value); }

        // handleTitleClick (Sin cambios)
        function handleTitleClick(title, titleElement) { /* ... */ const isLocked = titleElement.getAttribute('data-locked') === 'true'; if (isLocked) { console.log(`Title "${title}" is locked. Showing unlock modal.`); showUnlockModal(title); } else { console.log(`Title "${title}" is unlocked. Proceeding to load.`); loadContentForTitle(title); } }

        // --- MODIFIED: loadContentForTitle (Starts fact display interval) ---
        async function loadContentForTitle(title) {
            resetModalState(); showModal(); currentTopicTitle = title;
            modalTitle.textContent = title;
            modalStoryContentArea.classList.add('content-hidden');
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.classList.add('active');

            // --- Start displaying facts ---
            displayRandomFact(); // Show one immediately
            if (factInterval) clearInterval(factInterval); // Clear previous if any
            factInterval = setInterval(displayRandomFact, factChangeIntervalMs);
            console.log("Fact interval started.");
            // --- End fact display start ---

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // --- Stop fact interval on success ---
                if (factInterval) clearInterval(factInterval);
                factInterval = null;
                console.log("Fact interval cleared on success.");
                // ---
                modalLoadingIndicator.classList.remove('active');

                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0; // Reset scroll

                // Load Image
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Materializando visión...</p>`;
                modalContent.appendChild(placeholderDiv);
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización fallida.</p>`; };
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;}

            } catch (error) {
                 // --- Stop fact interval on error ---
                 if (factInterval) clearInterval(factInterval);
                 factInterval = null;
                 console.log("Fact interval cleared on error.");
                 // ---
                console.error("Failed display:", error);
                modalLoadingIndicator.classList.remove('active');
                modalErrorMessage.textContent = error.message || "Error desconocido al desenterrar esta leyenda.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = ''; // Clear any partial content
                chatSection.classList.add('content-hidden');
            }
        }

        // --- MODIFIED: handleAdButtonClick (No countdown) ---
        function handleAdButtonClick() {
            const titleToUnlock = unlockTargetTitleInput.value;
            if (!titleToUnlock || unlockAdButton.disabled) return;
            console.log(`Ad button clicked for title: ${titleToUnlock}`);

            // 1. Open Ad
            window.open(adUrl, '_blank');

            // 2. Disable button immediately
            unlockAdButton.disabled = true;
            unlockStatusDisplay.textContent = 'Procesando desbloqueo...';

            // 3. Unlock permanently FOR USER immediately
            unlockTitlePermanentlyByUser(titleToUnlock);
            console.log(`Unlock processed for ${titleToUnlock}`);

            // 4. Update status and proceed after short delay for visual feedback
            setTimeout(() => {
                unlockStatusDisplay.textContent = '¡Leyenda Revelada!';
                console.log(`Status updated for ${titleToUnlock}`);
                // Wait a bit longer before closing modal and loading
                setTimeout(() => {
                    hideUnlockModal();
                    loadContentForTitle(titleToUnlock); // Load content directly
                 }, 800); // 0.8 second delay after showing success message
             }, 500); // 0.5 second delay before showing success message
        }


        // handleGenerateMoreTitles (Sin cambios)
        async function handleGenerateMoreTitles() { /* ... */ if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return; generateMoreBtn.disabled = true; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más susurros...'; try { const newTitles = await fetchGeneratedTitles(); if (newTitles && newTitles.length > 0) { appendTitles(newTitles); } else { alert("No se encontraron más leyendas por ahora."); } } catch (error) { console.error("Failed title generation:", error); alert(`Error buscando leyendas: ${error.message}`); } finally { generateMoreBtn.disabled = false; generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Leyendas (40)'; } }

         // Search Filter Function (sin cambios)
         function filterTitles(searchTerm) { /* ... */ const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); const titleItems = titleListContainer.querySelectorAll('.title-item'); let visibleCount = 0; titleItems.forEach(item => { const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const isVisible = titleText.includes(term); item.classList.toggle('hidden', !isVisible); if (isVisible) visibleCount++; }); noResultsMsg.classList.toggle('hidden', visibleCount > 0); }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check essential elements (incluyendo #curious-fact-display, quitando #puzzle-canvas, #unlock-countdown)
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalLoadingIndicator || !curiousFactDisplay || !unlockModal || !unlockModalCloseBtn || !unlockAdButton || !unlockStatusDisplay || !unlockTargetTitleInput) {
                console.error("Initialization failed: Missing essential UI elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: ¡El Archivo está corrupto! Faltan componentes.</p>';
                return;
             }

            // --- Fetch curious facts on startup ---
            fetchCuriousFacts();

            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            unlockModalCloseBtn.addEventListener('click', hideUnlockModal);
            unlockModal.addEventListener('click', (event) => { if (event.target === unlockModal) hideUnlockModal(); });
            unlockAdButton.addEventListener('click', handleAdButtonClick);

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>