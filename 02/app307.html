<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leyendas Urbanas de Latinoamérica</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes: Una Serif clásica/misteriosa -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Leyendas Urbanas --- */
        :root {
            --color-primary: #8B0000; /* Rojo Sangre Oscuro */
            --color-secondary: #483D8B; /* Azul Pizarra Oscuro */
            --color-tertiary: #B0C4DE; /* Azul Acero Claro (Fantasma) */
            --color-background: #1A1A1A; /* Fondo Casi Negro */
            --color-text: #E0E0E0; /* Texto Gris Claro */
            --color-text-muted: #999999; /* Texto Gris Medio */
            --color-modal-bg: #2C2C2C; /* Fondo Modal Gris Muy Oscuro */
            --color-border: #444444; /* Borde Gris Oscuro */
            --color-locked-bg: #383838; /* Fondo bloqueado */
            --color-locked-text: #777777; /* Texto bloqueado */
            --color-error-bg: #4d1f1f; /* Fondo error rojo oscuro */
            --color-error-text: #ffcccc; /* Texto error rojo claro */
            --color-error-border: #8B0000; /* Borde error rojo sangre */

            --shadow-sm: 0 2px 5px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 5px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.5), 0 4px 10px rgba(0, 0, 0, 0.3);
            --border-radius: 4px; /* Bordes más definidos */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Crimson Text', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.8; font-weight: 400; /* Opcional: textura sutil de fondo */ background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23333' fill-opacity='0.1'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l-2.83-2.83 1.41-1.41L20 17.19l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 22.81l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
        h1, h2, h3, h4, .logo, #generate-more-btn, #unlock-ad-button, #modal-title, #loading-text { font-family: 'Montserrat', sans-serif; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-tertiary); font-weight: 700; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        h2.section-title { color: var(--color-primary); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-tertiary); font-weight: 700; font-size: 1.7rem; }
        .navbar { background-color: rgba(26, 26, 26, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }

        /* Search Bar */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #333; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Crimson Text'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic;}
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.3); outline: none; background-color: #404040; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        /* Title List & Items */
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 0.9rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between; min-height: 60px; font-family: 'Crimson Text', serif; font-size: 1.02rem; position: relative; overflow: hidden; border-left: 4px solid var(--color-secondary); }
        .title-item:hover { transform: translateX(3px); box-shadow: var(--shadow-md); border-left-color: var(--color-primary); color: var(--color-tertiary); background-color: #3a3a3a; }
        .title-item .title-text { flex-grow: 1; margin-right: 10px; font-weight: 700; }
        .title-item .lock-icon { color: var(--color-text-muted); font-size: 1.1rem; flex-shrink: 0; }

        /* Locked Title Items */
        .title-item.locked { background-color: var(--color-locked-bg); color: var(--color-locked-text); cursor: pointer; border-color: #555; border-left-color: var(--color-locked-text); opacity: 0.8; }
        .title-item.locked:hover { transform: none; box-shadow: var(--shadow-sm); background-color: var(--color-locked-bg); color: var(--color-locked-text); border-left-color: var(--color-primary); }
        .title-item.locked .title-text { font-weight: 400; }
        .title-item.locked .lock-icon { color: var(--color-primary); animation: pulse-lock 1.8s infinite ease-in-out; }
        @keyframes pulse-lock { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

        /* Generate More Button */
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.9rem 1.8rem; border: 1px solid rgba(255,255,255,0.1); border-radius: var(--border-radius); cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.4); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-text-muted); color: #aaa; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        /* Story Modal (Principal) */
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 10, 10, 0.92); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: 1.5rem 2rem; max-width: 950px; width: 95%; max-height: 90vh; min-height: 400px; overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: rgba(68, 68, 68, 0.8); border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }

        /* Modal Content Area (Scrollable) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem; scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border); }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.6em; font-size: 1.05rem; }
        #modal-content strong { color: var(--color-tertiary); font-weight: 700; font-family: 'Montserrat'; text-transform: uppercase; font-size: 0.9em; letter-spacing: 0.8px; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; opacity: 0.9; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Montserrat', sans-serif; margin-top: 2em; margin-bottom: 1.1em; color: var(--color-tertiary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.4em; color: var(--color-primary); border-bottom-width: 2px; }
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.1em; color: var(--color-tertiary); border-bottom: none; }
        #modal-content h4 { font-size: 1.0em; color: var(--color-text-muted); border-bottom: none; font-style: italic; font-family: 'Crimson Text'; text-transform: none; letter-spacing: normal;}
        /* Imagen Final */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; filter: grayscale(30%) contrast(110%); }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); filter: grayscale(0%) contrast(100%); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(68, 68, 68, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary);}

        /* Chat Section */
        #chat-section { border-top: 1px dashed var(--color-border); padding-top: 1rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
         #chat-section h3 { font-family: 'Montserrat'; color: var(--color-secondary); font-size: 1.1rem; text-align: center; margin-bottom: 0.8rem; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.6rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(44, 44, 44, 0.7); scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #chat-history::-webkit-scrollbar { width: 7px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.6; font-size: 0.95rem; font-family: 'Crimson Text'; }
        .user-message { background-color: var(--color-secondary); color: white; margin-left: auto; text-align: right; border-radius: var(--border-radius) 0 var(--border-radius) var(--border-radius); }
        .ai-message { background-color: #505050; color: var(--color-text); margin-right: auto; text-align: left; border-radius: 0 var(--border-radius) var(--border-radius) var(--border-radius); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #555; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Crimson Text'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); background-color: #606060; }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-secondary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-primary); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Montserrat'; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* --- MODIFIED: Loading Overlay con Datos Curiosos --- */
        #modal-loading { text-align: center; padding: 2rem 1rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(44, 44, 44, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #modal-loading.active { display: flex; }
        #loading-status { margin-bottom: 1.5rem; display: flex; flex-direction: column; align-items: center;}
        #loading-text { font-weight: 700; color: var(--color-primary); font-size: 1.4rem; margin-bottom: 1.5rem; }
        /* Div para mostrar la frase/dato curioso */
        #frase {
            font-family: 'Crimson Text', serif;
            font-style: italic;
            font-size: 1.15rem;
            color: var(--color-tertiary);
            max-width: 80%;
            margin: 0 auto 1.5rem auto;
            min-height: 60px; /* Espacio para que no salte el layout */
            line-height: 1.6;
            text-shadow: 1px 1px 2px #000;
            border-left: 3px solid var(--color-secondary);
            padding-left: 1rem;
        }
        #loading-spinner-icon {
             font-size: 2.5rem;
             color: var(--color-secondary);
             animation: spin 1.5s linear infinite;
             margin-bottom: 1rem;
        }
        #loading-final-text { font-weight: 400; color: var(--color-text-muted); font-size: 0.95rem; font-family: 'Crimson Text'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Crimson Text'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 10, 10, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-tertiary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-tertiary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-tertiary); color: var(--color-secondary); transform: scale(1.1); }

        /* --- MODIFIED: Unlock Modal (sin countdown) --- */
        #unlock-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.9); display: none; align-items: center; justify-content: center; z-index: 70; padding: 1rem; font-family: 'Crimson Text', serif; }
        #unlock-modal.active { display: flex; }
        .unlock-modal-content { background-color: var(--color-modal-bg); padding: 2.5rem 2rem 2rem 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); text-align: center; max-width: 480px; width: 90%; position: relative; border: 1px solid var(--color-border); }
        .unlock-modal-close-btn { position: absolute; top: 10px; right: 10px; background: transparent; border: none; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; line-height: 1; transition: color 0.2s ease; }
        .unlock-modal-close-btn:hover { color: var(--color-primary); }
        #unlock-modal h3 { font-family: 'Montserrat', sans-serif; color: var(--color-primary); font-size: 1.6rem; margin-bottom: 1.2rem; }
        #unlock-modal p { color: var(--color-text); margin-bottom: 1.8rem; line-height: 1.7; font-size: 1.1rem; }
        #unlock-ad-button { background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.9rem 2.2rem; border: none; border-radius: var(--border-radius); font-family: 'Montserrat', sans-serif; font-size: 1.1rem; cursor: pointer; transition: var(--transition-normal); margin-bottom: 1.5rem; display: inline-block; box-shadow: var(--shadow-md); text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        #unlock-ad-button:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: translateY(-2px); }
        #unlock-ad-button:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; box-shadow: none; transform: none; }
        /* REMOVED countdown display */
        #unlock-status { font-size: 1rem; color: var(--color-tertiary); margin-top: 0.8rem; font-style: italic; min-height: 20px; /* Keep space */ }

    </style>
</head>
<body class="bg-gray-900 text-gray-200">
     <!-- Header/Navbar -->
     <nav class="navbar mb-12">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                  <h1 class="logo text-3xl sm:text-4xl">
                      <i class="fas fa-ghost mr-2 text-blue-300"></i> <!-- Fantasma -->
                      <i class="fas fa-moon mx-1 text-yellow-300"></i> <!-- Luna -->
                      <i class="fas fa-book-skull mr-3 text-red-700"></i> <!-- Libro Calavera -->
                      Leyendas LATAM
                 </h1>
             </div>
             <span class="text-xs text-gray-500 font-sans tracking-wider uppercase">» Susurros en la Noche «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Ecos del Pasado Oscuro</h1>
             <p class="text-xl text-gray-400 mb-8 max-w-3xl mx-auto font-light italic">Historias que se cuentan en voz baja, mitos que acechan en las sombras de Latinoamérica. ¿Te atreves a explorar?</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar leyenda, criatura, lugar maldito...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-map-location-dot text-red-600 mr-2"></i> <!-- Mapa con punto -->
                 Archivos Paranormales
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Desempolvando grimorios antiguos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Ningún eco responde a tu llamada... «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir Más Leyendas (40)
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal (Principal) -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>
             <!-- Loading Overlay con Datos Curiosos -->
             <div id="modal-loading">
                 <div id="loading-status">
                     <p id="loading-text">Investigando el Misterio...</p>
                     <!-- Aquí va el dato curioso -->
                     <div id="frase">Cargando dato interesante...</div>
                      <!-- Ícono de carga -->
                     <i id="loading-spinner-icon" class="fas fa-spinner"></i>
                 </div>
                 <p id="loading-final-text">Mientras el relato emerge de las sombras, un dato curioso para ti.</p>
             </div>
             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content"></div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                      <h3 class="font-montserrat text-secondary text-center mb-2">Consulta al Investigador</h3>
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando archivos clasificados...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta más sobre esta leyenda...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                     <i class="fas fa-exclamation-triangle"></i>
                     <span id="modal-error-message"></span>
                 </div>
             </div>
         </div>
     </div>

      <!-- Unlock Modal (Sin countdown) -->
      <div id="unlock-modal">
          <div class="unlock-modal-content">
              <button class="unlock-modal-close-btn" id="unlock-modal-close" aria-label="Cerrar">&times;</button>
              <h3><i class="fas fa-key mr-2 text-yellow-400"></i> Desvelar Secreto</h3>
              <p>Algunos conocimientos requieren un pequeño pacto. Haz clic en "ANUNCIO" para abrir el velo y acceder a esta leyenda.</p>
              <button id="unlock-ad-button">
                  <i class="fas fa-eye mr-2"></i> ANUNCIO (Abrir el Velo)
              </button>
              <!-- REMOVED COUNTDOWN ELEMENT -->
              <div id="unlock-status"></div> <!-- Status message shown here -->
              <input type="hidden" id="unlock-target-title" value="">
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Ilustración de la Leyenda">
      </div>

      <!-- Footer -->
      <footer class="bg-black text-gray-500 py-6 mt-12 border-t border-gray-800 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Relatos de leyendas urbanas latinoamericanas generados por IA, inspirados en el folklore popular.</p>
              <p class="mt-1">Estas historias son interpretaciones. La verdad... a menudo es más extraña.</p>
              <p class="mt-2">© 2025 Archivos Paranormales Digitales</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const adUrl = 'https://increasingbelieveabonnement.com/pcmu77j4?key=1f38fa224b5ecf757563a32d2d8ac126';
        // REMOVED: unlockCountdownSeconds
        const lockPercentage = 0.8;
        const themePrefix = 'LeyendasLATAM'; // Unique prefix
        const userUnlockedKey = `unlockedTitles_${themePrefix}`;
        const initialLockStateSetFlagKey = `initialLockStateSet_${themePrefix}`;
        const initialLockedSetKey = `initialLockedSet_${themePrefix}`;
        // NEW: URL for fun facts JSON
        const funFactsUrl = 'https://raw.githubusercontent.com/nkkobb1/sitioweb/main/datoscuriosos.json';

        const predefinedTitles = [
            // México
            "La Llorona: El lamento junto al río", "El Charro Negro: El pacto en la encrucijada", "La Isla de las Muñecas (Xochimilco)", "El Nahual: El cambiaformas ancestral", "La Planchada: La enfermera fantasma", "El Callejón del Beso (Guanajuato)", "La leyenda del Popocatépetl e Iztaccíhuatl", "El Chupacabras: Orígenes y avistamientos", "Las Momias de Guanajuato", "La Casa de los Tubos (Monterrey)",
            // Colombia
            "El Silbón: El espíritu de los Llanos", "La Patasola: La mujer de una sola pierna", "El Mohán (El Poira): Guardián de ríos y tesoros", "La Madre Monte (Madreselva): Espíritu protector de la selva", "El Hombre Caimán (Plato, Magdalena)", "La Candileja: El espíritu errante de fuego", "El Sombrerón (Colombia/Guatemala)", "La Llorona (versión colombiana)", "La Muelona (La Colmillona)", "El Duende (Mitos sobre duendes)",
            // Argentina
            "La Luz Mala (El Farol de Mandinga)", "El Lobizón (El Hombre Lobo Guaraní)", "La Viuda Negra (leyenda urbana)", "Nahuelito: El monstruo del lago Nahuel Huapi", "El Pombero (Mito Guaraní)", "Gauchito Gil: El santo popular", "La Telesita: La bailarina del monte", "La Cueva de Salamanca", "El Familiar: El perro demoníaco del ingenio", "La leyenda de la Yerba Mate",
            // Chile
            "El Caleuche: El buque fantasma", "El Trauco: El seductor del bosque chilote", "La Fiura: La mujer deforme de Chiloé", "El Alicanto: El ave de los metales preciosos", "La Pincoya: La diosa marina de la fertilidad", "El Chonchón (Tué-tué): La bruja voladora", "La Quintrala: La terrateniente cruel", "El Cuero: El monstruo acuático", "La Añañuca: La flor de la leyenda", "La Calchona: La bruja transformada",
            // Perú
            "El Pishtaco (Nakaq): El degollador de los Andes", "El Tunche Maligno (El espíritu silbador de la selva)", "El Yacumama: La serpiente gigante de agua", "El Chullachaqui: El duende de los pies desiguales", "El Muqui: El duende minero", "La Runa Mula (Mula sin cabeza)", "La Casa Matusita (Lima)", "Jarjacha: El demonio incestuoso", "El Cóndor de Chavín", "La Laguna de Paca (Jauja)",
            // Venezuela
            "La Sayona: La mujer vengativa", "El Silbón (versión venezolana)", "La Loca Luz Caraballo (Andes)", "María Lionza: La diosa del culto", "El Carretón de la Muerte", "El Ánima Sola", "El Hachador Perdido", "La Novia de Puerto Cabello", "Juan Hilario: El espanto de El Palito", "Los Duendes de la Colonia Tovar",
            // Centroamérica (General/Varios Países)
            "La Cegua (Siguanaba): La mujer con cara de caballo", "El Cadejo (Blanco y Negro): Los perros guardianes/demoníacos", "El Sombrerón (Guatemala)", "La Carreta Nagua (Carreta sin bueyes)", "La Tulevieja (Mujer con patas de ave)", "Los Duendes (variaciones regionales)", "La Llorona (versiones centroamericanas)", "El Padre sin Cabeza", "La Mocuana (Nicaragua)", "La Sucia (Honduras)",
            // Otros Países (Bolivia, Ecuador, Paraguay, Uruguay, etc.)
            "El Tío de la Mina (Bolivia)", "El Guagua Auca (Ecuador)", "El Jasy Jatere (Paraguay)", "Luisón (Paraguay - variante del Lobizón)", "La Llorona del Parque Rodó (Uruguay)", "El Kari Kari (Bolivia)", "La Dama Tapada (Ecuador)", "Ao Ao (Mito Guaraní, Paraguay)", "La Mano Peluda (leyenda radial extendida)", "Leyendas de tesoros escondidos (Común en varios países)",
             // Tipos de Leyendas
            "Fantasmas y Apariciones en Latinoamérica", "Criaturas Míticas de los Andes", "Monstruos Acuáticos del Folklore LATAM", "Espíritus Protectores de la Naturaleza", "Leyendas de Brujas y Hechiceros", "Pactos con el Diablo en Leyendas", "Duendes y Criaturas Feéricas", "Animales Cambiaformas (Nahualismo)", "Leyendas de Lugares Embrujados", "Santos Populares y Figuras Milagrosas", "Leyendas sobre Tesoros y Guacas", "Mitos de Creación Indígena", "Leyendas Urbanas Modernas (Internet/Ciudades)", "Maldiciones Familiares y Objetos Malditos", "Leyendas de Carreteras Peligrosas",
            // ... (Continuar hasta ~400, profundizando en variantes, personajes secundarios, etc.)
            "El Jinete sin Cabeza (adaptaciones LATAM)", "La Leyenda del Dorado", "Serpientes Gigantes en la Amazonía", "Las Sirenas Encantadoras (costas)", "El Basilisco Chilote", "La Voladora (Bruja voladora, distintas regiones)", "Íncubos y Súcubos en el folklore", "Leyendas de Cementerios", "La Leyenda del Maíz", "El Origen Mítico del Cacao", "La Niña de la Curva", "El Juego de la Copa", "Verónica (El espejo)", "El Silbido del Afilador", "Las Voces de la Noche", "El Perro Negro de la Muerte", "La Procesión de las Ánimas", "El Alma en Pena del Conquistador", "El Fantasma del Monje", "La Maldición de la Malinche", "El Tesoro de Moctezuma", "La Ciudad Perdida de Z", "El Yeti de los Andes (Ukumar)", "El Mapinguari (Amazonas)", "La Leyenda del Ceibo", "La Flor del Irupé", "Mitos sobre Volcanes", "Leyendas de Cuevas Sagradas", "El Coco (Cuco / Boogeyman)", "El Viejo del Saco (Hombre de la Bolsa)"
        ];
        const legendThemes = [
            "fantasmas latinoamerica", "criptozoologia latam", "mitos indigenas", "leyendas coloniales", "lugares embrujados latam", "folklore andino", "folklore amazonico", "leyendas de pactos", "criaturas nocturnas latam", "espiritus del agua latam", "brujeria latinoamerica", "leyendas urbanas modernas latam", "mitos de origen", "tesoros escondidos latam", "santos populares latam"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un Investigador de lo Paranormal y narrador experto en folklore y leyendas urbanas de Latinoamérica. Relata la leyenda consultada con atmósfera, detalle y respeto por la tradición oral. Incluye orígenes posibles, variantes regionales (si las conoces), descripciones de la entidad o fenómeno, y el impacto cultural. Tu tono debe ser intrigante y ligeramente ominoso. Extensión objetivo: 1200-1300 palabras. La leyenda es:",
            timeoutSeconds: 180
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como asistente del Investigador Paranormal. Responde preguntas específicas sobre la leyenda recién narrada. Clarifica detalles sobre avistamientos, variantes, simbolismos o consejos para 'evitar' a la entidad, siempre basándote en el folklore descrito. Sé conciso y mantén el tono misterioso.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Genera una lista concisa de 40 títulos específicos sobre leyendas urbanas, mitos o folklore de diferentes países de Latinoamérica (criaturas, fantasmas, lugares, historias). Devuelve *solo* la lista de ítems, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, añadiendo funFactDisplay)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        // NEW: Element for fun fact
        const funFactDisplay = document.getElementById('frase');
        // REMOVED: puzzleCanvas, puzzleScoreLevelText
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        const unlockModal = document.getElementById('unlock-modal');
        const unlockModalCloseBtn = document.getElementById('unlock-modal-close');
        const unlockAdButton = document.getElementById('unlock-ad-button');
        // REMOVED: unlockCountdownDisplay
        const unlockStatusDisplay = document.getElementById('unlock-status');
        const unlockTargetTitleInput = document.getElementById('unlock-target-title');

        // ========== State Variables ==========
        let currentTopicTitle = null;
        let initialLockedTitles = loadInitialLockedSet();
        // REMOVED: countdownInterval
        // NEW: Variables for fun facts
        let funFactsData = null;
        let funFactInterval = null;


        // ========== LocalStorage Functions (Unlock Persistence & Initial Lock State) ==========
        // (Sin cambios respecto al ejemplo anterior)
        function getJsonFromStorage(key) { /* ... */ try{const s=localStorage.getItem(key); return s?JSON.parse(s):null;}catch(e){console.error(`Error reading ${key}:`,e); return null;} }
        function setJsonInStorage(key, value) { /* ... */ try{localStorage.setItem(key,JSON.stringify(value));}catch(e){console.error(`Error saving ${key}:`,e);} }
        function getUnlockedTitles() { const a=getJsonFromStorage(userUnlockedKey); return new Set(a||[]); }
        function saveUnlockedTitles(unlockedSet) { setJsonInStorage(userUnlockedKey, Array.from(unlockedSet)); }
        function isTitleUnlockedByUser(title) { return getUnlockedTitles().has(title); }
        function unlockTitlePermanentlyByUser(title) { if(!title)return; const u=getUnlockedTitles(); if(!u.has(title)){u.add(title);saveUnlockedTitles(u);console.log(`User unlocked: ${title}`);updateTitleItemLockStatus(title,false);} }
        function loadInitialLockedSet() { const a=getJsonFromStorage(initialLockedSetKey); return new Set(a||[]); }
        function saveInitialLockedSet(lockedSet) { setJsonInStorage(initialLockedSetKey, Array.from(lockedSet)); }
        function isInitialLockStateSet() { return localStorage.getItem(initialLockStateSetFlagKey)==='true'; }
        function setInitialLockStateFlag() { localStorage.setItem(initialLockStateSetFlagKey,'true'); }
        function isTitleInitiallyLocked(title) { return initialLockedTitles.has(title); }


        // ========== API FUNCTIONS ==========
        // (Sin cambios lógicos, solo prompts adaptados)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Actúa como asistente del Investigador Paranormal. Responde preguntas específicas sobre la leyenda '${currentTopicTitle}'. Clarifica detalles, variantes, simbolismos o consejos. Sé conciso y mantén el tono misterioso.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Hay interferencia ectoplásmica. Los servidores están ocupados. Intenta más tarde.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("El Investigador no encontró nada (respuesta vacía). Intenta de nuevo.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La consulta tardó demasiado (>${config.timeoutSeconds}s). La conexión es débil o el Más Allá no responde. Inténtalo de nuevo.`);
                 throw new Error(error.message || "Error desconocido contactando los archivos ocultos.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopicTitle) throw new Error("Contexto de la leyenda perdido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(legendThemes) || "leyendas latinoamericanas variadas";
             const specificPrompt = `Genera 40 títulos específicos sobre ${randomTheme}`;
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 10) throw new Error("La IA no conjuró suficientes ideas de leyendas.");
                     return titles.slice(0, 40);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Latin American urban legend";
            const enhancedPrompt = `Eerie, atmospheric digital painting illustrating the Latin American legend '${safePromptText}'. Dark, mysterious mood, focus on folklore elements, maybe shadowy figures or creepy landscape. Use a dark color palette (deep blues, grays, blacks, hints of red or ghostly white). Style: slightly stylized horror illustration, evocative, mysterious. No text, words, logos.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, bright colors, happy scene, cartoonish";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */ if(!rawText)return'';let f=rawText.trim();f=f.replace(/\\text\{(.*?)\}/g,'$1');f=f.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');f=f.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(m,b,e)=>{const c=e.replace('−','-');return`${b}<sup>${c}</sup>`;});f=f.replace(/\\rightarrow/g,'&rarr;');f=f.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');f=f.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');f=f.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');f=f.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');f=f.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');f=f.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');f=f.replace(/\*(.*?)\*/g,'<em>$1</em>');const b=f.split(/\n\s*\n/).filter(p=>p.trim().length>0);f=b.map(blk=>{if(blk.startsWith('<h')||blk.startsWith('<p class="formula">'))return blk;let c=blk.replace(/\n/g,' ');return`<p>${c}</p>`;}).join('');return f; }


         // ========== FUN FACT FUNCTIONS ==========
         async function fetchFunFacts() {
             if (funFactsData) return; // Already loaded
             try {
                 console.log("Fetching fun facts from:", funFactsUrl);
                 const response = await fetch(funFactsUrl);
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                 funFactsData = await response.json();
                 console.log("Fun facts loaded successfully.");
             } catch (error) {
                 console.error("Error fetching or parsing fun facts:", error);
                 funFactsData = null; // Ensure it's null on error
                 if (funFactDisplay) funFactDisplay.textContent = "No se pudieron cargar los datos curiosos.";
             }
         }

         function displayRandomFunFact() {
             if (!funFactsData || !funFactDisplay) {
                 // console.warn("Fun facts data not available or display element missing.");
                 if(funFactDisplay) funFactDisplay.textContent = "..."; // Placeholder
                 return;
             }
             try {
                 const categories = Object.keys(funFactsData);
                 if (categories.length === 0) {
                     funFactDisplay.textContent = "No hay categorías de datos disponibles.";
                     return;
                 }
                 const randomCategory = categories[Math.floor(Math.random() * categories.length)];
                 const factsInCategory = funFactsData[randomCategory];
                 if (!factsInCategory || factsInCategory.length === 0) {
                     funFactDisplay.textContent = `No hay datos en la categoría: ${randomCategory}`;
                     return;
                 }
                 const randomFact = factsInCategory[Math.floor(Math.random() * factsInCategory.length)];
                 funFactDisplay.textContent = `Dato Curioso (${randomCategory}): ${randomFact}`;
             } catch (error) {
                 console.error("Error selecting/displaying fun fact:", error);
                 funFactDisplay.textContent = "Error al mostrar dato curioso.";
             }
         }

         function startFunFactInterval() {
             if (!funFactsData) {
                 console.warn("Cannot start fun fact interval: data not loaded.");
                 fetchFunFacts(); // Attempt to load it again if needed
                 return;
             }
             stopFunFactInterval(); // Clear any existing interval
             funFactInterval = setInterval(displayRandomFunFact, 8000); // Change every 5 seconds
             displayRandomFunFact(); // Display one immediately
             console.log("Fun fact interval started.");
         }

         function stopFunFactInterval() {
             if (funFactInterval) {
                 clearInterval(funFactInterval);
                 funFactInterval = null;
                 console.log("Fun fact interval stopped.");
             }
             if (funFactDisplay) {
                 funFactDisplay.textContent = ""; // Clear the display
             }
         }


        // ========== MODAL FUNCTIONS ==========
        // (No cambios lógicos en show/hide modals)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { storyModal.classList.remove('active'); if (!imageFullscreenOverlay.classList.contains('active') && !unlockModal.classList.contains('active')) { document.body.style.overflow = ''; } modalTextArea.scrollTop = 0; stopFunFactInterval(); /* <-- Stop fun facts */ resetModalState(); }
        function resetModalState() { modalLoadingIndicator.classList.remove('active'); modalStoryContentArea.classList.add('content-hidden'); modalError.classList.add('content-hidden'); modalTitle.textContent = ''; modalContent.innerHTML = ''; modalErrorMessage.textContent = ''; chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; currentTopicTitle = null; hideFullscreenImage(); chatSection.classList.remove('content-hidden'); stopFunFactInterval(); /* <-- Ensure stopped */ }
        function showUnlockModal(titleToUnlock) { unlockTargetTitleInput.value = titleToUnlock; unlockStatusDisplay.textContent = ''; unlockAdButton.disabled = false; unlockModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideUnlockModal() { unlockModal.classList.remove('active'); if (!storyModal.classList.contains('active') && !imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; } /* No interval to clear here */ }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active') && !unlockModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios lógicos)
        function addChatMessage(message, sender) { /* ... */ const d=document.createElement('div');d.className=`chat-message ${sender==='user'?'user-message':'ai-message'}`;message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>');d.innerHTML=message;chatHistory.appendChild(d);chatHistory.scrollTop=chatHistory.scrollHeight;}
        function addChatError(message) { /* ... */ const e=document.createElement('div');e.className='chat-error';e.textContent=message;chatHistory.appendChild(e);chatHistory.scrollTop=chatHistory.scrollHeight;}
        async function handleSendMessage() { /* ... */ const q=chatInput.value.trim();if(!q||chatSendBtn.disabled)return;addChatMessage(q,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const r=await fetchChatResponse(q);addChatMessage(r,'ai');}catch(e){console.error("Chat Error:",e);addChatError(`Error del Investigador: ${e.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}}

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }

        // createTitleItem & updateTitleItemLockStatus (Sin cambios lógicos respecto al anterior)
        function createTitleItem(title) { const div = document.createElement('div'); div.className = 'title-item'; div.setAttribute('data-title', title); const textSpan = document.createElement('span'); textSpan.className = 'title-text'; textSpan.textContent = title; div.appendChild(textSpan); const initiallyLocked = isTitleInitiallyLocked(title); const unlockedByUser = isTitleUnlockedByUser(title); const isEffectivelyLocked = initiallyLocked && !unlockedByUser; div.setAttribute('data-locked', isEffectivelyLocked ? 'true' : 'false'); div.style.cursor = 'pointer'; if (isEffectivelyLocked) { div.classList.add('locked'); const lockIcon = document.createElement('i'); lockIcon.className = 'fas fa-lock lock-icon'; div.appendChild(lockIcon); } else { div.classList.remove('locked'); } div.addEventListener('click', () => handleTitleClick(title, div)); return div; }
        function updateTitleItemLockStatus(title, isLocked) { const item=titleListContainer.querySelector(`.title-item[data-title="${CSS.escape(title)}"]`); if(item){ item.setAttribute('data-locked',isLocked?'true':'false'); item.classList.toggle('locked',isLocked); let icon=item.querySelector('.lock-icon'); if(isLocked&&!icon){icon=document.createElement('i');icon.className='fas fa-lock lock-icon';item.appendChild(icon);} else if(!isLocked&&icon){icon.remove();}}}

        // displayTitles & appendTitles (Sin cambios lógicos respecto al anterior)
        function displayTitles(titles) { if (!titleListContainer || !titlesLoading) return; if (!isInitialLockStateSet() && titles.length > 0) { console.log("Setting initial lock state..."); const shuffled=shuffleArray([...titles]); const lockCount=Math.floor(titles.length*lockPercentage); const newInitialLockedSet=new Set(); for(let i=0;i<lockCount;i++){newInitialLockedSet.add(shuffled[i]);} saveInitialLockedSet(newInitialLockedSet); setInitialLockStateFlag(); initialLockedTitles=newInitialLockedSet; console.log(`Initially locked ${initialLockedTitles.size} titles.`); } else { console.log(`Initial lock state loaded: ${initialLockedTitles.size} initially locked.`); } const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none'; if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» Silencio absoluto en los archivos... «</p>'; return; } sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { if(!titleListContainer||!newTitles||newTitles.length===0)return; const existing=new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(i=>i.dataset.title)); let added=false; newTitles.forEach(t=>{if(!existing.has(t)){titleListContainer.appendChild(createTitleItem(t)); if(!initialLockedTitles.has(t)){initialLockedTitles.add(t);added=true;}}}); if(added){saveInitialLockedSet(initialLockedTitles);console.log("Added new titles to persistent initial locked set.");} filterTitles(searchInput.value); }

        // handleTitleClick (Sin cambios lógicos)
        function handleTitleClick(title, titleElement) { const isLocked = titleElement.getAttribute('data-locked') === 'true'; if (isLocked) { console.log(`Title "${title}" locked. Show unlock modal.`); showUnlockModal(title); } else { console.log(`Title "${title}" unlocked. Load content.`); loadContentForTitle(title); } }

        // *** MODIFIED: loadContentForTitle starts fun fact interval ***
        async function loadContentForTitle(title) {
            resetModalState(); showModal(); currentTopicTitle = title;
            modalTitle.textContent = title;
            modalStoryContentArea.classList.add('content-hidden');
            modalError.classList.add('content-hidden');

            // --- START FUN FACTS ---
            modalLoadingIndicator.classList.add('active');
            startFunFactInterval();
            // --- END START FUN FACTS ---

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // --- STOP FUN FACTS ---
                stopFunFactInterval();
                modalLoadingIndicator.classList.remove('active');
                // --- END STOP FUN FACTS ---

                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0; // Reset scroll

                // Load Image (igual que antes)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Conjurando una visión...</p>`;
                modalContent.appendChild(placeholderDiv);
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">La visión se desvanece.</p>`; };
                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                 else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al invocar imagen.</p>`;}

            } catch (error) {
                console.error("Failed display:", error);
                // --- STOP FUN FACTS (in case of error) ---
                stopFunFactInterval();
                modalLoadingIndicator.classList.remove('active');
                // --- END STOP FUN FACTS ---
                modalErrorMessage.textContent = error.message || "Error desconocido al invocar la leyenda.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleAdButtonClick removes countdown ***
        function handleAdButtonClick() {
            const titleToUnlock = unlockTargetTitleInput.value;
            if (!titleToUnlock || unlockAdButton.disabled) return;

            console.log(`Ad button clicked for title: ${titleToUnlock}`);
            window.open(adUrl, '_blank'); // Open ad in new tab

            // Disable button and show immediate feedback
            unlockAdButton.disabled = true;
            unlockStatusDisplay.textContent = '¡Secreto Desvelado!';

            // --- Unlock and load immediately ---
            unlockTitlePermanentlyByUser(titleToUnlock); // Unlock in localStorage

            // Short delay just for user to see the status message briefly
            setTimeout(() => {
                 hideUnlockModal();
                 loadContentForTitle(titleToUnlock); // Load the content
             }, 300); // 0.3 seconds delay

            // --- REMOVED: setInterval countdown logic ---
        }

        // handleGenerateMoreTitles (Sin cambios lógicos)
        async function handleGenerateMoreTitles() { if(!generateMoreBtn||!generateMoreSpinner||!generateMoreContainer)return; generateMoreBtn.disabled=true; generateMoreBtn.innerHTML='<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más susurros...'; try{const t=await fetchGeneratedTitles(); if(t&&t.length>0){appendTitles(t);}else{alert("No se encontraron más leyendas por ahora.");}}catch(e){console.error("Failed title generation:",e);alert(`Error buscando leyendas: ${e.message}`);}finally{generateMoreBtn.disabled=false;generateMoreBtn.innerHTML='<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir Más Leyendas (40)';}}

         // Search Filter Function (sin cambios)
         function filterTitles(searchTerm) { const term=searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(); const items=titleListContainer.querySelectorAll('.title-item'); let count=0; items.forEach(item=>{ const text=item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""); const isVisible=text.includes(term); item.classList.toggle('hidden',!isVisible); if(isVisible)count++; }); noResultsMsg.classList.toggle('hidden',count>0); }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check essential elements, including fun fact display
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !funFactDisplay /* <-- Check new element */ || !modalLoadingIndicator || !unlockModal || !unlockModalCloseBtn || !unlockAdButton || !unlockStatusDisplay || !unlockTargetTitleInput) {
                console.error("Initialization failed: Missing essential UI elements (check #frase).");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: El grimorio está incompleto. Faltan componentes.</p>';
                return;
             }

             // --- Fetch fun facts on startup ---
             fetchFunFacts();

             // Event Listeners (Igual que antes)
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
             unlockModalCloseBtn.addEventListener('click', hideUnlockModal);
             unlockModal.addEventListener('click', (event) => { if (event.target === unlockModal) hideUnlockModal(); });
             unlockAdButton.addEventListener('click', handleAdButtonClick); // Handles immediate unlock now

             // Initial display
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>
