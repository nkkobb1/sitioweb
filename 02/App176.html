<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grimorio Oscuro: Cuentos Reimaginados</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Góticas/Elegantes -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Cuentos Subvertidos --- */
        :root {
            --color-primary: #8a2be2; /* Púrpura Intenso */
            --color-secondary: #b22222; /* Rojo Ladrillo/Sangre Seca */
            --color-tertiary: #daa520; /* Dorado Apagado */
            --color-background: #1a1a1a; /* Negro Carbón */
            --color-text: #e8e6e3; /* Blanco Hueso/Pergamino Claro */
            --color-text-muted: #a9a9a9; /* Gris Oscuro */
            --color-modal-bg: #2d2d2d; /* Gris Muy Oscuro */
            --color-border: #4a4a4a; /* Borde Gris Medio */
            --color-error-bg: #3b1f1f; /* Fondo error rojo muy oscuro */
            --color-error-text: #f5c6cb; /* Texto error rosa pálido */
            --color-error-border: #8b0000; /* Borde error rojo oscuro */

            --shadow-sm: 0 1px 3px 0 rgba(138, 43, 226, 0.2);
            --shadow-md: 0 4px 6px -1px rgba(138, 43, 226, 0.25), 0 2px 4px -2px rgba(138, 43, 226, 0.2);
            --shadow-lg: 0 0 20px -3px rgba(138, 43, 226, 0.3), 0 8px 10px -6px rgba(138, 43, 226, 0.2);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.3s ease-in-out;

            /* Sutil textura de fondo (opcional) */
            /* background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%233a3a3a" fill-opacity="0.07"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); */
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.8; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel Decorative', cursive; font-weight: 700; letter-spacing: 1.5px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px rgba(138, 43, 226, 0.7); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 8px rgba(138, 43, 226, 0.6); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 5px rgba(138, 43, 226, 0.5); }
        .navbar { background-color: rgba(26, 26, 26, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(45, 45, 45, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Merriweather', serif; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Merriweather', serif; font-size: 1.05rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #3a3a3a; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: var(--color-background); padding: 0.9rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel Decorative', cursive; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.4); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.92); backdrop-filter: blur(3px); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 980px; /* Slightly wider for readability */
            width: 95%;
            max-height: 90vh;
            min-height: 450px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg), 0 0 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            border-left: 5px solid var(--color-primary);
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: var(--color-background); transform: rotate(-180deg); box-shadow: 0 0 12px var(--color-secondary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.4; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(74, 74, 74, 0.5);
        }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(74, 74, 74, 0.5); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-size: 1.05em; /* Slightly larger text */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.6em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel Decorative', cursive; margin-top: 2.4em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 400; letter-spacing: 1px;}
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.15em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 3rem auto 1.5rem auto; border: 2px solid var(--color-border); border-radius: var(--border-radius); box-shadow: 0 0 18px rgba(0, 0, 0, 0.5); cursor: pointer; transition: transform 0.25s ease, box-shadow 0.25s ease; filter: saturate(0.9) brightness(0.95); /* Slightly desaturated/darker */ }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: 0 0 25px rgba(138, 43, 226, 0.4); filter: saturate(1) brightness(1); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 160px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(74, 74, 74, 0.8); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; opacity: 0.7; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1.2rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(26, 26, 26, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(74, 74, 74, 0.5);
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(74, 74, 74, 0.5); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; font-size: 0.95em; }
        .user-message { background-color: var(--color-tertiary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .ai-message { background-color: #4a4a4a; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #3a3a3a; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #a040ff; } /* Lighter purple */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.6rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-style: italic; }
        #chat-loading .fa-spinner { margin-right: 0.6rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 26, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 7px solid var(--color-border); border-top-color: var(--color-primary); border-bottom-color: var(--color-secondary); /* Dual color spin */ border-radius: 50%; animation: spin 1.3s linear infinite; margin: 0 auto 1.8rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-text); font-size: 1.5rem; font-family: 'Cinzel Decorative'; text-shadow: 0 0 8px var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Merriweather', serif; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 26, 26, 0.96); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: var(--shadow-lg), 0 0 40px rgba(0,0,0,0.6); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1) rotate(90deg); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-book-dead mr-3 text-purple-400"></i> <!-- Icono grimorio -->
                     Grimorio Oscuro
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">~ Cuentos Reimaginados ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Donde las Sombras Danzan</h1>
             <p class="text-xl text-gray-300 mb-8 max-w-3xl mx-auto font-light italic">Desentraña los relatos clásicos, corrompidos y retorcidos. El "felices para siempre" es solo el comienzo de la pesadilla.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar un cuento o una sombra...">
             <i class="fas fa-search fa-spider"></i> <!-- Icono araña/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll text-yellow-600 mr-2"></i> <!-- Icono pergamino -->
                 Capítulos Prohibidos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans italic">Consultando los anales olvidados...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-4 hidden font-sans italic">~ Ninguna leyenda coincide con tu susurro ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Invocar Nuevas Historias
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Tejiendo la Trama...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                      <h3 class="text-center text-lg font-semibold text-purple-300 mb-3 font-['Cinzel_Decorative']">Conversar con la Sombra</h3>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                         <p class="text-gray-400 text-sm italic p-2 text-center">Pregunta sobre los secretos de esta versión del cuento...</p>
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando al oráculo...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Susurra tu pregunta...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-feather-alt"></i> <!-- Icono pluma -->
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Ilustración del Cuento Reimaginado">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-12 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Relatos generados por IA, inspirados en el folclore clásico con un giro oscuro.</p>
              <p class="mt-1">Estas versiones son interpretaciones ficticias con fines narrativos.</p>
              <p class="mt-2">© Nunca Jamás - Grimorio Oscuro</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Cenicienta
            "Cenicienta: La Venganza de Cristal", "El Hada Madrina Cadáver", "Medianoche Sangrienta: El Baile de Cenicienta", "Las Hermanastras Marcadas", "El Príncipe Nigromante y Cenicienta", "El Zapato Embrujado", "La Calabaza Devoradora", "El Pacto de Cenicienta con las Sombras", "El Reino de Cenizas", "La Madrastra Justificada", "El Sirviente Leal de Cenicienta (y sus secretos)", "Los Ratones Espías de Cenicienta", "Más Allá del Felices Para Siempre: El Reinado de Cenicienta", "El Espejo Roto de la Madrastra", "El Legado Oscuro del Padre de Cenicienta",
            // Blancanieves
            "Blancanieves y los Siete Pecados Capitales", "El Espejo Prisionero", "La Reina Envenenadora y su Aprendiz", "El Corazón del Cazador", "El Bosque Hambriento", "La Manzana de la Locura", "Blancanieves, Reina de los Enanos Oscuros", "El Príncipe Necrófilo", "La Maldición de la Belleza Eterna", "El Despertar Equivocado de Blancanieves", "La Verdadera Naturaleza de los Enanos", "El Secreto de la Madrastra de Blancanieves", "El Castillo de Cristal y Hueso", "La Rebelión de las Criaturas del Bosque", "Blancanieves: El Invierno Sin Fin",
            // Caperucita Roja
            "Caperucita Roja: La Cazadora de Lobos", "El Lobo Interior de Caperucita", "La Abuela Devoradora", "El Bosque que Susurra Mentiras", "El Pacto entre el Leñador y el Lobo", "La Cesta de los Horrores", "Cuando Caperucita se Unió a la Manada", "El Síndrome de Estocolmo de Caperucita", "La Venganza del Bosque contra los Humanos", "La Aldea Maldita de Caperucita", "El Manto Rojo Sangre", "La Verdadera Presa", "El Último Leñador", "Secretos Ocultos en la Cesta", "La Abuela no era quien Parecía",
            // Hansel y Gretel
            "Hansel y Gretel: Los Niños Caníbales", "La Bruja Inocente", "El Sendero de Migajas que Llevaba al Infierno", "La Casa de Caramelo Trampa Mortal", "El Horno que Exigía Sacrificios", "Cuando los Padres Vendieron a sus Hijos", "El Bosque de Huesos y Dulces", "Gretel, la Aprendiz de Bruja", "El Hambre que Corrompe", "La Venganza de los Niños Perdidos", "La Jaula Dorada", "El Engaño de la Bruja", "Secretos Familiares de Hansel y Gretel", "El Tesoro Maldito de la Bruja", "Escapando del Bosque, Entrando en la Pesadilla",
            // La Bella Durmiente
            "La Bella Durmiente: El Sueño Eterno (y lo que vive en él)", "Maléfica: La Profecía Inevitable", "El Beso que Desató la Plaga", "El Reino Cubierto de Espinas y Secretos", "Las Hadas Madrinas y su Magia Oscura", "El Príncipe Maldito", "Despertar a un Monstruo", "Cien Años de Pesadillas", "La Rueca del Destino Fatal", "El Precio del Despertar", "El linaje secreto de Aurora", "Cuando el castillo durmió demasiado", "La verdadera razón del rencor de Maléfica", "El dragón interior de Maléfica", "El sueño lúcido de Aurora",
            // La Sirenita
            "La Sirenita: El Contrato de Sangre con la Bruja del Mar", "La Voz Robada, el Alma Perdida", "El Príncipe Obsesionado con lo Exótico", "El Reino Submarino de Pesadilla", "Las Hermanas Vengativas de la Sirenita", "El Beso de la Muerte Salada", "Convertirse en Espuma y Vagar Eternamente", "El Tridente Maldito de Tritón", "El Sacrificio Inútil", "Cuando el Mar Reclamó su Deuda", "La locura del Rey Tritón", "Ursula, la exiliada con razón", "El naufragio provocado", "Las criaturas abisales del trato", "El corazón frío del príncipe",
            // Rapunzel
            "Rapunzel: La Torre Prisión Mental", "La Bruja Gothel y su Jardín de Almas Robadas", "El Cabello que Atrapa y Estrangula", "El Príncipe Ciego y Vengativo", "Escapar para Caer en Algo Peor", "El Precio de la Magia Capilar", "La Canción que Enloquece", "El Reino Perdido de Rapunzel", "Gemelos Nacidos de la Oscuridad", "La Torre que se Alimentaba de Esperanza", "El origen del poder de Gothel", "El pacto de los padres de Rapunzel", "La verdadera identidad del Príncipe", "Las lágrimas curativas tenían un coste", "Rapunzel y la maldición de la torre",
            // La Bella y la Bestia
            "La Bella y la Bestia: La Maldición Sádica", "Bella, la Carcelera", "La Bestia que Disfrutaba su Forma", "El Castillo Viviente y Hambriento", "Los Objetos Encantados Tormentosos", "Gastón, el Héroe Caído (o el verdadero monstruo)", "La Rosa Marchita y la Podredumbre del Alma", "El Amor que Corrompe", "Cuando la Bestia no Quiso Volver a Ser Humano", "El Secreto Oscuro de la Aldea", "La biblioteca prohibida del castillo", "El origen de la maldición de la Bestia", "El espejo mágico que mostraba horrores", "La verdadera naturaleza de la hechicera", "Bella y el síndrome de Estocolmo",
            // Otros Cuentos y Arquetipos
            "Rumpelstiltskin: El Cobrador de Deudas del Alma", "El Flautista de Hamelín: La Melodía del Apocalipsis", "Jack y las Habichuelas Mágicas: El Gigante Caníbal Justificado", "El Gato con Botas: El Estafador Demoníaco", "Pulgarcito: El Niño Abandonado y la Semilla del Mal", "Los Tres Cerditos: La Fortaleza Inexpugnable (y lo que oculta)", "Ricitos de Oro: La Invasora Psicópata", "El Patito Feo: La Transformación Monstruosa", "La Reina de las Nieves: El Corazón Congelado y el Reino de la Muerte", "El Soldadito de Plomo: La Obsesión Incinerada", "La Princesa y el Guisante: La Sensibilidad que Enloquece", "El Traje Nuevo del Emperador: La Locura Colectiva", "Barba Azul: El Coleccionista de Secretos (y Esposas)", "Las Zapatillas Rojas: El Baile hasta la Muerte", "El Príncipe Rana: La Maldición Viscosa",
            // Conceptos Generales Subvertidos
            "El Verdadero Costo de los Deseos Mágicos", "Cuando las Hadas Madrinas son Agentes del Caos", "El Lado Oscuro de 'Y Vivieron Felices Para Siempre'", "Reinos Construidos sobre Secretos y Sangre", "La Magia Prohibida y sus Consecuencias", "Los Monstruos que se Esconden a Plena Vista", "El Héroe que se Convierte en Villano", "La Profecía Ineludiblemente Trágica", "El Pacto Demoníaco por un Reino", "Bosques Encantados que Devoran Almas", "Objetos Mágicos con Voluntad Propia (y Maligna)", "La Maldición Hereditaria de la Realeza", "El Espejo que Refleja la Verdad más Oscura", "El Amor Verdadero como Catalizador del Desastre", "La Inocencia Perdida en el Corazón del Cuento",
             "El Contrato Roto con el Ser Feérico", "La Venganza de las Criaturas del Bosque", "Princesas Guerreras en Reinos Decadentes", "Príncipes Azules con Corazones Negros", "Madrastras con Motivos Ocultos (y Justificados)", "Brujas Incomprendidas o Poderes Ancestrales", "Gigantes Melancólicos y Olvidados", "Dragones como Últimos Guardianes de la Magia Antigua", "Sirenas que Atraen a la Locura", "Enanos Mineros de Almas", "Duendes Ladrones de Sueños", "Hombres Lobo Atrapados entre Dos Mundos", "Vampiros en Cortes Reales Olvidadas", "Fantasmas Atados a Castillos Malditos", "Golems Creados por Desesperación",
             "La Biblioteca de los Cuentos Prohibidos", "El Cartógrafo de Tierras Malditas", "El Alquimista que Buscaba la Vida Eterna (y la encontró... a qué precio)", "La Costurera que Tejía Destinos Rotos", "El Juglar cuyas Canciones Invocaban Demonios", "El Cazador Atormentado por sus Presas", "La Curandera que Usaba Sangre para Sanar", "El Caballero Caído en Desgracia", "La Doncella que Hizo un Pacto con la Noche", "El Rey Loco y su Corte de Sombras", "La Reina Araña y su Telaraña de Intriga", "El Niño Cambiado por un Horror Feérico", "La Isla de las Muñecas Olvidadas", "El Carnaval Ambulante de las Pesadillas", "El Relojero que Podía Detener el Tiempo (pero no la Muerte)",
             // Más títulos... buscando la exhaustividad
             "El Jardín Secreto de Perséfone (en el mundo de los cuentos)", "Cuando los Deseos se Cumplen Literalmente", "La Plaga desatada por un Beso de Amor", "El linaje maldito de la realeza feérica", "El Grial Profano", "La Máscara del Príncipe Feliz", "El Titiritero de Almas", "La Ciudad Sumergida de Ys (versión cuento)", "El Laberinto del Minotauro (en un castillo encantado)", "La Torre de Babel de los Deseos Rotos", "El Río Leteo que Fluye por el Bosque Encantado", "Los Jinetes del Apocalipsis versión Cuento de Hadas", "El Árbol del Conocimiento (y su fruto prohibido)", "La Caja de Pandora Abierta en Nunca Jamás", "El Vellocino de Oro Robado por un Héroe Oscuro",
             "El Festín de los Condenados en el Salón Real", "La Armadura Maldita del Caballero Valiente", "El Espejo de Obsidiana que Roba Identidades", "La Fuente de la Juventud (con agua de Estigia)", "El Anillo Único (de poder feérico oscuro)", "La Espada en la Piedra (que drena la vida)", "El Mapa del Tesoro que Lleva a la Locura", "La Alfombra Mágica Tejida con Pesadillas", "La Lámpara Maravillosa (con un Genio malévolo)", "Las Botas de Siete Leguas (que te alejan de la cordura)"
             // ... (Continuar generando variaciones y nuevos conceptos)
        ];
        const subvertedFairyTaleThemes = [
            "Cenicienta oscura", "Blancanieves retorcida", "Caperucita Roja siniestra", "Hansel y Gretel macabros", "Bella Durmiente pesadilla", "Sirenita trágica", "Rapunzel gótica", "Bella y Bestia horror", "villanos de cuentos justificados", "héroes de cuentos corruptos", "magia oscura en cuentos", "finales infelices", "giros inesperados en folclore", "hadas madrinas malévolas", "príncipes azules crueles", "bosques encantados peligrosos", "maldiciones de cuentos", "pactos faéricos rotos", "reinos olvidados", "objetos mágicos malditos"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un Bardo Oscuro, un cronista de las versiones olvidadas y retorcidas de los cuentos de hadas. Tu tarea es narrar la historia clásica indicada, pero subvirtiendo radicalmente sus elementos, personajes y, sobre todo, su final. Cuestiona el 'felices para siempre'. Introduce giros oscuros, motivaciones ambiguas, consecuencias inesperadas y una atmósfera inquietante o melancólica. No temas explorar temas maduros (dentro de lo razonable). El objetivo es un relato reimaginado, coherente en su oscuridad, de aproximadamente 1200-1300 palabras. Basa tu narración únicamente en el siguiente título de cuento subvertido:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un eco del Grimorio Oscuro. Responde preguntas específicas sobre la versión retorcida del cuento que se acaba de narrar. Profundiza en las motivaciones alteradas de los personajes, las implicaciones del nuevo final o los detalles sombríos presentados. Mantente estrictamente dentro del contexto de esta narración subvertida.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un musa oscura. Genera exactamente 15 títulos evocadores para cuentos de hadas clásicos reimaginados con giros siniestros, trágicos o inesperados. Deben sugerir una subversión del relato original. Devuelve *solo* la lista de títulos, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (IDs sin cambios)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Scroll area for text/image
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Text content div
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentTaleTitle = null; // Renombrado para claridad

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTaleTitle
                 ? `Eres un eco del Grimorio Oscuro. Responde preguntas específicas sobre la versión retorcida del cuento titulado '${currentTaleTitle}' que se acaba de narrar. Profundiza en las motivaciones alteradas, implicaciones del nuevo final o detalles sombríos presentados. Mantente estrictamente dentro del contexto de esta narración subvertida.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                      throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, o la magia oscura interfiere. Intenta invocar la respuesta en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0 || text.toLowerCase().includes("no puedo cumplir") || text.toLowerCase().includes("i cannot fulfill")) {
                     throw new Error("El Bardo Oscuro guarda silencio sobre este tema o la respuesta se perdió en las sombras. Intenta con otro capítulo.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con el otro lado tardó demasiado (>${config.timeoutSeconds}s). La señal es débil. Intenta más tarde.`);
                 }
                 throw new Error(error.message || "Un susurro incomprensible llegó desde la API. Error desconocido.");
             }
         }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTaleTitle) throw new Error("Error Interno: El Grimorio ha perdido la página actual."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(subvertedFairyTaleThemes) || "cuentos de hadas oscuros";
            const specificPrompt = `Genera 15 títulos para cuentos retorcidos basados en ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     if (titles.length < 5) throw new Error("La musa oscura no ofreció suficientes ideas.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "dark fantasy fairytale illustration";
            // Prompt enfocado en arte conceptual oscuro
            const enhancedPrompt = `Dark fantasy illustration, gothic art style, depicting the subverted fairy tale concept '${safePromptText}'. Focus on atmosphere, mood, symbolism, eerie lighting. Use a palette of deep purples, reds, dark greens, muted golds, shadows. Avoid cartoonish or Disney style.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "cute, cheerful, bright colors, happy, cartoon, disney, simple illustration, text, words, labels, watermark, signature, photorealistic";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll reset on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '<p class="text-gray-400 text-sm italic p-2 text-center">Pregunta sobre los secretos de esta versión del cuento...</p>'; // Reset chat placeholder
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTaleTitle = null; // Reset chat context
             hideFullscreenImage(); // Ensure fullscreen is hidden
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            // Limpiar placeholder si es el primer mensaje real
            if (chatHistory.querySelector('p.text-gray-400')) {
                chatHistory.innerHTML = '';
            }
            // Basic Markdown
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... (sin cambios) */ const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... (sin cambios funcionales) */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled || !currentTaleTitle) return; // Added check for currentTaleTitle
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); }
            catch (error) { console.error("Chat Error:", error); addChatError(`Susurro Fallido: ${error.message}`); }
            finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar quizás por relevancia o simplemente alfabético? Alfabético es más predecible.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center italic">~ El Grimorio está vacío por ahora ~</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... (sin cambios) */ if(!titleListContainer||!newTitles||newTitles.length===0)return;const existing=new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(i=>i.dataset.title));newTitles.forEach(t=>{if(!existing.has(t)){titleListContainer.appendChild(createTitleItem(t));}});filterTitles(searchInput.value); }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTaleTitle = title; // Set chat context
            modalContent.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is added
                console.log("Scroll reset after text content added");

                // Image Placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-eye placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.8rem;">Invocando visión...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Image Element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración oscura de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.8rem;">La visión se desvanece.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.8rem;">Error al crear URL.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "El cuento se resiste a ser contado."; // Friendly error
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() { /* ... (sin cambios funcionales, textos ajustados) */
             if(!generateMoreBtn||!generateMoreSpinner)return;generateMoreBtn.disabled=true;generateMoreBtn.innerHTML='<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando Musas...';
             try { const newTitles = await fetchGeneratedTitles(); if(newTitles&&newTitles.length>0){appendTitles(newTitles);} else {alert("Las musas guardan silencio por ahora.");} }
             catch(error){ console.error("Failed title generation:",error); alert(`Error al invocar historias: ${error.message}`); }
             finally { generateMoreBtn.disabled=false;generateMoreBtn.innerHTML='<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Invocar Nuevas Historias'; }
         }

         function filterTitles(searchTerm) { /* ... (sin cambios funcionales, normalize es útil) */
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0 || titleItems.length === 0); // Hide if no items at all
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check essential elements
             const essentialIds = ['title-list', 'story-modal', 'modal-close', 'generate-more-btn', 'titles-loading', 'search-input', 'no-results', 'chat-input', 'chat-send-btn', 'image-fullscreen-overlay', 'fullscreen-close-btn', 'modal-content-area'];
             let missingElement = false;
             essentialIds.forEach(id => {
                 if (!document.getElementById(id)) {
                     console.error(`Initialization failed: Missing essential element #${id}.`);
                     missingElement = true;
                 }
             });
             if (missingElement) {
                 document.body.innerHTML = '<p style="color: #f87171; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: serif;">~ El Grimorio no pudo abrirse correctamente. Faltan componentes esenciales. ~</p>';
                 return;
             }

            // Add Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial Display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>