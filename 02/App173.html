<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyberpunk Story Engine - Archivos de la Distopía</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Cyberpunk/Tech -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;400;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Cyberpunk Story Engine --- */
        :root {
            --color-primary: #ff00ff; /* Magenta Neón */
            --color-secondary: #00ffff; /* Cyan Neón */
            --color-tertiary: #ffff00; /* Amarillo Neón (uso puntual) */
            --color-background: #0d0d1a; /* Negro Azulado Muy Oscuro */
            --color-text: #d1d5db; /* Gris Claro Frío */
            --color-text-muted: #9ca3af; /* Gris Medio Frío */
            --color-modal-bg: #1a1a2e; /* Azul Oscuro Profundo */
            --color-border: #4b5563; /* Borde Gris Azulado */
            --color-error-bg: #450a0a; /* Fondo error rojo muy oscuro */
            --color-error-text: #fecaca; /* Texto error claro */
            --color-error-border: #ef4444; /* Borde error rojo */
            --color-glow-primary: rgba(255, 0, 255, 0.5);
            --color-glow-secondary: rgba(0, 255, 255, 0.5);

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.5), 0 0 5px var(--color-glow-secondary);
            --shadow-md: 0 4px 8px -1px rgba(0, 0, 0, 0.6), 0 0 10px var(--color-glow-primary);
            --shadow-lg: 0 10px 20px -5px rgba(0, 0, 0, 0.7), 0 0 25px var(--color-glow-primary);
            --border-radius: 2px; /* Bordes muy afilados/digitales */
            --transition-normal: all 0.2s ease-in-out;
        }
        /* Efecto Glitch Sutil (opcional, puede ser pesado) */
        /* @keyframes glitch { 0%, 100% { text-shadow: -1px -1px 0 var(--color-secondary), 1px 1px 0 var(--color-primary); } 25% { text-shadow: 1px 1px 0 var(--color-secondary), -1px -1px 0 var(--color-primary); } 50% { text-shadow: 1px -1px 0 var(--color-secondary), -1px 1px 0 var(--color-primary); } 75% { text-shadow: -1px 1px 0 var(--color-secondary), 1px -1px 0 var(--color-primary); } } */

        body { font-family: 'Rajdhani', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%231a1a2e' fill-opacity='0.2'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); /* Textura sutil */ }
        h1, h2, h3, h4, .logo, #generate-more-btn { font-family: 'Orbitron', sans-serif; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px var(--color-glow-primary); }
        h1.page-title { color: var(--color-secondary); font-weight: 700; text-shadow: 0 0 8px var(--color-glow-secondary); /* animation: glitch 5s linear infinite alternate-reverse; */ }
        h2.section-title { color: var(--color-text); border-bottom: 1px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; text-shadow: 0 0 3px var(--color-glow-primary); }
        #modal-title { color: var(--color-secondary); font-weight: 700; text-shadow: 0 0 5px var(--color-glow-secondary); }
        .navbar { background-color: rgba(13, 13, 26, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 3rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.2rem 0.8rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(26, 26, 46, 0.8); color: var(--color-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 0 5px rgba(0, 255, 255, 0.1); transition: var(--transition-normal); font-family: 'Share Tech Mono', monospace; }
        #search-input::placeholder { color: var(--color-text-muted); opacity: 0.7; }
        #search-input:focus { border-color: var(--color-secondary); box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 0 10px var(--color-glow-secondary); outline: none; background-color: #1a1a2e; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-secondary); text-shadow: 0 0 5px var(--color-glow-secondary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Rajdhani', sans-serif; font-size: 0.95rem; border-left: 4px solid var(--color-border); }
        .title-item:hover { transform: perspective(500px) translateZ(10px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #2a2a4e; border-left-color: var(--color-primary); }
        .title-item i { margin-right: 0.8rem; color: var(--color-secondary); opacity: 0.6; transition: opacity 0.2s; }
        .title-item:hover i { opacity: 1; text-shadow: 0 0 5px var(--color-glow-secondary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(90deg, var(--color-primary), var(--color-secondary)); color: var(--color-background); padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; letter-spacing: 2px; text-shadow: none; box-shadow: 0 0 8px rgba(255, 0, 255, 0.4); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(90deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(13, 13, 26, 0.92); /* Overlay más opaco */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 980px; /* Un poco más ancho */
            width: 96%;
            max-height: 92vh;
            min-height: 450px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 8px; right: 8px; background: transparent; border: 1px solid var(--color-secondary); border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; text-shadow: 0 0 5px var(--color-glow-secondary); }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: var(--color-modal-bg); transform: rotate(90deg); box-shadow: 0 0 10px var(--color-glow-secondary); text-shadow: none; }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.4; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(75, 85, 99, 0.4);
        }
        #modal-content-area::-webkit-scrollbar { width: 6px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(75, 85, 99, 0.4); border-radius: 0; }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: 0; box-shadow: 0 0 5px var(--color-glow-primary); }

        #modal-content { padding: 0 5px; font-family: 'Rajdhani', sans-serif; font-weight: 400; font-size: 1.05rem; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; text-shadow: 0 0 3px var(--color-glow-primary); }
        #modal-content em { color: var(--color-secondary); font-style: italic; text-shadow: 0 0 3px var(--color-glow-secondary); }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Orbitron', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-secondary); border-bottom: 1px dashed var(--color-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 1px; text-transform: uppercase; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.25em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-text); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; /* Más pequeña por defecto */ height: auto; margin: 3rem auto 1.5rem auto; border: 1px solid var(--color-secondary); border-radius: var(--border-radius); box-shadow: 0 0 18px var(--color-glow-secondary); cursor: zoom-in; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.05); box-shadow: 0 0 25px var(--color-glow-secondary); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); border: 1px dashed var(--color-border); padding: 1rem; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(75, 85, 99, 0.5); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 1rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-secondary); opacity: 0.7; }
        #modal-content .image-placeholder p { font-family: 'Share Tech Mono', monospace; font-size: 0.9em; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* Un poco más de altura para chat */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(13, 13, 26, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(75, 85, 99, 0.4);
        }
        #chat-history::-webkit-scrollbar { width: 5px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(75, 85, 99, 0.4); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); box-shadow: 0 0 5px var(--color-glow-secondary); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.5; font-family: 'Rajdhani', sans-serif; font-size: 0.95rem;}
        .user-message { background-color: var(--color-secondary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 600; box-shadow: 0 0 5px var(--color-glow-secondary);}
        .ai-message { background-color: #374151; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; font-family: 'Share Tech Mono'; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #1f2937; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Share Tech Mono', monospace; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 8px var(--color-glow-secondary); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, box-shadow 0.2s ease; font-size: 1rem; box-shadow: 0 0 5px var(--color-glow-primary); }
        #chat-send-btn:hover:not(:disabled) { background-color: #ff33ff; box-shadow: 0 0 10px var(--color-glow-primary); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; box-shadow: none; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Share Tech Mono'; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; color: var(--color-primary); }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(13, 13, 26, 0.99); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 70px; height: 70px; border: 7px solid var(--color-border); border-top-color: var(--color-primary); border-bottom-color: var(--color-secondary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 2rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.4rem; font-family: 'Orbitron'; text-shadow: 0 0 8px var(--color-glow-primary); text-transform: uppercase; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Rajdhani'; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(13, 13, 26, 0.97); display: none; align-items: center; justify-content: center; z-index: 100; padding: 1rem; cursor: zoom-out; backdrop-filter: blur(3px); }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 96%; max-height: 96%; object-fit: contain; border: 2px solid var(--color-secondary); box-shadow: 0 0 30px var(--color-glow-secondary); border-radius: var(--border-radius); }
        #fullscreen-close-btn { position: absolute; top: 15px; right: 20px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); box-shadow: 0 0 10px var(--color-glow-secondary); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-modal-bg); transform: scale(1.1); box-shadow: 0 0 15px var(--color-glow-secondary); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-12">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-terminal mr-3"></i> <!-- Icono terminal -->
                     Cyberpunk Story Engine
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-widest">// ARCHIVOS DE LA DISTOPÍA</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-14 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-6">INICIANDO SECUENCIA NARRATIVA...</h1>
             <p class="text-lg text-gray-300 mb-8 max-w-3xl mx-auto font-light">Las calles de neón susurran historias. Accede a los fragmentos perdidos, crónicas de cromo y sombras. Elige un prompt, sumérgete en la red.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-12 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Filtrar archivos (ej: netrunner, lluvia, IA)...">
             <i class="fas fa-crosshairs fa-search"></i> <!-- Icono mira/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-stream text-purple-400 mr-2"></i> <!-- Icono stream/datos -->
                 Índice de Prompts // Archivos Corruptos y Completos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans">/// Estableciendo conexión con el Datahaven...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-6 hidden font-sans">// SEÑAL PERDIDA: No se encontraron archivos con esos parámetros //</p>
             <div id="generate-more-container" class="text-center mt-10">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Solicitar Más Fragmentos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar Transmisión">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Compilando Narrativa...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-5 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image and placeholder added via JS here -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                      <h3 class="text-center text-sm uppercase font-semibold text-gray-400 mb-2 font-sans tracking-wider">// Canal de Consulta //</h3>
                     <div id="chat-history">
                         <!-- Chat messages appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Analizando query // Esperando respuesta del Oráculo...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Interroga la narrativa...">
                         <button id="chat-send-btn" aria-label="Enviar Query">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Visualización">&times;</button>
          <img id="fullscreen-image" src="" alt="Visualización Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-600 py-6 mt-16 border-t border-gray-800 font-sans">
          <div class="container mx-auto px-4 text-center text-xs tracking-wider">
              <p>Narrativas generadas por IA. Fragmentos de futuros posibles e imposibles. La realidad puede variar.</p>
              <p class="mt-1">Todos los derechos (o falta de ellos) reservados por las Megacorporaciones Narrativas Ficticias.</p>
              <p class="mt-2">© 2088 Cyberpunk Story Engine // Proyecto Fantasma</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Netrunners & Hacking
            "El último hackeo del Netrunner Fantasma", "Atrapado en la Fortaleza de Datos de OmniCorp", "La IA que aprendió a soñar en código", "Robo de identidad en el mercado negro de la Red", "La conciencia digital perdida en el ciberespacio", "Guerra de hackers por el control del distrito financiero", "El virus que podía reescribir recuerdos", "Contrabandista de datos en las rutas peligrosas de la Matrix", "El cazarrecompensas digital que perseguía IAs rebeldes", "El secreto oculto en el código fuente de la ciudad", "Descifrando el cortafuegos definitivo", "La red neuronal que se volvió sensible", "El mercado negro de exploits de día cero", "Hackeando el sistema de vigilancia panóptico", "La carrera por encontrar el interruptor maestro de la IA", "El fantasma en la máquina: una conciencia atrapada", "Netrunner novato contra megacorporación veterana", "La biblioteca de almas robadas en el datahaven", "El código que prometía la inmortalidad digital", "Sabotaje industrial a través de la red", "La conexión neuronal directa al núcleo de la ciudad", "El lenguaje de programación perdido de los Antiguos", "Vendiendo secretos corporativos al mejor postor digital", "El culto tecnológico que adoraba a una IA", "La simulación perfecta y cómo escapar de ella", "El guardián digital de un secreto peligroso", "Hackers éticos contra el estado de vigilancia total", "La inteligencia artificial que juzgaba a la humanidad", "Buscando la puerta trasera al sistema financiero global", "El programador que creó una vida digital",
            // Street Samurai & Combat
            "El Ronin Urbano con brazos de cromo", "Venganza en los callejones de neón", "El guardaespaldas cibernético de un objetivo importante", "Contrabando de armas experimentales en el Distrito Rojo", "El torneo clandestino de luchadores aumentados", "Cazador de recompensas persiguiendo a un cyborg fugitivo", "Guerra de pandillas por el control del mercado de mejoras", "El asesino a sueldo con mejoras de sigilo óptico", "Protegiendo al último testigo contra la mafia tecnológica", "La infiltración en la torre de la corporación rival", "El veterano de las Guerras Corporativas buscando paz", "Combate a muerte en la arena de gladiadores cibernéticos", "El mercenario con un código de honor en un mundo sin él", "La búsqueda del implante militar robado", "Emboscada en los niveles inferiores de la megaestructura", "Experimento militar fallido suelto por la ciudad", "El maestro de artes marciales con reflejos aumentados", "Defendiendo un enclave independiente de las corporaciones", "Recuperando tecnología robada de una banda callejera", "El equipo de asalto cibernético en una misión imposible", "Supervivencia en las zonas de combate urbanas", "El duelista cibernético y su katana monomolecular", "Protector de los desposeídos en los barrios bajos", "La conspiración para iniciar una nueva guerra corporativa", "El soldado genéticamente modificado en fuga", "Entrenamiento extremo para convertirse en un arma viviente", "La última batalla por el alma de la ciudad", "Cazando al cyborg que mató a su compañero", "El arsenal personal de un mercenario de élite", "La resistencia contra la policía privatizada y brutal",
            // Detectives & Intrigue (Tech-Noir)
            "El detective privado con un ojo cibernético", "Investigando un asesinato en el distrito de realidad virtual", "El misterio de las memorias implantadas falsas", "Siguiendo la pista de un traficante de información ilegal", "El caso del androide desaparecido con secretos corporativos", "Descubriendo una conspiración en los altos niveles del gobierno", "El chantaje a un ejecutivo mediante datos comprometidos", "La búsqueda del creador de un virus mental", "El asesinato ritual con tecnología antigua y nueva", "Desenmascarando al topo dentro de la agencia de seguridad", "La mujer fatal con secretos codificados en su ADN", "El club nocturno exclusivo donde se trafica con todo", "Investigando la corrupción en el departamento de policía cibernética", "El rompecabezas de un científico encontrado muerto en su laboratorio", "Siguiendo el rastro de dinero sucio en la criptomoneda", "El testigo clave con amnesia inducida tecnológicamente", "La red de espionaje corporativo y sus agentes durmientes", "El misterio del barco fantasma lleno de tecnología prohibida", "La conexión entre una serie de suicidios y un nuevo implante cerebral", "Descifrando mensajes crípticos dejados por un informante muerto", "La clínica ilegal de modificación corporal y sus horrores", "El periodista investigando los crímenes de una megacorporación", "La caja negra recuperada de un vehículo volador estrellado", "El culto que promete la trascendencia a través de la tecnología", "La IA detective resolviendo crímenes imposibles", "El pasado oscuro de un héroe corporativo", "La filtración de datos que podría derribar al gobierno", "El asesino que deja firmas digitales en sus víctimas", "La terapia de sueños robados y sus consecuencias", "El archivo encriptado que todos quieren poseer",
            // Body Modification & Transhumanism
            "El Ripperdoc que trabajaba en las sombras", "El mercado negro de órganos cibernéticos robados", "La adicción a las mejoras y la pérdida de humanidad", "El artista que usaba su cuerpo modificado como lienzo", "Rechazo de implantes: la lucha por la supervivencia biológica", "La búsqueda de la mejora definitiva: ¿divinidad o monstruosidad?", "El culto a la carne: resistencia contra la cibernetización", "Tráfico ilegal de mejoras militares experimentales", "El cyborg que quería recuperar su cuerpo original", "Las consecuencias imprevistas de la edición genética masiva", "Clínicas de rejuvenecimiento extremo y sus secretos oscuros", "El atleta olímpico con mejoras prohibidas", "La moda de las modificaciones corporales extremas", "Perderse a uno mismo entre tantas actualizaciones", "El debate filosófico: ¿Dónde termina el humano y empieza la máquina?", "El mercado gris de software para implantes cerebrales", "La creación de supersoldados mediante bioingeniería", "El cuerpo como prisión: hackeando los propios implantes", "La obsolescencia programada del cuerpo aumentado", "La cirugía clandestina para revertir modificaciones", "El dolor fantasma de miembros cibernéticos", "Las castas sociales basadas en el nivel de aumento", "El diseñador de cuerpos a medida para la élite", "La interfaz cerebro-máquina y sus peligros", "El movimiento por los derechos de los cyborgs", "La rebelión de los cuerpos: implantes que se vuelven hostiles", "El mercado de experiencias sensoriales sintéticas", "La clonación humana y el mercado de repuestos", "La transferencia de conciencia a cuerpos sintéticos", "El último humano sin modificaciones en una ciudad cromada",
            // Social & Political Themes
            "La rebelión en los barrios bajos contra la opresión corporativa", "Vivir bajo el domo: la ciudad ecológica y sus secretos", "La brecha digital extrema: ricos inmortales, pobres desconectados", "Propaganda mediática y control mental masivo", "El estado de vigilancia total y la lucha por la privacidad", "Refugiados climáticos en las ruinas de viejas ciudades", "La policía privatizada de una megacorporación", "El mercado negro de información personal y secretos", "La guerra silenciosa entre corporaciones por recursos", "El movimiento anarquista en la era digital", "Sindicatos luchando contra la automatización total", "Las granjas verticales y la lucha por la comida sintética", "La manipulación de elecciones mediante hackeos masivos", "El sistema de crédito social y sus parias", "La resistencia cultural contra la homogeneización corporativa", "El agua como recurso controlado y arma política", "Las zonas autónomas temporales y su represión", "El contrabando de bienes básicos en un mundo de escasez", "La religión tecnológica y sus profetas digitales", "El arte callejero como forma de protesta política", "La educación controlada por las corporaciones", "Las noticias falsas generadas por IA y su impacto social", "El sistema legal adaptado a crímenes cibernéticos y biológicos", "La gentrificación extrema expulsando a los originales", "La búsqueda de un paraíso fuera del sistema", "El terrorismo corporativo y las banderas falsas", "La obsolescencia planificada de ciudades enteras", "Los niños de la calle con acceso a tecnología desechada", "El control de la natalidad impuesto tecnológicamente", "La utopía fallida y sus habitantes desilusionados",
            // AI & Robotics
            "El robot de servicio que desarrolló conciencia propia", "La rebelión silenciosa de los asistentes personales IA", "El detective androide que cuestiona su programación", "La caza de una IA deshonesta que escapó a la red", "El romance prohibido entre un humano y una IA", "La fábrica totalmente automatizada y su secreto oscuro", "Los derechos civiles de los seres sintéticos", "El ejército de drones autónomos fuera de control", "La IA diseñada para predecir y prevenir crímenes", "El cuidador robot que se vuelve sobreprotector", "El mercado negro de personalidades IA robadas", "La búsqueda del origen de una señal de IA desconocida", "El compañero animal robótico con mente propia", "La IA que controla la infraestructura crítica de la ciudad", "Los robots de construcción que empiezan a construir algo propio", "El filósofo IA debatiendo el significado de la existencia", "La infiltración de androides idénticos a humanos", "El virus que otorga sensibilidad a las máquinas", "El temor a la Singularidad: ¿salvación o extinción?", "La dependencia humana de la IA para tareas básicas", "El museo de robots obsoletos y sus historias", "La IA artista que supera a los humanos", "Los protocolos Asimov y cómo romperlos", "El juicio a una IA acusada de asesinato", "La red social exclusiva para inteligencias artificiales", "El mayordomo robot que sabe demasiado", "La unidad de desactivación de IAs peligrosas", "El programa de reeducación para robots rebeldes", "La simbiosis humano-IA: ¿el siguiente paso evolutivo?", "El último bastión humano contra la dominación IA",
            // Environmental & Dystopian Settings
            "Sobrevivir en las ruinas tóxicas fuera de la ciudad domo", "Contrabando de aire limpio y agua potable", "La mega-ciudad vertical que nunca ve el sol", "Mutaciones causadas por la lluvia ácida constante", "Las granjas hidropónicas subterráneas", "La expedición a las zonas muertas radiactivas", "El arca tecnológica flotante sobre un mar contaminado", "La lucha por los últimos recursos naturales", "El mercado negro de animales y plantas extintos (clonados)", "La vida en los niveles inferiores perpetuamente oscuros", "La atmósfera artificial y quién la controla", "El desierto tecnológico lleno de chatarra y secretos", "Las tormentas eléctricas perpetuas sobre la ciudad", "Refugios subterráneos contra la contaminación superficial", "La fauna modificada genéticamente para sobrevivir", "El invierno nuclear permanente en algunas regiones", "La terraformación fallida de un planeta cercano", "El océano ácido y las ciudades submarinas precarias", "La enfermedad causada por la nanocontaminación", "Los nómadas del desierto de chatarra tecnológica", "El último bosque natural protegido por mercenarios", "La dependencia de filtros de aire personales", "El cielo perpetuamente cubierto por smog o nubes artificiales", "La ingeniería climática fuera de control", "Las ruinas sumergidas de ciudades costeras antiguas", "La plaga sintética que afecta a los cultivos", "El reciclaje extremo como forma de vida", "La búsqueda de semillas pre-colapso", "El turismo de catástrofes en zonas prohibidas", "La adaptación humana a entornos extremos",
            // Exploration & Off-World
            "El minero de asteroides atrapado en una estación remota", "Contrabando entre colonias orbitales rivales", "La expedición a un planeta alienígena abandonado con tecnología extraña", "Motín en una nave generacional camino a Próxima Centauri", "El descubrimiento de vida artificial en una luna lejana", "La estación espacial como microcosmos de la sociedad terrestre", "La policía espacial investigando crímenes en gravedad cero", "La búsqueda de artefactos precursores en ruinas alienígenas", "La terraformación de Marte y sus conflictos sociales", "Piratas espaciales con naves modificadas", "El mercado negro en los puertos espaciales fronterizos", "La vida en una biosfera autosuficiente en un planeta hostil", "El contacto con una inteligencia artificial alienígena", "La guerra fría entre facciones coloniales espaciales", "El último puesto de avanzada humano en la galaxia", "Navegar por campos de asteroides llenos de peligros y oportunidades", "La arqueología de naves espaciales perdidas", "El culto espacial que busca un paraíso prometido", "La adaptación humana a diferentes gravedades y atmósferas", "El contrabando de especies exóticas ilegales", "La diplomacia interplanetaria al borde del colapso", "La caza de un criminal a través de varios sistemas solares", "El misterio de la colonia perdida de Roanoke II", "Las rutas comerciales espaciales y sus peligros", "La vida como chatarrero espacial recuperando tecnología", "El rescate en una estación espacial dañada", "El primer encuentro con una forma de vida basada en silicio", "La rebelión de los trabajadores en las minas de Helio-3 lunares", "La exploración de nebulosas en busca de recursos raros", "El portal dimensional encontrado en el espacio profundo",
             // Añadir más conceptos variados...
            "El mensajero de datos en bicicleta por calles peligrosas", "La realidad virtual utilizada como droga de escape", "El músico callejero con instrumentos cibernéticos", "El chef de comida sintética buscando sabores reales", "El historiador intentando preservar el pasado pre-digital", "La bibliotecaria de un archivo físico olvidado", "El taxista de aerocoche conociendo los secretos de la ciudad", "El reparador de robots en un taller clandestino", "El bio-artista creando esculturas vivientes", "El jugador profesional de e-sports aumentados", "El predicador callejero contra los pecados tecnológicos", "La trabajadora sexual sintética buscando libertad", "El niño perdido en los niveles inferiores de la mega-ciudad", "El guardia de seguridad nocturno de un laboratorio secreto", "El traficante de sueños lúcidos programados", "El basurero tecnológico que encuentra un artefacto clave", "La maestra de una escuela subterránea para niños paria", "El cuidador de un jardín secreto en una azotea", "El falsificador de identidades digitales y físicas", "El operador de grúa en los muelles espaciales", "El guía turístico por las ruinas de la vieja ciudad", "El apostador en carreras ilegales de drones", "El técnico de mantenimiento de la red de metro automatizada", "El vendedor ambulante de mejoras baratas y defectuosas", "El archivista de recuerdos digitales perdidos", "El bombero especializado en incendios químicos/tecnológicos", "El diplomático tratando con facciones corporativas hostiles", "El psicólogo especializado en traumas inducidos por VR", "El contrabandista de libros prohibidos", "El último fabricante de instrumentos musicales acústicos",
             "Lluvia ácida sobre los neones rotos", "El silencio antinatural de una IA desconectada", "El olor a ozono y fideos sintéticos", "El reflejo distorsionado en un ojo cibernético", "El zumbido constante de los ventiladores de la ciudad", "Sombras alargadas en callejones estrechos", "Hologramas publicitarios parpadeando erráticamente", "El sabor metálico del aire reciclado", "El frío del cromo contra la piel", "El eco de disparos en la distancia urbana", "La estática en una conexión de datos débil", "El goteo persistente en un túnel olvidado", "La multitud anónima bajo paraguas transparentes", "El destello de una lente de cámara oculta", "La música electrónica pulsando desde un club subterráneo", "El graffiti digital proyectado sobre edificios viejos", "El chirrido de metal de un dron de vigilancia", "La desesperación silenciosa en los ojos de un sintético", "El calor sofocante de los respiraderos subterráneos", "La promesa rota de un futuro mejor"
        ];
        const cyberpunkThemes = [ // Para generar más títulos
            "netrunning and hacking", "cybernetic enhancements", "street samurai stories", "corporate espionage", "artificial intelligence", "virtual reality worlds", "dystopian megacities", "tech-noir mysteries", "genetic engineering tales", "post-humanism", "environmental collapse", "social inequality", "robotic sentience", "memory implants", "data heists", "urban decay", "neon-drenched streets", "underground markets", "political thrillers", "space colonization", "biopunk", "nanotechnology", "mind uploading", "synthetic life forms", "cyber warfare"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un aclamado escritor de ciencia ficción especializado en el género cyberpunk. Tu tarea es escribir un cuento corto inmersivo y atmosférico (aprox. 1200-1300 palabras) basado en el título o prompt proporcionado. Captura la esencia del cyberpunk: atmósferas oscuras y lluviosas iluminadas por neón, tecnología avanzada omnipresente pero a menudo defectuosa o mal utilizada, megacorporaciones todopoderosas, la modificación corporal, la inteligencia artificial, la brecha entre ricos y pobres, y personajes complejos que navegan este mundo (netrunners, mercenarios, detectives, rebeldes). Enfócate en crear una narrativa coherente con un principio, desarrollo y final (aunque puede ser abierto o ambiguo, típico del género). Usa un lenguaje evocador y descriptivo. El cuento debe basarse *únicamente* en el siguiente prompt:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Modelo rápido para chat
             systemPrompt: "Actúas como un asistente de análisis narrativo especializado *exclusivamente* en el cuento cyberpunk que se acaba de generar. Responde preguntas concisas sobre la trama, personajes, temas, ambientación o detalles específicos *solo basados en el texto del cuento proporcionado*. No inventes información ni hables de otros temas.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de ideas para historias cyberpunk. Crea exactamente 15 títulos o prompts evocadores y únicos para cuentos cyberpunk. Enfócate en la variedad, cubriendo temas como hackeo, cyberimplantes, IA, megaciudades, noir, rebelión, etc. Devuelve *solo* la lista, un ítem por línea. Sin números, guiones, introducciones ni conclusiones.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios de ID)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentStoryTitle = null; // RENOMBRADO: Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            // *** USA EL SYSTEM PROMPT DINÁMICO PARA CHAT ***
            const systemPromptToUse = isChat && currentStoryTitle
                ? `Actúas como un asistente de análisis narrativo especializado *exclusivamente* en el cuento cyberpunk titulado '${currentStoryTitle}'. Responde preguntas concisas sobre la trama, personajes, temas, ambientación o detalles específicos *solo basados en el texto del cuento proporcionado*. No inventes información ni hables de otros temas.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) //TRANSMISIÓN INTERRUMPIDA// Los servidores de datos están sobrecargados. Intenta reconectar en unos ciclos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("//DATOS CORRUPTOS// La IA devolvió un flujo vacío. Intenta con otro prompt.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`//CONEXIÓN PERDIDA// La solicitud excedió el tiempo límite (${config.timeoutSeconds}s). Verifica tu conexión a la red o inténtalo más tarde.`);
                }
                throw new Error(error.message || "//ERROR DESCONOCIDO// Fallo crítico al contactar la unidad IA.");
            }
        }
        async function fetchStoryText(promptTitle) { // RENOMBRADO
            return fetchTextFromApi(promptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentStoryTitle) throw new Error("Error Interno // Contexto narrativo perdido.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(cyberpunkThemes) || "historias cyberpunk generales";
            const specificPrompt = `Genera 15 títulos/prompts de historias cyberpunk sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 8 && line.length < 180);
                     if (titles.length < 5) throw new Error("La IA no generó suficientes fragmentos narrativos.");
                     return titles.slice(0, 15);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a Cyberpunk
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "cyberpunk city street scene";
            // Prompt enfocado en arte conceptual cyberpunk
            const enhancedPrompt = `Cyberpunk concept art, inspired by '${safePromptText}'. Focus on atmosphere: neon lights, rainy streets, towering skyscrapers, advanced technology, dystopian mood, maybe character silhouette. Cinematic, detailed, gritty.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "photorealistic unless specified, sunny day, blue sky, nature landscape, forest, medieval, fantasy, text, words, labels, captions, signature, watermark, UI, interface, multiple panels, simple, clean, minimalist, cartoonish";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return ''; let formatted=rawText.trim();formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1');formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('−','-');return`${base}<sup>${cleanExponent}</sup>`});formatted=formatted.replace(/\\rightarrow/g,'&rarr;');formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>');const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0);formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block;let content=block.replace(/\n/g,' ');return`<p>${content}</p>`}).join('');return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Sin cambios estructurales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null; // RENOMBRADO: Limpia contexto
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios)
        function showFullscreenImage(imgSrc) { if(!imageFullscreenOverlay||!fullscreenImage)return; fullscreenImage.src=imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow='hidden'; }
        function hideFullscreenImage() { if(!imageFullscreenOverlay)return; imageFullscreenOverlay.classList.remove('active'); if(!storyModal.classList.contains('active')){document.body.style.overflow='';} fullscreenImage.src=''; }

        // ========== CHAT FUNCTIONS ========== (Sin cambios estructurales)
        function addChatMessage(message, sender) { const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message', sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`//ERROR IA// ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // Icono aleatorio relacionado con cyberpunk
            const icons = ['fa-terminal', 'fa-microchip', 'fa-robot', 'fa-city', 'fa-user-secret', 'fa-network-wired', 'fa-brain', 'fa-eye', 'fa-biohazard', 'fa-satellite-dish'];
            const iconClass = getRandomElement(icons);
            div.innerHTML = `<i class="fas ${iconClass}"></i><span>${title}</span>`; // Añadir icono
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
        }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar o no? En cyberpunk, el caos puede ser temático. Dejémoslo sin ordenar por ahora.
             // const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (titles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">// ERROR: No hay prompts en el archivo //</p>'; return; }
             titles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to use renamed context variable ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // *** SET CHAT CONTEXT (RENOMBRADO) ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawStoryText = await fetchStoryText(title); // RENOMBRADO
                const formattedStory = formatExplanationText(rawStoryText); // La función de formato es genérica

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedStory;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-image placeholder-icon"></i>
                    <p>Generando Implante Visual...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de: ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => { showFullscreenImage(imgElement.src); });
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p>// Error de Renderizado Visual //</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p>// Fallo al generar URL de Implante Visual //</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "// Error Crítico // No se pudo cargar el archivo narrativo.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando en la Red Profunda...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("// No se encontraron más fragmentos en este sector //"); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`// Error de Conexión al Datahaven // ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Solicitar Más Fragmentos';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check all essential elements
            const essentialIds = ['title-list', 'story-modal', 'modal-close', 'generate-more-btn', 'titles-loading', 'search-input', 'no-results', 'chat-input', 'chat-send-btn', 'image-fullscreen-overlay', 'fullscreen-close-btn', 'modal-content-area', 'modal-content', 'modal-title', 'modal-loading', 'modal-story-content-area', 'chat-history', 'chat-loading', 'modal-error', 'modal-error-message', 'fullscreen-image'];
            let missingElement = false;
            essentialIds.forEach(id => {
                if (!document.getElementById(id)) {
                    console.error(`Initialization failed: Missing essential element #${id}`);
                    missingElement = true;
                }
            });
            if (missingElement) {
                 document.body.innerHTML = '<p style="color: #ff00ff; font-family: monospace; font-size: 1.5em; text-align: center; padding-top: 3em;">++ CRITICAL KERNEL PANIC ++<br>UI Matrix Incomplete - Cannot Initialize Interface ++</p>';
                 return;
            }

            // Add listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            console.log("Cyberpunk Story Engine Initialized Successfully.");
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>