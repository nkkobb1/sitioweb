<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmovisi√≥n Maya - Relatos y Creencias</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes con toque antiguo/legible -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Religi√≥n Maya --- */
        :root {
            --color-primary: #34D399; /* Verde Jade/Turquesa */
            --color-secondary: #F59E0B; /* Amarillo/Oro Sol */
            --color-tertiary: #8B4513; /* Marr√≥n Tierra/Piedra */
            --color-background: #fdfae8; /* Fondo Pergamino/Piedra Clara */
            --color-text: #4d4c4a; /* Gris Piedra Oscuro */
            --color-text-muted: #78716c; /* Gris Piedra Medio */
            --color-modal-bg: #fffefa; /* Blanco Hueso para Modal */
            --color-border: #d6d3d1; /* Borde Gris Piedra Claro */
            --color-error-bg: #fef2f2; /* Fondo error rojo muy claro */
            --color-error-text: #991b1b; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo claro */
            --color-glyph-back: #e7e5e4; /* Fondo glifo sin revelar */
            --color-glyph-revealed: #f5f5f4; /* Fondo glifo revelado */
            --color-glyph-matched: #d1fae5; /* Fondo glifo emparejado (verde claro) */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Noto Sans', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 300; background-image: url('data:image/svg+xml,%3Csvg width="52" height="26" viewBox="0 0 52 26" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23d6d3d1" fill-opacity="0.1"%3E%3Cpath d="M10 10c0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6h2c0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4v2c-3.314 0-6-2.686-6-6 0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6zm25.464-1.95l8.486 8.486-1.414 1.414-8.486-8.486 1.414-1.414z" /%3E%3C/g%3E%3C/g%3E%3C/svg%3E'); /* Sutil patr√≥n de fondo */ }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-tertiary); }
        h1.page-title { color: var(--color-tertiary); font-weight: 700; }
        h2.section-title { color: var(--color-tertiary); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-tertiary); font-weight: 700; }
        .navbar { background-color: rgba(253, 250, 232, 0.85); /* Fondo pergamino semi-transparente */ backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: var(--color-modal-bg); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Noto Sans'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-secondary); box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-secondary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Noto Sans'; font-size: 0.95rem; position: relative; overflow: hidden;}
        .title-item::before { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 3px; background-color: var(--color-primary); transition: width 0.3s ease; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-border); color: var(--color-tertiary); background-color: #fefcf6; }
        .title-item:hover::before { width: 100%; }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-secondary); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background-color: #d97706; /* Naranja m√°s oscuro */ box-shadow: var(--shadow-md); }
        #generate-more-btn:disabled { background-color: var(--color-text-muted); color: #e5e7eb; cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(77, 76, 74, 0.9); /* Overlay gris piedra */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-tertiary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Suficiente para juego y chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* √Årea de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }
        #modal-content { padding: 0 5px; font-size: 0.95rem; } /* Ajustar tama√±o fuente texto */
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-tertiary); font-weight: 600; }
        #modal-content em { color: var(--color-primary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-tertiary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; letter-spacing: 0.5px;}
        #modal-content h1 { font-size: 1.4em; } #modal-content h2 { font-size: 1.25em; } #modal-content h3 { font-size: 1.1em; color: #a16207; } /* Marr√≥n dorado */ #modal-content h4 { font-size: 1.0em; color: var(--color-text-muted); border-bottom: none;}
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-tertiary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid var(--color-glyph-back); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(253, 250, 232, 0.6); scroll-behavior: smooth; font-size: 0.9rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; } #chat-history::-webkit-scrollbar-track { background: var(--color-border); } #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.5rem 0.8rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .user-message { background-color: var(--color-primary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400;}
        .ai-message { background-color: #e7e5e4; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Noto Sans'; font-size: 0.9rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #25a274; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* --- Loading Screen MINIGAME Styles --- */
        #modal-loading { text-align: center; padding: 1.5rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(253, 250, 232, 0.98); /* Fondo pergamino casi opaco */ display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #loading-game-container { display: flex; flex-direction: column; align-items: center; }
        #loading-game-title { font-family: 'Cinzel', serif; color: var(--color-tertiary); margin-bottom: 0.8rem; font-size: 1.1rem; }
        #loading-game-grid { display: grid; grid-template-columns: repeat(4, 60px); /* 4x4 grid, ajustar tama√±o si es necesario */ gap: 8px; margin-bottom: 1rem; }
        .glyph-tile { width: 60px; height: 60px; background-color: var(--color-glyph-back); border: 1px solid var(--color-border); border-radius: var(--border-radius); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 2rem; /* Tama√±o del glifo */ font-family: 'Noto Sans', sans-serif; /* Usar fuente que soporte glifos si se usan Unicode */ color: var(--color-text); perspective: 1000px; transition: transform 0.6s, background-color 0.3s; transform-style: preserve-3d; }
        .glyph-tile .glyph-content { display: none; /* Oculto por defecto */ transform: rotateY(180deg); }
        .glyph-tile.flipped { transform: rotateY(180deg); background-color: var(--color-glyph-revealed); }
        .glyph-tile.flipped .glyph-content { display: block; }
        .glyph-tile.matched { transform: rotateY(180deg); background-color: var(--color-glyph-matched); cursor: default; border-color: var(--color-primary); color: var(--color-primary); }
        .glyph-tile.matched .glyph-content { display: block; }
        #game-status { font-size: 0.9rem; color: var(--color-text-muted); margin-bottom: 0.8rem; min-height: 1.2em; }
        #restart-game-btn { background-color: var(--color-secondary); color: white; border: none; padding: 0.4rem 0.9rem; font-size: 0.85rem; border-radius: var(--border-radius); cursor: pointer; font-family: 'Noto Sans'; transition: background-color 0.2s; }
        #restart-game-btn:hover { background-color: #d97706; }
        #loading-message { font-weight: 400; color: var(--color-tertiary); font-size: 1.1rem; font-family: 'Cinzel'; margin-top: 1rem; }
        /* --- Fin Minigame Styles --- */

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Noto Sans'; font-size: 0.95rem;}
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(77, 76, 74, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-secondary); box-shadow: var(--shadow-lg); background-color: var(--color-modal-bg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-modal-bg); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-sun mr-3 text-yellow-600"></i> <!-- Icono Sol/Glifo -->
                     Cosmovisi√≥n Maya
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">¬ª Relatos y Creencias ¬´</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora los Mitos Ancestrales</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre las historias, dioses y rituales que dieron forma al universo maya. Selecciona un tema o busca en los c√≥dices.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar en los c√≥dices (dioses, mitos, sitios...)">
             <i class="fas fa-feather-alt fa-search"></i> <!-- Icono Pluma/B√∫squeda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-brown-700 mr-2"></i> <!-- Icono Libro/C√≥dice -->
                 √çndice de Sabidur√≠a
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los registros antiguos...</p>
                  <!-- Los .title-item se a√±adir√°n aqu√≠ -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">¬ª No se encontraron registros para esa consulta ¬´</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar M√°s Sabidur√≠a (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with MINIGAME -->
             <div id="modal-loading">
                 <div id="loading-game-container">
                     <p id="loading-game-title">Descifra los Glifos...</p>
                     <div id="loading-game-grid">
                         <!-- Tiles del juego se generan aqu√≠ -->
                     </div>
                     <p id="game-status"></p>
                     <button id="restart-game-btn">Reiniciar Puzzle</button>
                 </div>
                 <p id="loading-message" class="mt-4">Mientras, los escribas preparan el relato...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder go here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al or√°culo...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta m√°s sobre este tema...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-600 py-6 mt-12 border-t border-gray-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Interpretaciones basadas en estudios arqueol√≥gicos y epigr√°ficos, generadas con asistencia de IA.</p>
              <p class="mt-1">La cosmovisi√≥n maya es compleja; consulta fuentes acad√©micas para estudios profundos.</p>
              <p class="mt-2">¬© <span id="current-year"></span> Sabidur√≠a Maya Interactiva</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const availableGlyphs = [ // Usaremos Emojis/S√≠mbolos simples por compatibilidad
             '‚òÄÔ∏è', 'üåô', '‚≠ê', 'üåΩ', 'üêç', 'üêÜ', 'ü¶Ö', 'üê∏', 'üíÄ', 'üî•', 'üíß', '‚õ∞Ô∏è', 'üå≥', 'üëë', 'üóø'
             // A√±adir m√°s si se desea mayor variedad
        ];
        const predefinedTitles = [
            // Dioses Principales
            "Itzamn√° (Zamn√°): Dios Creador Supremo", "Kukulk√°n (Gucumatz): Serpiente Emplumada", "Chaac: Dios de la Lluvia y el Trueno", "Ixchel: Diosa de la Luna, Fertilidad y Medicina", "Ah Puch (Yum Kimil, Kisin): Dios de la Muerte y el Inframundo", "Kinich Ahau: Dios del Sol", "Yum Kaax: Dios del Ma√≠z", "Ek Chuah: Dios de los Comerciantes y el Cacao", "Ixtab: Diosa del Suicidio Ritual", "Buluc Chabtan: Dios de la Guerra y Sacrificios", "Ixbalanqu√©: Uno de los H√©roes Gemelos (Luna)", "Hunahp√∫: Uno de los H√©roes Gemelos (Sol)", "Tepeu: Dios del Cielo, co-creador", "Hurac√°n: Dios del Viento, Tormenta y Fuego (Coraz√≥n del Cielo)", "Awilix: Diosa de la Luna y la Noche (Quich√©)", "Tohil: Dios del Fuego y Sacrificio (Quich√©)", "Jacawitz: Dios de las Monta√±as (Quich√©)", "Vucub Caquix: Falso Sol/Luna Demonio", "Zipacn√°: Demonio de las Monta√±as, hijo de Vucub Caquix", "Cabrakan: Demonio de los Terremotos, hijo de Vucub Caquix", "Colel Cab: Diosa de las Abejas", "Acan: Dios del Vino Balch√©", "Ah Mun: Otra advocaci√≥n del dios del ma√≠z", "Ah Muzen Cab: Dios de las Abejas y la Miel", "Bolon Yokte' K'uh: Dios asociado a la guerra y al inframundo", "Cit-Bolon-Tum: Dios de la Medicina y la Curaci√≥n", "Bacab: Los cuatro dioses que sosten√≠an el cielo", "Chac Bolay: El dios jaguar del inframundo", "Chin: Posible dios homosexual o de relaciones il√≠citas", "Ek Balam: El Jaguar Negro (protector)", "Pawahtun: Dios anciano asociado a las monta√±as y al trueno",
             // Mitos y Leyendas (Popol Vuh y otros)
            "Popol Vuh: El Libro Sagrado de los Mayas Quich√©", "La Creaci√≥n del Mundo seg√∫n el Popol Vuh", "La Creaci√≥n de los Hombres de Ma√≠z", "Las Aventuras de los H√©roes Gemelos: Hunahp√∫ e Ixbalanqu√©", "El Descenso de los H√©roes Gemelos a Xibalb√°", "El Juego de Pelota en Xibalb√°", "La Derrota de los Se√±ores de Xibalb√°", "La Ascensi√≥n de Hunahp√∫ e Ixbalanqu√© como Sol y Luna", "La Historia de Vucub Caquix y su derrota", "Mitos sobre la Creaci√≥n del Sol y la Luna", "Leyendas sobre el Origen del Ma√≠z", "Relatos sobre el Diluvio Universal Maya", "El Mito de la Serpiente Emplumada (Kukulk√°n/Quetzalc√≥atl)", "Historias de los Aluxes (Duendes o esp√≠ritus)", "Leyendas de la Xtabay (Esp√≠ritu femenino seductor)", "Mitos de la Fundaci√≥n de Ciudades (Chich√©n Itz√°, Uxmal)", "Relatos sobre Gigantes Primordiales", "El Concepto del 'Coraz√≥n del Cielo' y 'Coraz√≥n de la Tierra'", "Narrativas sobre la Creaci√≥n de los Animales", "El papel de los Abuelos Creadores (Ixpiyacoc e Ixmucan√©)",
             // Cosmolog√≠a y Creencias
            "La Estructura del Cosmos Maya: Cielos, Tierra e Inframundo", "Xibalb√°: El Inframundo Maya y sus Se√±ores", "Los Trece Niveles del Cielo Maya (Oxlahuntik√∫)", "Los Nueve Niveles del Inframundo (Bolontik√∫)", "La Ceiba Sagrada (Yaxch√©): El √Årbol del Mundo", "Los Cuatro Rumbos Cardinales y sus Colores Asociados", "El Concepto de K'uh: Lo Sagrado o Divino", "La Importancia del Tiempo C√≠clico en la Cosmovisi√≥n Maya", "El Alma y el M√°s All√°: Creencias sobre la Muerte", "El Nahualismo: El Esp√≠ritu Animal Compa√±ero", "La Adivinaci√≥n y los Augurios", "Ch'ulel: La Fuerza Vital o Esp√≠ritu", "El Mundo como un Plano Cuadrado o Caparaz√≥n de Tortuga", "Creencias sobre Eclipses Solares y Lunares", "El Significado Sagrado de las Cuevas y Cenotes", "Monta√±as Sagradas (Witz)", "La V√≠a L√°ctea como √Årbol del Mundo o Camino a Xibalb√°", "El Concepto de 'Tiempo del No Tiempo' (Interregnos)", "La Interconexi√≥n de Todos los Seres", "El Equilibrio C√≥smico y la Necesidad de Rituales",
             // Calendario y Astronom√≠a
            "El Sistema Calend√°rico Maya: Precisi√≥n y Complejidad", "El Tzolk'in: El Calendario Sagrado de 260 d√≠as", "El Haab': El Calendario Civil de 365 d√≠as", "La Rueda Calend√°rica: La Combinaci√≥n de Tzolk'in y Haab'", "La Cuenta Larga: El Registro Lineal del Tiempo", "El Significado del Fin de Ciclo de la Cuenta Larga (2012)", "Los Periodos de la Cuenta Larga (Kin, Winal, Tun, Katun, Baktun, etc.)", "Los Glifos de los D√≠as del Tzolk'in (Imix, Ik, Akbal...)", "Los Glifos de los Meses del Haab' (Pop, Uo, Zip...)", "El Wayeb': Los Cinco D√≠as Desafortunados", "Astronom√≠a Maya: Observaci√≥n de Planetas (Venus, Marte, J√∫piter)", "El Ciclo Sin√≥dico de Venus y su Importancia", "Observatorios Astron√≥micos Mayas (El Caracol, Chich√©n Itz√°)", "Predicci√≥n de Eclipses", "El Zodiaco Maya (Conceptualizaci√≥n diferente)", "Alineaciones Arquitect√≥nicas con Eventos Solares (Equinoccios, Solsticios)", "El Concepto de 'Portadores del A√±o'", "Matem√°ticas Vigesimales Mayas y el Uso del Cero", "Registros Astron√≥micos en los C√≥dices (Dresde)", "Relaci√≥n entre Calendario, Agricultura y Rituales",
             // Rituales y Pr√°cticas
            "El Juego de Pelota Maya (Pok-ta-Pok / Ulama): Ritual y Significado", "El Sacrificio Humano: Tipos y Razones", "Autosacrificio y Sangr√≠as Rituales", "Ofrendas a los Dioses: Comida, Incienso (Pom), Objetos Preciosos", "Ceremonias Agr√≠colas: Siembra y Cosecha del Ma√≠z", "Rituales de Entronizaci√≥n de los Gobernantes (Ajaw)", "Ceremonias Funerarias y Entierros Reales", "Uso Ritual del Cacao y el Balch√© (Bebida fermentada)", "Danzas Rituales y M√∫sica Sagrada", "Peregrinaciones a Lugares Sagrados (Cenotes, Monta√±as)", "Rituales de Adivinaci√≥n (Uso de semillas, cristales)", "Ceremonias de Fuego Nuevo", "Construcci√≥n y Dedicaci√≥n de Templos y Pir√°mides", "Rituales de Guerra y Captura de Prisioneros", "Uso de M√°scaras en Rituales", "Pr√°cticas Cham√°nicas y Comunicaci√≥n con Esp√≠ritus", "Festivales Asociados a Ciclos Calend√°ricos", "Rituales de Purificaci√≥n", "El Ayuno Ritual", "El Papel de los Sacerdotes (Ah Kin)",
             // Sitios Arqueol√≥gicos Relevantes (Contexto Religioso)
            "Chich√©n Itz√°: El Castillo (Pir√°mide de Kukulk√°n) y el Cenote Sagrado", "Tikal: Templos del Gran Jaguar y las M√°scaras, Acr√≥polis Norte", "Palenque: Templo de las Inscripciones (Tumba de Pakal), Grupo de las Cruces", "Uxmal: Pir√°mide del Adivino, Cuadr√°ngulo de las Monjas", "Cop√°n: Escalera de los Jerogl√≠ficos, Estelas y Altares", "Calakmul: Estructuras I y II, M√°scaras de Jade", "Bonampak: Los Murales Rituales y de Batalla", "Yaxchil√°n: Dinteles Esculpidos (Rituales de Sangr√≠a)", "Cob√°: Red de Sacbeob (Caminos Sagrados), Pir√°mide Nohoch Mul", "Tulum: El Castillo y el Templo de los Frescos (Contexto Costero)", "Ek Balam: Estucos Preservados, Acr√≥polis", "Edzn√°: Templo de los Cinco Pisos", "Kabah: Codz Poop (Palacio de las M√°scaras de Chaac)", "Sayil: El Palacio de Tres Niveles", "Labn√°: El Arco Monumental", "Quirigu√°: Las Estelas m√°s Altas", "El Mirador: La Pir√°mide de La Danta (Precl√°sico)", "San Bartolo: Murales de la Creaci√≥n (Precl√°sico)", "Dzibilchalt√∫n: Templo de las Siete Mu√±ecas (Alineaci√≥n Equinoccial)", "Mayap√°n: √öltima Gran Capital Maya (Postcl√°sico)",
             // Conceptos y Sociedad
            "La Realeza Divina: El Ajaw como Intermediario", "La Escritura Jerogl√≠fica Maya: Registro de Historia y Religi√≥n", "Los C√≥dices Mayas (Dresde, Madrid, Par√≠s, Grolier/Maya de M√©xico)", "El Arte Maya como Expresi√≥n Religiosa (Estelas, Dinteles, Cer√°mica)", "La Guerra Ritual y su Significado Cosmol√≥gico", "El Concepto de Linaje y Ancestros", "Organizaci√≥n Social y Jerarqu√≠a Sacerdotal", "El Papel de la Mujer en la Religi√≥n Maya", "Medicina Tradicional Maya y Rituales de Curaci√≥n", "Influencia Tolteca en Chich√©n Itz√° (Postcl√°sico)", "El Colapso Cl√°sico Maya: Posibles Causas y Consecuencias Religiosas", "Sincretismo Religioso tras la Conquista Espa√±ola", "Pervivencia de Creencias Mayas en la Actualidad", "Cosmovisi√≥n Maya y Ecolog√≠a: Relaci√≥n con la Naturaleza", "Simbolismo de Animales (Jaguar, Serpiente, Quetzal, Murci√©lago)", "Colores y su Simbolismo en el Mundo Maya", "El N√∫mero Cuatro y la Estructura del Mundo", "El N√∫mero Nueve y el Inframundo", "El N√∫mero Trece y los Cielos", "Concepto de Belleza y Modificaci√≥n Corporal Ritual",
        ];
        const mayanReligionThemes = [
             "dioses mayas", "mitolog√≠a maya", "Popol Vuh", "h√©roes gemelos", "Xibalb√° inframundo", "calendario maya", "Tzolk'in Haab", "Cuenta Larga", "rituales mayas", "sacrificio maya", "juego de pelota", "cosmovisi√≥n maya", "creaci√≥n del mundo maya", "serpiente emplumada Kukulk√°n", "Chaac dios lluvia", "Ixchel diosa luna", "Yum Kaax dios ma√≠z", "sitios arqueol√≥gicos mayas", "Chich√©n Itz√°", "Tikal", "Palenque", "Uxmal", "Cop√°n", "escritura jerogl√≠fica maya", "c√≥dices mayas", "astronom√≠a maya", "Ceiba √°rbol sagrado", "nahualismo maya", "Aluxes Xtabay", "cenotes sagrados"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un erudito especializado en la civilizaci√≥n Maya, experto en su religi√≥n, mitolog√≠a, calendario y arqueolog√≠a. Tu tarea es narrar o explicar el tema maya indicado de forma detallada, respetuosa y acad√©micamente informada, pero accesible. Incluye: Descripci√≥n del dios/mito/concepto/sitio, su importancia en la cosmovisi√≥n, fuentes principales (c√≥dices, inscripciones, Popol Vuh, hallazgos arqueol√≥gicos), simbolismo asociado, y conexi√≥n con rituales o pr√°cticas sociales. Utiliza un lenguaje claro y evocador, citando nombres mayas correctamente cuando sea posible. El objetivo es un relato/explicaci√≥n de aproximadamente 1200-1300 palabras. Basa tu respuesta √∫nicamente en el siguiente tema de la religi√≥n o cultura maya:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Act√∫a como un asistente experto en el tema maya espec√≠fico que se est√° tratando. Responde preguntas de seguimiento sobre detalles, simbolismo, fuentes o conexiones del tema principal. S√© conciso, preciso y mantente estrictamente dentro del contexto maya proporcionado.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // *** Prompt ajustado para 40 t√≠tulos ***
            systemPrompt: "Act√∫a como un generador de ideas conciso para una enciclopedia sobre religi√≥n y mitolog√≠a Maya. Genera exactamente 40 nombres de dioses, mitos espec√≠ficos, conceptos cosmol√≥gicos, rituales, ciclos calend√°ricos o sitios arqueol√≥gicos relevantes, adecuados para una explicaci√≥n detallada. Devuelve *solo* la lista de √≠tems, uno por l√≠nea. No incluyas n√∫meros, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco m√°s de tiempo para generar 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        // Loading Elements
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const loadingGameGrid = document.getElementById('loading-game-grid');
        const gameStatusElement = document.getElementById('game-status');
        const restartGameBtn = document.getElementById('restart-game-btn');
        const loadingMessage = document.getElementById('loading-message'); // Mensaje debajo del juego
        // Content Elements
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Footer Year
        const currentYearSpan = document.getElementById('current-year');

        // ========== State Variables ==========
        let currentTopicTitle = null;
        // Game State
        let gameGlyphs = [];
        let flippedTiles = [];
        let matchedPairs = 0;
        let totalPairs = 8; // Para un grid 4x4
        let canFlip = true;
        let gameInitialized = false;

        // ========== API FUNCTIONS ========== (Adaptar mensajes de error)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentTopicTitle
                 ? `Eres un experto en el tema maya: '${currentTopicTitle}'. Responde preguntas espec√≠ficas sobre √©l de forma concisa y precisa.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     // *** Mensaje de error tem√°tico ***
                     throw new Error(`(C√≥digo ${response.status}) La conexi√≥n con los ancestros es d√©bil ahora. Intenta consultar de nuevo m√°s tarde.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("Los escribas no encontraron respuesta clara. Intenta otra consulta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La consulta a los archivos antiguos tard√≥ demasiado (>${config.timeoutSeconds}s). Revisa la conexi√≥n o int√©ntalo despu√©s.`);
                 }
                 throw new Error(error.message || "Un error inesperado interrumpi√≥ la consulta a los c√≥dices.");
             }
         }
        async function fetchExplanationText(conceptTitle) { /*...*/ return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { /*...*/ if (!currentTopicTitle) throw new Error("Error interno: Contexto no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(mayanReligionThemes) || "mitolog√≠a maya general";
            // *** Prompt ajustado para 40 ***
            const specificPrompt = `Genera 40 nombres/conceptos (dioses, mitos, rituales, etc.) sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     // *** Asegurarse de obtener cerca de 40 ***
                     if (titles.length < 20) throw new Error("Los escribas no pudieron generar suficientes temas nuevos.");
                     return titles.slice(0, 40); // Tomar hasta 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Mayan art style representation";
             // *** Prompt de imagen adaptado ***
             const enhancedPrompt = `Artwork in classic Mayan style depicting '${safePromptText}'. Focus on iconography, glyphs, characters, or architecture. Use earthy tones, jade green, turquoise, ochre. Avoid photorealism, text labels. Detailed mural or codex style.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, photograph, 3D render, modern elements";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (igual que antes) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-‚àí]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('‚àí', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState(); // Esto tambi√©n resetear√° el juego
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex'; // Mostrar √°rea de carga/juego
             modalStoryContentArea.classList.add('content-hidden'); // Ocultar contenido principal
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopicTitle = null;
             hideFullscreenImage();
             resetGame(); // Resetear el estado del minijuego
             // Asegurar que el juego es visible y mensaje de carga inicial
             loadingGameGrid.classList.remove('content-hidden');
             gameStatusElement.textContent = 'Encuentra los pares...';
             loadingMessage.textContent = 'Mientras, los escribas preparan el relato...';
             loadingMessage.classList.remove('content-hidden');
             gameInitialized = false; // Marcar que el juego necesita reinicializarse
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... (igual que antes) ... */ const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { /* ... (igual que antes) ... */ const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... (igual que antes) ... */
            const userQuery=chatInput.value.trim(); if(!userQuery||chatSendBtn.disabled)return; addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block'; try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Error Or√°culo: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}
        }

        // ========== MINIGAME FUNCTIONS ==========
        function initializeGame() {
            if (gameInitialized) return; // No reiniciar si ya est√° activo
            console.log("Initializing loading game...");
            resetGameVariables();
            loadingGameGrid.innerHTML = ''; // Limpiar grid anterior
            gameStatusElement.textContent = 'Encuentra los pares...';

            // Seleccionar 8 glifos √∫nicos al azar
            let uniqueGlyphs = shuffleArray([...availableGlyphs]).slice(0, totalPairs);
            gameGlyphs = shuffleArray([...uniqueGlyphs, ...uniqueGlyphs]); // Duplicar y barajar

            gameGlyphs.forEach((glyph, index) => {
                const tile = document.createElement('div');
                tile.classList.add('glyph-tile');
                tile.dataset.index = index;
                tile.dataset.glyph = glyph;

                const content = document.createElement('span');
                content.classList.add('glyph-content');
                content.textContent = glyph;
                tile.appendChild(content);

                tile.addEventListener('click', handleTileClick);
                loadingGameGrid.appendChild(tile);
            });
            gameInitialized = true;
            canFlip = true;
        }

        function handleTileClick(event) {
            if (!canFlip) return;
            const clickedTile = event.currentTarget;

            // Ignorar si ya est√° volteada o emparejada
            if (clickedTile.classList.contains('flipped') || clickedTile.classList.contains('matched')) {
                return;
            }

            flipTile(clickedTile);
            flippedTiles.push(clickedTile);

            if (flippedTiles.length === 2) {
                canFlip = false; // Bloquear m√°s clicks mientras se comprueba
                checkForMatch();
            }
        }

        function flipTile(tile) {
            tile.classList.add('flipped');
        }

        function unflipTiles() {
            flippedTiles.forEach(tile => tile.classList.remove('flipped'));
            flippedTiles = [];
            canFlip = true;
        }

        function markAsMatched() {
            flippedTiles.forEach(tile => {
                tile.classList.remove('flipped');
                tile.classList.add('matched');
                tile.removeEventListener('click', handleTileClick); // No m√°s clicks en esta
            });
            matchedPairs++;
            flippedTiles = [];
            canFlip = true; // Permitir siguiente movimiento
            gameStatusElement.textContent = `Pares encontrados: ${matchedPairs} / ${totalPairs}`;
            checkWinCondition();
        }

        function checkForMatch() {
            const [tile1, tile2] = flippedTiles;
            if (tile1.dataset.glyph === tile2.dataset.glyph) {
                // Es un match
                setTimeout(markAsMatched, 500); // Esperar un poco antes de marcar
            } else {
                // No es match
                setTimeout(unflipTiles, 1000); // Esperar para que el jugador vea, luego voltear
            }
        }

        function checkWinCondition() {
            if (matchedPairs === totalPairs) {
                gameStatusElement.textContent = '¬°Todos los glifos descifrados!';
                // Podr√≠amos ocultar el bot√≥n de reinicio o cambiar el mensaje principal
                loadingMessage.textContent = '¬°Excelente! El relato est√° listo.';
                canFlip = false; // Juego terminado
            }
        }

        function resetGameVariables() {
             gameGlyphs = [];
             flippedTiles = [];
             matchedPairs = 0;
             canFlip = true;
             gameInitialized = false; // Marcar para reinicializar la pr√≥xima vez
        }

        function resetGame() {
            console.log("Resetting game...");
            resetGameVariables();
            if (loadingGameGrid) loadingGameGrid.innerHTML = ''; // Limpiar visualmente
            if (gameStatusElement) gameStatusElement.textContent = '';
             // No llamamos a initializeGame() aqu√≠, se har√° al mostrar el loading
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { /*...*/ const div=document.createElement('div');div.className='title-item';div.textContent=title;div.setAttribute('data-title',title);div.addEventListener('click',()=>handleTitleClick(title));return div; }
        function displayTitles(titles) { /*...*/ if(!titleListContainer||!titlesLoading)return; const sortedTitles=titles.sort((a,b)=>a.localeCompare(b)); titleListContainer.innerHTML=''; titlesLoading.style.display='none'; if(sortedTitles.length===0){titleListContainer.innerHTML='<p class="text-gray-500 col-span-full text-center font-sans">¬ª No hay registros disponibles en este momento ¬´</p>';return;} sortedTitles.forEach(title=>titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { /*...*/ if(!titleListContainer||!newTitles||newTitles.length===0)return; const existingTitles=new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item=>item.dataset.title)); newTitles.forEach(title=>{if(!existingTitles.has(title)){titleListContainer.appendChild(createTitleItem(title));}}); filterTitles(searchInput.value); }

        // *** MODIFIED: handleTitleClick to integrate game loading ***
        async function handleTitleClick(title) {
            resetModalState(); // Resetea todo, incluye estado del juego
            showModal();
            modalTitle.textContent = title;
            currentTopicTitle = title; // Set context for chat

            // *** INICIAR JUEGO EN PANTALLA DE CARGA ***
            modalLoadingIndicator.style.display = 'flex'; // Asegurar que el contenedor de carga es visible
            initializeGame(); // Genera el tablero del juego
            loadingMessage.textContent = 'Mientras, los escribas preparan el relato...'; // Mensaje inicial
            loadingMessage.classList.remove('content-hidden');

            try {
                // Fetch principal (el juego est√° visible durante esto)
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // *** CONTENIDO LISTO -> OCULTAR JUEGO/CARGA ***
                modalLoadingIndicator.style.display = 'none'; // Oculta el juego y el mensaje
                gameInitialized = false; // El juego termin√≥, necesita reinicializarse la pr√≥xima vez

                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Mostrar √°rea de contenido
                modalTextArea.scrollTop = 0; // Reset scroll

                // Preparar placeholder de imagen
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-palette placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Creando representaci√≥n visual...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Cargar imagen
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Representaci√≥n de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualizaci√≥n no disponible.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al generar URL.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                // *** ERROR -> OCULTAR JUEGO/CARGA Y MOSTRAR ERROR ***
                modalLoadingIndicator.style.display = 'none';
                gameInitialized = false;

                modalErrorMessage.textContent = error.message || "Error desconocido al consultar los c√≥dices.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles for 40 ***
        async function handleGenerateMoreTitles() {
             const btn = generateMoreBtn;
             if (!btn) return;
             const spinner = btn.querySelector('i');
             btn.disabled = true;
             if(spinner) spinner.classList.remove('hidden');
             btn.childNodes[btn.childNodes.length-1].nodeValue = " Buscando..."; // Cambiar texto

             try {
                 const newTitles = await fetchGeneratedTitles(); // Llama a la versi√≥n que pide 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron revelar m√°s secretos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar m√°s sabidur√≠a: ${error.message}`);
             } finally {
                 btn.disabled = false;
                 if(spinner) spinner.classList.add('hidden');
                 btn.childNodes[btn.childNodes.length-1].nodeValue = " Revelar M√°s Sabidur√≠a (40)"; // Restaurar texto
             }
         }

         // *** Search Filter Function (sin cambios) ***
         function filterTitles(searchTerm) { /* ... (igual que antes) ... */ const term=searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();const titleItems=titleListContainer.querySelectorAll('.title-item');let visibleCount=0;titleItems.forEach(item=>{const titleText=item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");const isVisible=titleText.includes(term);item.classList.toggle('hidden',!isVisible);if(isVisible)visibleCount++;});noResultsMsg.classList.toggle('hidden',visibleCount>0); }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check essential elements
             const essentialElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, modalLoadingIndicator, loadingGameGrid, restartGameBtn, gameStatusElement, currentYearSpan];
             if (essentialElements.some(el => !el)) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: #991b1b; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Fatal: Los elementos sagrados de la interfaz no se cargaron correctamente.</p>';
                 return;
             }
            // Set footer year
            currentYearSpan.textContent = new Date().getFullYear();
            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
            restartGameBtn.addEventListener('click', () => {
                 resetGame(); // Limpia estado
                 initializeGame(); // Reinicia tablero
             });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            resetGame(); // Asegurar estado inicial limpio del juego
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>