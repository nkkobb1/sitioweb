<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marvel ft. Hora de Aventura - Crossovers Dimensionales</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes: Comic/Cartoon + Epic -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados: Marvel x Hora de Aventura --- */
        :root {
            /* Paleta Adventure Time */
            --at-yellow: #F8E71C;
            --at-blue: #4A90E2;
            --at-pink: #F5A623; /* Usaremos naranja como rosa por contraste */
            --at-green: #7ED321;
            /* Paleta Marvel */
            --marvel-red: #ED1D24;
            --marvel-blue: #0050A8;
            --marvel-dark: #1F1F1F;
            --marvel-grey: #E1E1E1;
            /* Paleta Combinada */
            --color-primary: var(--marvel-red); /* Rojo Marvel como primario */
            --color-secondary: var(--at-yellow); /* Amarillo HDA como secundario */
            --color-tertiary: var(--at-blue); /* Azul HDA como terciario */
            --color-accent: var(--at-green); /* Verde HDA como acento */
            --color-background: #f0f4f8; /* Fondo claro, casi blanco azulado */
            --color-text: #2d3748; /* Texto gris oscuro */
            --color-text-muted: #718096;
            --color-modal-bg: #ffffff; /* Modal blanco limpio */
            --color-border: #cbd5e0; /* Borde gris claro */
            --color-error-bg: #fff5f5;
            --color-error-text: #c53030;
            --color-error-border: #fc8181;

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-portal: 0 0 15px 3px var(--color-tertiary); /* Sombra azul para efecto portal */
            --border-radius: 8px; /* Bordes redondeados, más cartoon */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 300; }
        h1, h2, h3, h4, .logo, .button-font { font-family: 'Bangers', cursive; letter-spacing: 1.5px; /* Fuente tipo cómic */ }
        .logo { color: var(--color-primary); -webkit-text-stroke: 1px var(--marvel-dark); text-stroke: 1px var(--marvel-dark); }
        h1.page-title { color: var(--color-primary); font-weight: normal; /* Bangers ya es bold */ }
        h2.section-title { color: var(--color-text); border-bottom: 4px dashed var(--color-secondary); padding-bottom: 0.6rem; display: inline-block; font-weight: normal; }
        #modal-title { color: var(--marvel-blue); font-weight: normal; text-align: center; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 2px solid var(--color-border); }
        /* Buscador */
        #search-input { border: 2px solid var(--color-border); border-radius: var(--border-radius); padding: 0.8rem 1.2rem 0.8rem 3rem; font-family: 'Poppins'; width: 100%; } /* Added width: 100% */
        #search-input:focus { border-color: var(--color-tertiary); box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.3); outline: none; }
        #search-container { position: relative; } /* Needed for icon positioning */
        #search-container .fa-search { position: absolute; color: var(--color-text-muted); left: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.2rem; pointer-events: none; /* Prevent icon blocking input */ }
        #search-input:focus + .fa-search { color: var(--color-tertiary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Poppins', sans-serif; font-size: 0.95rem; border-bottom: 5px solid var(--color-border); }
        .title-item:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--color-tertiary); color: var(--marvel-blue); border-bottom-color: var(--color-tertiary); background-color: #eef5fc; }
        #generate-more-btn { background: linear-gradient(45deg, var(--color-primary), var(--at-pink)); color: white; padding: 0.9rem 1.8rem; border: none; border-radius: 50px; /* Botón más redondo */ font-size: 1.2rem; cursor: pointer; transition: var(--transition-normal); margin-top: 1.5rem; box-shadow: var(--shadow-md); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--at-pink), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.05); }
        #generate-more-btn:disabled { background: #b8c1cc; color: #e2e8f0; cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); /* Overlay más oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; } /* This class shows the modal */
        .modal-content-wrapper {
            background-color: var(--color-modal-bg); border: 3px solid var(--color-secondary); border-radius: var(--border-radius); padding: 1.5rem; max-width: 900px; width: 95%; max-height: 90vh; min-height: 450px; /* Más altura para juego y chat */ overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 8px; right: 8px; background: var(--color-secondary); border: 2px solid var(--marvel-dark); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--marvel-dark); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; font-family: 'Bangers'; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(360deg) scale(1.1); border-color: white; }

        /* Loading Screen & Minigame */
        #modal-loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.95), rgba(248, 231, 28, 0.95)); /* Gradiente Azul/Amarillo HDA */
            display: none; /* Initially hidden, shown by JS */
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 55; border-radius: var(--border-radius); padding: 1rem;
            text-align: center; overflow: hidden; /* Clip game elements */
        }
        #modal-loading.active { display: flex; } /* Class to show loading */
        #loading-message { color: var(--marvel-dark); font-family: 'Bangers'; font-size: 1.8rem; margin-bottom: 1rem; text-shadow: 1px 1px 0px var(--color-modal-bg); }
        .loading-spinner-modal { /* Maybe hide or make smaller if game is present */ display: none; }

        /* Minigame Styles */
        #loading-game-container {
            width: 90%; height: 65%; /* Adjust as needed */
            background-color: rgba(255, 255, 255, 0.4); /* Semi-transparent white */
            border: 3px dashed var(--color-primary);
            border-radius: var(--border-radius);
            position: relative; /* For positioning game elements */
            overflow: hidden;
            margin-top: 1rem;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        .game-element {
            position: absolute;
            width: 35px; height: 35px;
            background-size: contain; background-repeat: no-repeat; background-position: center;
            cursor: pointer;
            transition: transform 0.1s ease-out, opacity 0.2s ease-out; /* Added opacity transition */
            will-change: top, left, transform, opacity; /* Performance hint */
            display: flex; align-items: center; justify-content: center; /* Center icon */
        }
        .game-element i { pointer-events: none; /* Prevent icon capturing click */ } /* Important! */
        .game-element:hover { transform: scale(1.15); filter: brightness(1.1); }
        .game-collectible { border-radius: 50%; font-size: 24px; }
        .game-hazard { border-radius: 5px; font-size: 24px; }
        #game-info { margin-top: 0.5rem; font-family: 'Poppins'; color: var(--marvel-dark); font-weight: 600; font-size: 1rem; background: rgba(255,255,255,0.7); padding: 5px 10px; border-radius: 5px;}
        #game-level { margin-right: 15px; }
        /* Shake animation for hazard click */
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-5px); }
          50% { transform: translateX(5px); }
          75% { transform: translateX(-5px); }
        }
        .game-element.shake { animation: shake 0.3s ease-in-out; }

        /* Contenido Modal (Texto, Imagen, Chat) */
        #modal-story-content-area { display: none; /* Initially hidden, shown by JS after loading */ flex-direction: column; flex-grow: 1; min-height: 0; }
        #modal-story-content-area.active { display: flex; } /* Class to show content */
        #modal-content-area { /* Scrollable text/image */ flex-grow: 1; overflow-y: auto; padding: 0 10px 10px 5px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid #a0aec0; }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Bangers', cursive; margin-top: 2em; margin-bottom: 1em; color: var(--marvel-blue); border-bottom: 2px solid var(--color-secondary); padding-bottom: 0.4em; font-weight: normal; letter-spacing: 1px; }
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.2em; color: var(--at-green); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        /* Imagen y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2rem auto 1rem auto; border: 3px solid var(--color-secondary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-portal); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); font-family: 'Poppins'; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(203, 213, 224, 0.7); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--at-blue); }

        /* Chat */
        #chat-section { border-top: 2px dashed var(--color-tertiary); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 220px; /* Ajustar altura */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f7fafc; /* Fondo chat muy claro */ scroll-behavior: smooth; }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: 15px; /* Más redondeado */ max-width: 85%; word-wrap: break-word; line-height: 1.5; font-family: 'Poppins'; font-size: 0.95rem; }
        .user-message { background-color: var(--at-blue); color: white; margin-left: auto; text-align: left; border-bottom-right-radius: 3px; }
        .ai-message { background-color: var(--marvel-grey); color: var(--marvel-dark); margin-right: auto; text-align: left; border-bottom-left-radius: 3px; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: 20px; font-family: 'Poppins'; font-size: 0.9rem; }
        #chat-input:focus { outline: none; border-color: var(--color-tertiary); box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: 50%; cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; display: flex; align-items: center; justify-content: center; }
        #chat-send-btn:hover:not(:disabled) { background-color: #c53030; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }

        /* Error */
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Poppins'; display: none; /* Initially hidden */}
        .error-msg.active { display: block; } /* Class to show error */
        .error-msg i { margin-right: 0.7rem; }

        /* Fullscreen Image */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 4px solid var(--color-secondary); box-shadow: var(--shadow-portal); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 2px solid var(--color-secondary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--marvel-dark); transform: scale(1.1); }

        .content-hidden { display: none !important; } /* Utility class */
        .title-item.hidden { display: none; } /* For search filter */

    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-yellow-50"> <!-- Fondo gradiente suave -->
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-4xl sm:text-5xl">
                     <i class="fas fa-bolt mr-2 text-yellow-400"></i> <!-- Rayo Marvel/Energía -->
                     MARVEL <span class="text-blue-500 mx-1">ft.</span> HORA DE AVENTURA
                     <i class="fas fa-gem ml-2 text-pink-400"></i> <!-- Gema HDA -->
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wide">» Generador de Crossovers «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-4">¡Colisiones Multiversales!</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">¡Matemático! Explora historias donde los héroes de Marvel y los habitantes de Ooo cruzan caminos. ¡Elige una premisa o busca tu favorita!</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar héroe, villano, lugar...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll text-yellow-500 mr-2"></i> <!-- Pergamino HDA -->
                 Premisas de Historias
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Abriendo portales dimensionales...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">¡Glob! No hay resultados para esa búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn" class="button-font">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     ¡Más Aventuras! (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator & Game -->
             <div id="modal-loading">
                 <p id="loading-message">Calculando probabilidades multiversales...</p>
                 <div id="loading-game-container">
                    <!-- Minigame elements will be added here by JS -->
                 </div>
                 <div id="game-info">
                    <span id="game-level">Nivel: 1</span>
                    <span id="game-score">Puntos: 0</span>
                 </div>
                 <div class="loading-spinner-modal mt-4"></div> <!-- Optional Spinner -->
             </div>

             <!-- Story Content Area (Initially Hidden) -->
             <div id="modal-story-content-area">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-2xl md:text-3xl mb-4"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image placeholder/image goes here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al Oráculo...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta historia...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
             </div>

             <!-- Error Display Area (Initially Hidden) -->
             <div id="modal-error" class="error-msg flex-shrink-0"> <!-- Removed content-hidden, use JS to show -->
                 <i class="fas fa-exclamation-triangle"></i>
                 <span id="modal-error-message"></span>
             </div>

          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-800 text-gray-300 py-6 mt-12 border-t-4 border-yellow-400 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias generadas por IA basadas en universos ficticios. ¡Sólo por diversión!</p>
              <p class="mt-1">Marvel y Hora de Aventura son propiedad de sus respectivos creadores.</p>
              <p class="mt-2">© 2024 Multiverse Mashup Inc.</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Personaje vs Personaje
            "Iron Man vs. El Rey Helado: Batalla Tecnológica en el Reino de Hielo", "Hulk Aplasta al Lich: Furia Imparable Contra la Muerte Eterna", "Spider-Man en Ooo: Confusión y Telarañas en el Dulce Reino", "Capitán América se Encuentra con Finn: El Escudo y la Espada", "Thor Odinson Descubre Ooo: ¿Es Digno el Martillo?", "Viuda Negra vs. Marceline: Duelo de Reinas Oscuras", "Doctor Strange Visita a Prismo: Maestros del Multiverso", "Deadpool Irrumpe en Hora de Aventura: Rompiendo la Cuarta Pared y Más", "Wolverine vs. Jake el Perro: Garras Contra Elasticidad", "Thanos Busca las Gemas del Infinito en Ooo", "Loki Intenta Engañar al Mago de la Fiesta", "Groot y Jake: Una Amistad Inusual", "Rocket Raccoon Intenta 'Mejorar' a BMO", "Scarlet Witch vs. Betty Grof (MAGIC MA'AM): Duelo de Magia Caótica", "El Castigador Persigue a Lemongrab: '¡INACEPTABLE!'", "Ms. Marvel (Kamala) se Hace Fan de Finn y Jake", "Moon Knight Protege el Dulce Reino de Amenazas Nocturnas", "Venom se Vincula con un Habitante de Ooo (¿Conde Limonagrio?)", "Ghost Rider Juzga las Almas del Reino de Fuego", "Ant-Man y la Avispa Exploran el Microverso de BMO", "Blade Caza Vampiros en la Nocheosfera", "Los Cuatro Fantásticos Investigan Anomalías en Ooo", "Silver Surfer Atraviesa los Cielos de Ooo", "Galactus Amenaza con Devorar Ooo", "Daredevil 'Ve' los Secretos del Reino Helado", "Magneto Intenta Reclutar a los Magos de Ooo", "Profesor X Contacta a la Dulce Princesa", "Jean Grey (Fénix) Siente el Poder del Lich", "Ice Man vs. Rey Helado: Batalla por el Trono de Hielo", "La Cosa y el Hombre de Malvavisco: Pelea de Masas",
            // Equipo vs Equipo / Team-Ups
            "Los Vengadores Perdidos en Ooo: Reunión Forzosa", "Finn y Jake se Unen a los Guardianes de la Galaxia", "La Patrulla X Recluta Mutantes en Ooo", "Los Defensores Protegen el Dulce Reino de la Mano (de Marvel)", "El Sindicato del Crimen (Marvel) Intenta Conquistar Ooo", "Los Thunderbolts Capturan Villanos de HDA", "Agentes de S.H.I.E.L.D. Investigan la Guerra del Champiñón", "Midnight Suns vs. Los Horrores Cósmicos de Ooo (Lich, Orgalorg)", "La Fundación Futuro (FF) Estudia la Ciencia del Dulce Reino", "A-Force y las Princesas de Ooo: Alianza Femenina", "Web Warriors (Spider-Verse) Encuentran a un 'Spider-Finn'", "Captain Carter y Finn el Humano: Héroes Fuera de Tiempo", "What If...?: Los Vengadores se Forman en Ooo", "What If...?: Jake se Convierte en un Agente de S.H.I.E.L.D.", "What If...?: La Dulce Princesa Descubre el Vibranium", "What If...?: Marceline se Encuentra con Morbius", "Los Jóvenes Vengadores Hacen Amistad con Fionna y Cake", "Runaways se Esconden en el Bosque de Ooo", "Excalibur Protege el Reino Mágico de Ooo", "El Cuerpo Nova Investiga la Energía Cósmica de Ooo",
            // Objeto/Concepto Crossover
            "El Guantelete del Infinito en Manos del Rey Helado", "El Enchiridion Cae en Manos de Doctor Doom", "El Cubo Cósmico Altera la Realidad del Dulce Reino", "Las Gemas del Infinito Reemplazan a las Gemas de las Princesas", "Finn Intenta Usar las Armas de Asgard", "La Dulce Princesa Estudia la Tecnología Stark", "Jake se Estira con Partículas Pym", "BMO es 'Hackeado' por Ultron", "El Nulificador Supremo Aparece en Ooo", "El Casco de Magneto vs. La Corona del Rey Helado", "Un Simbionte Klyntar en el Reino de Fuego", "La Fuerza Fénix Reside en la Princesa Llama", "Viaje a la Zona Negativa desde Ooo", "El Darkhold Corrompe a un Mago de Ooo", "El Vigilante Observa el Crossover Definitivo", "Las Bandas Escarlatas de Cyttorak Atrapan a Jake", "El Ojo de Agamotto Revela el Pasado de Ooo", "Alguien Intenta Replicar el Suero del Súper Soldado con Ciencia Dulce", "Mjolnir Atascado en el Árbol Fortaleza", "El Surf de Silver Surfer Hecho de Caramelo Cósmico", "Los Anillos del Mandarín Dispersos por Ooo", "La Armadura del Destructor (Asgard) Animada por Magia de Ooo", "El Corazón del Universo Pulsando en Ooo", "El Nido de Avispa (Microverso) Conectado a BMO", "El Reino Cuántico y el Mundo de los Espíritus de HDA",
            // Eventos y Escenarios
            "Secret Wars: Battleworld Incluye un Dominio de Ooo", "Civil War: ¿Team Iron Man o Team Captain Finn?", "Annihilation Wave Llega a la Galaxia de Ooo", "House of M: La Bruja Escarlata Reescribe Ooo ('No Más Mutantes')", "World War Hulk en el Dulce Reino", "Age of Apocalypse, Estilo Ooo", "Infinity War: Thanos vs. Todos en Ooo", "Siege: Norman Osborn Asedia el Dulce Reino", "Fear Itself: Los Martillos de los Dignos Caen en Ooo", "Spider-Verse: Variantes de Finn y Jake con Poderes Arácnidos", "Marvel Zombies Invaden Ooo", "El Día de M (Mutantes en Ooo)", "La Última Aventura: El Fin del Universo Marvel y Ooo", "Un Mundo sin Héroes (Marvel): Finn y Jake Intervienen", "Invasión Secreta: ¿Qué Personajes de HDA son Skrulls?", "El Imperativo Thanos en la Dimensión de Prismo", "Axis: Héroes y Villanos Invierten Roles en Ooo", "La Guerra Kree-Skrull se Extiende a Ooo", "Planeta Hulk: Hulk Aterriza en el Reino de Fuego", "El Reinado Oscuro del Rey Helado (Con Poderes de Norman Osborn)",
            // Tonos y Géneros Específicos
            "Una Comedia Romántica: Deadpool Intenta Ligar con la Dulce Princesa", "Historia de Terror Cósmico: El Lich se Enfrenta a Dormammu", "Misterio Noir: Jessica Jones Investiga un Crimen en el Dulce Reino", "Aventura Espacial: Star-Lord y Finn Roban un Artefacto Cósmico", "Musical: Galactus Llega a Ooo... Cantando", "Historia de Origen: ¿Cómo Obtuvo Finn sus Poderes Mutantes?", "Western Espacial: Los Guardianes en las Tierras Baldías de Ooo", "Fantasía Épica: Thor y la Princesa Llama Contra Surtur", "Ciencia Ficción Dura: Reed Richards Analiza la Magia de Ooo", "Historia de Viajes en el Tiempo: Kang el Conquistador vs. Prismo", "Parodia: Howard el Pato Comenta el Crossover", "Drama Judicial: Matt Murdock Defiende al Conde Limonagrio", "Película de Monstruos: Hulk y Hombre Cosa vs. Monstruos de Ooo", "Historia de Espías: Nick Fury Recluta a la Princesa Chicle", "Cyberpunk: El Dulce Reino en el Año 2099",
             // Añadir más combinaciones locas...
            "La Boda de Cíclope y Jean Grey... Interrumpida por el Rey Helado", "Masacre (Deadpool) Adopta a un Mini-Jake", "El Increíble Hulk Intenta Hacer Limonada con Limonagrio", "Doctor Strange Enseña Magia en la Escuela de Magos", "Iron Fist y Finn: Duelo de Puños y Espadas", "Luke Cage se Hace Amigo del Perro Mágico", "Black Panther Visita un Reino Oculto en Ooo", "Capitana Marvel Responde a una Señal de Auxilio de Ooo", "Los Celestiales Juzgan la Tierra de Ooo", "Eternals Descubren Deviants en Ooo", "Shang-Chi Entrena con el Maestro del Puño", "She-Hulk Defiende a BMO en Corte Interdimensional", "Squirrel Girl Derrota a Thanos... y al Lich", "Taskmaster Intenta Copiar las Habilidades de Jake", "Visión Intenta Comprender la Lógica de Ooo", "War Machine Actualiza la Armadura de la Princesa Chicle", "Winter Soldier Atrapado en el Pasado de Ooo", "Adam Warlock Medita con Prismo", "Beta Ray Bill Comparte Hidromiel con Jake", "Cable Viaja al Futuro Post-Apocalíptico de Ooo", "Cloak y Dagger se Teletransportan a la Nocheosfera", "Crystal (Inhumanos) Controla los Elementos de Ooo", "Elektra Asesina Contratada en el Reino de Fuego", "Emma Frost Intenta Leer la Mente de Gunter", "Gamora Busca la Espada de Hierba", "Hawkeye Enseña Arquería a Susan Strong", "Hércules Lucha Contra Gigantes de Ooo", "Human Torch Enciende a la Princesa Llama (Literalmente)", "Invisible Woman se Esconde del Rey Helado", "Juggernaut Atropella el Dulce Reino", "Ka-Zar y Zabu en las Selvas de Ooo", "Kraven el Cazador Persigue a Jake", "Magik (Illyana Rasputina) Abre un Portal al Limbo desde Ooo", "Mister Fantastic Intenta Analizar la Elasticidad de Jake", "Mister Sinister Experimenta con ADN Dulce", "Mockingbird se Infiltra en la Guardia Banana", "Monica Rambeau (Spectrum) Viaja a Través de Dimensiones a Ooo", "Namor el Submarino Descubre Reinos Submarinos en Ooo", "Nightcrawler se Teletransporta por Ooo", "Nova (Richard Rider) Patrulla el Sector Espacial de Ooo", "Patriot (Eli Bradley) Inspira a los Héroes de Ooo", "Psylocke Tiene un Duelo Psíquico con Goliad", "Quicksilver Corre Alrededor de Ooo en un Segundo", "Red Hulk Pelea con la Princesa Llama", "Red Skull Intenta Crear Hydra en Ooo", "Rhino Carga Contra el Muro de Carne", "Sandman se Mezcla con el Desierto de Ooo", "Sentry Pierde el Control en Ooo", "Spider-Gwen Colabora con Fionna", "Spider-Man 2099 Visita el Futuro de Ooo", "Spider-Woman (Jessica Drew) Investigando Toxinas en Ooo", "Starfox Usa sus Poderes de Persuasión en Ooo", "Storm Controla el Clima del Reino Helado", "Sunspot Absorbe Energía del Reino de Fuego", "Thing Ayuda a Construir un Nuevo Reino Dulce", "Tigra se Adapta a la Vida Salvaje de Ooo", "Valkyrie Lleva Héroes Caídos de Ooo al Valhalla", "Wasp (Janet) Explora Jardines Diminutos en Ooo", "Wonder Man Actúa en el Teatro del Dulce Reino", "X-23 Encuentra un Espíritu Afín en Marceline", "Yellowjacket (Darren Cross) Intenta Robar Tecnología Dulce", "Zabu y Jake: Competencia de Animales Fantásticos", "Apocalipsis Busca Mutantes Dignos en Ooo", "Arcade Atrapa a Finn y Jake en Murderworld", "Barón Zemo Planea Dominar Ooo desde las Sombras", "Bastion Desata Centinelas contra Ooo", "Blackheart Tienta a Marceline", "Bullseye Nunca Falla... ¿Ni Siquiera Contra Jake?", "Carnage se Une a un Ser de Ooo", "Centinelas Cazan Mutantes en Ooo", "Crossbones Lucha Contra la Guardia Banana", "Deathbird Intenta Conquistar el Espacio Aéreo de Ooo", "Destructor (Dirk Garthwaite) Destruye Propiedad Dulce", "Doctor Octopus Intenta Controlar los Guardianes de Chicle", "Dientes de Sable vs. Finn con la Espada de Hierba", "Domo Arcano de Dormammu sobre Ooo", "Ego el Planeta Viviente se Acerca a Ooo", "El Buitre Sobrevuela el Reino Nube", "El Camaleón se Hace Pasar por la Dulce Princesa", "El Duende Verde Lanza Bombas Calabaza en el Dulce Reino", "El Escarabajo (Abner Jenkins) Lucha Contra Iron Man... en Ooo", "El Espantapájaros (Marvel) Ataca Mentes en Ooo", "El Láser Viviente Ataca Ooo", "El Lagarto Experimenta con ADN de Ooo", "El Mandarín Busca Poder en los Anillos Elementales de Ooo", "El Pensador Loco Intenta Superar a la Princesa Chicle", "El Supervisor Estudia los Estilos de Lucha de Ooo", "Electro Cortocircuita a BMO", "Encantadora Hechiza a Finn", "Fin Fang Foom Despierta Bajo Ooo", "Galactus Envía a su Heraldo (¿Finn?)", "Garra Sónica Ataca con Sonido", "Gorgon (Tomi Shishido) Petrificando Habitantes de Ooo", "Graviton Altera la Gravedad de Ooo", "Grifo Ataca desde los Cielos", "Holocausto (Nemesis) Drena Energía Vital", "Hombre Absorbente Toca un Material de Ooo", "Hombre de Arena en las Playas de Ooo", "Hombre Gorila Busca Conocimiento Prohibido", "Hombre Topo Excava Bajo el Dulce Reino", "Hydra Establece una Base Secreta en Ooo", "Kang el Conquistador Altera la Línea Temporal de Ooo", "Kingpin Controla el Bajo Mundo de Ooo", "Klaw Manipula el Sonido Contra los Héroes", "Korvac Busca Poder Cósmico en Ooo", "Kulan Gath Lanza un Hechizo sobre Ooo", "La Abominación Lucha Contra Jake-Hulk", "La Brigada de Demolición Ataca Ooo", "La Hermandad de Mutantes Diabólicos Recluta", "Lady Deathstrike Mejora sus Garras con Tecnología Dulce", "Lápida Lucha Contra Héroes Callejeros en Ooo", "Líder Intenta Controlar Mentalmente a Ooo", "Living Monolith Absorbe Energía", "Madame Máscara Intriga en Ooo", "Madame Web Ve el Futuro del Crossover", "Magus (Adam Warlock Maligno) Corrompe Ooo", "Malekith el Maldito Trae Oscuridad a Ooo", "Mefisto Ofrece un Trato a un Héroe de Ooo", "Mente Maestra Crea Ilusiones", "Miek Lidera una Revolución de Insectos", "Mordo Desafía al Doctor Strange en Ooo", "Morlun Caza Tótems Arácnidos en Ooo", "Mystique se Infiltra en Ooo", "Nitro Explota Cerca del Dulce Reino", "Pesadilla Atormenta los Sueños de Ooo", "Plutón (Dios Romano) Reclama Almas", "Puercoespín Lanza Púas", "Puppet Master Controla Títeres", "Pyro Quema el Reino de Fuego", "Radioactive Man Irradia Ooo", "Rino Lucha Contra Spider-Finn", "Ronan el Acusador Juzga Ooo", "Selene la Reina Negra Drena Vida", "Serpiente de Midgard Ataca Ooo", "Set el Dios Serpiente Corrompe", "Shuma-Gorath Amenaza la Realidad", "Silver Samurai Corta con su Katana", "Skurge el Ejecutor Busca Almas para Hela", "Super-Skrull Imita Héroes de Ooo", "Supremor Controla a los Kree", "Surtur Trae el Ragnarok a Ooo", "Terrax el Dominador (Heraldo) Ataca", "Thundra Lucha por el Honor", "Tiburon Tigre Ataca Costas", "Tinkerer Crea Gadgets para Villanos", "Titanium Man Lucha Contra Iron Man", "Toro Lucha Ferozmente", "Trapster Pega a los Héroes", "Typhoid Mary Desata Caos Psíquico", "Ulik el Troll Lucha Contra Thor", "Ultron Mejora con Tecnología Dulce", "Unicornio Carga con su Cuerno", "Urraca Ataca con Gritos Sónicos", "Verdugo Imparte Justicia Asgardiana", "Vibora Lidera Hydra", "Ymir el Gigante de Hielo Congela Ooo", "Zarrko el Hombre del Mañana Altera el Tiempo", "Zzzax Absorbe Energía Eléctrica"
        ];
        const crossoverThemes = [ // Para generar más títulos
            "personajes de Marvel en Ooo", "personajes de Hora de Aventura en el Universo Marvel", "team-ups Marvel y HDA", "batallas Marvel vs HDA", "objetos de Marvel en Ooo", "objetos de HDA en Marvel", "magia de HDA vs tecnología Marvel", "eventos cósmicos Marvel afectando Ooo", "versiones alternativas (What If)", "romances improbables crossover", "misterios interdimensionales", "historias de terror crossover", "comedias crossover", "aventuras espaciales crossover", "viajes en el tiempo crossover", "villanos de Marvel conquistando Ooo", "villanos de HDA en Nueva York", "la ciencia de Dulce Princesa vs Reed Richards", "el multiverso de Prismo y Doctor Strange", "Finn buscando ser digno de Mjolnir", "Jake interactuando con simbiontes", "Marceline y Blade", "Rey Helado y Loki", "Dulce Princesa y Iron Man", "Princesa Llama y Human Torch", "BMO y Vision", "El Lich y Thanos", "Guardianes de la Galaxia y habitantes de Ooo"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un bardo multiversal y un fanático de los cómics y la animación. Tu tarea es escribir una HISTORIA CORTA y emocionante basada en la premisa de crossover entre Marvel y Hora de Aventura que se te proporciona. Captura el tono y la personalidad de los personajes de ambos universos. Desarrolla la trama, incluye diálogos característicos, acción o momentos divertidos/emotivos según la premisa. La historia debe tener un inicio, desarrollo y un final (aunque sea abierto), con una longitud aproximada de 1200-1300 palabras. Sé creativo y fiel al espíritu de ambos mundos. La premisa es:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "¡Algebraico! Eres un asistente del bardo multiversal, experto en la historia de crossover que se acaba de contar. Responde preguntas sobre los personajes, la trama, los detalles o posibles continuaciones de ESTA historia específica. Mantén el tono divertido y conocedor de ambos universos.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de ideas para crossovers locos entre Marvel y Hora de Aventura. Genera exactamente 40 premisas de historias únicas y emocionantes, una por línea. Combina personajes, lugares, objetos o eventos de ambos universos de formas inesperadas. Sé creativo y específico. Devuelve *solo* la lista de premisas, sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentado ligeramente para 40 títulos
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const loadingGameContainer = document.getElementById('loading-game-container');
        const gameInfoDisplay = document.getElementById('game-info');
        const gameLevelDisplay = document.getElementById('game-level');
        const gameScoreDisplay = document.getElementById('game-score');
        const loadingMessage = document.getElementById('loading-message');

        // ========== State Variables ==========
        let currentStoryTitle = null;
        // Minigame State
        let gameActive = false;
        let gameScore = 0;
        let gameLevel = 1;
        let gameSpawnInterval = null; // Initialize as null
        let gameTimerInterval = null; // Initialize as null

        // ========== MINIGAME LOGIC ==========
        const gameSettings = {
            levels: [
                { level: 1, spawnRate: 1000, pointsPerItem: 10, hazards: 0, penalty: 0 },
                { level: 2, spawnRate: 800, pointsPerItem: 15, hazards: 1, penalty: -20 },
                { level: 3, spawnRate: 600, pointsPerItem: 20, hazards: 2, penalty: -30 },
                { level: 4, spawnRate: 500, pointsPerItem: 25, hazards: 3, penalty: -40 },
                { level: 5, spawnRate: 400, pointsPerItem: 30, hazards: 4, penalty: -50 },
            ],
            collectibleIcons: ['fa-gem', 'fa-star', 'fa-bolt', 'fa-shield-alt', 'fa-hat-wizard'],
            hazardIcons: ['fa-bomb', 'fa-skull-crossbones', 'fa-biohazard', 'fa-radiation'],
            collectibleColors: ['text-yellow-400', 'text-blue-400', 'text-pink-400', 'text-green-400', 'text-purple-400'],
            hazardColors: ['text-gray-700', 'text-red-700'],
            maxElements: 20
        };

        function updateGameDisplay() {
            if (gameLevelDisplay) gameLevelDisplay.textContent = `Nivel: ${gameLevel}`;
            if (gameScoreDisplay) gameScoreDisplay.textContent = `Puntos: ${gameScore}`;
        }

        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        function elementClicked(event) {
            if (!gameActive || !event.target.classList.contains('game-element')) return; // Check if the clicked element is a game element
            const element = event.target;
            const isCollectible = element.dataset.type === 'collectible';
            const levelIndex = Math.min(gameLevel - 1, gameSettings.levels.length - 1); // Ensure valid index
            const levelConfig = gameSettings.levels[levelIndex];

            if (isCollectible) {
                gameScore += levelConfig.pointsPerItem;
                element.style.opacity = '0';
                element.style.transform = 'scale(1.5)';
                setTimeout(() => element.remove(), 200);
            } else { // Hazard
                gameScore += levelConfig.penalty;
                if (gameScore < 0) gameScore = 0;
                element.classList.add('shake'); // Add shake animation class
                // Remove element after animation
                setTimeout(() => element.remove(), 300);
            }
            updateGameDisplay();
        }

        function spawnElement() {
            if (!gameActive || !loadingGameContainer) return;
            const existingElements = loadingGameContainer.querySelectorAll('.game-element').length;
            if (existingElements >= gameSettings.maxElements) return;

            const levelIndex = Math.min(gameLevel - 1, gameSettings.levels.length - 1);
            const levelConfig = gameSettings.levels[levelIndex];
            const isHazard = Math.random() < (levelConfig.hazards * 0.15);

            const element = document.createElement('div');
            element.classList.add('game-element');
            const iconElement = document.createElement('i');
            iconElement.classList.add('fas'); // FontAwesome solid style

            if (isHazard && levelConfig.hazards > 0) {
                element.dataset.type = 'hazard';
                element.classList.add('game-hazard');
                iconElement.className = `fas ${getRandomElement(gameSettings.hazardIcons)}`; // Set full class for FA
                element.classList.add(getRandomElement(gameSettings.hazardColors));
            } else {
                element.dataset.type = 'collectible';
                element.classList.add('game-collectible');
                 iconElement.className = `fas ${getRandomElement(gameSettings.collectibleIcons)}`; // Set full class for FA
                element.classList.add(getRandomElement(gameSettings.collectibleColors));
            }
            element.appendChild(iconElement); // Append the <i> element

            const gameRect = loadingGameContainer.getBoundingClientRect();
            // Ensure width/height are positive before calculating position
            if (gameRect.width > 40 && gameRect.height > 40) {
                 element.style.left = `${Math.random() * (gameRect.width - 40) + 5}px`;
                 element.style.top = `${Math.random() * (gameRect.height - 40) + 5}px`;
            } else {
                 element.style.left = '10px'; // Default position if container size is invalid
                 element.style.top = '10px';
            }


            element.addEventListener('click', elementClicked); // Add listener to the div, not the icon
            loadingGameContainer.appendChild(element);

            setTimeout(() => {
                 if (element && element.parentElement) {
                    element.style.opacity = '0';
                    setTimeout(() => element.remove(), 500);
                 }
             }, Math.random() * 3000 + 4000);
        }

        function nextLevel() {
            gameLevel++;
            const maxLevel = gameSettings.levels.length;
            if (gameLevel > maxLevel) {
                if (loadingMessage) loadingMessage.textContent = `¡Nivel Máximo! Puntos: ${gameScore}`;
                gameLevel = maxLevel; // Stay at max level
            } else {
                 if (loadingMessage) loadingMessage.textContent = `¡Nivel ${gameLevel} alcanzado!`;
                 setTimeout(() => { if (loadingMessage && gameActive) loadingMessage.textContent = "¡Sigue jugando mientras carga!"; }, 1500);
            }

            if (loadingGameContainer) loadingGameContainer.innerHTML = ''; // Clear elements
            updateGameDisplay();

            if (gameSpawnInterval) clearInterval(gameSpawnInterval); // Clear previous interval
            const levelIndex = Math.min(gameLevel - 1, gameSettings.levels.length - 1);
            const levelConfig = gameSettings.levels[levelIndex];
            if (gameActive) { // Only set new interval if game should still be active
                gameSpawnInterval = setInterval(spawnElement, levelConfig.spawnRate);
            }
        }

        function startGame() {
            if (!modalLoadingIndicator || !loadingGameContainer) {
                console.error("Minigame elements not found, cannot start game.");
                return;
            }
            console.log("Starting minigame...");
            modalLoadingIndicator.classList.add('active'); // Show loading section
            loadingGameContainer.innerHTML = '';
            gameActive = true;
            gameScore = 0;
            gameLevel = 1;
            updateGameDisplay();
            if (loadingMessage) loadingMessage.textContent = "¡Minijuego de Carga Activado!";

            const initialLevelConfig = gameSettings.levels[0];
            // Clear previous intervals before starting new ones
            if (gameSpawnInterval) clearInterval(gameSpawnInterval);
            if (gameTimerInterval) clearInterval(gameTimerInterval);

            gameSpawnInterval = setInterval(spawnElement, initialLevelConfig.spawnRate);

            gameTimerInterval = setInterval(() => {
                if (!gameActive) return;
                const scoreThreshold = 100 + (gameLevel * 150);
                if (gameScore >= scoreThreshold && gameLevel < gameSettings.levels.length) {
                    nextLevel();
                }
                const messages = ["Recolectando artefactos...", "Esquivando anomalías...", "Calculando rutas...", "¡Casi listo!"];
                 if (loadingMessage && Math.random() < 0.1) loadingMessage.textContent = getRandomElement(messages);

            }, 2000);
        }

        function stopGame() {
             console.log("Stopping minigame...");
             gameActive = false;
             if (gameSpawnInterval) {
                 clearInterval(gameSpawnInterval);
                 gameSpawnInterval = null; // Reset interval ID
             }
             if (gameTimerInterval) {
                 clearInterval(gameTimerInterval);
                 gameTimerInterval = null; // Reset interval ID
             }
             if (loadingGameContainer) loadingGameContainer.innerHTML = '';
             // Keep the modalLoadingIndicator visible until content is ready
        }

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `¡Algebraico! Eres un asistente del bardo multiversal, experto en la historia de crossover llamada '${currentStoryTitle}'. Responde preguntas sobre los personajes, la trama, los detalles o posibles continuaciones de ESTA historia específica. Mantén el tono divertido y conocedor de ambos universos.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}, Timeout: ${config.timeoutSeconds}s): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) ¡Oh my Glob! Nuestros servidores tienen mucho tráfico o hay una falla dimensional. Intenta en unos segundos.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("¡BMO dice que la respuesta de la IA está vacía! Intenta de nuevo.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión tardó más de ${config.timeoutSeconds}s. ¡Como esperar mil años! Revisa tu conexión o intenta más tarde.`);
                 throw new Error(error.message || "¡Algo salió mal! Error desconocido al contactar la IA.");
             }
        }
        async function fetchExplanationText(storyTitle) {
            return fetchTextFromApi(storyTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentStoryTitle) throw new Error("Error interno: No sé de qué historia estamos hablando.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() { // Fetches 40 titles
            const randomTheme = getRandomElement(crossoverThemes) || "crossovers Marvel y Hora de Aventura";
            const specificPrompt = `Genera 40 premisas de historias crossover sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 200);
                     if (titles.length < 10) throw new Error("La IA no generó suficientes ideas de crossover.");
                     return titles.slice(0, 40);
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Marvel Adventure Time crossover";
             const enhancedPrompt = `Digital painting, vibrant cartoon style mixed with comic book dynamism, depicting the crossover scene: '${safePromptText}'. Capture character interactions, action, or atmosphere. Bright colors from Adventure Time, dynamic poses from Marvel. Avoid text, labels.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, 3D render, low detail, blurry";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() {
            if (storyModal) {
                storyModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            } else {
                console.error("showModal: storyModal element not found!");
            }
        }
        function hideModal() {
            stopGame(); // Ensure game stops
            if (storyModal) storyModal.classList.remove('active');
            if (imageFullscreenOverlay && !imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            if (modalTextArea) modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             console.log("Entering resetModalState");
             stopGame(); // Stop game first

             // Hide content, show loading section by default
             if (modalLoadingIndicator) modalLoadingIndicator.classList.add('active'); else console.error("resetModalState: modalLoadingIndicator missing");
             if (modalStoryContentArea) modalStoryContentArea.classList.remove('active'); else console.error("resetModalState: modalStoryContentArea missing");
             if (modalError) modalError.classList.remove('active'); else console.error("resetModalState: modalError missing");


             if (loadingMessage) loadingMessage.textContent = "Calculando probabilidades..."; else console.error("resetModalState: loadingMessage missing");
             if (modalTitle) modalTitle.textContent = ''; else console.error("resetModalState: modalTitle missing");
             if (modalContent) modalContent.innerHTML = ''; else console.error("resetModalState: modalContent missing");
             if (modalErrorMessage) modalErrorMessage.textContent = ''; else console.error("resetModalState: modalErrorMessage missing");
             if (chatHistory) chatHistory.innerHTML = ''; else console.error("resetModalState: chatHistory missing");
             if (chatInput) chatInput.value = ''; else console.error("resetModalState: chatInput missing");
             if (chatLoadingIndicator) chatLoadingIndicator.style.display = 'none'; else console.error("resetModalState: chatLoadingIndicator missing");
             if (chatSendBtn) chatSendBtn.disabled = false; else console.error("resetModalState: chatSendBtn missing");

             currentStoryTitle = null;
             hideFullscreenImage();
             console.log("resetModalState finished");
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ==========
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (storyModal && !storyModal.classList.contains('active')) { document.body.style.overflow = ''; } if(fullscreenImage) fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ==========
        function addChatMessage(message, sender) { if (!chatHistory) return; const msgDiv=document.createElement('div'); msgDiv.classList.add('chat-message', sender==='user'?'user-message':'ai-message'); message=message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML=message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { if (!chatHistory) return; const errDiv=document.createElement('div'); errDiv.classList.add('chat-error'); errDiv.textContent=message; chatHistory.appendChild(errDiv); chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { if (!chatInput || !chatSendBtn || !chatLoadingIndicator) return; const userQuery=chatInput.value.trim(); if(!userQuery||chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value=''; chatSendBtn.disabled=true; chatLoadingIndicator.style.display='block'; try { const aiResponse=await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Error IA: ${error.message}`); } finally { chatLoadingIndicator.style.display='none'; chatSendBtn.disabled=false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { if (!titleListContainer || !titlesLoading) return; const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); titleListContainer.innerHTML = ''; titlesLoading.style.display = 'none'; if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">¡Vacío Dimensional! No hay premisas.</p>'; return; } sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }
        function appendTitles(newTitles) { if (!titleListContainer || !newTitles || newTitles.length === 0) return; const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title)); newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } }); filterTitles(searchInput.value); }

        // *** CORRECTED handleTitleClick ***
        async function handleTitleClick(title) {
            console.log("handleTitleClick triggered for:", title);
            try {
                // 1. Reset state (stops previous game, clears content, shows loading section)
                resetModalState();
                console.log("resetModalState completed.");

                // 2. Set context
                currentStoryTitle = title;
                console.log("Context set:", currentStoryTitle);

                // 3. Show the modal frame
                showModal();
                console.log("showModal completed.");

                // 4. Set the title in the (now visible) modal
                 if (modalTitle) modalTitle.textContent = title; else console.error("handleTitleClick: modalTitle missing!");

                // 5. Start the minigame inside the loading section
                console.log("Attempting to start game...");
                startGame();
                console.log("startGame completed or initiated.");

                // 6. Fetch the story data (game runs during fetch)
                console.log("Fetching story text...");
                const rawExplanationText = await fetchExplanationText(title);
                console.log("Story text fetched.");

                // --- Data Fetched Successfully ---

                // 7. Stop the minigame
                stopGame();
                console.log("Game stopped.");

                // 8. Hide loading section, show content area
                if (modalLoadingIndicator) modalLoadingIndicator.classList.remove('active');
                if (modalStoryContentArea) modalStoryContentArea.classList.add('active');
                console.log("Switched from loading to content view.");

                // 9. Format and display text
                const formattedExplanation = formatExplanationText(rawExplanationText);
                 if (modalContent) modalContent.innerHTML = formattedExplanation; else console.error("handleTitleClick: modalContent missing!");
                if (modalTextArea) modalTextArea.scrollTop = 0; // Reset scroll for new content

                // 10. Prepare and load image
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Dibujando el crossover...</p>`;
                 if (modalContent) modalContent.appendChild(placeholderDiv); else console.error("handleTitleClick: Cannot append placeholder, modalContent missing!");


                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Crossover: ${title}`;
                imgElement.style.display = 'none'; // Hide until loaded

                imgElement.onload = () => {
                    placeholderDiv.remove(); imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">¡Fallo artístico!</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                 if (imageUrl) {
                     imgElement.src = imageUrl;
                     if (modalContent) modalContent.appendChild(imgElement); else console.error("handleTitleClick: Cannot append image, modalContent missing!");
                 }
                 else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                 }

            } catch (error) {
                 console.error("Error in handleTitleClick:", error);
                 // --- Error Handling ---
                 stopGame(); // Ensure game is stopped on error
                 if (modalLoadingIndicator) modalLoadingIndicator.classList.remove('active'); // Hide loading screen

                 // Show error message (modal frame should be visible from showModal())
                 if (modalErrorMessage && modalError) {
                    modalErrorMessage.textContent = error.message || "¡Error cósmico! No se pudo cargar la historia.";
                    modalError.classList.add('active'); // Show error section
                    // Ensure content area is hidden if error occurs before content is ready
                    if (modalStoryContentArea) modalStoryContentArea.classList.remove('active');
                 } else {
                    // Fallback if error elements are missing
                    alert("Ocurrió un error al intentar cargar la historia: " + error.message);
                 }
                 // Ensure modal remains controllable if error occurred early
                  if (storyModal && !storyModal.classList.contains('active')){
                     showModal(); // Try showing modal again if it somehow got hidden
                  }
            }
        }


        async function handleGenerateMoreTitles() { // Fetches 40
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando Portales...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("¡El Multiverso no responde! No se pudieron generar más premisas."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error generando premisas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> ¡Más Aventuras! (40)';
             }
         }

         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             if(noResultsMsg) noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check for all essential elements
             const essentialElements = [
                 titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading,
                 searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay,
                 fullscreenCloseBtn, loadingGameContainer, modalLoadingIndicator, modalStoryContentArea,
                 modalError, modalErrorMessage, gameInfoDisplay, gameLevelDisplay, gameScoreDisplay, loadingMessage,
                 modalTitle, modalContent, modalTextArea, chatHistory, chatLoadingIndicator, chatSection
             ];
             const missingElement = essentialElements.find(el => !el);
             if (missingElement) {
                console.error("Initialization failed: Missing essential element.", missingElement);
                 document.body.innerHTML = `<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡ZAP! Error crítico al cargar la interfaz (Elemento Faltante: ${missingElement?.id || 'desconocido'}). ¡Algo es INACEPTABLE!</p>`;
                return;
             }

             console.log("All essential elements found. Initializing listeners...");

            // Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            if(noResultsMsg) noResultsMsg.classList.add('hidden');
            if(loadingGameContainer) loadingGameContainer.innerHTML = ''; // Ensure game container is empty

             console.log("App Initialized Successfully.");
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>