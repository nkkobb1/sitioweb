<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enciclopedia Shinobi: Personajes de Naruto</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes temáticas (Ejemplo: Bangers o similar para títulos, Open Sans para cuerpo) -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Naruto --- */
        :root {
            --color-primary: #FF8C00; /* Naranja Naruto */
            --color-secondary: #2c3e50; /* Azul Ninja Oscuro */
            --color-background: #f5f1e8; /* Beige Pergamino Claro */
            --color-text: #34495e; /* Gris Azulado Oscuro */
            --color-text-muted: #7f8c8d; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco para Modal */
            --color-border: #bdc3c7; /* Gris Claro para Bordes */
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 6px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Open Sans', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; }
        /* Usar fuente temática para el logo/título principal */
        h1.logo, h1.page-title { font-family: 'Bangers', cursive; font-weight: normal; color: var(--color-primary); letter-spacing: 1.5px; text-shadow: 1px 1px 0px var(--color-secondary); }
        h2.section-title, #modal-title { font-family: 'Open Sans', sans-serif; font-weight: 700; }
        h2.section-title { color: var(--color-secondary); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; }
        #modal-title { color: var(--color-secondary); }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.25rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.25rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 700; color: var(--color-secondary); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-family: 'Open Sans', sans-serif; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #fff8f0; /* Naranja muy claro */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-secondary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Open Sans', sans-serif; font-weight: bold; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-transform: uppercase; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background-color: #34495e; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #95a5a6; color: #ecf0f1; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(44, 62, 80, 0.85); /* Overlay azul oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 2rem 2.5rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 350px; /* Altura mínima para pantalla de carga */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: #bdc3c7; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.6rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 10; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-modal-bg); transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }
        #modal-content {
            line-height: 1.7;
            color: var(--color-text);
            white-space: normal;
            overflow-y: auto;
            padding: 0 10px 1.5rem 10px; /* Padding inferior para espacio */
            flex-grow: 1;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) #ecf0f1; /* Scrollbar temático */
        }
        #modal-content::-webkit-scrollbar { width: 10px; }
        #modal-content::-webkit-scrollbar-track { background: #ecf0f1; border-radius: var(--border-radius); }
        #modal-content::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid #ecf0f1; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-secondary); font-weight: bold; }
        #modal-content em { color: var(--color-primary); font-style: italic; font-weight: bold; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Open Sans', sans-serif; font-weight: 700; margin-top: 2em; margin-bottom: 1em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; }
        #modal-content h1 { font-size: 1.5em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        /* Estilo para la imagen insertada al final del contenido */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); }
        /* Estilo para el placeholder/spinner de la imagen final */
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.75rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; /* Ajustar según el icono */ }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 6px solid #bdc3c7; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-secondary); font-size: 1.3rem; font-family: 'Open Sans'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: #fbeae5; /* Naranja muy pálido */ color: #c0392b; /* Rojo oscuro */ padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-primary); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: bold; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex justify-center items-center">
             <div class="flex items-center text-center">
                  <!-- Podría usarse un ícono de hoja de Konoha si se encuentra uno adecuado, o kunai/shuriken -->
                 <i class="fas fa-scroll text-yellow-600 mr-3 text-2xl"></i>
                 <h1 class="logo text-3xl sm:text-4xl">
                     Enciclopedia Shinobi
                 </h1>
                 <i class="fas fa-user-ninja text-blue-800 ml-3 text-2xl"></i>
             </div>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Descubre el Mundo Ninja</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto">Explora las biografías, habilidades y legados de los personajes más emblemáticos del universo Naruto. ¡Selecciona un ninja o concepto para comenzar tu misión!</p>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-users text-orange-500 mr-2"></i> <!-- Icono grupo -->
                 Personajes y Conceptos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg">Consultando los archivos de Konoha...</p>
             </div>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Invocar Más Shinobi
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Analizando datos Shinobi...</p>
             </div>

             <!-- Content Area -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4 text-center flex-shrink-0"></h2>
                 <!-- Text Content (Scrollable) - La imagen se añadirá aquí al final -->
                 <div id="modal-content" class="text-base md:text-lg">
                     <!-- Explanation text (HTML) goes here -->
                     <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                 </div>
                 <!-- NO HAY CONTENEDOR DE IMAGEN SEPARADO AQUÍ -->
                  <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
          </div>
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-600 py-6 mt-12 border-t border-gray-300">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Análisis de personajes generados por IA con fines informativos y de entretenimiento para fans de Naruto.</p>
              <p class="mt-1">Basado en el manga y anime original de Masashi Kishimoto.</p>
              <p class="mt-2">© 2025 Enciclopedia Shinobi</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
             // Equipo 7 (Principal)
            "Naruto Uzumaki", "Sasuke Uchiha", "Sakura Haruno", "Kakashi Hatake", "Sai", "Yamato (Tenzo)",
            // Konoha 11/12 y Senseis
            "Shikamaru Nara", "Choji Akimichi", "Ino Yamanaka", "Asuma Sarutobi", "Kiba Inuzuka", "Akamaru", "Shino Aburame", "Hinata Hyuga", "Kurenai Yuhi", "Rock Lee", "Neji Hyuga", "Tenten", "Might Guy (Maito Gai)",
            // Hokages
            "Hashirama Senju (Primer Hokage)", "Tobirama Senju (Segundo Hokage)", "Hiruzen Sarutobi (Tercer Hokage)", "Minato Namikaze (Cuarto Hokage)", "Tsunade Senju (Quinta Hokage)", "Danzo Shimura (Sexto Hokage Candidato/Interino)", "Kakashi Hatake (Sexto Hokage)", "Naruto Uzumaki (Séptimo Hokage)",
            // Sannin Legendarios
            "Jiraiya", "Orochimaru", "Tsunade Senju",
            // Akatsuki
            "Pain (Yahiko/Camino Deva)", "Nagato Uzumaki", "Konan", "Itachi Uchiha", "Kisame Hoshigaki", "Deidara", "Sasori", "Hidan", "Kakuzu", "Zetsu (Negro y Blanco)", "Tobi (Obito Uchiha)",
            // Personajes de Konoha (Apoyo/Importantes)
            "Iruka Umino", "Konohamaru Sarutobi", "Moegi Kazamatsuri", "Udon Ise", "Ebisu", "Shizune", "Anko Mitarashi", "Ibiki Morino", "Genma Shiranui", "Raido Namiashi", "Aoba Yamashiro", "Hayate Gekko", "Kotetsu Hagane", "Izumo Kamizuki", "Teuchi (Ichiraku Ramen)", "Ayame (Ichiraku Ramen)", "Kushina Uzumaki", "Fugaku Uchiha", "Mikoto Uchiha", "Hiashi Hyuga", "Hizashi Hyuga", "Hanabi Hyuga", "Shikaku Nara", "Yoshino Nara", "Inoichi Yamanaka", "Choza Akimichi", "Tsume Inuzuka", "Hana Inuzuka", "Shibi Aburame", "Mebuki Haruno", "Kizashi Haruno",
            // Raíz (Ne)
            "Danzo Shimura", "Sai", "Fu Yamanaka", "Torune Aburame", "Shin Uchiha (Concepto/Clon)",
            // Personajes de Sunagakure
            "Gaara (Quinto Kazekage)", "Kankuro", "Temari", "Rasa (Cuarto Kazekage)", "Karura", "Chiyo", "Ebizo", "Baki", "Yashamaru", "Matsuri", "Sari",
            // Personajes de Kirigakure
            "Mei Terumi (Quinta Mizukage)", "Zabuza Momochi", "Haku Yuki", "Chojuro (Sexto Mizukage)", "Ao", "Yagura Karatachi (Cuarto Mizukage/Jinchuriki)", "Utakata (Jinchuriki)", "Suigetsu Hozuki", "Mangetsu Hozuki", "Jinin Akebino", "Kushimaru Kuriarare", "Jinpachi Munashi", "Ameyuri Ringo", "Fuguki Suikazan",
            // Personajes de Iwagakure
            "Onoki (Tercer Tsuchikage)", "Kurotsuchi (Cuarta Tsuchikage)", "Akatsuchi", "Kitsuchi", "Roshi (Jinchuriki)", "Han (Jinchuriki)", "Gari", "Muu (Segundo Tsuchikage)", "Ishikawa (Primer Tsuchikage)",
            // Personajes de Kumogakure
            "A (Cuarto Raikage)", "Killer B (Kirabi)", "Darui (Quinto Raikage)", "C (Shi)", "Samui", "Karui Akimichi", "Omoi", "Yugito Nii (Jinchuriki)", "A (Tercer Raikage)", "Blue B (Fukai - Anterior Jinchuriki de Gyuki)", "Dodai", "Mabui",
            // Personajes de Otogakure (Sonido)
            "Orochimaru", "Kabuto Yakushi", "Kimimaro Kaguya", "Sakon y Ukon", "Tayuya", "Kidomaru", "Jirobo", "Dosu Kinuta", "Zaku Abumi", "Kin Tsuchi", "Guren (Anime)",
            // Clan Otsutsuki y Relacionados
            "Kaguya Otsutsuki", "Hagoromo Otsutsuki (Sabio de los Seis Caminos)", "Hamura Otsutsuki", "Indra Otsutsuki", "Asura Otsutsuki", "Momoshiki Otsutsuki", "Kinshiki Otsutsuki", "Urashiki Otsutsuki (Anime)", "Isshiki Otsutsuki", "Zetsu Negro",
            // Antagonistas Principales / Figuras Clave
            "Madara Uchiha", "Obito Uchiha", "Kabuto Yakushi (Modo Sabio)", "Pain/Nagato", "Danzo Shimura", "Orochimaru",
            // Jinchuriki (Además de los ya mencionados)
            "Fu (Jinchuriki de Chomei - Takigakure)", "Rin Nohara (Brevemente Jinchuriki de Isobu)", "Bunpuku (Anterior Jinchuriki de Shukaku)",
            // Bestias con Cola (Bijuu)
            "Shukaku (Una Cola)", "Matatabi (Dos Colas)", "Isobu (Tres Colas)", "Son Goku (Cuatro Colas)", "Kokuo (Cinco Colas)", "Saiken (Seis Colas)", "Chomei (Siete Colas)", "Gyuki (Ocho Colas)", "Kurama (Nueve Colas)", "Diez Colas (Juubi)", "Gedo Mazo (Estatua Demoníaca del Camino Exterior)",
            // Invocaciones Notables (Kuchiyose)
            "Gamabunta", "Gamakichi", "Gamatatsu", "Gerotora (Gama Tora)", "Fukasaku (Pa)", "Shima (Ma)", "Katsuyu", "Manda", "Aoda (Serpiente de Sasuke)", "Enma (Rey Mono)", "Pakkun", "Bull (Perro de Kakashi)", "Guruko (Perro de Kakashi)", "Shiba (Perro de Kakashi)", "Bisuke (Perro de Kakashi)", "Akino (Perro de Kakashi)", "Uhei (Perro de Kakashi)", "Urumi (Perro de Kakashi)", "Baku (Invocación de Danzo)", "Ningame (Tortuga de Guy)", "Kamaitachi (Temari - Comadreja)", "Iruka (Invocación de Ibiki - Gato?)", // Aclarar esta última
            // Equipo Taka / Hebi
            "Sasuke Uchiha", "Suigetsu Hozuki", "Karin Uzumaki", "Jugo",
            // Personajes Secundarios / Menores Relevantes
            "Nawaki Senju", "Dan Kato", "Mito Uzumaki", "Biwako Sarutobi (Esposa del Tercero)", "Nonou Yakushi", "Urushi", "Gato (Empresario)", "Tazuna (Constructor de Puentes)", "Inari", "Kaiza", "Waraji", "Zori", "Giichi", "Shibuki (Líder de Takigakure)", "Ajisai (Camino Animal de Pain)", "Fugai (Monje)", "Chiriku", "Kitane", "Nauma", "Seito", "Tou", "Kazuma", "Sora (Anime)",
            // Clanes Importantes
            "Clan Uchiha", "Clan Senju", "Clan Hyuga (Rama Principal y Secundaria)", "Clan Uzumaki", "Clan Nara", "Clan Yamanaka", "Clan Akimichi", "Clan Aburame", "Clan Inuzuka", "Clan Sarutobi", "Clan Kaguya", "Clan Yuki", "Clan Hozuki",
            // Conceptos / Técnicas / Habilidades Clave
            "Sharingan (Niveles 1, 2, 3)", "Mangekyo Sharingan", "Mangekyo Sharingan Eterno", "Byakugan", "Tenseigan (Película)", "Rinnegan", "Rinne Sharingan", "Modo Sabio (Sapos, Serpientes, Hashirama)", "Modo Sabio de los Seis Caminos", "Chakra de las Bestias con Cola", "Jinchuriki Perfecto", "Rasengan (y variantes)", "Chidori (Raikiri y variantes)", "Susanoo (Diferentes etapas/usuarios)", "Amaterasu", "Tsukuyomi", "Kotoamatsukami", "Izanagi", "Izanami", "Kamui (Obito/Kakashi)", "Shinra Tensei (Empujón Divino)", "Bansho Ten'in (Atracción Universal)", "Chibaku Tensei (Devastación Planetaria)", "Gedo: Rinne Tensei no Jutsu (Samsara Celestial)", "Hiraishin no Jutsu (Dios del Trueno Volador)", "Edo Tensei (Invocación: Reencarnación del Mundo Impuro)", "Sello Maldito del Cielo/Tierra (Orochimaru)", "Fuerza de un Centenar (Byakugo no In - Tsunade/Sakura)", "Ocho Puertas Internas (Hachimon Tonko)", "Rasenshuriken", "Kirin", "Jinton (Elemento Polvo)", "Mokuton (Elemento Madera)", "Hyoton (Elemento Hielo)", "Shoton (Elemento Cristal - Anime)", "Yoton (Elemento Lava)", "Futton (Elemento Vapor)", "Kekkei Genkai", "Kekkei Tota", "Kekkei Mora", "Ninjutsu", "Taijutsu", "Genjutsu", "Fuinjutsu (Técnicas de Sellado)", "Kinjutsu (Técnicas Prohibidas)", "Senjutsu (Técnicas del Sabio)", "Dojutsu (Técnicas Oculares)", "Las Ocho Trigramas Sesenta y Cuatro Palmas (Hakke Rokujūyon Shō)", "Puño Suave (Juken)", "Rotación Celestial de los Ocho Trigramas (Hakkesho Kaiten)", "Kagemane no Jutsu (Posesión de Sombra)", "Nikudan Sensha (Tanque de Bala Humana)", "Shintenshin no Jutsu (Transferencia de Mentes)", "Gatsuga (Colmillo sobre Colmillo)", "Kikaichu no Jutsu (Insectos)", "Konoha Senpu (Remolino de la Hoja)", "Omote Renge (Loto Primario)", "Ura Renge (Loto Inverso)", "Asa Kujaku (Pavo Real Matutino)", "Hirudora (Tigre del Mediodía)", "Sekizo (Elefante del Ocaso)", "Yagai (Bestia Nocturna / Tipo Nocturno)", "Suiton: Suiryudan no Jutsu (Elemento Agua: Dragón de Agua)", "Katon: Gokakyu no Jutsu (Elemento Fuego: Gran Bola de Fuego)", "Doton: Doryuheki (Elemento Tierra: Muro de Tierra)", "Raiton: Gian (Elemento Rayo: Falsa Oscuridad)", "Futon: Daitoppa (Elemento Viento: Gran Fisura)",
            // Organizaciones / Grupos
            "Akatsuki", "Equipo 7 (Varias formaciones)", "Equipo 8", "Equipo 10", "Equipo Guy", "Sannin Legendarios", "Doce Guardianes Ninja", "Raíz (Ne)", "ANBU", "Policía Militar de Konoha", "Equipo Taka (Hebi)", "Los Siete Espadachines Ninja de la Niebla",
            // Conceptos Generales / Lore
            "Voluntad de Fuego", "Maldición del Odio (Uchiha)", "Sistema de Rangos Ninja (Genin, Chunin, Jonin, Kage)", "Exámenes Chunin", "Las Cinco Grandes Naciones Shinobi", "Aldeas Ocultas Menores (Lluvia, Hierba, Cascada, Sonido)", "Guerras Mundiales Shinobi (Primera, Segunda, Tercera, Cuarta)", "Tratado de Paz", "Samurai (País del Hierro)", "Mifune", "Chakra (Naturalezas, Manipulación)", "Sellos Manuales (In)", "Kunai", "Shuriken", "Papel Bomba (Kibaku Fuda)", "Pergaminos (Makimono)",
            // Boruto Era (Pocos, para completar si falta mucho)
            "Boruto Uzumaki", "Sarada Uchiha", "Mitsuki", "Kawaki", "Jigen (Isshiki Otsutsuki)", "Code", "Delta", "Kashin Koji"
            // Añadir más si es necesario
        ];

        const narutoThemes = [
            "Personajes de Konoha", "Miembros de Akatsuki", "Los Kages de las 5 Grandes Naciones", "Jinchuriki y Bijuu", "Clan Uchiha", "Clan Hyuga", "Clan Senju", "Clan Uzumaki", "Sannin Legendarios", "Equipos Ninja (Equipo 7, 10, 8, Guy)", "Espadachines de la Niebla", "Personajes de Sunagakure", "Personajes de Kirigakure", "Personajes de Iwagakure", "Personajes de Kumogakure", "Antagonistas Principales", "Invocaciones (Kuchiyose)", "Técnicas Oculares (Dojutsu)", "Kekkei Genkai Notables", "Conceptos del Mundo Shinobi", "Maestros y Alumnos", "Miembros de ANBU/Raíz"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un erudito del universo Naruto, un experto analista de personajes y lore. Tu misión es proporcionar un análisis exhaustivo y detallado del personaje, concepto o técnica del mundo de Naruto solicitado. Describe su historia, personalidad, desarrollo, habilidades clave (jutsu, kekkei genkai, taijutsu, etc.), relaciones importantes, momentos cruciales en la trama y su significado o legado general en la serie. Si es un concepto (clan, técnica, evento), explícalo en profundidad, incluyendo su origen, funcionamiento, usuarios notables e impacto. Usa un lenguaje claro, preciso y apasionado, como si estuvieras escribiendo para una enciclopedia definitiva de Naruto. El objetivo es un texto de aproximadamente 1200-1300 palabras. Basa tu análisis únicamente en el siguiente término:",
            timeoutSeconds: 150
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia de Naruto. Genera exactamente 15 nombres de personajes importantes (de cualquier aldea o afiliación), clanes, técnicas icónicas (jutsu) o conceptos clave del universo Naruto/Shippuden. Devuelve *solo* la lista de nombres/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ========== (Sin cambios estructurales)
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Contenedor del texto y la imagen final
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');

        // ========== API FUNCTIONS ========== (Sin cambios lógicos, solo prompt de imagen)
        async function fetchTextFromApi(prompt, config) { /* ... Mismo código ... */
             const encodedPrompt = encodeURIComponent(prompt);
             const encodedSystem = encodeURIComponent(config.systemPrompt);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}): ${url.substring(0, 200)}...`);
             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`Error HTTP ${response.status}.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la API estaba vacía.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La solicitud a la API tardó demasiado (>${config.timeoutSeconds}s). Intente de nuevo.`);
                 throw new Error(`Error de comunicación con la API: ${error.message}`);
             }
        }
        async function fetchExplanationText(conceptTitle) { /* ... Mismo código ... */
            const text = await fetchTextFromApi(conceptTitle, textApiConfig);
             if (text.trim().length < 800 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("no puedo generar") || text.toLowerCase().includes("unable to generate") || text.toLowerCase().includes("incapaz de")) {
                  throw new Error("La IA no pudo generar un análisis adecuado o suficientemente detallado para este término.");
              }
            return text;
        }
        async function fetchGeneratedTitles() { /* ... Mismo código ... */
             const randomTheme = getRandomElement(narutoThemes) || "personajes clave de Naruto";
             const specificPrompt = `Genera 15 nombres de personajes, clanes, jutsus o conceptos relevantes de Naruto sobre ${randomTheme}`;
             console.log("Generating titles with prompt:", specificPrompt);
             const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
             const text = await fetchTextFromApi(specificPrompt, configForThisRequest);
             const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 100); // Ajustar longitud mínima/máxima si es necesario
             if (titles.length < 5) throw new Error("No se pudieron generar suficientes ideas.");
             return titles.slice(0, 15);
         }
        function createPollinationsImageUrl(promptText, options = {}) { // Prompt adaptado a NARUTO
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Konoha ninja";
            // Prompt ENFOCADO en estilo anime, personaje/concepto, sin texto.
            const enhancedPrompt = `Dynamic anime style character concept art of '${safePromptText}' from Naruto universe. Focus on iconic pose, key features, or representative jutsu effect. Cel shading, vibrant colors typical of the anime. Avoid text or logos.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            // NEGATIVE PROMPT: Evitar realismo, texto, etc.
            const negativePrompt = "photorealistic, realistic, 3D render, real life person, text, words, title, labels, signature, watermark, multiple characters, multiple panels, collage, UI, menu, buttons, photograph, screenshot";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... Mismo código ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); // Keep just in case
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, '<br>');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Sin cambios lógicos)
        function showModal() { /* ... Mismo código ... */ if(!storyModal) return; storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { /* ... Mismo código ... */
            if(!storyModal || !modalContent) return;
            storyModal.classList.remove('active');
            document.body.style.overflow = '';
            modalContent.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() { /* ... Mismo código ... */
             if (!modalLoadingIndicator || !modalStoryContentArea || !modalError || !modalTitle || !modalContent) return;
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = ''; // Clear previous text and image
             modalErrorMessage.textContent = '';
        }

        // ========== UI & EVENT HANDLERS ========== (Sin cambios lógicos, solo textos temáticos)
        function getRandomElement(arr) { /* ... Mismo código ... */ if (!arr || arr.length === 0) return null; return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... Mismo código ... */ let ci = array.length, ri; while (ci > 0) { ri = Math.floor(Math.random() * ci); ci--; [array[ci], array[ri]] = [array[ri], array[ci]]; } return array; }
        function createTitleItem(title) { /* ... Mismo código ... */ const div = document.createElement('div'); div.className = 'title-item'; div.textContent = title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) { /* ... Mismo código ... */
             if (!titleListContainer || !titlesLoading) return;
             const shuffledTitles = shuffleArray([...titles]);
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (shuffledTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay datos Shinobi disponibles.</p>'; return; } // Thematic
             shuffledTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... Mismo código ... */ if (!titleListContainer || !newTitles || newTitles.length === 0) return; newTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title))); }

        // *** MODIFIED: handleTitleClick (Misma lógica de imagen que versión anterior) ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            modalContent.innerHTML = ''; // Clear previous content
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                // 1. Fetch and format text
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // 2. Stop loading indicator, display text FIRST
                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation; // Inject text content
                modalStoryContentArea.classList.remove('content-hidden');

                 // 3. *** RESET SCROLL *** after text content is in and visible
                modalContent.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // 4. Prepare and append image placeholder/spinner WITHIN #modal-content
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-user-ninja placeholder-icon"></i> <!-- Icono Ninja -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización ninja...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // 5. Create and append the actual image element (starts loading)
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `
                        <i class="fas fa-eye-slash placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">Fallo al cargar la visualización.</p>
                    `;
                };

                // Get URL and set src AFTER attaching handlers
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle placeholder-icon"></i>
                        <p style="font-size: 0.8em; margin-top: 0.5rem;">Error al generar URL de imagen.</p>
                    `;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = `Error: ${error.message}`;
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
            }
        }

        async function handleGenerateMoreTitles() { /* ... Mismo código, textos temáticos ... */
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando...'; // Thematic text
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) {
                     generateMoreContainer.style.display = 'none';
                     appendTitles(newTitles);
                     if (titleListContainer.parentNode) {
                         titleListContainer.parentNode.appendChild(generateMoreContainer);
                     }
                     generateMoreContainer.style.display = 'block';
                 } else {
                     alert("No se encontraron más datos Shinobi en este momento."); // Thematic text
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al invocar Shinobi: ${error.message}`); // Thematic text
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Invocar Más Shinobi'; // Thematic text
             }
         }


        // ========== INITIALIZATION ========== (Sin cambios lógicos)
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading) { console.error("Init fail."); document.body.innerHTML = '<p style="color: red; font-size: 2em; text-align: center; padding-top: 5em;">¡Error! Fallo al cargar la base de datos Shinobi.</p>'; return; } // Thematic error
            modalCloseBtn.addEventListener('click', hideModal);
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            displayTitles(predefinedTitles);
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>