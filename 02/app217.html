<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reino de Cuentos - Historias de Princesas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Elegant & Readable Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Nunito+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Historias de Princesas --- */
        :root {
            --color-primary: #dda0dd; /* Plum / Light Purple */
            --color-secondary: #ffb6c1; /* Light Pink */
            --color-tertiary: #f0e68c; /* Khaki / Soft Gold */
            --color-background: #fffafa; /* Snow / Very Light Pinkish White */
            --color-text: #4b0082; /* Indigo / Dark Purple */
            --color-text-muted: #778899; /* Light Slate Gray */
            --color-modal-bg: #fdf5e6; /* Old Lace / Creamy White */
            --color-border: #e6e6fa; /* Lavender */
            --color-error-bg: #ffe4e1; /* Misty Rose */
            --color-error-text: #8b0000; /* Dark Red */
            --color-error-border: #ffb6c1; /* Light Pink Border for Error */

            --shadow-sm: 0 1px 3px 0 rgba(221, 160, 221, 0.1), 0 1px 2px 0 rgba(221, 160, 221, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(221, 160, 221, 0.15), 0 2px 4px -1px rgba(221, 160, 221, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(221, 160, 221, 0.2), 0 4px 6px -2px rgba(221, 160, 221, 0.1);
            --border-radius: 8px; /* Softer corners */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Nunito Sans', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Cpath fill='%23f0e68c' fill-opacity='0.1' d='M10 0l2.166 6.618h6.97l-5.65 4.11 2.165 6.618L10 13.236l-5.65 4.11 2.166-6.618L.864 6.618h6.97z'/%3E%3C/svg%3E"); /* Subtle star background */ }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(255, 250, 250, 0.85); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: white; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Nunito Sans'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(221, 160, 221, 0.3); outline: none; background-color: #fffafa; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: white; padding: 1.4rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-family: 'Nunito Sans'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #fffafa; border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; text-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(75, 0, 130, 0.85); /* Indigo overlay */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); box-shadow: 0 0 10px var(--color-primary); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Main content area (Text + Image) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-modal-bg); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 600; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px dashed var(--color-border); padding-bottom: 0.6em; font-weight: 700; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        /* Image styling */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 2.5rem auto 1rem auto; border: 3px solid var(--color-tertiary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid var(--color-border); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-secondary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(255, 250, 250, 0.6); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; box-shadow: var(--shadow-sm); }
        .user-message { background-color: var(--color-secondary); color: var(--color-text); margin-left: auto; text-align: right; font-weight: 600; }
        .ai-message { background-color: white; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; border: 1px solid var(--color-border); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Nunito Sans'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(221, 160, 221, 0.3); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #c71585; /* MediumVioletRed */}
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator with Mini-Game */
        #modal-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(253, 245, 230, 0.98); /* Creamy overlay */ display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); text-align: center; padding: 2rem; }
        #loading-message { font-family: 'Merriweather', serif; font-weight: 700; color: var(--color-text); font-size: 1.5rem; margin-bottom: 1.5rem; text-shadow: 1px 1px var(--color-border); }
        /* Mini-game Area */
        #mini-game-area { width: 90%; max-width: 400px; height: 150px; background-color: rgba(255, 255, 255, 0.5); border: 1px dashed var(--color-primary); border-radius: var(--border-radius); position: relative; overflow: hidden; margin-bottom: 1rem; cursor: crosshair; /* Indicate clickable area */ }
        .sparkle { position: absolute; width: 20px; height: 20px; background-color: var(--color-tertiary); border-radius: 50%; cursor: pointer; transition: transform 0.1s ease, opacity 0.5s ease; opacity: 0; animation: sparkle-pulse 1.5s infinite ease-in-out, fade-in 0.3s forwards; box-shadow: 0 0 8px var(--color-tertiary), 0 0 12px var(--color-primary); }
        .sparkle:active { transform: scale(0.8); }
        #game-score { font-size: 1.1rem; font-weight: 600; color: var(--color-text); }
        @keyframes sparkle-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        /* Hide game elements when not loading */
        #mini-game-area.hidden-game, #game-score.hidden-game { display: none; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Nunito Sans'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(75, 0, 130, 0.95); /* Indigo overlay */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 4px solid var(--color-tertiary); box-shadow: var(--shadow-lg); border-radius: 4px; }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: white; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-crown mr-3 text-yellow-500"></i> <!-- Icono corona -->
                     Reino de Cuentos
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">~ Historias de Princesas ~</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Descubre Mágicas Aventuras</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Abre el libro encantado y explora historias de valor, magia y realeza. Elige un cuento o busca tu princesa favorita.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar princesa, cuento o tema...">
             <i class="fas fa-search fa-book-open"></i> <!-- Icono libro abierto/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll text-purple-500 mr-2"></i> <!-- Icono pergamino -->
                 Índice de Historias
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Desenrollando el pergamino de cuentos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">~ Ningún cuento encontrado con esas palabras mágicas ~</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Invocar Más Historias (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Mini-Game -->
             <div id="modal-loading">
                 <p id="loading-message">Tejiendo la historia...</p>
                 <div id="mini-game-area" class="hidden-game">
                     <!-- Sparkles will appear here -->
                 </div>
                 <p id="game-score" class="hidden-game">Chispas atrapadas: 0</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <h4 class="text-center text-sm font-semibold text-gray-600 mb-2 font-sans">Pregúntale al Espejo Mágico sobre esta historia:</h4>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando oráculo...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Escribe tu pregunta aquí...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Cuento">
      </div>

      <!-- Footer -->
      <footer class="bg-pink-50 text-gray-600 py-6 mt-12 border-t border-pink-100 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias generadas por IA, inspiradas en cuentos de hadas y la imaginación.</p>
              <p class="mt-1">Cada aventura es única. ¡Disfruta la magia!</p>
              <p class="mt-2">© Año Mágico - Reino de Cuentos</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Princesas Clásicas y Conocidas
            "Cenicienta (La Zapatilla de Cristal)", "Blancanieves (Los Siete Enanitos)", "La Bella Durmiente (Aurora)", "La Sirenita (Ariel)", "Bella (La Bella y la Bestia)", "Jasmín (Aladdín)", "Pocahontas (Colores en el Viento)", "Mulan (La Guerrera Legendaria)", "Rapunzel (Enredados)", "Tiana (La Princesa y el Sapo)", "Mérida (Valiente)", "Elsa (Frozen - Reina, pero arquetipo princesa)", "Anna (Frozen)", "Moana/Vaiana (La Exploradora del Océano)", "Fiona (Shrek - Princesa Ogra)", "Giselle (Encantada)", "Anastasia (Princesa Perdida)", "Odette (La Princesa Cisne)", "Thumbelina/Pulgarcita", "La Princesa Kaguya (Cuento japonés)",
            // Princesas de Cuentos Menos Comunes
            "La Princesa y el Guisante", "Las Doce Princesas Bailarinas", "Piel de Asno", "El Príncipe Rana (La Princesa)", "El Rey Pico de Tordo", "La Reina de las Nieves (Gerda como heroína)", "Los Cisnes Salvajes (Elisa)", "La Pastora y el Deshollinador", "La Princesa que no podía Reír", "El Gato con Botas (La Princesa del Reino)", "La Hija del Rey del Mar (Andersen)", "Riquete el del Copete (La Princesa sabia y la hermosa)", "El Pájaro de Oro (La Princesa del Castillo Dorado)", "La Princesa Melisenda", "El Agua de la Vida (La Princesa Enferma)", "La Princesa del Jardín Flotante", "Historia del Príncipe Ahmed (Princesa Pari Banu)", "La Princesa de Babilonia (Voltaire)", "Vasilisa la Hermosa (Folclore ruso)", "Scheherezade (Las Mil y Una Noches)",
            // Arquetipos y Tipos de Princesas
            "La Princesa Guerrera", "La Princesa Perdida / Heredera Oculta", "La Princesa Erudita / Científica", "La Princesa Diplomática / Pacificadora", "La Princesa Rebelde", "La Princesa Hechicera / Mágica", "La Princesa Encantada / Maldita", "La Princesa Animal (Transformada)", "La Princesa Celestial / Estelar", "La Princesa del Reino Submarino", "La Princesa del Bosque Encantado", "La Princesa Gótica / Oscura", "La Princesa Aventurera / Exploradora", "La Princesa Artista / Música", "La Princesa Campesina (Nobleza Oculta)", "La Princesa Prometida (Matrimonio Arreglado)", "La Princesa que Salva al Príncipe", "La Princesa Anciana / Reina Madre Sabia", "La Princesa Mecánica / Artificial", "La Princesa de un Reino Caído",
            // Elementos y Temas de Cuentos de Princesas
            "El Baile Real / El Gran Salón", "El Objeto Mágico (Varita, Espejo, Lámpara)", "La Madrastra Malvada / La Bruja", "El Hada Madrina / El Mentor Mágico", "El Compañero Animal Leal", "El Bosque Prohibido / El Lugar Peligroso", "El Castillo Encantado / La Torre Solitaria", "La Maldición / El Hechizo", "La Prueba / La Tarea Imposible", "El Beso de Amor Verdadero", "El Disfraz / La Identidad Secreta", "La Profecía / El Destino", "El Sacrificio por Amor / Reino", "La Transformación (Física o Emocional)", "El Viaje / La Búsqueda", "La Rivalidad entre Hermanas", "El Poder de la Música / El Canto", "La Lucha contra la Oscuridad / El Mal", "El Descubrimiento de la Verdadera Familia", "La Coronación / La Asunción al Trono",
            // Prompts de Historias Específicas
            "Una princesa que habla con los dragones", "La historia de la princesa pirata", "La princesa que inventó una máquina voladora", "El diario secreto de una princesa cisne", "Una princesa atrapada en un videojuego", "La princesa que gobernó un reino de robots", "El misterio de la corona desaparecida", "La princesa que cambió su destino con un deseo", "Una princesa que aprendió magia de las estrellas", "La amistad entre una princesa y un fantasma", "La princesa que descubrió una ciudad perdida", "El viaje de la princesa a través del tiempo", "La princesa que domaba grifos", "Una princesa chef y su restaurante encantado", "La princesa que renunció al trono por la ciencia", "La biblioteca secreta de la princesa olvidada", "La princesa que pintaba sueños", "Una princesa detective en la corte real", "La princesa que se convirtió en caballero", "El último árbol mágico y la princesa guardiana",
             // Más y más... (se busca exhaustividad inicial)
            "La Princesa y el Unicornio de Cristal", "El Laberinto del Minotauro y la Princesa Ariadna (Mitología adaptada)", "La Princesa que tejía la luz de luna", "El secreto del Jardín Invernal de la Princesa", "La Princesa que montaba las águilas gigantes", "El Campeonato de Justas de la Princesa Leonor", "La Princesa que negoció la paz con los gigantes de hielo", "El autómata compañero de la Princesa Aiko", "La Princesa que estudiaba las runas antiguas", "El Festival de las Linternas Flotantes y la Princesa Mei", "La Princesa y el Kraken amistoso", "El mapa estelar heredado por la Princesa Lyra", "La Princesa que cultivaba plantas que curaban", "El Golem de Arcilla protector de la Princesa Talia", "La Princesa que dirigía la orquesta del reino", "El intercambio de princesas entre reinos rivales", "La Princesa que descendió al inframundo", "El torneo de acertijos de la Princesa Sofía", "La Princesa que domaba las tormentas", "El espíritu del bosque que guiaba a la Princesa Elara",
            "La Princesa y el mercader de especias mágicas", "La Princesa que vivía en un faro", "El reloj de arena que controlaba el tiempo de la Princesa Chrona", "La Princesa y el circo ambulante", "La Princesa que esculpía con hielo", "La Princesa que se comunicaba con los árboles", "El Santuario de Mariposas de la Princesa Papilia", "La Princesa arqueóloga y la tumba del rey hechicero", "La Princesa que navegaba en un barco de cristal", "El secreto de la inmortalidad de la Princesa Amara", "La Princesa y el Fénix renacido", "La academia de magia para jóvenes princesas", "La Princesa que podía caminar sobre las nubes", "El orfanato dirigido por la Princesa Caridad", "La Princesa y el último grifo lunar", "La rebelión de los juguetes encantados liderada por la Princesa Clara", "La Princesa que componía canciones para calmar bestias", "La Princesa que diseñaba constelaciones", "El jardín secreto de la Princesa Flora", "La Princesa astrónoma y el cometa perdido"
             // ... continuar añadiendo hasta tener una lista muy robusta
        ];
        const princessThemes = [
            "princesas de cuentos clásicos", "heroínas de fantasía", "realeza y magia", "castillos encantados", "aventuras épicas", "historias de amor verdadero", "personajes femeninos fuertes", "folclore europeo", "mitología adaptada", "princesas guerreras", "princesas científicas", "reinos submarinos", "bosques mágicos", "animales compañeros", "objetos encantados", "maldiciones y hechizos", "bailes reales", "viajes y búsquedas", "identidades secretas", "cuentos de hadas modernos", "princesas rebeldes", "historias de valor", "amistad inesperada", "descubrimiento personal"
        ];
        const textApiConfig = {
            model: "mistral", // O un modelo más potente si se prefiere para historias largas
            systemPrompt: "Eres un maestro narrador y experto en folclore y cuentos de hadas. Crea una historia cautivadora e imaginativa (aproximadamente 1200-1300 palabras) basada en la siguiente princesa, tema o concepto. Enfócate en el desarrollo del personaje, la descripción del escenario, la progresión de la trama y una conclusión satisfactoria (aunque no siempre sea un 'vivieron felices para siempre'). Encarna el estilo de los cuentos de hadas clásicos o modernos según corresponda. El tema central es:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny", // Modelo rápido para chat
            systemPrompt: "Actúa como un espejo mágico o un sabio libro de cuentos, conocedor únicamente de la historia específica que se acaba de contar sobre '[CURRENT_TITLE]'. Responde preguntas de seguimiento sobre los personajes, la trama, el escenario o los temas presentados en esa narrativa particular. Sé conciso, mágico y estrictamente relevante al cuento actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un bardo real o un hada madrina generando ideas. Genera exactamente 40 títulos diversos, conceptos o puntos de partida para historias relacionadas con princesas, cuentos de hadas, realeza y magia, adecuados para generar cuentos únicos. Incluye nombres de personajes, arquetipos, ganchos de trama y temas variados. Devuelve *solo* la lista de ítems, uno por línea, sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentar un poco por si pide más tokens
        };

        // ========== DOM ELEMENTS ==========
        // ... (igual que antes: searchInput, titleListContainer, etc.)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Mini-Game Elements
        const loadingMessage = document.getElementById('loading-message');
        const miniGameArea = document.getElementById('mini-game-area');
        const gameScoreDisplay = document.getElementById('game-score');


        // ========== State Variables ==========
        let currentStoryTitle = null;
        let miniGameInterval = null;
        let miniGameScore = 0;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `Eres un espejo mágico o un sabio libro de cuentos, conocedor únicamente de la historia específica que se acaba de contar sobre '${currentStoryTitle}'. Responde preguntas de seguimiento sobre los personajes, la trama, el escenario o los temas presentados en esa narrativa particular. Sé conciso, mágico y estrictamente relevante al cuento actual.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores de cuentos están muy ocupados ahora mismo. Por favor, inténtalo de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("El libro mágico devolvió páginas en blanco. Intenta pedir otra historia.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con el reino mágico tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o vuelve más tarde.`);
                 }
                 throw new Error(error.message || "Un hechizo inesperado impidió contactar al narrador.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentStoryTitle) throw new Error("Error interno: El espejo no sabe de qué cuento hablar."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(princessThemes) || "cuentos de princesas";
            // *** MODIFIED TO REQUEST 40 ***
            const specificPrompt = `Genera 40 títulos/conceptos sobre ${randomTheme}`;
            // Usa la función genérica fetchTextFromApi
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     // Expecting more titles now
                     if (titles.length < 20) throw new Error("El hada madrina no pudo conjurar suficientes ideas.");
                     return titles.slice(0, 40); // Return up to 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "fairytale princess illustration";
             const enhancedPrompt = `Illustrate the concept '${safePromptText}' in a beautiful fairytale style. Focus on atmosphere, character (if applicable), setting (castle, forest, magical realm). Use soft colors, painterly or illustrative style. Avoid text, logos, or photorealism. Evoke wonder and magic. Whimsical, enchanting.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, ugly, deformed, blurry, low quality, modern clothing, technology";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (copy from previous version) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState(); // Resets game too
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex'; // Show loading initially
             stopMiniGame(); // Make sure game is stopped
             miniGameArea.classList.add('hidden-game'); // Hide game elements
             gameScoreDisplay.classList.add('hidden-game');
             loadingMessage.textContent = "Tejiendo la historia..."; // Reset message

             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... (copy from previous version) ... */
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() { /* ... (copy from previous version) ... */
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios)
        function addChatMessage(message, sender) { /* ... (copy from previous version) ... */
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) { /* ... (copy from previous version) ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() { /* ... (copy from previous version) ... */
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Espejo Mágico dice: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== MINI-GAME FUNCTIONS ==========
        function startMiniGame() {
            console.log("Starting mini-game...");
            miniGameScore = 0;
            gameScoreDisplay.textContent = `Chispas atrapadas: ${miniGameScore}`;
            miniGameArea.innerHTML = ''; // Clear previous sparkles
            miniGameArea.classList.remove('hidden-game');
            gameScoreDisplay.classList.remove('hidden-game');

            // Spawn sparkles periodically
            miniGameInterval = setInterval(() => {
                if (!storyModal.classList.contains('active')) { // Stop if modal closed unexpectedly
                     stopMiniGame();
                     return;
                }
                createSparkle();
            }, 800); // Adjust spawn rate (milliseconds)
        }

        function stopMiniGame() {
            console.log("Stopping mini-game...");
            clearInterval(miniGameInterval);
            miniGameInterval = null;
            // Optionally hide game elements immediately
            // miniGameArea.classList.add('hidden-game');
            // gameScoreDisplay.classList.add('hidden-game');
        }

        function createSparkle() {
            if (!miniGameArea) return;
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';

            // Random position within the game area
            const maxX = miniGameArea.offsetWidth - 20; // 20 is sparkle width
            const maxY = miniGameArea.offsetHeight - 20; // 20 is sparkle height
            sparkle.style.left = `${Math.random() * maxX}px`;
            sparkle.style.top = `${Math.random() * maxY}px`;

            sparkle.addEventListener('click', () => {
                miniGameScore++;
                gameScoreDisplay.textContent = `Chispas atrapadas: ${miniGameScore}`;
                sparkle.remove();
                // Optional: Add a little visual feedback like a quick scale up/down
            });

            miniGameArea.appendChild(sparkle);

            // Remove sparkle after a short time if not clicked
            setTimeout(() => {
                if (sparkle) sparkle.remove();
            }, 1800); // Adjust lifetime (milliseconds) - should be longer than spawn rate
        }


        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">~ El libro de cuentos está vacío por ahora ~</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Appended ${addedCount} new titles.`);
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick to integrate mini-game ***
        async function handleTitleClick(title) {
            resetModalState(); // Resets everything, stops previous game if any
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title;
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');

            // *** START LOADING & GAME ***
            modalLoadingIndicator.style.display = 'flex';
            startMiniGame(); // Start the sparkle game

            try {
                // Fetch text (long operation)
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // *** STOP GAME, HIDE LOADING, SHOW CONTENT ***
                stopMiniGame();
                modalLoadingIndicator.style.display = 'none'; // Hide loading indicator AND game area implicitly if they are inside
                miniGameArea.classList.add('hidden-game');   // Explicitly hide game area
                gameScoreDisplay.classList.add('hidden-game'); // Explicitly hide score

                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Pintando la escena...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Create image element (fetch starts)
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-palette placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo pintar la escena.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                 // *** STOP GAME & HIDE LOADING ON ERROR ***
                 stopMiniGame();
                 modalLoadingIndicator.style.display = 'none';
                 miniGameArea.classList.add('hidden-game');
                 gameScoreDisplay.classList.add('hidden-game');

                 console.error("Failed display:", error);
                 modalErrorMessage.textContent = error.message || "Un duende travieso ha ocultado esta historia.";
                 modalError.classList.remove('content-hidden');
                 modalStoryContentArea.classList.remove('content-hidden');
                 modalContent.innerHTML = '';
                 chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles to fetch 40 ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando al Oráculo...';
             try {
                 // Fetching 40 titles now
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("El Oráculo está descansando, no hay más historias por ahora."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al invocar historias: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Update button text reflecting 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Invocar Más Historias (40)';
             }
         }

         // Search Filter Function (sin cambios, pero revisa normalize)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Add mini-game elements to the check
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !miniGameArea || !gameScoreDisplay || !loadingMessage) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: darkred; font-size: 1.5em; text-align: center; padding-top: 3em;">¡Oh no! El libro de cuentos mágico no se pudo abrir correctamente.</p>';
                return;
             }
            // Listeners (Modal, Generate More, Search, Chat, Fullscreen)
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            // Ensure game is hidden initially
            miniGameArea.classList.add('hidden-game');
            gameScoreDisplay.classList.add('hidden-game');

        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>