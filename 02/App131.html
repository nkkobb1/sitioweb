<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sabores de Latinoam√©rica - Gu√≠a Culinaria</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes C√°lidas y Legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Sabores de Latinoam√©rica --- */
        :root {
            --color-primary: #D32F2F; /* Rojo Piment√≥n Intenso */
            --color-secondary: #FFC107; /* Amarillo Ma√≠z Brillante */
            --color-tertiary: #4CAF50; /* Verde Cilantro Fresco */
            --color-background: #FFF8E1; /* Crema / Beige Claro (Papel Amate) */
            --color-text: #4E342E; /* Marr√≥n Caf√© Oscuro */
            --color-text-muted: #795548; /* Marr√≥n Medio */
            --color-modal-bg: #FFFFFF; /* Blanco Puro */
            --color-border: #D7CCC8; /* Borde Marr√≥n Claro / Gris√°ceo */
            --color-error-bg: #FFEBEE; /* Fondo error rosa muy p√°lido */
            --color-error-text: #B71C1C; /* Texto error rojo oscuro */
            --color-error-border: #FFCDD2; /* Borde error rosa claro */

            --shadow-sm: 0 1px 3px 0 rgba(78, 52, 46, 0.1), 0 1px 2px 0 rgba(78, 52, 46, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(78, 52, 46, 0.1), 0 2px 4px -1px rgba(78, 52, 46, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(78, 52, 46, 0.1), 0 4px 6px -2px rgba(78, 52, 46, 0.05);
            --border-radius: 8px; /* Bordes m√°s redondeados, org√°nicos */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); /* Blanco semi-transparente */ backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Montserrat'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.2); outline: none; background-color: #fff; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 500; color: var(--color-text); border: 1px solid var(--color-border); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px; font-family: 'Montserrat'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item i { color: var(--color-primary); margin-bottom: 0.4rem; font-size: 1.3rem; opacity: 0.7; transition: var(--transition-normal);}
        .title-item:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-primary); background-color: #fffbec; /* Amarillo muy claro */ border-left-color: var(--color-primary); }
        .title-item:hover i { color: var(--color-primary); opacity: 1; transform: scale(1.1);}
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), #e65100); /* Rojo a Naranja */ color: white; padding: 0.9rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, #e65100, var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; text-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(78, 52, 46, 0.85); /* Overlay Marr√≥n */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* M√°s altura para contenido y chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            border-top: 5px solid var(--color-primary);
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* √Årea de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 700; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.35em; }
        #modal-content h3 { font-size: 1.2em; color: #795548; /* Marr√≥n medio */ }
        #modal-content h4 { font-size: 1.1em; color: #A1887F; /* Marr√≥n claro */ border-bottom: none; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 3rem auto 1.5rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); border: 2px dashed var(--color-border); border-radius: var(--border-radius); background-color: #fafafa;}
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(121, 85, 72, 0.2); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 1rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-border); }

        /* Chat Section Styles */
        #chat-section { border-top: 2px solid var(--color-border); padding-top: 1rem; margin-top: 1.5rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fdfcf9; /* Casi blanco */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.55; font-size: 0.95rem; }
        .user-message { background-color: var(--color-secondary); color: var(--color-text); margin-left: auto; text-align: left; /* Alineaci√≥n izquierda dentro de la burbuja derecha */}
        .ai-message { background-color: #F1F8E9; /* Verde muy p√°lido */ color: var(--color-text); margin-right: auto; text-align: left; border: 1px solid #DCEDC8; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Montserrat'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #C62828; /* Rojo m√°s oscuro */ }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; color: var(--color-tertiary); }

        #modal-loading { text-align: center; padding: 4rem 1rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 248, 225, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 6px solid rgba(211, 47, 47, 0.2); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 2rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.4rem; font-family: 'Merriweather'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Montserrat'; }
        .error-msg i { margin-right: 0.8rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(78, 52, 46, 0.95); /* Overlay Marr√≥n Oscuro */ display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-secondary); box-shadow: var(--shadow-lg); border-radius: 4px; }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-secondary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: var(--color-text); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-utensils mr-3 text-red-700"></i> <!-- Icono cubiertos -->
                     Sabores de Latinoam√©rica
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wide">üå∂Ô∏è Gu√≠a Culinaria Interactiva üåΩ</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Un Viaje Gastron√≥mico</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre la riqueza y diversidad de los platos m√°s emblem√°ticos de Am√©rica Latina. ¬°Buen provecho!</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar plato, ingrediente o pa√≠s...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-red-600 mr-2"></i> <!-- Icono libro -->
                 Men√∫ de Platos T√≠picos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando el men√∫...</p>
                  <!-- Los .title-item se a√±adir√°n aqu√≠ -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No encontramos ese plato en nuestro recetario.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir M√°s Sabores
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Preparando la receta...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se a√±adir√°n aqu√≠ v√≠a JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                    <p class="text-sm font-semibold text-center text-gray-600 mb-2 font-sans">¬øPreguntas sobre este plato?</p>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando al chef...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Ej: ¬øEs picante? ¬øCon qu√© se acompa√±a?">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Plato">
      </div>

      <!-- Footer -->
      <footer class="bg-yellow-50 text-brown-700 py-6 mt-12 border-t border-brown-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Descripciones generadas por IA con fines informativos y de entretenimiento sobre la gastronom√≠a latinoamericana.</p>
              <p class="mt-1">Las recetas y detalles pueden variar regionalmente. ¬°Explora y disfruta!</p>
              <p class="mt-2">¬© 2025 Sabores de Latinoam√©rica</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        // *** LISTA EXHAUSTIVA (Intento de +400, priorizando relevancia) ***
        const predefinedTitles = [
            // Argentina
            "Asado Argentino", "Milanesa a la Napolitana", "Empanadas Argentinas (Carne, Pollo, Humita)", "Chorip√°n", "Locro Criollo", "Provoleta a la Parrilla", "Matambre a la Pizza", "Vitel Ton√©", "Pastel de Papas", "Humita en Chala", "Carbonada Criolla", "Chimichurri (Salsa)", "Alfajores (Marplatenses, Santafesinos)", "Dulce de Leche", "Pastafrola", "Flan con Dulce de Leche", "Fernet con Coca", "Malbec (Vino)", "Yerba Mate",
            // Bolivia
            "Salte√±as Bolivianas", "Pique Macho", "Sopa de Man√≠", "Silpancho", "Majadito", "Fricas√© Pace√±o", "Anticucho Boliviano", "Chairo Pace√±o", "Api Morado con Bu√±uelos", "Tucumanas (Empanadas fritas)", "Cu√±ap√©", "Helado de Canela", "Mocochinchi", "Singani (Bebida)",
            // Brasil
            "Feijoada Completa", "Moqueca (Baiana y Capixaba)", "P√£o de Queijo", "Coxinha", "Acaraj√©", "Vatap√°", "Churrasco Brasile√±o (Picanha)", "Bob√≥ de Camar√£o", "Farofa", "Brigadeiro", "Quindim", "Beijinho de Coco", "A√ßa√≠ na Tigela", "Caipirinha", "Guaran√° Antarctica",
            // Chile
            "Pastel de Choclo", "Empanadas de Pino", "Curanto en Hoyo", "Cazuela Chilena (Vacuno, Ave)", "Porotos Granados", "Charquic√°n", "Lomo a lo Pobre", "Completo Italiano", "Machas a la Parmesana", "Caldillo de Congrio", "Chorrillana", "Pebre (Salsa)", "Mote con Huesillo", "Leche Asada", "Torta de Mil Hojas", "Pisco Sour Chileno", "Carmenere (Vino)", "Terremoto (Bebida)",
            // Colombia
            "Bandeja Paisa", "Ajiaco Santafere√±o", "Sancocho (Coste√±o, Trif√°sico, de Gallina)", "Arepas Colombianas (con Queso, Huevo, Rellenas)", "Lechona Tolimense", "Posta Negra Cartagenera", "Patacones con Hogao", "Fritanga Colombiana", "Mote de Queso", "Arroz con Coco", "Sobrebarriga a la Criolla", "Tamales Tolimenses/Santandereanos", "Mazamorra Antioque√±a", "Brevas con Arequipe", "Obleas con Arequipe", "Cholado Valluno", "Aguardiente Antioque√±o", "Caf√© Colombiano (Tinto)", "Refajo", "Lulada",
            // Costa Rica
            "Gallo Pinto", "Casado Costarricense", "Olla de Carne", "Chifrijo", "Tamal Costarricense (de Cerdo)", "Pat√≠ (Empanada Caribe√±a)", "Gallo de Salchich√≥n", "Sopa Negra", "Arroz con Palmito", "Chorreadas", "Arroz con Leche Costarricense", "Tres Leches", "Agua Dulce", "Caf√© de Costa Rica", "Imperial (Cerveza)", "Guaro Cacique",
            // Cuba
            "Ropa Vieja", "Arroz con Pollo a la Chorrera", "Picadillo a la Habanera", "Moros y Cristianos", "Lech√≥n Asado Cubano", "Yuca con Mojo", "Vaca Frita", "S√°ndwich Cubano", "Tamal en Cazuela", "Frijoles Negros Dormidos", "Tostones (Chatinos)", "Flan Cubano", "Cascos de Guayaba con Queso Crema", "Mojito", "Daiquir√≠", "Caf√© Cubano", "Malta Hatuey",
            // Rep√∫blica Dominicana
            "La Bandera Dominicana (Arroz, Habichuelas, Carne)", "Sancocho Dominicano (de Siete Carnes)", "Mang√∫ con Los Tres Golpes", "Chimi Burger", "Pica Pollo", "Mofongo Dominicano", "Pastel√≥n de Pl√°tano Maduro", "Locrio de Pollo", "Yaniqueques", "Habichuelas con Dulce", "Majarete", "Morir So√±ando", "Mamajuana", "Presidente (Cerveza)",
            // Ecuador
            "Encebollado", "Fanesca", "Llapingachos con Hornado", "Cuy Asado", "Seco de Chivo/Gallina", "Guatita", "Ceviche Ecuatoriano (de Camar√≥n, Concha)", "Caldo de Bola de Verde", "Bol√≥n de Verde (con Queso/Chicharr√≥n)", "Empanadas de Viento", "Mote Pillo / Mote Sucio", "Pristi√±os con Miel", "Come y Bebe (Ensalada de Frutas)", "Canelazo", "Colada Morada (con Guaguas de Pan)", "Jugo de Naranjilla",
            // El Salvador
            "Pupusas (Revueltas, Queso con Loroco, Frijol con Queso)", "Yuca Frita con Chicharr√≥n", "Tamales Salvadore√±os (de Pollo, Pisques)", "Sopa de Patas", "Panes con Pollo", "Pastelitos de Carne/Papa", "Nuegados de Yuca", "Quesadilla Salvadore√±a (Postre)", "Horchata Salvadore√±a (de Morro)", "Atol de Elote", "Kolashanpan",
            // Guatemala
            "Pepi√°n de Pollo", "Kak'ik (Sopa de Pavo)", "Joc√≥n", "Hilachas", "Tamales Colorados / Negros", "Chuchitos", "Shucos (Hot Dogs Guatemaltecos)", "Tostadas Guatemaltecas (Salsa, Frijol, Guacamole)", "Pl√°tanos en Mole", "Rellenitos de Pl√°tano", "Bu√±uelos Guatemaltecos", "Atol Blanco", "Caf√© de Guatemala", "Ron Zacapa Centenario", "Gallo (Cerveza)",
            // Honduras
            "Baleadas (Sencillas, con Todo)", "Plato T√≠pico Hondure√±o", "Sopa de Caracol", "Tapado Olanchano", "Pupusas Hondure√±as", "Montucas", "Yuca con Chicharr√≥n Hondure√±a", "Pollo Chuco", "Rosquillas en Miel", "Torrejas de Pan/Pinol", "Horchata Hondure√±a", "Caf√© de Honduras", "Salva Vida (Cerveza)", "Gifiti (Bebida Gar√≠funa)",
            // M√©xico
            "Mole Poblano", "Chiles en Nogada", "Tacos al Pastor", "Pozole (Rojo, Blanco, Verde)", "Cochinita Pibil", "Birria de Chivo/Res", "Enchiladas (Verdes, Rojas, Suizas, Mineras)", "Tamales Mexicanos (Oaxaque√±os, Verdes, Dulce)", "Guacamole", "Sopa Azteca (Sopa de Tortilla)", "Carnitas Michoacanas", "Barbacoa de Borrego", "Chilaquiles", "Tlayudas Oaxaque√±as", "Esquites / Elotes Preparados", "Pescado a la Veracruzana", "Aguachile", "Flautas / Tacos Dorados", "Sopes / Gorditas", "Quesadillas (con/sin Queso)", "Pan de Muerto", "Pastel de Tres Leches", "Flan Napolitano", "Arroz con Leche Mexicano", "Churros con Chocolate", "Cajeta", "Agua de Horchata (de Arroz)", "Agua de Jamaica", "Agua de Tamarindo", "Margarita (C√≥ctel)", "Paloma (C√≥ctel)", "Michelada / Chelada", "Tequila", "Mezcal", "Pulque", "Caf√© de Olla",
            // Nicaragua
            "Gallo Pinto Nicarag√ºense", "Nacatamal", "Vigor√≥n", "Indio Viejo", "Sopa de Queso (Semana Santa)", "Baho", "Quesillo Nicarag√ºense", "Caballo Bayo", "Bu√±uelos de Yuca Nicarag√ºenses", "P√≠o Quinto", "Cacao Nicarag√ºense", "Pinolillo", "Chicha de Ma√≠z", "To√±a / Victoria (Cervezas)", "Ron Flor de Ca√±a",
            // Panam√°
            "Sancocho Paname√±o", "Ropa Vieja Paname√±a", "Arroz con Pollo Paname√±o", "Gallo Pinto Paname√±o", "Carima√±olas", "Hojaldras", "Tamal de Olla", "Corvina Frita", "Ceviche Paname√±o (Corvina)", "Bienmesabe (Postre)", "Sopa Borracha", "Chicheme", "Ron Abuelo", "Balboa / Atlas (Cervezas)", "Seco Herrerano",
            // Paraguay
            "Sopa Paraguaya", "Chipa Guasu", "Mbej√∫", "Vori Vori (Bori Bori)", "Pajagua Mascada", "Pastel Mandi'o", "Chipa (Almid√≥n, Mestizo)", "Kivev√©", "Dulce de Mam√≥n", "Cocido Quemado", "Terer√©", "Mosto Helado",
            // Per√∫
            "Ceviche Cl√°sico Peruano", "Lomo Saltado", "Aj√≠ de Gallina", "Causa Lime√±a (Rellena)", "Anticuchos de Coraz√≥n", "Rocoto Relleno Arequipe√±o", "Papa a la Huanca√≠na", "Pollo a la Brasa Peruano", "Arroz con Pato", "Seco de Cabrito a la Norte√±a", "Tacu Tacu", "Pachamanca", "Juane Amaz√≥nico", "Chupe de Camarones", "Suspiro a la Lime√±a", "Picarones", "Mazamorra Morada", "Arroz con Leche Peruano", "Alfajores Peruanos", "Pisco Sour Peruano", "Chicha Morada", "Inca Kola", "Caf√© Peruano", "Emoliente",
            // Puerto Rico
            "Mofongo (con Chicharr√≥n, Camarones, etc.)", "Lech√≥n Asado a la Vara", "Arroz con Gandules", "Pasteles Puertorrique√±os", "Tostones / Amarillos Fritos", "Pernil Asado", "Alcapurrias", "Bacalaitos Fritos", "Piononos", "Tembleque", "Arroz con Dulce", "Flan de Coco / Queso", "Coquito (Navidad)", "Pi√±a Colada", "Ron de Puerto Rico (Bacard√≠, Don Q)", "Mavi (Bebida)", "Caf√© de Puerto Rico",
            // Uruguay
            "Chivito Uruguayo", "Asado Uruguayo (Tira de Asado)", "Parrillada Uruguaya Completa", "Milanesa Uruguaya", "Empanadas Uruguayas", "Pastel de Carne Uruguayo", "Torta Frita", "Pasqualina", "Puchero Uruguayo", "Pancho (Hot Dog Uruguayo)", "Garrapi√±ada de Man√≠", "Chaj√° (Postre)", "Mart√≠n Fierro (Queso y Dulce)", "Medio y Medio (Bebida)", "Grappamiel", "Tannat (Vino)", "Mate Uruguayo",
            // Venezuela
            "Pabell√≥n Criollo", "Arepas Venezolanas (Reina Pepiada, Pel√∫a, Domin√≥, Sifrina)", "Hallacas Navide√±as", "Cachapas con Queso de Mano", "Teque√±os", "Asado Negro", "Sancocho Venezolano", "Pisca Andina", "Hervido de Gallina/Res", "Empanadas Venezolanas (Caz√≥n, Carne Mechada)", "Mandocas Zulianas", "Torta Negra Navide√±a", "Quesillo Venezolano", "Bienmesabe Venezolano", "Torta de Tres Leches", "Papel√≥n con Lim√≥n", "Chicha Venezolana (de Arroz)", "Merengada", "Malta Malt√≠n Polar", "Ron Venezolano (Santa Teresa, Cacique)", "Cocuy de Penca", "Frescolita",
            // Temas Generales / Ingredientes / T√©cnicas
            "El Ma√≠z en la Gastronom√≠a Latinoamericana", "La Papa: Origen Andino y Variedades", "El Aj√≠ / Chile: Picante y Sabor", "Frijoles / Porotos / Habichuelas: Base Proteica", "Yuca / Mandioca: Versatilidad Tropical", "Pl√°tano (Macho y Dulce): Usos Culinarios", "El Aguacate / Palta: Oro Verde", "Quinua: Superalimento Andino", "Cacao y Chocolate Latinoamericano", "Caf√© Latinoamericano: Diversidad de Or√≠genes", "Empanadas: Un Continente de Sabores", "Tamales: Variaciones Regionales", "Arepas: Tradici√≥n Colombo-Venezolana", "Ceviches: Frescura del Pac√≠fico", "Asados / Parrilladas del Cono Sur", "Sancochos y Hervidos: Sopas Sustanciosas", "Moles Mexicanos: Complejidad y Tradici√≥n", "Influencia Ind√≠gena en la Cocina LatAm", "Influencia Africana en la Gastronom√≠a Caribe√±a/Brasile√±a", "Influencia Espa√±ola y Europea", "Comida Callejera Latinoamericana", "Bebidas T√≠picas sin Alcohol", "Bebidas Alcoh√≥licas Tradicionales (Ron, Tequila, Pisco, etc.)", "Postres Emblem√°ticos de Latinoam√©rica", "Frutas Ex√≥ticas de Am√©rica Latina", "La Cocina Nikkei (Peruano-Japonesa)", "La Cocina Chifa (Peruano-China)", "T√©cnicas de Cocci√≥n Tradicionales (Pachamanca, Curanto)", "Hierbas Arom√°ticas Clave (Cilantro, Epazote, Huacatay)"
            // ... (Se pueden a√±adir m√°s variaciones espec√≠ficas o menos conocidas si se desea)
        ];
        const latinFoodThemes = [
            "platos de M√©xico", "comida peruana", "gastronom√≠a argentina", "cocina colombiana", "sabores de Brasil", "recetas de Chile", "platos venezolanos", "comida cubana", "recetas centroamericanas", "ingredientes andinos", "ma√≠z en latinoam√©rica", "papas nativas", "aj√≠es y chiles", "frutas tropicales", "bebidas latinas", "postres t√≠picos", "comida callejera LatAm", "influencia ind√≠gena cocina", "influencia africana cocina", "asados y parrilladas", "sopas y sancochos", "ceviches y tiraditos", "empanadas y tamales", "arepas y pupusas", "cocina caribe√±a"
        ];
        const textApiConfig = { // Para descripci√≥n principal
            model: "mistral",
            systemPrompt: "Eres un chef experto, historiador culinario y gu√≠a gastron√≥mico especializado en Am√©rica Latina. Tu tarea es describir el plato, bebida, ingrediente o concepto culinario latinoamericano indicado. Proporciona detalles sobre: Origen geogr√°fico e hist√≥rico (pa√≠s/regi√≥n), ingredientes clave y caracter√≠sticos, descripci√≥n general del sabor y textura, m√©todo de preparaci√≥n b√°sico (sin ser una receta paso a paso), variantes regionales importantes, significado cultural o cu√°ndo se consume t√≠picamente, y sugerencias de acompa√±amiento o maridaje. Usa un lenguaje descriptivo, apetitoso y culturalmente rico. El objetivo es una rese√±a completa y atractiva de aproximadamente 1200-1300 palabras. Basa tu descripci√≥n √∫nicamente en el siguiente elemento de la gastronom√≠a latinoamericana:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat, system prompt se sobreescribe
            model: "mistral-tiny",
            systemPrompt: "Act√∫a como un asistente de cocina amigable y conocedor, enfocado √∫nicamente en el plato o concepto latinoamericano que se est√° mostrando. Responde preguntas sobre sustituciones de ingredientes, nivel de picante, dificultad de preparaci√≥n, maridajes, historia espec√≠fica, o d√≥nde encontrarlo. S√© conciso, √∫til y mantente dentro del tema culinario actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Act√∫a como un generador de ideas conciso para una gu√≠a gastron√≥mica de Latinoam√©rica. Genera exactamente 15 nombres evocadores de platos t√≠picos, bebidas, postres, ingredientes clave o conceptos culinarios de diferentes pa√≠ses latinoamericanos. Devuelve *solo* la lista de nombres/conceptos, uno por l√≠nea. No incluyas n√∫meros, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        // (Sin cambios respecto a la versi√≥n anterior, los IDs son gen√©ricos)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentDishTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentDishTitle
                 ? `Eres un asistente de cocina amigable y conocedor, enfocado √∫nicamente en '${currentDishTitle}'. Responde preguntas sobre sustituciones de ingredientes, nivel de picante, dificultad, maridajes, historia espec√≠fica, o d√≥nde encontrarlo. S√© conciso, √∫til y mantente en el tema.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tr√°fico en este momento, intenta en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta del chef lleg√≥ vac√≠a. ¬øPodr√≠as reformular tu pregunta?");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexi√≥n tard√≥ demasiado (>${config.timeoutSeconds}s). Revisa tu conexi√≥n o int√©ntalo m√°s tarde.`);
                 }
                 throw new Error(error.message || "Hubo un problema en la cocina... Error inesperado.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentDishTitle) throw new Error("Error interno: No s√© de qu√© plato estamos hablando."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(latinFoodThemes) || "gastronom√≠a latinoamericana general";
             const specificPrompt = `Genera 15 nombres de platos, bebidas o ingredientes t√≠picos de ${randomTheme}`;
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                  .then(text => {
                      const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                      if (titles.length < 5) throw new Error("No se pudieron generar m√°s ideas de platos.");
                      return titles.slice(0, 15);
                  });
         }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "plato t√≠pico latinoamericano";
             // Prompt mejorado para fotos de comida
             const enhancedPrompt = `High-quality food photography of '${safePromptText}', typical Latin American dish. Focus on presentation, texture, key ingredients. Natural lighting, appetizing composition, shallow depth of field. Restaurant or rustic table setting.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             // Negativos espec√≠ficos para comida
             const negativePrompt = "text, words, labels, logo, watermark, signature, drawing, illustration, painting, cartoon, sketch, diagram, multiple dishes, person, hand, ugly, messy, blurry, low quality, unrealistic";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-‚àí]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('‚àí', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL, FULLSCREEN, CHAT FUNCTIONS ==========
        // (Sin cambios funcionales mayores respecto a la versi√≥n anterior, adaptados al contexto)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentDishTitle = null; // Limpia contexto
             hideFullscreenImage(); // Asegura que la imagen grande se cierre
        }
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            // Solo desbloquea si el modal principal NO est√° activo
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error del Chef: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        // Funci√≥n para asignar un icono basado en el t√≠tulo (simplificado)
        function getIconForTitle(title) {
            const lowerTitle = title.toLowerCase();
            if (lowerTitle.includes('sopa') || lowerTitle.includes('caldo') || lowerTitle.includes('chupe') || lowerTitle.includes('sancocho') || lowerTitle.includes('hervido') || lowerTitle.includes('ajiaco')) return 'fa-solid fa-bowl-rice';
            if (lowerTitle.includes('taco') || lowerTitle.includes('arepa') || lowerTitle.includes('pupusa') || lowerTitle.includes('empanada') || lowerTitle.includes('tamal') || lowerTitle.includes('salte√±a') || lowerTitle.includes('torta') || lowerTitle.includes('pastel')) return 'fa-solid fa-plate-wheat';
            if (lowerTitle.includes('asado') || lowerTitle.includes('parrilla') || lowerTitle.includes('churrasco') || lowerTitle.includes('carne') || lowerTitle.includes('pollo') || lowerTitle.includes('cerdo') || lowerTitle.includes('chivo') || lowerTitle.includes('pato') || lowerTitle.includes('cuy') || lowerTitle.includes('lechon') || lowerTitle.includes('res')) return 'fa-solid fa-drumstick-bite';
            if (lowerTitle.includes('ceviche') || lowerTitle.includes('pescado') || lowerTitle.includes('marisco') || lowerTitle.includes('camar√≥n') || lowerTitle.includes('concha')) return 'fa-solid fa-shrimp';
            if (lowerTitle.includes('postre') || lowerTitle.includes('dulce') || lowerTitle.includes('flan') || lowerTitle.includes('torta') || lowerTitle.includes('helado') || lowerTitle.includes('alfajor') || lowerTitle.includes('suspiro') || lowerTitle.includes('mazamorra') || lowerTitle.includes('arroz con leche')) return 'fa-solid fa-ice-cream';
            if (lowerTitle.includes('bebida') || lowerTitle.includes('agua') || lowerTitle.includes('jugo') || lowerTitle.includes('caf√©') || lowerTitle.includes('mate') || lowerTitle.includes('chicha') || lowerTitle.includes('ron') || lowerTitle.includes('pisco') || lowerTitle.includes('tequila') || lowerTitle.includes('vino') || lowerTitle.includes('cerveza') || lowerTitle.includes('caipirinha') || lowerTitle.includes('mojito')) return 'fa-solid fa-martini-glass-citrus';
            if (lowerTitle.includes('ma√≠z') || lowerTitle.includes('choclo') || lowerTitle.includes('elote')) return 'fa-solid fa-seedling'; // O usar fa-corn si estuviera disponible gratis
            if (lowerTitle.includes('papa') || lowerTitle.includes('yuca') || lowerTitle.includes('pl√°tano')) return 'fa-solid fa-carrot'; // Icono gen√©rico ra√≠z/tub√©rculo
            if (lowerTitle.includes('aj√≠') || lowerTitle.includes('chile')) return 'fa-solid fa-pepper-hot';
            return 'fa-solid fa-utensils'; // Icono por defecto
        }
        function createTitleItem(title) {
             const div = document.createElement('div');
             div.className = 'title-item';
             div.setAttribute('data-title', title);
             // Add icon
             const iconClass = getIconForTitle(title);
             const iconElement = document.createElement('i');
             iconElement.className = `fas ${iconClass}`; // O 'fa-solid' dependiendo de la versi√≥n FA
             div.appendChild(iconElement);
             // Add text
             const textSpan = document.createElement('span');
             textSpan.textContent = title;
             div.appendChild(textSpan);

             div.addEventListener('click', () => handleTitleClick(title));
             return div;
         }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar alfab√©ticamente para f√°cil navegaci√≥n
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay platos en el men√∫ por ahora.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-aplicar filtro
         }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentDishTitle = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll reset after text content added");

                // Placeholder y carga de imagen
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-camera placeholder-icon"></i>
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Tomando foto del plato...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Foto de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Image load error:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No pudimos fotografiar el plato.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la receta.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando en la despensa...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No encontramos m√°s platos por ahora."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar m√°s sabores: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir M√°s Sabores';
             }
         }
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
             // Check essential elements
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: var(--color-primary, red); font-size: 1.6em; text-align: center; padding-top: 4em; font-family: Merriweather, serif;">¬°Ups! Parece que la cocina est√° desordenada. Faltan componentes esenciales de la p√°gina.</p>';
                 return;
             }
             // Add Listeners
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

             // Initial Load
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
             console.log("App initialized. Buen provecho!");
         }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>