<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marvel x Cartoon Network: Crossover Nexus</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Comic/Divertidas/Heroicas -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-marvel-red: #ED1D24;
            --color-marvel-blue: #0050A4;
            --color-cn-green: #00A750; /* Ben 10 Green */
            --color-cn-pink: #FF7BAC; /* PPG Pink */
            --color-background: #f0f4f8; /* Fondo claro, como página de cómic */
            --color-text: #2d3748; /* Gris oscuro */
            --color-text-muted: #718096;
            --color-modal-bg: #ffffff;
            --color-border: #cbd5e0;
            --color-accent: #ffc107; /* Amarillo/Dorado */
            --color-error-bg: #fff5f5;
            --color-error-text: #c53030;
            --color-error-border: #fc8181;

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 8px; /* Bordes más redondeados */
            --transition-normal: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        /* Fuente Bangers para títulos principales */
        h1, h2, .logo, #modal-title { font-family: 'Bangers', cursive; letter-spacing: 2px; font-weight: 400; /* Bangers es bold por defecto */ }
        .logo { color: var(--color-marvel-red); text-shadow: 2px 2px 0px var(--color-marvel-blue), -2px -2px 0px var(--color-cn-green); -webkit-text-stroke: 1px black; }
        h1.page-title { color: var(--color-marvel-blue); text-shadow: 1px 1px 0 var(--color-marvel-red), -1px -1px 0 var(--color-cn-green); -webkit-text-stroke: 0.5px white; }
        h2.section-title { color: var(--color-text); border-bottom: 4px dotted var(--color-marvel-red); padding-bottom: 0.5rem; display: inline-block; }
        #modal-title { color: var(--color-marvel-red); text-shadow: 1px 1px var(--color-marvel-blue); }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 2px solid var(--color-border); }
        /* Search */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 2px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); transition: var(--transition-normal); }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-marvel-blue); box-shadow: 0 0 0 3px rgba(0, 80, 164, 0.25); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-marvel-blue); }
        /* Titles */
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.5rem 1.2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-marvel-blue); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 75px; font-size: 1.05rem; position: relative; overflow: hidden; }
        .title-item::before { /* Efecto hover */ content: ''; position: absolute; bottom: 0; left: -100%; width: 100%; height: 5px; background: linear-gradient(90deg, var(--color-marvel-red), var(--color-cn-green), var(--color-cn-pink)); transition: left 0.3s ease-out; }
        .title-item:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--color-marvel-blue); color: var(--color-marvel-red); }
        .title-item:hover::before { left: 0; }
        /* Generate More Button */
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-marvel-red), var(--color-marvel-blue)); color: white; padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Poppins', sans-serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; text-transform: uppercase; box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-cn-green), var(--color-cn-pink)); box-shadow: var(--shadow-md); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }
        /* Modal */
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(45, 55, 72, 0.9); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper { background-color: var(--color-modal-bg); border: 3px solid var(--color-border); border-radius: var(--border-radius); padding: 1.5rem 2rem; max-width: 950px; width: 95%; max-height: 90vh; min-height: 450px; /* Para acomodar juego/chat */ overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 8px; right: 8px; background: var(--color-text-muted); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-marvel-red); transform: rotate(180deg); }
        #modal-title { font-size: 3rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.1; }
        /* Loading Area with Game */
        #modal-loading { text-align: center; padding: 1rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); display: none; /* Oculto inicialmente */ flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #modal-loading.active { display: flex; } /* Se activa por JS */
        #loading-game-canvas { background-color: #1a202c; /* Fondo espacial oscuro */ border: 2px solid var(--color-accent); margin-bottom: 1rem; display: none; /* Oculto hasta que se active el juego */ cursor: crosshair; max-width: 90%; }
        #loading-game-info { color: var(--color-text); font-size: 0.9rem; margin-top: 0.5rem; display: none; /* Oculto hasta que se active el juego */ }
        #loading-game-info p { margin-bottom: 0.3rem; }
        #loading-spinner-area { /* Contenedor para spinner/texto si el juego falla o no inicia */ padding: 3rem 0; }
        .loading-spinner-modal { width: 60px; height: 60px; border: 6px solid #e2e8f0; border-top-color: var(--color-marvel-red); border-right-color: var(--color-cn-green); border-bottom-color: var(--color-marvel-blue); border-left-color: var(--color-cn-pink); border-radius: 50%; animation: spin 1.5s linear infinite; margin: 0 auto 1.5rem auto; }
        #loading-message { font-weight: 600; color: var(--color-text); font-size: 1.3rem; font-family: 'Poppins'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Story Content Area */
        #modal-story-content-area { display: none; /* Oculto hasta cargar */ flex-direction: column; flex-grow: 1; min-height: 0; }
        #modal-story-content-area.visible { display: flex; }
        /* Scrollable Text Area */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem; scrollbar-width: thin; scrollbar-color: var(--color-marvel-red) var(--color-border); }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-marvel-red); border-radius: var(--border-radius); border: 1px solid #a0aec0; }
        #modal-content { padding: 0 5px; font-size: 1.05rem; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-marvel-red); font-weight: 700; }
        #modal-content em { color: var(--color-cn-green); font-style: italic; font-weight: 600; }
        /* Usar Poppins para encabezados dentro del texto */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Poppins', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-marvel-blue); border-bottom: 2px solid var(--color-border); padding-bottom: 0.4em; font-weight: 700; letter-spacing: 0.5px; }
        #modal-content h1 { font-size: 1.5em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-marvel-red); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none; font-weight: 600; }
        /* Final Image */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 2px solid var(--color-accent); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.05); box-shadow: var(--shadow-lg), 0 0 15px var(--color-accent); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); font-family: 'Poppins'; }
        #modal-content .image-placeholder .spinner { /* Usar el mismo spinner que el loading principal */ width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--color-marvel-red); border-right-color: var(--color-cn-green); border-bottom-color: var(--color-marvel-blue); border-left-color: var(--color-cn-pink); border-radius: 50%; animation: spin 1.5s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-border); }
        /* Chat Section */
        #chat-section { border-top: 2px dashed var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f7fafc; scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: var(--color-cn-pink) #e2e8f0; }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: #e2e8f0; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-cn-pink); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 0.9rem; border-radius: 15px; /* Bubble shape */ max-width: 80%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-marvel-blue); color: white; margin-left: auto; border-bottom-right-radius: 3px; text-align: left; }
        .ai-message { background-color: #e2e8f0; color: var(--color-text); margin-right: auto; border-bottom-left-radius: 3px; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Poppins'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-marvel-blue); box-shadow: 0 0 0 2px rgba(0, 80, 164, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-marvel-red); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #c41a20; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; color: var(--color-marvel-red); }
        /* Error Message */
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Poppins'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }
        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-accent); box-shadow: 0 0 30px var(--color-accent); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: rgba(255,255,255, 0.2); border: 1px solid white; border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); backdrop-filter: blur(3px); }
        #fullscreen-close-btn:hover { background-color: var(--color-marvel-red); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10 py-3">
         <div class="container mx-auto px-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-4xl sm:text-5xl transform -rotate-2">
                     <i class="fas fa-bolt mr-2 text-yellow-400"></i> <!-- Icono rayo -->
                     Crossover Nexus
                 </h1>
             </div>
             <span class="text-base text-gray-600 font-semibold font-poppins tracking-wide">MARVEL <i class="fas fa-times text-red-500 mx-1"></i> CARTOON NETWORK</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">¡COLISIÓN DE UNIVERSOS!</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora historias inimaginables donde tus héroes y personajes favoritos se encuentran. ¡Elige una premisa o busca tu crossover soñado!</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar personajes, equipos, shows...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-blue-500 mr-2"></i> <!-- Icono libro -->
                 Premisas de Crossover
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-poppins">Accediendo a archivos multiversales...</p>
                  <!-- .title-item s here -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-poppins">¡Oops! Ninguna realidad coincide con esa búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar 40 Nuevas Realidades
                  </button>
             </div>
         </section>
     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Area (Game / Spinner) -->
             <div id="modal-loading">
                 <!-- Game Canvas and Info (initially hidden) -->
                 <canvas id="loading-game-canvas" width="600" height="350"></canvas>
                 <div id="loading-game-info">
                     <p><strong>¡COSMIC CLASH!</strong></p>
                     <p>Controles: Flechas Izq/Der = Rotar | Flecha Arriba = Empuje | Espacio = Disparar</p>
                     <p>¡Sobrevive mientras se carga la historia!</p>
                 </div>
                 <!-- Fallback Spinner Area (initially visible) -->
                 <div id="loading-spinner-area">
                     <div class="loading-spinner-modal"></div>
                     <p id="loading-message">Abriendo portal interdimensional...</p>
                 </div>
             </div>

             <!-- Content Area Wrapper (Story + Chat) -->
             <div id="modal-story-content-area">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) -->
                         <!-- Image placeholder/image -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al Vigilante...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta realidad...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Crossover">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-600 py-6 mt-12 border-t border-gray-300 font-poppins">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias generadas por IA inspiradas en personajes de Marvel y Cartoon Network. Fines recreativos.</p>
              <p class="mt-1">Marvel y todos los personajes relacionados son TM & © Marvel. Cartoon Network y todos los personajes relacionados son TM & © The Cartoon Network, Inc. / Warner Bros. Discovery.</p>
              <p class="mt-2">© 2024 Crossover Nexus Project</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Marvel Heroes meet CN Heroes
            "Spider-Man y Ben 10 intercambian lugares (y relojes)", "Los Vengadores reclutan a las Supernenas (Powerpuff Girls)", "Hulk y Four Arms (Ben 10) compiten en fuerza bruta", "Captain Marvel entrena a Garnet (Steven Universe)", "Iron Man intenta mejorar el laboratorio de Dexter", "Thor visita Ooo y se encuentra con Finn y Jake", "Wolverine y Samurai Jack: Duelo de espadachines silenciosos", "Doctor Strange busca consejo en Tío Grandpa", "Los Guardianes de la Galaxia conocen a los Chicos del Barrio (KND)", "Deadpool rompe la cuarta pared... en Chowder", "Ms. Marvel (Kamala) y Starfire (Teen Titans) se hacen amigas", "Black Widow investiga los secretos de Coraje, el Perro Cobarde", "Hawkeye y Arco (Samurai Jack): Competición de arquería", "Ant-Man se infiltra en la casa del árbol de KND", "She-Hulk defiende a Ed, Edd y Eddy en la corte", "Capitán América inspira a Número 1 (KND)", "Steven Universe intenta sanar el trauma de Bucky Barnes", "Los Cuatro Fantásticos exploran el Fantasma del Espacio", "Ghost Rider persigue a HIM (Powerpuff Girls)", "Daredevil ayuda a Escandalosos (We Bare Bears) a navegar la ciudad",
            // Marvel Villains meet CN Villains/Heroes
            "Thanos busca el Omnitrix", "Loki engaña a Aku (Samurai Jack)", "Doctor Doom intenta conquistar el Candy Kingdom (Adventure Time)", "Magneto vs Los Hombres X... y Dexter?", "El Duende Verde aterroriza Ciudad Saltadilla (Townsville)", "Mojo Jojo intenta unirse a los Maestros del Mal", "Vilgax desafía a los Vengadores", "El Mandarín encuentra los anillos... de Juniper Lee?", "Ultron asimila la tecnología de Mandark (Dexter's Lab)", "Galactus intenta devorar el mundo de Chowder", "Kingpin dirige el bajo mundo de Bellwood (Ben 10)", "Aku y Dormammu forman una alianza oscura", "HIM corrompe a un miembro de los X-Men", "Red Skull intenta reclutar a los Villanos de KND", "Kang el Conquistador viaja a la era de Samurai Jack", "Mystique se infiltra en las Gemas de Cristal", "Carnage se une a un personaje de Regular Show", "MODOK intenta controlar a Cerebro (Pinky y Cerebro)", "Ronan el Acusador juzga a Johnny Bravo", "Zzzax (Hulk villain) vs NRG (Ben 10)",
            // Team-Ups & Conflicts
            "Los Vengadores vs La Liga de la Justicia... Amiga (Dexter's Lab)", "X-Men y Jóvenes Titanes (Teen Titans): Amenaza Mutante", "Guardianes de la Galaxia y Cazarrecompensas Espaciales (Cowboy Bebop Style)", "Inhumanos descubren a las Gemas de Cristal", "Agentes de SHIELD investigan Fenómenos Paranormales en Elmore (Gumball)", "Los Defensores (Daredevil, etc.) protegen a Coraje", "Thunderbolts vs El Escuadrón del Mal (varios villanos CN)", "Runaways encuentran refugio con los Escandalosos", "Academia Vengadores conoce a los estudiantes de Megas XLR", "Power Pack y Supernenas: Equipo de niños héroes", "Captain Carter en el mundo de Samurai Jack", "What If... Gwen Tennyson encontrara el Simbionte Venom?", "What If... Jake el Perro obtuviera el Guantelete del Infinito?", "What If... Ben 10 escaneara a Hulk?", "What If... Las Supernenas fueran criadas por Nick Fury?",
            // Concepts & World Merging
            "Asgard aparece sobre el Reino de Ooo", "La Zona Negativa se abre en el laboratorio de Dexter", "Wakanda establece relaciones diplomáticas con el Dulce Reino", "Skrulls se infiltran en la Organización KND", "Un Celestial juzga el planeta de Billy y Mandy", "El Multiverso Marvel colapsa con el Multiverso de Rick y Morty", "La Magia del Caos (Wanda) afecta a Flapjack", "El Nulificador Supremo cae en manos de Ed", "El Cubo Cósmico reescribe la realidad de Regular Show", "Klyntar (Simbiontes) llegan a Bellwood", "Mutantes aparecen en Steven Universe", "Viaje en el tiempo: Cable encuentra a Samurai Jack", "Realidad Alterna: Peter Parker es mordido por una araña... en Ooo", "Realidad Alterna: Ben 10 encuentra el Teseracto", "Dimensión Oscura (Dormammu) invade el Inframundo (Billy y Mandy)",
            // More specific scenarios
            "Finn y Jake intentan levantar Mjolnir", "Gumball y Darwin causan problemas en la Torre Vengadores", "Rigby y Mordecai intentan usar la Máquina del Tiempo de Doom", "Las Gemas de Cristal reaccionan a las Gemas del Infinito", "Samurai Jack entrena a Shang-Chi", "Coraje advierte a los Vengadores de una amenaza cósmica", "Dexter desafía a Reed Richards a un duelo de inteligencia", "Mojo Jojo roba tecnología Stark", "Ben 10 lucha contra un Centinela X-Men", "Las Supernenas detienen un robo de Juggernaut", "Johnny Bravo intenta ligar con She-Hulk", "Ed, Edd y Eddy intentan estafar a Loki", "Número 4 (KND) pelea con Wolverine", "Billy y Mandy hacen un trato con Mephisto", "El Tío Grandpa visita a The Watcher (Uatu)", "El Fantasma del Espacio entrevista a los Guardianes de la Galaxia", "Blue Beetle (Jaime Reyes) y Ben 10 comparan tecnología alienígena", "Juniper Lee lucha contra demonios junto a Ghost Rider", "Invader Zim intenta conquistar la Tierra... de nuevo (con ayuda de MODOK?)", "Danny Phantom (Nick, pero popular en CN era) vs Doctor Strange",
             // Adding more diverse entries
            "Scooby Doo y la Máquina del Misterio encuentran la Mansión X", "Los Supersónicos conocen a Iron Man 2020", "Los Picapiedra descubren el Vibranium", "El Oso Yogui intenta robar la canasta de picnic de Hulk", "Tom y Jerry causan caos en el Helicarrier de SHIELD", "Droopy investiga un crimen mutante", "Hong Kong Phooey intenta ayudar a Daredevil", "Maguila Gorila se une al circo del crimen de Ringmaster", "Inspector Gadget (influencia CN) investiga a Hammer Industries", "He-Man (conexión Filmation/CN) y Thor: Choque de poder", "She-Ra (conexión Filmation/CN) y Captain Marvel: Princesas del Poder", "Birdman defiende a Harvey Birdman, Attorney at Law... en un caso contra Kingpin", "Shaggy y Scooby conocen a Groot y Rocket", "Velma resuelve un misterio con la ayuda de Doctor Strange", "Daphne y Fred son rescatados por Spider-Man", "Los Herculoides luchan contra Fin Fang Foom", "Johnny Quest y su equipo exploran la Tierra Salvaje", "Los Jóvenes Titanes en Acción conocen a Deadpool", "Clarence intenta hacerse amigo de Hulk", "El Increíble Mundo de Gumball: Episodio dirigido por los Hermanos Russo",
            "Generador Rex ayuda a los Vengadores contra Ultron", "Secret Saturdays investigan Knull, el Rey Simbionte", "Sym-Bionic Titan lucha contra un Celestial", "Mucha Lucha conoce a los luchadores de la UCWF (Thing, etc.)", "Código Lyoko (influencia CN) y los X-Men: Amenaza Digital", "Martin Mystery (influencia CN) investiga el Sanctum Sanctorum", "Totally Spies (influencia CN) se infiltran en SHIELD", "My Gym Partner's a Monkey conoce a Rocket Raccoon", "Camp Lazlo: Los campistas conocen a Ant-Man", "Chowder intenta cocinar con la Gema de la Realidad", "Flapjack navega hacia Krakoa", "Robotboy se une a los Vengadores Mecanizados", "Hi Hi Puffy AmiYumi dan un concierto en la Torre Stark", "The Life and Times of Juniper Lee: Te Xuan Ze vs Los Diez Anillos", "Megas XLR vs un Centinela Gigante", "Ben 10: Omniverse - Ben conoce al Spider-Verse", "Steven Universe Future: Steven ayuda a Wanda a controlar su poder", "Adventure Time: Distant Lands - Finn y Jake en el Reino Cuántico", "Regular Show: Mordecai y Rigby viajan al futuro de Kang", "KND: Operación M.A.R.V.E.L.",
            "Vilgax obtiene el poder del Fénix Oscuro", "Aku posee a un Heraldo de Galactus", "Mojo Jojo con el intelecto de The Leader", "HIM forma un pacto con Chton", "Mandark construye su propio Iron Monger", "Los Chicos del Barrio se enfrentan a la Inteligencia Suprema Kree", "Las Gemas de Cristal vs la Orden Negra de Thanos", "Samurai Jack lucha contra The Hand", "Coraje presencia la llegada de Silver Surfer", "Dexter intenta replicar el Suero del Súper Soldado", "Ben 10 (Alien X) debate con The Living Tribunal", "Las Supernenas asisten a la Academia Strange", "Finn y Jake se pierden en el Mojoverse", "Mordecai y Rigby juegan videojuegos con M.O.D.O.K.", "Gumball intenta venderle un seguro a J. Jonah Jameson", "Los Escandalosos son adoptados temporalmente por la Tía May", "Tío Grandpa le da consejos de vida a Deadpool", "Juniper Lee se une a los Midnight Sons", "Generador Rex vs los Reavers cibernéticos", "Kid Cosmic encuentra un artefacto Asgardiano"
            // Approx 150+ initial titles. "Generate More" adds 40 each time.
        ];
        const crossoverThemes = [ // For generating more titles
            "héroes de Marvel y Cartoon Network", "villanos de Marvel encontrando personajes de CN", "equipos de Marvel y CN",
            "magia de Marvel y CN", "tecnología de Marvel y CN", "personajes cósmicos Marvel y CN", "mutantes y personajes CN con poderes",
            "aventuras en Ooo con héroes Marvel", "Ben 10 escaneando ADN Marvel", "Supernenas en el Universo Marvel", "Dexter y ciencia Marvel",
            "Samurai Jack en épocas Marvel", "Steven Universe y gemas Marvel", "Regular Show causando caos Marvel", "KND vs organizaciones Marvel",
            "Historias 'What If' crossover", "Fusiones de mundos Marvel/CN", "Personajes callejeros Marvel en ciudades CN", "Terror Marvel con Coraje",
            "Guardianes de la Galaxia con personajes espaciales CN", "Spider-Verse encontrando dimensiones CN", "Gumball en situaciones Marvel"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un escritor extremadamente creativo y fanático, especializado en cómics y dibujos animados. Tu tarea es escribir una historia corta de ficción (aproximadamente 1200-1300 palabras) basada en la siguiente premisa de crossover entre MARVEL Comics y CARTOON NETWORK. Captura la esencia, personalidades y estilos de ambos universos involucrados. Enfócate en interacciones únicas, diálogos creíbles (dentro de su contexto), desarrollo de la trama interesante y un final satisfactorio (o un cliffhanger intrigante). ¡Sé imaginativo y diviértete fusionando estos mundos! La premisa es:",
            timeoutSeconds: 180 // Slightly longer timeout maybe needed for complex stories + server load
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúas como un asistente IA experto absoluto en los universos Marvel y Cartoon Network, específicamente enfocado en la historia crossover '[CURRENT_TITLE]' que acaba de ser contada. Responde preguntas de seguimiento sobre los personajes, la trama, las interacciones o posibles consecuencias *dentro de esa historia específica*. Sé entusiasta, conciso y mantente en el tema.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // Generate 40 titles now
            model: "mistral",
            systemPrompt: "Eres un generador de ideas multiversal. Crea exactamente 40 ideas ÚNICAS y EMOCIONANTES para historias crossover entre personajes, equipos o conceptos del universo Marvel Comics y personajes, shows o conceptos del universo Cartoon Network. Varía los tipos de interacción (team-ups, conflictos, 'what if', etc.). Devuelve *solo* la lista de ideas, una por línea. Sin números, guiones, introducciones o comentarios.",
            timeoutSeconds: 60 // Longer timeout for generating more titles
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        // Loading Elements
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const loadingSpinnerArea = document.getElementById('loading-spinner-area'); // Fallback spinner
        const loadingMessage = document.getElementById('loading-message');
        const loadingGameCanvas = document.getElementById('loading-game-canvas');
        const loadingGameInfo = document.getElementById('loading-game-info');
        // Story Content Elements
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Context for chat
        let gameInstance = null; // To hold the game object/state

        // ========== API FUNCTIONS ========== (Updated error messages, timeout)
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `Actúas como un asistente IA experto absoluto en los universos Marvel y Cartoon Network, específicamente enfocado en la historia crossover '${currentStoryTitle}' que acaba de ser contada. Responde preguntas de seguimiento sobre los personajes, la trama, las interacciones o posibles consecuencias *dentro de esa historia específica*. Sé entusiasta, conciso y mantente en el tema.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}, Timeout: ${config.timeoutSeconds}s): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);

                 if (!response.ok) {
                     // *** FRIENDLY ERROR MESSAGE ***
                     throw new Error(`(Error ${response.status}) ¡Vaya! Nuestros servidores multiversales tienen mucho tráfico ahora mismo. Inténtalo de nuevo en unos segundos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                      throw new Error("La IA devolvió una respuesta vacía. Quizás la conexión falló o la premisa era muy compleja.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 // Basic check for refusals (adapt keywords if needed)
                 const lowerText = text.toLowerCase();
                  if (lowerText.includes("cannot fulfill") || lowerText.includes("no puedo generar") || lowerText.includes("unable to create") || lowerText.includes("violates my policy")) {
                    throw new Error("La IA no pudo generar una historia para esta premisa específica, quizás por restricciones de contenido. ¡Prueba otra!");
                  }
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión al portal tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o la estabilidad del multiverso e intenta más tarde.`);
                 }
                 throw new Error(error.message || "¡Zas! Ocurrió un error inesperado contactando con la IA.");
             }
        }
        async function fetchExplanationText(storyTitle) { // Wrapper
            return fetchTextFromApi(storyTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) { // Wrapper
            if (!currentStoryTitle) throw new Error("Error interno: No se ha establecido el contexto de la historia para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() { // Fetch 40 titles
            const randomTheme = getRandomElement(crossoverThemes) || "crossovers Marvel y Cartoon Network";
            const specificPrompt = `Genera 40 ideas únicas y emocionantes sobre ${randomTheme}`;
            console.log("Generating 40 titles with prompt:", specificPrompt);
            const configForThisRequest = { ...titleGenerationConfig, seed: Math.floor(Math.random() * 1000000) };
            return fetchTextFromApi(specificPrompt, configForThisRequest, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 200); // Filter length
                     if (titles.length < 10) throw new Error("La IA no generó suficientes ideas de crossover."); // Expect at least some
                     console.log(`Generated ${titles.length} new titles.`);
                     return titles.slice(0, 40); // Ensure max 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Marvel cartoon network crossover";
             // More dynamic prompt blending styles
             const enhancedPrompt = `Dynamic comic book splash page illustration depicting the crossover: '${safePromptText}'. Blend the art style of Marvel Comics with the specific style of the mentioned Cartoon Network show(s). Focus on action, character interaction, or a key moment. Vibrant colors, high energy. Avoid text, logos, watermarks.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, letters, title, logo, caption, watermark, signature, realistic, photograph, 3d render, simple, boring, blurry, low quality, multiple panels, collage";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting ========== (No changes needed)
        function formatExplanationText(rawText) { /* ... */ if(!rawText)return'';let formatted=rawText.trim();formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1');formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('−','-');return`${base}<sup>${cleanExponent}</sup>`});formatted=formatted.replace(/\\rightarrow/g,'&rarr;');formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>');const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0);formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block;let content=block.replace(/\n/g,' ');return`<p>${content}</p>`}).join('');return formatted; }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) {
                document.body.style.overflow = '';
            }
            // Reset scroll of the content area
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState(); // This now also stops the game
        }
        function resetModalState() {
             modalLoadingIndicator.classList.remove('active'); // Hide loading area
             modalStoryContentArea.classList.remove('visible'); // Hide story area
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null;
             // Stop and Reset Game
             stopLoadingGame(); // Ensure game stops and elements reset
             // Ensure fullscreen is hidden
             hideFullscreenImage();
         }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (No changes needed)
        function showFullscreenImage(imgSrc) { if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden'; }
        function hideFullscreenImage() { if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src=''; }

        // ========== CHAT FUNCTIONS ========== (No changes needed)
        function addChatMessage(message, sender) { const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Chat Error: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();} }

        // ========== LOADING MINIGAME: Cosmic Clash (Asteroids Clone) ==========
        const GAME_FPS = 30; // Frames per second
        const SHIP_SIZE = 30; // Ship height
        const SHIP_THRUST = 5; // Acceleration
        const SHIP_TURN_SPD = 360; // Degrees per second
        const FRICTION = 0.7; // Slowdown factor
        const ASTEROID_NUM_START = 3; // Starting asteroids
        const ASTEROID_SPD = 50; // Max starting speed px/s
        const ASTEROID_SIZE = 100; // Max starting size
        const ASTEROID_PTS_LGE = 20;
        const ASTEROID_PTS_MED = 50;
        const ASTEROID_PTS_SML = 100;
        const BULLET_SPD = 500; // Px per second
        const BULLET_MAX = 10; // Max bullets on screen
        const SHIP_INV_DUR = 3; // Invincibility duration seconds
        const SHIP_BLINK_DUR = 0.1; // Blink duration seconds

        let canvas, ctx, ship, asteroids, bullets, score, level, lives, text, textAlpha;
        let keys = { ArrowUp: false, ArrowLeft: false, ArrowRight: false, Space: false };
        let gameLoopInterval = null;

        function initGameVariables() {
            ship = newShip();
            score = 0;
            level = 0;
            lives = 3;
            asteroids = [];
            bullets = [];
            text = "";
            textAlpha = 0;
            createAsteroidBelt();
        }

        function startGameLoop() {
            if (gameLoopInterval) clearInterval(gameLoopInterval); // Clear previous if any
            gameLoopInterval = setInterval(updateGame, 1000 / GAME_FPS);
            console.log("Game loop started.");
        }

        function stopGameLoop() {
            if (gameLoopInterval) {
                clearInterval(gameLoopInterval);
                gameLoopInterval = null;
                console.log("Game loop stopped.");
            }
        }

        function startLoadingGame() {
            console.log("Attempting to start loading game...");
            if (!loadingGameCanvas) {
                 console.error("Game Canvas not found!");
                 loadingSpinnerArea.style.display = 'block'; // Show fallback spinner
                 loadingMessage.textContent = "Error: No se pudo iniciar el juego. Cargando...";
                 return;
             }
            canvas = loadingGameCanvas;
            ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error("Failed to get 2D context for game canvas!");
                loadingSpinnerArea.style.display = 'block';
                loadingMessage.textContent = "Error: No se pudo iniciar el juego. Cargando...";
                 return;
            }

            initGameVariables();
            setupInputListeners();

            // Show game elements, hide spinner
            loadingSpinnerArea.style.display = 'none';
            canvas.style.display = 'block';
            loadingGameInfo.style.display = 'block';
            modalLoadingIndicator.classList.add('active'); // Ensure loading overlay is visible

            startGameLoop();
        }

        function stopLoadingGame() {
            console.log("Stopping loading game...");
            stopGameLoop();
            removeInputListeners();
            if (canvas) canvas.style.display = 'none'; // Hide canvas
            if(loadingGameInfo) loadingGameInfo.style.display = 'none'; // Hide game info
            // Reset loading indicator to default spinner state (in case modal stays open on error)
            if (loadingSpinnerArea) loadingSpinnerArea.style.display = 'block';
             if (loadingMessage) loadingMessage.textContent = "Abriendo portal interdimensional..."; // Reset message
            gameInstance = null; // Clear game state ref
        }

        function setupInputListeners() {
            document.addEventListener("keydown", keyDown);
            document.addEventListener("keyup", keyUp);
        }
        function removeInputListeners() {
            document.removeEventListener("keydown", keyDown);
            document.removeEventListener("keyup", keyUp);
            // Reset keys state
            keys = { ArrowUp: false, ArrowLeft: false, ArrowRight: false, Space: false };
        }

        function keyDown(/** @type {KeyboardEvent} */ ev) {
            if (!gameLoopInterval) return; // Only handle keys if game is running
            switch(ev.key) {
                case "ArrowLeft": keys.ArrowLeft = true; break;
                case "ArrowRight": keys.ArrowRight = true; break;
                case "ArrowUp": keys.ArrowUp = true; break;
                case " ": case "Spacebar": keys.Space = true; break; // Handle space
            }
            // Prevent page scroll with arrow keys/space while game is active
             if (["ArrowLeft", "ArrowRight", "ArrowUp", " ", "Spacebar"].includes(ev.key)) {
                 ev.preventDefault();
             }
        }

        function keyUp(/** @type {KeyboardEvent} */ ev) {
            if (!gameLoopInterval) return;
            switch(ev.key) {
                case "ArrowLeft": keys.ArrowLeft = false; break;
                case "ArrowRight": keys.ArrowRight = false; break;
                case "ArrowUp": keys.ArrowUp = false; break;
                case " ": case "Spacebar": keys.Space = false; break;
            }
        }

        function newShip() {
            return {
                x: canvas.width / 2,
                y: canvas.height / 2,
                r: SHIP_SIZE / 2,
                a: 90 / 180 * Math.PI, // Convert to radians, pointing up
                rot: 0,
                thrusting: false,
                thrust: { x: 0, y: 0 },
                blinkTime: Math.ceil(SHIP_BLINK_DUR * GAME_FPS),
                invDur: Math.ceil(SHIP_INV_DUR * GAME_FPS),
                canShoot: true,
                dead: false
            }
        }

        function shootLaser() {
            if (ship.canShoot && bullets.length < BULLET_MAX) {
                bullets.push({
                    x: ship.x + 4 / 3 * ship.r * Math.cos(ship.a),
                    y: ship.y - 4 / 3 * ship.r * Math.sin(ship.a),
                    xv: BULLET_SPD * Math.cos(ship.a) / GAME_FPS,
                    yv: -BULLET_SPD * Math.sin(ship.a) / GAME_FPS,
                    dist: 0,
                    explodeTime: 0
                });
                ship.canShoot = false; // Prevent holding space
            }
        }

        function distBetweenPoints(x1, y1, x2, y2) {
            return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }

        function createAsteroidBelt() {
            asteroids = [];
            let x, y;
            for (let i = 0; i < ASTEROID_NUM_START + level; i++) {
                do {
                    x = Math.floor(Math.random() * canvas.width);
                    y = Math.floor(Math.random() * canvas.height);
                } while (distBetweenPoints(ship.x, ship.y, x, y) < ASTEROID_SIZE * 2 + ship.r); // Don't spawn on ship
                asteroids.push(newAsteroid(x, y, Math.ceil(ASTEROID_SIZE / 2)));
            }
        }

        function newAsteroid(x, y, r) {
             const lvlMult = 1 + 0.1 * level;
             const roid = {
                 x: x, y: y, r: r,
                 xv: Math.random() * ASTEROID_SPD * lvlMult / GAME_FPS * (Math.random() < 0.5 ? 1 : -1),
                 yv: Math.random() * ASTEROID_SPD * lvlMult / GAME_FPS * (Math.random() < 0.5 ? 1 : -1),
                 a: Math.random() * Math.PI * 2, // Radians
                 vert: Math.floor(Math.random() * 10 + 5), // Vertices
                 offs: [] // Vertex offsets
             };
             // Create vertex offsets array
             for (let i = 0; i < roid.vert; i++) {
                 roid.offs.push(Math.random() * 0.4 + 0.8); // Jaggedness 0.8 to 1.2
             }
             return roid;
         }

         function destroyAsteroid(index) {
             const ax = asteroids[index].x;
             const ay = asteroids[index].y;
             const ar = asteroids[index].r;

             // Split asteroid if large enough
             if (ar === Math.ceil(ASTEROID_SIZE / 2)) { // Large
                 asteroids.push(newAsteroid(ax, ay, Math.ceil(ASTEROID_SIZE / 4)));
                 asteroids.push(newAsteroid(ax, ay, Math.ceil(ASTEROID_SIZE / 4)));
                 score += ASTEROID_PTS_LGE;
             } else if (ar === Math.ceil(ASTEROID_SIZE / 4)) { // Medium
                 asteroids.push(newAsteroid(ax, ay, Math.ceil(ASTEROID_SIZE / 8)));
                 asteroids.push(newAsteroid(ax, ay, Math.ceil(ASTEROID_SIZE / 8)));
                 score += ASTEROID_PTS_MED;
             } else { // Small
                 score += ASTEROID_PTS_SML;
             }

             // Destroy the original asteroid
             asteroids.splice(index, 1);

             // New level when no asteroids left
             if (asteroids.length === 0) {
                 level++;
                 text = `NIVEL ${level + 1}`;
                 textAlpha = 1.0;
                 ship = newShip(); // Reset ship position etc. for new level
                 createAsteroidBelt();
             }
         }

        function updateGame() {
            if (!ctx || !canvas) return;

            const blinkOn = ship.invDur > 0 && ship.blinkTime % 2 === 0;
            let exploding = ship.dead; // Use dead flag for explosion

            // --- Drawing ---
            // Background
            ctx.fillStyle = "#1a202c";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Ship (if not exploding)
             if (!exploding) {
                 if (blinkOn) {
                    ctx.strokeStyle = "white"; // Blinking color
                    ctx.fillStyle = "white";
                    ctx.lineWidth = SHIP_SIZE / 20;
                    ctx.beginPath();
                    // Nose
                    ctx.moveTo(
                        ship.x + 4 / 3 * ship.r * Math.cos(ship.a),
                        ship.y - 4 / 3 * ship.r * Math.sin(ship.a)
                    );
                    // Rear left
                    ctx.lineTo(
                        ship.x - ship.r * (2 / 3 * Math.cos(ship.a) + Math.sin(ship.a)),
                        ship.y + ship.r * (2 / 3 * Math.sin(ship.a) - Math.cos(ship.a))
                    );
                     // Rear right
                     ctx.lineTo(
                         ship.x - ship.r * (2 / 3 * Math.cos(ship.a) - Math.sin(ship.a)),
                         ship.y + ship.r * (2 / 3 * Math.sin(ship.a) + Math.cos(ship.a))
                     );
                     ctx.closePath();
                     ctx.stroke();
                     ctx.fill();
                 }

                 // Thrust flame
                 if (ship.thrusting && !ship.dead) {
                     ctx.fillStyle = "red";
                     ctx.strokeStyle = "yellow";
                     ctx.lineWidth = SHIP_SIZE / 10;
                     ctx.beginPath();
                     // Rear center
                     ctx.moveTo(
                         ship.x - ship.r * (2 / 3 * Math.cos(ship.a) + 0.5 * Math.sin(ship.a)),
                         ship.y + ship.r * (2 / 3 * Math.sin(ship.a) - 0.5 * Math.cos(ship.a))
                     );
                     // Flame point (behind ship)
                     ctx.lineTo(
                         ship.x - ship.r * 6 / 3 * Math.cos(ship.a),
                         ship.y + ship.r * 6 / 3 * Math.sin(ship.a)
                     );
                     // Rear center
                     ctx.lineTo(
                         ship.x - ship.r * (2 / 3 * Math.cos(ship.a) - 0.5 * Math.sin(ship.a)),
                         ship.y + ship.r * (2 / 3 * Math.sin(ship.a) + 0.5 * Math.cos(ship.a))
                     );
                     ctx.closePath();
                     ctx.fill();
                     ctx.stroke();
                 }
             } else {
                 // Draw explosion (simple expanding circle)
                 ctx.fillStyle = "darkred";
                 ctx.beginPath();
                 ctx.arc(ship.x, ship.y, ship.r * 1.4, 0, Math.PI * 2, false);
                 ctx.fill();
                 ctx.fillStyle = "red";
                 ctx.beginPath();
                 ctx.arc(ship.x, ship.y, ship.r * 1.1, 0, Math.PI * 2, false);
                 ctx.fill();
                 ctx.fillStyle = "orange";
                 ctx.beginPath();
                 ctx.arc(ship.x, ship.y, ship.r * 0.8, 0, Math.PI * 2, false);
                 ctx.fill();
                 ctx.fillStyle = "yellow";
                 ctx.beginPath();
                 ctx.arc(ship.x, ship.y, ship.r * 0.5, 0, Math.PI * 2, false);
                 ctx.fill();
             }

            // Asteroids
            ctx.strokeStyle = "slategrey";
            ctx.lineWidth = SHIP_SIZE / 20;
            let ax, ay, ar, aVert, aOffs;
            for (let i = 0; i < asteroids.length; i++) {
                ax = asteroids[i].x;
                ay = asteroids[i].y;
                ar = asteroids[i].r;
                aVert = asteroids[i].vert;
                aOffs = asteroids[i].offs;
                // Draw path
                ctx.beginPath();
                ctx.moveTo(
                    ax + ar * aOffs[0] * Math.cos(asteroids[i].a),
                    ay + ar * aOffs[0] * Math.sin(asteroids[i].a)
                );
                // Draw polygon
                for (let j = 1; j < aVert; j++) {
                    ctx.lineTo(
                        ax + ar * aOffs[j] * Math.cos(asteroids[i].a + j * Math.PI * 2 / aVert),
                        ay + ar * aOffs[j] * Math.sin(asteroids[i].a + j * Math.PI * 2 / aVert)
                    );
                }
                ctx.closePath();
                ctx.stroke();
            }

             // Bullets
             ctx.fillStyle = "salmon";
             for (let i = 0; i < bullets.length; i++) {
                 ctx.beginPath();
                 ctx.arc(bullets[i].x, bullets[i].y, SHIP_SIZE / 15, 0, Math.PI * 2, false);
                 ctx.fill();
             }

             // Game Text (Level, Game Over)
             if (textAlpha >= 0) {
                  ctx.textAlign = "center";
                  ctx.textBaseline = "middle";
                  ctx.fillStyle = `rgba(255, 255, 255, ${textAlpha})`;
                  ctx.font = "bold " + (SHIP_SIZE * 1.5) + "px Bangers"; // Use themed font
                  ctx.fillText(text, canvas.width / 2, canvas.height * 0.75);
                  textAlpha -= (1.0 / GAME_FPS / 2); // Fade out over 2 seconds
              } else if (ship.dead && lives <= 0) {
                 text = "GAME OVER";
                 ctx.textAlign = "center";
                 ctx.textBaseline = "middle";
                 ctx.fillStyle = "rgba(255, 0, 0, 1)"; // Red for Game Over
                 ctx.font = "bold " + (SHIP_SIZE * 2) + "px Bangers";
                 ctx.fillText(text, canvas.width / 2, canvas.height / 2);
              }

             // Score and Lives
             ctx.textAlign = "right";
             ctx.textBaseline = "middle";
             ctx.fillStyle = "white";
             ctx.font = (SHIP_SIZE * 0.75) + "px Poppins"; // Readable font
             ctx.fillText("Score: " + score, canvas.width - SHIP_SIZE / 2, SHIP_SIZE);
             ctx.textAlign = "left";
             ctx.fillText("Nivel: " + (level + 1), SHIP_SIZE / 2, SHIP_SIZE);
             // Draw lives (simple ship icons)
              let lifeColour;
              for (let i = 0; i < lives; i++) {
                 lifeColour = exploding && i === lives - 1 ? "red" : "white"; // Last life red if exploding
                 ctx.strokeStyle = lifeColour;
                 ctx.lineWidth = SHIP_SIZE / 20;
                 ctx.beginPath();
                 // Nose
                 ctx.moveTo(
                     SHIP_SIZE + i * SHIP_SIZE * 1.2 + SHIP_SIZE * 0.5,
                     SHIP_SIZE * 2.2 - SHIP_SIZE * 0.87
                 );
                 // Rear left
                 ctx.lineTo(
                     SHIP_SIZE + i * SHIP_SIZE * 1.2 + SHIP_SIZE * 0.5 - SHIP_SIZE * 0.5 * (2/3 * 1 + 0), // Simplified rotation at 90deg
                     SHIP_SIZE * 2.2 + SHIP_SIZE * 0.5 * (2/3 * 0 - 1)
                 );
                  // Rear right
                  ctx.lineTo(
                     SHIP_SIZE + i * SHIP_SIZE * 1.2 + SHIP_SIZE * 0.5 - SHIP_SIZE * 0.5 * (2/3 * 1 - 0),
                     SHIP_SIZE * 2.2 + SHIP_SIZE * 0.5 * (2/3 * 0 + 1)
                 );
                 ctx.closePath();
                 ctx.stroke();
              }

             // --- Movement & Logic ---
             if (!exploding) {
                 // Rotate ship
                 ship.a += (keys.ArrowLeft ? -1 : keys.ArrowRight ? 1 : 0) * SHIP_TURN_SPD / 180 * Math.PI / GAME_FPS;

                 // Thrust
                 ship.thrusting = keys.ArrowUp;
                 if (ship.thrusting) {
                     ship.thrust.x += SHIP_THRUST * Math.cos(ship.a) / GAME_FPS;
                     ship.thrust.y -= SHIP_THRUST * Math.sin(ship.a) / GAME_FPS;
                 } else {
                     // Friction (slow down)
                     ship.thrust.x -= FRICTION * ship.thrust.x / GAME_FPS;
                     ship.thrust.y -= FRICTION * ship.thrust.y / GAME_FPS;
                 }

                 // Move ship
                 ship.x += ship.thrust.x;
                 ship.y += ship.thrust.y;

                 // Handle screen edges (wrap around)
                 if (ship.x < 0 - ship.r) ship.x = canvas.width + ship.r;
                 else if (ship.x > canvas.width + ship.r) ship.x = 0 - ship.r;
                 if (ship.y < 0 - ship.r) ship.y = canvas.height + ship.r;
                 else if (ship.y > canvas.height + ship.r) ship.y = 0 - ship.r;

                 // Shooting
                 if (keys.Space) shootLaser(); else ship.canShoot = true;

                 // Invincibility blink
                 if (ship.invDur > 0) {
                     ship.invDur--;
                     ship.blinkTime = ship.invDur % Math.ceil(SHIP_BLINK_DUR * GAME_FPS * 2);
                 }
             } else {
                 // Reduce lives after explosion animation
                 ship.invDur = 0; // Not invincible anymore
                 if (ship.dead && lives > 0) { // Need a delay or flag for explosion animation end
                      lives--;
                      if (lives === 0) {
                           // Game Over logic moved to drawing section
                      } else {
                          ship = newShip(); // Respawn
                      }
                 }
                 ship.dead = false; // Reset dead flag after processing
             }

             // Move bullets
             for (let i = bullets.length - 1; i >= 0; i--) {
                 bullets[i].x += bullets[i].xv;
                 bullets[i].y += bullets[i].yv;
                 // Remove bullets that go off screen (simple distance)
                 if (bullets[i].x < 0 || bullets[i].x > canvas.width || bullets[i].y < 0 || bullets[i].y > canvas.height) {
                      bullets.splice(i, 1);
                  }
             }

             // Move asteroids
             for (let i = 0; i < asteroids.length; i++) {
                 asteroids[i].x += asteroids[i].xv;
                 asteroids[i].y += asteroids[i].yv;
                 // Wrap edges
                 if (asteroids[i].x < 0 - asteroids[i].r) asteroids[i].x = canvas.width + asteroids[i].r;
                 else if (asteroids[i].x > canvas.width + asteroids[i].r) asteroids[i].x = 0 - asteroids[i].r;
                 if (asteroids[i].y < 0 - asteroids[i].r) asteroids[i].y = canvas.height + asteroids[i].r;
                 else if (asteroids[i].y > canvas.height + asteroids[i].r) asteroids[i].y = 0 - asteroids[i].r;
             }

             // --- Collision Detection ---
             // Bullets vs Asteroids
             for (let i = asteroids.length - 1; i >= 0; i--) {
                 ax = asteroids[i].x;
                 ay = asteroids[i].y;
                 ar = asteroids[i].r;
                 for (let j = bullets.length - 1; j >= 0; j--) {
                     if (distBetweenPoints(ax, ay, bullets[j].x, bullets[j].y) < ar) {
                         // Remove bullet
                         bullets.splice(j, 1);
                         // Destroy asteroid
                         destroyAsteroid(i);
                         break; // Move to next asteroid
                     }
                 }
             }

             // Ship vs Asteroids
             if (!exploding && ship.invDur === 0) { // Only check if not invincible/exploding
                  for (let i = 0; i < asteroids.length; i++) {
                      if (distBetweenPoints(ship.x, ship.y, asteroids[i].x, asteroids[i].y) < ship.r + asteroids[i].r) {
                          ship.dead = true; // Set dead flag for explosion in next frame
                          destroyAsteroid(i); // Asteroid also breaks
                          break;
                      }
                  }
             }
        }
        // ========== END OF MINIGAME CODE ==========

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Sort for consistency, maybe random shuffle is more fun? Let's keep sorted.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-poppins">No hay premisas disponibles. ¡El Multiverso está vacío!</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => {
                 if (!existingTitles.has(title)) {
                     titleListContainer.appendChild(createTitleItem(title));
                     addedCount++;
                 }
             });
             console.log(`Added ${addedCount} new unique titles.`);
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick to integrate game start/stop ***
        async function handleTitleClick(title) {
            resetModalState(); // Reset everything, including stopping previous game
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // Set chat context
            modalError.classList.add('content-hidden');
            chatHistory.innerHTML = '';

            // *** START LOADING & GAME ***
            modalLoadingIndicator.classList.add('active'); // Show loading overlay
            startLoadingGame(); // Attempt to start the game

            try {
                // Fetch story in parallel with game running
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                 // *** STOP GAME, HIDE LOADING, SHOW CONTENT ***
                 stopLoadingGame(); // Stop game now that API call is done
                 modalLoadingIndicator.classList.remove('active'); // Hide loading overlay
                 modalContent.innerHTML = formattedExplanation; // Add text
                 modalStoryContentArea.classList.add('visible'); // Show the main area (text + chat)

                 modalTextArea.scrollTop = 0; // Reset scroll AFTER content is visible
                 console.log("Scroll set to 0 after content visible");

                // Prepare image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><p style="font-size:0.8em;margin-top:0.5rem;">Creando visualización...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Create and load image
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración crossover: ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Fallo al crear imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                    placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                 // *** STOP GAME ON ERROR TOO ***
                 stopLoadingGame();
                 modalLoadingIndicator.classList.remove('active'); // Hide loading overlay

                modalErrorMessage.textContent = error.message || "¡Algo salió mal al cargar esta realidad!";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.add('visible'); // Show area to display error
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden'); // Hide chat on main error
            }
        }

        // *** MODIFIED: Generate 40 titles ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Explorando el Multiverso...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches up to 40
                 if (newTitles && newTitles.length > 0) {
                     appendTitles(newTitles);
                 } else {
                     alert("No se pudieron generar nuevas realidades en este momento. ¡Intenta más tarde!");
                 }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar realidades: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Update button text to reflect it asks for 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Generar 40 Nuevas Realidades';
             }
         }

         // Search Filter Function (handle accents)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check all elements, including game canvas
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalLoadingIndicator || !loadingGameCanvas || !loadingGameInfo || !loadingSpinnerArea) {
                console.error("Initialization failed: Missing essential UI or Game elements.");
                document.body.innerHTML = '<p style="color: var(--color-marvel-red); font-size: 1.8em; text-align: center; padding-top: 3em; font-family: Bangers;">¡ERROR CATASTRÓFICO! Faltan componentes del Nexus.</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');

            console.log("Crossover Nexus Initialized. Ready for interdimensional fun!");
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>