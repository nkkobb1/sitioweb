<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conceptos Avanzados de Química - Enciclopedia Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y legibles -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Química Avanzada --- */
        :root {
            --color-primary: #0891b2; /* Cyan/Teal Oscuro (Principal) */
            --color-secondary: #059669; /* Verde Esmeralda (Secundario) */
            --color-tertiary: #6366f1; /* Indigo (Énfasis) */
            --color-background: #f8fafc; /* Gris Muy Claro (Fondo) */
            --color-text: #1f2937; /* Gris Muy Oscuro (Texto principal) */
            --color-text-muted: #6b7280; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco (Modal) */
            --color-border: #e5e7eb; /* Borde Gris Claro */
            --color-error-bg: #fef2f2; /* Fondo error rojo muy claro */
            --color-error-text: #991b1b; /* Texto error rojo oscuro */
            --color-error-border: #fecaca; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 4px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; /* Espacio para icono */ border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Lato'; font-size: 0.95rem; border-left: 3px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-border); border-left-color: var(--color-primary); color: var(--color-primary); background-color: #f0f9ff; /* Azul muy claro hover */ }
        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.7rem 1.4rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #06b6d4; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #f3f4f6; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; transform: scale(1.1); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final + Chat abajo) */
        #modal-story-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; }

        /* Área Scrollable (Texto + Imagen) */
        #modal-content-area { flex-grow: 1; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem; min-height: 150px; /* Altura mínima para que exista el scroll */
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 500; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-secondary); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        #modal-content .formula { font-family: 'Courier New', Courier, monospace; background-color: #f9fafb; padding: 0.8em; border: 1px solid var(--color-border); border-radius: var(--border-radius); margin: 1em 0; overflow-x: auto; text-align: center; }
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(209, 213, 219, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 200px; /* Altura del chat ajustada */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95em;}
        .user-message { background-color: var(--color-tertiary); color: #fff; margin-left: auto; text-align: left; } /* Cambiado a left para consistencia */
        .ai-message { background-color: #e0f2fe; /* Azul Hielo */ color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.3rem;}
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(8, 145, 178, 0.15);}
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: #fff; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #06b6d4; }
        #chat-send-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #e5e7eb; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1.5rem auto; }
        #modal-loading p { font-weight: 500; color: var(--color-text); font-size: 1.2rem; font-family: 'Roboto'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-modal-bg); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: #fff; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fas fa-flask mr-2"></i> <!-- Icono Matraz -->
                     Química Avanzada
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">» Enciclopedia Interactiva «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-5">Explora los Límites de la Química</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Sumérgete en los conceptos fundamentales y las fronteras de la investigación química moderna. Selecciona un tema o utiliza el buscador.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar concepto químico...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-atom text-cyan-600 mr-2"></i> <!-- Icono Átomo -->
                 Índice de Conceptos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando conceptos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No se encontraron conceptos para tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Generar Más Conceptos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Cargando explicación...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text/Image + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image placeholder/image added here by JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history">
                         <!-- Chat messages -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Pensando...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre este concepto...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Explicaciones generadas por IA con fines educativos y de referencia sobre química avanzada.</p>
              <p class="mt-1">Verifica siempre la información con fuentes académicas revisadas por pares.</p>
              <p class="mt-2">© 2025 Enciclopedia Química Interactiva</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        // *** Exhaustive List of Advanced Chemistry Concepts ***
        const predefinedTitles = [
            // Physical Chemistry - Quantum Mechanics
            "Ecuación de Schrödinger Independiente del Tiempo", "Operadores Cuánticos (Posición, Momento, Hamiltoniano)", "Postulados de la Mecánica Cuántica", "Partícula en una Caja (1D, 3D)", "Oscilador Armónico Cuántico", "Rotor Rígido", "Átomo de Hidrógeno: Solución Cuántica", "Momento Angular Orbital y de Espín", "Principio de Exclusión de Pauli", "Determinantes de Slater", "Teoría de Perturbaciones Independiente del Tiempo", "Teoría de Perturbaciones Dependiente del Tiempo", "Método Variacional", "Aproximación de Born-Oppenheimer", "Orbitales Atómicos (s, p, d, f)", "Teoría del Enlace de Valencia (VB)", "Teoría de Orbitales Moleculares (MO)", "Diagramas de Orbitales Moleculares (Diatómicas Homonucleares)", "Diagramas de Orbitales Moleculares (Diatómicas Heteronucleares)", "Método Hückel para Sistemas Pi", "Teoría del Funcional de la Densidad (DFT) - Introducción", "Funcionales de Intercambio-Correlación (LDA, GGA, Híbridos)", "Conjuntos de Bases (STO-nG, Pople, Dunning)",
            // Physical Chemistry - Thermodynamics & Statistical Mechanics
            "Leyes de la Termodinámica (Repaso Avanzado)", "Potenciales Termodinámicos (U, H, G, A)", "Ecuaciones de Maxwell Termodinámicas", "Termodinámica Estadística: Colectividades (Microcanónica, Canónica, Gran Canónica)", "Función de Partición Molecular", "Función de Partición Traslacional, Rotacional, Vibracional, Electrónica", "Cálculo de Propiedades Termodinámicas desde Funciones de Partición", "Estadísticas de Bose-Einstein y Fermi-Dirac", "Teoría de Gases Reales: Ecuación Virial", "Termodinámica de Soluciones No Ideales: Actividad y Coeficientes de Actividad", "Equilibrio de Fases: Regla de las Fases de Gibbs", "Diagramas de Fases Avanzados (Binarios, Ternarios)", "Fenómenos Críticos y Transiciones de Fase", "Termodinámica de Superficies e Interfaces", "Termodinámica de Procesos Irreversibles",
            // Physical Chemistry - Kinetics & Dynamics
            "Teoría de las Colisiones Moleculares", "Teoría del Estado de Transición (TST)", "Superficies de Energía Potencial (PES)", "Dinámica de Reacciones Moleculares", "Catálisis Homogénea y Heterogénea", "Mecanismos de Reacción Complejos (Aproximación Estado Estacionario, Pre-equilibrio)", "Cinética Enzimática: Ecuación de Michaelis-Menten", "Inhibición Enzimática (Competitiva, No Competitiva, Acompetitiva)", "Fotocatálisis", "Electrocatálisis", "Reacciones Oscilantes (Belousov-Zhabotinsky)", "Cinética de Reacciones en Fase Gaseosa", "Cinética de Reacciones en Solución: Efecto Jaula", "Química de Superficies: Adsorción (Fisisorción, Quimisorción)", "Isotermas de Adsorción (Langmuir, Freundlich, BET)", "Reactividad en Superficies Catalíticas", "Dinámica Molecular (Simulaciones MD)", "Métodos Monte Carlo en Cinética",
            // Physical Chemistry - Spectroscopy
            "Espectroscopía Rotacional (Microondas): Moléculas Diatómicas y Poliatómicas", "Espectroscopía Vibracional (Infrarrojo y Raman): Modos Normales", "Anarmonicidad y Acoplamiento Vibracional", "Espectroscopía Electrónica (UV-Vis): Transiciones Electrónicas", "Principio de Franck-Condon", "Fluorescencia y Fosforescencia: Diagrama de Jablonski", "Espectroscopía Fotoelectrónica (PES: UPS, XPS)", "Resonancia Magnética Nuclear (RMN): Principios Avanzados", "Desplazamiento Químico y Acoplamiento Espín-Espín (J-coupling)", "Experimentos de RMN 1D (DEPT)", "Experimentos de RMN 2D (COSY, HSQC, HMBC, NOESY)", "RMN de Estado Sólido", "Resonancia de Espín Electrónico (EPR/ESR)", "Espectrometría de Masas (EM): Ionización (EI, CI, ESI, MALDI)", "Analizadores de Masas (Sector Magnético, Cuadrupolo, Tiempo de Vuelo TOF, Trampa Iónica, FT-ICR)", "EM de Alta Resolución y EM en Tándem (MS/MS)", "Dicroísmo Circular (CD)", "Espectroscopía Mössbauer",
            // Organic Chemistry - Synthesis & Reactions
            "Retrosíntesis y Desconexiones", "Sintones y Equivalentes Sintéticos", "Grupos Protectores en Síntesis Orgánica", "Química Organometálica en Síntesis (Grignard, Organolitio, Gilman, Organocobre)", "Reacciones de Acoplamiento Cruzado Catalizadas por Paladio (Suzuki, Heck, Stille, Sonogashira)", "Metátesis de Olefinas (Grubbs, Schrock)", "Química de Carbenos y Nitrenos", "Reacciones Pericíclicas (Cicloadiciones [4+2], [2+2], Reacciones Electroclíclicas, Sigmatrópicas)", "Reglas de Woodward-Hoffmann", "Teoría de Orbitales Moleculares de Frontera (FMO)", "Reacciones Radicalarias Avanzadas (Iniciación, Propagación, Terminación)", "Química de Heterociclos: Síntesis y Reactividad", "Síntesis Asimétrica: Auxiliares Quirales", "Catálisis Asimétrica (Hidrogenación, Epoxidación)", "Organocatálisis Asimétrica", "Síntesis de Productos Naturales Complejos (Estrategias)", "Reacciones Multicomponente", "Química Click", "Química de Flujo Continuo", "Fotoquímica Orgánica: Reacciones y Mecanismos",
            // Organic Chemistry - Structure & Mechanism
            "Estereoquímica Avanzada: Isomería Conformacional (Cicloalcanos, A-values)", "Proquiralidad y Tópicos (Homotópico, Enantiotópico, Diastereotópico)", "Determinación de Configuración Absoluta (Reglas CIP Avanzadas)", "Análisis Conformacional y Reactividad", "Efectos Estéricos y Electrónicos en Reactividad", "Intermedios de Reacción (Carbocationes, Carbaniones, Radicales, Carbenos)", "Estudio de Mecanismos de Reacción: Métodos Cinéticos", "Efectos Isotópicos Cinéticos (KIE)", "Ecuaciones de Hammett y Relaciones Lineales de Energía Libre (LFER)", "Catálisis Ácida y Básica Específica y General", "Química Física Orgánica", "Química Supramolecular: Reconocimiento Molecular", "Autoensamblaje Molecular", "Máquinas Moleculares",
            // Inorganic Chemistry - Coordination Chemistry
            "Teoría del Campo Cristalino (CFT)", "Desdoblamiento del Campo Cristalino (Octaédrico, Tetraédrico, Plano Cuadrado)", "Energía de Estabilización del Campo Cristalino (CFSE)", "Serie Espectroquímica", "Efecto Jahn-Teller (Estático y Dinámico)", "Teoría del Campo Ligando (LFT)", "Diagramas de Tanabe-Sugano", "Propiedades Magnéticas de Complejos de Coordinación (Paramagnetismo, Diamagnetismo)", "Mecanismos de Reacción de Complejos de Coordinación (Sustitución, Redox)", "Mecanismos Asociativo, Disociativo e Intercambio (Ia, Id)", "Efecto Trans", "Reacciones Redox de Esfera Interna y Externa (Teoría de Marcus)", "Química Bioinorgánica: Metales en Sistemas Biológicos (Hemoglobina, Citocromos)", "Centros Hierro-Azufre", "Fotosíntesis: Complejo Evolucionador de Oxígeno", "Transporte y Almacenamiento de Metales", "Toxicidad de Metales y Quelatoterapia", "Complejos Metálicos como Fármacos (Cisplatino)",
            // Inorganic Chemistry - Organometallics & Solid State
            "Química Organometálica: Regla de los 18 Electrones", "Tipos de Ligandos Organometálicos (Sigma-dadores, Pi-aceptores)", "Reacciones Fundamentales: Adición Oxidativa, Eliminación Reductora, Inserción Migratoria", "Catálisis Homogénea con Compuestos Organometálicos (Hidrogenación, Hidroformilación)", "Química Inorgánica del Estado Sólido: Estructuras Cristalinas (Cúbica Simple, BCC, FCC, HCP)", "Índices de Miller", "Difracción de Rayos X (Ley de Bragg, Polvo, Monocristal)", "Defectos Puntuales en Sólidos (Schottky, Frenkel)", "Propiedades Electrónicas de Sólidos: Teoría de Bandas (Conductores, Semiconductores, Aislantes)", "Semiconductores Intrínsecos y Extrínsecos (Dopaje n y p)", "Materiales Magnéticos (Ferro-, Anti-ferro-, Ferrimagnetismo)", "Superconductividad", "Materiales Porosos: Zeolitas y MOFs (Metal-Organic Frameworks)", "Química de los Elementos del Bloque f (Lantánidos y Actínidos)",
            // Analytical Chemistry
            "Cromatografía Líquida de Alta Resolución (HPLC): Modos (Fase Reversa, Normal, Intercambio Iónico, Exclusión Molecular)", "Optimización de Separaciones HPLC", "Cromatografía de Gases (GC): Columnas Capilares, Detectores (FID, TCD, ECD, MS)", "GC-MS y LC-MS: Técnicas de Interfaz y Aplicaciones", "Electroforesis Capilar (CE)", "Técnicas Avanzadas de Espectrometría de Masas (Trampas Iónicas, Orbitrap)", "Análisis Cuantitativo por EM", "Métodos Electroanalíticos: Voltametría Cíclica (CV)", "Potenciometría: Electrodos Selectivos de Iones (ISE)", "Amperometría y Coulometría", "Espectroscopía de Impedancia Electroquímica (EIS)", "Métodos de Análisis de Superficies (XPS, AES, SIMS, AFM, STM)", "Quimiometría: Análisis de Componentes Principales (PCA)", "Calibración Multivariante (PLS)", "Validación de Métodos Analíticos", "Aseguramiento de la Calidad (QA/QC) en Análisis Químico",
            // Biochemistry
            "Estructura y Función de Proteínas: Niveles (Primario, Secundario, Terciario, Cuaternario)", "Plegamiento de Proteínas y Chaperonas", "Enfermedades de Mal Plegamiento (Priones, Alzheimer)", "Cinética Enzimática Avanzada: Ecuaciones de Estado Estacionario Complejas", "Regulación Enzimática Alostérica (Modelos MWC y KNF)", "Mecanismos Catalíticos Enzimáticos (Catálisis Ácido-Base, Covalente, Ión Metálico)", "Coenzimas y Vitaminas", "Estructura y Química de Ácidos Nucleicos (DNA, RNA)", "Replicación, Transcripción y Traducción del DNA (Mecanismos Detallados)", "Reparación del DNA", "Tecnología del DNA Recombinante", "PCR y Secuenciación de DNA (Sanger, NGS)", "Metabolismo de Carbohidratos: Glucólisis, Gluconeogénesis, Ciclo de Krebs (Regulación Detallada)", "Cadena de Transporte de Electrones y Fosforilación Oxidativa", "Metabolismo de Lípidos: Beta-Oxidación, Síntesis de Ácidos Grasos", "Metabolismo de Aminoácidos y Ciclo de la Urea", "Fotosíntesis: Reacciones Luminosas y Ciclo de Calvin", "Vías de Señalización Celular (Receptores Acoplados a Proteínas G, Tirosina Quinasas)", "Biología Química: Sondas Químicas para Sistemas Biológicos",
            // Theoretical & Computational Chemistry
            "Métodos Hartree-Fock (HF) y Post-Hartree-Fock (CI, MPn, CC)", "Teoría del Funcional de la Densidad (DFT): Teoremas de Hohenberg-Kohn", "Aproximación de Kohn-Sham", "Simulaciones de Dinámica Molecular (MD): Algoritmos (Verlet)", "Campos de Fuerza (Force Fields)", "Cálculo de Energías Libres (Perturbación, Integración Termodinámica)", "Métodos Monte Carlo (MC): Muestreo de Metropolis", "Química Cuántica Relativista", "Métodos QM/MM (Quantum Mechanics/Molecular Mechanics)", "Diseño de Fármacos Asistido por Computadora (CADD)", "Docking Molecular", "Relaciones Cuantitativas Estructura-Actividad (QSAR)",
            // Materials Chemistry
            "Química de Polímeros: Tipos de Polimerización (Adición, Condensación)", "Caracterización de Polímeros (Masa Molecular, Polidispersidad, Tg, Tm)", "Polímeros Conductores", "Polímeros Cristal Líquido", "Nanomateriales: Síntesis (Top-down, Bottom-up)", "Nanopartículas Metálicas y Semiconductoras (Quantum Dots)", "Nanotubos de Carbono y Grafeno", "Materiales Cerámicos Avanzados", "Materiales Compuestos (Composites)", "Biomateriales", "Materiales para Almacenamiento de Energía (Baterías, Supercondensadores)", "Materiales Fotovoltaicos (Células Solares)", "Materiales Inteligentes (Smart Materials)", "Catálisis Heterogénea y Diseño de Catalizadores", "Autoensamblaje y Nanofabricación",
            // Interdisciplinary & Specialized Topics
            "Astroquímica: Formación de Moléculas en el Espacio", "Geoquímica: Ciclos Biogeoquímicos", "Química Ambiental: Química Atmosférica (Ozono, Smog)", "Contaminación del Agua y Suelo", "Química Verde: Principios y Aplicaciones", "Radioquímica y Química Nuclear: Decaimiento Radioactivo, Reacciones Nucleares", "Química Forense", "Química de Alimentos", "Cristalografía de Rayos X: Resolución de Estructuras", "Microscopía Electrónica (SEM, TEM) en Química", "Espectroscopía de Fuerza Atómica (AFM) para Caracterización Química", "Resonancia de Plasmón Superficial (SPR)", "Química Combinatoria", "Química de Flujo"
            // Exhaustive? Getting there! ~300+ concepts listed.
        ];
        const chemistryThemes = [
            "mecánica cuántica aplicada a química", "termodinámica estadística", "cinética química avanzada", "espectroscopía molecular", "RMN avanzada", "espectrometría de masas avanzada", "síntesis orgánica compleja", "reacciones pericíclicas", "química organometálica", "catálisis asimétrica", "química supramolecular", "química de coordinación", "teoría del campo ligando", "química bioinorgánica", "química del estado sólido", "química de superficies", "métodos electroanalíticos", "cromatografía avanzada", "quimiometría", "estructura y función de proteínas", "cinética enzimática avanzada", "química de ácidos nucleicos", "metabolismo energético", "vías de señalización celular", "química computacional", "DFT", "dinámica molecular", "química de polímeros", "nanomateriales", "química de materiales", "química ambiental", "astroquímica", "química nuclear", "cristalografía"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral", // Consider 'gpt-4' via compatible API if higher accuracy needed for complexity
            systemPrompt: "Eres un catedrático de Química especializado en conceptos avanzados. Explica el siguiente tema de forma rigurosa, clara y detallada, como lo harías en un curso de posgrado. Incluye: definición precisa, principios fundamentales subyacentes, formalismo matemático relevante (simplificado si es posible, mencionando ecuaciones clave), aplicaciones importantes, técnicas experimentales asociadas, limitaciones o áreas de investigación activa. Usa terminología científica correcta. El objetivo es una explicación profunda de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente concepto avanzado de química:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny", // Keep chat model potentially faster
             systemPrompt: "Actúa como un asistente de cátedra especializado únicamente en el concepto químico avanzado que se está discutiendo. Responde preguntas de seguimiento sobre detalles específicos, clarificaciones, o conexiones con otros conceptos mencionados. Sé preciso, conciso y mantente estrictamente dentro del tema actual.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para un compendio de química avanzada. Genera exactamente 15 nombres de conceptos químicos específicos, teorías, técnicas espectroscópicas o de síntesis de nivel avanzado, adecuados para una explicación detallada. Devuelve *solo* la lista de nombres/conceptos, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        // (No changes needed from previous version - IDs remain the same)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        // ... (rest of DOM elements are the same)
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Scrollable text/image area
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentConceptTitle = null; // Renamed for clarity

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            // *** DYNAMIC SYSTEM PROMPT FOR CHAT ***
            const systemPromptToUse = isChat && currentConceptTitle
                ? `Eres un asistente de cátedra especializado únicamente en el concepto químico avanzado: '${currentConceptTitle}'. Responde preguntas de seguimiento sobre detalles específicos, clarificaciones, o conexiones con otros conceptos mencionados. Sé preciso, conciso y mantente estrictamente dentro del tema actual.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores pueden estar experimentando alto tráfico. Por favor, inténtalo de nuevo en unos momentos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta reformular la pregunta o el concepto.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar los servidores de IA.");
            }
        }
        // Wrapper functions for clarity
        async function fetchExplanationText(conceptTitle) {
            return fetchTextFromApi(conceptTitle, textApiConfig, false);
        }
        async function fetchChatResponse(userQuery) {
            if (!currentConceptTitle) throw new Error("Error interno: No se ha establecido el contexto del concepto para el chat.");
            return fetchTextFromApi(userQuery, chatApiConfig, true);
        }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(chemistryThemes) || "química avanzada general";
            const specificPrompt = `Genera 15 nombres de conceptos o técnicas específicas sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                .then(text => {
                    const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                    if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de conceptos.");
                    return titles.slice(0, 15);
                });
        }
        // *** Image generation prompt adapted for chemistry ***
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "abstract chemistry concept";
            // ** CRUCIAL: Prompt avoids asking for text/formulas **
            const enhancedPrompt = `Abstract visualization or conceptual art inspired by the advanced chemistry concept: '${safePromptText}'. Focus on molecular structures (stylized), energy landscapes, reaction pathways (conceptual), quantum effects, or laboratory instrumentation (artistic). Use a clean, scientific aesthetic. NO TEXT, NO LABELS, NO FORMULAS, NO EQUATIONS, NO GRAPHS.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            // ** CRUCIAL: Negative prompt reinforces exclusions **
            const negativePrompt = "text, words, labels, letters, titles, captions, writing, numbers, formulas, equations, graphs, charts, diagrams, textbook illustration, simple drawing, blurry, low quality, signature, watermark, people";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ==========
        // (No changes needed, but ensure .formula style handles potential math markup if AI uses it differently)
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            // Basic Markdown and LaTeX-like cleanup
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); // Remove \text{}
            formatted = formatted.replace(/(\w)_\{?([\w\d]+)\}?/g, '$1<sub>$2</sub>'); // Subscripts like H_2O
            formatted = formatted.replace(/(\w)\^\{?([\w\d+\-−*]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); // Superscripts like Fe^{2+}
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); // Right arrow
            formatted = formatted.replace(/\\leftrightarrow/g, '&harr;'); // Equilibrium arrow
            formatted = formatted.replace(/\\Rightarrow/g, '&rArr;'); // Implies arrow
            formatted = formatted.replace(/\\approx/g, '&approx;'); // Approximately equal
            formatted = formatted.replace(/\\pm/g, '&plusmn;'); // Plus/minus
            formatted = formatted.replace(/\\times/g, '&times;'); // Multiplication sign
            formatted = formatted.replace(/\\cdot/g, '&middot;'); // Dot product
            formatted = formatted.replace(/\\Delta/g, '&Delta;'); // Delta symbol
            formatted = formatted.replace(/\\nu/g, '&nu;'); // Nu symbol (frequency)
            // Handle potential block math environments (simplistic approach)
            formatted = formatted.replace(/\\\[([\s\S]*?)\\\]/g, (match, content) => `<p class="formula">${content.trim().replace(/\n/g, '<br>')}</p>`);
            formatted = formatted.replace(/\$\$([\s\S]*?)\$\$/g, (match, content) => `<p class="formula">${content.trim().replace(/\n/g, '<br>')}</p>`);

            // Headings
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            // Bold and Italic
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Paragraphs (split by double newline)
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.includes('class="formula"')) return block; // Keep existing elements
                let content = block.replace(/\n/g, ' '); // Replace single newlines within a block with space
                return `<p>${content}</p>`;
            }).join('');

            return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (No changes needed)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0; // Reset scroll
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentConceptTitle = null; // Reset chat context
             hideFullscreenImage(); // Ensure fullscreen is hidden
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (No changes needed)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (No changes needed)
        function addChatMessage(message, sender) { /* ... same as before ... */
             const msgDiv = document.createElement('div');
             msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
             message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
             msgDiv.innerHTML = message;
             chatHistory.appendChild(msgDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        function addChatError(message) { /* ... same as before ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        async function handleSendMessage() { /* ... same as before ... */
             const userQuery = chatInput.value.trim();
             if (!userQuery || chatSendBtn.disabled || !currentConceptTitle) return; // Check context too
             addChatMessage(userQuery, 'user');
             chatInput.value = '';
             chatSendBtn.disabled = true;
             chatLoadingIndicator.style.display = 'block';
             try {
                 const aiResponse = await fetchChatResponse(userQuery);
                 addChatMessage(aiResponse, 'ai');
             } catch (error) {
                 console.error("Chat Error:", error);
                 addChatError(`Error IA: ${error.message}`);
             } finally {
                 chatLoadingIndicator.style.display = 'none';
                 chatSendBtn.disabled = false;
                 chatInput.focus();
             }
         }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        // *** Display Titles sorted alphabetically ***
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Sort considering potential numbers/symbols initially might be complex, basic alpha sort is good
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">No hay conceptos disponibles.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... same as before ... */
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** handleTitleClick adapted for chemistry context ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentConceptTitle = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Show content + chat placeholder

                modalTextArea.scrollTop = 0; // Reset scroll after content added
                console.log("Scroll set to 0 after content visible");

                // Add image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-atom placeholder-icon"></i> <!-- Chemistry icon -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Generando visualización conceptual...</p>
                `;
                modalContent.appendChild(placeholderDiv); // Append placeholder

                // Create and load image
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); // Add click for fullscreen
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo generar la visualización.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title); // Use chemistry-focused prompt
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement); // Append image to the end of text content
                } else {
                    console.error("Could not create image URL for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al crear URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar la explicación."; // Use friendly error
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = ''; // Clear partial content
                chatSection.classList.add('content-hidden'); // Hide chat on main error
            }
        }

        // *** handleGenerateMoreTitles adapted text ***
        async function handleGenerateMoreTitles() {
            if (!generateMoreBtn || !generateMoreContainer) return;
            const btnIcon = generateMoreBtn.querySelector('i');
            generateMoreBtn.disabled = true;
            btnIcon.classList.remove('hidden');
            generateMoreBtn.childNodes[generateMoreBtn.childNodes.length - 1].nodeValue = " Buscando..."; // Update text node
            try {
                const newTitles = await fetchGeneratedTitles();
                if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                else { alert("No se pudieron generar más conceptos en este momento."); }
            } catch (error) {
                console.error("Failed title generation:", error);
                alert(`Error al generar conceptos: ${error.message}`); // Friendly error
            } finally {
                generateMoreBtn.disabled = false;
                 btnIcon.classList.add('hidden');
                generateMoreBtn.childNodes[generateMoreBtn.childNodes.length - 1].nodeValue = " Generar Más Conceptos";
            }
        }

        // *** Search Filter Function (with accent normalization) ***
        function filterTitles(searchTerm) {
            const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
            const titleItems = titleListContainer.querySelectorAll('.title-item');
            let visibleCount = 0;
            titleItems.forEach(item => {
                const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const isVisible = titleText.includes(term);
                item.classList.toggle('hidden', !isVisible);
                if (isVisible) visibleCount++;
            });
            noResultsMsg.classList.toggle('hidden', visibleCount > 0);
        }

        // ========== INITIALIZATION ========== (No changes needed)
        function initApp() {
            // ... (ensure all elements are selected correctly)
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Fallo al inicializar los componentes de la interfaz.</p>';
                 return;
             }
             modalCloseBtn.addEventListener('click', hideModal);
             storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
             generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
             searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
             searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
             chatSendBtn.addEventListener('click', handleSendMessage);
             chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
             imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
             fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });
             displayTitles(predefinedTitles);
             noResultsMsg.classList.add('hidden');
         }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>