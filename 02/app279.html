<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Religión Inca - Cosmovisión Andina</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Históricas/Elegantes -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Religión Inca --- */
        :root {
            --color-primary: #D4AF37; /* Oro Inca (Inti) */
            --color-secondary: #8B4513; /* Marrón Tierra/Terracota */
            --color-tertiary: #4682B4; /* Azul Montaña/Cielo */
            --color-accent: #2E8B57; /* Verde Agricultura/Naturaleza */
            --color-background: #F5F5DC; /* Beige Piedra/Arena Claro */
            --color-text: #3B3131; /* Marrón Oscuro Casi Negro */
            --color-text-muted: #808080; /* Gris Medio */
            --color-modal-bg: #FFF8DC; /* Crema (Cornsilk) */
            --color-border: #CD853F; /* Perú (Marrón Claro) */
            --color-error-bg: #FFF0F5; /* Lavanda Blush (fondo error suave) */
            --color-error-text: #A52A2A; /* Marrón (texto error) */
            --color-error-border: #F08080; /* Coral Claro (borde error) */

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.12);
            --border-radius: 6px;
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Lato', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; font-weight: 400;
               background-image: linear-gradient(rgba(245, 245, 220, 0.97), rgba(245, 245, 220, 0.97)),
                                 url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%238B4513' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); /* Patrón sutil */
               background-attachment: fixed;
        }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel Decorative', serif; font-weight: 700; }
        .logo { color: var(--color-primary); text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .logo .andean { color: var(--color-secondary); } /* Parte andina en marrón */
        h1.page-title { color: var(--color-secondary); font-weight: 700; }
        h2.section-title { color: var(--color-secondary); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(255, 248, 220, 0.9); backdrop-filter: blur(4px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.2rem 0.8rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Lato'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.25); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(270px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-secondary); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Lato'; font-size: 0.95rem; }
        .title-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); border-color: var(--color-primary); color: var(--color-primary); background-color: #fffaf0; /* FloralWhite hover */ }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), var(--color-secondary)); color: white; padding: 0.9rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel Decorative', serif; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-secondary), var(--color-primary)); box-shadow: var(--shadow-md); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(59, 49, 49, 0.9); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 2px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 500px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-secondary); border: 1px solid var(--color-primary); border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-modal-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-secondary); transform: rotate(90deg); box-shadow: 0 0 8px var(--color-primary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        #modal-story-content-area { flex-grow: 1; min-height: 0; display: none; flex-direction: column; }
        #modal-story-content-area.visible { display: flex; }
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border); }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: #f5e8d0; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid #f5e8d0; }

        #modal-content { padding: 0 5px; font-size: 1rem; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 700; }
        #modal-content em { color: var(--color-accent); font-style: italic; font-weight: 600;}
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel Decorative', serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-secondary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 400; }
        #modal-content h1 { font-size: 1.5em; color: var(--color-primary); }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-accent); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2rem auto 1rem auto; border: 2px solid var(--color-secondary); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: 0 0 12px var(--color-secondary); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(139, 69, 19, 0.2); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.8rem; color: var(--color-tertiary); }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 260px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #faf0e6; /* Linen */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) #f5e8d0; }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: #f5e8d0; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; box-shadow: var(--shadow-sm); }
        .user-message { background-color: var(--color-tertiary); color: white; margin-left: auto; text-align: left; font-weight: 600;}
        .ai-message { background-color: var(--color-secondary); color: white; margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Lato'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.15); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1rem; flex-shrink: 0; }
        #chat-send-btn:hover:not(:disabled) { background-color: var(--color-secondary); transform: scale(1.05); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; transform: none; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Screen & Minigame */
        #modal-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(180deg, rgba(70, 130, 180, 0.97) 0%, rgba(212, 175, 55, 0.97) 100%); /* Azul a Oro */ display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); padding: 2rem; color: #fff; text-align: center; text-shadow: 1px 1px 2px #333; }
        #modal-loading.active { display: flex; }
        #loading-game-canvas { border: 3px solid var(--color-secondary); background-color: #deb887; /* BurlyWood - Tierra */ max-width: 90%; max-height: 60%; aspect-ratio: 16 / 9; box-shadow: 0 0 15px rgba(139, 69, 19, 0.6); margin-bottom: 1rem; display: block; }
        #loading-instructions { font-size: 0.9rem; margin-top: 0.5rem; font-family: 'Lato'; }
        #loading-score { font-size: 1.5rem; font-family: 'Cinzel Decorative'; margin-top: 0.5rem; }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.2); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Lato'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(40, 20, 10, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: 0 0 25px var(--color-primary); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-modal-bg); transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-4xl sm:text-5xl">
                     <i class="fas fa-sun mr-2 text-yellow-500"></i> <!-- Icono Sol (Inti) -->
                     Religión <span class="andean">Inca</span>
                     <i class="fas fa-mountain ml-2 text-brown-700"></i> <!-- Icono Montaña (Apus) -->
                 </h1>
             </div>
             <span class="text-md text-gray-700 font-semibold font-sans tracking-wide">» Cosmovisión Andina «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">El Mundo Sagrado de los Incas</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora las deidades, mitos, rituales y la profunda conexión con la naturaleza que definieron el Imperio del Sol.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar (Ej: Inti, Pachamama, Huaca, Inti Raymi...)">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-dead text-yellow-600 mr-2"></i> <!-- Icono libro/quipu -->
                 Conceptos Fundamentales
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los archivos del Qorikancha...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron conceptos para tu búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Descubrir 40 Conceptos Más
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <canvas id="loading-game-canvas" width="640" height="360">Tu navegador no soporta Canvas.</canvas>
                 <p id="loading-instructions">¡El Chasqui está en camino! Juega mientras carga... (Usa ↑ / ↓)</p>
                 <p id="loading-score">Puntos: 0 | Nivel: 1</p>
                 <div class="loading-spinner-modal content-hidden"></div>
             </div>

             <!-- Content Area Wrapper (Initially Hidden) -->
             <div id="modal-story-content-area">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando al Willaq Umu...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta más sobre este concepto...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-yellow-100 text-gray-700 py-6 mt-12 border-t border-yellow-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Información sobre la religión inca generada por IA con fines educativos y de referencia.</p>
              <p class="mt-1">Consulta fuentes académicas para estudios profundos. Basado en interpretaciones históricas.</p>
              <p class="mt-2">© 2025 Legado Andino Digital</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Deidades Principales
            "Inti (Dios del Sol)", "Viracocha (Dios Creador)", "Pachamama (Madre Tierra)", "Mama Quilla (Diosa de la Luna)", "Illapa (Dios del Trueno, Rayo y Lluvia)", "Pachacamac (Dios Creador - Costa)", "Mama Cocha (Diosa del Mar)", "Supay (Dios del Inframundo/Muerte)",
            // Deidades Secundarias y Espíritus
            "Apus (Espíritus de las Montañas)", "Huacas (Lugares y Objetos Sagrados)", "Conopa (Objeto de Poder Personal)", "Malki (Espíritus Ancestrales Momificados)", "Apu Kon Ticse Wiracocha (Aspecto de Viracocha)", "Ch'aska (Diosa del Amanecer/Venus)", "Ekeko (Dios de la Abundancia - Preincaico)", "Illas (Objetos que Representan Ganado)", "Amaru (Serpiente Mítica/Dragón)", "Achachila (Espíritus Ancestrales - Aymara/Inca)",
            // Cosmología y Conceptos
            "Hanan Pacha (Mundo de Arriba)", "Kay Pacha (Este Mundo)", "Uku Pacha (Mundo de Abajo)", "El Tiempo Cíclico Inca (Pachakuti)", "Concepto de Dualidad (Yanantin)", "Principio de Reciprocidad (Ayni)", "Mita (Trabajo Comunal como Deber Sagrado)", "Cosmovisión Andina (Relación Hombre-Naturaleza)", "El Origen del Universo según los Incas", "La Vía Láctea (Mayu) en la Cosmología Inca", "Las Constelaciones Oscuras (Yana Phuyu)", "Ceque (Sistema de Líneas Sagradas de Cusco)", "Tawantinsuyu (Las Cuatro Regiones Unidas)", "Qhapaq Ñan (El Camino Real como Eje Sagrado)", "Pacha (Concepto de Tiempo y Espacio)",
            // Figuras y Roles Religiosos
            "Sapa Inca (Hijo del Sol, Emperador Divino)", "Coya (Reina Principal, Hermana/Esposa del Inca)", "Willaq Umu (Sumo Sacerdote del Sol)", "Aqllakuna (Vírgenes del Sol, Mujeres Escogidas)", "Tarpuntay (Sacerdotes de Rango Menor)", "Ichuri (Confesor/Adivino)", "Mallquip Villac (Sacerdote de los Ancestros)", "Caviacas (Mujeres Guardianas de Huacas)", "Yachaq (Sabio, Chamán, Curandero)", "Hampiq (Curandero con Hierbas)", "Layqa (Hechicero, Brujo)",
            // Rituales y Ceremonias
            "Inti Raymi (Fiesta del Sol)", "Capac Raymi (Gran Fiesta Real - Solsticio Diciembre)", "Qhapaq Hucha / Capacocha (Sacrificio Humano de Niños)", "Sacrificios de Animales (Llamas, Cuyes)", "Ofrendas de Chicha y Hojas de Coca", "Lectura de Hojas de Coca para Adivinación", "Interpretación de Sueños y Presagios", "Rituales Agrícolas (Siembra, Cosecha)", "Ceremonias de Purificación", "Mummificación de los Gobernantes Incas", "Procesiones Sagradas", "Rituales de Paso (Nacimiento, Pubertad, Muerte)", "Pago a la Tierra (Ofrenda a Pachamama)", "Citua (Fiesta de Purificación y Expulsión de Males)", "Wata Huchuy (Atadura del Sol - Intihuatana)",
            // Lugares Sagrados
            "Qorikancha (Templo del Sol en Cusco)", "Machu Picchu (Ciudadela Sagrada)", "Sacsayhuamán (Fortaleza/Templo Ceremonial)", "Ollantaytambo (Complejo Arqueológico)", "Isla del Sol y de la Luna (Lago Titicaca)", "Huacas Específicas (Ej: Huaca Pucllana)", "Montañas Sagradas (Apus) Específicas (Ej: Ausangate)", "Intihuatana (Piedra para 'Atar' el Sol)", "Ushnu (Plataforma Ceremonial)", "Tambomachay (Baños del Inca, Culto al Agua)", "Kenko (Anfiteatro/Santuario)", "Raqchi (Templo de Viracocha)", "Vilcashuamán (Centro Administrativo/Religioso)", "Pisaq (Sitio Arqueológico)",
            // Mitos y Leyendas
            "Mito de Origen: Manco Cápac y Mama Ocllo", "Mito de Origen: Los Hermanos Ayar", "Leyenda de la Fundación de Cusco", "Mitos de Creación de Viracocha", "Historias sobre Héroes Culturales Incas", "Mitos sobre el Diluvio Andino", "Leyendas sobre Tesoros Escondidos (Paititi)", "Narrativas sobre la Lucha contra los Chankas", "Mitos relacionados con el Lago Titicaca", "Cuentos sobre la Interacción con los Apus",
            // Objetos y Símbolos
            "Quipu (Sistema de Cuerdas Anudadas)", "Tumi (Cuchillo Ceremonial)", "Kero (Vaso Ceremonial de Madera)", "Unku (Túnica Inca)", "Mascapaicha (Borla Real del Sapa Inca)", "Chakana (Cruz Andina)", "Representaciones del Sol (Discos de Oro)", "Textiles Incas (Diseños Simbólicos)", "Cerámica Inca (Formas y Decoración Religiosa)", "Conopas de Llamas y Alpacas",
            // Post-Conquista y Legado
            "Sincretismo Religioso Andino-Católico", "Supervivencia de Creencias Incas", "La 'Extirpación de Idolatrías'", "Fiestas Patronales con Elementos Incas", "El Culto a los Apus en la Actualidad", "Pachamama en la Cultura Andina Contemporánea", "Impacto de la Conquista en la Religión Inca", "Resistencia Cultural y Religiosa", "Neo-Incanismo y Movimientos Espirituales Modernos", "Interpretaciones Modernas de la Cosmovisión Inca",
            // Y muchos más... (el botón ayudará a completar)
        ];
        const incaReligionThemes = [ // Para generar más títulos
            "Dioses Incas", "Panteón Inca", "Cosmovisión Andina", "Rituales Incas", "Sacrificios Incas", "Sacerdocio Inca", "Templos Incas", "Huacas Sagradas", "Apus Montañas Sagradas", "Mitos de Origen Inca", "Leyendas Incas", "Inti Dios Sol", "Viracocha Creador", "Pachamama Madre Tierra", "Mama Quilla Luna", "Illapa Trueno", "Fiestas Incas", "Inti Raymi", "Capacocha", "Mummificación Inca", "Calendario Inca", "Adivinación Inca", "Quipu y Religión", "Símbolos Incas", "Chakana", "Cusco Sagrado", "Machu Picchu Religión", "Lago Titicaca Mitología", "Sincretismo Andino", "Reciprocidad Ayni", "Dualidad Yanantin", "Hanan Kay Uku Pacha", "Sapa Inca Divinidad", "Textiles Sagrados", "Agricultura y Religión"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un historiador y antropólogo especializado en las culturas precolombinas de los Andes, con profundo conocimiento de la religión y cosmovisión Inca. Proporciona una explicación detallada, precisa y académicamente informada sobre el concepto, deidad, ritual o lugar sagrado inca indicado. Describe su significado, contexto histórico, prácticas asociadas, importancia dentro del sistema de creencias inca y posibles interpretaciones. Utiliza un lenguaje claro y objetivo, citando aspectos clave basados en crónicas, arqueología y estudios etnohistóricos cuando sea apropiado. El objetivo es una descripción completa de aproximadamente 1200-1300 palabras basada *exclusivamente* en el siguiente tema inca:",
            timeoutSeconds: 180
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente de investigación especializado en la religión Inca. Responde preguntas específicas de seguimiento sobre el concepto, deidad o práctica que se está mostrando actualmente. Basa tus respuestas en el conocimiento histórico y antropológico establecido sobre los Incas, aclarando detalles o expandiendo puntos mencionados en la descripción principal.",
            timeoutSeconds: 50
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de temas conciso para una enciclopedia sobre la Religión Inca. Genera exactamente 40 nombres específicos de deidades, conceptos cosmológicos, rituales, lugares sagrados, mitos o roles religiosos del Imperio Inca. Devuelve *solo* la lista, un ítem por línea, sin números, guiones, introducciones ni conclusiones.",
            timeoutSeconds: 60
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, verificando IDs)
        const searchInput=document.getElementById('search-input');const titleListContainer=document.getElementById('title-list');const titlesLoading=document.getElementById('titles-loading');const noResultsMsg=document.getElementById('no-results');const generateMoreContainer=document.getElementById('generate-more-container');const generateMoreBtn=document.getElementById('generate-more-btn');const generateMoreSpinner=generateMoreBtn.querySelector('i');const storyModal=document.getElementById('story-modal');const modalCloseBtn=document.getElementById('modal-close');const modalLoadingIndicator=document.getElementById('modal-loading');const modalStoryContentArea=document.getElementById('modal-story-content-area');const modalTextArea=document.getElementById('modal-content-area');const modalTitle=document.getElementById('modal-title');const modalContent=document.getElementById('modal-content');const modalError=document.getElementById('modal-error');const modalErrorMessage=document.getElementById('modal-error-message');const chatSection=document.getElementById('chat-section');const chatHistory=document.getElementById('chat-history');const chatInput=document.getElementById('chat-input');const chatSendBtn=document.getElementById('chat-send-btn');const chatLoadingIndicator=document.getElementById('chat-loading');const imageFullscreenOverlay=document.getElementById('image-fullscreen-overlay');const fullscreenImage=document.getElementById('fullscreen-image');const fullscreenCloseBtn=document.getElementById('fullscreen-close-btn');const gameCanvas=document.getElementById('loading-game-canvas');const gameCtx=gameCanvas.getContext('2d');const loadingInstructions=document.getElementById('loading-instructions');const loadingScoreDisplay=document.getElementById('loading-score');

        // ========== State Variables ==========
        let currentConceptTitle = null; // Cambiado nombre para claridad
        let gameLoopId = null;
        let isGameRunning = false;

        // ========== MINIGAME VARIABLES & LOGIC ("Chasqui Run") ==========
        const gameConfigInca = {
            playerWidth: 35, playerHeight: 50, playerSpeed: 5, playerColor: '#8B4513', // Chasqui color
            itemSize: 18, itemSpeedMultiplier: 0.7, // Items más lentos
            obstacleWidth: 40, obstacleHeight: 40, obstacleMinSpeed: 3.5, obstacleMaxSpeed: 7,
            spawnRateItems: 0.018,
            spawnRateObstacles: 0.012,
            scorePerItem: 15, scoreLostOnHit: 30,
            levelUpScore: 200,
            maxSpeedIncreasePerLevel: 0.6,
            maxSpawnRateIncreasePerLevel: 0.0025,
        };

        let playerInca = { x: 60, y: gameCanvas.height / 2 - gameConfigInca.playerHeight / 2, type: 'chasqui' }; // Tipo inicial
        let itemsInca = []; // {x, y, type: 'quipu' | 'maize' | 'potato'}
        let obstaclesInca = []; // {x, y, speed, type: 'rock' | 'conquistador' | 'puma'}
        let scoreInca = 0;
        let levelInca = 1;
        let currentObstacleSpeedInca = gameConfigInca.obstacleMinSpeed;
        let currentItemSpeedInca = gameConfigInca.obstacleMinSpeed * gameConfigInca.itemSpeedMultiplier;
        let currentObstacleSpawnRateInca = gameConfigInca.spawnRateObstacles;
        let currentItemSpawnRateInca = gameConfigInca.spawnRateItems;
        let keysPressedInca = {};

        function resetGameInca() {
            playerInca.y = gameCanvas.height / 2 - gameConfigInca.playerHeight / 2;
            playerInca.type = 'chasqui'; // Reset a tipo inicial
            itemsInca = [];
            obstaclesInca = [];
            scoreInca = 0;
            levelInca = 1;
            currentObstacleSpeedInca = gameConfigInca.obstacleMinSpeed;
            currentItemSpeedInca = gameConfigInca.obstacleMinSpeed * gameConfigInca.itemSpeedMultiplier;
            currentObstacleSpawnRateInca = gameConfigInca.spawnRateObstacles;
            currentItemSpawnRateInca = gameConfigInca.spawnRateItems;
            keysPressedInca = {};
            loadingScoreDisplay.textContent = `Puntos: 0 | Nivel: 1`;
            console.log("Inca Game Reset");
        }

        function handleKeyDownInca(e) { keysPressedInca[e.key] = true; if (['ArrowUp', 'ArrowDown'].includes(e.key)) e.preventDefault(); }
        function handleKeyUpInca(e) { keysPressedInca[e.key] = false; }

        function updateGameInca() {
            if (!isGameRunning) return;

            // Player Movement
            if (keysPressedInca['ArrowUp'] && playerInca.y > 0) playerInca.y -= gameConfigInca.playerSpeed;
            if (keysPressedInca['ArrowDown'] && playerInca.y < gameCanvas.height - gameConfigInca.playerHeight) playerInca.y += gameConfigInca.playerSpeed;

            // Cambio de 'sprite' simple con nivel (Chasqui -> Condor?)
            playerInca.type = (levelInca >= 3) ? 'condor' : 'chasqui'; // Nivel 3+ se vuelve condor
            playerInca.color = (playerInca.type === 'condor') ? '#5A4D41' : '#8B4513'; // Gris oscuro vs Marrón
            gameConfigInca.playerHeight = (playerInca.type === 'condor') ? 40 : 50; // Condor un poco más bajo
            gameConfigInca.playerWidth = (playerInca.type === 'condor') ? 55 : 35; // Condor más ancho

            // Spawn Items
            if (Math.random() < currentItemSpawnRateInca) {
                let type; const rand = Math.random();
                if (rand < 0.4) type = 'maize'; else if (rand < 0.75) type = 'potato'; else type = 'quipu';
                itemsInca.push({ x: gameCanvas.width, y: Math.random() * (gameCanvas.height - gameConfigInca.itemSize), type });
            }

            // Spawn Obstacles
            if (Math.random() < currentObstacleSpawnRateInca) {
                let type; const rand = Math.random();
                 // Más rocas al principio, más conquistadores/pumas después
                if (levelInca < 2 && rand < 0.7) type = 'rock';
                else if (rand < 0.4) type = 'rock';
                else if (rand < 0.75) type = 'puma';
                else type = 'conquistador';
                obstaclesInca.push({
                    x: gameCanvas.width,
                    y: Math.random() * (gameCanvas.height - gameConfigInca.obstacleHeight),
                    speed: currentObstacleSpeedInca + (Math.random() * (gameConfigInca.obstacleMaxSpeed - currentObstacleSpeedInca)), // Velocidad variable
                    type
                });
            }

            // Move & Handle Items
            itemsInca.forEach((item, index) => {
                item.x -= currentItemSpeedInca;
                if (item.x < -gameConfigInca.itemSize) itemsInca.splice(index, 1);
                else if (playerInca.x < item.x + gameConfigInca.itemSize && playerInca.x + gameConfigInca.playerWidth > item.x &&
                         playerInca.y < item.y + gameConfigInca.itemSize && playerInca.y + gameConfigInca.playerHeight > item.y) {
                    let itemValue = gameConfigInca.scorePerItem;
                    if (item.type === 'quipu') itemValue *= 2; // Quipu vale más
                    scoreInca += itemValue;
                    itemsInca.splice(index, 1);
                    checkLevelUpInca();
                }
            });

            // Move & Handle Obstacles
            obstaclesInca.forEach((obstacle, index) => {
                obstacle.x -= obstacle.speed;
                if (obstacle.x < -gameConfigInca.obstacleWidth) obstaclesInca.splice(index, 1);
                else if (playerInca.x < obstacle.x + gameConfigInca.obstacleWidth && playerInca.x + gameConfigInca.playerWidth > obstacle.x &&
                         playerInca.y < obstacle.y + gameConfigInca.obstacleHeight && playerInca.y + gameConfigInca.playerHeight > obstacle.y) {
                    scoreInca = Math.max(0, scoreInca - gameConfigInca.scoreLostOnHit);
                    obstaclesInca.splice(index, 1); // Remove obstacle
                    // Efecto visual de golpe simple
                    gameCanvas.style.backgroundColor = '#FFA07A'; // Light Salmon flash
                    setTimeout(() => { gameCanvas.style.backgroundColor = '#deb887'; }, 100);
                }
            });

            loadingScoreDisplay.textContent = `Puntos: ${scoreInca} | Nivel: ${levelInca}`;
        }

        function checkLevelUpInca() {
            const nextLevelThreshold = levelInca * gameConfigInca.levelUpScore;
            if (scoreInca >= nextLevelThreshold) {
                levelInca++;
                currentObstacleSpeedInca = Math.min(gameConfigInca.obstacleMaxSpeed * 1.6, gameConfigInca.obstacleMinSpeed + (levelInca - 1) * gameConfigInca.maxSpeedIncreasePerLevel);
                currentItemSpeedInca = currentObstacleSpeedInca * gameConfigInca.itemSpeedMultiplier;
                currentObstacleSpawnRateInca = Math.min(0.06, gameConfigInca.spawnRateObstacles + (levelInca - 1) * gameConfigInca.maxSpawnRateIncreasePerLevel);
                currentItemSpawnRateInca = Math.min(0.07, gameConfigInca.spawnRateItems + (levelInca - 1) * gameConfigInca.maxSpawnRateIncreasePerLevel);
                console.log(`Inca Level Up! Lvl: ${levelInca}, Speed: ${currentObstacleSpeedInca.toFixed(2)}, Spawn: ${currentObstacleSpawnRateInca.toFixed(4)}`);
                gameCanvas.style.borderColor = ['#8B4513', '#4682B4', '#2E8B57'][levelInca % 3];
                setTimeout(() => { gameCanvas.style.borderColor = 'var(--color-secondary)'; }, 300);
            }
        }

        function drawGameInca() {
            if (!isGameRunning || !gameCtx) return;
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

            // Background Andino simple
            const grad = gameCtx.createLinearGradient(0, 0, 0, gameCanvas.height);
            grad.addColorStop(0, '#ADD8E6'); // Cielo claro
            grad.addColorStop(0.7, '#deb887'); // Tierra
            grad.addColorStop(1, '#A0522D'); // Tierra más oscura
            gameCtx.fillStyle = grad;
            gameCtx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

            // Draw Player (Chasqui/Condor)
            gameCtx.fillStyle = playerInca.color;
            if (playerInca.type === 'chasqui') {
                gameCtx.fillRect(playerInca.x, playerInca.y, gameConfigInca.playerWidth, gameConfigInca.playerHeight);
                // Simple detalle 'cabeza'
                gameCtx.fillStyle = '#FFDAB9'; // PeachPuff
                gameCtx.fillRect(playerInca.x + gameConfigInca.playerWidth * 0.2, playerInca.y + 5, gameConfigInca.playerWidth * 0.6, 10);
            } else { // Condor (forma simple de 'alas')
                gameCtx.beginPath();
                gameCtx.moveTo(playerInca.x, playerInca.y + gameConfigInca.playerHeight / 2);
                gameCtx.lineTo(playerInca.x + gameConfigInca.playerWidth, playerInca.y);
                gameCtx.lineTo(playerInca.x + gameConfigInca.playerWidth * 0.8, playerInca.y + gameConfigInca.playerHeight / 2);
                gameCtx.lineTo(playerInca.x + gameConfigInca.playerWidth, playerInca.y + gameConfigInca.playerHeight);
                gameCtx.closePath();
                gameCtx.fill();
            }

            // Draw Items
            itemsInca.forEach(item => {
                if (item.type === 'quipu') { gameCtx.fillStyle = '#D2B48C'; gameCtx.fillRect(item.x, item.y, gameConfigInca.itemSize*0.7, gameConfigInca.itemSize); } // Tan rectangle
                else if (item.type === 'maize') { gameCtx.fillStyle = '#FFD700'; gameCtx.fillRect(item.x, item.y, gameConfigInca.itemSize, gameConfigInca.itemSize*0.6); } // Gold rectangle
                else { gameCtx.fillStyle = '#A0522D'; gameCtx.beginPath(); gameCtx.arc(item.x + gameConfigInca.itemSize / 2, item.y + gameConfigInca.itemSize / 2, gameConfigInca.itemSize / 2, 0, Math.PI * 2); gameCtx.fill(); } // Sienna circle (papa)
            });

            // Draw Obstacles
            obstaclesInca.forEach(obstacle => {
                if (obstacle.type === 'rock') { gameCtx.fillStyle = '#808080'; gameCtx.fillRect(obstacle.x, obstacle.y, gameConfigInca.obstacleWidth, gameConfigInca.obstacleHeight); } // Gray square
                else if (obstacle.type === 'puma') { gameCtx.fillStyle = '#B8860B'; gameCtx.fillRect(obstacle.x, obstacle.y, gameConfigInca.obstacleWidth * 1.2, gameConfigInca.obstacleHeight * 0.8); } // DarkGoldenrod rect
                else { gameCtx.fillStyle = '#C0C0C0'; gameCtx.fillRect(obstacle.x, obstacle.y, gameConfigInca.obstacleWidth * 0.7, gameConfigInca.obstacleHeight * 1.1); } // Silver rect (conquistador)
            });
        }

        function gameLoopInca() { if (isGameRunning) { updateGameInca(); drawGameInca(); gameLoopId = requestAnimationFrame(gameLoopInca); } }
        function startGameLoopInca() { if(isGameRunning)return; console.log("Starting Inca Game Loop"); isGameRunning = true; resetGameInca(); document.addEventListener('keydown', handleKeyDownInca); document.addEventListener('keyup', handleKeyUpInca); gameLoopId = requestAnimationFrame(gameLoopInca); modalLoadingIndicator.classList.add('active'); gameCanvas.style.display = 'block'; }
        function stopGameLoopInca() { if(!isGameRunning)return; console.log("Stopping Inca Game Loop"); isGameRunning = false; if (gameLoopId) { cancelAnimationFrame(gameLoopId); gameLoopId = null; } document.removeEventListener('keydown', handleKeyDownInca); document.removeEventListener('keyup', handleKeyUpInca); }


        // ========== API FUNCTIONS ==========
        // *** NEW: Advertising Filter Function ***
        function filterAdvertising(text) {
            if (!text) return '';
            // Regex to find common ad patterns, especially those starting with '---' or similar separators
            // Looks for separator, then common ad keywords later in the sentence/paragraph.
            const adPatterns = [
                 /(\n\s*|^)---\s*.*?(\bLearn more\b|\bVisit\b|\bGet\b|\bSubscribe\b|\bDiscount\b|\bOffer\b|\bNordVPN\b|\bSurfshark\b|\bExpressVPN\b|\bAtlasVPN\b).*/gis,
                 // Add more specific patterns if needed
                 /(\n\s*|^)Advertisement:.*?$/gis,
                 /(\n\s*|^)Sponsored link:.*?$/gis
            ];
            let cleanedText = text;
             adPatterns.forEach(pattern => {
                 cleanedText = cleanedText.replace(pattern, '');
             });

            // Remove potential empty lines left after removal
             cleanedText = cleanedText.replace(/^\s*[\r\n]/gm, '');

            return cleanedText.trim(); // Trim whitespace from final result
        }

        async function fetchTextFromApi(prompt, config, isChat = false) {
            // ... (URL encoding and parameter setup remains the same)
             const encodedPrompt=encodeURIComponent(prompt);const systemPromptToUse=isChat&&currentConceptTitle?`Eres un asistente de investigación especializado en la religión Inca. Responde preguntas específicas de seguimiento sobre '${currentConceptTitle}'. Basa tus respuestas en el conocimiento histórico y antropológico establecido.` : config.systemPrompt;const encodedSystem=encodeURIComponent(systemPromptToUse);const params=new URLSearchParams({model:config.model,system:encodedSystem});if(config.seed&&!isChat)params.append('seed',config.seed);const url=`https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0,200)}...`);const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),config.timeoutSeconds*1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores están experimentando mucho tráfico. Por favor, intenta de nuevo en unos segundos.`);

                const rawText = await response.text(); // Get raw text

                // *** APPLY FILTER HERE ***
                const cleanedText = filterAdvertising(rawText);

                if (!cleanedText || cleanedText.length < (isChat ? 10 : 400)) { // Check cleaned text length
                    throw new Error("La respuesta de la IA fue demasiado corta, vacía o filtrada por completo. Intenta de nuevo o con otro concepto.");
                }
                console.log(`API Response received (${rawText.length} chars), Cleaned (${cleanedText.length} chars)`);
                return cleanedText; // Return the cleaned text

            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o inténtalo más tarde.`);
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }

        // fetchExplanationText, fetchChatResponse, fetchGeneratedTitles use fetchTextFromApi internally,
        // so they will automatically benefit from the filtering.
         async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
         async function fetchChatResponse(userQuery) { if (!currentConceptTitle) throw new Error("Error interno: No se ha establecido el contexto para el chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
         async function fetchGeneratedTitles() { const randomTheme=getRandomElement(incaReligionThemes)||"Conceptos Incas"; const specificPrompt=`Genera 40 conceptos o nombres específicos sobre ${randomTheme} en la religión Inca.`; console.log("Generating 40 titles with prompt:", specificPrompt); const configForThisRequest={...titleGenerationConfig, seed: Math.floor(Math.random()*1000000)}; return fetchTextFromApi(specificPrompt, configForThisRequest, false).then(text=>{const titles=text.split('\n').map(line=>line.replace(/^[-\d.\s*]+/,'').trim()).filter(line=>line.length>5&&line.length<150&&!/^\s*$/.test(line)).slice(0,40); if(titles.length<10)throw new Error("La IA no generó suficientes conceptos válidos."); return titles; }); }

        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 1024, height: 576, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Inca religious ceremony";
            const enhancedPrompt = `Artwork depicting the Inca concept '${safePromptText}'. Andean landscape, mystical atmosphere, focus on symbolism (sun, mountains, gold, textiles). Style: historical illustration mixed with magical realism. Avoid photorealism.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, logo, watermark, signature, multiple images, collage, european people, modern elements, cartoon, simple drawing";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
         }

        // ========== Text Formatting Function ========== (Sin cambios)
        function formatExplanationText(rawText){ if(!rawText)return'';let formatted=rawText.trim();formatted=formatted.replace(/\\text\{(.*?)\}/g,'$1');formatted=formatted.replace(/(\w)_\{?(\d+)\}?/g,'$1<sub>$2</sub>');formatted=formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g,(match,base,exponent)=>{const cleanExponent=exponent.replace('−','-');return`${base}<sup>${cleanExponent}</sup>`;});formatted=formatted.replace(/\\rightarrow/g,'&rarr;');formatted=formatted.replace(/\\\[\s*(.*?)\s*\\\]/g,'<p class="formula">$1</p>');formatted=formatted.replace(/^####\s+(.*)$/gm,'<h4>$1</h4>');formatted=formatted.replace(/^###\s+(.*)$/gm,'<h3>$1</h3>');formatted=formatted.replace(/^##\s+(.*)$/gm,'<h2>$1</h2>');formatted=formatted.replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');formatted=formatted.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formatted=formatted.replace(/\*(.*?)\*/g,'<em>$1</em>');const blocks=formatted.split(/\n\s*\n/).filter(p=>p.trim().length>0);formatted=blocks.map(block=>{if(block.startsWith('<h')||block.startsWith('<p class="formula">'))return block;let content=block.replace(/\n/g,' ');return`<p>${content}</p>`;}).join('');return formatted;}

        // ========== MODAL FUNCTIONS ========== (Integrando inicio/parada del juego Inca)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() { stopGameLoopInca(); storyModal.classList.remove('active'); if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; } modalTextArea.scrollTop = 0; resetModalState(); }
        function resetModalState() { stopGameLoopInca(); modalLoadingIndicator.classList.remove('active'); modalStoryContentArea.classList.remove('visible'); modalStoryContentArea.classList.add('content-hidden'); modalError.classList.add('content-hidden'); modalTitle.textContent = ''; modalContent.innerHTML = ''; modalErrorMessage.textContent = ''; chatHistory.innerHTML = ''; chatInput.value = ''; chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; currentConceptTitle = null; hideFullscreenImage(); }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (Sin cambios)
        function showFullscreenImage(imgSrc){if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden';}
        function hideFullscreenImage(){if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src='';}

        // ========== CHAT FUNCTIONS ========== (Sin cambios funcionales)
        function addChatMessage(message,sender){const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        function addChatError(message){const errorDiv=document.createElement('div');errorDiv.classList.add('chat-error');errorDiv.textContent=message;chatHistory.appendChild(errorDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        async function handleSendMessage(){const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Error IA: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}}

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title) { const div=document.createElement('div');div.className='title-item';div.textContent=title;div.setAttribute('data-title',title);div.addEventListener('click',()=>handleTitleClick(title));return div; }
        function displayTitles(titles) { if(!titleListContainer||!titlesLoading)return; const sortedTitles=titles.sort((a,b)=>a.localeCompare(b)); titleListContainer.innerHTML=''; titlesLoading.style.display='none'; if(sortedTitles.length===0){titleListContainer.innerHTML='<p class="text-gray-500 col-span-full text-center font-sans">» No hay conceptos disponibles. Intenta generar más. «</p>';return;} sortedTitles.forEach(title=>titleListContainer.appendChild(createTitleItem(title))); console.log(`Displayed ${sortedTitles.length} titles.`); }
        function appendTitles(newTitles) { if(!titleListContainer||!newTitles||newTitles.length===0)return; console.log(`Appending ${newTitles.length} new titles.`); const existingTitles=new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item=>item.dataset.title)); let addedCount=0; newTitles.forEach(title=>{if(!existingTitles.has(title)){titleListContainer.appendChild(createTitleItem(title));addedCount++;}}); console.log(`Successfully added ${addedCount} unique titles.`); filterTitles(searchInput.value); }

        // *** MODIFIED: handleTitleClick to manage Inca game start/stop ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentConceptTitle = title; // Set context
            chatHistory.innerHTML = '';

            // *** START LOADING & INCA GAME ***
            modalLoadingIndicator.classList.add('active');
            startGameLoopInca();

            try {
                const explanationPromise = fetchExplanationText(title);
                const imageUrl = createPollinationsImageUrl(title);
                const rawExplanationText = await explanationPromise; // Await completion

                // *** STOP GAME & SHOW CONTENT ***
                stopGameLoopInca();
                modalLoadingIndicator.classList.remove('active');
                modalStoryContentArea.classList.add('visible');
                modalStoryContentArea.classList.remove('content-hidden');

                const formattedExplanation = formatExplanationText(rawExplanationText);
                modalContent.innerHTML = formattedExplanation;
                modalTextArea.scrollTop = 0;

                // Image Handling
                const placeholderDiv=document.createElement('div');placeholderDiv.className='image-placeholder';placeholderDiv.innerHTML=`<div class="spinner"></div><i class="fas fa-om placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Cargando representación visual...</p>`;modalContent.appendChild(placeholderDiv);
                if(imageUrl){const imgElement=document.createElement('img');imgElement.className='final-image';imgElement.alt=`Ilustración de ${title}`;imgElement.style.display='none';imgElement.onload=()=>{placeholderDiv.remove();imgElement.style.display='block';imgElement.addEventListener('click',()=>showFullscreenImage(imgElement.src));};imgElement.onerror=()=>{placeholderDiv.innerHTML=`<i class="fas fa-exclamation-triangle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error al cargar imagen.</p>`;};imgElement.src=imageUrl;modalContent.appendChild(imgElement);}else{placeholderDiv.innerHTML=`<i class="fas fa-ban placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo generar URL de imagen.</p>`;}

            } catch (error) {
                console.error("Failed display:", error);
                stopGameLoopInca(); // Stop game on error too
                modalLoadingIndicator.classList.remove('active');
                modalStoryContentArea.classList.add('visible');
                modalStoryContentArea.classList.remove('content-hidden');
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el concepto.";
                modalError.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() { if(!generateMoreBtn||!generateMoreSpinner)return; generateMoreBtn.disabled=true; generateMoreBtn.innerHTML='<i class="fas fa-sync-alt mr-2 animate-spin"></i> Excavando Conocimiento...'; try{const newTitles=await fetchGeneratedTitles(); if(newTitles&&newTitles.length>0){appendTitles(newTitles);}else{alert("No se pudieron generar más conceptos ahora.");}}catch(error){console.error("Failed title generation:",error);alert(`Error generando conceptos: ${error.message}`);}finally{generateMoreBtn.disabled=false;generateMoreBtn.innerHTML='<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Descubrir 40 Conceptos Más';} }

        // *** Search Filter Function (con normalización) ***
        function filterTitles(searchTerm){const term=searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();const titleItems=titleListContainer.querySelectorAll('.title-item');let visibleCount=0;titleItems.forEach(item=>{const titleText=item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");const isVisible=titleText.includes(term);item.classList.toggle('hidden',!isVisible);if(isVisible)visibleCount++;});noResultsMsg.classList.toggle('hidden',visibleCount>0||titleItems.length===0);}

        // ========== INITIALIZATION ==========
        function initApp() {
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !gameCanvas || !loadingScoreDisplay) { console.error("Initialization failed: Missing essential elements."); document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Faltan componentes de la interfaz.</p>'; return; }
             modalCloseBtn.addEventListener('click',hideModal); storyModal.addEventListener('click',(event)=>{if(event.target===storyModal)hideModal();});
             generateMoreBtn.addEventListener('click',handleGenerateMoreTitles);
             searchInput.addEventListener('input',(event)=>filterTitles(event.target.value)); searchInput.addEventListener('keypress',(event)=>{if(event.key==='Enter')event.preventDefault();});
             chatSendBtn.addEventListener('click',handleSendMessage); chatInput.addEventListener('keypress',(event)=>{if(event.key==='Enter')handleSendMessage();});
             imageFullscreenOverlay.addEventListener('click',hideFullscreenImage); fullscreenCloseBtn.addEventListener('click',(event)=>{event.stopPropagation();hideFullscreenImage();});
             displayTitles(predefinedTitles); noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>