<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Susurros Mágicos - Generador de Cuentos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Literarias/Evocadoras -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Cinzel:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Realismo Mágico --- */
        :root {
            --color-primary: #8B4513; /* Marrón Silla (Tierra, Madera) */
            --color-secondary: #FFD700; /* Dorado (Toque Mágico, Sol) */
            --color-tertiary: #2E8B57; /* Verde Mar Marino (Naturaleza, Misterio) */
            --color-background: #fdf6e3; /* Crema / Papel Viejo */
            --color-text: #4a4a4a; /* Gris Oscuro Cálido */
            --color-text-muted: #888; /* Gris Medio */
            --color-modal-bg: #fffaf0; /* Blanco Floral (Ligeramente crema) */
            --color-border: #d2b48c; /* Tan / Arena (Borde suave) */
            --color-error-bg: #fceded; /* Fondo error rosa pálido */
            --color-error-text: #a0522d; /* Siena (Texto error) */
            --color-error-border: #e57373; /* Borde error rojo suave */

            --shadow-sm: 0 2px 4px rgba(139, 69, 19, 0.1);
            --shadow-md: 0 5px 10px rgba(139, 69, 19, 0.15);
            --shadow-lg: 0 10px 20px rgba(139, 69, 19, 0.2);
            --border-radius: 5px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.8; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel', serif; font-weight: 600; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 600; }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 600;}
        #modal-title { color: var(--color-primary); font-weight: 600; }
        .navbar { background-color: rgba(253, 246, 227, 0.85); /* Fondo crema semitransparente */ backdrop-filter: blur(5px); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(255, 250, 240, 0.9); color: var(--color-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); transition: var(--transition-normal); font-family: 'Merriweather'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.15); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: flex-start; /* Alineado a la izquierda */ min-height: 75px; font-family: 'Merriweather'; font-size: 0.95rem; border-left: 4px solid transparent; position: relative; overflow: hidden; }
        .title-item::before { /* Pequeño detalle decorativo */ content: '\f185'; /* Icono de sol/luna suave */ font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); opacity: 0; transition: opacity 0.3s ease; font-size: 1.2rem; }
        .title-item:hover { transform: translateY(-3px) scale(1.01); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-primary); background-color: #fffef7; border-left-color: var(--color-secondary); }
        .title-item:hover::before { opacity: 0.6; color: var(--color-secondary); }

        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(to right, var(--color-primary), var(--color-tertiary)); color: var(--color-background); padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel', serif; font-weight: 400; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(to right, var(--color-tertiary), var(--color-primary)); box-shadow: var(--shadow-md); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; text-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: var(--color-background); }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(139, 69, 19, 0.7); /* Overlay marrón translúcido */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.8rem 2.2rem;
            max-width: 980px;
            width: 96%;
            max-height: 92vh;
            min-height: 450px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #eaddcc; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; font-family: serif; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-modal-bg); transform: rotate(90deg); box-shadow: 0 0 10px rgba(139, 69, 19, 0.3); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.4; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; margin-bottom: 1.2rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; font-size: 1.05rem; /* Tamaño fuente legible */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; font-weight: 400; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px dotted var(--color-border); padding-bottom: 0.6em; font-weight: 600; }
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 3rem auto 1.5rem auto; border: 3px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: var(--shadow-lg); border-color: var(--color-secondary); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); border: 2px dashed var(--color-border); border-radius: var(--border-radius); padding: 1rem; }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(210, 180, 140, 0.5); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1.2s linear infinite; margin-bottom: 1rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; color: var(--color-border); } /* Mariposa como placeholder */
        #modal-content .image-placeholder p { font-size: 0.9em; font-style: italic; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1.2rem; margin-top: 1.2rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* Más altura para chat */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(253, 246, 227, 0.6); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; font-size: 0.95rem; }
        .user-message { background-color: var(--color-tertiary); color: var(--color-background); margin-left: auto; text-align: left; font-weight: 400; border-radius: var(--border-radius) 0 var(--border-radius) var(--border-radius); }
        .ai-message { background-color: #eaddcc; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; border-radius: 0 var(--border-radius) var(--border-radius) var(--border-radius); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.7rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #fffaf0; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Merriweather'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(139, 69, 19, 0.1); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-primary); color: var(--color-background); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #a0522d; } /* Siena */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-style: italic;}
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(253, 246, 227, 0.97); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 6px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.3s linear infinite; margin: 0 auto 2rem auto; }
        #modal-loading p { font-weight: 400; color: var(--color-primary); font-size: 1.4rem; font-family: 'Cinzel'; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Merriweather'; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-text); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(253, 246, 227, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 96%; max-height: 96%; object-fit: contain; border: 4px solid var(--color-primary); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); font-family: serif; }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-feather-alt mr-3 text-brown-600"></i> <!-- Icono pluma -->
                     Susurros Mágicos
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">» Generador de Cuentos «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Donde lo Cotidiano se Vuelve Leyenda</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora un universo donde la realidad se entrelaza con la maravilla. Elige un título y deja que la magia te envuelva.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar un presagio, un recuerdo, un título...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-green-800 mr-2"></i> <!-- Icono libro abierto -->
                 Catálogo de Historias Susurradas
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans italic">Consultando los anales del tiempo...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans italic">» El eco de esa historia aún no resuena aquí «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Invocar Nuevos Relatos
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Tejiendo la Trama...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                      <h3 class="text-lg font-semibold text-gray-700 mb-2 text-center font-serif italic">Dialoga con la Historia</h3>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Descifrando símbolos...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre sus secretos...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Cuento">
      </div>

      <!-- Footer -->
      <footer class="bg-cream-dark text-gray-600 py-6 mt-12 border-t border-tan font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias generadas por IA, inspiradas en la rica tradición del realismo mágico latinoamericano y mundial.</p>
              <p class="mt-1">Cada cuento es una ficción única, un eco de lo maravilloso en lo cotidiano.</p>
              <p class="mt-2">© <span id="footer-year"></span> Susurros Mágicos</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Títulos con elementos naturales/climáticos
            "La Lluvia que Olía a Jazmín", "Cuando el Río Habló en Sueños", "El Viento que Borraba Recuerdos", "La Noche de las Luciérnagas de Hielo", "El Sol que Maduraba las Piedras", "Bajo la Luna de Sal", "El Aroma de Tierra Mojada y Fantasmas", "Donde los Árboles Sangran Savia Dorada", "La Sequía de los Cien Años de Silencio", "El Mar que Devolvía Cartas de Amor", "Tormenta de Mariposas Amarillas", "Nevada de Ceniza sobre Santa María", "El Día que las Nubes Bajaron a Caminar", "La Niebla con Sabor a Café", "El Terremoto que Reordenó el Pasado", "Cuando las Estrellas Llovieron Peces", "El Pantano que Susurraba Profecías", "La Flor que Florecía en Invierno Perpetuo", "El Eco de la Cascada Invertida", "La Isla que Flotaba al Amanecer",
            // Títulos con objetos/lugares mágicos
            "La Casa de los Espejos Inciertos", "El Reloj que Marcaba el Tiempo del Corazón", "La Silla donde se Sentó la Muerte", "El Mapa que Dibujaba Deseos", "La Taza de Café con Fondos Infinitos", "El Baúl de los Secretos Flotantes", "La Biblioteca de Libros No Escritos", "El Pueblo que Aparecía cada Luna Llena", "La Calle Donde el Tiempo se Detuvo", "El Pozo de los Lamentos Secos", "La Tienda de Remedios Olvidados", "El Faro que Guiaba a los Fantasmas", "La Cocina Donde la Comida Lloraba", "El Piano que Tocaba Melodías del Futuro", "La Cama que Inducía Sueños Compartidos", "El Puente Hecho de Suspiros", "Las Ruinas que Reconstruían Historias", "El Jardín de Estatuas Vivas", "La Ventana Hacia Otros Mundos", "El Mercado de Sombras y Recuerdos",
            // Títulos centrados en personajes y sus dones/maldiciones
            "El Hombre que Podía Volar los Martes", "La Mujer que Tejía con Hilos de Luna", "El Niño que Hablaba con los Gatos Muertos", "La Anciana que Recordaba el Futuro", "El Panadero de los Panes Tristes", "La Costurera de Destinos Cruzados", "El Pescador que Atrapaba Estrellas", "La Maestra que Enseñaba el Olvido", "El Fotógrafo de Almas Invisibles", "La Viuda que Conversaba con su Difunto Esposo", "El Músico Cuyas Notas Curaban Heridas", "El Carpintero de Muebles Vivos", "La Lavandera de Pecados Ajenos", "El Cartero de Cartas Imposibles", "La Niña con Ojos de Agua de Mar", "El Sacerdote que Dudaba de Dios y Hablaba con Santos", "El Zapatero de Botas para Caminar sobre el Agua", "La Curandera de Males del Alma", "El Barbero que Cortaba Malos Pensamientos", "El Alfarero de Vasijas que Guardaban Ecos",
            // Títulos sobre familia y generaciones
            "La Saga de los Buendía Olvidados", "Cien Años de Soledad en la Cocina", "Los Fantasmas Hereditarios de los Pérez", "La Maldición de las Mujeres sin Sombra", "El Legado del Abuelo Alquimista", "Las Tres Vidas de mi Bisabuela Clara", "Crónica de una Familia Anunciada", "El Árbol Genealógico con Raíces Aéreas", "Los Hijos de la Lluvia y el Viento", "El Secreto Guardado Bajo Siete Llaves Familiares", "Cuando Mamá Grande se Convirtió en Mariposa", "La Casa Tomada por los Recuerdos", "Genealogía de los Hombres Invisibles", "El Álbum de Fotos Vivientes", "La Herencia del Silencio", "Los Primos que Intercambiaban Sueños", "La Última Matriarca y sus Milagros Cotidianos", "El Pacto Secreto de los Hermanos Luna", "La Profecía Escrita en la Palma de la Mano Familiar", "Nacer y Morir en Macondo (Otra Vez)",
            // Títulos con temas de amor, pérdida y tiempo
            "El Amor en los Tiempos del Olvido", "Crónica de una Muerte Anunciada por un Pájaro", "La Triste Historia de la Cándida Eréndira y su Abuela Desalmada (Versión Apócrifa)", "El Fantasma Enamorado de la Esquina", "Cuando el Tiempo se Hizo Chicle en Santa Clara", "La Memoria Líquida de los Amantes Perdidos", "El Diario de un Amor Eterno (y Repetitivo)", "Los Besos que Dejaban Sabor a Imposible", "El Día que Perdimos la Gravedad por Desamor", "La Nostalgia Embotellada", "Un Siglo de Domingos sin Ti", "El Laberinto Circular de la Pena", "Cartas Cruzadas con el Pasado", "El Río que Llevaba Olvido y Traía Recuerdos", "La Boda Interrumpida por un Milagro Inoportuno", "El Corazón que Latía en Dos Cuerpos", "Recordar es Volver a Morir un Poco", "El Perfume de la Ausencia", "La Espera Infinita en el Andén Fantasma", "Si Supieras Cuánto Te Lloró el Mar",
            // Títulos abstractos o sugerentes
            "El Olor de la Guayaba a Medianoche", "Polvo de Estrellas en el Café", "Certeza de lo Incierto", "La Mecánica del Corazón Roto", "Geografía de la Melancolía", "Manual para Llorar en Silencio", "Sinfonía de lo Inevitable", "El Color del Silencio", "Arquitectura de los Sueños", "Tratado de Milagros Menores", "Inventario de Imposibles", "La Soledad de los Números Primos (en el Trópico)", "Elogio de la Locura Cotidiana", "Breve Historia de la Eternidad Casera", "Las Venas Abiertas de un Pueblo Fantasma", "Diccionario de Intraducibles del Alma", "Física Cuántica para Corazones Rotos", "El Azar y la Necesidad (Versión Caribe)", "Fragmentos de un Discurso Amoroso (Bajo la Ceiba)", "La Insoportable Levedad del Ser (Tropicalizada)",
            // Títulos inspirados en lugares/atmósferas
            "Crónicas de Comala revisitadas", "Santa María de los Vientos Perdidos", "Macondo: Guía Turística para Fantasmas", "El Ocaso en la Ciénaga Grande", "Medianoche en el Puerto Olvidado", "Siesta Eterna en la Plaza Mayor", "Polvo y Espejismos en el Desierto de la Candelaria", "Bajo el Sol Inclemente de Yoknapatawpha (Tropical)", "Los Cafetales del Silencio", "La Calle de las Putas Tristes y los Milagros Baratos", "El Río de los Ahogados que Cantan", "La Frontera Invisible entre la Vigilia y el Sueño", "El Calor Húmedo de los Secretos", "La Luz Turbia del Amanecer en el Trópico", "El Laberinto de Callejones sin Nombre", "La Estación de Trenes donde Nadie Baja", "El Cementerio con Vista al Mar (y a la Eternidad)", "Las Montañas que Esconden Pueblos Perdidos", "La Neblina Perpetua de San Cristóbal", "El Hotel de los Viajeros sin Destino",
             // Más Títulos (Combinaciones)
            "El Gato Negro que Predecía Lluvias de Peces", "La Abuela que Flotaba Después de Comer Chocolate", "Memorias de mis Putas Alegres (con Fantasmas)", "El Coronel que Esperaba una Carta del Más Allá", "La Increíble y Triste Historia del Relojero Ciego", "Cuando los Santos Bajaron a Jugar Dominó", "El Libro de Arena (Edición de Bolsillo)", "La Casa Tomada por Mariposas Azules", "El Hombre que Confundió a su Mujer con un Sombrero (Mágico)", "Los Funerales de la Mamá Grande (Remasterizados)", "Pedro Páramo Busca a su Padre (Otra Vez)", "El Aleph Visto Desde una Hamaca", "Rayuela Jugada con Piedras del Río", "La Muerte de Artemio Cruz (y su Fantasma)", "Aura (y sus Ecos)", "El Laberinto de la Soledad (con Salida Mágica)", "Noticia de un Secuestro (Anunciado por un Sueño)", "El Amor y Otros Demonios (Menores)", "Travesuras de la Niña Mala (y sus Milagros)", "La Fiesta del Chivo (con Espectros Invitados)",
             "El Perfume de las Guayabas Invisibles", "La Sombra del Viento (Tropical)", "Cien Años de Recetas Mágicas", "Donde Habitan los Ángeles (y los Mosquitos)", "El Corazón Helado (Literalmente)", "Dime Quién Soy (Después de la Amnesia Mágica)", "La Catedral del Mar (Hecha de Coral)", "Los Pilares de la Tierra (Sostenidos por Hormigas)", "El Juego del Ángel (Caído)", "La Reina Descalza (que Caminaba sobre el Agua)", "Invierno en el Mundo (Excepto en Macondo)", "Todo Esto Te Daré (Incluyendo un Fantasma)", "Patria (Inventada)", "El Paciente (Eterno)", "La Verdad Sobre el Caso Savolta (con Intervención Divina)", "Riña de Gatos (con Transformaciones)", "Últimas Tardes con Teresa (y su Doble)", "La Ciudad de los Prodigios (Literales)", "El Jinete Polaco (que Llegó Volando)", "Nadie Les Escribió (Porque Eran Analfabetos Mágicos)",
            // ... (Continuar generando variaciones y conceptos)
        ];
        const magicalRealismThemes = [
            "pueblos olvidados", "familias con secretos", "eventos climáticos extraños", "objetos con vida", "fantasmas cotidianos", "tiempo circular o maleable", "amor y pérdida exagerados", "milagros inesperados", "la línea borrosa entre sueño y realidad", "naturaleza exuberante y mágica", "crítica social velada", "historia y mito entrelazados", "personajes excéntricos con dones", "comida con propiedades mágicas", "la muerte como personaje o vecino", "profecías y presagios", "realidad detallada con un toque insólito", "soledad y melancolía", "lo grotesco y lo bello juntos", "la política y lo sobrenatural"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un escritor experto en el estilo del Realismo Mágico, heredero de García Márquez, Borges, Allende, Rulfo y Cortázar. Tu tarea es escribir un cuento corto original (aproximadamente 1200-1300 palabras) basado en el título proporcionado. Impregna la narrativa con las características clave del género: mezcla lo ordinario con lo extraordinario de forma naturalista, usa un tono factual incluso para eventos imposibles, ambienta la historia preferiblemente en un contexto latinoamericano (real o imaginario) rico en detalles sensoriales, explora temas como el tiempo, la memoria, el destino, la familia, el amor, la pérdida o la crítica social de manera sutil. Los elementos mágicos deben sentirse integrados en la realidad cotidiana del relato, no como fantasía pura. Evoca una atmósfera de maravilla, melancolía, ironía o extrañeza.",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
             systemPrompt: "Actúa como un analista literario perspicaz, especializado únicamente en el cuento de realismo mágico titulado '[STORY_TITLE]' que acaba de ser presentado. Responde preguntas sobre sus personajes, simbolismo, temas, elementos mágicos específicos, o posibles interpretaciones, basándote *exclusivamente* en el texto de esa historia. Mantén un tono reflexivo y erudito, acorde al género.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Actúa como un generador de ideas conciso para cuentos de Realismo Mágico. Genera exactamente 15 títulos evocadores que mezclen lo cotidiano con lo extraordinario de forma sutil. Sugiere atmósferas latinoamericanas, personajes comunes con peculiaridades, eventos naturales insólitos, u objetos con vida propia. Devuelve *solo* la lista de títulos, uno por línea. Sin números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 40
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        const footerYear = document.getElementById('footer-year');

        // ========== State Variables ==========
        let currentStoryTitle = null; // Contexto para el chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            let systemPromptToUse = config.systemPrompt;
            if (isChat && currentStoryTitle) {
                systemPromptToUse = config.systemPrompt.replace('[STORY_TITLE]', currentStoryTitle); // Inject current title
            }
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            // Seed for main story, not chat
            if (config.seed && !isChat) params.append('seed', config.seed || Math.floor(Math.random() * 100000));

            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, o la IA no pudo procesar la solicitud. Por favor, intenta de nuevo en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0 || text.toLowerCase().includes("cannot fulfill") || text.toLowerCase().includes("unable to generate")) {
                    throw new Error("La respuesta de la IA llegó vacía o no pudo generar el contenido solicitado. Intenta con otro título.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }
        async function fetchExplanationText(storyTitle) { return fetchTextFromApi(storyTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentStoryTitle) throw new Error("Error interno: Contexto del cuento no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(magicalRealismThemes) || "realismo mágico general";
            const specificPrompt = `Genera 15 títulos de cuentos inspirados en ${randomTheme}`;
            const text = await fetchTextFromApi(specificPrompt, titleGenerationConfig, false);
            const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
            if (titles.length < 5) throw new Error("La IA no generó suficientes ideas de títulos.");
            return titles.slice(0, 15);
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "escena de realismo mágico";
            const enhancedPrompt = `Evocative conceptual art in the style of magical realism, inspired by '${safePromptText}'. Dreamlike atmosphere, blend ordinary Latin American setting with subtle surreal or impossible elements. Focus on mood, symbolism, rich colors (earthy tones, vibrant accents). Painterly style. Avoid text, labels, hyperrealism.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, photorealistic, photograph, multiple images, collage, watermark, signature, ugly, deformed, blurry, low quality, simple background";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' '); // Reemplazar saltos internos con espacio
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (sin cambios funcionales)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll set to 0 on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null;
             hideFullscreenImage();
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios funcionales)
        function showFullscreenImage(imgSrc) {
            if (!imageFullscreenOverlay || !fullscreenImage) return;
            fullscreenImage.src = imgSrc;
            imageFullscreenOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function hideFullscreenImage() {
            if (!imageFullscreenOverlay) return;
            imageFullscreenOverlay.classList.remove('active');
            if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; }
            fullscreenImage.src = '';
        }

        // ========== CHAT FUNCTIONS ========== (sin cambios funcionales)
        function addChatMessage(message, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
            msgDiv.innerHTML = message;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function addChatError(message) {
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        async function handleSendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || chatSendBtn.disabled) return;
            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;
            chatLoadingIndicator.style.display = 'block';
            try {
                const aiResponse = await fetchChatResponse(userQuery);
                addChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Chat Error:", error);
                addChatError(`Error IA: ${error.message}`);
            } finally {
                chatLoadingIndicator.style.display = 'none';
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ========== UI & EVENT HANDLERS ========== (sin cambios funcionales importantes)
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Ordenar puede ser bueno, o dejarlo al azar para más descubrimiento
             // const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (titles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center italic">» No hay historias esperando ser contadas en este momento. «</p>'; return; }
             titles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentStoryTitle = title; // SET CHAT CONTEXT
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0; // Reset scroll AFTER content is visible
                console.log("Scroll set to 0 after content visible");

                // Image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-feather placeholder-icon"></i> <!-- Icono Pluma -->
                    <p>Visualizando la esencia del cuento...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                // Image element
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización artística de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded successfully.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="far fa-image placeholder-icon"></i><p>No se pudo visualizar la imagen.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p>Error al generar URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Ocurrió un error inesperado al cargar la historia.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando inspiración...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Las musas están esquivas ahora. Intenta más tarde."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al invocar relatos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Invocar Nuevos Relatos';
             }
         }

         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check essential elements
             const essentialElements = [titleListContainer, storyModal, modalCloseBtn, generateMoreBtn, titlesLoading, searchInput, noResultsMsg, chatInput, chatSendBtn, imageFullscreenOverlay, fullscreenCloseBtn, footerYear];
             if (essentialElements.some(el => !el)) {
                 console.error("Initialization failed: Missing essential UI elements.");
                 document.body.innerHTML = '<p style="color: #8B4513; font-size: 1.5em; text-align: center; padding-top: 3em; font-family: serif;">Error Crítico: La magia no pudo cargar la página correctamente.</p>';
                 return;
             }

            // Set Footer Year
            footerYear.textContent = new Date().getFullYear();

            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles); // Display initial titles
            noResultsMsg.classList.add('hidden');
            console.log("Susurros Mágicos Initialized.");
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>