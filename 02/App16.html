<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO Title -->
    <title>AI Icon Generator - Vector & Flat Icon Ideas | Icon Spark AI by PapitasFritas.com</title>
    <!-- Meta Description (Add a relevant description) -->
    <!-- <meta name="description" content="Genera ideas visuales únicas para iconos con IA. Introduce un concepto (guardar, perfil, configuración) y obtén 4 estilos de iconos vectoriales o planos con Icon Spark AI en PapitasFritas.com. ¡Inspiración instantánea para UI/UX!"> -->

    <style>
        /* --- Reset & Base Styles --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg-color: #0f0f20; /* Slightly different dark blue/purple */
            --primary-neon: #00f0ff;
            --secondary-neon: #ff00ff;
            --accent-neon: #39ff14; /* Green accent */
            --error-neon: #ff4d4d;
            --text-color: #e8e8e8;
            --border-color: rgba(0, 240, 255, 0.4);
            --glow-primary: 0 0 6px var(--primary-neon), 0 0 12px var(--primary-neon), 0 0 18px rgba(0, 240, 255, 0.6);
            --glow-secondary: 0 0 6px var(--secondary-neon), 0 0 12px var(--secondary-neon), 0 0 18px rgba(255, 0, 255, 0.6);
            --glow-accent: 0 0 6px var(--accent-neon), 0 0 12px var(--accent-neon);
            --glow-error: 0 0 5px var(--error-neon), 0 0 10px var(--error-neon);
            --input-bg: rgba(255, 255, 255, 0.08);
        }
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap');

        body {
            font-family: 'Rajdhani', sans-serif; background-color: var(--bg-color); color: var(--text-color);
            line-height: 1.6; padding: 2rem; display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
             /* Subtle grid background */
            background-image:
                linear-gradient(rgba(0, 240, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        /* --- Layout & Container --- */
        .container {
            width: 100%; max-width: 900px; margin: 20px auto; padding: 2rem 2.5rem;
            background: rgba(10, 10, 25, 0.8); /* Slightly transparent dark background */
            border: 1px solid var(--border-color); border-radius: 12px; backdrop-filter: blur(5px);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.6), inset 0 0 10px rgba(0, 240, 255, 0.1);
            text-align: center;
        }
        /* --- Header --- */
        header { margin-bottom: 2.5rem; }
        /* SEO H1 */
        h1 {
            font-family: 'Orbitron', sans-serif; font-size: 2.4em; color: var(--primary-neon); text-shadow: var(--glow-primary);
            margin-bottom: 0.5em; letter-spacing: 1px; font-weight: 700;
        }
        /* SEO Subtitle */
        .subtitle {
            font-size: 1.2em; color: var(--secondary-neon); text-shadow: 0 0 5px var(--secondary-neon);
            font-weight: 400; max-width: 600px; margin: 0 auto; /* Center */
        }
        /* --- Controls --- */
        .controls { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2.5rem; align-items: center; }
        .input-label { font-size: 1.2em; color: var(--accent-neon); text-shadow: var(--glow-accent); margin-bottom: 0.3rem; font-weight: 600; }
        #conceptInput {
            width: 100%; max-width: 500px; padding: 10px 15px; font-size: 1em; background-color: var(--input-bg);
            border: 1px solid var(--accent-neon); border-radius: 6px; color: var(--text-color); transition: all 0.3s ease;
            box-shadow: inset 0 0 8px rgba(57, 255, 20, 0.2); /* Accent glow inset */
        }
        #conceptInput:focus { outline: none; border-color: var(--primary-neon); box-shadow: inset 0 0 10px rgba(0, 240, 255, 0.4), 0 0 10px var(--primary-neon); }
        #generateBtn {
            padding: 10px 25px; font-family: 'Orbitron', sans-serif; font-size: 1.1em; font-weight: 700;
            color: var(--bg-color); background: linear-gradient(45deg, var(--accent-neon), var(--primary-neon)); /* Accent to Primary */
            border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase;
            letter-spacing: 1px; box-shadow: 0 0 8px rgba(57, 255, 20, 0.5), 0 0 8px rgba(0, 240, 255, 0.5);
        }
        #generateBtn:hover:not(:disabled) { box-shadow: 0 0 12px var(--accent-neon), 0 0 12px var(--primary-neon); transform: translateY(-2px); }
        #generateBtn:active:not(:disabled) { transform: translateY(0); }
        #generateBtn:disabled { opacity: 0.6; cursor: not-allowed; background: grey; box-shadow: none; }

        /* --- Results Grid (Adjusted for Icons) --- */
        .results-grid {
            display: grid;
            /* Make columns smaller for icons */
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* Smaller minmax */
            gap: 1.5rem; margin-top: 2rem;
        }
        /* --- Icon Container & Image --- */
        .icon-container {
            position: relative; aspect-ratio: 1 / 1; background-color: rgba(255, 255, 255, 0.04);
            border-radius: 8px; overflow: hidden; border: 1px solid rgba(0, 240, 255, 0.2);
            display: flex; justify-content: center; align-items: center; text-align: center; /* Center error text too */
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s;
            cursor: pointer;
        }
        .icon-container:hover:not(.failed) { transform: scale(1.05); box-shadow: 0 0 15px var(--secondary-neon); border-color: var(--secondary-neon); }
        .icon-container.failed { cursor: not-allowed; border-color: var(--error-neon); box-shadow: var(--glow-error); }
        .icon-image { display: block; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.6s ease-in-out; }
        .icon-image.loaded { opacity: 1; }

        /* --- Loading / Feedback / Error States --- */
        .feedback-area { min-height: 25px; text-align: center; margin-top: 1.5rem; }
        .loading-indicator, .error-message { font-size: 1em; padding: 8px 12px; border-radius: 5px; display: inline-block; font-weight: 600; }
        .loading-indicator { color: var(--accent-neon); text-shadow: var(--glow-accent); animation: pulse 1.5s infinite ease-in-out; border: 1px dashed var(--accent-neon); }
        .error-message { color: var(--error-neon); background-color: rgba(255, 77, 77, 0.15); border: 1px solid var(--error-neon); }

        /* Spinner inside icon container */
        .icon-container.loading::before {
            content: ''; position: absolute; width: 30px; height: 30px;
            border: 3px solid rgba(0, 240, 255, 0.4); border-top-color: var(--primary-neon);
            border-radius: 50%; animation: spin 1s linear infinite; z-index: 1;
        }
        /* Style for failed icon container */
        .icon-container.failed { background-color: rgba(255, 77, 77, 0.1); color: var(--error-neon); font-size: 0.8em; padding: 5px; }
        .icon-container.failed::before { display: none; } /* Hide spinner on final error */
        .icon-container .error-content { /* Specific class for error text */ font-weight: normal; }
        .icon-container .retry-info { font-size: 0.9em; color: var(--secondary-neon); margin-top: 3px; display: block; }

        /* --- Footer --- */
        footer { margin-top: 3rem; text-align: center; font-size: 0.9em; color: rgba(232, 232, 232, 0.7); }
        footer a { color: var(--secondary-neon); text-decoration: none; transition: color 0.3s, text-shadow 0.3s; }
        footer a:hover { color: var(--primary-neon); text-shadow: 0 0 5px var(--primary-neon); }

        /* --- Lightbox (Identical to previous examples) --- */
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; backdrop-filter: blur(4px); }
        #lightbox.active { display: flex; }
        #lightbox img { display: block; max-width: 90%; max-height: 90%; object-fit: contain; border: 2px solid var(--primary-neon); box-shadow: var(--glow-primary); }
        #lightbox .close-btn { position: absolute; top: 20px; right: 30px; font-size: 2.5rem; color: var(--text-color); cursor: pointer; line-height: 1; transition: color 0.3s, text-shadow 0.3s; text-shadow: 0 0 5px rgba(0, 0, 0, 0.7); }
        #lightbox .close-btn:hover { color: var(--secondary-neon); text-shadow: var(--glow-secondary); }

        /* --- Animations --- */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Responsiveness --- */
        @media (max-width: 768px) {
            .container { padding: 1.5rem; }
            h1 { font-size: 2em; }
            .subtitle { font-size: 1.1em; }
            .results-grid { grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 1rem; }
        }
        @media (max-width: 480px) {
            body { padding: 1rem; }
            .container { padding: 1.5rem 1rem; }
            h1 { font-size: 1.8em; }
            .subtitle { font-size: 1em; }
            #generateBtn { font-size: 1em; }
            .results-grid { grid-template-columns: repeat(2, 1fr); gap: 1rem; } /* Force 2 columns */
            #lightbox .close-btn { top: 15px; right: 20px; font-size: 2rem; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Icon Spark AI</h1>
            <p class="subtitle">Genera Ideas Visuales para Iconos con Inteligencia Artificial</p>
        </header>

        <main>
            <div class="controls">
                <label for="conceptInput" class="input-label">Introduce tu Concepto:</label>
                <input type="text" id="conceptInput" placeholder="Ej: guardar, configuración, usuario, cohete, idea...">
                <button id="generateBtn">Generar Ideas</button>
            </div>

            <!-- Area for global feedback -->
            <div id="feedback" class="feedback-area" aria-live="polite"></div>

            <div id="resultsGrid" class="results-grid">
                <!-- Los iconos generados aparecerán aquí -->
            </div>
        </main>
    </div>

    <div id="lightbox">
        <span class="close-btn">&times;</span>
        <img id="lightbox-img" src="" alt="Icono Ampliado">
    </div>

    <footer>
        Herramienta por <a href="https://papitasfritas.com/" target="_blank" rel="noopener noreferrer">PapitasFritas.com</a> | Imágenes via <a href="https://pollinations.ai/" target="_blank" rel="noopener noreferrer">Pollinations.ai</a>
    </footer>

    <script>
        // --- DOM References ---
        const conceptInput = document.getElementById('conceptInput');
        const generateBtn = document.getElementById('generateBtn');
        const resultsGrid = document.getElementById('resultsGrid');
        const feedbackDiv = document.getElementById('feedback');
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const closeBtn = document.querySelector('#lightbox .close-btn');

        // --- Configuration ---
        const NUM_ICONS_PER_CONCEPT = 4; // Number of icon ideas to generate
        const ICON_WIDTH = 512;         // Request higher quality
        const ICON_HEIGHT = 512;
        const PROMPT_SUFFIX = ", simple icon, vector style, flat design, high quality, clean background"; // Auto-added prompt parts
        const MAX_RETRIES = 2;          // Max retries per image load
        const RETRY_DELAY_MS = 1500;    // Delay before retrying
        const IMAGE_LOAD_TIMEOUT_MS = 50000; // Timeout per image load attempt (slightly longer)
        const API_BASE_URL = "https://image.pollinations.ai/prompt/";

        // --- Event Listeners ---
        generateBtn.addEventListener('click', handleGeneration);
        conceptInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleGeneration();
            }
        });
        // Lightbox listeners
        closeBtn.addEventListener('click', closeLightbox);
        lightbox.addEventListener('click', (event) => { if (event.target === lightbox) closeLightbox(); });
        document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && lightbox.classList.contains('active')) closeLightbox(); });

        // --- Core Generation Logic ---
        function handleGeneration() {
            const concept = conceptInput.value.trim();
            if (!concept) {
                showFeedback('error', '¡Introduce un concepto para generar iconos!');
                return;
            }

            // **Crucial:** Clear previous results *before* disabling button/showing loading
            clearResults();
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generando...';
            showFeedback('loading', `Generando ${NUM_ICONS_PER_CONCEPT} ideas para "${concept}"...`);

            const basePrompt = `${concept}${PROMPT_SUFFIX}`;
            console.log("Base Prompt:", basePrompt);

            let iconsInitiated = 0;

            for (let i = 0; i < NUM_ICONS_PER_CONCEPT; i++) {
                iconsInitiated++;
                // **Crucial:** Generate a NEW random seed for EACH icon EVERY time
                const seed = Math.floor(Math.random() * 1000000);
                const encodedPrompt = encodeURIComponent(basePrompt);
                const imageUrl = `${API_BASE_URL}${encodedPrompt}?width=${ICON_WIDTH}&height=${ICON_HEIGHT}&seed=${seed}&nologo=true`;

                // Create container immediately
                const iconContainer = document.createElement('div');
                iconContainer.className = 'icon-container loading'; // Start as loading
                iconContainer.dataset.concept = concept; // Store concept for potential error messages
                iconContainer.dataset.seed = seed; // Store seed for reference
                iconContainer.dataset.retries = 0; // Initialize retries

                // Append container to grid
                resultsGrid.appendChild(iconContainer);

                // Start image loading process with retry logic for this container
                loadImageWithRetry(iconContainer, imageUrl, concept);
            }

            // Initial check (checkAllIconsDone will handle final state)
             checkAllIconsDone(NUM_ICONS_PER_CONCEPT);
        }

        // --- Image Loading with Retry Logic (Adapted from App04/Moodboard) ---
        function loadImageWithRetry(container, imageUrl, concept) {
            let timeoutId;

            // Create the image element for this attempt
            const img = document.createElement('img');
            img.className = 'icon-image';
            img.alt = `Idea de icono para: ${concept} (Seed: ${container.dataset.seed})`; // Descriptive alt text

            // Clear previous state (like error messages) before loading
            container.classList.add('loading');
            container.classList.remove('failed', 'loaded'); // 'loaded' on container might not be needed, but clear it
             // Remove previous error/retry messages if any
             const existingErrorDiv = container.querySelector('.error-content');
             if (existingErrorDiv) existingErrorDiv.remove();
            container.innerHTML = ''; // Clear container
            container.appendChild(img); // Add the new image element

            img.onload = () => {
                clearTimeout(timeoutId); // Clear the timeout
                container.classList.remove('loading', 'failed');
                img.classList.add('loaded'); // Add class for image opacity transition
                // Add lightbox click listener ONCE on successful load
                container.addEventListener('click', () => openLightbox(imageUrl));
                console.log(`Icono cargado con éxito para "${concept}" (Seed: ${container.dataset.seed})`);
                checkAllIconsDone(NUM_ICONS_PER_CONCEPT); // Check if all are done
            };

            img.onerror = (err) => {
                clearTimeout(timeoutId); // Clear the timeout
                console.error(`Error cargando imagen de icono para "${concept}" (Seed: ${container.dataset.seed}): ${imageUrl}`, err);
                handleImageLoadFailure(container, img, imageUrl, concept, 'Error de carga');
            };

            // Set the src *after* attaching listeners
            img.src = imageUrl;

            // Set a timeout for this specific load attempt
            timeoutId = setTimeout(() => {
                if (container.classList.contains('loading') && !img.complete) { // Check if still loading
                    console.warn(`Timeout de carga para "${concept}" (Seed: ${container.dataset.seed}): ${imageUrl}`);
                    img.src = ''; // Stop trying to load the timed-out image
                    handleImageLoadFailure(container, img, imageUrl, concept, 'Timeout');
                }
            }, IMAGE_LOAD_TIMEOUT_MS);
        }

        function handleImageLoadFailure(container, img, imageUrl, concept, reason) {
            const currentRetries = parseInt(container.dataset.retries || 0);
            const seed = container.dataset.seed;

            if (currentRetries < MAX_RETRIES) {
                container.dataset.retries = currentRetries + 1;
                const attempt = currentRetries + 1;
                console.log(`Reintentando carga de icono para "${concept}" (Seed: ${seed}, Intento: ${attempt}/${MAX_RETRIES})...`);

                // Show retry indicator WITHIN the container
                container.classList.remove('loading'); // Temporarily remove loading
                container.classList.add('failed'); // Indicate an issue occurred
                container.innerHTML = ''; // Clear previous content
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-content';
                errorDiv.innerHTML = `${reason}<br><span class="retry-info">Reintento ${attempt}/${MAX_RETRIES}...</span>`;
                container.appendChild(errorDiv);

                // Use setTimeout for delay before retry (with exponential backoff)
                const delay = RETRY_DELAY_MS * Math.pow(2, currentRetries);
                setTimeout(() => {
                    loadImageWithRetry(container, imageUrl, concept); // Retry loading
                }, delay);

            } else {
                // Max retries reached, mark as permanent error
                console.error(`Máximos reintentos (${MAX_RETRIES}) alcanzados para icono "${concept}" (Seed: ${seed}). Desistiendo.`);
                container.classList.remove('loading');
                container.classList.add('failed');
                container.innerHTML = ''; // Clear previous content
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-content';
                errorDiv.textContent = `Error final: ${reason}`;
                container.appendChild(errorDiv);

                checkAllIconsDone(NUM_ICONS_PER_CONCEPT); // Check if others finished
            }
        }

        // --- Completion Check (Adapted from App04/Moodboard) ---
        function checkAllIconsDone(totalExpected) {
            if (!totalExpected) return;

            const containers = resultsGrid.querySelectorAll('.icon-container');

            // Wait until the expected number of containers are added
            if (containers.length < totalExpected) {
                return; // Still creating containers
            }

            const allAccountedFor = Array.from(containers).every(
                cont => !cont.classList.contains('loading') // Either loaded or failed
            );

            if (allAccountedFor) {
                showFeedback(''); // Clear global loading/error message
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generar Ideas';

                // Count errors for final feedback
                const errorCount = resultsGrid.querySelectorAll('.icon-container.failed').length;
                 if (errorCount > 0) {
                    showFeedback('error', `${errorCount} de ${totalExpected} ideas de icono no pudieron cargarse.`);
                } else {
                     // Optional: Global success message
                    // showFeedback('success', '¡Ideas de icono generadas!');
                    console.log("Generación de iconos completada.");
                }
            } else {
                 // Update loading message if still waiting
                 const currentDoneOrFailed = Array.from(containers).filter(c => !c.classList.contains('loading')).length;
                 showFeedback('loading', `Generando ${totalExpected} ideas... (${currentDoneOrFailed}/${totalExpected})`);
            }
        }

        // --- UI Helper Functions ---
        function showFeedback(type, message) {
            feedbackDiv.innerHTML = ''; // Clear previous messages
            if (!message) return; // If message is empty, just clear

            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            messageElement.className = type === 'error' ? 'error-message' : type === 'loading' ? 'loading-indicator' : ''; // Add more types if needed
            feedbackDiv.appendChild(messageElement);
        }

        function clearResults() {
            resultsGrid.innerHTML = '';
            feedbackDiv.innerHTML = ''; // Clear feedback area too
             // If there are specific success messages elsewhere, clear them too
        }

         // --- Lightbox Functions (Unchanged) ---
         function openLightbox(imageUrl) {
            lightboxImg.src = imageUrl;
            lightboxImg.alt = "Icono Ampliado"; // Reset alt text
            lightbox.classList.add('active');
        }
        function closeLightbox() {
            lightbox.classList.remove('active');
            lightboxImg.src = ""; // Clear src
            lightboxImg.alt = "";
        }

         // Optional: Preconnect
         document.addEventListener('DOMContentLoaded', () => {
             const preconnectLink = document.createElement('link'); preconnectLink.rel = 'preconnect'; preconnectLink.href = 'https://image.pollinations.ai'; document.head.appendChild(preconnectLink);
         });

    </script>

</body>
</html>