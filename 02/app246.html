<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panteón Crossover - Mitos Reimaginados</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Clásicas/Épicas -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Panteón Crossover --- */
        :root {
            --color-primary: #ffd700; /* Dorado */
            --color-secondary: #4682b4; /* Azul Acero (Nórdico) */
            --color-tertiary: #e0e0e0; /* Mármol Claro */
            --color-background: #f5f5f5; /* Blanco Hueso/Mármol Muy Claro */
            --color-text: #333333; /* Gris Oscuro Casi Negro */
            --color-text-muted: #6c757d; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco Puro */
            --color-border: #d1d5db; /* Borde Gris Claro */
            --color-error-bg: #fff5f5; /* Fondo error rosa pálido */
            --color-error-text: #c53030; /* Texto error rojo oscuro */
            --color-error-border: #fca5a5; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0 / 0.1);
            --border-radius: 4px; /* Bordes suavemente redondeados */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Merriweather', serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.75; }
        h1, h2, h3, h4, .logo { font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); filter: drop-shadow(0 1px 1px rgba(0,0,0,0.4)); }
        h1.page-title { color: var(--color-text); }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; }
        #modal-title { color: var(--color-secondary); } /* Azul para título modal */
        .navbar { background-color: white; box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1.1rem 0.8rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Merriweather'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.3rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.4rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px; font-family: 'Merriweather'; font-size: 1.05rem; border-left: 4px solid transparent; }
        .title-item i { color: var(--color-secondary); margin-bottom: 0.5rem; font-size: 1.2em; opacity: 0.7; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-secondary); border-left-color: var(--color-primary); background-color: #f8f8ff; /* Lavender blush ligero */ }
        .title-item:hover i { color: var(--color-primary); opacity: 1; }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-primary), #daa520); /* Dorado a dorado oscuro */ color: #333; padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Cinzel', serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; text-shadow: none; box-shadow: var(--shadow-sm); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, #daa520, var(--color-primary)); box-shadow: var(--shadow-md); transform: scale(1.02); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: #333; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(50, 50, 50, 0.85); /* Overlay gris */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 980px; /* Un poco más ancho */
            width: 95%;
            max-height: 90vh;
            min-height: 500px; /* Mayor altura para juego y chat */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e5e7eb; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) #e5e7eb; }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: #e5e7eb; border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 1px solid #d1d5db; }

        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-secondary); font-weight: 700; }
        #modal-content em { color: #8b4513; /* Marrón silla (pergamino) */ font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Cinzel', serif; margin-top: 2.3em; margin-bottom: 1.2em; color: var(--color-text); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.6em; color: var(--color-secondary); }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: #a0522d; } /* Sienna */
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none; }
        #modal-content .final-image { display: block; max-width: 75%; height: auto; margin: 3rem auto 1.5rem auto; border: 2px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); text-align: center; }
        #modal-content .image-placeholder .spinner { border: 4px solid #e5e7eb; width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1.2s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; margin-bottom: 0.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 260px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #fafafa; scroll-behavior: smooth;
             scrollbar-width: thin; scrollbar-color: var(--color-secondary) #e5e7eb; }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: #e5e7eb; border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.7rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; box-shadow: var(--shadow-sm); }
        .user-message { background-color: var(--color-secondary); color: white; margin-left: auto; text-align: left; }
        .ai-message { background-color: var(--color-tertiary); color: var(--color-text); margin-right: auto; text-align: left; border: 1px solid #d1d5db; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Merriweather'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-primary); color: #333; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #e6c300; }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Modal with Minigame */
        #modal-loading { text-align: center; padding: 2rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.4rem; font-family: 'Cinzel'; margin-bottom: 1rem; }
        #minigame-container { width: 90%; max-width: 450px; height: 250px; /* Fixed height for game area */ background-color: #f0f0f0; border: 2px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: inset 0 0 10px rgba(0,0,0,0.1); position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; padding: 1rem; }
        #game-status { font-family: 'Merriweather'; color: var(--color-secondary); margin-bottom: 0.5rem; font-weight: bold; height: 20px; }
        #game-area { flex-grow: 1; width: 100%; position: relative; }
        /* Styles for game elements (will be dynamically added/styled) */
        .game-clickable { cursor: pointer; transition: transform 0.1s ease; font-size: 2.5rem; position: absolute; }
        .game-clickable:active { transform: scale(0.9); }
        #power-bar-container { width: 80%; height: 20px; background-color: var(--color-border); border-radius: 10px; overflow: hidden; margin-top: 1rem; }
        #power-bar { width: 0%; height: 100%; background-color: var(--color-primary); transition: width 0.1s linear; }
        #sequence-display { margin-top: 1rem; font-size: 1.5rem; }
        #sequence-input-area button { background-color: var(--color-secondary); color: white; border: none; padding: 0.5rem 1rem; margin: 0 0.3rem; border-radius: var(--border-radius); font-size: 1.2rem; cursor: pointer; }
        #sequence-input-area button:hover { background-color: #3672a4; }
        .game-target { /* Style for clickable targets */ width: 40px; height: 40px; background-color: var(--color-secondary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; position: absolute; transition: opacity 0.3s ease, transform 0.1s ease; }
        .game-target.hit { opacity: 0; transform: scale(1.5); }
        #game-level-display { position: absolute; top: 5px; right: 10px; font-size: 0.9em; color: var(--color-text-muted); font-family: 'Merriweather'; }


        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Merriweather'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(30, 30, 30, 0.96); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: 0 0 25px rgba(255, 215, 0, 0.4); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--color-primary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); backdrop-filter: blur(3px); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: #333; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-bolt mr-2"></i> <!-- Rayo (Zeus) -->
                     Panteón Crossover
                     <i class="fas fa-hammer ml-2"></i> <!-- Martillo (Thor) -->
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">» Mitos Reimaginados «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Cuando los Mundos Chocan</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explora historias jamás contadas donde los dioses del Olimpo se encuentran con las deidades de Asgard. Elige un escenario o busca tu leyenda.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar dioses, mitos, encuentros...">
             <i class="fas fa-book-open fa-search"></i> <!-- Libro/búsqueda -->
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-scroll text-yellow-600 mr-2"></i> <!-- Pergamino -->
                 Crónicas de Dos Panteones
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Consultando los anales del destino...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» Ninguna leyenda coincide con tu búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar Más Leyendas (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading">
                 <p>Forjando la Leyenda...</p>
                 <div id="minigame-container">
                     <div id="game-level-display">Nivel: 1</div>
                     <div id="game-status">¡Gana el favor de los Dioses!</div>
                     <div id="game-area">
                         <!-- Game elements appear here -->
                     </div>
                     <!-- Elements specific to game types -->
                     <div id="power-bar-container" class="content-hidden">
                         <div id="power-bar"></div>
                     </div>
                     <div id="sequence-display" class="content-hidden"></div>
                     <div id="sequence-input-area" class="content-hidden"></div>
                 </div>
                 <p style="font-size:0.8em; color: var(--color-text-muted); margin-top: 1rem;">(Juega mientras esperas)</p>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Story text (HTML) goes here -->
                         <!-- Image and placeholder added here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> El Oráculo medita...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregúntale al Bardo sobre esta historia...">
                         <button id="chat-send-btn" aria-label="Enviar Pregunta"><i class="fas fa-feather-alt"></i></button> <!-- Pluma -->
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                 </div>
             </div>
         </div>
     </div>

     <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Historias generadas por IA, explorando encuentros ficticios entre mitologías.</p>
              <p class="mt-1">Creado con fines de entretenimiento y exploración creativa.</p>
              <p class="mt-2">© MMXXIV Panteón Crossover Archives</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Encuentros Cumbre
            "La Primera Cena en el Olimpo: Odin visita a Zeus", "El Banquete en Asgard: Hera conoce a Frigg", "Thor y Hércules: Competición de Fuerza en Nemea", "Loki se Infiltra en el Olimpo: El Caos Llega a Grecia", "Atenea y Odin: Un Debate sobre Sabiduría y Guerra", "Poseidón vs Aegir: La Batalla por el Dominio de los Mares", "Hades se Encuentra con Hel: Gobernantes del Inframundo", "Ares y Tyr: ¿Aliados o Rivales en el Campo de Batalla?", "Afrodita Intenta Seducir a Thor (con resultados inesperados)", "Apolo Desafía a Bragi a un Concurso de Poesía Épica", "Artemisa y Skadi: Una Cacería Conjunta en los Bosques Nórdicos", "Hermes Compite con Heimdall: ¿Quién es el Mensajero Más Rápido?", "Dionisio Invita a los Æsir a una Bacanal", "Hefesto Examina a Mjolnir: Un Herrero Intrigado", "Perséfone Visita Niflheim: Flores en la Helada",
            // Conflictos y Rivalidades
            "La Furia de Zeus ante la Existencia de Otros Dioses del Trueno", "La Guerra por Midgard: Olímpicos vs Æsir por la Adoración Mortal", "El Robo del Vellocino de Oro por parte de Loki", "Hera Celosa de las Valquirias", "La Intervención de Odín en la Guerra de Troya", "Thor Intenta Levantar el Monte Olimpo", "Ares Desafía a los Einherjar de Valhalla", "La Maldición de las Nornas sobre un Héroe Griego", "Hades Intenta Reclamar Almas de Valhalla", "Poseidón Inunda las Costas de Noruega", "El Engaño de Loki Causa una Disputa entre Atenea y Frigg", "El Monstruo del Caos Griego (Tifón) se Enfrenta a Jormungandr", "Hércules vs Fenrir: Duelo de Bestias", "Las Arpías Atacan el Banquete de Odín", "Conflicto entre Oráculos: Delfos vs las Visiones de una Völva",
            // Alianzas Inesperadas
            "Zeus y Odín Unen Fuerzas contra una Amenaza Cósmica Mayor (¿Titanes y Gigantes de Hielo?)", "Atenea y las Valquirias Crean una Nueva Estrategia de Batalla", "Hefesto y los Enanos de Svartalfheim Forjan un Arma Combinada", "Hermes y Loki Colaboran en un Gran Engaño (¿para bien o para mal?)", "Artemisa Ayuda a Freyja a Proteger sus Animales Sagrados", "Apolo Enseña Música a los Elfos de Alfheim", "Deméter Comparte Secretos Agrícolas con Sif", "Hércules Ayuda a Thor a Recuperar a Mjolnir (otra vez)", "Los Sátiros y los Trolls Celebran Juntos", "Las Musas Griegas Inspiran a los Skalds Nórdicos", "Esculapio y Eir Comparten Conocimientos de Sanación", "Hades Permite a Baldr Visitar los Campos Elíseos", "Poseidón Ayuda a los Vikingos a Navegar Aguas Peligrosas", "Las Nereidas y las Nornas Tejen un Destino Común", "Perseo se Une a una Incursión Vikinga",
            // Romance y Relaciones
            "El Amor Prohibido entre un Dios Olímpico y una Diosa Vanir", "Freyja Despierta el Interés de Ares", "Hel se Siente Intrigada por la Melancolía de Hades", "Idunn Comparte sus Manzanas con Perséfone", "Un Sátiro se Enamora de una Elfa Oscura", "Una Valquiria Elige a un Héroe Griego para Valhalla", "Cupido Dispara una Flecha a Odín por Error", "La Belleza de Sif Causa Envidia en el Olimpo", "Thor Queda Impresionado por la Fuerza de Atalanta", "Loki Intenta Intercambiar Roles con Hermes", "Una Ninfa del Bosque se Encuentra con un Berserker Perdido", "El Matrimonio Arreglado entre un Gigante de Hielo y una Diosa Menor Griega", "Zeus Intenta Seducir a una Valquiria (y falla)", "La Amistad Inusual entre Cerbero y Garmr", "Pan Intenta Enseñar a Bailar a los Enanos",
            // Impacto en los Mortales y el Mundo
            "Los Vikingos Descubren las Ruinas de Micenas", "Un Filósofo Griego Intenta Explicar la Existencia de Asgard", "Sacerdotes de Zeus Reaccionan a un Avistamiento de Mjolnir", "Los Héroes de Ambas Mitologías se Encuentran en el Inframundo", "El Oráculo de Delfos Predice el Ragnarok", "Una Völva Tiene Visiones de la Titanomaquia", "La Fusión de Criaturas: ¿Centauros con Cuernos de Alce?", "Los Mortales Intentan Elegir a Qué Panteón Adorar", "La Construcción de un Templo Híbrido Greco-Nórdico", "Festivales que Mezclan Tradiciones Olímpicas y Asgardianas", "El Laberinto del Minotauro Aparece en las Costas de Escandinavia", "Los Berserkers Adoptan Tácticas de la Falange Hoplita", "Una Trirreme Griega Encuentra un Drakkar Vikingo en Medio del Océano", "El Impacto del Hidromiel Nórdico en las Celebraciones Griegas", "La Reacción de los Filósofos Estoicos a la Furia Berserker",
            // Escenarios "¿Qué pasaría si...?"
            "¿Qué pasaría si Odín hubiera sacrificado su ojo en la Fuente de Mimir por conocimiento griego?", "¿Y si Loki fuera el responsable de la Guerra de Troya?", "¿Cómo reaccionaría Hércules al enterarse del Ragnarok?", "¿Podrían las Nornas cambiar el destino de Edipo?", "¿Qué arma elegiría Atenea en Asgard?", "¿Y si Zeus intentara gobernar los Nueve Mundos?", "¿Podría Thor sobrevivir al Tártaro?", "¿Cómo sería una alianza entre Hades y Loki?", "¿Qué pasaría si Afrodita recibiera el collar Brisingamen?", "¿Y si Kratos (God of War) se encontrara con ambos panteones simultáneamente?", "¿Podrían los Titanes derrotar a los Gigantes de Hielo?", "¿Qué pasaría si el Minotauro custodiara el Bifrost?", "¿Y si las sirenas atrajeran a los barcos vikingos?", "¿Cómo sería una Olimpiada con atletas de ambos mundos?", "¿Podrían los filósofos griegos calmar la ira de un dios nórdico?",
            // ... (Continuar expandiendo con más combinaciones y escenarios)
            // Nota: Llegar a 400+ títulos únicos y significativos es un reto. Se enfoca en diversidad.
        ];
        const crossoverThemes = [
            "Encuentros entre Zeus y Odin", "Conflictos Thor vs Hércules", "Intrigas de Loki en el Olimpo", "Alianzas Atenea y Frigg", "Batallas navales Poseidón vs Aegir", "Gobernantes del Inframundo Hades y Hel", "Rivalidades Ares y Tyr", "Romances inesperados entre panteones", "Impacto en Midgard/Grecia Antigua", "Fusión de monstruos mitológicos", "Predicciones Oráculo vs Nornas", "Viajes entre Olimpo y Asgard", "Comparación de armas divinas (Mjolnir vs Rayo)", "Festivales y rituales combinados", "Héroes griegos en Valhalla", "Vikingos explorando el Mediterráneo", "Debates filosóficos Odin vs Sócrates", "Consecuencias de magia nórdica en Grecia", "Intervención divina cruzada en guerras mortales", "Creación de mitos híbridos"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un Bardo experto, un narrador de mitos y leyendas con profundo conocimiento de las mitologías griega y nórdica. Tu tarea es tejer una HISTORIA FICTICIA ORIGINAL basada en el escenario de encuentro o conflicto entre estos dos panteones que se te indica. Enfócate en la interacción de los personajes, sus motivaciones, diálogos creíbles (adaptados a su personalidad mitológica), el desarrollo de la trama y una resolución coherente dentro de la lógica fantástica del crossover. Describe escenarios vívidos y atmósferas que mezclen elementos de ambos mundos. La historia debe tener aproximadamente 1200-1300 palabras. Basa tu relato únicamente en el siguiente escenario:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
             systemPrompt: "Actúa como el Bardo que contó la historia anterior. Responde preguntas de seguimiento sobre los personajes, eventos o detalles de esa narrativa específica de crossover Greco-Nórdico. Mantén el tono épico y el conocimiento del relato. Sé conciso y enfócate en la historia ya contada.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Eres un generador de ideas para sagas épicas. Crea exactamente 40 títulos o ganchos argumentales ÚNICOS y CONCISOS para historias FICTICIAS que involucren INTERACCIONES SIGNIFICATIVAS (alianzas, conflictos, romances, malentendidos) entre personajes, criaturas o conceptos de la MITOLOGÍA GRIEGA y la MITOLOGÍA NÓRDICA. Devuelve *solo* la lista, una por línea, sin números ni introducciones.",
            timeoutSeconds: 60 // Un poco más de tiempo para generar 40
        };

        // ========== DOM ELEMENTS ==========
        // ... (Igual que antes: searchInput, titleListContainer, etc.) ...
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Área scrollable
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameContainer = document.getElementById('minigame-container');
        const gameStatus = document.getElementById('game-status');
        const gameArea = document.getElementById('game-area');
        const powerBarContainer = document.getElementById('power-bar-container');
        const powerBar = document.getElementById('power-bar');
        const sequenceDisplay = document.getElementById('sequence-display');
        const sequenceInputArea = document.getElementById('sequence-input-area');
        const gameLevelDisplay = document.getElementById('game-level-display');


        // ========== State Variables ==========
        let currentStoryTitle = null;
        let minigameInterval = null;
        let minigameTimeout = null;
        let gameLevel = 1; // Nivel inicial
        let gameScore = 0;
        let currentGameType = null; // 'power', 'target', 'sequence'
        let gameActive = false;
        const GAME_DURATION = 10000; // 10 segundos por juego (ajustable)

        // ========== MINIGAME LOGIC ==========
        const gameTypes = ['power', 'target', 'sequence'];
        const gameSymbols = ['<i class="fas fa-bolt"></i>', '<i class="fas fa-hammer"></i>', '<i class="fas fa-scroll"></i>', '<i class="fas fa-shield-alt"></i>', '<i class="fas fa-eye"></i>']; // Rayo, Martillo, Pergamino, Escudo, Ojo(Odin)

        function loadGameLevel() {
            const savedLevel = localStorage.getItem('minigameLevel');
            gameLevel = savedLevel ? parseInt(savedLevel, 10) : 1;
            gameLevelDisplay.textContent = `Nivel: ${gameLevel}`;
        }

        function saveGameLevel() {
            localStorage.setItem('minigameLevel', gameLevel.toString());
        }

        function increaseGameLevel() {
            gameLevel++;
            saveGameLevel();
            gameLevelDisplay.textContent = `Nivel: ${gameLevel}`;
        }

        function resetGameArea() {
            gameArea.innerHTML = '';
            powerBarContainer.classList.add('content-hidden');
            sequenceDisplay.classList.add('content-hidden');
            sequenceInputArea.classList.add('content-hidden');
            powerBar.style.width = '0%';
            gameScore = 0;
        }

        function startGame() {
            if (gameActive) return; // Evitar iniciar múltiples veces
            console.log("Starting Minigame - Level:", gameLevel);
            loadGameLevel(); // Cargar nivel actual
            gameActive = true;
            resetGameArea();
            currentGameType = gameTypes[Math.floor(Math.random() * gameTypes.length)];
            gameStatus.textContent = "¡Rápido!";

            switch (currentGameType) {
                case 'power': setupPowerGame(); break;
                case 'target': setupTargetGame(); break;
                case 'sequence': setupSequenceGame(); break;
            }

            // Detener el juego después de un tiempo (incluso si la API es más rápida)
            clearTimeout(minigameTimeout);
            minigameTimeout = setTimeout(endGame, GAME_DURATION + 1000); // Da 1 seg extra
        }

        function endGame() {
            if (!gameActive) return;
            console.log("Ending Minigame - Score:", gameScore);
            gameActive = false;
            clearInterval(minigameInterval);
            clearTimeout(minigameTimeout); // Limpiar timeout explícito
            gameStatus.textContent = "¡Favor Obtenido!"; // O mensaje según score
            // Podría añadirse lógica para aumentar nivel solo si se superó cierto score
        }

        // --- Power Game ---
        function setupPowerGame() {
            gameStatus.textContent = "¡Carga el Poder Divino!";
            powerBarContainer.classList.remove('content-hidden');
            const powerIcon = document.createElement('div');
            powerIcon.innerHTML = Math.random() > 0.5 ? '<i class="fas fa-bolt"></i>' : '<i class="fas fa-hammer"></i>'; // Alterna icono
            powerIcon.className = 'game-clickable';
            powerIcon.style.top = '40%';
            powerIcon.style.left = '50%';
            powerIcon.style.transform = 'translateX(-50%)';
            powerIcon.style.fontSize = '4rem';
            powerIcon.onclick = handlePowerClick;
            gameArea.appendChild(powerIcon);
            gameScore = 0; // Reset score for this game type
        }

        function handlePowerClick() {
            if (!gameActive || currentGameType !== 'power') return;
            gameScore++;
            const powerIncrease = 100 / (20 + gameLevel * 2); // Más clicks necesarios a mayor nivel
            const currentWidth = parseFloat(powerBar.style.width) || 0;
            const newWidth = Math.min(100, currentWidth + powerIncrease);
            powerBar.style.width = `${newWidth}%`;
            if (newWidth >= 100) {
                 gameStatus.textContent = "¡Poder al Máximo!";
                 // endGame(); // Podría terminar aquí o dejar correr el tiempo
            }
             // Efecto visual simple
             this.style.transform = 'translateX(-50%) scale(1.1)';
             setTimeout(() => { this.style.transform = 'translateX(-50%) scale(1)'; }, 50);
        }

        // --- Target Game ---
        function setupTargetGame() {
             gameStatus.textContent = "¡Defiende el Reino!";
             gameScore = 0; // Reset score
             const spawnInterval = Math.max(100, 800 - gameLevel * 50); // Más rápido a mayor nivel
             minigameInterval = setInterval(spawnTarget, spawnInterval);
             // Spawn inicial
             spawnTarget();
             spawnTarget();
        }

        function spawnTarget() {
            if (!gameActive || currentGameType !== 'target') return;
            const target = document.createElement('div');
            target.className = 'game-target game-clickable';
            target.innerHTML = Math.random() > 0.5 ? '<i class="fab fa-grunt"></i>' : '<i class="fas fa-pastafarianism"></i>'; // Orco / Gigante (iconos placeholder)
             target.style.left = `${Math.random() * 85}%`; // Evitar bordes exactos
             target.style.top = `${Math.random() * 80}%`; // Evitar bordes exactos
            target.onclick = function() {
                 if (!gameActive) return;
                 gameScore++;
                 this.classList.add('hit');
                 gameStatus.textContent = `Derrotados: ${gameScore}`;
                 setTimeout(() => this.remove(), 300); // Eliminar después de animación 'hit'
             };
             gameArea.appendChild(target);

             // Autodestrucción si no se clickea
             setTimeout(() => {
                 if (target && !target.classList.contains('hit')) {
                     target.style.opacity = '0';
                     setTimeout(() => target.remove(), 300);
                 }
             }, 2000 - gameLevel * 50); // Duran menos a mayor nivel
        }

         // --- Sequence Game ---
        let currentSequence = [];
        let playerSequence = [];
        function setupSequenceGame() {
             gameStatus.textContent = "¡Descifra el Oráculo!";
             sequenceDisplay.classList.remove('content-hidden');
             sequenceInputArea.classList.remove('content-hidden');
             generateSequence();
             displaySequence();
        }
        function generateSequence() {
             currentSequence = [];
             const sequenceLength = 2 + gameLevel; // Secuencia más larga a mayor nivel
             for (let i = 0; i < sequenceLength; i++) {
                 currentSequence.push(gameSymbols[Math.floor(Math.random() * gameSymbols.length)]);
             }
             playerSequence = [];
        }
        function displaySequence() {
             sequenceDisplay.innerHTML = 'Observa: ';
             sequenceInputArea.innerHTML = ''; // Limpiar botones
             sequenceInputArea.classList.add('content-hidden'); // Ocultar mientras se muestra

             let i = 0;
             minigameInterval = setInterval(() => {
                 if (i < currentSequence.length) {
                     sequenceDisplay.innerHTML = currentSequence[i];
                     i++;
                 } else {
                     clearInterval(minigameInterval);
                     sequenceDisplay.innerHTML = 'Tu turno...';
                     showSequenceButtons();
                 }
             }, 800 - gameLevel * 20); // Muestra más rápido a mayor nivel
        }
        function showSequenceButtons() {
             sequenceInputArea.classList.remove('content-hidden');
             // Crear botones para todos los símbolos posibles
             gameSymbols.forEach(symbol => {
                 const btn = document.createElement('button');
                 btn.innerHTML = symbol;
                 btn.onclick = () => handleSequenceInput(symbol);
                 sequenceInputArea.appendChild(btn);
             });
        }
        function handleSequenceInput(symbol) {
             if (!gameActive || currentGameType !== 'sequence' || playerSequence.length >= currentSequence.length) return;
             playerSequence.push(symbol);
             // Comprobar si el símbolo actual es correcto
             if (playerSequence[playerSequence.length - 1] !== currentSequence[playerSequence.length - 1]) {
                 gameStatus.textContent = "¡Secuencia Incorrecta!";
                 setTimeout(setupSequenceGame, 1500); // Reiniciar secuencia tras error
                 return;
             }
             // Si la secuencia está completa y correcta
             if (playerSequence.length === currentSequence.length) {
                 gameScore++;
                 gameStatus.textContent = "¡Correcto! Siguiente...";
                 setTimeout(setupSequenceGame, 1000); // Generar nueva secuencia
             }
        }


        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentStoryTitle
                 ? `Eres el Bardo que contó la historia sobre '${currentStoryTitle}'. Responde preguntas de seguimiento sobre los personajes, eventos o detalles de esa narrativa específica de crossover Greco-Nórdico. Mantén el tono épico y el conocimiento del relato. Sé conciso y enfócate en la historia ya contada.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);
             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text (Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, intenta en unos segundos.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la IA estaba vacía. Intenta reformular.");
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
         }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentStoryTitle) throw new Error("Error interno: Contexto de historia no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(crossoverThemes) || "encuentros Greco-Nórdicos";
            const specificPrompt = `Genera 40 títulos/ganchos argumentales únicos sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 10 && line.length < 150);
                     if (titles.length < 20) throw new Error("La IA no generó suficientes ideas de leyendas."); // Umbral menor por si falla en generar 40
                     return titles.slice(0, 40); // Asegura máximo 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Greek and Norse gods meeting";
             const enhancedPrompt = `Epic mythical scene depicting '${safePromptText}'. Blend Greek marble architecture/togas with Norse runes/armor/stormy skies. Focus on character interaction or dramatic landscape. Cinematic, detailed painting style. Avoid text or labels.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, photograph, realism, modern elements, simple background";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (identical to previous versions) ... */
             if (!rawText) return '';
             let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
             formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
             formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
             formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
             formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
             formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
             formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
             formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => {
                 if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                 let content = block.replace(/\n/g, ' ');
                 return `<p>${content}</p>`;
             }).join('');
             return formatted;
         }


        // ========== MODAL, IMAGE, CHAT FUNCTIONS ==========
        // (Show/Hide Modal, Reset State, Show/Hide Fullscreen, Add Chat Message/Error, Handle Send Message - mostly identical, minor text changes)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) document.body.style.overflow = '';
            modalTextArea.scrollTop = 0;
            endGame(); // Asegurarse de que el juego termine al cerrar
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex'; // Mostrar carga inicialmente
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentStoryTitle = null;
             hideFullscreenImage();
             resetGameArea(); // Limpiar área del juego
             gameActive = false; // Asegurar que el juego está inactivo
             clearInterval(minigameInterval);
             clearTimeout(minigameTimeout);
        }
        function showFullscreenImage(imgSrc) { fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() {
             imageFullscreenOverlay.classList.remove('active');
             if (!storyModal.classList.contains('active')) document.body.style.overflow = '';
             fullscreenImage.src = '';
         }
        function addChatMessage(message, sender) { /* ... (identical) ... */
             const msgDiv = document.createElement('div');
             msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message');
             message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
             msgDiv.innerHTML = message;
             chatHistory.appendChild(msgDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        function addChatError(message) { /* ... (identical) ... */
             const errorDiv = document.createElement('div');
             errorDiv.classList.add('chat-error');
             errorDiv.textContent = message;
             chatHistory.appendChild(errorDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
         }
        async function handleSendMessage() { /* ... (identical) ... */
             const userQuery = chatInput.value.trim();
             if (!userQuery || chatSendBtn.disabled) return;
             addChatMessage(userQuery, 'user');
             chatInput.value = '';
             chatSendBtn.disabled = true;
             chatLoadingIndicator.style.display = 'block';
             try {
                 const aiResponse = await fetchChatResponse(userQuery);
                 addChatMessage(aiResponse, 'ai');
             } catch (error) {
                 console.error("Chat Error:", error);
                 addChatError(`Error Bardo: ${error.message}`);
             } finally {
                 chatLoadingIndicator.style.display = 'none';
                 chatSendBtn.disabled = false;
                 chatInput.focus();
             }
         }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function createTitleItem(title) {
            const div = document.createElement('div');
            div.className = 'title-item';
            // Icono aleatorio para variedad visual
            const icons = ['fa-bolt', 'fa-hammer', 'fa-scroll', 'fa-shield-alt', 'fa-book-open', 'fa-feather-alt', 'fa-ankh', 'fa-gavel']; // Añadir más si se desea
            div.innerHTML = `<i class="fas ${getRandomElement(icons)}"></i><span>${title}</span>`;
            div.setAttribute('data-title', title);
            div.addEventListener('click', () => handleTitleClick(title));
            return div;
         }
        function displayTitles(titles) { /* ... (identical logic, uses new createTitleItem) ... */
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay leyendas disponibles «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) { /* ... (identical logic) ... */
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
        }

        // *** MODIFIED: handleTitleClick to start minigame ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal(); // Mostrar modal inmediatamente
            modalLoadingIndicator.style.display = 'flex'; // Asegurar que loading esté visible
            modalTitle.textContent = title;
            currentStoryTitle = title;
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');

            startGame(); // <--- INICIAR MINIJUEGO AQUÍ

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                endGame(); // <--- Terminar minijuego al recibir respuesta (antes de ocultar loading)
                modalLoadingIndicator.style.display = 'none'; // Ocultar loading/juego
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Mostrar contenido principal
                modalTextArea.scrollTop = 0;

                // Gestionar aumento de nivel SOLO si la carga fue exitosa
                increaseGameLevel(); // <--- Aumentar nivel para la próxima vez

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-palette placeholder-icon"></i><p style="font-size: 0.8em; margin-top: 0.5rem;">Visualizando la leyenda...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Ilustración de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Ilustración no disponible.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL de imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                endGame(); // <--- Terminar minijuego también en caso de error
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Los hilos del destino están enredados. Error al cargar.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Consultando las Nornas...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Pide 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("Las musas no respondieron. No se pudieron generar más leyendas."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar leyendas: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Revelar Más Leyendas (40)';
             }
         }

        function filterTitles(searchTerm) { /* ... (identical logic, uses normalize) ... */
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }


        // ========== INITIALIZATION ==========
        function initApp() {
            // ... (Check all essential elements including game elements) ...
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameContainer || !gameStatus || !gameArea || !gameLevelDisplay ) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">¡Los Titanes han Roto la Página! Faltan Componentes.</p>';
                return;
             }
            loadGameLevel(); // Cargar nivel guardado al inicio
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>