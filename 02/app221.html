<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trucos Productividad Windows 10 - Guía Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes limpias y modernas -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Windows 10 Tricks --- */
        :root {
            --color-primary: #0078d4; /* Azul Windows Principal */
            --color-secondary: #107c10; /* Verde (Éxito, Opcional) */
            --color-tertiary: #50e6ff; /* Cyan Claro (Énfasis) */
            --color-background: #f3f2f1; /* Gris Claro Windows */
            --color-text: #1f2937; /* Gris Muy Oscuro (Texto Principal) */
            --color-text-muted: #605e5c; /* Gris Medio Windows */
            --color-modal-bg: #ffffff; /* Blanco */
            --color-border: #e1dfdd; /* Borde Gris Claro */
            --color-error-bg: #fff1f2; /* Rosa muy claro */
            --color-error-text: #be123c; /* Rojo oscuro */
            --color-error-border: #fecdd3; /* Borde rosa claro */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.06), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 4px; /* Bordes ligeramente redondeados */
            --transition-normal: all 0.2s ease-in-out;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Roboto', sans-serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-primary); padding-bottom: 0.6rem; display: inline-block; font-weight: 500; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: var(--color-modal-bg); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Inter'; }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 0.9rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.1rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 500; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; min-height: 65px; font-family: 'Inter'; font-size: 0.95rem; position: relative; overflow: hidden; }
        .title-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background-color: var(--color-primary); opacity: 0; transition: opacity 0.2s ease; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: #c6c6c6; }
        .title-item:hover::before { opacity: 1; }
        .title-item i { margin-right: 0.7rem; color: var(--color-primary); width: 16px; text-align: center; } /* Icono opcional en item */

        #generate-more-btn { grid-column: 1 / -1; background-color: var(--color-primary); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Roboto', sans-serif; font-weight: 500; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; }
        #generate-more-btn:hover:not(:disabled) { background-color: #005a9e; box-shadow: var(--shadow-sm); }
        #generate-more-btn:disabled { background-color: #a19f9d; color: #e1dfdd; cursor: not-allowed; opacity: 0.8; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(31, 41, 55, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* Más altura para chat y juego */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: #e1dfdd; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: #ffffff; }
        #modal-title { font-size: 1.7rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid var(--color-border); }

        #modal-content { padding: 0 5px; line-height: 1.7; }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-secondary); font-style: italic; font-weight: 500;}
        #modal-content code { background-color: #f3f2f1; padding: 0.2em 0.4em; border-radius: 3px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9em; color: #c50f1f; /* Rojo oscuro para código */}
        #modal-content kbd { background-color: #e1dfdd; border: 1px solid #c6c6c6; border-radius: 3px; padding: 0.1em 0.5em; font-family: 'Segoe UI', 'Inter', sans-serif; font-size: 0.9em; box-shadow: inset 0 -1px 0 #c6c6c6;} /* Estilo teclas */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Roboto', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.4em; font-weight: 500; }
        #modal-content h1 { font-size: 1.4em; } #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: #323130; } /* Gris oscuro para h3 */
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.05); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; }

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 200px; /* Altura chat ajustada */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f8f8f8; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-primary); color: white; margin-left: auto; text-align: left; } /* Usuario a la derecha, texto a la izquierda */
        .ai-message { background-color: #e1dfdd; color: var(--color-text); margin-right: auto; text-align: left; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Inter'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2); }
        #chat-send-btn { padding: 0.6rem 1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #005a9e; }
        #chat-send-btn:disabled { background-color: #a19f9d; cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator & Minigame */
        #modal-loading { text-align: center; padding: 2rem 1rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.97); display: none; /* Hidden initially */ flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #modal-loading.active { display: flex; } /* Show when loading */
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #e1dfdd; border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1.2s linear infinite; margin: 0 auto 1rem auto; flex-shrink: 0; }
        #modal-loading p { font-weight: 500; color: var(--color-text); font-size: 1.2rem; font-family: 'Roboto'; margin-bottom: 1.5rem; flex-shrink: 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Minigame Styles */
        #loading-minigame { width: 90%; max-width: 300px; height: 150px; background-color: #e1dfdd; border: 1px solid #c6c6c6; border-radius: var(--border-radius); position: relative; overflow: hidden; margin-top: 1rem; cursor: crosshair; flex-shrink: 0; /* Prevent shrinking */ }
        #game-target { width: 25px; height: 25px; background-color: var(--color-primary); border-radius: 50%; position: absolute; cursor: pointer; transition: top 0.1s linear, left 0.1s linear; box-shadow: 0 0 8px rgba(0, 120, 212, 0.5); }
        #game-target:hover { background-color: var(--color-tertiary); }
        #game-score { position: absolute; bottom: 5px; right: 10px; font-size: 1rem; font-weight: 700; color: var(--color-text); font-family: 'Roboto'; }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1rem 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 500; font-family: 'Inter'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 1px solid var(--color-border); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: #e1dfdd; color: var(--color-text); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-2 sm:mb-0">
                 <h1 class="logo text-2xl sm:text-3xl">
                     <i class="fab fa-windows mr-2"></i> <!-- Icono Windows -->
                     Trucos Windows 10
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans">Guía Interactiva de Productividad</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-10 text-center">
             <h1 class="page-title text-4xl sm:text-5xl mb-4">Maximiza tu Productividad</h1>
             <p class="text-lg text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre atajos, configuraciones y funciones ocultas para dominar Windows 10 y trabajar más rápido.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar truco, atajo o función...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-2xl sm:text-3xl mb-8 text-center mx-auto">
                 <i class="fas fa-bolt text-yellow-500 mr-2"></i> <!-- Icono rayo/velocidad -->
                 Índice de Trucos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando trucos...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">No se encontraron trucos para tu búsqueda.</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Mostrar 40 Trucos Más
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator & Minigame Area -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Cargando detalles del truco...</p>
                 <!-- Minigame Container -->
                 <div id="loading-minigame">
                     <div id="game-target"></div>
                     <div id="game-score">Puntos: 0</div>
                 </div>
                 <p class="text-xs text-gray-500 mt-2">¡Haz clic en el objetivo mientras esperas!</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Consultando IA...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="¿Preguntas sobre este truco?">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-200 text-gray-600 py-5 mt-12 border-t border-gray-300 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Guía interactiva generada con IA sobre trucos de Windows 10.</p>
              <p class="mt-1">Verifica siempre la aplicabilidad en tu versión específica. Algunos trucos pueden requerir permisos de administrador.</p>
              <p class="mt-2">© 2025 Guía Productividad Windows</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Atajos Generales
            "Win + D: Mostrar/Ocultar Escritorio", "Win + E: Abrir Explorador de Archivos", "Win + I: Abrir Configuración", "Win + L: Bloquear PC", "Win + R: Abrir Ejecutar", "Win + X: Menú Vínculo Rápido (Power Menu)", "Win + Tab: Vista de Tareas (Timeline/Desktops)", "Win + Flechas: Ajustar Ventanas (Snap Assist)", "Win + , (coma): Vistazo al Escritorio", "Win + . (punto): Panel de Emojis y Símbolos", "Win + V: Historial del Portapapeles", "Win + Shift + S: Recorte de Pantalla (Snip & Sketch)", "Win + PrtScn: Guardar Captura de Pantalla", "Alt + Tab: Cambiar entre Aplicaciones", "Ctrl + Shift + Esc: Abrir Administrador de Tareas", "Ctrl + Alt + Supr: Opciones de Seguridad", "F5: Actualizar Ventana Activa", "F11: Modo Pantalla Completa (Navegador/Explorador)",
            // Explorador de Archivos
            "Alt + P: Mostrar/Ocultar Panel de Vista Previa", "Ctrl + N: Nueva Ventana del Explorador", "Ctrl + Shift + N: Nueva Carpeta", "Ctrl + Rueda Ratón: Cambiar Tamaño de Iconos", "Alt + Flecha Arriba: Subir un Nivel de Carpeta", "Alt + Flecha Izquierda/Derecha: Atrás/Adelante", "F2: Renombrar Archivo/Carpeta Seleccionado", "Shift + Supr: Eliminar Permanentemente", "Ctrl + C / Ctrl + X / Ctrl + V: Copiar / Cortar / Pegar", "Ctrl + Z: Deshacer Última Acción", "Barra de Direcciones como Ejecutar (cmd, powershell, etc.)", "Mostrar Extensiones de Archivo", "Añadir Carpetas a Acceso Rápido", "Usar Casillas de Verificación para Selección", "Personalizar Vistas de Carpeta", "Abrir PowerShell/Terminal desde Carpeta (Shift+Click Derecho)", "Mapear Unidad de Red", "Comprimir/Descomprimir Archivos (Zip)", "Buscar Archivos por Contenido", "Usar Filtros de Búsqueda Avanzados",
            // Barra de Tareas
            "Win + T: Navegar por Iconos de Barra de Tareas", "Win + Número (1-9): Abrir/Cambiar a App Anclada", "Win + Shift + Número: Abrir Nueva Instancia de App Anclada", "Win + B: Enfocar Área de Notificación", "Shift + Click en Icono: Abrir Nueva Instancia", "Ctrl + Shift + Click en Icono: Abrir como Administrador", "Click Derecho en Icono: Jump Lists", "Anclar/Desanclar Aplicaciones", "Mostrar/Ocultar Botón Vista de Tareas", "Mostrar/Ocultar Cortana/Búsqueda", "Añadir Barras de Herramientas (Dirección, Vínculos)", "Configurar Comportamiento de Iconos de Sistema", "Desbloquear/Bloquear Barra de Tareas", "Mover Barra de Tareas (Arriba, Izquierda, Derecha)", "Usar Iconos Pequeños", "Combinar/No Combinar Botones",
            // Menú Inicio
            "Escribir para Buscar Aplicaciones/Archivos", "Anclar/Desanclar Tiles", "Redimensionar Tiles", "Crear Carpetas de Tiles", "Desactivar Tiles Dinámicos (Live Tiles)", "Acceder al Menú 'Secreto' (Win+X)", "Anclar Elementos de Configuración al Inicio", "Desinstalar Apps desde Menú Inicio (Click Derecho)", "Mostrar Más Tiles", "Personalizar Lista de Carpetas Visibles (Documentos, Descargas, etc.)",
            // Escritorios Virtuales
            "Win + Ctrl + D: Crear Nuevo Escritorio Virtual", "Win + Ctrl + F4: Cerrar Escritorio Virtual Actual", "Win + Ctrl + Flecha Izquierda/Derecha: Cambiar entre Escritorios", "Mover Ventanas entre Escritorios (Arrastrar en Vista de Tareas)", "Mover Ventanas entre Escritorios (Click Derecho en Vista de Tareas)", "Configurar qué ventanas mostrar en Alt+Tab", "Nombrar Escritorios Virtuales (Desde build reciente)",
            // Configuración y Personalización
            "Activar Modo Oscuro", "Personalizar Colores de Acento", "Cambiar Fondo de Escritorio/Pantalla de Bloqueo", "Configurar Salvapantallas", "Ajustar Escala y Resolución de Pantalla", "Configurar Múltiples Monitores", "Administrar Notificaciones y Asistente de Concentración", "Configurar Opciones de Energía (Plan de Energía)", "Administrar Aplicaciones de Inicio", "Desinstalar Aplicaciones (Apps y Características)", "Configurar Aplicaciones Predeterminadas", "Administrar Cuentas de Usuario", "Configurar Windows Hello (Facial, Huella, PIN)", "Administrar Opciones de Privacidad (Micrófono, Cámara, Ubicación)", "Ver Historial de Actualizaciones (Windows Update)", "Liberar Espacio con Sensor de Almacenamiento", "Activar 'Modo Dios' (God Mode)", "Ajustar Configuración del Mouse/Panel Táctil", "Cambiar Idioma y Región", "Configurar Teclado (Distribución, Idiomas)",
            // Herramientas Integradas
            "Usar Recortes y Anotación (Snip & Sketch)", "Historial del Portapapeles (Win+V)", "Notas Rápidas (Sticky Notes)", "Asistente de Concentración (Focus Assist)", "Línea de Tiempo (Timeline - Win+Tab)", "Barra de Juego (Win+G) para Grabar/Capturar", "Calculadora Científica/Programador/Convertidor", "Alarmas y Reloj (Temporizador, Cronómetro)", "Mapa de Caracteres", "Visor de Eventos", "Monitor de Rendimiento", "Monitor de Recursos", "Información del Sistema", "Administrador de Discos", "Herramienta de Diagnóstico de Memoria", "Restaurar Sistema", "Liberador de Espacio en Disco (Cleanmgr)",
            // Red y Conexión
            "Win + A: Abrir Centro de Acción (Acceso rápido a WiFi/Bluetooth)", "Ver Redes WiFi Disponibles", "Olvidar una Red WiFi", "Ver Propiedades de Conexión (IP, DNS)", "Diagnosticar Problemas de Red", "Configurar VPN", "Crear un Hotspot Móvil", "Administrar Uso de Datos", "Configurar Conexión de Uso Medido",
            // PowerShell / Símbolo del Sistema (CMD)
            "Abrir CMD/PowerShell como Administrador", "Comando `ipconfig`: Ver configuración de red", "Comando `ping`: Probar conectividad", "Comando `tracert`: Trazar ruta de red", "Comando `sfc /scannow`: Reparar archivos de sistema", "Comando `chkdsk`: Comprobar errores de disco", "Comando `tasklist` / `taskkill`: Administrar procesos", "Comando `systeminfo`: Ver información del sistema", "Comando `powercfg`: Administrar energía", "Ejecutar scripts de PowerShell (.ps1)", "Copiar/Pegar en Consola (Ctrl+C/Ctrl+V habilitado)",
            // Accesibilidad
            "Win + U: Abrir Centro de Accesibilidad", "Win + (+) / (-): Zoom con Lupa", "Ctrl + Alt + L: Cambiar Modo de Lupa", "Activar Narrador", "Activar Teclado en Pantalla", "Usar Reconocimiento de Voz", "Activar Filtros de Color", "Ajustar Contraste Alto", "Configurar Teclas Especiales (Sticky Keys, Filter Keys)",
            // Rendimiento y Optimización
            "Desactivar Aplicaciones de Inicio Innecesarias", "Limitar Aplicaciones en Segundo Plano", "Ajustar Efectos Visuales para Mejor Rendimiento", "Desfragmentar y Optimizar Unidades", "Actualizar Controladores (Drivers)", "Comprobar Malware/Virus (Windows Security)", "Administrar Espacio en Disco (Sensor de Almacenamiento)", "Crear/Restaurar Punto de Restauración", "Usar el Solucionador de Problemas de Windows", "Monitorizar Temperatura de CPU/GPU (con herramientas)",
            // Trucos 'Ocultos' y Avanzados
            "Modo Dios (Carpeta con todos los applets)", "Menú Inicio Secreto (Win+X)", "Agitar Ventana para Minimizar Otras (Aero Shake)", "Historial de Archivos (File History Backup)", "Pasos para Reproducir un Problema (psr.exe)", "Monitor de Fiabilidad (Reliability Monitor)", "Configuración Avanzada del Sistema (Variables de Entorno)", "Programador de Tareas", "Editor de Registro (Regedit) - ¡Con Precaución!", "Editor de Directivas de Grupo Local (gpedit.msc) - Pro/Edu", "Sandboxing de Windows (Pro/Edu)", "Subsistema de Windows para Linux (WSL)",
            // Preguntas Comunes
            "¿Cómo personalizar la barra de tareas?", "¿Cómo usar escritorios virtuales eficazmente?", "¿Cómo liberar espacio en disco?", "¿Cómo mejorar el arranque de Windows?", "¿Cómo hacer capturas de pantalla rápido?", "¿Qué es el Asistente de Concentración?", "¿Cómo activo el historial del portapapeles?", "¿Cómo cambiar las aplicaciones predeterminadas?", "¿Cómo proteger mi privacidad en Windows 10?", "¿Cómo solucionar problemas de conexión WiFi?", "¿Para qué sirve el Administrador de Tareas?", "¿Cómo encuentro archivos perdidos?", "¿Cómo actualizo Windows 10?", "¿Cómo restauro Windows a un punto anterior?", "¿Cómo creo una nueva cuenta de usuario?", "¿Qué es Windows Hello?", "¿Cómo uso la Línea de Tiempo?", "¿Vale la pena el Modo Juego?", "¿Cómo comprimir archivos sin programas extra?", "¿Cómo conecto una impresora?"
            // ... Continuar expandiendo con más detalles, variaciones y preguntas
        ];
        const windowsThemes = [ // Temas para generar más títulos
            "atajos de teclado windows", "explorador de archivos tips", "personalización barra de tareas", "optimización menú inicio", "escritorios virtuales", "configuración windows 10", "rendimiento windows 10", "herramientas integradas windows", "seguridad windows 10", "solución problemas windows", "comandos cmd útiles", "trucos powershell", "accesibilidad windows", "privacidad windows 10", "administrador de tareas", "sensor almacenamiento", "windows update", "redes wifi windows", "modo dios windows", "registro windows tweaks", "directivas de grupo"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un experto en Windows 10 y gurú de la productividad. Tu tarea es explicar de forma clara, concisa y paso a paso el truco, atajo o función de Windows 10 que se te indica. Incluye: 1) Una breve introducción de qué es y para qué sirve. 2) Los pasos exactos para usarlo (con atajos de teclado si aplica, usando etiquetas <kbd>Win</kbd>+<kbd>E</kbd> por ejemplo). 3) Los beneficios o ventajas de usarlo. 4) Posibles variaciones, configuraciones relacionadas o consejos extra. 5) Si aplica, alguna precaución a tener en cuenta. Usa un lenguaje amigable y directo. Formatea los atajos de teclado con <kbd>Tecla</kbd>. El objetivo es una explicación útil y detallada de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente truco/función de Windows 10:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un asistente experto en Windows 10, enfocado *únicamente* en el truco o función que se está mostrando actualmente. Responde preguntas de seguimiento sobre los pasos, beneficios, o aclaraciones relacionadas. Sé breve y ve al grano.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // *** PEDIR 40 TÍTULOS ***
            systemPrompt: "Actúa como un generador de ideas conciso para una guía de productividad de Windows 10. Genera exactamente 40 nombres de trucos, atajos, funciones o preguntas comunes sobre Windows 10, adecuados para una explicación detallada. Varía los temas (teclado, archivos, configuración, rendimiento, etc.). Devuelve *solo* la lista, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Aumentar ligeramente por pedir más
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, pero añadiendo los del minijuego)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const gameContainer = document.getElementById('loading-minigame');
        const gameTarget = document.getElementById('game-target');
        const gameScoreDisplay = document.getElementById('game-score');

        // ========== State & Game Variables ==========
        let currentTrickTitle = null;
        let gameScore = 0;
        let gameIntervalId = null;
        let isGameActive = false;

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentTrickTitle
                ? `Eres un asistente experto en Windows 10, enfocado *únicamente* en el truco o función '${currentTrickTitle}'. Responde preguntas de seguimiento sobre los pasos, beneficios, o aclaraciones relacionadas. Sé breve y ve al grano.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);

            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            if (config.seed && !isChat) params.append('seed', config.seed);
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    // *** MENSAJE DE ERROR AMIGABLE ***
                    throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, por favor intenta en unos segundos.`);
                }
                const text = await response.text();
                if (!text || text.trim().length === 0) {
                    throw new Error("La respuesta de la IA llegó vacía. Intenta de nuevo.");
                }
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') {
                    throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                }
                throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
            }
        }
        async function fetchExplanationText(trickTitle) { return fetchTextFromApi(trickTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTrickTitle) throw new Error("Error interno: Contexto del truco no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(windowsThemes) || "trucos generales windows 10";
            // *** PROMPT PIDE 40 ***
            const specificPrompt = `Genera 40 nombres/conceptos/preguntas sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                .then(text => {
                    const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                    if (titles.length < 10) throw new Error("La IA no generó suficientes ideas de trucos."); // Ajustar umbral si es necesario
                    return titles.slice(0, 40); // *** DEVOLVER HASTA 40 ***
                });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 450, nologo: true }; // Aspect ratio 16:9
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Windows 10 interface screenshot concept";
             // Prompt más enfocado a UI o concepto abstracto
             const enhancedPrompt = `Conceptual image representing the Windows 10 feature or trick '${safePromptText}'. Clean UI elements, abstract representation of the function (e.g., speed lines for performance, linked boxes for virtual desktops). Avoid text unless essential (like a keycap). Style similar to Microsoft Fluent Design.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, person, people, hand, ugly, blurry, low quality, watermark, signature, multiple images, collage, realistic photograph";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ==========
        function formatExplanationText(rawText) {
            if (!rawText) return '';
            let formatted = rawText.trim();
            // Formato específico Windows: <kbd>Tecla</kbd>
            formatted = formatted.replace(/<kbd>(.*?)<\/kbd>/g, '<kbd>$1</kbd>'); // Mantener las existentes
             // Intentar detectar combinaciones comunes si no están ya con kbd
            formatted = formatted.replace(/(Win|Windows)\s*\+\s*([A-Za-z0-9.,;+´¨\[\]{}*~^<>|@#~€¬\-\_])\b/g, '<kbd>Win</kbd>+<kbd>$2</kbd>');
            formatted = formatted.replace(/Ctrl\s*\+\s*Shift\s*\+\s*([A-Za-z0-9.,;+´¨\[\]{}*~^<>|@#~€¬\-\_])\b/g, '<kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>$1</kbd>');
            formatted = formatted.replace(/Alt\s*\+\s*Shift\s*\+\s*([A-Za-z0-9.,;+´¨\[\]{}*~^<>|@#~€¬\-\_])\b/g, '<kbd>Alt</kbd>+<kbd>Shift</kbd>+<kbd>$1</kbd>');
            formatted = formatted.replace(/Ctrl\s*\+\s*Alt\s*\+\s*([A-Za-z0-9.,;+´¨\[\]{}*~^<>|@#~€¬\-\_]|Supr|Del)\b/gi, '<kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>$1</kbd>');
            formatted = formatted.replace(/Ctrl\s*\+\s*([A-Za-z0-9.,;+´¨\[\]{}*~^<>|@#~€¬\-\_])\b/g, '<kbd>Ctrl</kbd>+<kbd>$1</kbd>');
            formatted = formatted.replace(/Alt\s*\+\s*([A-Za-z0-9.,;+´¨\[\]{}*~^<>|@#~€¬\-\_]|Tab)\b/gi, '<kbd>Alt</kbd>+<kbd>$1</kbd>');
            formatted = formatted.replace(/Shift\s*\+\s*([A-Za-z0-9.,;+´¨\[\]{}*~^<>|@#~€¬\-\_]|Supr|Del|Tab)\b/gi, '<kbd>Shift</kbd>+<kbd>$1</kbd>');
             // Teclas individuales F1-F12, Esc, Supr, Enter, Tab, etc.
            formatted = formatted.replace(/\b(F[1-9]|F1[0-2]|Esc|Supr|Del|Enter|Tab|PrtScn|Impr Pant|Space|Espacio)\b/gi, '<kbd>$1</kbd>');

            // Markdown básico y estructural (igual que antes)
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             // Detectar `código` o rutas C:\...
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
            formatted = formatted.replace(/(\b[A-Za-z]:\\[^ \n\r\t<)]+)/g, '<code>$1</code>'); // Rutas de archivo básicas

            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                // Detectar listas (simplificado)
                if (block.match(/^(\*|-|\d+\.)\s+/)) {
                    const listType = block.startsWith('*') || block.startsWith('-') ? 'ul' : 'ol';
                    const items = block.split('\n').map(item => `<li>${item.replace(/^(\*|-|\d+\.)\s+/, '')}</li>`).join('');
                    return `<${listType}>${items}</${listType}>`;
                }
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
         }

        // ========== MINIGAME FUNCTIONS ==========
        function moveTarget() {
            if (!isGameActive || !gameContainer || !gameTarget) return;
            const containerRect = gameContainer.getBoundingClientRect();
            const targetSize = gameTarget.offsetWidth; // Assume square

            // Calculate max position ensuring the target stays fully inside
            const maxX = containerRect.width - targetSize;
            const maxY = containerRect.height - targetSize;

            // Generate random positions within bounds
            const randomX = Math.max(0, Math.floor(Math.random() * maxX));
            const randomY = Math.max(0, Math.floor(Math.random() * maxY));

            gameTarget.style.left = `${randomX}px`;
            gameTarget.style.top = `${randomY}px`;
        }
        function handleTargetClick() {
            if (!isGameActive) return;
            gameScore++;
            gameScoreDisplay.textContent = `Puntos: ${gameScore}`;
            moveTarget();
        }
        function startGame() {
            if (!modalLoadingIndicator || !gameContainer || !gameTarget) return;
            console.log("Starting minigame...");
            gameScore = 0;
            gameScoreDisplay.textContent = `Puntos: ${gameScore}`;
            isGameActive = true;
            gameTarget.style.display = 'block'; // Make target visible
            gameTarget.addEventListener('click', handleTargetClick);
            moveTarget(); // Initial position
            // Optional: Move target periodically even if not clicked
            // if (gameIntervalId) clearInterval(gameIntervalId);
            // gameIntervalId = setInterval(moveTarget, 2000); // Move every 2s
        }
        function stopGame() {
            if (!isGameActive) return;
            console.log("Stopping minigame...");
            isGameActive = false;
            if (gameTarget) {
                 gameTarget.style.display = 'none'; // Hide target
                 gameTarget.removeEventListener('click', handleTargetClick);
            }
            if (gameIntervalId) {
                clearInterval(gameIntervalId);
                gameIntervalId = null;
            }
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            stopGame(); // Ensure game stops when modal hides
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.classList.remove('active'); // Hide loader by default
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTrickTitle = null;
             hideFullscreenImage();
             // Ensure game target is hidden if reset is called without stopping game properly
             if (gameTarget) gameTarget.style.display = 'none';
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS (Sin cambios) ==========
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS (Sin cambios) ==========
        function addChatMessage(message, sender) { const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        function addChatError(message) { const errDiv=document.createElement('div');errDiv.classList.add('chat-error');errDiv.textContent=message;chatHistory.appendChild(errDiv);chatHistory.scrollTop=chatHistory.scrollHeight;}
        async function handleSendMessage() { const q=chatInput.value.trim();if(!q||chatSendBtn.disabled)return;addChatMessage(q,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const r=await fetchChatResponse(q);addChatMessage(r,'ai');}catch(e){console.error("Chat Error:",e);addChatError(`Error IA: ${e.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();}}

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; /* Optional icon based on keywords? */ let iconClass='fa-keyboard'; if(title.toLowerCase().includes('archivo')||title.toLowerCase().includes('carpeta')) iconClass='fa-folder-open'; else if(title.toLowerCase().includes('rendimiento')||title.toLowerCase().includes('optimizar')) iconClass='fa-tachometer-alt'; else if(title.toLowerCase().includes('configuración')||title.toLowerCase().includes('ajustar')) iconClass='fa-cog'; else if(title.toLowerCase().includes('seguridad')||title.toLowerCase().includes('privacidad')) iconClass='fa-shield-alt'; div.innerHTML = `<i class="fas ${iconClass}"></i><span>${title}</span>`; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Sort maybe by category implicit in name? Or just alpha. Alpha is safer.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">No hay trucos disponibles.</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value);
         }

        // *** MODIFIED: handleTitleClick to start/stop game ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTrickTitle = title;
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.classList.add('active'); // Show loader
            startGame(); // *** START MINIGAME ***

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                stopGame(); // *** STOP MINIGAME (on success) ***
                modalLoadingIndicator.classList.remove('active'); // Hide loader
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Image loading (same logic as before)
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Cargando imagen conceptual...</p>`;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Concepto visual para ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-image-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">No se pudo cargar imagen.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                stopGame(); // *** STOP MINIGAME (on error) ***
                modalLoadingIndicator.classList.remove('active'); // Hide loader
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el truco.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más trucos...';
             try {
                 const newTitles = await fetchGeneratedTitles();
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se encontraron más trucos en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar trucos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // *** Update button text to reflect 40 ***
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Mostrar 40 Trucos Más';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check all essential elements including game elements
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !modalLoadingIndicator || !gameContainer || !gameTarget || !gameScoreDisplay) {
                console.error("Initialization failed: Missing essential UI elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error: No se pudieron cargar los componentes necesarios de la página.</p>';
                return;
             }
            // Event Listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            modalLoadingIndicator.classList.remove('active'); // Ensure loader is hidden initially
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>