<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sendero Rastafari - Sabiduría y Cultura</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes - Readable Sans-serif and Serif -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Rastafarianismo --- */
        :root {
            --color-red: #D90429; /* Rojo Vibrante */
            --color-gold: #FFC300; /* Dorado/Amarillo */
            --color-green: #008000; /* Verde Profundo */
            --color-black: #000000; /* Negro */
            --color-background: #f4f1ea; /* Crema/Beige Claro (Tierra) */
            --color-text: #2d2d2d; /* Gris Muy Oscuro/Casi Negro */
            --color-text-muted: #575757; /* Gris Medio */
            --color-modal-bg: #ffffff; /* Blanco */
            --color-border: #d1d5db; /* Borde Gris Claro */
            --color-error-bg: #fee2e2; /* Fondo error rojo claro */
            --color-error-text: #991b1b; /* Texto error rojo oscuro */
            --color-error-border: #fca5a5; /* Borde error rojo claro */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0 / 0.1);
            --border-radius: 5px; /* Bordes Suaves */
            --transition-normal: all 0.25s ease-in-out;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.65; font-weight: 400; }
        h1, h2, h3, h4, .logo { font-family: 'Poppins', sans-serif; font-weight: 700; }
        .logo { color: var(--color-green); /* Verde para el logo */ }
        h1.page-title { color: var(--color-red); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-gold); padding-bottom: 0.6rem; display: inline-block; font-weight: 600; }
        #modal-title { color: var(--color-green); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2rem; position: relative; }
        #search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-green); box-shadow: 0 0 0 3px rgba(0, 128, 0, 0.2); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1rem; }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.1rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.2rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 65px; font-size: 0.95rem; border-left: 4px solid var(--color-border); }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-green); color: var(--color-green); border-left-color: var(--color-green); background-color: #f0fff0; /* Verde muy pálido */ }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-red), var(--color-gold), var(--color-green)); color: white; padding: 0.8rem 1.6rem; border: none; border-radius: var(--border-radius); font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer; transition: var(--transition-normal); margin-top: 1.8rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        #generate-more-btn:hover:not(:disabled) { background-size: 150% 150%; box-shadow: var(--shadow-md); opacity: 0.95; }
        #generate-more-btn:disabled { background: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; }
        #generate-more-btn .fa-sync-alt { color: white; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(45, 45, 45, 0.85); /* Overlay gris oscuro */ display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px; width: 95%; max-height: 90vh; min-height: 450px; /* Height for game */
            overflow: hidden; position: relative; box-shadow: var(--shadow-lg); display: flex; flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e5e7eb; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-red); color: #ffffff; transform: rotate(90deg); }
        #modal-title { font-size: 1.8rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Area Contenido Principal (Texto + Imagen) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-green) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-green); border-radius: var(--border-radius); }

        #modal-content { padding: 0 5px; font-family: 'Merriweather', serif; /* Serif for body */ }
        #modal-content p:not(:last-child) { margin-bottom: 1.3em; }
        #modal-content strong { color: var(--color-red); font-weight: bold; }
        #modal-content em { color: var(--color-green); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Poppins', sans-serif; margin-top: 2em; margin-bottom: 1em; color: var(--color-green); border-bottom: 1px solid #e5e5e5; padding-bottom: 0.4em; font-weight: 600; }
        #modal-content h1 { font-size: 1.4em; }
        #modal-content h2 { font-size: 1.3em; }
        #modal-content h3 { font-size: 1.15em; color: var(--color-red); }
        #modal-content h4 { font-size: 1.05em; color: var(--color-text-muted); border-bottom: none;}
        /* Imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.2rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.02); box-shadow: var(--shadow-md); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.2rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-green); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-gold); } /* Gold icon */

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9fafb; /* Light gray background */ scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-red) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-red); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-family: 'Poppins'; }
        .user-message { background-color: var(--color-gold); color: var(--color-black); margin-left: auto; text-align: left; font-weight: 400;}
        .ai-message { background-color: #e5e7eb; /* Gray bubble */ color: var(--color-text); margin-right: auto; text-align: left; font-weight: 400; }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; font-family: 'Poppins';}
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: #fff; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Poppins'; font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-green); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-green); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #006400; } /* Darker green */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; font-family: 'Poppins'; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; color: var(--color-green); }

        /* Loading Overlay & Minigame */
        #modal-loading { text-align: center; padding: 1.5rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); display: none; /* Hidden initially */ flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        #modal-loading.active { display: flex; } /* Show when active */
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid rgba(0, 0, 0, 0.1); border-top-color: var(--color-green); border-radius: 50%; animation: spin 1.2s linear infinite; margin-bottom: 1rem; }
        #modal-loading p.loading-text { font-weight: 600; color: var(--color-text); font-size: 1.2rem; font-family: 'Poppins'; margin-bottom: 1.5rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Minigame Styles */
        #loading-minigame { border: 1px solid var(--color-gold); border-radius: var(--border-radius); padding: 1rem 1.5rem; background-color: #fffaf0; /* Very light yellow */ width: 90%; max-width: 450px; text-align: center; box-shadow: var(--shadow-sm); }
        #minigame-title { font-size: 1.1rem; font-weight: 600; color: var(--color-green); margin-bottom: 1rem; }
        #minigame-score-display { font-size: 1.5rem; font-weight: 700; color: var(--color-red); margin-bottom: 1rem; }
        #minigame-clickable { font-size: 4rem; cursor: pointer; display: inline-block; margin-bottom: 1.5rem; transition: transform 0.1s ease; color: var(--color-gold); text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        #minigame-clickable:active { transform: scale(0.9); }
        .minigame-upgrades { display: flex; flex-direction: column; gap: 0.8rem; align-items: center; }
        .upgrade-btn { background-color: var(--color-green); color: white; border: none; padding: 0.6rem 1rem; border-radius: var(--border-radius); cursor: pointer; transition: var(--transition-normal); font-size: 0.9rem; width: 80%; }
        .upgrade-btn:hover:not(:disabled) { background-color: #006400; }
        .upgrade-btn:disabled { background-color: var(--color-text-muted); opacity: 0.7; cursor: not-allowed; }
        .upgrade-info { font-size: 0.85rem; color: var(--color-text-muted); }
        #minigame-level { margin-top: 1rem; font-size: 0.9rem; color: var(--color-text-muted); font-weight: 600; }

        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Poppins'; }
        .error-msg i { margin-right: 0.7rem; color: var(--color-error-text); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(45, 45, 45, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--color-gold); box-shadow: var(--shadow-lg); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: var(--color-modal-bg); border: 1px solid var(--color-gold); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-gold); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-gold); color: var(--color-black); transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl flex items-center">
                     <i class="fas fa-leaf mr-3 text-green-600"></i> <!-- Icono Hoja (Ganja/Naturaleza) -->
                     Sendero Rastafari
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider flex items-center">
                 <i class="fas fa-star-of-david text-yellow-500 mx-1"></i> Sabiduría y Cultura <i class="fas fa-drum text-red-600 ml-1"></i>
             </span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Explora la Profundidad Rastafari</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Descubre la historia, creencias, cultura y modo de vida (livity) del movimiento Rastafari. Selecciona un tema o busca para iniciar tu viaje.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar término (Ej: Selassie, Babylon, Reggae...)">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-green-700 mr-2"></i> <!-- Icono Libro -->
                 Temas de Conocimiento
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Cargando sabiduría ancestral...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">» No se encontraron temas para tu búsqueda «</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Revelar Más Sabiduría
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator with Minigame -->
             <div id="modal-loading"> <!-- Initially hidden, shown via JS -->
                 <div class="loading-spinner-modal"></div>
                 <p class="loading-text">Canalizando conocimiento...</p>
                 <!-- Minigame Container -->
                 <div id="loading-minigame">
                     <h3 id="minigame-title">Juego de Espera: Acumula "Vibes"</h3>
                     <div id="minigame-score-display">Vibes: 0</div>
                     <span id="minigame-clickable" title="¡Haz clic para ganar Vibes!"><i class="fas fa-drum"></i></span> <!-- Clickable Drum -->
                     <div class="minigame-upgrades">
                         <button id="upgrade-click-btn" class="upgrade-btn">Mejorar Clic (Costo: 10)</button>
                         <span class="upgrade-info" id="click-level-info">Clic Nivel 1 (+1 Vibes/clic)</span>
                         <button id="upgrade-auto-btn" class="upgrade-btn">Tamborilero Automático (Costo: 50)</button>
                         <span class="upgrade-info" id="auto-level-info">Tamborileros: 0 (+0 Vibes/seg)</span>
                     </div>
                     <div id="minigame-level">Nivel de Razonamiento: 1</div>
                 </div>
             </div>

             <!-- Content Area Wrapper -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Reflexionando...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Profundiza sobre este tema...">
                         <button id="chat-send-btn" aria-label="Enviar Mensaje"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Contenido generado por IA con fines informativos y culturales sobre el movimiento Rastafari.</p>
              <p class="mt-1">Se recomienda consultar fuentes académicas para estudios profundos. Respeto y Unidad.</p>
              <p class="mt-2">© 2025 Sendero Rastafari</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Figuras Clave
            "Haile Selassie I: Vida y Significado", "Marcus Garvey: Profecías y Panafricanismo", "Leonard Howell: El Primer Rasta", "Mortimo Planno: Maestro y Filósofo", "Bob Marley: Embajador Global del Reggae y Rasta", "Peter Tosh: El 'Stepping Razor' y Activista", "Bunny Wailer: El Último Wailer Original", "Burning Spear (Winston Rodney): Mensaje Consciente", "Walter Rodney: Historiador y Pensador Panafricano", "Queen Omega (Jeneile Osborne)", "Empress Menen Asfaw: Consorte de Selassie I", "Joseph Hibbert", "Archibald Dunkley", "Vernon Carrington (Prophet Gad)", "Prince Emmanuel Charles Edwards",
            // Conceptos Teológicos y Filosóficos
            "Jah (Dios Rastafari): Concepto y Naturaleza", "La Santísima Trinidad en Rastafari", "Cristo Negro: Interpretación Rastafari", "La Biblia (King James Version): Uso e Interpretación", "El Kebra Nagast: Texto Sagrado Etíope", "Zion (Etiopía): La Tierra Prometida", "Babylon: Símbolo de Opresión", "Repatriación a África: Significado y Movimiento", "Livity: El Modo de Vida Rastafari", "I and I (Yo y Yo): Concepto de Unidad", "Word, Sound and Power (Palabra, Sonido y Poder)", "Reasoning (Razonamiento): Sesiones de Debate Espiritual", "El Concepto de Equilibrio Natural", "Amor Universal y Unidad", "Profecía en Rastafari", "Resistencia Pacífica vs. Resistencia Activa", "La Caída del Hombre y la Redención", "Escatología Rastafari: Fin de los Tiempos", "Reencarnación en Creencias Rastas (Limitado)", "Visión del Cosmos y la Creación", "Espiritualidad vs. Religión Organizada",
            // Prácticas Culturales y Sociales
            "Dreadlocks: Significado Espiritual y Cultural", "Ital Livity: La Dieta Rastafari", "Ganja (Marihuana): Uso Sacramental", "La Chalice (Pipa de Agua): Ritual y Significado", "Nyabinghi: Orden Ancestral y Música de Tambores", "Música Reggae: Orígenes, Evolución y Mensaje", "Roots Reggae: El Corazón del Mensaje Rasta", "Dub: Experimentación Sonora y Espiritual", "Dancehall: Relación y Tensiones con Rasta", "Lenguaje Iyaric: Creación y Significado", "Colores Rastafari: Rojo, Oro y Verde (Significado)", "El León de Judah: Símbolo Imperial y Espiritual", "La Bandera Etíope: Significado Histórico y Actual", "Organización Social: Las Doce Tribus de Israel (Mansión)", "Otras Mansiones: Nyahbinghi Order, Bobo Ashanti, Emmanuelites", "Ceremonias y Celebraciones (Groundations, Grounation Day, Cumpleaños de Selassie)", "Arte Rastafari: Pintura, Escultura, Artesanía", "Moda Rastafari: Estilo y Simbolismo", "Familia y Roles de Género en Rastafari", "Educación Rastafari (Enfoques Alternativos)", "Salud y Bienestar desde la Perspectiva Ital", "Relación con la Naturaleza y la Ecología",
            // Historia y Contexto
            "Orígenes del Movimiento Rastafari en Jamaica (Década 1930)", "Contexto Social y Económico de Jamaica en los 30s", "Influencia del Panafricanismo", "Coronación de Haile Selassie I (1930)", "Primeras Comunidades Rastas (Ej: Pinnacle de Howell)", "Persecución y Represión del Movimiento (Ej: Coral Gardens)", "Visita de Haile Selassie I a Jamaica (1966)", "Expansión Global del Movimiento Rastafari (Años 70 y 80)", "Rastafari en el Reino Unido", "Rastafari en Estados Unidos y Canadá", "Rastafari en África (Etiopía, Ghana, Sudáfrica)", "Rastafari en el Caribe (Además de Jamaica)", "Rastafari y la Política Jamaicana", "Relación con otros Movimientos de Liberación Negra", "Impacto del Reggae en la Difusión Global", "Shashamane: Tierra Concedida por Selassie I en Etiopía", "El Movimiento Rastafari Hoy: Desafíos y Evolución", "Diáspora Africana y Rastafari", "Influencia de Religiones Africanas Tradicionales", "Comparación con el Movimiento Hebreo Negro", "Rastafari y Derechos Humanos",
            // Temas Específicos y Preguntas
            "¿Qué significa 'Babylon System'?", "¿Cuál es la importancia del tambor Nyabinghi?", "¿Es Rastafari una religión o un modo de vida?", "Diferencias entre las principales Mansiones Rasta", "El papel de la mujer en el movimiento Rastafari", "¿Cómo se interpreta el Apocalipsis en Rastafari?", "La relación entre Rastafari y Cristianismo Ortodoxo Etíope", "Uso Medicinal de la Ganja en la cultura Rasta", "Impacto Cultural de Bob Marley", "Significado de 'One Love'", "Filosofía detrás de la dieta Ital", "¿Por qué se dejan crecer los dreadlocks?", "El concepto de 'Upfullness'", "Retos legales relacionados con la Ganja", "Visión Rastafari sobre la tecnología moderna", "La música como herramienta de resistencia", "El significado del Arca de la Alianza en Kebra Nagast", "¿Qué es un 'Groundation'?", "Influencia de Rastafari en otros géneros musicales", "El futuro de la Repatriación", "Símbolos Rastafari Comunes y su Significado",
            // Añadir más... (Generate More ayudará)
        ];
        const rastaThemes = [
            "figuras clave Rastafari", "teología Rastafari", "conceptos filosóficos Rasta", "livity y prácticas culturales", "historia del movimiento Rastafari", "música Reggae y Nyabinghi", "símbolos Rastafari", "mansiones Rastafari", "Marcus Garvey y panafricanismo", "Haile Selassie I", "Babylon vs Zion", "Ital y dieta", "Ganja como sacramento", "Repatriación", "Dreadlocks", "influencia global de Rastafari", "Rastafari en Jamaica", "Kebra Nagast", "interpretación bíblica Rasta", "arte y moda Rastafari"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Eres un erudito respetado y conocedor profundo del movimiento Rastafari, su historia, teología, cultura y prácticas (livity). Explica el tema solicitado de manera informativa, precisa y respetuosa, evitando estereotipos. Cubre los orígenes, significado, desarrollo y relevancia actual del concepto. Utiliza un lenguaje claro y académico pero accesible. El objetivo es una exposición detallada de aproximadamente 1200-1300 palabras. Basa tu explicación únicamente en el siguiente tema Rastafari:",
            timeoutSeconds: 150
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Actúa como un guía conocedor y respetuoso del tema Rastafari específico que se está tratando. Responde preguntas de seguimiento sobre sus detalles, contexto o implicaciones mencionadas en la descripción principal. Sé conciso, preciso y mantén un tono de respeto cultural.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            // ** SOLICITA 40 TÍTULOS **
            systemPrompt: "Actúa como un generador de ideas conciso para una enciclopedia sobre Rastafarianismo. Genera exactamente 40 nombres de figuras clave, conceptos teológicos, prácticas culturales, eventos históricos o temas relevantes del movimiento Rastafari, adecuados para una explicación detallada. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo para generar más títulos
        };

        // ========== DOM ELEMENTS ==========
        // (Igual que antes, más los elementos del minijuego)
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading'); // Contenedor del loading y juego
        const modalLoadingText = modalLoadingIndicator.querySelector('p.loading-text'); // Texto "Cargando..."
        const modalStoryContentArea = document.getElementById('modal-story-content-area'); // Wrapper contenido principal
        const modalTextArea = document.getElementById('modal-content-area'); // Área texto+imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div para texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameContainer = document.getElementById('loading-minigame');
        const minigameScoreDisplay = document.getElementById('minigame-score-display');
        const minigameClickable = document.getElementById('minigame-clickable');
        const upgradeClickBtn = document.getElementById('upgrade-click-btn');
        const upgradeAutoBtn = document.getElementById('upgrade-auto-btn');
        const clickLevelInfo = document.getElementById('click-level-info');
        const autoLevelInfo = document.getElementById('auto-level-info');
        const minigameLevelDisplay = document.getElementById('minigame-level');

        // ========== State Variables ==========
        let currentRastaTopic = null; // Contexto para el chat
        let minigameInterval = null; // ID del intervalo del juego
        let gameData = {}; // Objeto para guardar el estado del minijuego

        // ========== API FUNCTIONS ==========
        // fetchTextFromApi, fetchExplanationText, fetchChatResponse (con prompts actualizados)
        // ... (igual que la versión anterior, solo cambian los system prompts definidos arriba) ...
         async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentRastaTopic
                 ? `Actúa como un guía conocedor y respetuoso del tema Rastafari específico llamado '${currentRastaTopic}'. Responde preguntas de seguimiento sobre sus detalles, contexto o implicaciones mencionadas en la descripción principal. Sé conciso, preciso y mantén un tono de respeto cultural.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             if (config.seed && !isChat) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) throw new Error(`(Error ${response.status}) Nuestros servidores tienen mucho tráfico en este momento, intenta en unos segundos.`);
                 const text = await response.text();
                 if (!text || text.trim().length === 0) throw new Error("La respuesta de la IA llegó vacía. Intenta reformular.");
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') throw new Error(`La conexión tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 throw new Error(error.message || "Ocurrió un error inesperado al contactar la IA.");
             }
         }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentRastaTopic) throw new Error("Error interno: Contexto del tema no establecido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }

        // ** MODIFIED fetchGeneratedTitles **
        async function fetchGeneratedTitles() {
            const randomTheme = getRandomElement(rastaThemes) || "conceptos generales Rastafari";
            // Prompt pide 40 títulos (config actualizada)
            const specificPrompt = `Genera 40 ítems sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                .then(text => {
                    const titles = text.split('\n')
                                     .map(line => line.replace(/^[-\d.\s*]+/, '').trim())
                                     .filter(line => line.length > 4 && line.length < 150); // Filtrado básico
                    if (titles.length < 10) throw new Error("La IA no generó suficientes ideas sobre el tema."); // Ajustar umbral si es necesario
                    // Devuelve hasta 40 títulos si los generó
                    return titles.slice(0, 40);
                });
        }

        // createPollinationsImageUrl (adapt prompt)
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Rastafari culture symbolism";
             // Prompt ENFOCADO en simbolismo, cultura, naturaleza, espiritualidad. Evitar estereotipos.
             const enhancedPrompt = `Symbolic and conceptual artwork inspired by Rastafari theme: '${safePromptText}'. Focus on elements like Lion of Judah, Star of David, Ethiopian flag colors (red, gold, green), nature, drums, spiritual vibes, community, resistance. Avoid caricature or stereotypes. Use warm, natural, vibrant colors. No text.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, map, realistic photograph of people, smoking, caricature, stereotype, simplistic, low quality, blurry, watermark, signature";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (identical to previous version) ... */
            if (!rawText) return '';
            let formatted = rawText.trim();
            formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1');
            formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>');
            formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; });
            formatted = formatted.replace(/\\rightarrow/g, '&rarr;');
            formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
            formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
            formatted = blocks.map(block => {
                if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block;
                let content = block.replace(/\n/g, ' ');
                return `<p>${content}</p>`;
            }).join('');
            return formatted;
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState(); // Esto también detendrá y reseteará el juego
        }
        function resetModalState() {
             // ** STOP MINIGAME **
             stopMinigame();
             // Hide content, show loading (it will be hidden again if successful load)
             modalLoadingIndicator.classList.remove('active'); // Ensure loading overlay is hidden initially
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             // Clear content
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentRastaTopic = null;
             // Reset image overlay
             hideFullscreenImage();
             // ** RESET MINIGAME STATE **
             resetMinigameState();
             updateMinigameUI(); // Update UI to reflect reset state
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios)
        function showFullscreenImage(imgSrc) { /* ... */ if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { /* ... */ if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios funcionales)
        function addChatMessage(message, sender) { /* ... */ const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... (identical to previous version, uses fetchChatResponse) ... */
             const userQuery = chatInput.value.trim();
             if (!userQuery || chatSendBtn.disabled) return;
             addChatMessage(userQuery, 'user');
             chatInput.value = '';
             chatSendBtn.disabled = true;
             chatLoadingIndicator.style.display = 'block';
             try {
                 const aiResponse = await fetchChatResponse(userQuery);
                 addChatMessage(aiResponse, 'ai');
             } catch (error) {
                 console.error("Chat Error:", error);
                 addChatError(`Error IA: ${error.message}`);
             } finally {
                 chatLoadingIndicator.style.display = 'none';
                 chatSendBtn.disabled = false;
                 chatInput.focus();
             }
         }

        // ========== MINIGAME FUNCTIONS ==========
        function resetMinigameState() {
            gameData = {
                score: 0,
                level: 1,
                clickLevel: 1,
                clickPower: 1,
                clickUpgradeCost: 10,
                autoLevel: 0,
                autoPower: 1, // Power per auto-clicker
                autoScorePerSecond: 0,
                autoUpgradeCost: 50,
                levelUpThreshold: 100, // Score needed for next level
            };
        }

        function updateMinigameUI() {
            if (!minigameContainer.offsetParent) return; // Don't update if hidden
            minigameScoreDisplay.textContent = `Vibes: ${Math.floor(gameData.score)}`;
            minigameLevelDisplay.textContent = `Nivel de Razonamiento: ${gameData.level}`;

            upgradeClickBtn.textContent = `Mejorar Clic (Costo: ${gameData.clickUpgradeCost})`;
            upgradeClickBtn.disabled = gameData.score < gameData.clickUpgradeCost;
            clickLevelInfo.textContent = `Clic Nivel ${gameData.clickLevel} (+${gameData.clickPower} Vibes/clic)`;

            upgradeAutoBtn.textContent = `Tamborilero Automático (Costo: ${gameData.autoUpgradeCost})`;
            upgradeAutoBtn.disabled = gameData.score < gameData.autoUpgradeCost;
            autoLevelInfo.textContent = `Tamborileros: ${gameData.autoLevel} (+${gameData.autoScorePerSecond} Vibes/seg)`;
        }

        function handleMinigameClick() {
            gameData.score += gameData.clickPower;
            checkLevelUp();
            updateMinigameUI();
            // Simple animation on click
            minigameClickable.style.transform = 'scale(0.9)';
            setTimeout(() => { minigameClickable.style.transform = 'scale(1)'; }, 100);
        }

        function buyClickUpgrade() {
            if (gameData.score >= gameData.clickUpgradeCost) {
                gameData.score -= gameData.clickUpgradeCost;
                gameData.clickLevel++;
                gameData.clickPower = Math.ceil(gameData.clickPower * 1.5); // Increase power
                gameData.clickUpgradeCost = Math.ceil(gameData.clickUpgradeCost * 1.8); // Increase cost
                updateMinigameUI();
            }
        }

        function buyAutoUpgrade() {
            if (gameData.score >= gameData.autoUpgradeCost) {
                gameData.score -= gameData.autoUpgradeCost;
                gameData.autoLevel++;
                // Increase auto score more significantly at higher levels
                gameData.autoScorePerSecond += Math.ceil(gameData.autoPower * (1 + gameData.autoLevel / 5));
                gameData.autoUpgradeCost = Math.ceil(gameData.autoUpgradeCost * 2.1); // Increase cost faster
                updateMinigameUI();
            }
        }

        function checkLevelUp() {
            if (gameData.score >= gameData.levelUpThreshold) {
                gameData.level++;
                // Increase threshold significantly per level
                gameData.levelUpThreshold = Math.ceil(gameData.levelUpThreshold * 2.5 + gameData.level * 50);
                // Optional: Give a small reward or bonus for leveling up
                gameData.clickPower = Math.ceil(gameData.clickPower * 1.1); // Small boost on level up
                console.log(`Level Up! Reached Level ${gameData.level}. Next threshold: ${gameData.levelUpThreshold}`);
            }
        }

        function gameLoop() {
            gameData.score += gameData.autoScorePerSecond / 10; // Add score fractionally 10 times/sec
            checkLevelUp();
            updateMinigameUI();
        }

        function startMinigame() {
            resetMinigameState(); // Start fresh each time
            updateMinigameUI();
            modalLoadingIndicator.classList.add('active'); // Show the loading overlay
            minigameContainer.style.display = 'block'; // Make sure game is visible
            if (minigameInterval) clearInterval(minigameInterval); // Clear any previous interval
            minigameInterval = setInterval(gameLoop, 100); // Run game loop 10 times per second
        }

        function stopMinigame() {
            if (minigameInterval) {
                clearInterval(minigameInterval);
                minigameInterval = null;
            }
            minigameContainer.style.display = 'none'; // Hide game when loading finishes
            // Don't hide the whole #modal-loading here, handleTitleClick will hide it after content is ready
        }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { /* ... */ let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">» No hay temas disponibles «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        // ** MODIFIED appendTitles to handle potentially 40 titles **
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             console.log(`Appending ${newTitles.length} new titles.`); // Log how many are received
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => {
                 if (!existingTitles.has(title)) {
                     titleListContainer.appendChild(createTitleItem(title));
                     addedCount++;
                 }
             });
             console.log(`Successfully added ${addedCount} unique titles.`);
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick to integrate minigame ***
        async function handleTitleClick(title) {
            resetModalState(); // Reset everything, including stopping previous game
            showModal();
            modalTitle.textContent = title;
            currentRastaTopic = title; // Set chat context
            modalStoryContentArea.classList.add('content-hidden'); // Hide main content area initially
            modalError.classList.add('content-hidden');

            // ** START MINIGAME **
            startMinigame();

            try {
                // Fetch content WHILE minigame runs
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                // ** STOP MINIGAME (Success Path) **
                stopMinigame();
                modalLoadingIndicator.classList.remove('active'); // Hide loading overlay

                // Display content
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden'); // Show content + chat
                chatSection.classList.remove('content-hidden'); // Ensure chat is visible

                modalTextArea.scrollTop = 0; // Reset scroll

                // Prepare and add image placeholder
                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `<div class="spinner"></div><i class="fas fa-image placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Generando imagen...</p>`;
                modalContent.appendChild(placeholderDiv);

                // Create and load image
                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización de ${title}`;
                imgElement.style.display = 'none';
                imgElement.onload = () => { placeholderDiv.remove(); imgElement.style.display = 'block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { placeholderDiv.innerHTML = `<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Imagen no disponible.</p>`; };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src = imageUrl; modalContent.appendChild(imgElement); }
                else { placeholderDiv.innerHTML = `<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error URL imagen.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                // ** STOP MINIGAME (Error Path) **
                stopMinigame();
                modalLoadingIndicator.classList.remove('active'); // Hide loading overlay

                // Display error message
                modalErrorMessage.textContent = error.message || "Error desconocido al cargar el tema.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden'); // Show area to display error
                modalContent.innerHTML = ''; // Clear partial content
                chatSection.classList.add('content-hidden'); // Hide chat on error
            }
        }

        // ** MODIFIED handleGenerateMoreTitles to handle 40 **
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando más sabiduría...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches up to 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudo revelar más sabiduría en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al buscar sabiduría: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Revelar Más Sabiduría';
             }
         }

         // Search Filter Function (con normalización para tildes)
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Add Minigame elements to check
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameClickable || !upgradeClickBtn || !upgradeAutoBtn) {
                console.error("Initialization failed: Missing essential elements (incl. minigame).");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Error Crítico: Faltan componentes de la interfaz.</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // ** Minigame Listeners **
            minigameClickable.addEventListener('click', handleMinigameClick);
            upgradeClickBtn.addEventListener('click', buyClickUpgrade);
            upgradeAutoBtn.addEventListener('click', buyAutoUpgrade);

            // Initial display
            resetMinigameState(); // Init game state vars
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>