<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crónicas del Multiverso - Narrativas Paralelas</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Misteriosas/Elegantes -->
    <link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Realidades Paralelas --- */
        :root {
            --color-primary: #8b5cf6; /* Púrpura Vibrante */
            --color-secondary: #f97316; /* Naranja Intenso (para acentos/portales) */
            --color-tertiary: #14b8a6; /* Teal/Turquesa (misterio) */
            --color-background: #111827; /* Azul Muy Oscuro */
            --color-text: #d1d5db; /* Gris Claro */
            --color-text-muted: #9ca3af; /* Gris Medio */
            --color-modal-bg: #1f2937; /* Gris Azulado Oscuro */
            --color-border: #4b5563; /* Borde Gris Oscuro */
            --color-error-bg: #450a0a; /* Fondo error rojo muy oscuro */
            --color-error-text: #fecaca; /* Texto error claro */
            --color-error-border: #ef4444; /* Borde error rojo */

            --shadow-sm: 0 1px 2px 0 rgba(139, 92, 246, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(139, 92, 246, 0.15), 0 2px 4px -2px rgba(139, 92, 246, 0.1);
            --shadow-lg: 0 0 25px -5px rgba(139, 92, 246, 0.25), 0 8px 10px -6px rgba(139, 92, 246, 0.2);
            --border-radius: 4px; /* Bordes suaves */
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--color-background) 0%, #0f172a 100%); color: var(--color-text); line-height: 1.75; font-weight: 300; }
        h1, h2, h3, h4, .logo { font-family: 'Spectral', serif; font-weight: 700; letter-spacing: 0.5px; }
        .logo { color: var(--color-primary); text-shadow: 0 0 10px rgba(139, 92, 246, 0.5); }
        h1.page-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 8px rgba(139, 92, 246, 0.6); }
        h2.section-title { color: var(--color-text); border-bottom: 2px solid var(--color-primary); padding-bottom: 0.7rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; text-shadow: 0 0 5px rgba(139, 92, 246, 0.4); }
        .navbar { background-color: rgba(17, 24, 39, 0.85); backdrop-filter: blur(8px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Estilos Buscador */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: rgba(31, 41, 55, 0.8); color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); font-family: 'Inter'; }
        #search-input::placeholder { color: var(--color-text-muted); font-style: italic; }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3); outline: none; background-color: var(--color-modal-bg); }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.3rem; }
        .title-item { background: linear-gradient(145deg, var(--color-modal-bg), #2a3647); padding: 1.4rem 1.1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: left; font-weight: 400; color: var(--color-text); border: 1px solid var(--color-border); display: flex; flex-direction: column; justify-content: center; min-height: 75px; font-family: 'Inter'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-5px) scale(1.02); box-shadow: var(--shadow-lg); border-color: var(--color-primary); color: var(--color-primary); background: linear-gradient(145deg, #2a3647, var(--color-modal-bg)); border-left-color: var(--color-primary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(60deg, var(--color-primary), var(--color-tertiary)); color: #ffffff; padding: 0.9rem 1.8rem; border: none; border-radius: var(--border-radius); font-family: 'Spectral', serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2.5rem; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(60deg, var(--color-tertiary), var(--color-primary)); box-shadow: var(--shadow-lg); transform: scale(1.03); }
        #generate-more-btn:disabled { background: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; text-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: #ffffff; }

        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.95); backdrop-filter: blur(3px); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-primary);
            border-radius: var(--border-radius);
            padding: 1.8rem 2.2rem;
            max-width: 1000px; /* Ligeramente más ancho */
            width: 96%;
            max-height: 90vh;
            min-height: 450px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: var(--color-border); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: rotate(90deg) scale(1.1); box-shadow: 0 0 12px var(--color-primary); }
        #modal-title { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.35; }

        /* Área de Contenido Principal (Texto + Imagen al final) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 12px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-primary) rgba(75, 85, 99, 0.4);
        }
        #modal-content-area::-webkit-scrollbar { width: 10px; }
        #modal-content-area::-webkit-scrollbar-track { background: rgba(75, 85, 99, 0.4); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: var(--border-radius); border: 2px solid rgba(75, 85, 99, 0.4); }

        #modal-content { padding: 0 8px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.5em; }
        #modal-content strong { color: var(--color-primary); font-weight: 600; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Spectral', serif; margin-top: 2.4em; margin-bottom: 1.2em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.6em; font-weight: 700; letter-spacing: 0.3px;}
        #modal-content h1 { font-size: 1.6em; }
        #modal-content h2 { font-size: 1.4em; }
        #modal-content h3 { font-size: 1.25em; color: var(--color-tertiary); }
        #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Estilos imagen final y placeholder */
        #modal-content .final-image { display: block; max-width: 85%; height: auto; margin: 3rem auto 1.5rem auto; border: 1px solid var(--color-primary); border-radius: var(--border-radius); box-shadow: 0 0 18px rgba(139, 92, 246, 0.3); cursor: pointer; transition: transform 0.25s ease, box-shadow 0.25s ease; }
        #modal-content .final-image:hover { transform: scale(1.04); box-shadow: 0 0 25px rgba(139, 92, 246, 0.5); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 160px; margin: 3rem auto 1.5rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 5px solid rgba(75, 85, 99, 0.7); width: 40px; height: 40px; border-radius: 50%; border-left-color: var(--color-primary); animation: spin 1s linear infinite; margin-bottom: 0.8rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 3rem; } /* Icono más grande */

        /* Chat Section Styles */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1.2rem; margin-top: 1.2rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 280px; /* Más espacio para chat */ }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: rgba(17, 24, 39, 0.8); scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) rgba(75, 85, 99, 0.4);
        }
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: rgba(75, 85, 99, 0.4); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.8rem; padding: 0.6rem 1rem; border-radius: var(--border-radius); max-width: 88%; word-wrap: break-word; line-height: 1.6; }
        .user-message { background-color: var(--color-tertiary); color: var(--color-background); margin-left: auto; text-align: right; font-weight: 400; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .ai-message { background-color: #4b5563; color: var(--color-text); margin-right: auto; text-align: left; font-weight: 300; box-shadow: -1px 1px 3px rgba(0,0,0,0.2); }
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; padding: 0.5rem; }
        #chat-input-area { display: flex; gap: 0.6rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 1rem; border: 1px solid var(--color-border); background-color: #374151; color: var(--color-text); border-radius: var(--border-radius); font-family: 'Inter'; font-size: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 5px rgba(139, 92, 246, 0.3); }
        #chat-send-btn { padding: 0.7rem 1.2rem; background-color: var(--color-primary); color: #ffffff; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 1rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #7c3aed; transform: scale(1.05); }
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; transform: none; }
        #chat-loading { text-align: center; padding: 0.6rem; font-size: 0.95em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.6rem; }

        #modal-loading { text-align: center; padding: 3rem 0; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(17, 24, 39, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 65px; height: 65px; border: 7px solid var(--color-border); border-top-color: var(--color-primary); border-bottom-color: var(--color-tertiary); /* Doble color */ border-radius: 50%; animation: spin 1.3s linear infinite; margin: 0 auto 1.8rem auto; }
        #modal-loading p { font-weight: 700; color: var(--color-text); font-size: 1.4rem; font-family: 'Spectral'; text-shadow: 0 0 8px var(--color-primary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.3rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 400; font-family: 'Inter'; }
        .error-msg i { margin-right: 0.8rem; color: var(--color-error-border); }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.97); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-primary); box-shadow: var(--shadow-lg); border-radius: var(--border-radius); }
        #fullscreen-close-btn { position: absolute; top: 25px; right: 30px; background: var(--color-modal-bg); border: 1px solid var(--color-primary); border-radius: 50%; width: 45px; height: 45px; font-size: 2rem; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-primary); color: var(--color-background); transform: scale(1.1) rotate(180deg); }
    </style>
</head>
<body class="scroll-smooth">
     <!-- Header/Navbar -->
     <nav class="navbar mb-12">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-infinity mr-3 text-purple-400 transform scale-x-[-1]"></i> <!-- Icono infinito/multiverso -->
                     Crónicas del Multiverso
                 </h1>
             </div>
             <span class="text-sm text-gray-400 font-sans tracking-wider">» Explorando Realidades Paralelas «</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-14 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-6">Tejidos de Realidad Alterna</h1>
             <p class="text-xl text-gray-300 mb-10 max-w-4xl mx-auto font-light">Universos incontables colisionan y se entrelazan. Investiga los nexos, las paradojas y las historias nacidas donde las dimensiones se encuentran.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-12 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar concepto, paradoja o universo...">
             <i class="fas fa-search fa-portal-exit"></i> <!-- Icono portal/búsqueda -->
             <style> .fa-portal-exit::before { content: "\f563"; /* Usa un icono que parezca un portal o similar */ } </style>
         </section>

         <!-- Title List Container -->
         <section class="mb-12">
             <h2 class="section-title text-3xl sm:text-4xl mb-10 text-center mx-auto">
                 <i class="fas fa-book-journal-whills text-teal-400 mr-3"></i> <!-- Icono libro arcano -->
                 Índice de Singularidades
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-400 col-span-full text-center text-lg font-sans italic">Sintonizando con el tejido multiversal...</p>
                  <!-- Los .title-item se añadirán aquí -->
             </div>
             <p id="no-results" class="text-gray-400 col-span-full text-center text-lg mt-6 hidden font-sans">» Ninguna hebra de realidad coincide con la consulta «</p>
             <div id="generate-more-container" class="text-center mt-10">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Explorar Más Realidades (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Cerrar">&times;</button>

             <!-- Loading Indicator -->
             <div id="modal-loading">
                 <div class="loading-spinner-modal"></div>
                 <p>Cartografiando Realidad...</p>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">

                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- La imagen y su placeholder/spinner se añadirán aquí vía JS -->
                     </div>
                 </div>

                 <!-- Chat Section (Fixed at bottom of content area) -->
                 <div id="chat-section">
                     <h4 class="text-center text-sm font-semibold text-gray-400 mb-2 font-sans">Consultar al Oráculo Dimensional</h4>
                     <div id="chat-history">
                         <!-- Chat messages will appear here -->
                     </div>
                     <div id="chat-loading">
                         <i class="fas fa-spinner fa-spin"></i> Consultando ecos interdimensionales...
                     </div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pregunta sobre esta realidad específica...">
                         <button id="chat-send-btn" aria-label="Enviar Consulta">
                             <i class="fas fa-paper-plane"></i>
                         </button>
                     </div>
                 </div>

                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Cerrar Imagen">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagen Ampliada del Concepto">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-900 text-gray-500 py-6 mt-16 border-t border-gray-700 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Narrativas generadas por IA explorando las infinitas posibilidades del multiverso con fines creativos.</p>
              <p class="mt-1">Los conceptos aquí descritos son ejercicios de imaginación basados en tropos de ciencia ficción y fantasía.</p>
              <p class="mt-2">© ∞ Crónicas del Multiverso</p>
          </div>
      </footer>


    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Tipos de Universos / Realidades
            "El Mundo Espejo Invertido", "Dimensión Sombría Parásita", "Utopía Tecnológica Fría", "Distopía Post-Apocalíptica Viral", "Realidad donde la Magia es Ciencia", "Mundo donde la Alquimia domina la Física", "Tierra Conquistada por la Flora Inteligente", "Universo sin Humanos, Evolución Alterna", "Realidad Histórica: Imperio Romano Tecnológico", "Realidad Histórica: Egipto Faraónico Interstellar", "Mundo Gobernado por Inteligencias Artificiales Benevolentes (¿o no?)", "Dimensión de Pesadilla Colectiva", "Plano Elemental Puro (Fuego, Agua, etc.)", "Universo de Bolsillo Inestable", "La Biblioteca de Todas las Historias Posibles", "Realidad donde los Sueños se Manifiestan Físicamente", "Mundo Silencioso (sin sonido)", "Universo de Dibujos Animados con Física Propia", "Realidad donde los Dioses Griegos aún Gobiernan", "Mundo Submarino Avanzado post-Diluvio", "Tierra Congelada Eternamente", "Universo donde los Dinosaurios Desarrollaron Inteligencia", "Realidad basada en una Obra Literaria Famosa", "Dimensión Matemática Abstracta", "El Vacío Entre Mundos",
            // Puntos de Conexión / Viaje
            "El Nexo de Todas las Realidades", "Grietas Dimensionales Espontáneas", "Zonas de Sangrado Dimensional", "El Artefacto que Abre Portales", "Viajeros Conscientes del Multiverso (Exploradores)", "Refugiados de Universos Moribundos", "Conquistadores Interdimensionales", "El Faro que Guía Entre Mundos", "Objetos Ancla (impiden desplazamiento)", "La Red de Caminos Ocultos", "Viaje a través de los Sueños Lúcidos", "Tecnología de Plegado Espacial", "Mutaciones Genéticas que permiten el Salto", "Portales Naturales en Lugares Anómalos", "El Río del Tiempo y sus Afluentes Dimensionales",
            // Consecuencias y Paradojas
            "La Paradoja del Doppelgänger Asesino", "Bucles Temporales por Interferencia Dimensional", "Borrado Causal por Alterar el Pasado Alterno", "Fusión Inestable de Realidades", "Contaminación Informativa entre Mundos", "Guerra por Recursos entre Dimensiones", "El Dilema Ético de la Intervención Multiversal", "Síndrome de Desrealización del Viajero", "Ecos de Vidas Alternas (Déjà vu intensificado)", "Entropía Acelerada por Fugas Dimensionales", "Leyes Físicas Contradictorias Coexistiendo", "El Efecto Mariposa a Escala Multiversal", "La Paradoja del Conocimiento Prohibido de Otro Yo", "Robo de Identidad Interdimensional", "Creación Involuntaria de Nuevas Paradojas",
            // Personajes y Entidades
            "El Guardián del Equilibrio Multiversal", "La Entidad Devoradora de Realidades", "Versiones Alternas de Figuras Históricas", "Seres Nativos de Dimensiones Abstractas", "La Policía del Tiempo/Realidad", "Cultos que Adoran a Entidades Interdimensionales", "El Mercader de Secretos del Multiverso", "El Último Superviviente de un Universo Colapsado", "El Niño que Puede Ver Todas las Posibilidades", "El Colectivo de Mentes Unidas a través de Dimensiones", "Doppelgängers con Habilidades Opuestas", "Parásitos Dimensionales que Roban Recuerdos", "Arquitectos de Realidades de Bolsillo", "El Exiliado Interdimensional", "La Sombra que Persigue a los Viajeros",
            // Conceptos y Fenómenos
            "Teoría de Cuerdas y Branas Dimensionales", "La Espuma Cuántica de Posibilidades", "Tormentas de Probabilidad (Realidad fluctuante)", "Anclas de Realidad (puntos estables)", "Armonía y Disonancia Dimensional", "El Velo Entre Mundos (barrera)", "Dimensiones de Bolsillo Personalizadas", "Realidades Subjetivas Creadas por la Mente", "El Gran Filtro Multiversal (¿por qué no vemos viajeros?)", "Conciencia Colectiva a Nivel Multiversal", "Leyes de Conservación Interdimensional (Energía/Materia)", "El Lenguaje Universal de las Matemáticas", "La Cicatriz Dimensional (resto de una colisión)", "El Efecto Observador en la Selección de Realidades", "La Geometría No-Euclidiana del Multiverso",
             // Story Seeds (más específicos)
             "La Ciudad que Existe en Tres Realidades Solapadas", "El Intercambio Accidental de Ciudadanos entre dos Tierras", "La Búsqueda del Universo 'Original'", "Cuando una Ley Física Dejó de Funcionar", "El Mapa del Multiverso Tatuado en la Piel", "El Virus que Borra Versiones Alternas de Ti Mismo", "La Guerra Fría Interdimensional por el Control del Nexo", "El Culto que Intenta Fusionar la Tierra con una Dimensión Demoníaca", "El Detective que Investiga Crímenes a través de Realidades", "La Carrera por Encontrar la 'Realidad Perfecta'", "El Último Libro de la Biblioteca de Todas las Historias", "Sanar un Universo Moribundo Robando Energía de Otros", "El Reflejo en el Espejo que Empezó a Vivir por su Cuenta", "La Tecnología que Permite 'Descargar' Habilidades de Otros Yo", "El Día que Todas las Puertas se Convirtieron en Portales",
             // Más conceptos abstractos/filosóficos
             "Identidad Personal a través del Multiverso", "Libre Albedrío vs. Determinismo Multiversal", "La Naturaleza de la 'Realidad Base'", "Consecuencias Morales de Eliminar un Universo", "El Significado de la Vida en un Cosmos Infinito", "La Evolución Convergente entre Realidades", "Comunicación con Versiones Futuras/Pasadas Alternas", "El Concepto de 'Hogar' para un Viajero Dimensional", "La Soledad del Ser Único en el Multiverso", "Religiones Basadas en la Existencia de Otras Dimensiones", "El Arte Inspirado por Visiones de Mundos Alternos", "La Búsqueda de un Propósito Universal", "El Miedo a la Propia Inexistencia en Otras Ramas", "La Responsabilidad por las Acciones de tus Otros Yo", "El Amor a Través de las Barreras Dimensionales",
             // Añadiendo Variedad
             "Universo donde la Gravedad Funciona a la Inversa", "Realidad Controlada por Música y Sonido", "Dimensión Hecha Enteramente de Luz Solidificada", "El Mundo Dentro de un Copo de Nieve", "Realidad donde las Emociones Tienen Forma Física", "Universo Simbiótico entre Humanos y Plantas", "Tierra Alterna con Múltiples Lunas y Mareas Caóticas", "Dimensión donde el Tiempo Fluye Hacia Atrás", "Realidad sin Concepto de Individualidad (Mente Colmena)", "El Universo de los Dioses Olvidados", "Mundo Tecnológico Impulsado por Almas Capturadas", "Realidad donde los Colores tienen Propiedades Mágicas", "Dimensión Carcelaria para Entidades Cósmicas", "El Universo Nacido de una Paradoja", "Mundo Espejo donde Todo es Moralmente Opuesto",
             // Y más... (el botón ayudará a seguir explorando)
         ];
        const parallelRealitiesThemes = [
            "mundos espejo", "dimensiones paralelas", "viaje interdimensional", "paradojas temporales", "líneas de tiempo alternativas", "historia alterna", "universos de bolsillo", "nexos dimensionales", "doppelgängers", "guerras multiversales", "refugiados dimensionales", "fusión de realidades", "leyes físicas alternas", "magia vs tecnología", "utopías y distopías paralelas", "conciencia multiversal", "entidades cósmicas", "guardianes de la realidad", "efecto mariposa dimensional", "realidades oníricas", "universos abstractos", "el vacío interdimensional", "artefactos de poder dimensional", "tecnología de portales", "crisis multiversal"
        ];
        const textApiConfig = { // Para descripción principal
            model: "mistral",
            systemPrompt: "Eres un Cronista del Multiverso, un narrador experto en tejer historias sobre realidades paralelas. Tu tarea es describir el concepto, escenario o paradoja dimensional indicado. Enfócate en cómo coexisten o interactúan las diferentes realidades, los conflictos que surgen de esta interacción, las paradojas inherentes y las implicaciones para sus habitantes o para el tejido mismo del multiverso. Usa un estilo narrativo evocador, inmersivo y detallado, explorando las reglas, peligros y maravillas del concepto. El objetivo es una crónica rica de aproximadamente 1200-1300 palabras. Basa tu narración únicamente en el siguiente concepto de realidad paralela:",
            timeoutSeconds: 150
        };
        const chatApiConfig = { // Config base para chat
            model: "mistral-tiny",
            systemPrompt: "Actúa como un Oráculo Dimensional, una IA con acceso a ecos informativos del multiverso. Responde preguntas específicas sobre el concepto de realidad paralela que se está mostrando actualmente. Céntrate en sus detalles, implicaciones o posibles variaciones mencionadas en la crónica principal. Sé conciso, enigmático pero informativo, y siempre relevante al tema.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = { // *** MODIFIED: Generar 40 ***
            model: "mistral",
            systemPrompt: "Actúa como un generador de semillas narrativas para historias de realidades paralelas. Genera exactamente 40 conceptos intrigantes, títulos evocadores, paradojas interesantes o escenarios únicos basados en la coexistencia e interacción de múltiples dimensiones. Devuelve *solo* la lista de ítems, uno por línea. No incluyas números, guiones, introducciones ni despedidas.",
            timeoutSeconds: 60 // Un poco más de tiempo por si necesita generar más
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area'); // Área de texto+imagen
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content'); // Div texto HTML
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');

        // ========== State Variables ==========
        let currentRealityConcept = null; // Contexto del chat

        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
             const encodedPrompt = encodeURIComponent(prompt);
             const systemPromptToUse = isChat && currentRealityConcept
                 ? `Eres un Oráculo Dimensional IA, especializado únicamente en el concepto de realidad paralela llamado '${currentRealityConcept}'. Responde preguntas de seguimiento sobre sus detalles, implicaciones o posibles variaciones mencionadas en la crónica principal. Sé conciso, enigmático pero informativo, y siempre relevante al tema.`
                 : config.systemPrompt;
             const encodedSystem = encodeURIComponent(systemPromptToUse);

             const params = new URLSearchParams({ model: config.model, system: encodedSystem });
             // Seed es menos relevante para generación de títulos múltiples o chat
             // if (config.seed && !isChat && config !== titleGenerationConfig) params.append('seed', config.seed);
             const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
             console.log(`Fetching text from API (${config.model}, Chat: ${isChat}, Requesting ${config === titleGenerationConfig ? '40 titles' : 'text'}): ${url.substring(0, 200)}...`);

             const controller = new AbortController();
             const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);

             try {
                 const response = await fetch(url, { signal: controller.signal });
                 clearTimeout(timeoutId);
                 if (!response.ok) {
                     throw new Error(`(Error ${response.status}) Nuestros servidores (o los ecos del multiverso) están experimentando interferencias. Por favor, intenta de nuevo en unos momentos.`);
                 }
                 const text = await response.text();
                 if (!text || text.trim().length === 0) {
                     throw new Error("La respuesta de la IA llegó vacía o corrupta. Intenta de nuevo o con otra consulta.");
                 }
                 console.log(`API Response received (${text.length} chars)`);
                 return text;
             } catch (error) {
                 clearTimeout(timeoutId);
                 console.error("API Fetch Error:", error);
                 if (error.name === 'AbortError') {
                     throw new Error(`La conexión con la fuente dimensional tardó demasiado (>${config.timeoutSeconds}s). Revisa tu conexión o intenta más tarde.`);
                 }
                 throw new Error(error.message || "Ocurrió un error desconocido al consultar el multiverso.");
             }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentRealityConcept) throw new Error("Error interno: Contexto dimensional perdido."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() { // *** MODIFIED: Expect 40 ***
            const randomTheme = getRandomElement(parallelRealitiesThemes) || "realidades paralelas generales";
            const specificPrompt = `Genera 40 conceptos/títulos sobre ${randomTheme}`;
            return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 5 && line.length < 150);
                     // Ajustar umbral de error para 40 solicitados
                     if (titles.length < 20) { // Si recibimos menos de la mitad de lo esperado, es un problema
                         throw new Error("La IA no generó suficientes conceptos nuevos (recibidos: " + titles.length + ").");
                     }
                     return titles.slice(0, 40); // Asegurarse de no devolver más de 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
             const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
             const settings = { ...defaults, ...options };
             const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "abstract parallel realities concept art";
             const enhancedPrompt = `Conceptual artwork representing '${safePromptText}'. Parallel realities, dimensional rift, alternate universe aesthetic. Focus on atmosphere, surrealism, impossible geometry, colliding worlds, cosmic visuals. Ethereal, mysterious, maybe slightly unsettling. Avoid text, labels, maps, realistic figures unless specified. Use ${getRandomElement(['purples and oranges','deep blues and teals','monochromatic with energy highlights','fractal patterns'])}.`;
             const escapedPrompt = encodeURIComponent(enhancedPrompt);
             if (!escapedPrompt) return '';
             const negativePrompt = "text, words, labels, letters, title, caption, diagram, chart, graph, UI, menu, button, watermark, signature, multiple images, collage, realistic photograph, clear sky, normal landscape, mundane, boring, simple";
             const escapedNegative = encodeURIComponent(negativePrompt);
             let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
             if (settings.nologo) url += '&nologo=true';
             console.log("Image URL:", url);
             return url;
         }

        // ========== Text Formatting Function ========== (sin cambios)
        function formatExplanationText(rawText) { /* ... (identical to previous version) ... */
            if (!rawText) return ''; let formatted = rawText.trim(); formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-−]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('−', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>'); formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>'); formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0); formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join(''); return formatted;
        }

        // ========== MODAL FUNCTIONS ========== (sin cambios en lógica, sí en reset)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            console.log("Scroll reset on hideModal");
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             // Reset Chat
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentRealityConcept = null; // *** CLEAR CHAT CONTEXT ***
             // Reset Fullscreen Image
             hideFullscreenImage(); // Ensure it's hidden and cleared
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (sin cambios en lógica)
        function showFullscreenImage(imgSrc) { if (!imageFullscreenOverlay || !fullscreenImage) return; fullscreenImage.src = imgSrc; imageFullscreenOverlay.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideFullscreenImage() { if (!imageFullscreenOverlay) return; imageFullscreenOverlay.classList.remove('active'); if (!storyModal.classList.contains('active')) { document.body.style.overflow = ''; } fullscreenImage.src = ''; }

        // ========== CHAT FUNCTIONS ========== (sin cambios en lógica)
        function addChatMessage(message, sender) { const msgDiv = document.createElement('div'); msgDiv.classList.add('chat-message', sender === 'user' ? 'user-message' : 'ai-message'); message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); msgDiv.innerHTML = message; chatHistory.appendChild(msgDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        function addChatError(message) { const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-error'); errorDiv.textContent = message; chatHistory.appendChild(errorDiv); chatHistory.scrollTop = chatHistory.scrollHeight; }
        async function handleSendMessage() { const userQuery = chatInput.value.trim(); if (!userQuery || chatSendBtn.disabled) return; addChatMessage(userQuery, 'user'); chatInput.value = ''; chatSendBtn.disabled = true; chatLoadingIndicator.style.display = 'block'; try { const aiResponse = await fetchChatResponse(userQuery); addChatMessage(aiResponse, 'ai'); } catch (error) { console.error("Chat Error:", error); addChatError(`Oráculo: ${error.message}`); } finally { chatLoadingIndicator.style.display = 'none'; chatSendBtn.disabled = false; chatInput.focus(); } }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div'); div.className='title-item'; div.textContent=title; div.setAttribute('data-title', title); div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             // Opcional: ¿Orden aleatorio para sensación de multiverso caótico? O alfabético para orden.
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b)); // Mantener orden alfabético por ahora
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center font-sans">» El Nexo está vacío o inaccesible «</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             let addedCount = 0;
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); addedCount++; } });
             console.log(`Appended ${addedCount} new unique titles.`);
             filterTitles(searchInput.value); // Reapply filter
         }

        // *** MODIFIED: handleTitleClick context variable name ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentRealityConcept = title; // *** SET CHAT CONTEXT ***
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';

            try {
                const rawExplanationText = await fetchExplanationText(title);
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none';
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');

                modalTextArea.scrollTop = 0;
                console.log("Scroll reset after content visible");

                const placeholderDiv = document.createElement('div');
                placeholderDiv.className = 'image-placeholder';
                placeholderDiv.innerHTML = `
                    <div class="spinner"></div>
                    <i class="fas fa-eye placeholder-icon text-purple-400"></i> <!-- Icono ojo/visión -->
                    <p style="font-size: 0.8em; margin-top: 0.5rem;">Visualizando la hebra de realidad...</p>
                `;
                modalContent.appendChild(placeholderDiv);

                const imgElement = document.createElement('img');
                imgElement.className = 'final-image';
                imgElement.alt = `Visualización conceptual de ${title}`;
                imgElement.style.display = 'none';

                imgElement.onload = () => {
                    console.log("Image loaded.");
                    placeholderDiv.remove();
                    imgElement.style.display = 'block';
                    imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src));
                };
                imgElement.onerror = () => {
                    console.error("Error loading image for:", title);
                    placeholderDiv.innerHTML = `<i class="fas fa-ban placeholder-icon text-red-500"></i><p style="font-size:0.8em;margin-top:0.5rem;">Visualización Interdimensional Fallida.</p>`;
                };

                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) {
                    imgElement.src = imageUrl;
                    modalContent.appendChild(imgElement);
                } else {
                     console.error("Could not create image URL for:", title);
                     placeholderDiv.innerHTML = `<i class="fas fa-exclamation-triangle placeholder-icon text-yellow-500"></i><p style="font-size:0.8em;margin-top:0.5rem;">Error generando URL de imagen.</p>`;
                }

            } catch (error) {
                console.error("Failed display:", error);
                modalLoadingIndicator.style.display = 'none';
                modalErrorMessage.textContent = error.message || "Error desconocido al cartografiar esta realidad.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        // *** MODIFIED: handleGenerateMoreTitles button text ***
        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Explorando el Caos Primigenio...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40 based on config
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("No se pudieron sintonizar nuevas realidades en este momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Error al explorar: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Update button text to reflect it generates 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Explorar Más Realidades (40)';
             }
         }

         // *** Search Filter Function (con normalización) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn) {
                console.error("Initialization failed: Missing essential elements.");
                document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">// ERROR CRÍTICO: Falla en la Matriz de la Interfaz //</p>';
                return;
             }
            // Modal listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });

            // Title generation listener
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);

            // Search listener
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });

            // Chat listeners
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });

            // Fullscreen image listeners
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>