<!DOCTYPE html>
<html lang="pt-BR"> <!-- Language set to Brazilian Portuguese -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hist√≥rias de Candombl√© - Guia Interativo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Fuentes Legibles con Toque Elegante -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- Estilos Adaptados para Candombl√© (Respeito e Cores) --- */
        :root {
            /* Paleta inspirada nos Orix√°s e natureza */
            --color-oxala: #ffffff; /* Branco */
            --color-ogum: #000080;  /* Azul Escuro */
            --color-oxossi: #008000; /* Verde */
            --color-xango: #ff0000; /* Vermelho */
            --color-iemanja: #add8e6; /* Azul Claro */
            --color-oxum: #ffd700;  /* Amarelo/Dourado */
            --color-iansa: #ff4500; /* Laranja/Vermelho */
            --color-nana: #800080;  /* Roxo */
            --color-omolu: #a0522d; /* Marrom/Terra */
            --color-exu: #000000;   /* Preto (usar com modera√ß√£o) */

            --color-primary: var(--color-ogum); /* Azul como base */
            --color-secondary: var(--color-oxum); /* Dourado para detalhes */
            --color-tertiary: var(--color-oxossi); /* Verde para √™nfase */
            --color-background: #fdfaf6; /* Fundo quase branco, quente */
            --color-text: #333333; /* Texto escuro, leg√≠vel */
            --color-text-muted: #666666;
            --color-modal-bg: #ffffff; /* Modal branco limpo */
            --color-border: #e0e0e0; /* Borda cinza suave */
            --color-error-bg: #fff0f0; /* Fundo erro rosa claro */
            --color-error-text: #c00000; /* Texto erro vermelho */
            --color-error-border: #ffcccc; /* Borda erro rosa */

            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.07), 0 1px 2px 0 rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 5px;
            --transition-normal: all 0.3s ease-in-out;
        }
        body { font-family: 'Open Sans', sans-serif; background-color: var(--color-background); color: var(--color-text); line-height: 1.7; }
        h1, h2, h3, h4, .logo { font-family: 'Merriweather', serif; font-weight: 700; }
        .logo { color: var(--color-primary); }
        h1.page-title { color: var(--color-primary); font-weight: 700; }
        h2.section-title { color: var(--color-text); border-bottom: 3px solid var(--color-secondary); padding-bottom: 0.6rem; display: inline-block; font-weight: 700; }
        #modal-title { color: var(--color-primary); font-weight: 700; }
        .navbar { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); box-shadow: var(--shadow-md); position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--color-border); }
        /* Search */
        #search-container { margin-bottom: 2.5rem; position: relative; }
        #search-input { width: 100%; padding: 0.9rem 1.2rem 0.9rem 3rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: 1rem; background-color: #fff; color: var(--color-text); box-shadow: var(--shadow-sm); transition: var(--transition-normal); }
        #search-input::placeholder { color: var(--color-text-muted); }
        #search-input:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 0, 128, 0.15); outline: none; }
        #search-container .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted); font-size: 1.1rem; transition: color 0.2s ease; }
        #search-input:focus + .fa-search { color: var(--color-primary); }

        /* Title List */
        #title-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.2rem; }
        .title-item { background-color: var(--color-modal-bg); padding: 1.3rem 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-normal); text-align: center; font-weight: 600; color: var(--color-primary); border: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; min-height: 70px; font-family: 'Open Sans'; font-size: 0.95rem; border-left: 4px solid transparent; }
        .title-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--color-secondary); color: var(--color-text); background-color: #fffaf0; /* Amarelo bem claro */ border-left-color: var(--color-secondary); }
        #generate-more-btn { grid-column: 1 / -1; background: linear-gradient(45deg, var(--color-tertiary), var(--color-primary)); color: white; padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); font-family: 'Merriweather', serif; font-weight: 700; cursor: pointer; transition: var(--transition-normal); margin-top: 2rem; letter-spacing: 0.5px; }
        #generate-more-btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--color-primary), var(--color-tertiary)); box-shadow: var(--shadow-lg); transform: scale(1.02); }
        #generate-more-btn:disabled { background: #cccccc; color: #888888; cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none; }
        #generate-more-btn .fa-sync-alt { color: white; }

        /* Modal */
        #story-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(51, 51, 51, 0.85); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #story-modal.active { display: flex; }
        .modal-content-wrapper {
            background-color: var(--color-modal-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1.5rem 2rem;
            max-width: 950px;
            width: 95%;
            max-height: 90vh;
            min-height: 450px; /* More height for potential game space */
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: var(--color-border); border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 1.7rem; color: var(--color-text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); z-index: 60; }
        .modal-close-btn:hover { background-color: var(--color-secondary); color: white; transform: rotate(90deg); }
        #modal-title { font-size: 1.9rem; text-align: center; margin-bottom: 1.2rem; flex-shrink: 0; padding: 0 1rem; line-height: 1.3; }

        /* Content Area (Text + Image) */
        #modal-content-area { flex-grow: 1; min-height: 0; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--color-secondary) var(--color-border);
        }
        #modal-content-area::-webkit-scrollbar { width: 8px; }
        #modal-content-area::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #modal-content-area::-webkit-scrollbar-thumb { background-color: var(--color-secondary); border-radius: var(--border-radius); border: 1px solid var(--color-border); }
        #modal-content { padding: 0 5px; }
        #modal-content p:not(:last-child) { margin-bottom: 1.4em; }
        #modal-content strong { color: var(--color-primary); font-weight: 700; }
        #modal-content em { color: var(--color-tertiary); font-style: italic; }
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 { font-family: 'Merriweather', serif; margin-top: 2.2em; margin-bottom: 1.1em; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.5em; font-weight: 700; }
        #modal-content h1 { font-size: 1.5em; } #modal-content h2 { font-size: 1.35em; } #modal-content h3 { font-size: 1.2em; color: var(--color-tertiary); } #modal-content h4 { font-size: 1.1em; color: var(--color-text-muted); border-bottom: none;}
        /* Image styles */
        #modal-content .final-image { display: block; max-width: 80%; height: auto; margin: 2.5rem auto 1rem auto; border: 1px solid var(--color-border); border-radius: var(--border-radius); box-shadow: var(--shadow-md); cursor: pointer; transition: transform 0.2s ease; }
        #modal-content .final-image:hover { transform: scale(1.03); box-shadow: var(--shadow-lg); }
        #modal-content .image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; margin: 2.5rem auto 1rem auto; color: var(--color-text-muted); }
        #modal-content .image-placeholder .spinner { border: 4px solid rgba(200, 200, 200, 0.5); width: 35px; height: 35px; border-radius: 50%; border-left-color: var(--color-secondary); animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        #modal-content .image-placeholder .placeholder-icon { font-size: 2.5rem; color: var(--color-tertiary); }

        /* Chat Section */
        #chat-section { border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem; flex-shrink: 0; display: flex; flex-direction: column; max-height: 250px; }
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 0.8rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f9f9f9; scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--color-tertiary) var(--color-border);
        }
        #chat-history::-webkit-scrollbar { width: 6px; }
        #chat-history::-webkit-scrollbar-track { background: var(--color-border); border-radius: var(--border-radius); }
        #chat-history::-webkit-scrollbar-thumb { background-color: var(--color-tertiary); border-radius: var(--border-radius); }
        .chat-message { margin-bottom: 0.6rem; padding: 0.6rem 0.9rem; border-radius: var(--border-radius); max-width: 85%; word-wrap: break-word; line-height: 1.5; font-size: 0.95rem; }
        .user-message { background-color: var(--color-iemanja); color: var(--color-text); margin-left: auto; text-align: left; } /* User message blue */
        .ai-message { background-color: #efefef; color: var(--color-text); margin-right: auto; text-align: left; } /* AI message light grey */
        .chat-error { color: var(--color-error-text); font-style: italic; text-align: center; font-size: 0.9em; }
        #chat-input-area { display: flex; gap: 0.5rem; }
        #chat-input { flex-grow: 1; padding: 0.7rem 0.9rem; border: 1px solid var(--color-border); background-color: white; color: var(--color-text); border-radius: var(--border-radius); font-size: 0.95rem; }
        #chat-input:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 2px rgba(0, 0, 128, 0.1); }
        #chat-send-btn { padding: 0.7rem 1.1rem; background-color: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-size: 0.9rem; }
        #chat-send-btn:hover:not(:disabled) { background-color: #0000cd; } /* Darker blue */
        #chat-send-btn:disabled { background-color: var(--color-text-muted); cursor: not-allowed; }
        #chat-loading { text-align: center; padding: 0.5rem; font-size: 0.9em; color: var(--color-text-muted); display: none; }
        #chat-loading .fa-spinner { margin-right: 0.5rem; }

        /* Loading Indicator & Minigame */
        #modal-loading { text-align: center; padding: 2rem; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: space-between; /* Space out elements */ z-index: 55; border-radius: var(--border-radius); }
        .loading-spinner-modal { width: 50px; height: 50px; border: 5px solid #e0e0e0; border-top-color: var(--color-secondary); border-radius: 50%; animation: spin 1.2s linear infinite; margin-bottom: 1rem; }
        #modal-loading p.loading-text { font-weight: 600; color: var(--color-text); font-size: 1.3rem; font-family: 'Merriweather'; margin-bottom: 1.5rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MINIGAME AREA STYLES */
        #minigame-area { width: 100%; max-width: 500px; padding: 1.5rem; margin-top: 1rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: #f5f5f5; flex-grow: 1; /* Allow game area to take space */ display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; /* Ensure it has some height */ }
        #game-instructions { font-size: 1rem; color: var(--color-text-muted); margin-bottom: 1rem; font-weight: 600; }
        #game-level { font-size: 0.9rem; color: var(--color-primary); font-weight: 700; margin-bottom: 0.5rem; }
        #game-score { font-size: 1.1rem; color: var(--color-tertiary); font-weight: 700; margin-bottom: 1.5rem; }
        #game-content { width: 100%; text-align: center; flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        /* Example elements for game types */
        .game-target { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--color-primary); font-family: 'Merriweather'; }
        .game-options { display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap; margin-top: 1rem; }
        .game-option { cursor: pointer; padding: 0.8rem 1.2rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); background-color: white; transition: all 0.2s ease; font-size: 1.2rem; box-shadow: var(--shadow-sm); }
        .game-option:hover { background-color: var(--color-iemanja); transform: scale(1.05); }
        .rhythm-cue { width: 50px; height: 50px; border-radius: 50%; background-color: var(--color-secondary); margin: 1rem auto; animation: pulse 1.5s infinite ease-in-out; }
        .rhythm-hit-area { margin-top: 1rem; padding: 1rem; font-size: 0.9rem; color: var(--color-text-muted); }
        @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.7; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(0.9); opacity: 0.7; } }
        .game-feedback { margin-top: 1rem; font-weight: 700; height: 20px; }
        .feedback-correct { color: var(--color-tertiary); }
        .feedback-incorrect { color: var(--color-xango); }

        /* Error Msg */
        .error-msg { background-color: var(--color-error-bg); color: var(--color-error-text); padding: 1.2rem; border-radius: var(--border-radius); border: 1px solid var(--color-error-border); margin-top: 1.5rem; text-align: center; flex-shrink: 0; font-weight: 600; font-family: 'Open Sans'; }
        .error-msg i { margin-right: 0.7rem; }
        .content-hidden { display: none !important; }
        .title-item.hidden { display: none; }

        /* Fullscreen Image Overlay */
        #image-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(50, 50, 50, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; padding: 2rem; cursor: zoom-out; }
        #image-fullscreen-overlay.active { display: flex; }
        #fullscreen-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 3px solid var(--color-oxala); box-shadow: 0 0 30px rgba(255, 255, 255, 0.3); }
        #fullscreen-close-btn { position: absolute; top: 20px; right: 25px; background: rgba(0, 0, 0, 0.6); border: 1px solid var(--color-oxala); border-radius: 50%; width: 40px; height: 40px; font-size: 1.8rem; color: var(--color-oxala); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition-normal); }
        #fullscreen-close-btn:hover { background-color: var(--color-secondary); color: black; transform: scale(1.1); }
    </style>
</head>
<body>
     <!-- Header/Navbar -->
     <nav class="navbar mb-10">
         <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
             <div class="flex items-center text-center mb-3 sm:mb-0">
                 <h1 class="logo text-3xl sm:text-4xl">
                     <i class="fas fa-drum mr-3 text-yellow-600"></i> <!-- Icono Tambor -->
                     Hist√≥rias de Candombl√©
                 </h1>
             </div>
             <span class="text-sm text-gray-600 font-sans tracking-wider">¬ª Guia Interativo ¬´</span>
         </div>
     </nav>

     <!-- Main content -->
     <main class="container mx-auto px-4 pb-16">
         <!-- Hero section -->
         <section class="mb-12 text-center">
             <h1 class="page-title text-5xl sm:text-6xl mb-5">Conhecendo o Candombl√©</h1>
             <p class="text-xl text-gray-700 mb-8 max-w-3xl mx-auto font-light">Explore a riqueza dos Orix√°s, rituais, hist√≥ria e conceitos desta religi√£o afro-brasileira. Selecione um tema ou use a busca.</p>
         </section>

         <!-- Search Bar -->
         <section id="search-container" class="mb-10 max-w-2xl mx-auto">
             <input type="text" id="search-input" placeholder="Buscar Orix√°, conceito, na√ß√£o...">
             <i class="fas fa-search"></i>
         </section>

         <!-- Title List Container -->
         <section class="mb-10">
             <h2 class="section-title text-3xl sm:text-4xl mb-8 text-center mx-auto">
                 <i class="fas fa-book-open text-green-700 mr-2"></i> <!-- Icono Libro -->
                 √çndice de Conhecimentos
             </h2>
             <div id="title-list">
                  <p id="titles-loading" class="text-gray-500 col-span-full text-center text-lg font-sans">Carregando √≠ndice...</p>
                  <!-- .title-item added here -->
             </div>
             <p id="no-results" class="text-gray-500 col-span-full text-center text-lg mt-4 hidden font-sans">¬ª Nenhum resultado encontrado para sua busca ¬´</p>
             <div id="generate-more-container" class="text-center mt-8">
                 <button id="generate-more-btn">
                      <i class="fas fa-sync-alt mr-2 animate-spin hidden"></i>
                     Gerar Mais T√≥picos (40)
                  </button>
             </div>
         </section>

     </main>

     <!-- Explanation Modal -->
     <div id="story-modal">
         <div class="modal-content-wrapper">
             <button class="modal-close-btn" id="modal-close" aria-label="Fechar">&times;</button>

             <!-- Loading Indicator & Minigame -->
             <div id="modal-loading">
                 <div> <!-- Wrapper for spinner and text -->
                    <div class="loading-spinner-modal"></div>
                    <p class="loading-text">Carregando informa√ß√µes... Ax√©!</p>
                 </div>
                 <!-- MINIGAME AREA -->
                 <div id="minigame-area" class="content-hidden"> <!-- Initially hidden -->
                     <div id="game-level">N√≠vel 1</div>
                     <div id="game-score">Pontos: 0</div>
                     <div id="game-instructions">Jogo da Espera: Pressione ESPA√áO no ritmo!</div>
                     <div id="game-content">
                         <!-- Content changes based on level -->
                         <div class="rhythm-cue"></div>
                         <div class="rhythm-hit-area">(Pressione ESPA√áO aqui)</div>
                     </div>
                     <div class="game-feedback"></div>
                 </div>
             </div>

             <!-- Content Area Wrapper (Scrollable Text + Fixed Chat below) -->
             <div id="modal-story-content-area" class="content-hidden flex flex-col flex-grow min-h-0">
                 <!-- Scrollable Text Area -->
                 <div id="modal-content-area">
                     <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-4 text-center flex-shrink-0"></h2>
                     <div id="modal-content">
                         <!-- Explanation text (HTML) goes here -->
                         <!-- Image and placeholder appended here -->
                     </div>
                 </div>
                 <!-- Chat Section -->
                 <div id="chat-section">
                     <div id="chat-history"></div>
                     <div id="chat-loading"><i class="fas fa-spinner fa-spin"></i> Pensando...</div>
                     <div id="chat-input-area">
                         <input type="text" id="chat-input" placeholder="Pergunte mais sobre este t√≥pico...">
                         <button id="chat-send-btn" aria-label="Enviar Mensagem"><i class="fas fa-paper-plane"></i></button>
                     </div>
                 </div>
                 <!-- Error Display Area -->
                 <div id="modal-error" class="error-msg content-hidden mt-4 flex-shrink-0">
                      <i class="fas fa-exclamation-circle"></i>
                      <span id="modal-error-message"></span>
                  </div>
             </div>
          </div>
      </div>

      <!-- Fullscreen Image Overlay -->
      <div id="image-fullscreen-overlay">
          <button id="fullscreen-close-btn" aria-label="Fechar Imagem">&times;</button>
          <img id="fullscreen-image" src="" alt="Imagem Ampliada">
      </div>

      <!-- Footer -->
      <footer class="bg-gray-100 text-gray-600 py-6 mt-12 border-t border-gray-200 font-sans">
          <div class="container mx-auto px-4 text-center text-sm">
              <p>Informa√ß√µes geradas por IA com prop√≥sito informativo e de respeito √† cultura do Candombl√©.</p>
              <p class="mt-1">Este conte√∫do √© uma introdu√ß√£o e n√£o substitui o estudo aprofundado ou a viv√™ncia religiosa.</p>
              <p class="mt-2">¬© 2025 Guia Interativo de Candombl√©</p>
          </div>
      </footer>

    <script>
        // ========== CONFIG & DATA ==========
        const predefinedTitles = [
            // Orix√°s Principais (Ketu/Nag√¥ como base inicial)
            "Exu", "Ogum", "Ox√≥ssi", "Logun Ed√©", "Xang√¥", "Ayr√†", "Omolu", "Obaluai√™", "Oxumar√©", "Ossaim", "Nan√£ Buruqu√™", "Iemanj√°", "Oxum", "Ians√£ (Oy√°)", "Ob√°", "Ew√°", "Ibeji", "Oxal√° (Oxalufan e Oxaguian)", "If√° (Orunmil√°)",
            // Conceitos Fundamentais
            "Ax√© (For√ßa Vital)", "Ori (Cabe√ßa/Destino)", "Eb√≥ (Oferenda/Sacrif√≠cio)", "Jogo de B√∫zios (Or√°culo)", "Incorpora√ß√£o (Transe)", "Terreiro (Casa de Candombl√©)", "Il√™ Ax√©", "Barrac√£o", "Pai de Santo (Babalorix√°)", "M√£e de Santo (Ialorix√°)", "Filho de Santo (Ia√¥)", "Ogan", "Ekedi", "Inicia√ß√£o (Feitura de Santo)", "Obriga√ß√µes (7, 14, 21 anos)", "Santo (Orix√° Pessoal)", "Adjunt√≥", "Qualidades de Orix√°", "Ervas Sagradas (Ew√©)", "Comidas Rituais (Ajeum)", "Sincretismo Religioso (Hist√≥ria e Cr√≠ticas)", "Intoler√¢ncia Religiosa contra o Candombl√©",
            // Na√ß√µes (Na√ß√µes)
            "Na√ß√£o Ketu (Origem Yoruba)", "Na√ß√£o Jeje (Origem Ewe/Fon)", "Na√ß√£o Angola (Origem Bantu)", "Diferen√ßas entre as Na√ß√µes", "Orix√°s espec√≠ficos de cada Na√ß√£o", "Toques e Cantigas por Na√ß√£o",
            // Rituais e Cerim√¥nias
            "Xir√™ (Festa P√∫blica dos Orix√°s)", "Toques (Ritmos dos Atabaques)", "Cantigas de Orix√°", "Dan√ßas Sagradas", "Festa de Iemanj√° (2 de Fevereiro)", "Festa de Oxum", "Festa de Xang√¥ (Fogueira)", "√Åguas de Oxal√°", "Sa√≠da de Ia√¥", "Or√¥ (Rituais Secretos)", "Pad√™ de Exu", "Sasanha (C√¢nticos para Folhas)", "Axex√™ (Ritual F√∫nebre)",
            // Hist√≥ria e Sociedade
            "Origens Africanas do Candombl√©", "A Di√°spora Africana e o Candombl√© no Brasil", "Persegui√ß√£o Hist√≥rica ao Candombl√©", "Resist√™ncia Cultural e Religiosa", "Figuras Hist√≥ricas Importantes (Ex: M√£e Menininha do Gantois)", "Legaliza√ß√£o e Reconhecimento", "O Papel Social do Terreiro na Comunidade", "Candombl√© e Identidade Negra", "Rela√ß√£o com a Umbanda", "Candombl√© Contempor√¢neo: Desafios e Adapta√ß√µes", "Patrim√¥nio Cultural Imaterial",
            // Cosmologia e Mitologia
            "Olodumar√© / Olorum (Deus Supremo)", "Orun (Mundo Espiritual)", "Aiy√™ (Mundo Material)", "Cria√ß√£o do Mundo (Mitos)", "Lendas dos Orix√°s (It√£s)", "Hierarquia dos Orix√°s", "Voduns (Divindades Jeje)", "Nkisis (Divindades Angola)", "A Morte no Candombl√©", "Reencarna√ß√£o (Conceito)",
            // Objetos e S√≠mbolos
            "Atabaques (Rum, Rumpi, L√©)", "Agog√¥", "Xequer√™", "Adj√°", "Fios de Contas (Guias)", "Ferramentas dos Orix√°s", "Cores Simb√≥licas dos Orix√°s", "Assentamento do Orix√° (Ot√°)", "Peji (Altar)", "Quartinha", "Velas", "Incensos e Defumadores", "Pano da Costa", "Roupas Rituais (Branco predominante)",
            // Outros T√≥picos Relevantes
            "Candombl√© de Caboclo", "Culin√°ria Afro-Brasileira e Candombl√©", "Sa√∫de e Cura no Candombl√© (Ervas)", "√âtica no Candombl√©", "A Quest√£o Animal nos Rituais", "M√∫sica Popular Brasileira e Influ√™ncia do Candombl√©", "Artes Visuais e Candombl√©", "Candombl√© fora do Brasil", "Estudos Acad√™micos sobre Candombl√©", "Representa√ß√£o na M√≠dia",
            // Perguntas Espec√≠ficas
            "Qual o dia da semana de Ogum?", "Quais as comidas preferidas de Oxum?", "Como funciona a consulta ao Jogo de B√∫zios?", "Qual a import√¢ncia do Ax√©?", "O que significa 'feitura de santo'?", "Quais s√£o os principais atabaques?", "Quem foi M√£e Menininha do Gantois?", "Diferen√ßa entre Omolu e Obaluai√™", "O que √© um adjunt√≥?", "Qual o papel do Ogan?", "Ekedis podem incorporar?", "O que √© um 'barco' de Ia√¥s?", "Para que serve o Pad√™ de Exu?", "Qual a rela√ß√£o entre Oxal√° e Iemanj√°?", "Hist√≥ria da Fogueira de Xang√¥", "O que s√£o os Ibejis?", "Nan√£ √© considerada a Orix√° mais velha?", "Logun Ed√© √© homem ou mulher?", "Qual a rela√ß√£o de Ox√≥ssi com as matas?", "Ians√£ comanda os ventos e tempestades?", "Quais ervas s√£o associadas a Ossaim?", "Por que o branco √© importante para Oxal√°?", "Qual o metal de Ogum?", "Onde vive Iemanj√°?", "Como Ob√° perdeu sua orelha (mito)?", "Ew√° e a vid√™ncia", "Oxumar√© representa o arco-√≠ris?", "O que s√£o Voduns?", "O que s√£o Nkisis?", "Existe pecado no Candombl√©?", "Como o Candombl√© v√™ a morte?", "O que √© intoler√¢ncia religiosa?", "Como denunciar intoler√¢ncia religiosa?", "Qual a import√¢ncia da ancestralidade?", "O que √© 'feitura na cabe√ßa'?", "Candombl√© √© magia negra?", "Todos podem frequentar um terreiro?", "Como se vestir para ir a um terreiro?", "O que √© o Olubaj√©?",
            // Adicionando mais para chegar perto de 400...
            "Arquitetura de um Terreiro", "Simbologia da Cor Branca", "Simbologia da Cor Vermelha", "Simbologia da Cor Azul", "Simbologia da Cor Verde", "Simbologia da Cor Amarela", "Orix√°s e os Elementos da Natureza (√Ågua)", "Orix√°s e os Elementos da Natureza (Fogo)", "Orix√°s e os Elementos da Natureza (Terra)", "Orix√°s e os Elementos da Natureza (Ar)", "Orix√° Regente do Ano", "Influ√™ncia Lunar nos Rituais", "Animais Sagrados no Candombl√©", "A Figura do 'Povo da Rua' (Exus e Pombagiras) - Vis√£o do Candombl√© vs Umbanda", "Orix√°s Guerreiros", "Orix√°s das √Åguas Doces", "Orix√°s das √Åguas Salgadas", "Orix√°s da Justi√ßa", "Orix√°s da Ca√ßa e Fartura", "Orix√°s da Cura e Doen√ßa", "Orix√°s da Maternidade e Fam√≠lia", "Orix√°s da Transforma√ß√£o", "Orix√°s da Sabedoria e Conhecimento", "Orix√°s da Morte e Renascimento", "O conceito de 'Fam√≠lia de Santo'", "Orix√°s e os Chacras (Interpreta√ß√µes)", "A import√¢ncia da oralidade", "Mitos de Exu", "Mitos de Ogum", "Mitos de Ox√≥ssi", "Mitos de Xang√¥", "Mitos de Iemanj√°", "Mitos de Oxum", "Mitos de Ians√£", "Mitos de Oxal√°", "Rituais de Limpeza e Purifica√ß√£o (Banhos)", "O uso de P√≥lvora em Rituais (Fundamento)", "A rela√ß√£o com a Natureza", "O Candombl√© e a Ecologia", "Candombl√© e Direitos Humanos", "Candombl√© e Pol√≠tica no Brasil", "Terreiros Tombados como Patrim√¥nio Hist√≥rico", "Museus dedicados √† Cultura Afro-Brasileira", "A di√°spora Jeje no Maranh√£o (Tambor de Mina)", "A di√°spora Bantu em outras regi√µes", "Candombl√© Banto", "Candombl√© Nag√¥-Vodum", "O papel da mulher no Candombl√©", "Lideran√ßas femininas hist√≥ricas", "O Candombl√© e a quest√£o LGBTQIA+", "Sincretismo com Santos Cat√≥licos: Ogum e S√£o Jorge", "Sincretismo: Iemanj√° e Nossa Senhora da Concei√ß√£o", "Sincretismo: Ox√≥ssi e S√£o Sebasti√£o", "Sincretismo: Xang√¥ e S√£o Jer√¥nimo/S√£o Pedro", "Sincretismo: Ians√£ e Santa B√°rbara", "Sincretismo: Oxum e Nossa Senhora Aparecida/da Concei√ß√£o", "Sincretismo: Omolu/Obaluai√™ e S√£o L√°zaro/S√£o Roque", "Sincretismo: Oxal√° e Jesus Cristo", "Debates sobre o fim do sincretismo", "O que √© 'assentar' um Orix√°?", "A vida ap√≥s a inicia√ß√£o", "Restri√ß√µes alimentares (Quizilas)", "A import√¢ncia do respeito aos mais velhos no Terreiro", "Como identificar um Terreiro s√©rio?", "Cargos dentro de um Terreiro (Hierarquia)", "O que √© Eled√°?", "O que √© um 'fundamento'?", "Diferen√ßa entre Candombl√© e Bruxaria", "Candombl√© e Espiritismo Kardecista s√£o a mesma coisa?", "O que √© 'virar no santo'?", "O que acontece durante um Xir√™?", "Como s√£o feitas as comidas de santo?", "Azeite de Dend√™: Uso ritual√≠stico", "Mel: Uso ritual√≠stico", "Sal: Uso ritual√≠stico", "Fumo (Tabaco): Uso ritual√≠stico", "Bebidas Rituais (Alu√°, etc.)", "A m√∫sica como condutora do Ax√©", "A dan√ßa como express√£o do Orix√°", "O sil√™ncio nos rituais", "A import√¢ncia da comunidade (Egb√©)", "Festivais Culturais relacionados ao Candombl√©", "Influ√™ncia na Capoeira", "Influ√™ncia no Samba", "Jorge Amado e a representa√ß√£o do Candombl√©", "Pierre Verger: Fot√≥grafo dos Orix√°s", "Caryb√©: Artista do Candombl√©", "Mestre Didi: Escultor e Sacerdote", "O que √© um Babala√¥ (Diferente de Babalorix√°)?", "O sistema de If√°", "Odus de If√°", "A rela√ß√£o entre If√° e os Orix√°s no Ketu", "O Candombl√© na Bahia", "O Candombl√© no Rio de Janeiro", "O Candombl√© em S√£o Paulo", "O Candombl√© em Pernambuco", "O Candombl√© no Rio Grande do Sul (Batuque)", "Adapta√ß√µes regionais do Candombl√©", "Novas gera√ß√µes no Candombl√©", "O uso da internet e redes sociais pelos Terreiros", "Desmistificando preconceitos comuns", "Orix√°s e arqu√©tipos junguianos (An√°lises)", "A beleza est√©tica dos rituais", "O sagrado no cotidiano do Candomblecista", "A vis√£o de mundo Yorub√°", "A vis√£o de mundo Bantu", "A vis√£o de mundo Fon/Ewe", "Tempo c√≠clico vs Tempo linear", "A import√¢ncia da mem√≥ria e da ancestralidade."
            // Objetivo √© ter uma base robusta, Generate More complementa.
        ];
        const candombleThemes = [ // Temas para gerar mais t√≠tulos
            "Orix√°s e suas qualidades", "conceitos do Candombl√© Ketu", "rituais da na√ß√£o Angola", "hist√≥ria do Candombl√© Jeje", "ervas sagradas e seus usos", "comidas rituais espec√≠ficas", "lendas (it√£s) menos conhecidas", "figuras hist√≥ricas do Candombl√©", "instrumentos musicais sagrados", "diferen√ßas entre na√ß√µes", "sincretismo religioso", "intoler√¢ncia religiosa", "cosmologia Yorub√°", "cosmologia Bantu", "organiza√ß√£o social de um terreiro", "obriga√ß√µes religiosas", "o jogo de b√∫zios", "Candombl√© de Caboclo", "influ√™ncia africana no Brasil", "Voduns", "Nkisis", "festas de Orix√°s", "dan√ßas sagradas", "cantigas espec√≠ficas"
        ];
        const textApiConfig = {
            model: "mistral",
            systemPrompt: "Voc√™ √© um pesquisador e estudioso dedicado √†s religi√µes afro-brasileiras, com profundo respeito e conhecimento sobre o Candombl√©. Sua tarefa √© fornecer uma explica√ß√£o clara, detalhada e respeitosa sobre o Orix√°, conceito, ritual, na√ß√£o ou t√≥pico do Candombl√© indicado. Aborde a origem (se aplic√°vel), caracter√≠sticas principais, simbolismo, import√¢ncia dentro da religi√£o, e rela√ß√µes com outros elementos. Use terminologia apropriada (Yorub√°, Portugu√™s) quando necess√°rio, explicando-a. Evite estere√≥tipos e sensacionalismo. O objetivo √© um texto informativo e culturalmente sens√≠vel de aproximadamente 1200-1300 palavras. Baseie sua explica√ß√£o *unicamente* no seguinte t√≥pico do Candombl√©:",
            timeoutSeconds: 240 // Increased timeout (4 minutes)
        };
        const chatApiConfig = {
            model: "mistral-tiny",
            systemPrompt: "Aja como um assistente de estudos sobre Candombl√©, focado *apenas* no t√≥pico atualmente exibido. Responda perguntas de forma concisa, respeitosa e informativa, baseando-se na descri√ß√£o principal e no conhecimento geral sobre o t√≥pico espec√≠fico. Mantenha o foco e a relev√¢ncia cultural.",
            timeoutSeconds: 45
        };
        const titleGenerationConfig = {
            model: "mistral",
            systemPrompt: "Atue como um gerador de ideias conciso para um guia sobre Candombl√©. Gere exatamente 40 nomes de Orix√°s, conceitos, rituais, na√ß√µes, figuras hist√≥ricas ou t√≥picos relevantes do Candombl√©, adequados para uma descri√ß√£o detalhada e respeitosa. Retorne *apenas* a lista de itens, um por linha. N√£o inclua n√∫meros, h√≠fens, introdu√ß√µes ou despedidas.",
            timeoutSeconds: 60 // More time for more titles
        };

        // ========== DOM ELEMENTS ==========
        const searchInput = document.getElementById('search-input');
        const titleListContainer = document.getElementById('title-list');
        const titlesLoading = document.getElementById('titles-loading');
        const noResultsMsg = document.getElementById('no-results');
        const generateMoreContainer = document.getElementById('generate-more-container');
        const generateMoreBtn = document.getElementById('generate-more-btn');
        const generateMoreSpinner = generateMoreBtn.querySelector('i');
        const storyModal = document.getElementById('story-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const modalStoryContentArea = document.getElementById('modal-story-content-area');
        const modalTextArea = document.getElementById('modal-content-area');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalError = document.getElementById('modal-error');
        const modalErrorMessage = document.getElementById('modal-error-message');
        // Chat Elements
        const chatSection = document.getElementById('chat-section');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatLoadingIndicator = document.getElementById('chat-loading');
        // Fullscreen Image Elements
        const imageFullscreenOverlay = document.getElementById('image-fullscreen-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
        // Minigame Elements
        const minigameArea = document.getElementById('minigame-area');
        const gameLevelDisplay = document.getElementById('game-level');
        const gameScoreDisplay = document.getElementById('game-score');
        const gameInstructions = document.getElementById('game-instructions');
        const gameContent = document.getElementById('game-content');
        const gameFeedback = document.querySelector('.game-feedback');

        // ========== State Variables ==========
        let currentTopic = null; // For chat context
        let minigameActive = false;
        let gameLevel = 1;
        let gameScore = 0;
        let gameTimer = null;
        let expectedGameAction = null; // 'click', 'keypress'
        let gameTimeout = null; // Timeout for player action

        // ========== MINIGAME LOGIC ==========
        const gameLevelsData = [
            // Level 1: Simple Rhythm (Spacebar)
            { type: 'rhythm', instruction: 'Jogo da Espera: Pressione ESPA√áO no ritmo!', cueClass: 'rhythm-cue', hitAreaText: '(Pressione ESPA√áO aqui)', key: 'Space', points: 10, timeBetweenCues: 1500, actionTimeLimit: 1000 },
            // Level 2: Symbol Matching (Click) - Example data needed
            { type: 'match', instruction: 'Associe o Orix√° ao seu elemento/s√≠mbolo:', options: 3, points: 15, actionTimeLimit: 5000 },
            // Level 3: Faster Rhythm
            { type: 'rhythm', instruction: 'Ritmo mais r√°pido! Pressione ESPA√áO!', cueClass: 'rhythm-cue', hitAreaText: '(Pressione ESPA√áO aqui)', key: 'Space', points: 20, timeBetweenCues: 1000, actionTimeLimit: 700 },
            // Level 4: More Complex Matching
            { type: 'match', instruction: 'Associa√ß√£o r√°pida! Qual s√≠mbolo pertence a este Orix√°?', options: 4, points: 25, actionTimeLimit: 4000 },
             // Level 5: Alternating Rhythm Keys (Example: A and L)
            { type: 'rhythm-multi', instruction: 'Use as teclas A e L no ritmo!', cues: [{key: 'KeyA', display: 'A'}, {key: 'KeyL', display: 'L'}], points: 30, timeBetweenCues: 1200, actionTimeLimit: 800 },
            // Add more levels as needed
        ];

        // Example Matching Data (replace with real associations)
        const matchingData = {
            'Ox√≥ssi': { target: 'üèπ', options: ['üèπ', '‚ö°', '‚öñÔ∏è', 'üåä'] }, // Bow/Arrow
            'Iemanj√°': { target: 'üåä', options: ['üåä', 'üî•', 'üåø', '‚õèÔ∏è'] }, // Water/Waves
            'Xang√¥': { target: '‚öñÔ∏è', options: ['‚öñÔ∏è', '‚òÄÔ∏è', 'üåô', 'üèπ'] }, // Balance/Justice scales
            'Ogum': { target: '‚õèÔ∏è', options: ['‚õèÔ∏è', 'üåä', '‚ö°', 'üåø'] }, // Pickaxe/Tools
            'Ians√£': { target: '‚ö°', options: ['‚ö°', 'üåø', '‚öñÔ∏è', '‚òÄÔ∏è'] }  // Lightning
            // Add many more
        };

        function setupGameLevel(levelIndex) {
            if (levelIndex >= gameLevelsData.length) {
                gameInstructions.textContent = `N√≠vel M√°ximo Atingido! Continue jogando o √∫ltimo n√≠vel.`;
                levelIndex = gameLevelsData.length - 1; // Repeat last level
            }
            const levelData = gameLevelsData[levelIndex];
            gameLevel = levelIndex + 1;
            gameLevelDisplay.textContent = `N√≠vel ${gameLevel}`;
            gameInstructions.textContent = levelData.instruction;
            gameContent.innerHTML = ''; // Clear previous content
            gameFeedback.textContent = '';
            clearTimeout(gameTimeout); // Clear any pending action timeout

            if (levelData.type === 'rhythm') {
                const cue = document.createElement('div');
                cue.className = levelData.cueClass;
                const hitArea = document.createElement('div');
                hitArea.className = 'rhythm-hit-area';
                hitArea.textContent = levelData.hitAreaText;
                gameContent.appendChild(cue);
                gameContent.appendChild(hitArea);
                expectedGameAction = 'keypress';
                cue.style.animationDuration = `${levelData.timeBetweenCues / 1000}s`; // Sync pulse?
                scheduleNextRhythmAction(levelData);
            } else if (levelData.type === 'match') {
                const availableKeys = Object.keys(matchingData);
                if (availableKeys.length === 0) {
                     gameInstructions.textContent = "Dados de jogo insuficientes. Reiniciando.";
                     setTimeout(() => setupGameLevel(0), 2000); // Restart if no data
                     return;
                }
                const randomKey = availableKeys[Math.floor(Math.random() * availableKeys.length)];
                const matchInfo = matchingData[randomKey];

                const target = document.createElement('div');
                target.className = 'game-target';
                target.textContent = randomKey; // Display Orix√° name
                gameContent.appendChild(target);

                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'game-options';
                // Shuffle options before displaying
                const shuffledOptions = shuffleArray([...matchInfo.options]);
                shuffledOptions.slice(0, levelData.options).forEach(opt => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'game-option';
                    optionEl.textContent = opt;
                    optionEl.addEventListener('click', () => handleGameAction(opt === matchInfo.target, levelData));
                    optionsContainer.appendChild(optionEl);
                });
                gameContent.appendChild(optionsContainer);
                expectedGameAction = 'click';
                 // Set timeout for matching action
                gameTimeout = setTimeout(() => {
                     if (minigameActive) handleGameAction(false, levelData, true); // Timeout counts as incorrect
                 }, levelData.actionTimeLimit);

            } else if (levelData.type === 'rhythm-multi') {
                 // Setup for multi-key rhythm (display area, instructions)
                const displayArea = document.createElement('div');
                displayArea.id = 'multi-rhythm-display';
                displayArea.className = 'text-4xl font-bold my-4';
                gameContent.appendChild(displayArea);
                const hitArea = document.createElement('div');
                 hitArea.className = 'rhythm-hit-area';
                 hitArea.textContent = `Pressione ${levelData.cues.map(c => c.display).join(' ou ')}`;
                 gameContent.appendChild(hitArea);
                expectedGameAction = 'keypress-multi';
                scheduleNextMultiRhythmAction(levelData);
             }
        }

        function scheduleNextRhythmAction(levelData) {
             if (!minigameActive) return;
             clearTimeout(gameTimeout); // Clear previous timeout if any
             // Add a visual cue or change state briefly before expecting input
             const cueElement = gameContent.querySelector(`.${levelData.cueClass}`);
             if (cueElement) {
                 // Simple visual feedback: Quick blink or slight size change?
                 cueElement.style.transform = 'scale(1.15)';
                 setTimeout(() => { if(cueElement) cueElement.style.transform = 'scale(1)'; }, 100);
             }

             gameTimeout = setTimeout(() => {
                if (!minigameActive) return;
                // Player needs to press the key within levelData.actionTimeLimit
                // We'll check the key press in the event listener.
                // If the listener doesn't fire in time, this timeout could mark as miss (optional)
                // For simplicity, we rely on the keypress listener triggering handleGameAction.
                // Let's schedule the *next* cue appearance instead.
                 scheduleNextRhythmAction(levelData); // Loop for next cue
             }, levelData.timeBetweenCues); // Time until the *next* cue should appear

             // Add a shorter timeout to detect if the player missed the current window
             const missTimeout = setTimeout(() => {
                 if(minigameActive && expectedGameAction === 'keypress') {
                     // If no correct key was pressed within the action time after the cue appeared.
                     // This logic is tricky. Let's simplify: check on keypress only.
                 }
             }, levelData.actionTimeLimit); // Player has this much time *after* cue appears
         }

        function scheduleNextMultiRhythmAction(levelData) {
             if (!minigameActive) return;
             clearTimeout(gameTimeout);

             // Choose a random key cue
             const currentCue = levelData.cues[Math.floor(Math.random() * levelData.cues.length)];
             const displayArea = document.getElementById('multi-rhythm-display');
             if (displayArea) displayArea.textContent = currentCue.display; // Show A or L

             // Set expected key code
             expectedGameAction = currentCue.key; // Store 'KeyA' or 'KeyL'

             gameTimeout = setTimeout(() => {
                 if (minigameActive) {
                     // No key pressed in time
                     handleGameAction(false, levelData, true);
                 }
             }, levelData.actionTimeLimit);
         }


        function handleGameAction(correct, levelData, timeout = false) {
            if (!minigameActive) return;
            clearTimeout(gameTimeout); // Stop the timeout for this action

            if (correct) {
                gameScore += levelData.points;
                gameScoreDisplay.textContent = `Pontos: ${gameScore}`;
                gameFeedback.textContent = "Ax√©! Correto!";
                gameFeedback.className = 'game-feedback feedback-correct';
                // Progress to next level every N points or after X correct actions? Let's do score based.
                if (gameScore > 0 && gameScore % 50 === 0) { // Advance level every 50 points
                    setupGameLevel(gameLevel); // gameLevel is already incremented inside if needed
                } else {
                    // Continue current level type
                    if (levelData.type === 'rhythm') scheduleNextRhythmAction(levelData);
                    else if (levelData.type === 'match') setTimeout(() => setupGameLevel(gameLevel - 1), 800); // Next match question
                     else if (levelData.type === 'rhythm-multi') scheduleNextMultiRhythmAction(levelData);
                }
            } else {
                gameFeedback.textContent = timeout ? "Tempo esgotado!" : "Ops! Tente de novo.";
                gameFeedback.className = 'game-feedback feedback-incorrect';
                // Maybe stay on the same level or reset current task
                setTimeout(() => {
                     if (minigameActive) {
                         gameFeedback.textContent = ''; // Clear feedback
                         if (levelData.type === 'rhythm') scheduleNextRhythmAction(levelData);
                         else if (levelData.type === 'match') setupGameLevel(gameLevel - 1); // Try another match
                         else if (levelData.type === 'rhythm-multi') scheduleNextMultiRhythmAction(levelData);
                     }
                 }, 1200); // Give time to read feedback
            }
        }

         // Event listener for rhythm game keypress
        document.addEventListener('keydown', (event) => {
            if (!minigameActive || !storyModal.classList.contains('active')) return;

            const levelData = gameLevelsData[gameLevel - 1];
            if (!levelData) return;

            if (expectedGameAction === 'keypress' && event.code === levelData.key) {
                 event.preventDefault(); // Prevent space bar scrolling
                 handleGameAction(true, levelData);
            } else if (expectedGameAction.startsWith('Key') && event.code === expectedGameAction) { // For rhythm-multi
                event.preventDefault();
                handleGameAction(true, levelData);
            }
            // No 'else' here to handle incorrect key presses explicitly, only timeout or correct press matters
         });


        function startGame() {
            if (!minigameArea || !modalLoadingIndicator) return;
            console.log("Starting minigame...");
            minigameActive = true;
            gameLevel = 1;
            gameScore = 0;
            gameScoreDisplay.textContent = `Pontos: ${gameScore}`;
            minigameArea.classList.remove('content-hidden');
            setupGameLevel(0); // Start level 1
        }

        function stopGame() {
            if (!minigameArea) return;
            console.log("Stopping minigame...");
            minigameActive = false;
            clearTimeout(gameTimer);
            clearTimeout(gameTimeout);
            minigameArea.classList.add('content-hidden');
            gameContent.innerHTML = ''; // Clear game content
            gameFeedback.textContent = '';
        }


        // ========== API FUNCTIONS ==========
        async function fetchTextFromApi(prompt, config, isChat = false) {
            const encodedPrompt = encodeURIComponent(prompt);
            const systemPromptToUse = isChat && currentTopic
                ? `Voc√™ √© um assistente de estudos sobre Candombl√©, focado *apenas* no t√≥pico: '${currentTopic}'. Responda perguntas de forma concisa, respeitosa e informativa, baseando-se na descri√ß√£o principal e no conhecimento geral sobre este t√≥pico espec√≠fico. Mantenha o foco e a relev√¢ncia cultural.`
                : config.systemPrompt;
            const encodedSystem = encodeURIComponent(systemPromptToUse);
            const params = new URLSearchParams({ model: config.model, system: encodedSystem });
            // Seed might not be ideal for factual recall, maybe remove? Let's keep for variety for now.
            if (config.seed && !isChat) params.append('seed', Math.floor(Math.random() * 100000));
            const url = `https://text.pollinations.ai/${encodedPrompt}?${params.toString()}`;
            console.log(`Fetching text (Chat: ${isChat}, Timeout: ${config.timeoutSeconds}s): ${url.substring(0, 150)}...`);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeoutSeconds * 1000);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`(${response.status}) Nossos servidores parecem ocupados. Por favor, tente novamente em alguns instantes.`);
                const text = await response.text();
                if (!text || text.trim().length < 10) throw new Error("A resposta da IA foi muito curta ou vazia. Tente novamente ou reformule.");
                console.log(`API Response received (${text.length} chars)`);
                return text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("API Fetch Error:", error);
                if (error.name === 'AbortError') throw new Error(`A conex√£o demorou demais (>${config.timeoutSeconds}s). Verifique sua internet ou tente mais tarde.`);
                throw new Error(error.message || "Ocorreu um erro inesperado ao contactar a IA.");
            }
        }
        async function fetchExplanationText(conceptTitle) { return fetchTextFromApi(conceptTitle, textApiConfig, false); }
        async function fetchChatResponse(userQuery) { if (!currentTopic) throw new Error("Contexto do t√≥pico n√£o definido para o chat."); return fetchTextFromApi(userQuery, chatApiConfig, true); }
        async function fetchGeneratedTitles() {
             const randomTheme = getRandomElement(candombleThemes) || "conceitos gerais do Candombl√©";
             const specificPrompt = `Gere 40 nomes ou conceitos sobre ${randomTheme}`; // Ask for 40
             return fetchTextFromApi(specificPrompt, titleGenerationConfig, false)
                 .then(text => {
                     const titles = text.split('\n').map(line => line.replace(/^[-\d.\s*]+/, '').trim()).filter(line => line.length > 3 && line.length < 150);
                     if (titles.length < 10) throw new Error("A IA n√£o gerou t√≥picos suficientes."); // Expect at least some
                     return titles.slice(0, 40); // Return up to 40
                 });
        }
        function createPollinationsImageUrl(promptText, options = {}) {
            const defaults = { seed: Math.floor(Math.random() * 10000000), width: 800, height: 600, nologo: true };
            const settings = { ...defaults, ...options };
            const safePromptText = typeof promptText === 'string' && promptText.trim() !== '' ? promptText : "Candombl√© art";
            // Respectful prompt: focus on symbolism, nature, energy, avoid literal human depictions unless specific Orix√° known for it & done carefully.
            const enhancedPrompt = `Symbolic and respectful artistic representation inspired by '${safePromptText}' from Candombl√©. Focus on elements (water, fire, forest, wind), sacred objects (drums, shells, tools), colors associated, energy flow. Abstract or semi-abstract style preferred. Avoid realistic human figures or stereotypical imagery. Serene or powerful atmosphere.`;
            const escapedPrompt = encodeURIComponent(enhancedPrompt);
            if (!escapedPrompt) return '';
            const negativePrompt = "photorealistic human face, cartoon, caricature, disrespectful imagery, text, words, labels, letters, diagram, chart, map, logo, watermark, signature, multiple images, collage, blurry, low quality";
            const escapedNegative = encodeURIComponent(negativePrompt);
            let url = `https://image.pollinations.ai/prompt/${escapedPrompt}?seed=${settings.seed}&width=${settings.width}&height=${settings.height}&negative=${escapedNegative}`;
            if (settings.nologo) url += '&nologo=true';
            console.log("Image URL:", url);
            return url;
        }

        // ========== Text Formatting Function ========== (unchanged)
        function formatExplanationText(rawText) { /* ... */
             if (!rawText) return ''; let formatted = rawText.trim();
             formatted = formatted.replace(/\\text\{(.*?)\}/g, '$1'); formatted = formatted.replace(/(\w)_\{?(\d+)\}?/g, '$1<sub>$2</sub>'); formatted = formatted.replace(/(\w)\^\{?([\d+\-‚àí]+)\}?/g, (match, base, exponent) => { const cleanExponent = exponent.replace('‚àí', '-'); return `${base}<sup>${cleanExponent}</sup>`; }); formatted = formatted.replace(/\\rightarrow/g, '&rarr;'); formatted = formatted.replace(/\\\[\s*(.*?)\s*\\\]/g, '<p class="formula">$1</p>');
             formatted = formatted.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>'); formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>'); formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>'); formatted = formatted.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
             formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
             const blocks = formatted.split(/\n\s*\n/).filter(p => p.trim().length > 0);
             formatted = blocks.map(block => { if (block.startsWith('<h') || block.startsWith('<p class="formula">')) return block; let content = block.replace(/\n/g, ' '); return `<p>${content}</p>`; }).join('');
             return formatted;
         }

        // ========== MODAL FUNCTIONS ========== (Integrate game start/stop)
        function showModal() { storyModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
        function hideModal() {
            storyModal.classList.remove('active');
            stopGame(); // Ensure game stops when modal closes
            if (!imageFullscreenOverlay.classList.contains('active')) { document.body.style.overflow = ''; }
            modalTextArea.scrollTop = 0;
            resetModalState();
        }
        function resetModalState() {
             modalLoadingIndicator.style.display = 'flex';
             minigameArea.classList.add('content-hidden'); // Hide game area initially
             modalStoryContentArea.classList.add('content-hidden');
             modalError.classList.add('content-hidden');
             modalTitle.textContent = '';
             modalContent.innerHTML = '';
             modalErrorMessage.textContent = '';
             chatHistory.innerHTML = '';
             chatInput.value = '';
             chatLoadingIndicator.style.display = 'none';
             chatSendBtn.disabled = false;
             currentTopic = null;
             hideFullscreenImage();
             stopGame(); // Ensure game state is reset
        }

        // ========== FULLSCREEN IMAGE FUNCTIONS ========== (unchanged)
        function showFullscreenImage(imgSrc) { /* ... */ if(!imageFullscreenOverlay||!fullscreenImage)return;fullscreenImage.src=imgSrc;imageFullscreenOverlay.classList.add('active');document.body.style.overflow='hidden'; }
        function hideFullscreenImage() { /* ... */ if(!imageFullscreenOverlay)return;imageFullscreenOverlay.classList.remove('active');if(!storyModal.classList.contains('active')){document.body.style.overflow='';}fullscreenImage.src=''; }

        // ========== CHAT FUNCTIONS ========== (unchanged)
        function addChatMessage(message, sender) { /* ... */ const msgDiv=document.createElement('div');msgDiv.classList.add('chat-message',sender==='user'?'user-message':'ai-message');message=message.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');message=message.replace(/\*(.*?)\*/g,'<em>$1</em>');msgDiv.innerHTML=message;chatHistory.appendChild(msgDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        function addChatError(message) { /* ... */ const errDiv=document.createElement('div');errDiv.classList.add('chat-error');errDiv.textContent=message;chatHistory.appendChild(errDiv);chatHistory.scrollTop=chatHistory.scrollHeight; }
        async function handleSendMessage() { /* ... */ const userQuery=chatInput.value.trim();if(!userQuery||chatSendBtn.disabled)return;addChatMessage(userQuery,'user');chatInput.value='';chatSendBtn.disabled=true;chatLoadingIndicator.style.display='block';try{const aiResponse=await fetchChatResponse(userQuery);addChatMessage(aiResponse,'ai');}catch(error){console.error("Chat Error:",error);addChatError(`Erro IA: ${error.message}`);}finally{chatLoadingIndicator.style.display='none';chatSendBtn.disabled=false;chatInput.focus();} }

        // ========== UI & EVENT HANDLERS ==========
        function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) { let ci=array.length,ri;while(ci>0){ri=Math.floor(Math.random()*ci);ci--;[array[ci],array[ri]]=[array[ri],array[ci]];} return array; }
        function createTitleItem(title) { const div=document.createElement('div');div.className='title-item';div.textContent=title;div.setAttribute('data-title', title);div.addEventListener('click', () => handleTitleClick(title)); return div; }
        function displayTitles(titles) {
             if (!titleListContainer || !titlesLoading) return;
             const sortedTitles = titles.sort((a, b) => a.localeCompare(b));
             titleListContainer.innerHTML = '';
             titlesLoading.style.display = 'none';
             if (sortedTitles.length === 0) { titleListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center font-sans">¬ª Nenhum t√≥pico encontrado. ¬´</p>'; return; }
             sortedTitles.forEach(title => titleListContainer.appendChild(createTitleItem(title)));
         }
        function appendTitles(newTitles) {
             if (!titleListContainer || !newTitles || newTitles.length === 0) return;
             const existingTitles = new Set(Array.from(titleListContainer.querySelectorAll('.title-item')).map(item => item.dataset.title));
             newTitles.forEach(title => { if (!existingTitles.has(title)) { titleListContainer.appendChild(createTitleItem(title)); } });
             filterTitles(searchInput.value); // Re-apply filter
         }

        // *** MODIFIED: handleTitleClick to start game ***
        async function handleTitleClick(title) {
            resetModalState();
            showModal();
            modalTitle.textContent = title;
            currentTopic = title; // Set chat context
            modalContent.innerHTML = '';
            chatHistory.innerHTML = '';
            modalError.classList.add('content-hidden');
            modalLoadingIndicator.style.display = 'flex';
            startGame(); // *** START THE MINIGAME ***

            try {
                // Fetch text in parallel with game running
                const rawExplanationText = await fetchExplanationText(title);
                stopGame(); // *** STOP GAME ON SUCCESSFUL FETCH ***
                const formattedExplanation = formatExplanationText(rawExplanationText);

                modalLoadingIndicator.style.display = 'none'; // Hide loader/game
                modalContent.innerHTML = formattedExplanation;
                modalStoryContentArea.classList.remove('content-hidden');
                modalTextArea.scrollTop = 0;
                console.log("Scroll set to 0 after content visible");

                // Add image placeholder and load image (same logic as before)
                const placeholderDiv = document.createElement('div'); /*...*/ placeholderDiv.className='image-placeholder';placeholderDiv.innerHTML=`<div class="spinner"></div><i class="fas fa-leaf placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Carregando imagem...</p>`; modalContent.appendChild(placeholderDiv);
                const imgElement = document.createElement('img'); /*...*/ imgElement.className='final-image';imgElement.alt=`Representa√ß√£o art√≠stica de ${title}`;imgElement.style.display='none';
                imgElement.onload = () => { console.log("Image loaded."); placeholderDiv.remove(); imgElement.style.display='block'; imgElement.addEventListener('click', () => showFullscreenImage(imgElement.src)); };
                imgElement.onerror = () => { console.error("Image load error"); placeholderDiv.innerHTML=`<i class="fas fa-eye-slash placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Imagem n√£o carregou.</p>`; };
                const imageUrl = createPollinationsImageUrl(title);
                if (imageUrl) { imgElement.src=imageUrl; modalContent.appendChild(imgElement); } else { console.error("No Img URL"); placeholderDiv.innerHTML=`<i class="fas fa-exclamation-circle placeholder-icon"></i><p style="font-size:0.8em;margin-top:0.5rem;">Erro URL imagem.</p>`; }

            } catch (error) {
                console.error("Failed display:", error);
                stopGame(); // *** STOP GAME ON FETCH ERROR ***
                modalLoadingIndicator.style.display = 'none'; // Hide loader/game
                modalErrorMessage.textContent = error.message || "Ocorreu um erro ao carregar as informa√ß√µes.";
                modalError.classList.remove('content-hidden');
                modalStoryContentArea.classList.remove('content-hidden');
                modalContent.innerHTML = '';
                chatSection.classList.add('content-hidden');
            }
        }

        async function handleGenerateMoreTitles() {
             if (!generateMoreBtn || !generateMoreSpinner || !generateMoreContainer) return;
             generateMoreBtn.disabled = true;
             generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin"></i> Buscando mais t√≥picos...';
             try {
                 const newTitles = await fetchGeneratedTitles(); // Fetches 40
                 if (newTitles && newTitles.length > 0) { appendTitles(newTitles); }
                 else { alert("N√£o foi poss√≠vel gerar mais t√≥picos no momento."); }
             } catch (error) {
                 console.error("Failed title generation:", error);
                 alert(`Erro ao gerar t√≥picos: ${error.message}`);
             } finally {
                 generateMoreBtn.disabled = false;
                 // Update button text to reflect it generates 40
                 generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Gerar Mais T√≥picos (40)';
             }
         }

        // *** Search Filter Function (with accent normalization) ***
         function filterTitles(searchTerm) {
             const term = searchTerm.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
             const titleItems = titleListContainer.querySelectorAll('.title-item');
             let visibleCount = 0;
             titleItems.forEach(item => {
                 const titleText = item.dataset.title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const isVisible = titleText.includes(term);
                 item.classList.toggle('hidden', !isVisible);
                 if (isVisible) visibleCount++;
             });
             noResultsMsg.classList.toggle('hidden', visibleCount > 0);
         }

        // ========== INITIALIZATION ==========
        function initApp() {
            // Check all essential elements, including game area
             if (!titleListContainer || !storyModal || !modalCloseBtn || !generateMoreBtn || !titlesLoading || !searchInput || !noResultsMsg || !chatInput || !chatSendBtn || !imageFullscreenOverlay || !fullscreenCloseBtn || !minigameArea) {
                 console.error("Initialization failed: Missing essential elements.");
                 document.body.innerHTML = '<p style="color: red; font-size: 1.5em; text-align: center; padding-top: 3em;">Erro cr√≠tico: Falha ao carregar componentes da p√°gina.</p>';
                 return;
             }
            // Event listeners
            modalCloseBtn.addEventListener('click', hideModal);
            storyModal.addEventListener('click', (event) => { if (event.target === storyModal) hideModal(); });
            generateMoreBtn.addEventListener('click', handleGenerateMoreTitles);
            searchInput.addEventListener('input', (event) => filterTitles(event.target.value));
            searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') event.preventDefault(); });
            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') handleSendMessage(); });
            imageFullscreenOverlay.addEventListener('click', hideFullscreenImage);
            fullscreenCloseBtn.addEventListener('click', (event) => { event.stopPropagation(); hideFullscreenImage(); });

            // Initial Display
            displayTitles(predefinedTitles);
            noResultsMsg.classList.add('hidden');
            generateMoreBtn.innerHTML = '<i class="fas fa-sync-alt mr-2 animate-spin hidden"></i> Gerar Mais T√≥picos (40)'; // Update button text
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>